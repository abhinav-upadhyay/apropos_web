<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
VIRTUAL(8)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
VIRTUAL(8)</td>
<td class="head-vol" align="center">
System Manager's Manual</td>
<td class="head-rtitle" align="right">
VIRTUAL(8)</td>
</tr>
</tbody>
</table>
<br>
<div class="section">
<h1>NAME</h1> virtual &#45; Postfix virtual domain mail delivery agent</div>
<div class="section">
<h1>SYNOPSIS</h1><br>
<b>virtual</b> [generic Postfix daemon options]</div>
<div class="section">
<h1>DESCRIPTION</h1><br>
The <b>virtual</b>(8) delivery agent is designed for virtual mail hosting services. Originally based on the Postfix  <b>local</b>(8) delivery agent, this agent looks up recipients with map lookups of their full recipient address, instead of using hard-coded unix password file lookups of the address local part only.<div style="height: 1.00em;">
&#160;</div>
This delivery agent only delivers mail.  Other features such as mail forwarding, out-of-office notifications, etc., must be configured via virtual_alias maps or via similar lookup mechanisms.</div>
<div class="section">
<h1>MAILBOX LOCATION</h1><br>
The mailbox location is controlled by the <b>virtual_mailbox_base</b> and  <b>virtual_mailbox_maps</b> configuration parameters (see below). The  <b>virtual_mailbox_maps</b> table is indexed by the recipient address as described under TABLE SEARCH ORDER below.<div style="height: 1.00em;">
&#160;</div>
The mailbox pathname is constructed as follows:<div style="height: 1.00em;">
&#160;</div>
<br>
  <b>$virtual_mailbox_base/$virtual_mailbox_maps(</b><i>recipient</i><b>)</b><br>
<div style="height: 1.00em;">
&#160;</div>
where <i>recipient</i> is the full recipient address.</div>
<div class="section">
<h1>UNIX MAILBOX FORMAT</h1><br>
When the mailbox location does not end in <b>/</b>, the message is delivered in UNIX mailbox format.   This format stores multiple messages in one textfile.<div style="height: 1.00em;">
&#160;</div>
The <b>virtual</b>(8) delivery agent prepends a "<b>From </b><i>sender</i>  <i>time_stamp</i>" envelope header to each message, prepends a  <b>Delivered-To:</b> message header with the envelope recipient address, prepends an  <b>X-Original-To:</b> header with the recipient address as given to Postfix, prepends a  <b>Return-Path:</b> message header with the envelope sender address, prepends a  <b>&gt;</b> character to lines beginning with " <b>From </b>", and appends an empty line.<div style="height: 1.00em;">
&#160;</div>
The mailbox is locked for exclusive access while delivery is in progress. In case of problems, an attempt is made to truncate the mailbox to its original length.</div>
<div class="section">
<h1>QMAIL MAILDIR FORMAT</h1><br>
When the mailbox location ends in <b>/</b>, the message is delivered in qmail  <b>maildir</b> format. This format stores one message per file.<div style="height: 1.00em;">
&#160;</div>
The <b>virtual</b>(8) delivery agent prepends a <b>Delivered-To:</b> message header with the final envelope recipient address, prepends an  <b>X-Original-To:</b> header with the recipient address as given to Postfix, and prepends a  <b>Return-Path:</b> message header with the envelope sender address.<div style="height: 1.00em;">
&#160;</div>
By definition, <b>maildir</b> format does not require application-level file locking during mail delivery or retrieval.</div>
<div class="section">
<h1>MAILBOX OWNERSHIP</h1><br>
Mailbox ownership is controlled by the <b>virtual_uid_maps</b> and  <b>virtual_gid_maps</b> lookup tables, which are indexed with the full recipient address. Each table provides a string with the numerical user and group ID, respectively.<div style="height: 1.00em;">
&#160;</div>
The <b>virtual_minimum_uid</b> parameter imposes a lower bound on numerical user ID values that may be specified in any  <b>virtual_uid_maps</b>.</div>
<div class="section">
<h1>CASE FOLDING</h1><br>
All delivery decisions are made using the full recipient address, folded to lower case. See also the next section for a few exceptions with optional address extensions.</div>
<div class="section">
<h1>TABLE SEARCH ORDER</h1><br>
Normally, a lookup table is specified as a text file that serves as input to the  <b>postmap</b>(1) command. The result, an indexed file in  <b>dbm</b> or <b>db</b> format, is used for fast searching by the mail system.<div style="height: 1.00em;">
&#160;</div>
The search order is as follows. The search stops upon the first successful lookup.<dl>
<dt>
&#8226;</dt>
<dd>
When the recipient has an optional address extension the  <i>user+extension@domain.tld</i> address is looked up first.<div style="height: 1.00em;">
&#160;</div>
With Postfix versions before 2.1, the optional address extension is always ignored.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
The <i>user@domain.tld</i> address, without address extension, is looked up next.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
Finally, the recipient <i>@domain</i> is looked up.</dd>
</dl>
<p>
When the table is provided via other means such as NIS, LDAP or SQL, the same lookups are done as for ordinary indexed files.<div style="height: 1.00em;">
&#160;</div>
Alternatively, a table can be provided as a regular-expression map where patterns are given as regular expressions. In that case, only the full recipient address is given to the regular-expression map.</div>
<div class="section">
<h1>SECURITY</h1><br>
The <b>virtual</b>(8) delivery agent is not security sensitive, provided that the lookup tables with recipient user/group ID information are adequately protected. This program is not designed to run chrooted.<div style="height: 1.00em;">
&#160;</div>
The <b>virtual</b>(8) delivery agent disallows regular expression substitution of $1 etc. in regular expression lookup tables, because that would open a security hole.<div style="height: 1.00em;">
&#160;</div>
The <b>virtual</b>(8) delivery agent will silently ignore requests to use the  <b>proxymap</b>(8) server. Instead it will open the table directly. Before Postfix version 2.2, the virtual delivery agent will terminate with a fatal error.</div>
<div class="section">
<h1>STANDARDS</h1><br>
RFC 822 (ARPA Internet Text Messages)</div>
<div class="section">
<h1>DIAGNOSTICS</h1><br>
Mail bounces when the recipient has no mailbox or when the recipient is over disk quota. In all other cases, mail for an existing recipient is deferred and a warning is logged.<div style="height: 1.00em;">
&#160;</div>
Problems and transactions are logged to <b>syslogd</b>(8). Corrupted message files are marked so that the queue manager can move them to the  <b>corrupt</b> queue afterwards.<div style="height: 1.00em;">
&#160;</div>
Depending on the setting of the <b>notify_classes</b> parameter, the postmaster is notified of bounces and of other trouble.</div>
<div class="section">
<h1>BUGS</h1><br>
This delivery agent supports address extensions in email addresses and in lookup table keys, but does not propagate address extension information to the result of table lookup.<div style="height: 1.00em;">
&#160;</div>
Postfix should have lookup tables that can return multiple result attributes. In order to avoid the inconvenience of maintaining three tables, use an LDAP or MYSQL database.</div>
<div class="section">
<h1>CONFIGURATION PARAMETERS</h1><br>
Changes to <b>main.cf</b> are picked up automatically, as  <b>virtual</b>(8) processes run for only a limited amount of time. Use the command " <b>postfix reload</b>" to speed up a change.<div style="height: 1.00em;">
&#160;</div>
The text below provides only a parameter summary. See  <b>postconf</b>(5) for more details including examples.</div>
<div class="section">
<h1>MAILBOX DELIVERY CONTROLS</h1><br>
<dl>
<dt>
<b>virtual_mailbox_base (empty)</b></dt>
<dd>
A prefix that the <b>virtual</b>(8) delivery agent prepends to all pathname results from $virtual_mailbox_maps table lookups.</dd>
</dl>
<dl>
<dt>
<b>virtual_mailbox_maps (empty)</b></dt>
<dd>
Optional lookup tables with all valid addresses in the domains that match $virtual_mailbox_domains.</dd>
</dl>
<dl>
<dt>
<b>virtual_minimum_uid (100)</b></dt>
<dd>
The minimum user ID value that the <b>virtual</b>(8) delivery agent accepts as a result from $virtual_uid_maps table lookup.</dd>
</dl>
<dl>
<dt>
<b>virtual_uid_maps (empty)</b></dt>
<dd>
Lookup tables with the per-recipient user ID that the <b>virtual</b>(8) delivery agent uses while writing to the recipient's mailbox.</dd>
</dl>
<dl>
<dt>
<b>virtual_gid_maps (empty)</b></dt>
<dd>
Lookup tables with the per-recipient group ID for <b>virtual</b>(8) mailbox delivery.</dd>
</dl>
<p>
Available in Postfix version 2.0 and later:<dl>
<dt>
<b>virtual_mailbox_domains ($virtual_mailbox_maps)</b></dt>
<dd>
Postfix is final destination for the specified list of domains; mail is delivered via the $virtual_transport mail delivery transport.</dd>
</dl>
<dl>
<dt>
<b>virtual_transport (virtual)</b></dt>
<dd>
The default mail delivery transport and next-hop destination for final delivery to domains listed with $virtual_mailbox_domains.</dd>
</dl>
<p>
Available in Postfix version 2.5.3 and later:<dl>
<dt>
<b>strict_mailbox_ownership (yes)</b></dt>
<dd>
Defer delivery when a mailbox file is not owned by its recipient.</dd>
</dl>
</div>
<div class="section">
<h1>LOCKING CONTROLS</h1><br>
<dl>
<dt>
<b>virtual_mailbox_lock (see 'postconf -d' output)</b></dt>
<dd>
How to lock a UNIX-style <b>virtual</b>(8) mailbox before attempting delivery.</dd>
</dl>
<dl>
<dt>
<b>deliver_lock_attempts (20)</b></dt>
<dd>
The maximal number of attempts to acquire an exclusive lock on a mailbox file or  <b>bounce</b>(8) logfile.</dd>
</dl>
<dl>
<dt>
<b>deliver_lock_delay (1s)</b></dt>
<dd>
The time between attempts to acquire an exclusive lock on a mailbox file or  <b>bounce</b>(8) logfile.</dd>
</dl>
<dl>
<dt>
<b>stale_lock_time (500s)</b></dt>
<dd>
The time after which a stale exclusive mailbox lockfile is removed.</dd>
</dl>
</div>
<div class="section">
<h1>RESOURCE AND RATE CONTROLS</h1><br>
<dl>
<dt>
<b>virtual_destination_concurrency_limit ($default_destination_concurrency_limit)</b></dt>
<dd>
The maximal number of parallel deliveries to the same destination via the virtual message delivery transport.</dd>
</dl>
<dl>
<dt>
<b>virtual_destination_recipient_limit ($default_destination_recipient_limit)</b></dt>
<dd>
The maximal number of recipients per message for the virtual message delivery transport.</dd>
</dl>
<dl>
<dt>
<b>virtual_mailbox_limit (51200000)</b></dt>
<dd>
The maximal size in bytes of an individual <b>virtual</b>(8) mailbox or maildir file, or zero (no limit).</dd>
</dl>
</div>
<div class="section">
<h1>MISCELLANEOUS CONTROLS</h1><br>
<dl>
<dt>
<b>config_directory (see 'postconf -d' output)</b></dt>
<dd>
The default location of the Postfix main.cf and master.cf configuration files.</dd>
</dl>
<dl>
<dt>
<b>daemon_timeout (18000s)</b></dt>
<dd>
How much time a Postfix daemon process may take to handle a request before it is terminated by a built-in watchdog timer.</dd>
</dl>
<dl>
<dt>
<b>delay_logging_resolution_limit (2)</b></dt>
<dd>
The maximal number of digits after the decimal point when logging sub-second delay values.</dd>
</dl>
<dl>
<dt>
<b>ipc_timeout (3600s)</b></dt>
<dd>
The time limit for sending or receiving information over an internal communication channel.</dd>
</dl>
<dl>
<dt>
<b>max_idle (100s)</b></dt>
<dd>
The maximum amount of time that an idle Postfix daemon process waits for an incoming connection before terminating voluntarily.</dd>
</dl>
<dl>
<dt>
<b>max_use (100)</b></dt>
<dd>
The maximal number of incoming connections that a Postfix daemon process will service before terminating voluntarily.</dd>
</dl>
<dl>
<dt>
<b>process_id (read-only)</b></dt>
<dd>
The process ID of a Postfix command or daemon process.</dd>
</dl>
<dl>
<dt>
<b>process_name (read-only)</b></dt>
<dd>
The process name of a Postfix command or daemon process.</dd>
</dl>
<dl>
<dt>
<b>queue_directory (see 'postconf -d' output)</b></dt>
<dd>
The location of the Postfix top-level queue directory.</dd>
</dl>
<dl>
<dt>
<b>syslog_facility (mail)</b></dt>
<dd>
The syslog facility of Postfix logging.</dd>
</dl>
<dl>
<dt>
<b>syslog_name (see 'postconf -d' output)</b></dt>
<dd>
The mail system name that is prepended to the process name in syslog records, so that "smtpd" becomes, for example, "postfix/smtpd".</dd>
</dl>
</div>
<div class="section">
<h1>SEE ALSO</h1><br>
qmgr(8), queue manager<br>
bounce(8), delivery status reports<br>
postconf(5), configuration parameters<br>
syslogd(8), system logging</div>
<div class="section">
<h1>README_FILES</h1><br>
Use "<b>postconf readme_directory</b>" or<br>
"<b>postconf html_directory</b>" to locate this information.<br>
VIRTUAL_README, domain hosting howto</div>
<div class="section">
<h1>LICENSE</h1><br>
The Secure Mailer license must be distributed with this software.</div>
<div class="section">
<h1>HISTORY</h1><br>
This delivery agent was originally based on the Postfix local delivery agent. Modifications mainly consisted of removing code that either was not applicable or that was not safe in this context: aliases, ~user/.forward files, delivery to "|command" or to /file/name.<div style="height: 1.00em;">
&#160;</div>
The <b>Delivered-To:</b> message header appears in the <b>qmail</b> system by Daniel Bernstein.<div style="height: 1.00em;">
&#160;</div>
The <b>maildir</b> structure appears in the <b>qmail</b> system by Daniel Bernstein.</div>
<div class="section">
<h1>AUTHOR(S)</h1><br>
Wietse Venema<br>
IBM T.J. Watson Research<br>
P.O. Box 704<br>
Yorktown Heights, NY 10598, USA<p>
<br>
Andrew McNamara<br>
andrewm@connect.com.au<br>
connect.com.au Pty. Ltd.<br>
Level 3, 213 Miller St<br>
North Sydney 2060, NSW, Australia</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tr>
<td class="foot-date">
</td>
<td class="foot-os" align="right">
</td>
</tr>
</table>
</div>
</body>
</html>

