<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
FTP-PROXY(8)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
FTP-PROXY(8)</td>
<td class="head-vol" align="center">
System Manager's Manual</td>
<td class="head-rtitle" align="right">
FTP-PROXY(8)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">ftp-proxy</b> &#8212; <span class="desc">Internet File Transfer Protocol proxy daemon</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1><table class="synopsis">
<col style="width: 9.00ex;">
<col>
<tbody>
<tr>
<td>
ftp-proxy</td>
<td>
&#91;<span class="opt"><b class="flag">&#45;6Adrv</b></span>&#93; &#91;<span class="opt"><b class="flag">&#45;a</b>&#160;<i class="arg">address</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;b</b>&#160;<i class="arg">address</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;D</b>&#160;<i class="arg">level</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;i</b>&#160;<i class="arg">netif</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;m</b>&#160;<i class="arg">maxsessions</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;P</b>&#160;<i class="arg">port</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;p</b>&#160;<i class="arg">port</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;q</b>&#160;<i class="arg">queue</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;R</b>&#160;<i class="arg">address</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;T</b>&#160;<i class="arg">tag</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;t</b>&#160;<i class="arg">timeout</i></span>&#93;</td>
</tr>
</tbody>
</table>
</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> <b class="name">ftp-proxy</b> is a proxy for the Internet File Transfer Protocol. FTP control connections should be redirected into the proxy using the <a class="link-man" href="../4/ipnat">ipnat(4)</a> or <a class="link-man" href="../4/pf">pf(4)</a> <i class="arg">rdr</i> command, after which the proxy connects to the server on behalf of the client.<p>
The proxy allows data connections to pass, rewriting and redirecting them so that the right addresses are used. All connections from the client to the server have their source address rewritten so they appear to come from the proxy. Consequently, all connections from the server to the proxy have their destination address rewritten, so they are redirected to the client. The proxy uses the <a class="link-man" href="../4/pf">pf(4)</a> <i class="arg">anchor</i> facility for this, unless the option <b class="flag">&#45;i</b> is specified, it will then use the <a class="link-man" href="../4/ipnat">ipnat(4)</a> interface.<p>
Assuming the FTP control connection is from $client to $server, the proxy connected to the server using the $proxy source address, and $port is negotiated, then <b class="name">ftp-proxy</b> adds the following rules to the various anchors. (These example rules use inet, but the proxy also supports inet6.)<p>
In case of active mode (PORT or EPRT):<p>
<pre style="margin-left: 2.00ex;" class="lit display">
rdr from $server to $proxy port $port -&gt; $client 
pass quick inet proto tcp &#92; 
    from $server to $client port $port</pre>
<p>
In case of passive mode (PASV or EPSV):<p>
<pre style="margin-left: 2.00ex;" class="lit display">
nat from $client to $server port $port -&gt; $proxy 
pass in quick inet proto tcp &#92; 
    from $client to $server port $port 
pass out quick inet proto tcp &#92; 
    from $proxy to $server port $port</pre>
<p>
The options are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;6</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
IPv6 mode. The proxy will expect and use IPv6 addresses for all communication. Only the extended FTP modes EPSV and EPRT are allowed with IPv6. The proxy is in IPv4 mode by default.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;A</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Only permit anonymous FTP connections. Either user "ftp" or user "anonymous" is allowed.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;a</b> <i class="arg">address</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The proxy will use this as the source address for the control connection to a server.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;b</b> <i class="arg">address</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Address where the proxy will listen for redirected control connections. The default is 127.0.0.1, or ::1 in IPv6 mode.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;D</b> <i class="arg">level</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Debug level, ranging from 0 to 7. Higher is more verbose. The default is 5. (These levels correspond to the <a class="link-man" href="../3/syslog">syslog(3)</a> levels.)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;d</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Do not daemonize. The process will stay in the foreground, logging to standard error.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;i</b> <i class="arg">netif</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Set <b class="name">ftp-proxy</b> for use with IP-Filter. The argument <i class="arg">netif</i> should be set to the name of the network interface where rdr is applied on.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;m</b> <i class="arg">maxsessions</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Maximum number of concurrent FTP sessions. When the proxy reaches this limit, new connections are denied. The default is 100 sessions. The limit can be lowered to a minimum of 1, or raised to a maximum of 500.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;P</b> <i class="arg">port</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Fixed server port. Only used in combination with <b class="flag">&#45;R</b>. The default is port 21.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;p</b> <i class="arg">port</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Port where the proxy will listen for redirected connections. The default is port 8021.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;q</b> <i class="arg">queue</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Create rules with queue <i class="arg">queue</i> appended, so that data connections can be queued.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;R</b> <i class="arg">address</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Fixed server address, also known as reverse mode. The proxy will always connect to the same server, regardless of where the client wanted to connect to (before it was redirected). Use this option to proxy for a server behind NAT, or to forward all connections to another proxy.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;r</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Rewrite sourceport to 20 in active mode to suit ancient clients that insist on this RFC property.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;T</b> <i class="arg">tag</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Automatically tag packets passing through the <a class="link-man" href="../4/pf">pf(4)</a> rule with the name supplied.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;t</b> <i class="arg">timeout</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Number of seconds that the control connection can be idle, before the proxy will disconnect. The maximum is 86400 seconds, which is also the default. Do not set this too low, because the control connection is usually idle when large data transfers are taking place.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;v</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Set the 'log' flag on pf rules committed by <b class="name">ftp-proxy</b>. Use twice to set the 'log-all' flag. The pf rules do not log by default.</dd>
</dl>
</div>
<div class="section">
<h1 id="x434f4e46494755524154494f4e">CONFIGURATION</h1> To make use of the proxy using <a class="link-man" href="../4/pf">pf(4)</a>, <a class="link-man" href="../5/pf.conf">pf.conf(5)</a> needs the following rules. All anchors are mandatory. Adjust the rules as needed.<p>
In the NAT section:<p>
<pre style="margin-left: 2.00ex;" class="lit display">
nat-anchor "ftp-proxy/*" 
rdr-anchor "ftp-proxy/*" 
rdr pass on $int_if proto tcp from $lan to any port 21 -&gt; &#92; 
    127.0.0.1 port 8021</pre>
<p>
In the rule section:<p>
<pre style="margin-left: 2.00ex;" class="lit display">
anchor "ftp-proxy/*" 
pass out proto tcp from $proxy to any port 21</pre>
<p>
To make use of the proxy using <a class="link-man" href="../4/ipnat">ipnat(4)</a>, <a class="link-man" href="../5/ipnat.conf">ipnat.conf(5)</a> need the following rule:<p>
<pre style="margin-left: 2.00ex;" class="lit display">
rdr $int_if any port 21 -&gt; 127.0.0.1 port 8021 tcp</pre>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../1/ftp">ftp(1)</a>, <a class="link-man" href="../4/ipnat">ipnat(4)</a>, <a class="link-man" href="../4/pf">pf(4)</a>, <a class="link-man" href="../5/ipnat.conf">ipnat.conf(5)</a>, <a class="link-man" href="../5/pf.conf">pf.conf(5)</a></div>
<div class="section">
<h1 id="x43415645415453">CAVEATS</h1> <a class="link-man" href="../4/ipnat">ipnat(4)</a> and <a class="link-man" href="../4/pf">pf(4)</a> does not allow the ruleset to be modified if the system is running at a securelevel higher than 1. At that level <b class="name">ftp-proxy</b> cannot add rules to the anchors and FTP data connections may get blocked.<p>
Negotiated data connection ports below 1024 are not allowed.<p>
The negotiated IP address for active modes is ignored for security reasons. This makes third party file transfers impossible.<p>
<b class="name">ftp-proxy</b> chroots to "/var/chroot/ftp-proxy" and changes to user "_proxy" to drop privileges.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
August 1, 2007</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

