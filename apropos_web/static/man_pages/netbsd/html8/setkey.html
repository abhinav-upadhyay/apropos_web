<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
SETKEY(8)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
SETKEY(8)</td>
<td class="head-vol" align="center">
System Manager's Manual</td>
<td class="head-rtitle" align="right">
SETKEY(8)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">setkey</b> &#8212; <span class="desc">manually manipulate the IPsec SA/SP database</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1><table class="synopsis">
<col style="width: 6.00ex;">
<col>
<tbody>
<tr>
<td>
setkey</td>
<td>
&#91;<span class="opt"><b class="flag">&#45;knrv</b></span>&#93; <i class="arg">file ...</i></td>
</tr>
</tbody>
</table>
<br>
<table class="synopsis">
<col style="width: 6.00ex;">
<col>
<tbody>
<tr>
<td>
setkey</td>
<td>
&#91;<span class="opt"><b class="flag">&#45;knrv</b></span>&#93; <b class="flag">&#45;c</b></td>
</tr>
</tbody>
</table>
<br>
<table class="synopsis">
<col style="width: 6.00ex;">
<col>
<tbody>
<tr>
<td>
setkey</td>
<td>
&#91;<span class="opt"><b class="flag">&#45;krv</b></span>&#93; <b class="flag">&#45;f</b> <i class="arg">filename</i></td>
</tr>
</tbody>
</table>
<br>
<table class="synopsis">
<col style="width: 6.00ex;">
<col>
<tbody>
<tr>
<td>
setkey</td>
<td>
&#91;<span class="opt"><b class="flag">&#45;aklPrv</b></span>&#93; <b class="flag">&#45;D</b></td>
</tr>
</tbody>
</table>
<br>
<table class="synopsis">
<col style="width: 6.00ex;">
<col>
<tbody>
<tr>
<td>
setkey</td>
<td>
&#91;<span class="opt"><b class="flag">&#45;Pvp</b></span>&#93; <b class="flag">&#45;F</b></td>
</tr>
</tbody>
</table>
<br>
<table class="synopsis">
<col style="width: 6.00ex;">
<col>
<tbody>
<tr>
<td>
setkey</td>
<td>
&#91;<span class="opt"><b class="flag">&#45;H</b></span>&#93; <b class="flag">&#45;x</b></td>
</tr>
</tbody>
</table>
<br>
<table class="synopsis">
<col style="width: 6.00ex;">
<col>
<tbody>
<tr>
<td>
setkey</td>
<td>
&#91;<span class="opt"><b class="flag">&#45;?V</b></span>&#93;</td>
</tr>
</tbody>
</table>
</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> <b class="name">setkey</b> adds, updates, dumps, or flushes Security Association Database (SAD) entries as well as Security Policy Database (SPD) entries in the kernel.<p>
<b class="name">setkey</b> takes a series of operations from standard input (if invoked with <b class="flag">&#45;c</b>) or the file named <i class="arg">filename</i> (if invoked with <b class="flag">&#45;f</b> <i class="arg">filename</i>).<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
(no flag)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Dump the SAD entries or SPD entries contained in the specified <i class="arg">file</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;</b>?</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Print short help.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;a</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
<b class="name">setkey</b> usually does not display dead SAD entries with <b class="flag">&#45;D</b>. If <b class="flag">&#45;a</b> is also specified, the dead SAD entries will be displayed as well. A dead SAD entry is one that has expired but remains in the system because it is referenced by some SPD entries.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;D</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Dump the SAD entries. If <b class="flag">&#45;P</b> is also specified, the SPD entries are dumped. If <b class="flag">&#45;p</b> is specified, the ports are displayed.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;F</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Flush the SAD entries. If <b class="flag">&#45;P</b> is also specified, the SPD entries are flushed.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;H</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Add hexadecimal dump in <b class="flag">&#45;x</b> mode.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;h</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
On <span class="unix">NetBSD</span>, synonym for <b class="flag">&#45;H</b>. On other systems, synonym for <b class="flag">&#45;</b>?.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;k</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Use semantics used in kernel. Available only in Linux. See also <b class="flag">&#45;r</b>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;l</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Loop forever with short output on <b class="flag">&#45;D</b>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;n</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
No action. The program will check validity of the input, but no changes to the SPD will be made.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;r</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Use semantics described in IPsec RFCs. This mode is default. For details see section <i class="link-sec"><a class="link-sec" href="#x524643207673204c696e7578206b65726e656c2073656d616e74696373">RFC vs Linux kernel semantics</a></i>. Available only in Linux. See also <b class="flag">&#45;k</b>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;x</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Loop forever and dump all the messages transmitted to the <span class="define">PF_KEY</span> socket. <b class="flag">&#45;xx</b> prints the unformatted timestamps.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;V</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Print version string.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;v</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Be verbose. The program will dump messages exchanged on the <span class="define">PF_KEY</span> socket, including messages sent from other processes to the kernel.</dd>
</dl>
<div class="subsection">
<h2 id="x436f6e66696775726174696f6e2073796e746178">Configuration syntax</h2> With <b class="flag">&#45;c</b> or <b class="flag">&#45;f</b> on the command line, <b class="name">setkey</b> accepts the following configuration syntax. Lines starting with hash signs (&#8216;#&#8217;) are treated as comment lines.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">add</code> &#91;<span class="opt"><b class="flag">&#45;46n</b></span>&#93; <i class="arg">src</i> <i class="arg">dst</i> <i class="arg">protocol</i> <i class="arg">spi</i> &#91;<span class="opt"><i class="arg">extensions</i></span>&#93; <i class="arg">algorithm ...</i>;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Add an SAD entry. <code class="lit">add</code> can fail for multiple reasons, including when the key length does not match the specified algorithm.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">get</code> &#91;<span class="opt"><b class="flag">&#45;46n</b></span>&#93; <i class="arg">src</i> <i class="arg">dst</i> <i class="arg">protocol</i> <i class="arg">spi</i>;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Show an SAD entry.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">delete</code> &#91;<span class="opt"><b class="flag">&#45;46n</b></span>&#93; <i class="arg">src</i> <i class="arg">dst</i> <i class="arg">protocol</i> <i class="arg">spi</i>;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Remove an SAD entry.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">deleteall</code> &#91;<span class="opt"><b class="flag">&#45;46n</b></span>&#93; <i class="arg">src</i> <i class="arg">dst</i> <i class="arg">protocol</i>;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Remove all SAD entries that match the specification.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">flush</code> &#91;<span class="opt"><i class="arg">protocol</i></span>&#93;;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Clear all SAD entries matched by the options. <b class="flag">&#45;F</b> on the command line achieves the same functionality.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">dump</code> &#91;<span class="opt"><i class="arg">protocol</i></span>&#93;;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Dumps all SAD entries matched by the options. <b class="flag">&#45;D</b> on the command line achieves the same functionality.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">spdadd</code> &#91;<span class="opt"><b class="flag">&#45;46n</b></span>&#93; <i class="arg">src_range</i> <i class="arg">dst_range</i> <i class="arg">upperspec</i> <i class="arg">label</i> <i class="arg">policy</i>;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Add an SPD entry.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">spdadd tagged</code> <i class="arg">tag</i> <i class="arg">policy</i>;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Add an SPD entry based on a PF tag. <i class="arg">tag</i> must be a string surrounded by double quotes.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">spdupdate</code> &#91;<span class="opt"><b class="flag">&#45;46n</b></span>&#93; <i class="arg">src_range</i> <i class="arg">dst_range</i> <i class="arg">upperspec</i> <i class="arg">label</i> <i class="arg">policy</i>;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Updates an SPD entry.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">spdupdate tagged</code> <i class="arg">tag</i> <i class="arg">policy</i>;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Update an SPD entry based on a PF tag. <i class="arg">tag</i> must be a string surrounded by double quotes.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">spddelete</code> &#91;<span class="opt"><b class="flag">&#45;46n</b></span>&#93; <i class="arg">src_range</i> <i class="arg">dst_range</i> <i class="arg">upperspec</i> <b class="flag">&#45;P</b> <i class="arg">direction</i>;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Delete an SPD entry.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">spdflush</code>;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Clear all SPD entries. <b class="flag">&#45;FP</b> on the command line achieves the same functionality.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">spddump</code>;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Dumps all SPD entries. <b class="flag">&#45;DP</b> on the command line achieves the same functionality.</dd>
</dl>
<p>
Meta-arguments are as follows:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">src</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">dst</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Source/destination of the secure communication is specified as an IPv4/v6 address, and an optional port number between square brackets. <b class="name">setkey</b> can resolve a FQDN into numeric addresses. If the FQDN resolves into multiple addresses, <b class="name">setkey</b> will install multiple SAD/SPD entries into the kernel by trying all possible combinations. <b class="flag">&#45;4</b>, <b class="flag">&#45;6</b>, and <b class="flag">&#45;n</b> restrict the address resolution of FQDN in certain ways. <b class="flag">&#45;4</b> and <b class="flag">&#45;6</b> restrict results into IPv4/v6 addresses only, respectively. <b class="flag">&#45;n</b> avoids FQDN resolution and requires addresses to be numeric addresses.<p>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">protocol</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
<i class="arg">protocol</i> is one of following:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<code class="lit">esp</code></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
ESP based on rfc2406</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<code class="lit">esp-old</code></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
ESP based on rfc1827</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<code class="lit">esp-udp</code></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
UDP encapsulated ESP for NAT traversal (rfc3948)</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<code class="lit">ah</code></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
AH based on rfc2402</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<code class="lit">ah-old</code></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
AH based on rfc1826</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<code class="lit">ipcomp</code></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
IPComp</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<code class="lit">tcp</code></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
TCP-MD5 based on rfc2385</dd>
</dl>
<p>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">spi</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Security Parameter Index (SPI) for the SAD and the SPD. <i class="arg">spi</i> must be a decimal number, or a hexadecimal number with a &#8220;<code class="lit">0x</code>&#8221; prefix. SPI values between 0 and 255 are reserved for future use by IANA and cannot be used. TCP-MD5 associations must use 0x1000 and therefore only have per-host granularity at this time.<p>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">extensions</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
take some of the following:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;m</b> <i class="arg">mode</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Specify a security protocol mode for use. <i class="arg">mode</i> is one of following: <code class="lit">transport</code>, <code class="lit">tunnel</code>, or <code class="lit">any</code>. The default value is <code class="lit">any</code>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;r</b> <i class="arg">size</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Specify window size of bytes for replay prevention. <i class="arg">size</i> must be decimal number in 32-bit word. If <i class="arg">size</i> is zero or not specified, replay checks don't take place.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;u</b> <i class="arg">id</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Specify the identifier of the policy entry in the SPD. See <i class="arg">policy</i>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;f</b> <i class="arg">pad_option</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
defines the content of the ESP padding. <i class="arg">pad_option</i> is one of following:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<code class="lit">zero-pad</code></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
All the paddings are zero.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<code class="lit">random-pad</code></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
A series of randomized values are used.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<code class="lit">seq-pad</code></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
A series of sequential increasing numbers started from 1 are used.</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;f</b> <code class="lit">nocyclic-seq</code></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Don't allow cyclic sequence numbers.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;lh</b> <i class="arg">time</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;ls</b> <i class="arg">time</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Specify hard/soft life time duration of the SA measured in seconds.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;bh</b> <i class="arg">bytes</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;bs</b> <i class="arg">bytes</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Specify hard/soft life time duration of the SA measured in bytes transported.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;esp_frag</b> <i class="arg">bytes</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Specify esp fragment size for NAT-T (only valid for NAT-T SAs).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;ctx</b> <i class="arg">doi</i> <i class="arg">algorithm</i> <i class="arg">context-name</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Specify an access control label. The access control label is interpreted by the LSM (e.g., SELinux). Ultimately, it enables MAC on network communications.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">doi</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
The domain of interpretation, which is used by the IKE daemon to identify the domain in which negotiation takes place.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">algorithm</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Indicates the LSM for which the label is generated (e.g., SELinux).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">context-name</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
The string representation of the label that is interpreted by the LSM.</dd>
</dl>
</dd>
</dl>
<p>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">algorithm</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;E</b> <i class="arg">ealgo</i> <i class="arg">key</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Specify an encryption algorithm <i class="arg">ealgo</i> for ESP.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;E</b> <i class="arg">ealgo</i> <i class="arg">key</i> <b class="flag">&#45;A</b> <i class="arg">aalgo</i> <i class="arg">key</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Specify an encryption algorithm <i class="arg">ealgo</i>, as well as a payload authentication algorithm <i class="arg">aalgo</i>, for ESP.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;A</b> <i class="arg">aalgo</i> <i class="arg">key</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Specify an authentication algorithm for AH.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;C</b> <i class="arg">calgo</i> &#91;<span class="opt"><b class="flag">&#45;R</b></span>&#93;</dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Specify a compression algorithm for IPComp. If <b class="flag">&#45;R</b> is specified, the <i class="arg">spi</i> field value will be used as the IPComp CPI (compression parameter index) on wire as-is. If <b class="flag">&#45;R</b> is not specified, the kernel will use well-known CPI on wire, and <i class="arg">spi</i> field will be used only as an index for kernel internal usage.</dd>
</dl>
<p>
<i class="arg">key</i> must be a double-quoted character string, or a series of hexadecimal digits preceded by &#8220;<code class="lit">0x</code>&#8221;.<p>
Possible values for <i class="arg">ealgo</i>, <i class="arg">aalgo</i>, and <i class="arg">calgo</i> are specified in the <i class="link-sec"><a class="link-sec" href="#x416c676f726974686d73">Algorithms</a></i> sections.<p>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">src_range</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">dst_range</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
These select the communications that should be secured by IPsec. They can be an IPv4/v6 address or an IPv4/v6 address range, and may be accompanied by a TCP/UDP port specification. This takes the following form:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
<i class="arg">address</i> 
<i class="arg">address/prefixlen</i> 
<i class="arg">address[port]</i> 
<i class="arg">address/prefixlen[port]</i></pre>
<p>
<i class="arg">prefixlen</i> and <i class="arg">port</i> must be decimal numbers. The square brackets around <i class="arg">port</i> are really necessary, they are not man page meta-characters. For FQDN resolution, the rules applicable to <i class="arg">src</i> and <i class="arg">dst</i> apply here as well.<p>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">upperspec</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Upper-layer protocol to be used. You can use one of the words in <i class="file">/etc/protocols</i> as <i class="arg">upperspec</i>, or <code class="lit">icmp6</code>, <code class="lit">ip4</code>, <code class="lit">gre</code>, or <code class="lit">any</code>. <code class="lit">any</code> stands for &#8220;any protocol&#8221;. You can also use the protocol number. Additional specification can be placed after the protocol name for some protocols. You can specify a type and/or a code of ICMP or ICMPv6. The type is separated from a code by single comma and the code must always be specified. GRE key can be specified in dotted-quad format or as plain number. When a zero is specified, the kernel deals with it as a wildcard. Note that the kernel can not distinguish a wildcard from an ICPMv6 type of zero.<p>
For example, the following means that the policy doesn't require IPsec for any inbound Neighbor Solicitation.<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit">spdadd ::/0 ::/0 icmp6 135,0 -P in none;</code></div>
</blockquote>
<p>
A second example of requiring transport mode encryption of specific GRE tunnel:<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit">spdadd 0.0.0.0 0.0.0.0 gre 1234 ipsec esp/transport//require;</code></div>
</blockquote>
<p>
<span class="emph">Note</span>: <i class="arg">upperspec</i> does not work against forwarding case at this moment, as it requires extra reassembly at the forwarding node (not implemented at this moment). There are many protocols in <i class="file">/etc/protocols</i>, but all protocols except of TCP, UDP, GRE, and ICMP may not be suitable to use with IPsec. You have to consider carefully what to use.<p>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">label</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
<i class="arg">label</i> is the access control label for the policy. This label is interpreted by the LSM (e.g., SELinux). Ultimately, it enables MAC on network communications. When a policy contains an access control label, SAs negotiated with this policy will contain the label. Its format:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<b class="flag">&#45;ctx</b> <i class="arg">doi</i> <i class="arg">algorithm</i> <i class="arg">context-name</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">doi</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
The domain of interpretation, which is used by the IKE daemon to identify the domain in which negotiation takes place.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">algorithm</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Indicates the LSM for which the label is generated (e.g., SELinux).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">context-name</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
The string representation of the label that is interpreted by the LSM.</dd>
</dl>
</dd>
</dl>
<p>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">policy</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
<i class="arg">policy</i> is in one of the following three formats:<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-item">
<li class="list-item" style="margin-top: 0.00em;">
<b class="flag">&#45;P</b> <i class="arg">direction [priority specification]</i> <code class="lit">discard</code></li>
<li class="list-item" style="margin-top: 0.00em;">
<b class="flag">&#45;P</b> <i class="arg">direction [priority specification]</i> <code class="lit">none</code></li>
<li class="list-item" style="margin-top: 0.00em;">
<b class="flag">&#45;P</b> <i class="arg">direction [priority specification]</i> <code class="lit">ipsec</code> <i class="arg">protocol/mode/src-dst/level</i> &#91;<span class="opt">...</span>&#93;</li>
</ul>
<p>
You must specify the direction of its policy as <i class="arg">direction</i>. Either <i class="arg">out</i>, <i class="arg">in</i>, or <i class="arg">fwd</i> can be used.<p>
<i class="arg">priority specification</i> is used to control the placement of the policy within the SPD. Policy position is determined by a signed integer where higher priorities indicate the policy is placed closer to the beginning of the list and lower priorities indicate the policy is placed closer to the end of the list. Policies with equal priorities are added at the end of groups of such policies.<p>
Priority can only be specified when setkey has been compiled against kernel headers that support policy priorities (Linux &gt;= 2.6.6). If the kernel does not support priorities, a warning message will be printed the first time a priority specification is used. Policy priority takes one of the following formats:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="arg">{priority,prio} offset</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<i class="arg">offset</i> is an integer in the range from &#45;2147483647 to 214783648.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="arg">{priority,prio} base {+,&#45;} offset</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<i class="arg">base</i> is either <code class="lit">low (&#45;1073741824)</code>, <code class="lit">def (0)</code>, or <code class="lit">high (1073741824)</code><p>
<i class="arg">offset</i> is an unsigned integer. It can be up to 1073741824 for positive offsets, and up to 1073741823 for negative offsets.</dd>
</dl>
<p>
<code class="lit">discard</code> means the packet matching indexes will be discarded. <code class="lit">none</code> means that IPsec operation will not take place onto the packet. <code class="lit">ipsec</code> means that IPsec operation will take place onto the packet.<p>
The <i class="arg">protocol/mode/src-dst/level</i> part specifies the rule how to process the packet. Either <code class="lit">ah</code>, <code class="lit">esp</code>, or <code class="lit">ipcomp</code> must be used as <i class="arg">protocol</i>. <i class="arg">mode</i> is either <code class="lit">transport</code> or <code class="lit">tunnel</code>. If <i class="arg">mode</i> is <code class="lit">tunnel</code>, you must specify the end-point addresses of the SA as <i class="arg">src</i> and <i class="arg">dst</i> with &#8216;-&#8217; between these addresses, which is used to specify the SA to use. If <i class="arg">mode</i> is <code class="lit">transport</code>, both <i class="arg">src</i> and <i class="arg">dst</i> can be omitted. <i class="arg">level</i> is to be one of the following: <code class="lit">default</code>, <code class="lit">use</code>, <code class="lit">require</code>, or <code class="lit">unique</code>. If the SA is not available in every level, the kernel will ask the key exchange daemon to establish a suitable SA. <code class="lit">default</code> means the kernel consults the system wide default for the protocol you specified, e.g. the <code class="lit">esp_trans_deflev</code> sysctl variable, when the kernel processes the packet. <code class="lit">use</code> means that the kernel uses an SA if it's available, otherwise the kernel keeps normal operation. <code class="lit">require</code> means SA is required whenever the kernel sends a packet matched with the policy. <code class="lit">unique</code> is the same as <code class="lit">require</code>; in addition, it allows the policy to match the unique out-bound SA. You just specify the policy level <code class="lit">unique</code>, <a class="link-man" href="../html8/racoon.html">racoon(8)</a> will configure the SA for the policy. If you configure the SA by manual keying for that policy, you can put a decimal number as the policy identifier after <code class="lit">unique</code> separated by a colon &#8216;:&#8217; like: <code class="lit">unique:number</code> in order to bind this policy to the SA. <code class="lit">number</code> must be between 1 and 32767. It corresponds to <i class="arg">extensions</i> <b class="flag">&#45;u</b> of the manual SA configuration. When you want to use SA bundle, you can define multiple rules. For example, if an IP header was followed by an AH header followed by an ESP header followed by an upper layer protocol header, the rule would be:<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit">esp/transport//require ah/transport//require;</code></div>
</blockquote>
The rule order is very important.<p>
When NAT-T is enabled in the kernel, policy matching for ESP over UDP packets may be done on endpoint addresses and port (this depends on the system. System that do not perform the port check cannot support multiple endpoints behind the same NAT). When using ESP over UDP, you can specify port numbers in the endpoint addresses to get the correct matching. Here is an example:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
spdadd 10.0.11.0/24[any] 10.0.11.33/32[any] any &#45;P out ipsec 
    esp/tunnel/192.168.0.1[4500]-192.168.1.2[30000]/require ; 
</pre>
These ports must be left unspecified (which defaults to 0) for anything other than ESP over UDP. They can be displayed in SPD dump using <b class="name">setkey</b> <b class="flag">&#45;DPp</b>.<p>
Note that &#8220;<code class="lit">discard</code>&#8221; and &#8220;<code class="lit">none</code>&#8221; are not in the syntax described in <a class="link-man" href="../html3/ipsec_set_policy.html">ipsec_set_policy(3)</a>. There are a few differences in the syntax. See <a class="link-man" href="../html3/ipsec_set_policy.html">ipsec_set_policy(3)</a> for detail.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x416c676f726974686d73">Algorithms</h2> The following list shows the supported algorithms. <span class="symb">protocol</span> and <span class="symb">algorithm</span> are almost orthogonal. These authentication algorithms can be used as <i class="arg">aalgo</i> in <b class="flag">&#45;A</b> <i class="arg">aalgo</i> of the <i class="arg">protocol</i> parameter:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
algorithm	keylen (bits) 
hmac-md5	128		ah: rfc2403 
		128		ah-old: rfc2085 
hmac-sha1	160		ah: rfc2404 
		160		ah-old: 128bit ICV (no document) 
keyed-md5	128		ah: 96bit ICV (no document) 
		128		ah-old: rfc1828 
keyed-sha1	160		ah: 96bit ICV (no document) 
		160		ah-old: 128bit ICV (no document) 
null		0 to 2048	for debugging 
hmac-sha256	256		ah: 128bit ICV (RFC4868) 
		256		ah-old: 128bit ICV (no document) 
hmac-sha384	384		ah: 192bit ICV (RFC4868) 
		384		ah-old: 128bit ICV (no document) 
hmac-sha512	512		ah: 256bit ICV (RFC4868) 
		512		ah-old: 128bit ICV (no document) 
hmac-ripemd160	160		ah: 96bit ICV (RFC2857) 
				ah-old: 128bit ICV (no document) 
aes-xcbc-mac	128		ah: 96bit ICV (RFC3566) 
		128		ah-old: 128bit ICV (no document) 
tcp-md5		8 to 640	tcp: rfc2385</pre>
<p>
These encryption algorithms can be used as <i class="arg">ealgo</i> in <b class="flag">&#45;E</b> <i class="arg">ealgo</i> of the <i class="arg">protocol</i> parameter:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
algorithm	keylen (bits) 
des-cbc		64		esp-old: rfc1829, esp: rfc2405 
3des-cbc	192		rfc2451 
null		0 to 2048	rfc2410 
blowfish-cbc	40 to 448	rfc2451 
cast128-cbc	40 to 128	rfc2451 
des-deriv	64		ipsec-ciph-des-derived-01 
3des-deriv	192		no document 
rijndael-cbc	128/192/256	rfc3602 
twofish-cbc	0 to 256	draft-ietf-ipsec-ciph-aes-cbc-01 
aes-ctr		160/224/288	rfc3686 
camellia-cbc	128/192/256	rfc4312 
aes-gcm-16	160/224/288	rfc4106 
aes-gmac	160/224/288	rfc4543</pre>
<p>
Note that the first 128/192/256 bits of a key for <code class="lit">aes-ctr</code>, <code class="lit">aes-gcm-16</code> or <code class="lit">aes-gmac</code> will be used as AES key, and the remaining 32 bits will be used as nonce. Also note that <code class="lit">aes-gmac</code> does not encrypt the payload, it only provides authentication.<p>
These compression algorithms can be used as <i class="arg">calgo</i> in <b class="flag">&#45;C</b> <i class="arg">calgo</i> of the <i class="arg">protocol</i> parameter:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
algorithm 
deflate		rfc2394</pre>
</div>
<div class="subsection">
<h2 id="x524643207673204c696e7578206b65726e656c2073656d616e74696373">RFC vs Linux kernel semantics</h2> The Linux kernel uses the <i class="arg">fwd</i> policy instead of the <i class="arg">in</i> policy for packets what are forwarded through that particular box.<p>
In <i class="arg">kernel</i> mode, <b class="name">setkey</b> manages and shows policies and SAs exactly as they are stored in the kernel.<p>
In <i class="arg">RFC</i> mode, <b class="name">setkey</b><ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-item">
<li class="list-item" style="margin-top: 1.00em;">
creates <i class="arg">fwd</i> policies for every <i class="arg">in</i> policy inserted</li>
<li class="list-item" style="margin-top: 1.00em;">
(not implemented yet) filters out all <i class="arg">fwd</i> policies</li>
</ul>
</div>
</div>
<div class="section">
<h1 id="x52455455524e2056414c554553">RETURN VALUES</h1> The command exits with 0 on success, and non-zero on errors.</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1><pre style="margin-left: 0.00ex;" class="lit display">
add 3ffe:501:4819::1 3ffe:501:481d::1 esp 123457 
	&#45;E des-cbc 0x3ffe05014819ffff ; 
 
add &#45;6 myhost.example.com yourhost.example.com ah 123456 
	&#45;A hmac-sha1 "AH SA configuration!" ; 
 
add 10.0.11.41 10.0.11.33 esp 0x10001 
	&#45;E des-cbc 0x3ffe05014819ffff 
	&#45;A hmac-md5 "authentication!!" ; 
 
get 3ffe:501:4819::1 3ffe:501:481d::1 ah 123456 ; 
 
flush ; 
 
dump esp ; 
 
spdadd 10.0.11.41/32[21] 10.0.11.33/32[any] any 
	&#45;P out ipsec esp/tunnel/192.168.0.1-192.168.1.2/require ; 
 
add 10.1.10.34 10.1.10.36 tcp 0x1000 &#45;A tcp-md5 "TCP-MD5 BGP secret" ; 
 
add 10.0.11.41 10.0.11.33 esp 0x10001 
	&#45;ctx 1 1 "system_u:system_r:unconfined_t:SystemLow-SystemHigh" 
	&#45;E des-cbc 0x3ffe05014819ffff; 
 
spdadd 10.0.11.41 10.0.11.33 any 
	&#45;ctx 1 1 "system_u:system_r:unconfined_t:SystemLow-SystemHigh" 
	&#45;P out ipsec esp/transport//require ;</pre>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html3/ipsec_set_policy.html">ipsec_set_policy(3)</a>, <a class="link-man" href="../html8/racoon.html">racoon(8)</a>, <a class="link-man" href="../html8/sysctl.html">sysctl(8)</a><p>
<span class="ref"><span class="ref-title">Changed manual key configuration for IPsec</span>, <a class="link-ref" href="http://www.kame.net/newsletter/19991007/">http://www.kame.net/newsletter/19991007/</a>, <span class="ref-date">October 1999</span>.</span></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">setkey</b> command first appeared in the WIDE Hydrangea IPv6 protocol stack kit. The command was completely re-designed in June 1998.</div>
<div class="section">
<h1 id="x42554753">BUGS</h1> <b class="name">setkey</b> should report and handle syntax errors better.<p>
For IPsec gateway configuration, <i class="arg">src_range</i> and <i class="arg">dst_range</i> with TCP/UDP port numbers does not work, as the gateway does not reassemble packets (it cannot inspect upper-layer headers).</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
February 18, 2012</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

