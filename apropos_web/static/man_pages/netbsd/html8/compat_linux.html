<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
COMPAT_LINUX(8)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
COMPAT_LINUX(8)</td>
<td class="head-vol" align="center">
System Manager's Manual</td>
<td class="head-rtitle" align="right">
COMPAT_LINUX(8)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">compat_linux</b> &#8212; <span class="desc">setup procedure for running Linux binaries</span></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> <span class="unix">NetBSD</span> supports running Linux binaries. This applies to amd64, arm, alpha, i386, m68k, and powerpc systems for now. Both the a.out and ELF binary formats are supported. Most programs should work, including the ones that use the Linux SVGAlib (only on i386). <span class="unix">NetBSD</span> amd64 can execute both 32bit and 64bit linux programs. Programs that will not work include some that use i386-specific calls, such as enabling virtual 8086 mode. Currently, sound is only partially supported for Linux binaries (they will probably run, depending on what Linux sound support features are used).<p>
The Linux compatibility feature is active for kernels compiled with the <span class="define">COMPAT_LINUX</span> option enabled. If support for Linux a.out executables is desired, the <span class="define">EXEC_AOUT</span> option should be enabled in addition to option <span class="define">COMPAT_LINUX</span>. Similarly, if support for Linux 32-bit and/or 64-bit ELF executables is desired, the <span class="define">EXEC_ELF32</span> and/or <span class="define">EXEC_ELF64</span> options (respectively) should be enabled in addition to <span class="define">COMPAT_LINUX</span>.<p>
A lot of programs are dynamically linked. This means that you will also need the Linux shared libraries that the program depends on, and the runtime linker. Also, you will need to create a &#8220;shadow root&#8221; directory for Linux binaries on your <span class="unix">NetBSD</span> system. This directory is named <i class="file">/emul/linux</i> or <i class="file">/emul/linux32</i> for 32bit emulation on 64bit systems. Any file operations done by Linux programs run under <span class="unix">NetBSD</span> will look in this directory first. So, if a Linux program opens, for example, <i class="file">/etc/passwd</i>, <span class="unix">NetBSD</span> will first try to open <i class="file">/emul/linux/etc/passwd</i>, and if that does not exist open the &#8216;real&#8217; <i class="file">/etc/passwd</i> file. It is recommended that you install Linux packages that include configuration files, etc under <i class="file">/emul/linux</i>, to avoid naming conflicts with possible <span class="unix">NetBSD</span> counterparts. Shared libraries should also be installed in the shadow tree. Filenames that start "/../" are only looked up in the real root.<p>
Generally, you will need to look for the shared libraries that Linux binaries depend on only the first few times that you install a Linux program on your <span class="unix">NetBSD</span> system. After a while, you will have a sufficient set of Linux shared libraries on your system to be able to run newly imported Linux binaries without any extra work.<div class="subsection">
<h2 id="x53657474696e6720757020736861726564206c6962726172696573">Setting up shared libraries</h2> How to get to know which shared libraries Linux binaries need, and where to get them? Basically, there are 2 possibilities (when following these instructions: you will need to be root on your <span class="unix">NetBSD</span> system to do the necessary installation steps).<ol style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-enum">
<li class="list-enum" style="margin-top: 1.00em;">
For i386, you can simply install the SuSE shared libs using the <i class="file">pkgsrc/emulators/suse100_linux</i> package(s). On PowerPC ports, the <i class="file">pkgsrc/emulators/linuxppc_lib</i> will install the needed libraries. If you are on other platforms, or this doesn't supply you with all the needed libraries, read on.</li>
<li class="list-enum" style="margin-top: 1.00em;">
You have access to a Linux system. In this case you can temporarily install the binary there, see what shared libraries it needs, and copy them to your <span class="unix">NetBSD</span> system. Example: you have just ftp-ed the Linux binary of Doom. Put it on the Linux system you have access to, and check which shared libraries it needs by running &#8216;ldd linuxxdoom&#8217;:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
(me@linux) ldd linuxxdoom 
     libXt.so.3 (DLL Jump 3.1) =&gt; /usr/X11/lib/libXt.so.3.1.0 
     libX11.so.3 (DLL Jump 3.1) =&gt; /usr/X11/lib/libX11.so.3.1.0 
     libc.so.4 (DLL Jump 4.5pl26) =&gt; /lib/libc.so.4.6.29</pre>
<p>
You would need go get all the files from the last column, and put them under <i class="file">/emul/linux</i>, with the names in the first column as symbolic links pointing to them. This means you eventually have these files on your <span class="unix">NetBSD</span> system:<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-item">
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/usr/X11/lib/libXt.so.3.1.0</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/usr/X11/lib/libXt.so.3</i> (symbolic link to the above)</li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/usr/X11/lib/libX11.so.3.1.0</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/usr/X11/lib/libX11.so.3</i> (symbolic link to the above)</li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/lib/libc.so.4.6.29</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/lib/libc.so.4</i> (symbolic link to the above)</li>
</ul>
<p>
Note that if you already have a Linux shared library with a matching major revision number to the first column of the <a class="link-man" href="../1/ldd">ldd(1)</a> output, you won't need to copy the file named in the last column to your system, the one you already have should work. It is advisable to copy the shared library anyway if it is a newer version, though. You can remove the old one, as long as you make the symbolic link point to the new one. So, if you have these libraries on your system:<p>
<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-item">
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/lib/libc.so.4.6.27</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/lib/libc.so.4</i> -&gt; <i class="file">/emul/linux/lib/libc.so.4.6.27</i></li>
</ul>
<p>
and you find that the <b class="cmd">ldd</b> output for a new binary you want to install is:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
libc.so.4 (DLL Jump 4.5pl26) =&gt; /lib/libc.so.4.6.29</pre>
<p>
you won't need to worry about copying <i class="file">/lib/libc.so.4.6.29</i> too, because the program should work fine with the slightly older version. You can decide to replace the libc.so anyway, and that should leave you with:<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-item">
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/lib/libc.so.4.6.29</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/lib/libc.so.4</i> -&gt; <i class="file">/emul/linux/lib/libc.so.4.6.29</i></li>
</ul>
<p>
Please note that the symbolic link mechanism is <span class="emph">only</span> needed for Linux binaries, the <span class="unix">NetBSD</span> runtime linker takes care of looking for matching major revision numbers itself, you don't need to worry about that.<p>
Finally, you must make sure that you have the Linux runtime linker and its config files on your system. You should copy these files from the Linux system to their appropriate place on your <span class="unix">NetBSD</span> system (in the <i class="file">/emul/linux</i> tree):<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-item">
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/lib/ld.so</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/etc/ld.so.cache</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/etc/ld.so.config</i></li>
</ul>
</li>
<li class="list-enum" style="margin-top: 1.00em;">
You don't have access to a Linux system. In that case, you should get the extra files you need from various ftp sites. Information on where to look for the various files is appended below. For now, let's assume you know where to get the files.<p>
Retrieve the following files (from _one_ ftp site to avoid any version mismatches), and install them under <i class="file">/emul/linux</i> (i.e. <i class="file">/foo/bar</i> is installed as <i class="file">/emul/linux/foo/bar</i>):<p>
<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-item">
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/sbin/ldconfig</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/usr/bin/ldd</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/lib/libc.so.x.y.z</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/lib/ld.so</i></li>
</ul>
<p>
<b class="cmd">ldconfig</b> and <b class="cmd">ldd</b> don't necessarily need to be under <i class="file">/emul/linux</i>, you can install them elsewhere in the system too. Just make sure they don't conflict with their <span class="unix">NetBSD</span> counterparts. A good idea would be to install them in <i class="file">/usr/local/bin</i> as <b class="cmd">ldconfig-linux</b> and <b class="cmd">ldd-linux</b>.<p>
Create the file <i class="file">/emul/linux/etc/ld.so.conf</i>, containing the directories in which the Linux runtime linker should look for shared libs. It is a plain text file, containing a directory name on each line. <i class="file">/lib</i> and <i class="file">/usr/lib</i> are standard, you could add the following:<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-item">
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/usr/X11/lib</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/usr/local/lib</i></li>
</ul>
<p>
Note that these are mapped to <i class="file">/emul/linux/XXXX</i> by <span class="unix">NetBSD</span>&#39;s compat code, and should exist as such on your system.<p>
Run the Linux <b class="cmd">ldconfig</b> program. It should be statically linked, so it doesn't need any shared libraries by itself. It will create the file <i class="file">/emul/linux/etc/ld.so.cache</i> You should rerun the Linux version of <b class="cmd">ldconfig</b> each time you add a new shared library.<p>
You should now be set up for Linux binaries which only need a shared libc. You can test this by running the Linux <b class="cmd">ldd</b> on itself. Suppose that you have it installed as <b class="cmd">ldd-linux</b>, it should produce something like:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
(me@netbsd) ldd-linux `which ldd-linux`</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
libc.so.4 (DLL Jump 4.5pl26) =&gt; /lib/libc.so.4.6.29</dd>
</dl>
<p>
This being done, you are ready to install new Linux binaries. Whenever you install a new Linux program, you should check if it needs shared libraries, and if so, whether you have them installed in the <i class="file">/emul/linux</i> tree. To do this, you run the Linux <b class="cmd">ldd</b> on the new program, and watch its output. <b class="cmd">ldd</b> (see also the manual page for <a class="link-man" href="../1/ldd">ldd(1)</a>) will print a list of shared libraries that the program depends on, in the form &#60;majorname&#62; (&#60;jumpversion&#62;) =&gt; &#60;fullname&#62;.<p>
If it prints &#8220;not found&#8221; instead of &#60;fullname&#62; it means that you need an extra library. Which library this is, is shown in &#60;majorname&#62;, which will be of the form libXXXX.so.&lt;N&gt; You will need to find a libXXXX.so.&lt;N&gt;.&lt;mm&gt; on a Linux ftp site, and install it on your system. The XXXX (name) and &#60;N&#62; (major revision number) should match; the minor number(s) &#60;mm&#62; are less important, though it is advised to take the most recent version.</li>
<li class="list-enum" style="margin-top: 1.00em;">
Set up linux specific devices:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
(me@netbsd) cd /usr/share/examples/emul/linux/etc</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
<div style="height: 0.00em;">
&#160;</div>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
(me@netbsd) cp LINUX_MAKEDEV /emul/linux/dev</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
<div style="height: 0.00em;">
&#160;</div>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
(me@netbsd) cd /emul/linux/dev &amp;&amp; sh LINUX_MAKEDEV all</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
</dd>
</dl>
</li>
</ol>
</div>
<div class="subsection">
<h2 id="x53657474696e672075702070726f636673">Setting up procfs</h2> Some Linux binaries expect procfs to be mounted and that it would contain some Linux specific stuff. If it's not the case, they behave unexpectedly or even crash.<p>
Mount procfs on <span class="unix">NetBSD</span> using following command:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
(me@netbsd) mount_procfs -o linux procfs /emul/linux/proc</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
</dd>
</dl>
<p>
You can also set up your system so that procfs is mounted automatically on system boot, by putting an entry like the one below to <i class="file">/etc/fstab</i>.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
procfs /emul/linux/proc procfs ro,linux</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
</dd>
</dl>
<p>
See <a class="link-man" href="../8/mount_procfs">mount_procfs(8)</a> for further information.</div>
<div class="subsection">
<h2 id="x53657474696e67207570206f746865722066696c6573">Setting up other files</h2> Newer version of Linux use <i class="file">/etc/nsswitch.conf</i> for network information, such as NIS and DNS. You must create or get a valid copy of this file and put it in <i class="file">/emul/linux/etc</i>.</div>
<div class="subsection">
<h2 id="x46696e64696e6720746865206e65636573736172792066696c6573">Finding the necessary files</h2> <span class="emph">Note</span>: the information below is valid as of the time this document was first written (March, 1995), but certain details such as names of ftp sites, directories and distribution names may have changed by the time you read this.<p>
Linux is distributed by several groups that make their own set of binaries that they distribute. Each distribution has its own name, like &#8220;Slackware&#8221; or &#8220;Yggdrasil&#8221;. The distributions are available on a lot of ftp sites. Sometimes the files are unpacked, and you can get the individual files you need, but mostly they are stored in distribution sets, usually consisting of subdirectories with gzipped tar files in them. The primary ftp sites for the distributions are:<ul style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-item">
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">sunsite.unc.edu:/pub/Linux/distributions</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">tsx-11.mit.edu:/pub/linux/distributions</i></li>
</ul>
<p>
Some European mirrors:<ul style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-item">
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">ftp.luth.se:/pub/linux/distributions</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">ftp.demon.co.uk:/pub/linux/distributions</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">src.doc.ic.ac.uk:/packages/linux/distributions</i></li>
</ul>
<p>
For simplicity, let's concentrate on Slackware here. This distribution consists of a number of subdirectories, containing separate packages. Normally, they're controlled by an install program, but you can retrieve files &#8220;by hand&#8221; too. First of all, you will need to look in the <i class="file">contents</i> subdir of the distribution. You will find a lot of small textfiles here describing the contents of the separate packages. The fastest way to look something up is to retrieve all the files in the contents subdirectory, and grep through them for the file you need. Here is an example of a list of files that you might need, and in which contents-file you will find it by grepping through them:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
Needed                  Package 
 
ld.so                   ldso 
ldconfig                ldso 
ldd                     ldso 
libc.so.4               shlibs 
libX11.so.6.0           xf_lib 
libXt.so.6.0            xf_lib 
libX11.so.3             oldlibs 
libXt.so.3              oldlibs</pre>
<p>
So, in this case, you will need the packages ldso, shlibs, xf_lib and oldlibs. In each of the contents-files for these packages, look for a line saying &#8220;PACKAGE LOCATION&#8221;, it will tell you on which &#8216;disk&#8217; the package is, in our case it will tell us in which subdirectory we need to look. For our example, we would find the following locations:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
Package                 Location 
 
ldso                    diska2 
shlibs                  diska2 
oldlibs                 diskx6 
xf_lib                  diskx9</pre>
<p>
The locations called <i class="file">diskXX</i> refer to the <i class="file">slakware/XX</i> subdirectories of the distribution, others may be found in the <i class="file">contrib</i> subdirectory. In this case, we could now retrieve the packages we need by retrieving the following files (relative to the root of the Slackware distribution tree):<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-item">
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">slakware/a2/ldso.tgz</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">slakware/a2/shlibs.tgz</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">slakware/x6/oldlibs/tgz</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">slakware/x9/xf_lib.tgz</i></li>
</ul>
<p>
Extract the files from these gzipped tarfiles in your /emul/linux directory (possibly omitting or afterwards removing files you don't need), and you are done.</div>
<div class="subsection">
<h2 id="x50726f6772616d73207573696e6720535647416c6962">Programs using SVGAlib</h2> SVGAlib binaries require some extra care. You need to have <b class="config">options WSDISPLAY_COMPAT_USL</b> in your kernel (see <a class="link-man" href="../4/wscons">wscons(4)</a>), and you will also have to create some symbolic links in the <i class="file">/emul/linux/dev</i> directory, namely:<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-item">
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/dev/console</i> -&gt; <i class="file">/dev/tty</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/dev/mouse</i> -&gt; whatever device your mouse is connected to</li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/dev/ttyS0</i> -&gt; <i class="file">/dev/tty00</i></li>
<li class="list-item" style="margin-top: 0.00em;">
<i class="file">/emul/linux/dev/ttyS1</i> -&gt; <i class="file">/dev/tty01</i></li>
</ul>
<p>
Be warned: the first link mentioned here makes SVGAlib binaries work, but may confuse others, so you may have to remove it again at some point.</div>
</div>
<div class="section">
<h1 id="x42554753">BUGS</h1> The information about Linux distributions may become outdated.<p>
Absolute pathnames pointed to by symbolic links are only looked up in the shadow root when the symbolic link itself was found by an absolute pathname inside the shadow root. This is not consistent.<p>
Linux executables cannot handle directory offset cookies &gt; 32 bits. Should such an offset occur, you will see the message &#8220;linux_getdents: dir offset too large for emulated program&#8221;. Currently, this can only happen on NFS mounted file systems, mounted from servers that return offsets with information in the upper 32 bits. These errors should rarely happen, but can be avoided by mounting this file system with offset translation enabled. See the <b class="flag">&#45;X</b> option to <a class="link-man" href="../8/mount_nfs">mount_nfs(8)</a>. The <b class="flag">&#45;2</b> option to <a class="link-man" href="../8/mount_nfs">mount_nfs(8)</a> will also have the desired effect, but is less preferable.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
April 30, 2007</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

