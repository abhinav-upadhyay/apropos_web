<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
ANVIL(8)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
ANVIL(8)</td>
<td class="head-vol" align="center">
System Manager's Manual</td>
<td class="head-rtitle" align="right">
ANVIL(8)</td>
</tr>
</tbody>
</table>
<br>
<div class="section">
<h1>NAME</h1> anvil &#45; Postfix session count and request rate control</div>
<div class="section">
<h1>SYNOPSIS</h1><br>
<b>anvil</b> [generic Postfix daemon options]</div>
<div class="section">
<h1>DESCRIPTION</h1><br>
The Postfix <b>anvil</b>(8) server maintains statistics about client connection counts or client request rates. This information can be used to defend against clients that hammer a server with either too many simultaneous sessions, or with too many successive requests within a configurable time interval.  This server is designed to run under control by the Postfix  <b>master</b>(8) server.<div style="height: 1.00em;">
&#160;</div>
In the following text, <b>ident</b> specifies a (service, client) combination. The exact syntax of that information is application-dependent; the  <b>anvil</b>(8) server does not care.</div>
<div class="section">
<h1>CONNECTION COUNT/RATE CONTROL</h1><br>
To register a new connection send the following request to the  <b>anvil</b>(8) server:<div style="height: 1.00em;">
&#160;</div>
<br>
    <b>request=connect</b><br>
    <b>ident=</b><i>string</i><br>
<div style="height: 1.00em;">
&#160;</div>
The <b>anvil</b>(8) server answers with the number of simultaneous connections and the number of connections per unit time for the (service, client) combination specified with  <b>ident</b>:<div style="height: 1.00em;">
&#160;</div>
<br>
    <b>status=0</b><br>
    <b>count=</b><i>number</i><br>
    <b>rate=</b><i>number</i><br>
<div style="height: 1.00em;">
&#160;</div>
To register a disconnect event send the following request to the  <b>anvil</b>(8) server:<div style="height: 1.00em;">
&#160;</div>
<br>
    <b>request=disconnect</b><br>
    <b>ident=</b><i>string</i><br>
<div style="height: 1.00em;">
&#160;</div>
The <b>anvil</b>(8) server replies with:<div style="height: 1.00em;">
&#160;</div>
<br>
    <b>status=0</b><br>
</div>
<div class="section">
<h1>MESSAGE RATE CONTROL</h1><br>
To register a message delivery request send the following request to the  <b>anvil</b>(8) server:<div style="height: 1.00em;">
&#160;</div>
<br>
    <b>request=message</b><br>
    <b>ident=</b><i>string</i><br>
<div style="height: 1.00em;">
&#160;</div>
The <b>anvil</b>(8) server answers with the number of message delivery requests per unit time for the (service, client) combination specified with  <b>ident</b>:<div style="height: 1.00em;">
&#160;</div>
<br>
    <b>status=0</b><br>
    <b>rate=</b><i>number</i><br>
</div>
<div class="section">
<h1>RECIPIENT RATE CONTROL</h1><br>
To register a recipient request send the following request to the  <b>anvil</b>(8) server:<div style="height: 1.00em;">
&#160;</div>
<br>
    <b>request=recipient</b><br>
    <b>ident=</b><i>string</i><br>
<div style="height: 1.00em;">
&#160;</div>
The <b>anvil</b>(8) server answers with the number of recipient addresses per unit time for the (service, client) combination specified with  <b>ident</b>:<div style="height: 1.00em;">
&#160;</div>
<br>
    <b>status=0</b><br>
    <b>rate=</b><i>number</i><br>
</div>
<div class="section">
<h1>TLS SESSION NEGOTIATION RATE CONTROL</h1><br>
The features described in this section are available with Postfix 2.3 and later.<div style="height: 1.00em;">
&#160;</div>
To register a request for a new (i.e. not cached) TLS session send the following request to the  <b>anvil</b>(8) server:<div style="height: 1.00em;">
&#160;</div>
<br>
    <b>request=newtls</b><br>
    <b>ident=</b><i>string</i><br>
<div style="height: 1.00em;">
&#160;</div>
The <b>anvil</b>(8) server answers with the number of new TLS session requests per unit time for the (service, client) combination specified with  <b>ident</b>:<div style="height: 1.00em;">
&#160;</div>
<br>
    <b>status=0</b><br>
    <b>rate=</b><i>number</i><br>
<div style="height: 1.00em;">
&#160;</div>
To retrieve new TLS session request rate information without updating the counter information, send:<div style="height: 1.00em;">
&#160;</div>
<br>
    <b>request=newtls_report</b><br>
    <b>ident=</b><i>string</i><br>
<div style="height: 1.00em;">
&#160;</div>
The <b>anvil</b>(8) server answers with the number of new TLS session requests per unit time for the (service, client) combination specified with  <b>ident</b>:<div style="height: 1.00em;">
&#160;</div>
<br>
    <b>status=0</b><br>
    <b>rate=</b><i>number</i><br>
</div>
<div class="section">
<h1>SECURITY</h1><br>
The <b>anvil</b>(8) server does not talk to the network or to local users, and can run chrooted at fixed low privilege.<div style="height: 1.00em;">
&#160;</div>
The <b>anvil</b>(8) server maintains an in-memory table with information about recent clients requests.  No persistent state is kept because standard system library routines are not sufficiently robust for update-intensive applications.<div style="height: 1.00em;">
&#160;</div>
Although the in-memory state is kept only temporarily, this may require a lot of memory on systems that handle connections from many remote clients.  To reduce memory usage, reduce the time unit over which state is kept.</div>
<div class="section">
<h1>DIAGNOSTICS</h1><br>
Problems and transactions are logged to <b>syslogd</b>(8).<div style="height: 1.00em;">
&#160;</div>
Upon exit, and every <b>anvil_status_update_time</b> seconds, the server logs the maximal count and rate values measured, together with (service, client) information and the time of day associated with those events. In order to avoid unnecessary overhead, no measurements are done for activity that isn't concurrency limited or rate limited.</div>
<div class="section">
<h1>BUGS</h1><br>
Systems behind network address translating routers or proxies appear to have the same client address and can run into connection count and/or rate limits falsely.<div style="height: 1.00em;">
&#160;</div>
In this preliminary implementation, a count (or rate) limited server process can have only one remote client at a time. If a server process reports multiple simultaneous clients, state is kept only for the last reported client.<div style="height: 1.00em;">
&#160;</div>
The <b>anvil</b>(8) server automatically discards client request information after it expires.  To prevent the  <b>anvil</b>(8) server from discarding client request rate information too early or too late, a rate limited service should always register connect/disconnect events even when it does not explicitly limit them.</div>
<div class="section">
<h1>CONFIGURATION PARAMETERS</h1><br>
On low-traffic mail systems, changes to <b>main.cf</b> are picked up automatically as  <b>anvil</b>(8) processes run for only a limited amount of time. On other mail systems, use the command " <b>postfix reload</b>" to speed up a change.<div style="height: 1.00em;">
&#160;</div>
The text below provides only a parameter summary. See  <b>postconf</b>(5) for more details including examples.<dl>
<dt>
<b>anvil_rate_time_unit (60s)</b></dt>
<dd>
The time unit over which client connection rates and other rates are calculated.</dd>
</dl>
<dl>
<dt>
<b>anvil_status_update_time (600s)</b></dt>
<dd>
How frequently the <b>anvil</b>(8) connection and rate limiting server logs peak usage information.</dd>
</dl>
<dl>
<dt>
<b>config_directory (see 'postconf -d' output)</b></dt>
<dd>
The default location of the Postfix main.cf and master.cf configuration files.</dd>
</dl>
<dl>
<dt>
<b>daemon_timeout (18000s)</b></dt>
<dd>
How much time a Postfix daemon process may take to handle a request before it is terminated by a built-in watchdog timer.</dd>
</dl>
<dl>
<dt>
<b>ipc_timeout (3600s)</b></dt>
<dd>
The time limit for sending or receiving information over an internal communication channel.</dd>
</dl>
<dl>
<dt>
<b>max_idle (100s)</b></dt>
<dd>
The maximum amount of time that an idle Postfix daemon process waits for an incoming connection before terminating voluntarily.</dd>
</dl>
<dl>
<dt>
<b>max_use (100)</b></dt>
<dd>
The maximal number of incoming connections that a Postfix daemon process will service before terminating voluntarily.</dd>
</dl>
<dl>
<dt>
<b>process_id (read-only)</b></dt>
<dd>
The process ID of a Postfix command or daemon process.</dd>
</dl>
<dl>
<dt>
<b>process_name (read-only)</b></dt>
<dd>
The process name of a Postfix command or daemon process.</dd>
</dl>
<dl>
<dt>
<b>syslog_facility (mail)</b></dt>
<dd>
The syslog facility of Postfix logging.</dd>
</dl>
<dl>
<dt>
<b>syslog_name (see 'postconf -d' output)</b></dt>
<dd>
The mail system name that is prepended to the process name in syslog records, so that "smtpd" becomes, for example, "postfix/smtpd".</dd>
</dl>
</div>
<div class="section">
<h1>SEE ALSO</h1><br>
smtpd(8), Postfix SMTP server<br>
postconf(5), configuration parameters<br>
master(5), generic daemon options</div>
<div class="section">
<h1>README FILES</h1><br>
Use "<b>postconf readme_directory</b>" or " <b>postconf html_directory</b>" to locate this information.<br>
TUNING_README, performance tuning</div>
<div class="section">
<h1>LICENSE</h1><br>
The Secure Mailer license must be distributed with this software.</div>
<div class="section">
<h1>HISTORY</h1><br>
The anvil service is available in Postfix 2.2 and later.</div>
<div class="section">
<h1>AUTHOR(S)</h1><br>
Wietse Venema<br>
IBM T.J. Watson Research<br>
P.O. Box 704<br>
Yorktown Heights, NY 10598, USA</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tr>
<td class="foot-date">
</td>
<td class="foot-os" align="right">
</td>
</tr>
</table>
</div>
</body>
</html>

