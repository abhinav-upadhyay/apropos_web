<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/../4/strict.dtd">
>
<head>
<meta http-equiv="Content-Type" content="te../; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
SETUID(7)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
SETUID(7)</td>
<td class="head-vol" align="center">
Miscellaneous Information Manual</td>
<td class="head-rtitle" align="right">
SETUID(7)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">setuid</b> &#8212; <span class="desc">checklist for security of setuid programs</span></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> <span class="emph">Please note</span>: This manual page was written long ago, and is in need of updating to match today's systems. We think it is valuable enough to include, even though parts of it are outdated. A carefully-researched updated version would be very useful, if anyone is feeling enthusiastic...<p>
Writing a secure setuid (or setgid) program is tricky. There are a number of possible ways of subverting such a program. The most conspicuous security holes occur when a setuid program is not sufficiently careful to avoid giving away access to resources it legitimately has the use of. Most of the other attacks are basically a matter of altering the program's environment in unexpected ways and hoping it will fail in some security-breaching manner. There are generally three categories of environment manipulation: supplying a legal but unexpected environment that may cause the program to directly do something insecure, arranging for error conditions that the program may not handle correctly, and the specialized subcategory of giving the program inadequate resources in hopes that it won't respond properly.<p>
The following are general considerations of security when writing a setuid program.<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-bul">
<li class="list-bul" style="margin-top: 1.00em;">
The program should run with the weakest userid possible, preferably one used only by itself. A security hole in a setuid program running with a highly-privileged userid can compromise an entire system. Security-critical programs like <a class="link-man" href="../1/passwd">passwd(1)</a> should always have private userids, to minimize possible damage from penetrations elsewhere.</li>
<li class="list-bul" style="margin-top: 1.00em;">
The result of <a class="link-man" href="../2/getlogin">getlogin(2)</a> or <a class="link-man" href="../3/ttyname">ttyname(3)</a> may be wrong if the descriptors have been meddled with. There is <span class="emph">no</span> foolproof way to determine the controlling terminal or the login name (as opposed to uid) on V7.</li>
<li class="list-bul" style="margin-top: 1.00em;">
On some systems, the setuid bit may not be honored if the program is run by root, so the program may find itself running as root.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Programs that attempt to use <a class="link-man" href="../3/creat">creat(3)</a> for locking can foul up when run by root; use of <a class="link-man" href="../2/link">link(2)</a> is preferred when implementing locking. Using <a class="link-man" href="../2/chmod">chmod(2)</a> for locking is an obvious disaster.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Breaking an existing lock is very dangerous; the breakdown of a locking protocol may be symptomatic of far worse problems. Doing so on the basis of the lock being &#8216;old&#8217; is sometimes necessary, but programs can run for surprising lengths of time on heavily-loaded systems.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Care must be taken that user requests for I/O are checked for permissions using the user's permissions, not the program's. Use of <a class="link-man" href="../2/access">access(2)</a> is recommended.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Programs executed at user request (e.g. shell escapes) must not receive the setuid program's permissions; use of daughter processes and &#8220;setuid(getuid())&#8221; plus &#8220;setgid(getgid())&#8221; after <a class="link-man" href="../2/fork">fork(2)</a> but before <a class="link-man" href="../3/exec">exec(3)</a> is vital.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Similarly, programs executed at user request must not receive other sensitive resources, notably file descriptors. Use of <a class="link-man" href="../2/fcntl">fcntl(2)</a> <span class="define">F_CLOSEM</span>, <span class="define">FILENO_STDERR + 1</span> (close all fd's greater than stderr) and/or <a class="link-man" href="../2/fcntl">fcntl(2)</a> <span class="define">F_SETFD</span>, <span class="define">FD_CLOEXEC</span> (close-on-exec) arrangements on systems which have them is recommended.<p>
Other resources should also be examined for sanity and possibly set to desired settings, such as the current working directory, signal disposition, resource limits, environment, umask, group membership, chroot.<p>
Programs activated by one user but handling traffic on behalf of others (e.g. daemons) should avoid doing &#8220;setuid(getuid())&#8221; or &#8220;setgid(getgid())&#8221;, since the original invoker's identity is almost certainly inappropriate. On systems which permit it, use of &#8220;setuid(geteuid())&#8221; and &#8220;setgid(getegid())&#8221; is recommended when performing work on behalf of the system as opposed to a specific user.</li>
<li class="list-bul" style="margin-top: 1.00em;">
There are inherent permission problems when a setuid program executes another setuid program, since the permissions are not additive. Care should be taken that created files are not owned by the wrong person. Use of &#8220;setuid(geteuid())&#8221; and its gid counterpart can help, if the system allows them.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Care should be taken that newly-created files do not have the wrong permission or ownership even momentarily. Permissions should be arranged by using <a class="link-man" href="../2/umask">umask(2)</a> in advance, rather than by creating the file wide-open and then using <a class="link-man" href="../2/chmod">chmod(2)</a>. Ownership can get sticky due to the limitations of the setuid concept, although using a daughter process connected by a pipe can help.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Setuid programs should be especially careful about error checking, and the normal response to a strange situation should be termination, rather than an attempt to carry on.</li>
</ul>
<p>
The following are ways in which the program may be induced to carelessly give away its special privileges.<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-bul">
<li class="list-bul" style="margin-top: 1.00em;">
The directory the program is started in, or directories it may plausibly <a class="link-man" href="../2/chdir">chdir(2)</a> to, may contain programs with the same names as system programs, placed there in hopes that the program will activate a shell with a permissive <span class="env">PATH</span> setting. <span class="env">PATH</span> should <span class="emph">always</span> be standardized before invoking a shell (either directly or via <a class="link-man" href="../3/popen">popen(3)</a> or <a class="link-man" href="../3/execvp">execvp(3)</a> or <a class="link-man" href="../3/execlp">execlp(3)</a>).</li>
<li class="list-bul" style="margin-top: 1.00em;">
Similarly, a bizarre <span class="env">IFS</span> setting may alter the interpretation of a shell command in really strange ways, possibly causing a user-supplied program to be invoked. <span class="env">IFS</span> too should always be standardized before invoking a shell.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Environment variables in general cannot be trusted. Their contents should never be taken for granted.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Setuid shell files (on systems which implement such) simply cannot cope adequately with some of these problems. They also have some nasty problems like trying to run a <i class="file">.profile</i> when run under a suitable name. They are terminally insecure, and must be avoided.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Relying on the contents of files placed in publically-writable directories, such as <i class="file">/tmp</i>, is a nearly-incurable security problem. Setuid programs should avoid using <i class="file">/tmp</i> entirely, if humanly possible. The sticky-directories modification (sticky bit on for a directory means only owner of a file can remove it) helps, but is not a complete solution.</li>
<li class="list-bul" style="margin-top: 1.00em;">
A related problem is that spool directories, holding information that the program will trust later, must never be publically writable even if the files in the directory are protected. Among other sinister manipulations that can be performed, note that on many Unixes, a core dump of a setuid program is owned by the program's owner and not by the user running it.</li>
</ul>
<p>
The following are unusual but possible error conditions that the program should cope with properly (resource-exhaustion questions are considered separately, see below).<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-bul">
<li class="list-bul" style="margin-top: 1.00em;">
The value of <i class="arg">argc</i> might be 0.</li>
<li class="list-bul" style="margin-top: 1.00em;">
The setting of the <a class="link-man" href="../2/umask">umask(2)</a> might not be sensible. In any case, it should be standardized when creating files not intended to be owned by the user.</li>
<li class="list-bul" style="margin-top: 1.00em;">
One or more of the standard descriptors might be closed, so that an opened file might get (say) descriptor 1, causing chaos if the program tries to do a <a class="link-man" href="../3/printf">printf(3)</a>.</li>
<li class="list-bul" style="margin-top: 1.00em;">
The current directory (or any of its parents) may be unreadable and unsearchable. On many systems <a class="link-man" href="../1/pwd">pwd(1)</a> does not run setuid-root, so it can fail under such conditions.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Descriptors shared by other processes (i.e., any that are open on startup) may be manipulated in strange ways by said processes.</li>
<li class="list-bul" style="margin-top: 1.00em;">
The standard descriptors may refer to a terminal which has a bizarre mode setting, or which cannot be opened again, or which gives end-of-file on any read attempt, or which cannot be read or written successfully.</li>
<li class="list-bul" style="margin-top: 1.00em;">
The process may be hit by interrupt, quit, hangup, or broken-pipe signals, singly or in fast succession. The user may deliberately exploit the race conditions inherent in catching signals; ignoring signals is safe, but catching them is not.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Although non-keyboard signals cannot be sent by ordinary users in V7, they may perhaps be sent by the system authorities (e.g. to indicate that the system is about to shut down), so the possibility cannot be ignored.</li>
<li class="list-bul" style="margin-top: 1.00em;">
On some systems there may be an <a class="link-man" href="../3/alarm">alarm(3)</a> signal pending on startup.</li>
<li class="list-bul" style="margin-top: 1.00em;">
The program may have children it did not create. This is normal when the process is part of a pipeline.</li>
<li class="list-bul" style="margin-top: 1.00em;">
In some non-V7 systems, users can change the ownerships of their files. Setuid programs should avoid trusting the owner identification of a file.</li>
<li class="list-bul" style="margin-top: 1.00em;">
User-supplied arguments and input data <span class="emph">must</span> be checked meticulously. Overly-long input stored in an array without proper bound checking can easily breach security. When software depends on a file being in a specific format, user-supplied data should never be inserted into the file without being checked first. Meticulous checking includes allowing for the possibility of non-ASCII characters.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Temporary files left in public directories like <i class="file">/tmp</i> might vanish at inconvenient times.</li>
</ul>
<p>
The following are resource-exhaustion possibilities that the program should respond properly to.<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-bul">
<li class="list-bul" style="margin-top: 1.00em;">
The user might have used up all of his allowed processes, so any attempt to create a new one (via <a class="link-man" href="../2/fork">fork(2)</a> or <a class="link-man" href="../3/popen">popen(3)</a>) will fail.</li>
<li class="list-bul" style="margin-top: 1.00em;">
There might be many files open, exhausting the supply of descriptors. Running <a class="link-man" href="../2/fcntl">fcntl(2)</a> <span class="define">F_CLOSEM</span> on systems which have it, is recommended.</li>
<li class="list-bul" style="margin-top: 1.00em;">
There might be many arguments.</li>
<li class="list-bul" style="margin-top: 1.00em;">
The arguments and the environment together might occupy a great deal of space.</li>
</ul>
<p>
Systems which impose other resource limitations can open setuid programs to similar resource-exhaustion attacks.<p>
Setuid programs which execute ordinary programs without reducing authority pass all the above problems on to such unprepared children. Standardizing the execution environment is only a partial solution.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../1/passwd">passwd(1)</a>, <a class="link-man" href="../1/pwd">pwd(1)</a>, <a class="link-man" href="../2/access">access(2)</a>, <a class="link-man" href="../2/chdir">chdir(2)</a>, <a class="link-man" href="../2/chroot">chroot(2)</a>, <a class="link-man" href="../2/execve">execve(2)</a>, <a class="link-man" href="../2/fcntl">fcntl(2)</a>, <a class="link-man" href="../2/fork">fork(2)</a>, <a class="link-man" href="../2/getlogin">getlogin(2)</a>, <a class="link-man" href="../2/link">link(2)</a>, <a class="link-man" href="../2/setegid">setegid(2)</a>, <a class="link-man" href="../2/seteuid">seteuid(2)</a>, <a class="link-man" href="../2/setgid">setgid(2)</a>, <a class="link-man" href="../2/setgroups">setgroups(2)</a>, <a class="link-man" href="../2/setrlimit">setrlimit(2)</a>, <a class="link-man" href="../2/setuid">setuid(2)</a>, <a class="link-man" href="../2/sigaction">sigaction(2)</a>, <a class="link-man" href="../2/umask">umask(2)</a>, <a class="link-man" href="../3/alarm">alarm(3)</a>, <a class="link-man" href="../3/creat">creat(3)</a>, <a class="link-man" href="../3/execvp">execvp(3)</a>, <a class="link-man" href="../3/popen">popen(3)</a>, <a class="link-man" href="../3/printf">printf(3)</a>, <a class="link-man" href="../3/ttyname">ttyname(3)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> Written by Henry Spencer, and based on additional outside contributions.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> <span class="author">Henry Spencer</span> &#60;<a class="link-mail" href="mailto:henry@spsystems.net">henry@spsystems.net</a>&#62;</div>
<div class="section">
<h1 id="x42554753">BUGS</h1> The list really is rather long... and probably incomplete.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
February 26, 2009</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
<>

