<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/../4/strict.dtd">
>
<head>
<meta http-equiv="Content-Type" content="te../; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
WSKBD(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
WSKBD(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
WSKBD(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">wskbd</b>, <b class="name">wskbd_input</b>, <b class="name">wskbd_rawinput</b>, <b class="name">wskbd_cnattach</b>, <b class="name">wskbd_cndetach</b>, <b class="name">wskbddevprint</b> &#8212; <span class="desc">wscons keyboard support</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">dev/wscons/wsconsio.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">dev/wscons/wskbdvar.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">dev/wscons/wsksymdef.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">dev/wscons/wsksymvar.h</a>&gt;</b><p>
<i class="ftype">void</i><br>
<b class="fname">wskbd_input</b>(<i class="farg" style="white-space:nowrap;">struct device *kbddev</i>, <i class="farg" style="white-space:nowrap;">u_int type</i>, <i class="farg" style="white-space:nowrap;">int value</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">wskbd_rawinput</b>(<i class="farg" style="white-space:nowrap;">struct device *kbddev</i>, <i class="farg" style="white-space:nowrap;">u_char *buf</i>, <i class="farg" style="white-space:nowrap;">int len</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">wskbd_cnattach</b>(<i class="farg" style="white-space:nowrap;">const struct wskbd_consops *consops</i>, <i class="farg" style="white-space:nowrap;">void *conscookie</i>, <i class="farg" style="white-space:nowrap;">const struct wskbd_mapdata *mapdata</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">wskbd_cndetach</b>(<i class="farg" style="white-space:nowrap;"></i>);<p>
<i class="ftype">int</i><br>
<b class="fname">wskbddevprint</b>(<i class="farg" style="white-space:nowrap;">void *aux</i>, <i class="farg" style="white-space:nowrap;">const char *pnp</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">wskbd</b> module is a component of the <a class="link-man" href="../9/wscons">wscons(9)</a> framework to provide machine-independent keyboard support. Most of the support is provided by the <a class="link-man" href="../4/wskbd">wskbd(4)</a> device driver, which must be a child of the hardware device driver.</div>
<div class="section">
<h1 id="x44415441205459504553">DATA TYPES</h1> Keyboard drivers providing support for wscons keyboards will make use of the following data types:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">kbd_t</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
An opaque type describing keyboard properties.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">keysym_t</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
The wscons keyboard-independent symbolic representation of the keypress.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">struct wskbd_accessops</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
A structure used to specify the keyboard access functions. All keyboards must provide this structure and pass it to the <a class="link-man" href="../4/wskbd">wskbd(4)</a> child device. It has the following members:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
	int	(*enable)(void *, int); 
	void	(*set_leds)(void *, int); 
	int	(*ioctl)(void *v, u_long cmd, void *data, 
			int flag, struct lwp *l);</pre>
<p>
The <i class="farg">enable</i> member defines the function to be called to enable keypress passing to wscons. The <i class="farg">set_leds</i> member defined the function to be called to set the LEDs on the keyboard. The <i class="farg">ioctl</i> member defines the function to be called to perform keyboard-specific ioctl calls.<p>
There is a <i class="farg">void *</i> cookie provided by the keyboard driver associated with these functions, which is passed to them when they are invoked.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">struct wskbd_consops</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
A structure used to specify the keyboard console operations. All keyboards which can operate as a console must provide this structure and pass it to the <a class="link-man" href="../4/wskbd">wskbd(4)</a> child device. If the keyboard cannot be a console, it is not necessary to specify this structure. It has the following members:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
	void	(*getc)(void *, u_int *, int *); 
	void	(*pollc)(void *, int); 
	void	(*bell)(void *, u_int, u_int, u_int);</pre>
<p>
There is a <i class="farg">void *</i> cookie provided by the keyboard driver associated with these functions, which is passed to them when they are invoked.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">struct wscons_keydesc</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
A structure used to describe a keyboard mapping table to convert keyboard-specific keycodes to wscons keysyms. It has the following members:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
	kbd_t	name;		/* name of this map */ 
	kbd_t	base;		/* map this one is based on */ 
	int	map_size;	/* size of map */ 
	const	keysym_t *map;	/* the map itself */</pre>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">struct wskbd_mapdata</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
A structure used to describe the keyboard layout and operation to interpret the keyboard layout. it contains the following members:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
        const struct wscons_keydesc *keydesc; 
        kbd_t layout;</pre>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">struct wskbddev_attach_args</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
A structure used to attach the <a class="link-man" href="../4/wskbd">wskbd(4)</a> child device. It has the following members:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
	int console; 
	const struct wskbd_mapdata *keymap; 
	const struct wskbd_accessops *accessops; 
	void *accesscookie;</pre>
</dd>
</dl>
<div class="subsection">
<h2 id="x4b65796d617073">Keymaps</h2> Keymaps are a dense stream of <i class="farg">keysym_t</i>. A declaration has the following fields:<p>
<i class="arg">pos</i> &#91;<span class="opt"><i class="arg">cmd</i></span>&#93; <i class="arg">normal</i> &#91;<span class="opt"><i class="arg">shift</i></span>&#93; &#91;<span class="opt"><i class="arg">altgr</i></span>&#93; &#91;<span class="opt"><i class="arg">shift-altgr</i></span>&#93;<p>
The fields have the following meanings:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">pos</i></dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
Always specified as KC(<i class="arg">pos</i>) and starts the description of key <i class="arg">pos</i>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">cmd</i></dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
If the command modifier (KS_Cmd_XXX) is active, the optional command <i class="arg">cmd</i> is invoked.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">normal</i></dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
The keysym if no modifiers are active.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">shift</i></dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
The keysym if the shift modifier is active.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">altgr</i></dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
The keysym if the alt-gr modifier is active.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="arg">shift-altgr</i></dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
The keysym if the shift-alt-gr modifier is active.</dd>
</dl>
<p>
If the keysym after <i class="arg">pos</i> is not KS_Cmd_XXX, then <i class="arg">cmd</i> is empty. The <i class="arg">shift</i>, <i class="arg">altgr</i> and <i class="arg">shift-altgr</i> fields are determined from previous fields if they are not specified. Therefore, there are four valid keysym declarations:<p>
<i class="arg">pos</i> &#91;<span class="opt"><i class="arg">cmd</i></span>&#93; <i class="arg">normal</i><p>
<i class="arg">pos</i> &#91;<span class="opt"><i class="arg">cmd</i></span>&#93; <i class="arg">normal</i> <i class="arg">shift</i><p>
<i class="arg">pos</i> &#91;<span class="opt"><i class="arg">cmd</i></span>&#93; <i class="arg">normal</i> <i class="arg">shift</i> <i class="arg">altgr</i><p>
<i class="arg">pos</i> &#91;<span class="opt"><i class="arg">cmd</i></span>&#93; <i class="arg">normal</i> <i class="arg">shift</i> <i class="arg">altgr</i> <i class="arg">shift-altgr</i></div>
</div>
<div class="section">
<h1 id="x46554e4354494f4e53">FUNCTIONS</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">wskbd_input</b>(<i class="farg">kbddev</i>, <i class="farg">type</i>, <i class="farg">value</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Pass the keypress of value <i class="farg">value</i> and type <i class="farg">type</i> to wscons keyboard driver. Valid values of <i class="farg">type</i> are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
WSCONS_EVENT_KEY_UP</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Key released.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
WSCONS_EVENT_KEY_DOWN</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Key pressed.</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">wskbd_rawinput</b>(<i class="farg">kbddev</i>, <i class="farg">buf</i>, <i class="farg">len</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Pass the raw keypress in the buffer <i class="farg">buf</i> to the wscons keyboard driver. The buffer is <i class="farg">len</i> bytes long. This function should only be called if the kernel option <span class="emph">WSDISPLAY_COMPAT_RAWKBD</span> is enabled.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">wskbd_cnattach</b>(<i class="farg">consops</i>, <i class="farg">conscookie</i>, <i class="farg">mapdata</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Attach this keyboard as the console input by specifying the console operations <i class="farg">consops</i> and the keyboard mapping table information in <i class="farg">mapdata</i>. The functions specified in <i class="farg">consops</i> will be called with <i class="farg">conscookie</i> as the first argument.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">wskbd_cndetach</b>(<i class="farg"></i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Detach this keyboard as the console input.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">wskbddevprint</b>(<i class="farg">aux</i>, <i class="farg">pnp</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
The default wskbd printing routine used by <b class="fname">config_found</b>(). (see <a class="link-man" href="../9/autoconf">autoconf(9)</a>).</dd>
</dl>
</div>
<div class="section">
<h1 id="x4155544f434f4e46494755524154494f4e">AUTOCONFIGURATION</h1> Keyboard drivers which want to use the wskbd module must be a parent to the <a class="link-man" href="../4/wskbd">wskbd(4)</a> device and provide an attachment interface. To attach the <a class="link-man" href="../4/wskbd">wskbd(4)</a> device, the keyboard driver must allocate and populate a <i class="farg">wskbddev_attach_args</i> structure with the supported operations and callbacks and call <b class="fname">config_found</b>() to perform the attach (see <a class="link-man" href="../9/autoconf">autoconf(9)</a>). The <i class="farg">keymap</i> member points to the <span class="emph">wskbd_mapdata</span> structure which describes the keycode mapping operations. The <i class="farg">accessops</i> member points to the <span class="emph">wskbd_accessops</span> structure which describes the keyboard access operations. The <i class="farg">console</i> member is a boolean to indicate to wscons whether this keyboard will be used for console input.</div>
<div class="section">
<h1 id="x4f5045524154494f4e">OPERATION</h1> If the keyboard belongs to the system console, it must register the <i class="farg">wskbd_consops</i> structure specifying the console operations via <b class="fname">wskbd_cnattach</b>() at console attach time.<p>
When a keypress arrives from the keyboard, the keyboard driver must perform any necessary character decoding to wscons events and pass the events to wscons via <b class="fname">wskbd_input</b>(). If the kernel is compiled with the option <span class="emph">WSDISPLAY_COMPAT_RAWKBD</span>, then the keyboard driver must also pass the raw keyboard data to wscons via <b class="fname">wskbd_rawinput</b>().<p>
The wscons framework calls back into the hardware driver by invoking the functions that are specified in the <span class="emph">accessops</span> structure. The <b class="fname">enable</b>() and <b class="fname">set_leds</b>() functions are relatively simple and self-explanatory. The <b class="fname">ioctl</b>() function is called by the wscons interface to perform keyboard-specific ioctl operations (see <a class="link-man" href="../2/ioctl">ioctl(2)</a>). The argument <i class="farg">cmd</i> to the <b class="fname">ioctl</b>() function specifies the specific command to perform using the data <i class="farg">data</i>. Valid commands are listed in <i class="file">sys/dev/wscons/wsconsio.h</i>.</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The wscons subsystem is implemented within the directory <i class="file">sys/dev/wscons</i>. The <b class="name">wskbd</b> module itself is implement within the files <i class="file">sys/dev/wscons/wskbd.c</i> and <i class="file">sys/dev/wscons/wskbdutil.c</i>. <a class="link-man" href="../2/ioctl">ioctl(2)</a> operations are listed in <i class="file">sys/dev/wscons/wsconsio.h</i>.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../2/ioctl">ioctl(2)</a>, <a class="link-man" href="../9/autoconf">autoconf(9)</a>, <a class="link-man" href="../9/driver">driver(9)</a>, <a class="link-man" href="../9/intro">intro(9)</a>, <a class="link-man" href="../9/wsdisplay">wsdisplay(9)</a>, <a class="link-man" href="../9/wsmouse">wsmouse(9)</a></div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
December 20, 2005</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
<>

