<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
FILEDESC(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
FILEDESC(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
FILEDESC(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">filedesc</b>, <b class="name">dupfdopen</b>, <b class="name">falloc</b>, <b class="name">fd_getfile</b>, <b class="name">fdalloc</b>, <b class="name">fdcheckstd</b>, <b class="name">fdclear</b>, <b class="name">fdclone</b>, <b class="name">fdcloseexec</b>, <b class="name">fdcopy</b>, <b class="name">fdexpand</b>, <b class="name">fdfree</b>, <b class="name">fdinit</b>, <b class="name">fdrelease</b>, <b class="name">fdremove</b>, <b class="name">fdshare</b>, <b class="name">fdunshare</b> &#8212; <span class="desc">file descriptor tables and operations</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/file.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">sys/filedesc.h</a>&gt;</b><p>
<i class="ftype">int</i><br>
<b class="fname">falloc</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>, <i class="farg" style="white-space:nowrap;">struct file **resultfp</i>, <i class="farg" style="white-space:nowrap;">int *resultfd</i>);<p>
<i class="ftype">struct file *</i><br>
<b class="fname">fd_getfile</b>(<i class="farg" style="white-space:nowrap;">struct filedesc *fdp</i>, <i class="farg" style="white-space:nowrap;">int fd</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">dupfdopen</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>, <i class="farg" style="white-space:nowrap;">int indx</i>, <i class="farg" style="white-space:nowrap;">int dfd</i>, <i class="farg" style="white-space:nowrap;">int mode</i>, <i class="farg" style="white-space:nowrap;">int error</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">fdalloc</b>(<i class="farg" style="white-space:nowrap;">struct proc *p</i>, <i class="farg" style="white-space:nowrap;">int want</i>, <i class="farg" style="white-space:nowrap;">int *result</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">fdcheckstd</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">fdclear</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">fdclone</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>, <i class="farg" style="white-space:nowrap;">struct file *fp</i>, <i class="farg" style="white-space:nowrap;">int fd</i>, <i class="farg" style="white-space:nowrap;">int flag</i>, <i class="farg" style="white-space:nowrap;">const struct fileops *fops</i>, <i class="farg" style="white-space:nowrap;">void *data</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">fdcloseexec</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>);<p>
<i class="ftype">struct filedesc *</i><br>
<b class="fname">fdcopy</b>(<i class="farg" style="white-space:nowrap;">struct proc *p</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">fdexpand</b>(<i class="farg" style="white-space:nowrap;">struct proc *p</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">fdfree</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>);<p>
<i class="ftype">struct filedesc *</i><br>
<b class="fname">fdinit</b>(<i class="farg" style="white-space:nowrap;">struct proc *p</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">fdrelease</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>, <i class="farg" style="white-space:nowrap;">int fd</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">fdremove</b>(<i class="farg" style="white-space:nowrap;">struct filedesc *fdp</i>, <i class="farg" style="white-space:nowrap;">int fd</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">fdshare</b>(<i class="farg" style="white-space:nowrap;">struct proc *p1</i>, <i class="farg" style="white-space:nowrap;">struct proc *p2</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">fdunshare</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> For user processes, all I/O is done through file descriptors. These file descriptors represent underlying objects supported by the kernel and are created by system calls specific to the type of object. In <span class="unix">NetBSD</span>, six types of objects can be represented by file descriptors: data files, pipes, sockets, event queues, crypto, and miscellaneous.<p>
The kernel maintains a descriptor table for each process which is used to translate the external representation of a file descriptor into an internal representation. The file descriptor is merely an index into this table. The file descriptor table maintains the following information:<p>
<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-bul">
<li class="list-bul" style="margin-top: 0.00em;">
the number of descriptors allocated in the file descriptor table;</li>
<li class="list-bul" style="margin-top: 0.00em;">
approximate next free descriptor;</li>
<li class="list-bul" style="margin-top: 0.00em;">
a reference count on the file descriptor table; and</li>
<li class="list-bul" style="margin-top: 0.00em;">
an array of open file entries.</li>
</ul>
<p>
On creation of the file descriptor table, a fixed number of file entries are created. It is the responsibility of the file descriptor operations to expand the available number of entries if more are required. Each file entry in the descriptor table contains the information necessary to access the underlying object and to maintain common information. See <a class="link-man" href="../9/file">file(9)</a> for details of operations on the file entries.<p>
New file descriptors are generally allocated by <b class="fname">falloc</b>() and freed by <b class="fname">fdrelease</b>(). File entries are extracted from the file descriptor table by <b class="fname">fd_getfile</b>(). Most of the remaining functions in the interface are purpose specific and perform lower-level file descriptor operations.</div>
<div class="section">
<h1 id="x46554e4354494f4e53">FUNCTIONS</h1> The following functions are high-level interface routines to access the file descriptor table for a process and its file entries.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">falloc</b>(<i class="farg">p</i>, <i class="farg">*resultfp</i>, <i class="farg">*resultfd</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Create a new open file entry and allocate a file descriptor for process <i class="farg">p</i>. This operation is performed by invoking <b class="fname">fdalloc</b>() to allocate the new file descriptor. The credential on the file entry are inherited from process <i class="farg">p</i>. The <b class="fname">falloc</b>() function is responsible for expanding the file descriptor table when necessary.<p>
A pointer to the file entry is returned in <i class="farg">*resultfp</i> and the file descriptor is returned in <i class="farg">*resultfd</i>. The <b class="fname">falloc</b>() function returns zero on success, otherwise an appropriate error is returned.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fd_getfile</b>(<i class="farg">fdp</i>, <i class="farg">fd</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Get the file entry for file descriptor <i class="farg">fd</i> in the file descriptor table <i class="farg">fdp</i>. The file entry is returned if it is valid and useable, otherwise <span class="define">NULL</span> is returned.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">dupfdopen</b>(<i class="farg">l</i>, <i class="farg">indx</i>, <i class="farg">dfd</i>, <i class="farg">mode</i>, <i class="farg">error</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Duplicate file descriptor <i class="farg">dfd</i> for lwp <i class="farg">l</i>.</dd>
</dl>
<p>
The following functions operate on the file descriptor table for a process.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fdalloc</b>(<i class="farg">p</i>, <i class="farg">want</i>, <i class="farg">*result</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Allocate a file descriptor <i class="farg">want</i> for process <i class="farg">p</i>. The resultant file descriptor is returned in <i class="farg">*result</i>. The <b class="fname">fdalloc</b>() function returns zero on success, otherwise an appropriate error is returned.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fdcheckstd</b>(<i class="farg">l</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Check the standard file descriptors 0, 1, and 2 and ensure they are referencing valid file descriptors. If they are not, create references to <i class="file">/dev/null</i>. This operation is necessary as these file descriptors are given implicit significance in the Standard C Library and it is unsafe for <a class="link-man" href="../2/setuid">setuid(2)</a> and <a class="link-man" href="../2/setgid">setgid(2)</a> processes to be started with these file descriptors closed.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fdclear</b>(<i class="farg">l</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Clear the descriptor table for lwp <i class="farg">l</i>. This operation is performed by invoking <b class="fname">fdinit</b>() to initialise a new file descriptor table to replace the old file descriptor table and invoking <b class="fname">fdfree</b>() to release the old one.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fdclone</b>(<i class="farg">l</i>, <i class="farg">fp</i>, <i class="farg">fd</i>, <i class="farg">flag</i>, <i class="farg">fops</i>, <i class="farg">data</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
This function is meant to be used by devices which allocate a file entry upon open. <b class="fname">fdclone</b>() fills <i class="farg">fp</i> with the given parameters. It always returns the in-kernel errno value <span class="errno">EMOVEFD</span>, which is meant to be returned from the device open routine. This special return value is interpreted by the caller of the device open routine.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fdcloseexec</b>(<i class="farg">l</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Close any files for process <i class="farg">p</i> that are marked &#8220;close on exec&#8221;. This operation is performed by invoking <b class="fname">fdunshare</b>() for the process and invoking <b class="fname">fdrelease</b>() on the appropriate file descriptor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fdcopy</b>(<i class="farg">p</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Copy the file descriptor table from process <i class="farg">p</i> and return a pointer to the copy. The returned file descriptor is guaranteed to have a reference count of one. All file descriptor state is maintained. The reference counts on each file entry referenced by the file descriptor table is incremented accordingly.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fdexpand</b>(<i class="farg">p</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Expand the file descriptor table for process <i class="farg">p</i> by allocating memory for additional file descriptors.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fdfree</b>(<i class="farg">l</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Decrement the reference count on the file descriptor table for lwp <i class="farg">l</i> and release the file descriptor table if the reference count drops to zero.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fdinit</b>(<i class="farg">p</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Create a file descriptor table using the same current and root directories of process <i class="farg">p</i>. The returned file descriptor table is guaranteed to have a reference count of one.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fdrelease</b>(<i class="farg">l</i>, <i class="farg">fd</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Remove file descriptor <i class="farg">fd</i> from the file descriptor table of lwp <i class="farg">l</i>. The operation is performed by invoking <b class="fname">closef</b>().</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fdremove</b>(<i class="farg">fdp</i>, <i class="farg">fd</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Unconditionally remove the file descriptor <i class="farg">fd</i> from file descriptor table <i class="farg">fdp</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fdshare</b>(<i class="farg">p1</i>, <i class="farg">p2</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Share the file descriptor table belonging to process <i class="farg">p1</i> with process <i class="farg">p2</i>. Process <i class="farg">p2</i> is assumed not to have a file descriptor table already allocated. The reference count on the file descriptor table is incremented. This function is used by <a class="link-man" href="../9/fork1">fork1(9)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fdunshare</b>(<i class="farg">l</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Ensure that lwp <i class="farg">l</i> does not share its file descriptor table. If its file descriptor table has more than one reference, the file descriptor table is copied by invoking <b class="fname">fdcopy</b>(). The reference count on the original file descriptor table is decremented.</dd>
</dl>
</div>
<div class="section">
<h1 id="x52455455524e2056414c554553">RETURN VALUES</h1> Successful operations return zero. A failed operation will return a non-zero return value. Possible values include:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">EBADF</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Bad file descriptor specified.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">EMFILE</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Cannot exceed file descriptor limit.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">ENOSPC</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
No space left in file descriptor table.</dd>
</dl>
</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The framework for file descriptor handling is implemented within the file <i class="file">sys/kern/kern_descrip.c</i>.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../9/file">file(9)</a></div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
July 24, 2006</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

