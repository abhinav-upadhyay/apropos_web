<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
PCI_MSI(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
PCI_MSI(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
PCI_MSI(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">pci_msi</b>, <b class="name">pci_msix</b>, <b class="name">pci_msi_count</b>, <b class="name">pci_msi_alloc</b>, <b class="name">pci_msi_alloc_exact</b>, <b class="name">pci_msix_count</b>, <b class="name">pci_msix_alloc</b>, <b class="name">pci_msix_alloc_exact</b>, <b class="name">pci_msix_alloc_map</b>, <b class="name">pci_intx_alloc</b>, <b class="name">pci_intr_release</b> &#8212; <span class="desc">PCI MSI{,-X} manipulation functions</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <i class="ftype">int</i><br>
<b class="fname">pci_msi_count</b>(<i class="farg" style="white-space:nowrap;">struct pci_attach_args *pa</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">pci_msi_alloc</b>(<i class="farg" style="white-space:nowrap;">struct pci_attach_args *pa</i>, <i class="farg" style="white-space:nowrap;">pci_intr_handle_t **ihps</i>, <i class="farg" style="white-space:nowrap;">int *count</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">pci_msi_alloc_exect</b>(<i class="farg" style="white-space:nowrap;">struct pci_attach_args *pa</i>, <i class="farg" style="white-space:nowrap;">pci_intr_handle_t **ihps</i>, <i class="farg" style="white-space:nowrap;">int count</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">pci_msix_count</b>(<i class="farg" style="white-space:nowrap;">struct pci_attach_args *pa</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">pci_msix_alloc</b>(<i class="farg" style="white-space:nowrap;">struct pci_attach_args *pa</i>, <i class="farg" style="white-space:nowrap;">pci_intr_handle_t **ihps</i>, <i class="farg" style="white-space:nowrap;">int *count</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">pci_msix_alloc_exect</b>(<i class="farg" style="white-space:nowrap;">struct pci_attach_args *pa</i>, <i class="farg" style="white-space:nowrap;">pci_intr_handle_t **ihps</i>, <i class="farg" style="white-space:nowrap;">int count</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">pci_msix_alloc_map</b>(<i class="farg" style="white-space:nowrap;">struct pci_attach_args *pa</i>, <i class="farg" style="white-space:nowrap;">pci_intr_handle_t **ihps</i>, <i class="farg" style="white-space:nowrap;">u_int *table_indexes</i>, <i class="farg" style="white-space:nowrap;">int count</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">pci_intx_alloc</b>(<i class="farg" style="white-space:nowrap;">struct pci_attach_args *pa</i>, <i class="farg" style="white-space:nowrap;">pci_intr_handle_t **ihp</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pci_intr_release</b>(<i class="farg" style="white-space:nowrap;">pci_chipset_tag_t pc</i>, <i class="farg" style="white-space:nowrap;">pci_intr_handle_t *pih</i>, <i class="farg" style="white-space:nowrap;">int count</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">pci_msi</b> functions exist to allow device drivers to use MSI/MSI-X. When the system uses MSI/MSI-X, it must define the <span class="define">__HAVE_PCI_MSI_MSIX</span> build option.<p>
Each driver has an <b class="fname">attach</b>() function which has a bus-specific <i class="ftype">attach_args</i> structure. Each driver for a PCI device is passed a pointer to an object of type <i class="ftype">struct pci_attach_args</i> which contains, among other things, information about the location of the device in the PCI bus topology sufficient to allow interrupts from the device to be handled.<p>
If a driver wishes to establish an MSI handler for the device, it should pass the <i class="ftype">struct pci_attach_args *</i> and <i class="farg">count</i> <b class="fname">pci_msi_alloc</b>() or <b class="fname">pci_msi_alloc_exact</b>() functions, which return zero on success, and nonzero on failure. When the functions are successful, they return the pointer to the allocated handle array in <i class="ftype">pihs</i> whose size is <i class="ftype">count</i> or less. The difference between <b class="fname">pci_msi_alloc</b>() and <b class="fname">pci_msi_alloc_exact</b>() is whether <i class="farg">count</i> can be decremented or not. <b class="fname">pci_msi_alloc</b>() can decrement <i class="farg">count</i>, and which is similar to <span class="unix">FreeBSD</span>&#39;s <b class="fname">pci_alloc_msi</b>(). In contrast, <b class="fname">pci_msi_alloc_exact</b>() can not decrement <i class="ftype">count</i>.<p>
If the driver wishes to refer to the MSI source in an attach or error message, it should use the value returned by <b class="fname">pci_intr_string</b>() the same as INTx. The buffer passed to <b class="fname">pci_intr_string</b>() should be at least <span class="define">PCI_INTRSTR_LEN</span> bytes long.<p>
Subsequently, when the driver is prepared to receive MSIs, it should call <b class="fname">pci_intr_establish</b>() the same as INTx to actually establish the handler; when the device interrupts, <i class="farg">intrhand</i> will be called with a single argument <i class="farg">intrarg</i>, and will run at the interrupt priority level <i class="farg">ipl</i>.<p>
The return value of <b class="fname">pci_intr_establish</b>() may be saved and passed to <b class="fname">pci_intr_disestablish</b>() to disable the interrupt handler the same as INTx when the driver is no longer interested in MSIs from the device. After that, the driver should also call <b class="fname">pci_intr_release</b>() to free resources about MSI as well as INTx and MSI-X.<p>
If a driver wishes to establish an MSI-X handler for the device, it is almost the same as MSI. The only differences is <b class="fname">pci_msix_alloc_map</b>(). This function can assign separate handlers for each MSI-X table entry. I.e., if the driver wants to assign the handlers in the following way:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
	msix_handler0 =&gt; MSI-X table index: 4 
	msix_handler1 =&gt; MSI-X table index: 5 
	msix_handler2 =&gt; MSI-X table index: 0</pre>
the driver should set <i class="farg">table_indexes</i> this way:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
	table_indexes[0] = 4; 
	table_indexes[1] = 5; 
	table_indexes[2] = 0;</pre>
<p>
If the driver wants to fall back to INTx, the driver should use <b class="fname">pci_intx_alloc</b>() and <b class="fname">pci_intr_release</b>() instead of <b class="fname">pci_intr_map</b>() to resolve contradiction of the interrupt handler ownership. I.e., <b class="fname">pci_intr_map</b>() does not have the ownership (the function just calculates value), in contrast, <b class="fname">pci_msi_alloc</b>() and <b class="fname">pci_msix_alloc</b>() have (the functions allocate memory for interrupt handlers).</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../9/pci_intr">pci_intr(9)</a></div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
May 11, 2015</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

