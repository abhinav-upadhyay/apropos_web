<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
SYSMON_ENVSYS(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
SYSMON_ENVSYS(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
SYSMON_ENVSYS(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">sysmon_envsys</b> &#8212; <span class="desc">kernel part of the envsys 2 framework</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">dev/sysmon/sysmonvar.h</a>&gt;</b><p>
<i class="ftype">struct sysmon_envsys *</i><br>
<b class="fname">sysmon_envsys_create</b>(<i class="farg" style="white-space:nowrap;">void</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">sysmon_envsys_destroy</b>(<i class="farg" style="white-space:nowrap;">struct sysmon_envsys *</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">sysmon_envsys_register</b>(<i class="farg" style="white-space:nowrap;">struct sysmon_envsys *</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">sysmon_envsys_unregister</b>(<i class="farg" style="white-space:nowrap;">struct sysmon_envsys *</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">sysmon_envsys_sensor_attach</b>(<i class="farg" style="white-space:nowrap;">struct sysmon_envsys *</i>, <i class="farg" style="white-space:nowrap;">envsys_data_t *</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">sysmon_envsys_sensor_detach</b>(<i class="farg" style="white-space:nowrap;">struct sysmon_envsys *</i>, <i class="farg" style="white-space:nowrap;">envsys_data_t *</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">sysmon_envsys_sensor_event</b>(<i class="farg" style="white-space:nowrap;">struct sysmon_envsys *</i>, <i class="farg" style="white-space:nowrap;">envsys_data_t *</i>, <i class="farg" style="white-space:nowrap;">int</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">sysmon_envsys_foreach_sensor</b>(<i class="farg" style="white-space:nowrap;">sysmon_envsys_callback_t</i>, <i class="farg" style="white-space:nowrap;">void *</i>, <i class="farg" style="white-space:nowrap;">bool</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">sysmon_envsys_update_limits</b>(<i class="farg" style="white-space:nowrap;">struct sysmon_envsys *</i>, <i class="farg" style="white-space:nowrap;">envsys_data_t *</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> <b class="name">sysmon_envsys</b> is the kernel part of the <a class="link-man" href="../4/envsys">envsys(4)</a> framework. With this framework you are able to register and unregister a <b class="name">sysmon_envsys</b> device, attach or detach sensors into a device, and enable or disable automatic monitoring for some sensors without any user interactivity, among other things.<div class="subsection">
<h2 id="x484f5720544f2055534520544845204652414d45574f524b">HOW TO USE THE FRAMEWORK</h2> To register a new driver to the <b class="name">sysmon_envsys</b> framework, a <span class="emph">sysmon_envsys</span> object must be allocated and initialized; the <b class="fname">sysmon_envsys_create</b>() function is used for this. This returns a zero'ed pointer to a <span class="emph">sysmon_envsys</span> structure.<p>
Once the object has been initialized, actual sensors may be initialized and attached (see the <i class="link-sec"><a class="link-sec" href="#x53454e534f522044455441494c53">SENSOR DETAILS</a></i> section for more information). This is accomplished by the <b class="fname">sysmon_envsys_sensor_attach</b>() function, which will attach the <span class="emph">envsys_data_t</span> (a sensor) specified as second argument into the <span class="emph">sysmon_envsys</span> object specified in the first argument.<p>
Finally, after all sensors have been attached, the device needs to set some required (and optional) members of the <span class="emph">sysmon_envsys</span> structure before calling the <b class="fname">sysmon_envsys_register</b>() function to register the device.<p>
In case of errors during the initialization, the <b class="fname">sysmon_envsys_destroy</b>() function should be used. This detachs all previously attached sensors and deallocates the <span class="emph">sysmon_envsys</span> object.<p>
Some sensors can be monitored, and when the sensor value changes an event can be delivered to the <a class="link-man" href="../8/powerd">powerd(8)</a> daemon. Sensor monitoring can be performed by the <b class="name">sysmon_envsys</b> framework on a polled basis. Alternatively, the sensor's device driver can call the <b class="fname">sysmon_envsys_sensor_event</b>() function to deliver the event without waiting for the device to be polled.<p>
The <b class="fname">sysmon_envsys_foreach_sensor</b>() function can be used by other parts of the kernel to iterate over all registered sensors. This capability is used by the <a class="link-man" href="../4/i386/apm">i386/apm(4)</a> driver to summarize the state of all battery sensors.<p>
Drivers can also call the <b class="fname">sysmon_envsys_update_limits</b>() function when it is necessary to reinitialize a sensor's threshhold values. This is used by the <a class="link-man" href="../4/acpibat">acpibat(4)</a> driver when a new battery is inserted.<p>
The <span class="emph">sysmon_envsys</span> structure is defined as follows (only the public members are shown):<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct sysmon_envsys { 
	const char 	*sme_name; 
	int		sme_flags; 
	int		sme_class; 
	uint64_t	sme_events_timeout; 
	void 		*sme_cookie; 
	void (*sme_refresh)(struct sysmon_envsys *, envsys_data_t *); 
	void (*sme_set_limits)(struct sysmon_envsys *, envsys_data_t *, 
			       sysmon_envsys_lim_t *, uint32_t *); 
	void (*sme_get_limits)(struct sysmon_envsys *, envsys_data_t *, 
			       sysmon_envsys_lim_t *, uint32_t *); 
};</pre>
<p>
The members have the following meaning:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">sme_class</i></dt>
<dd class="list-tag" style="margin-left: 18.00ex;">
This specifies the class of the sysmon envsys device. See the <span class="symb">DEVICE CLASSES</span> section for more information (OPTIONAL).</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">sme_name</i></dt>
<dd class="list-tag" style="margin-left: 18.00ex;">
The name that will be used in the driver (REQUIRED).</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">sme_flags</i></dt>
<dd class="list-tag" style="margin-left: 18.00ex;">
Additional flags for the <b class="name">sysmon_envsys</b> device. Currently supporting <i class="arg">SME_DISABLE_REFRESH</i>. If enabled, the <i class="arg">sme_refresh</i> function callback won't be used to refresh sensor data and the driver will use its own method (OPTIONAL).</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">sme_events_timeout</i></dt>
<dd class="list-tag" style="margin-left: 18.00ex;">
This is used to specify the default timeout value (in seconds) that will be used to check for critical events if any monitoring flag was set (OPTIONAL).</dd>
</dl>
<p>
If the driver wants to refresh sensors data via the <b class="name">sysmon_envsys</b> framework, the following members may be specified:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">sme_cookie</i></dt>
<dd class="list-tag" style="margin-left: 18.00ex;">
Typically a pointer to the device struct (also called &#8220;softc&#8221;). This may be used in the <span class="symb">sme_refresh</span>, <span class="symb">sme_get_limits</span>, or <span class="symb">sme_set_limits</span> function callbacks.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">sme_refresh</i></dt>
<dd class="list-tag" style="margin-left: 18.00ex;">
Pointer to a function that will be used to refresh sensor data in the device. This can be used to set the state and other properties of the sensor depending on the data returned by the driver. <span class="emph">NOTE</span>: <span class="emph">You don't have to refresh all sensors, only the sensor specified by the</span> <span class="symb">edata-&gt;sensor</span> <span class="emph">index</span>. If this member is not specified, the device driver will be totally responsible for all updates of this sensor; the <b class="name">sysmon_envsys</b> framework will not be able to update the sensor value.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">sme_get_limits</i></dt>
<dd class="list-tag" style="margin-left: 18.00ex;">
Pointer to a function that will be used to obtain from the driver the initial limits (or thresholds) used when monitoring a sensor's value. (See the <i class="link-sec"><a class="link-sec" href="#x53454e534f522044455441494c53">SENSOR DETAILS</a></i> section for more information.) If this member is not specified, the <span class="define">ENVSYS_FMONLIMITS</span> flag will be ignored, and limit monitoring will not occur until appropriate limits are enabled from userland via <a class="link-man" href="../8/envstat">envstat(8)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">sme_set_limits</i></dt>
<dd class="list-tag" style="margin-left: 18.00ex;">
Pointer to a function that alerts the device driver whenever monitoring limits (or thresholds) are updated by the user. Setting this function allows the device driver to reprogram hardware limits (if provided by the device) when the user-specificied limits are updated, and gives the driver direct control over setting the sensor's state based on hardware status.<p>
The <i class="farg">sme_set_limits</i> callback can be invoked with the third argument (a pointer to the new limits) set to a <span class="define">NULL</span> pointer. Device drivers must recognize this as a request to restore the sensor limits to their original, boot-time values.<p>
If the <i class="farg">sme_set_limits</i> member is not specified, the device driver is not informed of changes to the sensor's limit values, and the <b class="name">sysmon_envsys</b> framework performs all limit checks in software.</dd>
</dl>
<p>
Note that it's not necessary to refresh the sensors data before the driver is registered, only do it if you need the data in your driver to check for a specific condition.<p>
The timeout value for the monitoring events on a device may be changed via the <span class="define">ENVSYS_SETDICTIONARY</span> <a class="link-man" href="../2/ioctl">ioctl(2)</a> or the <a class="link-man" href="../8/envstat">envstat(8)</a> command.<p>
To unregister a driver previously registered with the <b class="name">sysmon_envsys</b> framework, the <b class="fname">sysmon_envsys_unregister</b>() function must be used. If there were monitoring events registered for the driver, they all will be destroyed before the device is unregistered and its sensors are detached. Finally the <span class="emph">sysmon_envsys</span> object will be freed, so there's no need to call <b class="fname">sysmon_envsys_destroy</b>().</div>
<div class="subsection">
<h2 id="x44455649434520434c4153534553">DEVICE CLASSES</h2> The <i class="farg">sme_class</i> member of the <i class="farg">sysmon_envsys</i> structure is an optional flag that specifies the class of the sysmon envsys device. Currently there are two classes:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
SME_CLASS_ACADAPTER</dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
<p>
This class is for devices that want to act as an <span class="emph">AC adapter</span>. The device writer must ensure that at least there is a sensor with <span class="emph">units</span> of <span class="define">ENVSYS_INDICATOR</span>. This will be used to report its current state (on/off).</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
SME_CLASS_BATTERY</dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
<p>
This class is for devices that want to act as a <span class="emph">Battery</span>. The device writer must ensure that at least there are two sensors with units of <span class="define">ENVSYS_BATTERY_CAPACITY</span> and <span class="define">ENVSYS_BATTERY_CHARGE</span>.<p>
These two sensors are used to ensure that the battery device can send a <span class="emph">low-power</span> event to the <a class="link-man" href="../8/powerd">powerd(8)</a> daemon (if running) when all battery devices are in a critical state. (The critical state occurs when a battery is not currently charging and its charge state is low or critical.) When the <span class="emph">low-power</span> condition is met, an event is sent to the <a class="link-man" href="../8/powerd">powerd(8)</a> daemon (if running), which will shutdown the system gracefully by executing the <i class="file">/etc/powerd/scripts/sensor_battery</i> script.<p>
If <a class="link-man" href="../8/powerd">powerd(8)</a> is not running, the system will be powered off via the <a class="link-man" href="../9/cpu_reboot">cpu_reboot(9)</a> call with the <span class="define">RB_POWERDOWN</span> flag.</dd>
</dl>
<p>
<span class="emph">NOTE</span>: If a <span class="define">SME_CLASS_ACADAPTER</span> or <span class="define">SME_CLASS_BATTERY</span> class device doesn't have the sensors required, the <span class="emph">low-power</span> event will never be sent, and the graceful shutdown won't be possible.</div>
<div class="subsection">
<h2 id="x53454e534f522044455441494c53">SENSOR DETAILS</h2> Each sensor uses a <span class="symb">envsys_data_t</span> structure, it's defined as follows (only the public members are shown);<p>
<pre style="margin-left: 0.00ex;" class="lit display">
typedef struct envsys_data { 
	uint32_t	units; 
	uint32_t	state; 
	uint32_t	flags; 
	uint32_t	rpms; 
	int32_t		rfact; 
	int32_t		value_cur; 
	int32_t		value_max; 
	int32_t		value_min; 
	int32_t		value_avg; 
	sysmon_envsys_lim_t limits; 
	int		upropset; 
	char		desc[ENVSYS_DESCLEN]; 
} envsys_data_t;</pre>
<p>
The members for the <span class="symb">envsys_data_t</span> structure have the following meaning:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">units</i></dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Used to set the units type.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">state</i></dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Used to set the current state.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">flags</i></dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Used to set additional flags. Among other uses, if one or more of the <span class="define">ENVSYS_FMONxxx</span> flags are set, automatic sensor monitoring will be enabled. Periodically, the sensor's value will be checked and if certain conditions are met, an event will be sent to the <a class="link-man" href="../8/powerd">powerd(8)</a> daemon. <span class="emph">NOTE</span> <span class="emph">that limits (or thresholds) can be set at any time to enable</span> <span class="emph">monitoring that the sensor's value remains within those limits</span>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">rpms</i></dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Used to set the nominal RPM value for <span class="symb">fan</span> sensors.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">rfact</i></dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Used to set the rfact value for <span class="symb">voltage</span> sensors.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">value_cur</i></dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Used to set the current value.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">value_max</i></dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Used to set the maximum value.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">value_min</i></dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Used to set the minimum value.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">value_avg</i></dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Used to set the average value.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">limits</i></dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Structure used to contain the sensor's alarm thresholds.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">upropset</i></dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Used to keep track of which sensor properties are set.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">desc</i></dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Used to set the description string. <span class="emph">NOTE</span> <span class="emph">that the description string must be unique in a device, and sensors with</span> <span class="emph">duplicate or empty description will simply be ignored</span>.</dd>
</dl>
<p>
Users of this framework must take care about the following points:<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-bul">
<li class="list-bul" style="margin-top: 1.00em;">
The <i class="arg">desc</i> member needs to have a valid description, unique in a device and non empty to be valid.</li>
<li class="list-bul" style="margin-top: 1.00em;">
The <i class="arg">units</i> type must be valid. The following units are defined:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_STEMP</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For temperature sensors, in microkelvins.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SFANRPM</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For fan sensors.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SVOLTS_AC</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For AC Voltage.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SVOLTS_DC</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For DC Voltage.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SOHMS</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For Ohms.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SWATTS</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For Watts.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SAMPS</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For Ampere.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SWATTHOUR</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For Watts hour.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SAMPHOUR</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For Ampere hour.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_INDICATOR</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For sensors that only want a boolean type.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_INTEGER</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For sensors that only want an integer type.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For drive sensors.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_BATTERY_CAPACITY</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For Battery device classes. This sensor unit uses the <span class="define">ENVSYS_BATTERY_CAPACITY_*</span> values in <i class="arg">value_cur</i> to report its current capacity to userland. Mandatory if <i class="farg">sme_class</i> is set to <span class="define">SME_CLASS_BATTERY</span>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_BATTERY_CHARGE</span></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
For Battery device classes. This sensor is equivalent to the Indicator type, it's a boolean. Use it to specify in what state is the Battery state: <span class="symb">true</span> if the battery is currently charging or <span class="symb">false</span> otherwise. Mandatory if <i class="farg">sme_class</i> is set to <span class="define">SME_CLASS_BATTERY</span>.</dd>
</dl>
</li>
<li class="list-bul" style="margin-top: 1.00em;">
When initializing or refreshing the sensor, the <i class="arg">state</i> member should be set to a known state (otherwise it will be in unknown state). Possible values:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SVALID</span></dt>
<dd class="list-tag" style="margin-left: 19.00ex;">
Sets the sensor to a valid state.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SINVALID</span></dt>
<dd class="list-tag" style="margin-left: 19.00ex;">
Sets the sensor to an invalid state.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SCRITICAL</span></dt>
<dd class="list-tag" style="margin-left: 19.00ex;">
Sets the sensor to a critical state.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SCRITUNDER</span></dt>
<dd class="list-tag" style="margin-left: 19.00ex;">
Sets the sensor to a critical under state.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SCRITOVER</span></dt>
<dd class="list-tag" style="margin-left: 19.00ex;">
Sets the sensor to a critical over state.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SWARNUNDER</span></dt>
<dd class="list-tag" style="margin-left: 19.00ex;">
Sets the sensor to a warning under state.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_SWARNOVER</span></dt>
<dd class="list-tag" style="margin-left: 19.00ex;">
Sets the sensor to a warning over state.</dd>
</dl>
</li>
<li class="list-bul" style="margin-top: 1.00em;">
The <i class="arg">flags</i> member accepts one or more of the following flags:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENVSYS_FCHANGERFACT</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Marks the sensor with ability to change the <i class="arg">rfact</i> value on the fly (in voltage sensors). The <i class="arg">rfact</i> member must be used in the correct place of the code that retrieves and converts the value of the sensor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENVSYS_FPERCENT</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
This uses the <i class="arg">value_cur</i> and <i class="arg">value_max</i> members to make a percentage. Both values must be enabled and have data.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENVSYS_FVALID_MAX</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Marks the <i class="arg">value_max</i> value as valid.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENVSYS_FVALID_MIN</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Marks the <i class="arg">value_min</i> value as valid.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENVSYS_FVALID_AVG</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Marks the <i class="arg">value_avg</i> value as valid.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENVSYS_FMONCRITICAL</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Enables and registers a new event to monitor a critical state.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENVSYS_FMONLIMITS</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Enables and registers a new event to monitor a sensor's value crossing limits or thresholds.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENVSYS_FMONSTCHANGED</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Enables and registers a new event to monitor battery capacity or drive state sensors. The flag is not effective if the <i class="arg">units</i> member is not <span class="define">ENVSYS_DRIVE</span> or <span class="define">ENVSYS_BATTERY_CAPACITY</span>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENVSYS_FMONNOTSUPP</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Disallows setting of limits (or thresholds) via the <span class="define">ENVSYS_SETDICTIONARY</span> <a class="link-man" href="../2/ioctl">ioctl(2)</a>. This flag only disables setting the limits from userland. It has no effect on monitoring flags set by the driver.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENVSYS_FHAS_ENTROPY</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Allows this sensor to provide entropy for <a class="link-man" href="../4/rnd">rnd(4)</a>.</dd>
</dl>
<p>
<span class="emph">If the driver has to use any of the</span> <i class="arg">value_max</i>, <i class="arg">value_min</i>, <span class="emph">or</span> <i class="arg">value_avg</i> <span class="emph">members, they should be marked as valid with the appropriate flag</span>.</li>
<li class="list-bul" style="margin-top: 1.00em;">
If <i class="arg">units</i> is set to <span class="define">ENVSYS_DRIVE</span>, the <i class="arg">value_cur</i> member must be set to one of the following predefined states:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_EMPTY</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive state is unknown.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_READY</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive is ready.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_POWERUP</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive is powering up.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_ONLINE</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive is online.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_OFFLINE</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive is offline.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_IDLE</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive is idle.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_ACTIVE</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive is active.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_BUILD</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive is building.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_REBUILD</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive is rebuilding.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_POWERDOWN</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive is powering down.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_FAIL</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive has failed.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_PFAIL</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive has been degraded.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_MIGRATING</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive is migrating.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_DRIVE_CHECK</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Drive is checking its state.</dd>
</dl>
</li>
<li class="list-bul" style="margin-top: 1.00em;">
If <i class="arg">units</i> is set to <span class="define">ENVSYS_BATTERY_CAPACITY</span>, the <i class="arg">value_cur</i> member must be set to one of the following predefined capacity states:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_BATTERY_CAPACITY_NORMAL</span></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Battery charge is normal.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_BATTERY_CAPACITY_CRITICAL</span></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Battery charge is critical.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_BATTERY_CAPACITY_LOW</span></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Battery charge is low.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ENVSYS_BATTERY_CAPACITY_WARNING</span></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Battery charge is on or below the warning capacity.</dd>
</dl>
</li>
<li class="list-bul" style="margin-top: 1.00em;">
The <a class="link-man" href="../4/envsys">envsys(4)</a> framework expects to have the values converted to a unit that can be converted to another one easily. That means the user should convert the value returned by the driver to the appropriate unit. For example voltage sensors to <span class="symb">mV</span>, temperature sensors to <span class="symb">uK</span>, Watts to <span class="symb">mW</span>, Ampere to <span class="symb">mA</span>, etc.<p>
The following types shouldn't need any conversion: <span class="define">ENVSYS_BATTERY_CAPACITY</span>, <span class="define">ENVSYS_BATTERY_CHARGE</span>, <span class="define">ENVSYS_INDICATOR</span>, <span class="define">ENVSYS_INTEGER</span>, and <span class="define">ENVSYS_DRIVE</span>.<p>
<span class="emph">PLEASE NOTE THAT YOU MUST AVOID USING FLOATING POINT OPERATIONS</span> <span class="emph">IN KERNEL WHEN CONVERTING THE DATA RETURNED BY THE DRIVER TO THE</span> <span class="emph">APPROPRIATE UNIT, IT'S NOT ALLOWED</span>.</li>
</ul>
</div>
<div class="subsection">
<h2 id="x484f5720544f20454e41424c45204155544f4d41544943204d4f4e49544f52494e4720494e2053454e534f5253">HOW TO ENABLE AUTOMATIC MONITORING IN SENSORS</h2> The following example illustrates how to enable automatic monitoring in a virtual driver for a <span class="emph">critical</span> state in the first sensor (<i class="farg">sc_sensor[0]</i>):<p>
<pre style="margin-left: 0.00ex;" class="lit display">
int 
mydriver_initialize_sensors(struct mysoftc *sc) 
{ 
	... 
	/* sensor is initialized with a valid state */ 
	sc-&gt;sc_sensor[0].state = ENVSYS_SVALID; 
 
	/* 
	 * the monitor member must be true to enable 
	 * automatic monitoring. 
	 */ 
	sc-&gt;sc_sensor[0].monitor = true; 
 
	/* and now we specify the type of the monitoring event */ 
	sc-&gt;sc_sensor[0].flags |= ENVSYS_FMONCRITICAL; 
	... 
} 
 
int 
mydriver_refresh(struct sysmon_envsys *sme, envsys_data_t *edata) 
{ 
	struct mysoftc *sc = sme-&gt;sme_cookie; 
 
	/* we get current data from the driver */ 
	edata-&gt;value_cur = sc-&gt;sc_getdata(); 
 
	/* 
	 * if value is too high, mark the sensor in 
	 * critical state. 
	 */ 
	if (edata-&gt;value_cur &gt; MYDRIVER_SENSOR0_HIWAT) { 
		edata-&gt;state = ENVSYS_SCRITICAL; 
		/* a critical event will be sent now automatically */ 
	} else { 
		/* 
		 * if value is within the limits, and we came from 
		 * a critical state make sure to change sensor's state 
		 * to valid. 
		 */ 
		edata-&gt;state = ENVSYS_SVALID; 
	} 
	... 
}</pre>
</div>
</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The <span class="symb">envsys 2</span> framework is implemented within the files:<p>
<i class="file">sys/dev/sysmon/sysmon_envsys.c</i><p>
<i class="file">sys/dev/sysmon/sysmon_envsys_events.c</i><p>
<i class="file">sys/dev/sysmon/sysmon_envsys_tables.c</i><p>
<i class="file">sys/dev/sysmon/sysmon_envsys_util.c</i></div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../4/envsys">envsys(4)</a>, <a class="link-man" href="../8/envstat">envstat(8)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The first <span class="emph">envsys</span> framework first appeared in <span class="unix">NetBSD&#160;1.5</span>. The <span class="emph">envsys 2</span> framework first appeared in <span class="unix">NetBSD&#160;5.0</span>.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> The (current) <span class="emph">envsys 2</span> framework was implemented by <span class="author">Juan Romero Pardines</span>. Additional input on the design was provided by many <span class="unix">NetBSD</span> developers around the world.<p>
The first <span class="emph">envsys</span> framework was implemented by Jason R. Thorpe, Tim Rightnour, and Bill Squier.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
July 13, 2012</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

