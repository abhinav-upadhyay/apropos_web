<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
CONDVAR(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
CONDVAR(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
CONDVAR(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">cv</b>, <b class="name">condvar</b>, <b class="name">cv_init</b>, <b class="name">cv_destroy</b>, <b class="name">cv_wait</b>, <b class="name">cv_wait_sig</b>, <b class="name">cv_timedwait</b>, <b class="name">cv_timedwait_sig</b>, <b class="name">cv_signal</b>, <b class="name">cv_broadcast</b>, <b class="name">cv_has_waiters</b> &#8212; <span class="desc">condition variables</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/condvar.h</a>&gt;</b><p>
<i class="ftype">void</i><br>
<b class="fname">cv_init</b>(<i class="farg" style="white-space:nowrap;">kcondvar_t *cv</i>, <i class="farg" style="white-space:nowrap;">const char *wmesg</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">cv_destroy</b>(<i class="farg" style="white-space:nowrap;">kcondvar_t *cv</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">cv_wait</b>(<i class="farg" style="white-space:nowrap;">kcondvar_t *cv</i>, <i class="farg" style="white-space:nowrap;">kmutex_t *mtx</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">cv_wait_sig</b>(<i class="farg" style="white-space:nowrap;">kcondvar_t *cv</i>, <i class="farg" style="white-space:nowrap;">kmutex_t *mtx</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">cv_timedwait</b>(<i class="farg" style="white-space:nowrap;">kcondvar_t *cv</i>, <i class="farg" style="white-space:nowrap;">kmutex_t *mtx</i>, <i class="farg" style="white-space:nowrap;">int ticks</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">cv_timedwait_sig</b>(<i class="farg" style="white-space:nowrap;">kcondvar_t *cv</i>, <i class="farg" style="white-space:nowrap;">kmutex_t *mtx</i>, <i class="farg" style="white-space:nowrap;">int ticks</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">cv_signal</b>(<i class="farg" style="white-space:nowrap;">kcondvar_t *cv</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">cv_broadcast</b>(<i class="farg" style="white-space:nowrap;">kcondvar_t *cv</i>);<p>
<i class="ftype">bool</i><br>
<b class="fname">cv_has_waiters</b>(<i class="farg" style="white-space:nowrap;">kcondvar_t *cv</i>);<p>
<br>
<b class="config">options DIAGNOSTIC</b><br>
<b class="config">options LOCKDEBUG</b></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> Condition variables (CVs) are used in the kernel to synchronize access to resources that are limited (for example, memory) and to wait for pending I/O operations to complete.<p>
The <span class="type">kcondvar_t</span> type provides storage for the CV object. This should be treated as an opaque object and not examined directly by consumers.</div>
<div class="section">
<h1 id="x4f5054494f4e53">OPTIONS</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="config">options DIAGNOSTIC</b></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Kernels compiled with the <span class="define">DIAGNOSTIC</span> option perform basic sanity checks on CV operations.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="config">options LOCKDEBUG</b></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Kernels compiled with the <span class="define">LOCKDEBUG</span> option perform potentially CPU intensive sanity checks on CV operations.</dd>
</dl>
</div>
<div class="section">
<h1 id="x46554e4354494f4e53">FUNCTIONS</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cv_init</b>(<i class="farg">cv</i>, <i class="farg">wmesg</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Initialize a CV for use. No other operations can be performed on the CV until it has been initialized.<p>
The <i class="farg">wmesg</i> argument specifies a string of no more than 8 characters that describes the resource or condition associated with the CV. The kernel does not use this argument directly but makes it available for utilities such as <a class="link-man" href="../html1/ps.html">ps(1)</a> to display.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cv_destroy</b>(<i class="farg">cv</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Release resources used by a CV. The CV must not be in use when it is destroyed, and must not be used afterwards.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cv_wait</b>(<i class="farg">cv</i>, <i class="farg">mtx</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Cause the current LWP to wait non-interruptably for access to a resource, or for an I/O operation to complete. The LWP will resume execution when awoken by another thread using <b class="fname">cv_signal</b>() or <b class="fname">cv_broadcast</b>().<p>
<i class="farg">mtx</i> specifies a kernel mutex to be used as an interlock, and must be held by the calling LWP on entry to <b class="fname">cv_wait</b>(). It will be released once the LWP has prepared to sleep, and will be reacquired before <b class="fname">cv_wait</b>() returns.<p>
A small window exists between testing for availability of a resource and waiting for the resource with <b class="fname">cv_wait</b>(), in which the resource may become available again. The interlock is used to guarantee that the resource will not be signalled as available until the calling LWP has begun to wait for it.<p>
Non-interruptable waits have the potential to deadlock the system, and so must be kept short (typically, under one second).</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cv_wait_sig</b>(<i class="farg">cv</i>, <i class="farg">mtx</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
As per <b class="fname">cv_wait</b>(), but causes the current LWP to wait interruptably. If the LWP receives a signal, or is interrupted by another condition such as its containing process exiting, the wait is ended early and an error code returned.<p>
If <b class="fname">cv_wait_sig</b>() returns as a result of a signal, the return value is <span class="errno">ERESTART</span> if the signal has the <span class="define">SA_RESTART</span> property. If awoken normally, the value is zero, and <span class="errno">EINTR</span> under all other conditions.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cv_timedwait</b>(<i class="farg">cv</i>, <i class="farg">mtx</i>, <i class="farg">ticks</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
As per <b class="fname">cv_wait</b>(), but will return early if a timeout specified by the <i class="farg">ticks</i> argument expires.<p>
<i class="farg">ticks</i> is an architecture and system dependent value related to the number of clock interrupts per second. See <a class="link-man" href="../html9/hz.html">hz(9)</a> for details. The <a class="link-man" href="../html9/mstohz.html">mstohz(9)</a> macro can be used to convert a timeout expressed in milliseconds to one suitable for <b class="fname">cv_timedwait</b>(). If the <i class="farg">ticks</i> argument is zero, <b class="fname">cv_timedwait</b>() behaves exactly like <b class="fname">cv_wait</b>().<p>
If the timeout expires before the LWP is awoken, the return value is <span class="errno">EWOULDBLOCK</span>. If awoken normally, the return value is zero.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cv_timedwait_sig</b>(<i class="farg">cv</i>, <i class="farg">mtx</i>, <i class="farg">ticks</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
As per <b class="fname">cv_wait_sig</b>(), but also accepts a timeout value and will return <span class="errno">EWOULDBLOCK</span> if the timeout expires.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cv_signal</b>(<i class="farg">cv</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Awaken one LWP (potentially among many) that is waiting on the specified condition variable. The mutex passed to the wait function (<i class="farg">mtx</i>) must also be held when calling <b class="fname">cv_signal</b>().<p>
(Note that <b class="fname">cv_signal</b>() is erroneously named in that it does not send a signal in the traditional sense to LWPs waiting on a CV.)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cv_broadcast</b>(<i class="farg">cv</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Awaken all LWPs waiting on the specified condition variable. The mutex passed to the wait function (<i class="farg">mtx</i>) must also be held when calling <b class="fname">cv_broadcast</b>().</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cv_has_waiters</b>(<i class="farg">cv</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Return <span class="define">true</span> if one or more LWPs are waiting on the specified condition variable.<p>
<b class="fname">cv_has_waiters</b>() cannot test reliably for interruptable waits. It should only be used to test for non-interruptable waits made using <b class="fname">cv_wait</b>().<p>
<b class="fname">cv_has_waiters</b>() should only be used when making diagnostic assertions, and must be called while holding the interlocking mutex passed to <b class="fname">cv_wait</b>().</dd>
</dl>
</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1><pre style="margin-left: 0.00ex;" class="lit display">
Consuming a resource: 
 
	/* 
	 * Lock the resource.  Its mutex will also serve as the 
	 * interlock. 
	 */ 
	mutex_enter(&amp;res-&gt;mutex); 
 
	/* 
	 * Wait for the resource to become available. 
	 */ 
	while (res-&gt;state == BUSY) 
		cv_wait(&amp;res-&gt;condvar, &amp;res-&gt;mutex); 
 
	/* 
	 * It's now available to us.  Take ownership of the 
	 * resource, and consume it. 
	 */ 
	res-&gt;state = BUSY; 
	mutex_exit(&amp;res-&gt;mutex); 
	consume(res); 
 
Releasing a resource for the next consumer to use: 
 
	mutex_enter(&amp;res-&gt;mutex); 
	res-&gt;state = IDLE; 
	cv_signal(&amp;res-&gt;condvar); 
	mutex_exit(&amp;res-&gt;mutex);</pre>
</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The core of the CV implementation is in <i class="file">sys/kern/kern_condvar.c</i>.<p>
The header file <i class="file">sys/sys/condvar.h</i> describes the public interface.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html2/sigaction.html">sigaction(2)</a>, <a class="link-man" href="../html9/errno.html">errno(9)</a>, <a class="link-man" href="../html9/mb.html">mb(9)</a>, <a class="link-man" href="../html9/mstohz.html">mstohz(9)</a>, <a class="link-man" href="../html9/mutex.html">mutex(9)</a>, <a class="link-man" href="../html9/rwlock.html">rwlock(9)</a><p>
<p>
<span class="ref"><span class="ref-auth">Jim Mauro</span> and <span class="ref-auth">Richard McDougall</span>, <span class="ref-title">Solaris Internals: Core Kernel Architecture</span>, <i class="ref-issue">Prentice Hall</i>, <span class="ref-date">2001</span>, <span class="ref-opt">ISBN 0-13-022496-0</span>.</span></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The CV primitives first appeared in <span class="unix">NetBSD&#160;5.0</span>.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
June 4, 2008</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

