<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
POOL(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
POOL(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
POOL(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">pool_init</b>, <b class="name">pool_destroy</b>, <b class="name">pool_get</b>, <b class="name">pool_put</b>, <b class="name">pool_prime</b>, <b class="name">pool_sethiwat</b>, <b class="name">pool_setlowat</b>, <b class="name">pool_sethardlimit</b> &#8212; <span class="desc">resource-pool manager</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/pool.h</a>&gt;</b><p>
<i class="ftype">void</i><br>
<b class="fname">pool_init</b>(<i class="farg">struct pool *pp</i>, <i class="farg">size_t size</i>, <i class="farg">u_int align</i>, <i class="farg">u_int align_offset</i>, <i class="farg">int flags</i>, <i class="farg">const char *wchan</i>, <i class="farg">struct pool_allocator *palloc</i>, <i class="farg">int ipl</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pool_destroy</b>(<i class="farg" style="white-space:nowrap;">struct pool *pp</i>);<p>
<i class="ftype">void *</i><br>
<b class="fname">pool_get</b>(<i class="farg" style="white-space:nowrap;">struct pool *pp</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pool_put</b>(<i class="farg" style="white-space:nowrap;">struct pool *pp</i>, <i class="farg" style="white-space:nowrap;">void *item</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">pool_prime</b>(<i class="farg" style="white-space:nowrap;">struct pool *pp</i>, <i class="farg" style="white-space:nowrap;">int nitems</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pool_sethiwat</b>(<i class="farg" style="white-space:nowrap;">struct pool *pp</i>, <i class="farg" style="white-space:nowrap;">int n</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pool_setlowat</b>(<i class="farg" style="white-space:nowrap;">struct pool *pp</i>, <i class="farg" style="white-space:nowrap;">int n</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pool_sethardlimit</b>(<i class="farg" style="white-space:nowrap;">struct pool *pp</i>, <i class="farg" style="white-space:nowrap;">int n</i>, <i class="farg" style="white-space:nowrap;">const char *warnmess</i>, <i class="farg" style="white-space:nowrap;">int ratecap</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> These utility routines provide management of pools of fixed-sized areas of memory. Resource pools set aside an amount of memory for exclusive use by the resource pool owner. This can be used by applications to guarantee the availability of a minimum amount of memory needed to continue operation independent of the memory resources currently available from the system-wide memory allocator (<a class="link-man" href="../html9/malloc.html">malloc(9)</a>).<div class="subsection">
<h2 id="x494e495449414c495a494e47204120504f4f4c">INITIALIZING A POOL</h2> The function <b class="fname">pool_init</b>() initializes a resource pool. The arguments are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pp</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
The handle identifying the pool resource instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">size</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Specifies the size of the memory items managed by the pool.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">align</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Specifies the memory address alignment of the items returned by <b class="fname">pool_get</b>(). This argument must be a power of two. If zero, the alignment defaults to an architecture-specific natural alignment.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">align_offset</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
The offset within an item to which the <i class="farg">align</i> parameter applies.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">flags</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Should be set to zero or <span class="define">PR_NOTOUCH</span>. If <span class="define">PR_NOTOUCH</span> is given, free items are never used to keep internal state so that the pool can be used for non memory backed objects.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">wchan</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
The &#8216;wait channel&#8217; passed on to <a class="link-man" href="../html9/cv_wait.html">cv_wait(9)</a> if <b class="fname">pool_get</b>() must wait for items to be returned to the pool.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">palloc</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Can be set to <span class="define">NULL</span> or <span class="define">pool_allocator_kmem</span>, in which case the default kernel memory allocator will be used. It can also be set to <span class="define">pool_allocator_nointr</span> when the pool will never be accessed from interrupt context.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">ipl</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Specifies an interrupt priority level that will block all interrupt handlers that could potentially access the pool.</dd>
</dl>
<p>
The <b class="fname">POOL_INIT</b>() macro can be used to both declare and initialize a resource pool. The <b class="fname">POOL_INIT</b>() macro has the same arguments as the <b class="fname">pool_init</b>() function and the resource pool will be initialized automatically during system startup.</div>
<div class="subsection">
<h2 id="x44455354524f59494e47204120504f4f4c">DESTROYING A POOL</h2> The function <b class="fname">pool_destroy</b>() destroys a resource pool. It takes a single argument <i class="farg">pp</i> identifying the pool resource instance.</div>
<div class="subsection">
<h2 id="x414c4c4f434154494e47204954454d532046524f4d204120504f4f4c">ALLOCATING ITEMS FROM A POOL</h2> <b class="fname">pool_get</b>() allocates an item from the pool and returns a pointer to it. The arguments are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pp</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The handle identifying the pool resource instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">flags</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The flags can be used to define behaviour in case the pooled resources are depleted. If no resources are available and <span class="define">PR_NOWAIT</span> is given, <b class="fname">pool_get</b>() returns <span class="define">NULL</span>. If <span class="define">PR_WAITOK</span> is given and allocation is attempted with no resources available, the function will sleep until items are returned to the pool. If both <span class="define">PR_LIMITFAIL</span> and <span class="define">PR_WAITOK</span> are specified, and the pool has reached its hard limit, <b class="fname">pool_get</b>() will return <span class="define">NULL</span> without waiting, allowing the caller to do its own garbage collection; however, it will still wait if the pool is not yet at its hard limit.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x52455455524e494e47204954454d5320544f204120504f4f4c">RETURNING ITEMS TO A POOL</h2> <b class="fname">pool_put</b>() returns the pool item pointed at by <i class="farg">item</i> to the resource pool identified by the pool handle <i class="farg">pp</i>. If the number of available items in the pool exceeds the maximum pool size set by <b class="fname">pool_sethiwat</b>() and there are no outstanding requests for pool items, the excess items will be returned to the system. The arguments to <b class="fname">pool_put</b>() are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pp</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
The handle identifying the pool resource instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">item</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
A pointer to a pool item previously obtained by <b class="fname">pool_get</b>().</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x5052494d494e47204120504f4f4c">PRIMING A POOL</h2> <b class="fname">pool_prime</b>() adds items to the pool. Storage space for the items is allocated by using the page allocation routine specified to <b class="fname">pool_create</b>().<p>
The arguments to <b class="fname">pool_prime</b>() are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pp</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
The handle identifying the pool resource instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">nitems</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
The number of items to add to the pool.</dd>
</dl>
<p>
This function may return <span class="define">ENOMEM</span> in case the requested number of items could not be allocated. Otherwise, the return value is 0.</div>
<div class="subsection">
<h2 id="x53455454494e4720504f4f4c205245534f555243452057415445524d41524b5320414e44204c494d495453">SETTING POOL RESOURCE WATERMARKS AND LIMITS</h2> A pool will attempt to increase its resource usage to keep up with the demand for its items. Conversely, it will return unused memory to the system should the number of accumulated unused items in the pool exceed a programmable limit.<p>
The limits for the minimum and maximum number of items which a pool should keep at hand are known as the high and low <span class="symb">watermarks</span>. The functions <b class="fname">pool_sethiwat</b>() and <b class="fname">pool_setlowat</b>() set a pool's high and low watermarks, respectively.<p>
The hard limit represents the maximum number of items a pool is allowed to allocate at any given time. Unless modified via <b class="fname">pool_sethardlimit</b>(), the hard limit defaults to <span class="define">UINT_MAX</span>.<p>
<b class="fname">pool_sethiwat</b>()<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pp</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The handle identifying the pool resource instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">n</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The maximum number of items to keep in the pool. As items are returned and the total number of pages in the pool is larger than the maximum set by this function, any completely unused pages are released immediately. If this function is not used to specify a maximum number of items, the pages will remain associated with the pool until the system runs low on memory, at which point the VM system will try to reclaim unused pages.</dd>
</dl>
<p>
<b class="fname">pool_setlowat</b>()<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pp</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The handle identifying the pool resource instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">n</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The minimum number of items to keep in the pool. The number pages in the pool will not decrease below the required value to accommodate the minimum number of items specified by this function. Unlike <b class="fname">pool_prime</b>(), this function does not allocate the necessary memory up-front.</dd>
</dl>
<p>
<b class="fname">pool_sethardlimit</b>()<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pp</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The handle identifying the pool resource instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">n</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The maximum number of items to be allocated from the pool (i.e. the hard limit).</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">warnmess</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The warning message that will be logged when the hard limit is reached.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">ratecap</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The minimal interval (in seconds) after which another warning message is issued when the pool hits its hard limit again.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x504f54454e5449414c2050495446414c4c53">POTENTIAL PITFALLS</h2> Note that undefined behaviour results when mixing the storage providing methods supported by the pool resource routines.<p>
The pool resource code uses a per-pool lock to protect its internal state. If any pool functions are called in an interrupt context, the caller must block all interrupts that might cause the code to be reentered. Additionally, the functions <b class="fname">pool_init</b>() and <b class="fname">pool_destroy</b>() should never be called in interrupt context.</div>
<div class="subsection">
<h2 id="x444941474e4f5354494353">DIAGNOSTICS</h2> Pool usage logs can be enabled by defining the compile-time option <span class="define">POOL_DIAGNOSTIC</span>.</div>
</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The pool manager is implemented in the file <i class="file">sys/kern/subr_pool.c</i>.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html9/free.html">free(9)</a>, <a class="link-man" href="../html9/malloc.html">malloc(9)</a>, <a class="link-man" href="../html9/memoryallocators.html">memoryallocators(9)</a>, <a class="link-man" href="../html9/pool_cache.html">pool_cache(9)</a>, <a class="link-man" href="../html9/uvm.html">uvm(9)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <span class="unix">NetBSD</span> pool manager appeared in <span class="unix">NetBSD&#160;1.4</span>.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
November 14, 2011</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

