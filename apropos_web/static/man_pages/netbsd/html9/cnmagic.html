<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
CNMAGIC(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
CNMAGIC(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
CNMAGIC(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">cn_init_magic</b>, <b class="name">cn_trap</b>, <b class="name">cn_isconsole</b>, <b class="name">cn_check_magic</b>, <b class="name">cn_destroy_magic</b>, <b class="name">cn_set_magic</b>, <b class="name">cn_get_magic</b> &#8212; <span class="desc">console magic key sequence management</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/systm.h</a>&gt;</b><p>
<i class="ftype">void</i><br>
<b class="fname">cn_init_magic</b>(<i class="farg" style="white-space:nowrap;">cnm_state_t *cnms</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">cn_trap</b>();<p>
<i class="ftype">int</i><br>
<b class="fname">cn_isconsole</b>(<i class="farg" style="white-space:nowrap;">dev_t dev</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">cn_check_magic</b>(<i class="farg" style="white-space:nowrap;">dev_t dev</i>, <i class="farg" style="white-space:nowrap;">int k</i>, <i class="farg" style="white-space:nowrap;">cnm_state_t *cnms</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">cn_destroy_magic</b>(<i class="farg" style="white-space:nowrap;">cnm_state_t *cnms</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">cn_set_magic</b>(<i class="farg" style="white-space:nowrap;">char *magic</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">cn_get_magic</b>(<i class="farg" style="white-space:nowrap;">char *magic</i>, <i class="farg" style="white-space:nowrap;">int len</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <span class="unix">NetBSD</span> console magic key sequence management framework is designed to provide flexible methods to set, change, and detect magic key sequences on console devices and break into the debugger or ROM monitor with a minimum of interrupt latency.<p>
Drivers that generate console input should make use of these routines. A different <b class="var">cnm_state_t</b> should be used for each separate input stream. Multiple devices that share the same input stream, such as USB keyboards can share the same <b class="var">cnm_state_t</b>. Once a <b class="var">cnm_state_t</b> is allocated, it should be initialized with <b class="fname">cn_init_magic</b>() so it can be used by <b class="fname">cn_check_magic</b>(). If a driver thinks it might be the console input device it can set the magic sequence with <b class="fname">cn_set_magic</b>() to any arbitrary string. Whenever the driver receives input, it should call <b class="fname">cn_check_magic</b>() to process the data and determine whether the magic sequence has been hit.<p>
The magic key sequence can be accessed through the <b class="var">hw.cnmagic</b> <b class="cmd">sysctl</b> variable. This is the raw data and may be keycodes rather than processed characters, depending on the console device.</div>
<div class="section">
<h1 id="x46554e4354494f4e53">FUNCTIONS</h1> The following functions describe the console magic interface.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cn_init_magic</b>(<i class="farg">cnm</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Initialize the console magic state pointed to by <i class="farg">cnm</i> to a usable state.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cn_trap</b>()</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Trap into the kernel debugger or ROM monitor. By default this routine is defined to be <b class="fname">console_debugger</b>() but can be overridden in MI header files.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cn_isconsole</b>(<i class="farg">dev</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Determine whether a given <i class="farg">dev</i> is the system console. This macro tests to see if <i class="farg">dev</i> is the same as <b class="var">cn_tab-&gt;cn_dev</b> but can be overridden in MI header files.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cn_check_magic</b>(<i class="farg">dev</i>, <i class="farg">k</i>, <i class="farg">cnms</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
All input should be passed through <b class="fname">cn_check_magic</b>() so the state machine remains in a consistent state. <b class="fname">cn_check_magic</b>() calls <b class="fname">cn_isconsole</b>() with <i class="farg">dev</i> to determine if this is the console. If that returns true then it runs the input value <i class="farg">k</i> through the state machine. If the state machine completes a match of the current console magic sequence <b class="fname">cn_trap</b>() is called. Some input may need to be translated to state machine values such as the serial line <code class="lit">BREAK</code> sequence.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cn_destroy_magic</b>(<i class="farg">cnms</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This should be called once what <i class="farg">cnms</i> points to is no longer needed.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cn_set_magic</b>(<i class="farg">magic</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
<b class="fname">cn_set_magic</b>() encodes a <code class="lit">nul</code> terminated string arbitrary string into values that can be used by the state machine and installs it as the global magic sequence. The escape sequence is character value <code class="lit">0x27</code> and can be used to encode special values:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
0x27</dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The literal value <code class="lit">0x27</code>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
0x01</dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
Serial <code class="lit">BREAK</code> sequence.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
0x02</dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
<code class="lit">Nul</code> character.</dd>
</dl>
<p>
Returns <code class="lit">0</code> on success or a non-zero error value.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cn_get_magic</b>(<i class="farg">magic</i>, <i class="farg">len</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Extract the current magic sequence from the state machine and return up to <i class="farg">len</i> bytes of it in the buffer pointed to by <i class="farg">magic</i>. It uses the same encoding accepted by <b class="fname">cn_set_magic</b>(). Returns <code class="lit">0</code> on success or a non-zero error value.</dd>
</dl>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../8/sysctl">sysctl(8)</a>, <a class="link-man" href="../9/cons">cons(9)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <span class="unix">NetBSD</span> console magic key sequence management framework first appeared in <span class="unix">NetBSD&#160;1.6</span>.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> The <span class="unix">NetBSD</span> console magic key sequence management framework was designed and implemented by <span class="author">Eduardo Horvath</span> &#60;eeh@NetBSD.org&#62;.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
June 8, 2010</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

