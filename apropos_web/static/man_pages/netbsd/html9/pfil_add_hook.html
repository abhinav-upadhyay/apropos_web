<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/../4/strict.dtd">
>
<head>
<meta http-equiv="Content-Type" content="te../; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
PFIL(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
PFIL(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
PFIL(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">pfil</b>, <b class="name">pfil_head_register</b>, <b class="name">pfil_head_unregister</b>, <b class="name">pfil_head_get</b>, <b class="name">pfil_hook_get</b>, <b class="name">pfil_add_hook</b>, <b class="name">pfil_remove_hook</b>, <b class="name">pfil_run_hooks</b> &#8212; <span class="desc">packet filter interface</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/param.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">sys/mbuf.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">net/if.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">net/pfil.h</a>&gt;</b><p>
<i class="ftype">int</i><br>
<b class="fname">pfil_head_register</b>(<i class="farg" style="white-space:nowrap;">struct pfil_head *ph</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">pfil_head_unregister</b>(<i class="farg" style="white-space:nowrap;">struct pfil_head *ph</i>);<p>
<i class="ftype">struct pfil_head *</i><br>
<b class="fname">pfil_head_get</b>(<i class="farg" style="white-space:nowrap;">int af</i>, <i class="farg" style="white-space:nowrap;">u_long dlt</i>);<p>
<i class="ftype">struct packet_filter_hook *</i><br>
<b class="fname">pfil_hook_get</b>(<i class="farg" style="white-space:nowrap;">int dir</i>, <i class="farg" style="white-space:nowrap;">struct pfil_head *ph</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">pfil_add_hook</b>(<i class="farg" style="white-space:nowrap;">int (*func)()</i>, <i class="farg" style="white-space:nowrap;">void *arg</i>, <i class="farg" style="white-space:nowrap;">int flags</i>, <i class="farg" style="white-space:nowrap;">struct pfil_head *ph</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">pfil_remove_hook</b>(<i class="farg" style="white-space:nowrap;">int (*func)()</i>, <i class="farg" style="white-space:nowrap;">void *arg</i>, <i class="farg" style="white-space:nowrap;">int flags</i>, <i class="farg" style="white-space:nowrap;">struct pfil_head *ph</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">(*func)</b>(<i class="farg" style="white-space:nowrap;">void *arg</i>, <i class="farg" style="white-space:nowrap;">struct mbuf **mp</i>, <i class="farg" style="white-space:nowrap;">struct ifnet *</i>, <i class="farg" style="white-space:nowrap;">int dir</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">pfil_run_hooks</b>(<i class="farg" style="white-space:nowrap;">struct pfil_head *ph</i>, <i class="farg" style="white-space:nowrap;">struct mbuf **mp</i>, <i class="farg" style="white-space:nowrap;">struct ifnet *ifp</i>, <i class="farg" style="white-space:nowrap;">int dir</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">pfil</b> framework allows for a specified function to be invoked for every incoming or outgoing packet for a particular network I/O stream. These hooks may be used to implement a firewall or perform packet transformations.<p>
Packet filtering points are registered with <b class="fname">pfil_head_register</b>(). Filtering points are identified by a key (void *) and a data link type (int) in the <span class="emph">pfil_head</span> structure. Packet filters use the key and data link type to look up the filtering point with which they register themselves. The key is unique to the filtering point. The data link type is a <a class="link-man" href="../4/bpf">bpf(4)</a> DLT constant indicating what kind of header is present on the packet at the filtering point. Filtering points may be unregistered with the <b class="fname">pfil_head_unregister</b>() function.<p>
Packet filters register/unregister themselves with a filtering point with the <b class="fname">pfil_add_hook</b>() and <b class="fname">pfil_remove_hook</b>() functions, respectively. The head is looked up using the <b class="fname">pfil_head_get</b>() function, which takes the key and data link type that the packet filter expects. Filters may provide an argument to be passed to the filter when invoked on a packet.<p>
When a filter is invoked, the packet appears just as if it &#8220;came off the wire&#8221;. That is, all protocol fields are in network byte order. The filter is called with its specified argument, the pointer to the pointer to the mbuf containing the packet, the pointer to the network interface that the packet is traversing, and the direction (<span class="define">PFIL_IN</span> or <span class="define">PFIL_OUT</span>, see also below) that the packet is traveling. The filter may change which mbuf the mbuf ** argument references. The filter returns an errno if the packet processing is to stop, or 0 if the processing is to continue. If the packet processing is to stop, it is the responsibility of the filter to free the packet.<p>
The <span class="emph">flags</span> parameter, used in the <b class="fname">pfil_add_hook</b>() and <b class="fname">pfil_remove_hook</b>() functions, indicates when the filter should be called. The flags are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
PFIL_IN</dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
call me on incoming packets</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
PFIL_OUT</dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
call me on outgoing packets</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
PFIL_ALL</dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
call me on all of the above</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
PFIL_IFADDR</dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
call me on interface reconfig (mbuf ** is ioctl #)</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
PFIL_IFNET</dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
call me on interface attach/detach (mbuf ** is either <span class="define">PFIL_IFNET_ATTACH</span> or <span class="define">PFIL_IFNET_DETACH</span>)</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
PFIL_WAITOK</dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
OK to call malloc with M_WAITOK.</dd>
</dl>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../4/bpf">bpf(4)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">pfil</b> interface first appeared in <span class="unix">NetBSD&#160;1.3</span>. The <b class="name">pfil</b> input and output lists were originally implemented as <b class="includes">&lt;<a class="link-includes">sys/queue.h</a>&gt;</b> <span class="define">LIST</span> structures; however this was changed in <span class="unix">NetBSD&#160;1.4</span> to <span class="define">TAILQ</span> structures. This change was to allow the input and output filters to be processed in reverse order, to allow the same path to be taken, in or out of the kernel.<p>
The <b class="name">pfil</b> interface was changed in 1.4T to accept a 3rd parameter to both <b class="fname">pfil_add_hook</b>() and <b class="fname">pfil_remove_hook</b>(), introducing the capability of per-protocol filtering. This was done primarily in order to support filtering of IPv6.<p>
In 1.5K, the <b class="name">pfil</b> framework was changed to work with an arbitrary number of filtering points, as well as be less IP-centric.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> The <b class="name">pfil</b> interface was designed and implemented by Matthew R. Green, with help from Darren Reed, Jason R. Thorpe and Charles M. Hannum. Darren Reed added support for IPv6 in addition to IPv4. Jason R. Thorpe added support for multiple hooks and other clean up.</div>
<div class="section">
<h1 id="x42554753">BUGS</h1> The current <b class="name">pfil</b> implementation will need changes to suit a threaded kernel model.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
August 22, 2013</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
<>

