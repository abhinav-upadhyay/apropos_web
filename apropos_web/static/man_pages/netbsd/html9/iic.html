<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/../4/strict.dtd">
>
<head>
<meta http-equiv="Content-Type" content="te../; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
IIC(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
IIC(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
IIC(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">iic_acquire_bus</b>, <b class="name">iic_release_bus</b>, <b class="name">iic_exec</b>, <b class="name">iic_smbus_write_byte</b>, <b class="name">iic_smbus_read_byte</b>, <b class="name">iic_smbus_receive_byte</b> &#8212; <span class="desc">Inter IC (I2C) bus</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">dev/i2c/i2cvar.h</a>&gt;</b><p>
<i class="ftype">int</i><br>
<b class="fname">iic_acquire_bus</b>(<i class="farg">i2c_tag_t ic</i>, <i class="farg">int flags</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">iic_release_bus</b>(<i class="farg">i2c_tag_t ic</i>, <i class="farg">int flags</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">iic_exec</b>(<i class="farg">i2c_tag_t ic</i>, <i class="farg">i2c_op_t op</i>, <i class="farg">i2c_addr_t addr</i>, <i class="farg">const void *cmdbuf</i>, <i class="farg">size_t cmdlen</i>, <i class="farg">void *buf</i>, <i class="farg">size_t buflen</i>, <i class="farg">int flags</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">iic_smbus_write_byte</b>(<i class="farg">i2c_tag_t ic</i>, <i class="farg">i2c_addr_t addr</i>, <i class="farg">uint8_t cmd</i>, <i class="farg">uint8_t data</i>, <i class="farg">int flags</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">iic_smbus_read_byte</b>(<i class="farg">i2c_tag_t ic</i>, <i class="farg">i2c_addr_t addr</i>, <i class="farg">uint8_t cmd</i>, <i class="farg">uint8_t *datap</i>, <i class="farg">int flags</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">iic_smbus_receive_byte</b>(<i class="farg">i2c_tag_t ic</i>, <i class="farg">i2c_addr_t addr</i>, <i class="farg">uint8_t *datap</i>, <i class="farg">int flags</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> I2C is a two-wire bus developed by Philips used for connecting integrated circuits. It is commonly used for connecting devices such as EEPROMs, temperature sensors, fan controllers, real-time clocks, tuners, and other types of integrated circuits. The <b class="name">iic</b> interface provides a means of communicating with I2C-connected devices. The System Management Bus, or SMBus, is a variant of the I2C bus with a simplified command protocol and some electrical differences.</div>
<div class="section">
<h1 id="x44415441205459504553">DATA TYPES</h1> Drivers for devices attached to the I2C bus will make use of the following data types:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">i2c_tag_t</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Controller tag for the I2C bus. This is a pointer to a <i class="farg">struct i2c_controller</i>, consisting of function pointers filled in by the I2C controller driver.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">i2c_op_t</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
I2C bus operation. The following I2C bus operations are defined:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
I2C_OP_READ</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Perform a read operation.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
I2C_OP_READ_WITH_STOP</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Perform a read operation and send a STOP condition on the I2C bus at the conclusion of the read.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
I2C_OP_WRITE</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Perform a write operation.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
I2C_OP_WRITE_WITH_STOP</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Perform a write operation and send a STOP condition on the I2C bus at the conclusion of the write.</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">i2c_addr_t</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
I2C device address.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">struct i2c_attach_args</i></dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Devices are attached to an I2C bus using this structure. The structure is defined as follows:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct i2c_attach_args { 
	i2c_tag_t ia_tag;	/* controller */ 
	i2c_addr_t ia_addr;	/* address of device */ 
	int ia_size;		/* size (for EEPROMs) */ 
};</pre>
</dd>
</dl>
</div>
<div class="section">
<h1 id="x46554e4354494f4e53">FUNCTIONS</h1> The following functions comprise the API provided to drivers of I2C-connected devices:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">iic_acquire_bus</b>(<i class="farg">ic</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
Acquire an exclusive lock on the I2C bus. This is required since only one device may communicate on the I2C bus at a time. Drivers should acquire the bus lock, perform the I2C bus operations necessary, and then release the bus lock. Passing the <span class="define">I2C_F_POLL</span> flag indicates to <b class="fname">iic_acquire_bus</b>() that sleeping is not permitted.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">iic_release_bus</b>(<i class="farg">ic</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
Release an exclusive lock on the I2C bus. If the <span class="define">I2C_F_POLL</span> flag was passed to <b class="fname">iic_acquire_bus</b>(), it must also be passed to <b class="fname">iic_release_bus</b>().</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">iic_exec</b>(<i class="farg">ic</i>, <i class="farg">op</i>, <i class="farg">addr</i>, <i class="farg">cmdbuf</i>, <i class="farg">cmdlen</i>, <i class="farg">buf</i>, <i class="farg">buflen</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
Perform a series of I2C transactions on the bus. <b class="fname">iic_exec</b>() initiates the operation by sending a START condition on the I2C bus and then transmitting the address of the target device along with the transaction type. If <i class="farg">cmdlen</i> is non-zero, the command pointed to by <i class="farg">cmdbuf</i> is then sent to the device. If <i class="farg">buflen</i> is non-zero, <b class="fname">iic_exec</b>() will then transmit or receive the data, as indicated by <i class="farg">op</i>. If <i class="farg">op</i> indicates a read operation, <b class="fname">iic_exec</b>() will send a REPEATED START before transferring the data. If <i class="farg">op</i> so indicates, a STOP condition will be sent on the I2C bus at the conclusion of the operation. Passing the <span class="define">I2C_F_POLL</span> flag indicates to <b class="fname">iic_exec</b>() that sleeping is not permitted.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">iic_smbus_write_byte</b>(<i class="farg">ic</i>, <i class="farg">addr</i>, <i class="farg">cmd</i>, <i class="farg">data</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
Perform an SMBus WRITE BYTE operation. This is equivalent to I2C_OP_WRITE_WITH_STOP with <i class="farg">cmdlen</i> of 1 and <i class="farg">buflen</i> of 1.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">iic_smbus_read_byte</b>(<i class="farg">ic</i>, <i class="farg">addr</i>, <i class="farg">cmd</i>, <i class="farg">datap</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
Perform an SMBus READ BYTE operation. This is equivalent to I2C_OP_READ_WITH_STOP with <i class="farg">cmdlen</i> of 1 and <i class="farg">buflen</i> of 1.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">iic_smbus_receive_byte</b>(<i class="farg">ic</i>, <i class="farg">addr</i>, <i class="farg">datap</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
Perform an SMBus RECEIVE BYTE operation. This is equivalent to I2C_OP_READ_WITH_STOP with <i class="farg">cmdlen</i> of 0 and <i class="farg">buflen</i> of 1.</dd>
</dl>
</div>
<div class="section">
<h1 id="x434f4e54524f4c4c455220494e54455246414345">CONTROLLER INTERFACE</h1> The I2C controller driver must fill in the function pointers of an <i class="farg">i2c_controller</i> structure, which is defined as follows:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct i2c_controller { 
	void	*ic_cookie;	/* controller private */ 
 
	int	(*ic_acquire_bus)(void *, int); 
	void	(*ic_release_bus)(void *, int); 
 
	int	(*ic_exec)(void *, i2c_op_t, i2c_addr_t, 
		   const void *, size_t, void *, size_t, int); 
 
	int	(*ic_send_start)(void *, int); 
	int	(*ic_send_stop)(void *, int); 
	int	(*ic_initiate_xfer)(void *, i2c_addr_t, int); 
	int	(*ic_read_byte)(void *, uint8_t *, int); 
	int	(*ic_write_byte)(void *, uint8_t, int); 
};</pre>
<p>
The <b class="fname">(*ic_acquire_bus)</b>() and <b class="fname">(*ic_release_bus)</b>() functions must always be provided.<p>
The controller driver may elect to provide an <b class="fname">(*ic_exec)</b>() function. This function is intended for use by automated controllers that do not provide manual control over I2C bus conditions such as START and STOP.<p>
If the <b class="fname">(*ic_exec)</b>() function is not provided, the following 5 functions will be used by <b class="fname">iic_exec</b>() in order to execute the I2C bus operation:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">(*ic_send_start)</b>(<i class="farg">cookie</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Send a START condition on the I2C bus. The <span class="define">I2C_F_POLL</span> flag indicates that sleeping is not permitted.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">(*ic_send_stop)</b>(<i class="farg">cookie</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Send a STOP condition on the I2C bus. The <span class="define">I2C_F_POLL</span> flag indicates that sleeping is not permitted.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">(*ic_initiate_xfer)</b>(<i class="farg">cookie</i>, <i class="farg">addr</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Initiate a transfer on the I2C bus by sending a START condition and then transmitting the I2C device address and transfer type. The <span class="define">I2C_F_READ</span> flag indicates a read transfer; the lack of this flag indicates a write transfer. The <span class="define">I2C_F_POLL</span> flag indicates that sleeping is not permitted. The error code <span class="define">ETIMEDOUT</span> should be returned if a timeout that would indicate that the device is not present occurs.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">(*ic_read_byte)</b>(<i class="farg">cookie</i>, <i class="farg">datap</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Read a byte from the I2C bus into the memory location referenced by <i class="farg">datap</i>. The <span class="define">I2C_F_LAST</span> flag indicates that this is the final byte of the transfer, and that a NACK condition should be sent on the I2C bus following the transfer of the byte. The <span class="define">I2C_F_STOP</span> flag indicates that a STOP condition should be sent on the I2C bus following the transfer of the byte. The <span class="define">I2C_F_POLL</span> flag indicates that sleeping is not permitted.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">(*ic_write_byte)</b>(<i class="farg">cookie</i>, <i class="farg">data</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Write the byte contained in <i class="farg">data</i> to the I2C bus. The <span class="define">I2C_F_STOP</span> flag indicates that a STOP condition should be sent on the I2C bus following the transfer of the byte. The <span class="define">I2C_F_POLL</span> flag indicates that sleeping is not permitted.</dd>
</dl>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../4/iic">iic(4)</a>, <a class="link-man" href="../8/i2cscan">i2cscan(8)</a><p>
<span class="ref"><span class="ref-auth">NXP Semiconductors</span>, <span class="ref-title">I2C-bus Specification and User Manual</span>, <span class="ref-num">Revision 03</span>, <a class="link-ref" href="http://www.ics.nxp.com/support/documents/i2c/pdf/i2c.bus.specification.pdf">http://www.ics.nxp.com/support/documents/i2c/pdf/i2c.bus.specification.pdf</a>, <span class="ref-date">June 19, 2007</span>.</span><p>
<span class="ref"><span class="ref-auth">Duracell Inc. et. al.</span>, <span class="ref-title">System Management Bus (SMBus) Specification</span>, <span class="ref-num">Version 2.0</span>, <a class="link-ref" href="http://smbus.org/specs/smbus20.pdf">http://smbus.org/specs/smbus20.pdf</a>, <span class="ref-date">August 3, 2000</span>.</span></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">iic</b> API first appeared in <span class="unix">NetBSD&#160;2.0</span>. <span class="unix">OpenBSD</span> support was added in <span class="unix">OpenBSD&#160;3.6</span>.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> The <b class="name">iic</b> API was written by Steve C. Woodford and Jason R. Thorpe for <span class="unix">NetBSD</span> and then ported to <span class="unix">OpenBSD</span> by <span class="author">Alexander Yurchenko</span> &#60;<a class="link-mail" href="mailto:grange@openbsd.org">grange@openbsd.org</a>&#62;.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
October 15, 2011</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
<>

