<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
PCU(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
PCU(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
PCU(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">pcu</b> &#8212; <span class="desc">per-CPU unit (PCU)</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/pcu.h</a>&gt;</b><p>
<i class="ftype">void</i><br>
<b class="fname">pcu_load</b>(<i class="farg" style="white-space:nowrap;">const pcu_ops_t *pcu</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pcu_save</b>(<i class="farg" style="white-space:nowrap;">const pcu_ops_t *pcu</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pcu_save_all</b>(<i class="farg" style="white-space:nowrap;">lwp_t *l</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pcu_discard</b>(<i class="farg" style="white-space:nowrap;">const pcu_ops_t *pcu</i>, <i class="farg" style="white-space:nowrap;">bool valid</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pcu_discard_all</b>(<i class="farg" style="white-space:nowrap;">lwp_t *l</i>);<p>
<i class="ftype">bool</i><br>
<b class="fname">pcu_valid_p</b>(<i class="farg" style="white-space:nowrap;">const pcu_ops_t *pcu</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> Per CPU Unit (PCU) is an interface to manage synchronization of any per-CPU context (unit) tied to an LWP context. Typical use of PCU is for "lazy-switch" synchronization of the FPU state. Each PCU has its operations defined by a <span class="type">pcu_ops_t</span> structure. Members of <span class="type">pcu_ops_t</span> are<p>
<pre style="margin-left: 0.00ex;" class="lit display">
        u_int	pcu_id; 
        void	(*pcu_state_save)(lwp_t *l); 
        void	(*pcu_state_load)(lwp_t *l, u_int flags); 
        void	(*pcu_state_release)(lwp_t *l);</pre>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pcu_state_save</b>()</dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
Indicate to MD code that the PCU state on the current CPU should be saved into the given LWP's MD storage.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pcu_state_load</b>()</dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
Load PCU state from the given LWP's MD storage to the current CPU. The <i class="arg">flags</i> argument is a combination of one or more of the following:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">PCU_VALID</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Indicate that the PCU state is considered valid and need not be initialized. This is the case if the PCU state was already used (and thus loaded) by the LWP and has not been discarded since.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">PCU_REENABLE</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Indicate that a fault reoccurred while the PCU state is loaded, therefore PCU should be re-enabled. This happens if LWP is context switched to another CPU and then switched back to the original CPU while the state on that CPU has not been changed by other LWPs. It may also happen due to instruction "bouncing" on some architectures.</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pcu_state_release</b>()</dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
Indicate to MD code that the PCU ownership by the LWP was released, therefore the next use of PCU on the LWP shall be detected and <b class="fname">pcu_load</b>() be called to reacquire the ownership. For example, this would normally be the changing of a bit for a CPU to trap on the execution of one of the PCU's instructions.</dd>
</dl>
</div>
<div class="section">
<h1 id="x46554e4354494f4e53">FUNCTIONS</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pcu_load</b>()</dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Load or initialize the PCU state of the current LWP on the current CPU.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pcu_save</b>()</dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Save the specified PCU state to the given LWP.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pcu_discard</b>()</dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Discard the specified PCU state of the current LWP. The PCU state will be considered invalid, unless the "valid" parameter is set to true.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pcu_valid_p</b>()</dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Return true if PCU state is considered valid. Generally, it always becomes "valid" when <b class="fname">pcu_load</b>() is called by the LWP. Otherwise, return false.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pcu_discard_all</b>()</dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Discard all PCU states of the given LWP; generally used by exec and exit.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pcu_save_all</b>()</dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Save all PCU states of the given LWP; generally used during new LWP creation so that the PCU state of the parent could be copied.</dd>
</dl>
</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> <b class="name">pcu</b> is implemented within the file <i class="file">sys/kern/subr_pcu.c</i>.</div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> PCU first appeared in <span class="unix">NetBSD&#160;6.0</span>.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> <span class="author">Mindaugas Rasiukevicius</span> &#60;<a class="link-mail" href="mailto:rmind@NetBSD.org">rmind@NetBSD.org</a>&#62;</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
May 25, 2014</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

