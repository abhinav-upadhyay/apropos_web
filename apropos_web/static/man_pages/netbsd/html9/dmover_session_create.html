<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/../4/strict.dtd">
>
<head>
<meta http-equiv="Content-Type" content="te../; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
DMOVER(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
DMOVER(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
DMOVER(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">dmover_backend_register</b>, <b class="name">dmover_backend_unregister</b>, <b class="name">dmover_session_create</b>, <b class="name">dmover_session_destroy</b>, <b class="name">dmover_request_alloc</b>, <b class="name">dmover_request_free</b>, <b class="name">dmover_process</b>, <b class="name">dmover_done</b> &#8212; <span class="desc">hardware-assisted data mover interface</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">dev/dmover/dmovervar.h</a>&gt;</b><p>
Client interface routines:<p>
<br>
<i class="ftype">int</i><br>
<b class="fname">dmover_session_create</b>(<i class="farg" style="white-space:nowrap;">const char *</i>, <i class="farg" style="white-space:nowrap;">struct dmover_session **</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">dmover_session_destroy</b>(<i class="farg" style="white-space:nowrap;">struct dmover_session *</i>);<p>
<i class="ftype">struct dmover_request *</i><br>
<b class="fname">dmover_request_alloc</b>(<i class="farg" style="white-space:nowrap;">struct dmover_session *</i>, <i class="farg" style="white-space:nowrap;">dmover_buffer *</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">dmover_request_free</b>(<i class="farg" style="white-space:nowrap;">struct dmover_request *</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">dmover_process</b>(<i class="farg" style="white-space:nowrap;">struct dmover_request *</i>);<p>
Back-end interface routines:<p>
<br>
<i class="ftype">void</i><br>
<b class="fname">dmover_backend_register</b>(<i class="farg" style="white-space:nowrap;">struct dmover_backend *</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">dmover_backend_unregister</b>(<i class="farg" style="white-space:nowrap;">struct dmover_backend *</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">dmover_done</b>(<i class="farg" style="white-space:nowrap;">struct dmover_request *</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">dmover</b> facility provides an interface to hardware-assisted data movers. This can be used to copy data from one location in memory to another, clear a region of memory, fill a region of memory with a pattern, and perform simple operations on multiple regions of memory, such as an XOR, without intervention by the CPU.<p>
The drivers for hardware-assisted data movers present themselves to <b class="name">dmover</b> by registering their capabilities. When a client wishes to use a <b class="name">dmover</b> function, it creates a session for that function, which identifies back-ends capable of performing that function. The client then enqueues requests on that session, which the back-ends process asynchronously. The client may choose to block until the request is completed, or may have a call-back invoked once the request has been completed.<p>
When a client creates a session, the <b class="name">dmover</b> facility identifies back-ends which are capable of handling the requested function. When a request is scheduled for processing, the <b class="name">dmover</b> scheduler will identify the best back-end to process the request from the list of candidate back-ends, in an effort to provide load balancing, while considering the relative performance of each back-end.<p>
A <b class="name">dmover</b> function always has one output region. A function may have zero or more input regions, or may use an immediate value as an input. For functions which use input regions, the lengths of each input region and the output region must be the same. All <b class="name">dmover</b> functions with the same name will have the same number of and type inputs. If a back-end attempts to register a function which violates this invariant, behavior is undefined.<p>
The <b class="name">dmover</b> facility supports several types of buffer descriptors. For functions which use input regions, each input buffer descriptor and the output buffer descriptor must be of the same type. This restriction may be removed in a future revision of the interface.<p>
The <b class="name">dmover</b> facility may need to interrupt request processing and restart it. Clients of the <b class="name">dmover</b> facility should take care to avoid unwanted side-effects should this occur. In particular, for functions which use input regions, no input region may overlap with the output region.<div class="subsection">
<h2 id="x444154412053545255435455524553">DATA STRUCTURES</h2> The <b class="name">dmover</b> facility shares several data structures between the client and back-end in order to describe sessions and requests.<p>
<pre style="margin-left: 5.00ex;" class="lit display">
typedef enum { 
	DMOVER_BUF_LINEAR, 
	DMOVER_BUF_UIO 
} dmover_buffer_type; 
 
typedef struct { 
	void *l_addr; 
	size_t l_len; 
} dmover_buf_linear; 
 
typedef union { 
	dmover_buf_linear dmbuf_linear; 
	struct uio *dmbuf_uio; 
} dmover_buffer;</pre>
<p>
Together, these data types are used to describe buffer data structures which the <b class="name">dmover</b> facility understands. Additional buffer types may be added in future revisions of the <b class="name">dmover</b> interface.<p>
The <i class="farg">dmover_assignment</i> structure contains the information about the back-end to which a request is currently assigned. It contains the following public members:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
struct dmover_backend *das_backend</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is a pointer to the back-end.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
const struct dmover_algdesc *das_algdesc</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is a pointer to the algorithm description provided by the back-end for the request's function.</dd>
</dl>
<p>
The <i class="farg">dmover_session</i> structure contains the following public members:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
void *dses_cookie</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is a pointer to client private data.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
int dses_ninputs</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is the number of inputs used by the selected function.</dd>
</dl>
<p>
The <i class="farg">dmover_request</i> structure contains the following public members:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
TAILQ_ENTRY(dmover_request) dreq_dmbq</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Linkage on the back-end's queue of pending requests.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
struct dmover_session *dreq_session</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Pointer to the session with which this request is associated. This is intended for use by the back-end.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
struct dmover_assignment *dreq_assignment</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Pointer to the <i class="farg">dmover_assignment</i> structure which describes the back-end to which the request is currently assigned. The back-end is assigned when the request is scheduled with <b class="fname">dmover_process</b>().</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
void (*dreq_callback)(struct dmover_request *)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is a pointer to an optional call-back function provided by the client. If provided, the call-back is invoked when the request is complete. This field must be <span class="define">NULL</span> if <span class="emph">DMOVER_REQ_WAIT</span> is set in <span class="emph">dreq_flags</span>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
void *dreq_cookie</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is a pointer to client private data specific to the request.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
void *dreq_dmbcookie</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is a pointer to back-end private data, for use while the back-end is actively processing a request.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
volatile int dreq_flags</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
The following flags are defined:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_REQ_DONE</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
The request has been completed. If not using a call-back, the client may poll this bit to determine if a request has been processed.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_REQ_ERROR</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
An error has occurred while processing the request.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_REQ_RUNNING</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
The request is currently being executed by the back-end. Once a command is running, it cannot be cancelled, and must run to completion.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_REQ_WAIT</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
If set by the client, <b class="fname">dmover_process</b>() will wait for the request to complete using <a class="link-man" href="../9/cv_wait">cv_wait(9)</a>. This flag may only be used if the caller has a valid thread context. If this flag is set, a callback may not be used.</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
int dreq_error</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
If the <span class="emph">DMOVER_REQ_ERROR</span> bit is set, this contains the <a class="link-man" href="../2/errno">errno(2)</a> value indicating the error that occurred during processing.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
dmover_buffer_type dreq_outbuf_type</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
The type of the output buffer.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
dmover_buffer dreq_outbuf</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
The output buffer.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
uint8_t dreq_immediate[8]</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is the input for algorithms which use an immediate value. Values smaller than 8 bytes should use the least-significant bytes first. For example, a 32-bit integer would occupy bytes 0, 1, 2, and 3.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
dmover_buffer_type dreq_inbuf_type</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
The type of the input buffer. This is only used if the <b class="name">dmover</b> function has one or more inputs.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
dmover_buffer *dreq_inbuf</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
A pointer to an array of input buffers. This is only used if the <b class="name">dmover</b> function has one or more inputs. The number of inputs, and thus the number of valid elements in the array, is specified by the algorithm description for the session.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x434c49454e5420494e54455246414345">CLIENT INTERFACE</h2> The following functions are provided to the client:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">dmover_session_create</b>(<i class="farg">function</i>, <i class="farg">sessionp</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
The <b class="fname">dmover_session_create</b>() function creates a data mover session for the specified data movement function <i class="farg">function</i>. A handle to the new session is returned in <i class="farg">sessionp</i>.<p>
The following are valid data movement function names:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
&#8220;zero&#8221;</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Fill a memory region with zeros. This algorithm has an input count of 0.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#8220;fill8&#8221;</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Fill a memory region with an 8-bit pattern. This algorithm has an input count of 0. The pattern is provided in the <span class="emph">dreq_imm8</span> member of the <i class="farg">dmover_request</i> structure.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#8220;copy&#8221;</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Copy a memory region from one location to another. This algorithm has an input count of 1.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#8220;xor2&#8221;</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Perform an XOR operation on 2 inputs. This algorithm has an input count of 2.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#8220;xor3&#8221;</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Perform an XOR operation on 3 inputs. This algorithm has an input count of 3.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#8220;xor4&#8221;</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Perform an XOR operation on 4 inputs. This algorithm has an input count of 4.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#8220;xor5&#8221;</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Perform an XOR operation on 5 inputs. This algorithm has an input count of 5.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#8220;xor6&#8221;</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Perform an XOR operation on 6 inputs. This algorithm has an input count of 6.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#8220;xor7&#8221;</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Perform an XOR operation on 7 inputs. This algorithm has an input count of 7.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#8220;xor8&#8221;</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Perform an XOR operation on 8 inputs. This algorithm has an input count of 8.</dd>
</dl>
<p>
Users of the <b class="name">dmover</b> facility are encouraged to use the following aliases for the well-known function names, as doing so saves space and reduces the chance of programming errors:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_FUNC_ZERO</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
&#8220;zero&#8221; (<b class="var">dmover_funcname_zero</b>)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_FUNC_FILL8</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
&#8220;fill8&#8221; (<b class="var">dmover_funcname_fill8</b>)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_FUNC_COPY</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
&#8220;copy&#8221; (<b class="var">dmover_funcname_copy</b>)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_FUNC_XOR2</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
&#8220;xor2&#8221; (<b class="var">dmover_funcname_xor2</b>)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_FUNC_XOR3</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
&#8220;xor3&#8221; (<b class="var">dmover_funcname_xor3</b>)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_FUNC_XOR4</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
&#8220;xor4&#8221; (<b class="var">dmover_funcname_xor4</b>)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_FUNC_XOR5</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
&#8220;xor5&#8221; (<b class="var">dmover_funcname_xor5</b>)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_FUNC_XOR6</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
&#8220;xor6&#8221; (<b class="var">dmover_funcname_xor6</b>)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_FUNC_XOR7</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
&#8220;xor7&#8221; (<b class="var">dmover_funcname_xor7</b>)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
DMOVER_FUNC_XOR8</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
&#8220;xor8&#8221; (<b class="var">dmover_funcname_xor8</b>)</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">dmover_session_destroy</b>(<i class="farg">session</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
The <b class="fname">dmover_session_destroy</b>() function tears down a data mover session and releases all resources associated with it.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">dmover_request_alloc</b>(<i class="farg">session</i>, <i class="farg">inbuf</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
The <b class="fname">dmover_request_alloc</b>() function allocates a <b class="name">dmover</b> request structure and associates it with the specified session. If the <i class="farg">inbuf</i> argument is not <span class="define">NULL</span>, <i class="farg">inbuf</i> is used as the array of input buffer descriptors in the request. Otherwise, if <i class="farg">inbuf</i> is <span class="define">NULL</span> and the <b class="name">dmover</b> function requires input buffers, the input buffer descriptors will be allocated automatically using <a class="link-man" href="../9/malloc">malloc(9)</a>.<p>
If the request structure or input buffer descriptors cannot be allocated, <b class="fname">dmover_request_alloc</b>() return <span class="define">NULL</span> to indicate failure.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">dmover_request_free</b>(<i class="farg">req</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
The <b class="fname">dmover_request_free</b>() function frees a <b class="name">dmover</b> request structure. If the <b class="name">dmover</b> function requires input buffers, and the input buffer descriptors associated with <i class="farg">req</i> were allocated by <b class="fname">dmover_request_alloc</b>(), then the input buffer descriptors will also be freed.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">dmover_process</b>(<i class="farg">req</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
The <b class="fname">dmover_process</b>() function submits the <b class="name">dmover</b> request <i class="farg">req</i> for processing. The call-back specified by the request is invoked when processing is complete.</dd>
</dl>
<p>
The <b class="fname">dmover_session_create</b>() and <b class="fname">dmover_session_destroy</b>() functions must not be called from interrupt context.<p>
The <b class="fname">dmover_request_alloc</b>(), <b class="fname">dmover_request_free</b>(), and <b class="fname">dmover_process</b>() functions may be called from interrupt handlers at levels <span class="emph">IPL_VM</span>, <span class="emph">IPL_SOFTCLOCK</span>, and <span class="emph">IPL_SOFTNET</span>, or in non-interrupt context.<p>
The request completion call-back is called from a software interrupt handler at <span class="emph">IPL_SOFTCLOCK</span>.</div>
<div class="subsection">
<h2 id="x4241434b1e454e4420494e54455246414345">BACK-END INTERFACE</h2> A back-end describes the <b class="name">dmover</b> functions it can perform using an array of <i class="farg">dmover_algdesc</i> structures:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
struct dmover_algdesc { 
	const char *dad_name;	/* algorithm name */ 
	void *dad_data;		/* opaque algorithm description */ 
	int dad_ninputs;	/* number of inputs */ 
};</pre>
<p>
The <span class="emph">dad_name</span> member points to a valid <b class="name">dmover</b> function name which the client may specify. The <span class="emph">dad_data</span> member points to a back-end-specific description of the algorithm.<p>
A back-end presents itself to the <b class="name">dmover</b> facility using the <i class="farg">dmover_backend</i> structure. The back-end must initialize the following members of the structure:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
const char *dmb_name</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is the name of the back-end.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
u_int dmb_speed</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is an estimate of the number of kilobytes/second that the back-end can process.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
void *dmb_cookie</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is a pointer to back-end private data.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
const struct dmover_algdesc *dmb_algdescs</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This points to an array of <i class="farg">dmover_algdesc</i> structures which describe the functions the data mover can perform.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
int dmb_nalgdescs</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is the number of elements in the <span class="emph">dmb_algdescs</span> array.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
void (*dmb_process)(struct dmover_backend *)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is the entry point to the back-end used to process requests.</dd>
</dl>
<p>
When invoked by the <b class="name">dmover</b> facility, the back-end's <b class="fname">(*dmb_process)</b>() function should examine the pending request queue in its <i class="farg">dmover_backend</i> structure:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
TAILQ_HEAD(, dmover_request) dmb_pendreqs</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is the queue of pending requests.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
int dmb_npendreqs</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
This is the number of requests in the <span class="emph">dmb_pendreqs</span> queue.</dd>
</dl>
<p>
If an error occurs when processing the request, the <span class="emph">DMOVER_REQ_ERROR</span> bit must be set in the <span class="emph">dreq_flags</span> member of the request, and the <span class="emph">dreq_error</span> member set to an <a class="link-man" href="../2/errno">errno(2)</a> value to indicate the error.<p>
When the back-end has finished processing the request, it must call the <b class="fname">dmover_done</b>() function. This function eventually invokes the client's call-back routine.<p>
If a hardware-assisted data mover uses interrupts, the interrupt handlers should be registered at IPL_VM.<p>
The following functions are provided to the back-ends:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">dmover_backend_register</b>(<i class="farg">backend</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
The <b class="fname">dmover_backend_register</b>() function registers the back-end <i class="farg">backend</i> with the <b class="name">dmover</b> facility.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">dmover_backend_unregister</b>(<i class="farg">backend</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
The <b class="fname">dmover_backend_unregister</b>() function removes the back-end <i class="farg">backend</i> from the <b class="name">dmover</b> facility. The back-end must already be registered.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">dmover_done</b>(<i class="farg">req</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
The <b class="fname">dmover_done</b>() function is called by the back-end when it has finished processing a request, whether the request completed successfully or not.</dd>
</dl>
<p>
The <b class="fname">dmover_backend_register</b>() and <b class="fname">dmover_backend_unregister</b>() functions must not be called from interrupt context.<p>
The <b class="fname">dmover_done</b>() function may be called at <span class="emph">IPL_VM</span>, <span class="emph">IPL_SOFTCLOCK</span>, <span class="emph">IPL_SOFTNET</span>, or in non-interrupt context.</div>
</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> The following is an example of a client using <b class="name">dmover</b> to zero-fill a region of memory. In this example, the CPU will be able to context switch to another thread and perform work while the hardware-assisted data mover clears the specified block of memory.<p>
<pre style="margin-left: 0.00ex;" class="lit display">
int 
hw_bzero(void *buf, size_t len) 
{ 
	struct dmover_session *dses; 
	struct dmover_request *dreq; 
	int error; 
 
	error = dmover_session_create(DMOVER_FUNC_ZERO, &amp;dses); 
	if (error) 
		return (error); 
 
	dreq = dmover_request_alloc(dses, NULL); 
	if (dreq == NULL) { 
		dmover_session_destroy(dses); 
		return (ENOMEM); 
	} 
 
	dreq-&gt;dreq_flags = DMOVER_REQ_WAIT; 
	dreq-&gt;dreq_callback = NULL; 
	dreq-&gt;dreq_outbuf.dreq_outbuf_type = DMOVER_BUF_LINEAR; 
	dreq-&gt;dreq_outbuf.dmbuf_linear.l_addr = buf; 
	dreq-&gt;dreq_outbuf.dmbuf_linear.l_len = len; 
 
	dmover_process(dreq); 
 
	error = (dreq-&gt;dreq_flags &amp; DMOVER_REQ_ERROR) ? 
	    dreq-&gt;dreq_error : 0; 
 
	dmover_request_free(dreq); 
	dmover_session_destroy(dses); 
 
	return (error); 
}</pre>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../3/queue">queue(3)</a>, <a class="link-man" href="../4/dmoverio">dmoverio(4)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">dmover</b> facility first appeared in <span class="unix">NetBSD&#160;2.0</span>.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> The <b class="name">dmover</b> facility was designed and implemented by <span class="author">Jason R. Thorpe</span> &#60;thorpej@wasabisystems.com&#62; and contributed by Wasabi Systems, Inc.</div>
<div class="section">
<h1 id="x42554753">BUGS</h1> The mechanism by which a back-end should advertise its performance to the request scheduler is not well-defined. Therefore, the load-balancing mechanism within the request scheduler is also not well-defined.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
December 4, 2007</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
<>

