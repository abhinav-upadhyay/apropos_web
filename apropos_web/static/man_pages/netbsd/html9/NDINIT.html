<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
NAMEI(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
NAMEI(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
NAMEI(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">namei</b>, <b class="name">lookup_for_nfsd</b>, <b class="name">lookup_for_nfsd_index</b>, <b class="name">relookup</b>, <b class="name">NDINIT</b>, <b class="name">NDAT</b>, <b class="name">namei_simple_kernel</b>, <b class="name">namei_simple_user</b> &#8212; <span class="desc">pathname lookup</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/namei.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">sys/uio.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">sys/vnode.h</a>&gt;</b><p>
<i class="ftype">int</i><br>
<b class="fname">namei</b>(<i class="farg" style="white-space:nowrap;">struct nameidata *ndp</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">lookup_for_nfsd</b>(<i class="farg" style="white-space:nowrap;">struct nameidata *ndp</i>, <i class="farg" style="white-space:nowrap;">struct vnode *startdir</i>, <i class="farg" style="white-space:nowrap;">int neverfollow</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">lookup_for_nfsd_index</b>(<i class="farg" style="white-space:nowrap;">struct nameidata *ndp</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">relookup</b>(<i class="farg" style="white-space:nowrap;">struct vnode *dvp</i>, <i class="farg" style="white-space:nowrap;">struct vnode **vpp</i>, <i class="farg" style="white-space:nowrap;">struct componentname *cnp</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">NDINIT</b>(<i class="farg" style="white-space:nowrap;">struct nameidata *ndp</i>, <i class="farg" style="white-space:nowrap;">u_long op</i>, <i class="farg" style="white-space:nowrap;">u_long flags</i>, <i class="farg" style="white-space:nowrap;">struct pathbuf *pathbuf</i>);<p>
<b class="fname">NDAT</b>(<i class="farg" style="white-space:nowrap;">struct nameidata *ndp</i>, <i class="farg" style="white-space:nowrap;">struct vnode *dvp</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">namei_simple_kernel</b>(<i class="farg" style="white-space:nowrap;">const char *path</i>, <i class="farg" style="white-space:nowrap;">namei_simple_flags_t sflags</i>, <i class="farg" style="white-space:nowrap;">struct vnode **ret</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">namei_simple_user</b>(<i class="farg" style="white-space:nowrap;">const char *path</i>, <i class="farg" style="white-space:nowrap;">namei_simple_flags_t sflags</i>, <i class="farg" style="white-space:nowrap;">struct vnode **ret</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">namei</b> interface is used to convert pathnames to file system vnodes. The name of the interface is actually a contraction of the words <span class="emph">name</span> and <span class="emph">inode</span> for name-to-inode conversion, in the days before the <a class="link-man" href="../9/vfs">vfs(9)</a> interface was implemented.<p>
Except for the simple forms, the arguments passed to the functions are encapsulated in the <span class="emph">nameidata</span> structure. It has the following layout:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct nameidata { 
        /* 
         * Arguments to namei/lookup. 
         */ 
        struct vnode *ni_startdir;      /* starting dir, cwd if null */ 
        struct pathbuf *ni_pathbuf;     /* pathname container */ 
        char *ni_pnbuf;                 /* extra pathname buffer ref (XXX) */ 
        /* 
         * Arguments to lookup. 
         */ 
        struct  vnode *ni_startdir;     /* starting directory */ 
        struct  vnode *ni_rootdir;      /* logical root directory */ 
        /* 
         * Results: returned from/manipulated by lookup 
         */ 
        struct  vnode *ni_vp;           /* vnode of result */ 
        struct  vnode *ni_dvp;          /* vnode of intermediate dir */ 
        /* 
         * Shared between namei and lookup/commit routines. 
         */ 
        size_t ni_pathlen;              /* remaining chars in path */ 
        const char *ni_next;            /* next location in pathname */ 
        unsigned int ni_loopcnt;        /* count of symlinks encountered */ 
        /* 
         * Lookup parameters 
         */ 
        struct componentname { 
                /* 
                 * Arguments to lookup. 
                 */ 
                uint32_t cn_nameiop;    /* namei operation */ 
                uint32_t cn_flags;      /* flags to namei */ 
                kauth_cred_t cn_cred;   /* credentials */ 
                /* 
                 * Shared between lookup and commit routines. 
                 */ 
                const char *cn_nameptr; /* pointer to looked up name */ 
                size_t cn_namelen;      /* length of looked up component */ 
                size_t cn_consume;      /* chars to be consumed this time */ 
        } ni_cnd; 
};</pre>
<p>
The <b class="name">namei</b> interface accesses vnode operations by passing arguments in the partially initialised <span class="emph">componentname</span> structure <span class="emph">ni_cnd</span>. This structure describes the subset of information from the nameidata structure that is passed through to the vnode operations. See <a class="link-man" href="../9/vnodeops">vnodeops(9)</a> for more information. The details of the componentname structure are not absolutely necessary since the members are initialised by the helper macro <b class="fname">NDINIT</b>(). It is useful to know the operations and flags as specified in <a class="link-man" href="../9/vnodeops">vnodeops(9)</a>.<p>
The <b class="name">namei</b> interface overloads <span class="emph">ni_cnd.cn_flags</span> with some additional flags. These flags should be specific to the <b class="name">namei</b> interface and ignored by vnode operations. However, due to the historic close relationship between the <b class="name">namei</b> interface and the vnode operations, these flags are sometimes used (and set) by vnode operations, particularly <b class="fname">VOP_LOOKUP</b>(). The additional flags are:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">NOCROSSMOUNT</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
do not cross mount points</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">RDONLY</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
lookup with read-only semantics</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ISDOTDOT</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
current pathname component is ..</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">MAKEENTRY</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
add entry to the name cache</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ISLASTCN</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
this is last component of pathname</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">ISWHITEOUT</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
found whiteout</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">DOWHITEOUT</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
do whiteouts</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">REQUIREDIR</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
must be a directory</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">CREATEDIR</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
trailing slashes are ok</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">PARAMASK</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
mask of parameter descriptors</dd>
</dl>
<p>
All access to the <b class="name">namei</b> interface must be in process context. Pathname lookups cannot be done in interrupt context.</div>
<div class="section">
<h1 id="x46554e4354494f4e53">FUNCTIONS</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">namei</b>(<i class="farg">ndp</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Convert a pathname into a pointer to a vnode. The nameidata structure pointed to by <i class="farg">ndp</i> should be initialized with the <b class="fname">NDINIT</b>() macro. Direct initialization of members of struct nameidata is <span class="emph">not</span> supported and may break silently in the future.<p>
The vnode for the pathname is returned in <span class="emph">ndp-&gt;ni_vp</span>. The parent directory is returned locked in <span class="emph">ndp-&gt;ni_dvp</span> iff <span class="define">LOCKPARENT</span> is specified.<p>
If <span class="emph">ndp-&gt;ni_cnd.cn_flags</span> has the <span class="define">FOLLOW</span> flag set then symbolic links are followed when they occur at the end of the name translation process. Symbolic links are always followed for all other pathname components other than the last.<p>
Historically <b class="name">namei</b> had a sub-function called <b class="fname">lookup</b>(). This function processed a pathname until either running out of material or encountering a symbolic link. <b class="name">namei</b> worked by first setting up the start directory <span class="emph">ndp-&gt;ni_startdir</span> and then calling <b class="fname">lookup</b>() repeatedly.<p>
The semantics of <b class="name">namei</b> are altered by the operation specified by <span class="emph">ndp-&gt;ni_cnd.cn_nameiop</span>. When <span class="define">CREATE</span>, <span class="define">RENAME</span>, or <span class="define">DELETE</span> is specified, information usable in creating, renaming, or deleting a directory entry may be calculated.<p>
If the target of the pathname exists and LOCKLEAF is set, the target is returned locked in <span class="emph">ndp-&gt;ni_vp</span>, otherwise it is returned unlocked.<p>
As of this writing the internal function <b class="fname">do_lookup</b>() is comparable to the historic <b class="fname">lookup</b>() but this code is slated for refactoring.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">lookup_for_nfsd</b>(<i class="farg">ndp</i>, <i class="farg">startdir</i>, <i class="farg">neverfollow</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
This is a private entry point into <b class="name">namei</b> used by the NFS server code. It looks up a path starting from <i class="farg">startdir</i>. If <i class="farg">neverfollow</i> is set, <span class="emph">any</span> symbolic link (not just at the end of the path) will cause an error. Otherwise, it follows symlinks normally. Its semantics are similar to a symlink-following loop around the historic <b class="fname">lookup</b>() function described above. It should not be used by new code.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">lookup_for_nfsd_index</b>(<i class="farg">ndp</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
This is a (second) private entry point into <b class="name">namei</b> used by the NFS server code. Its semantics are similar to the historic <b class="fname">lookup</b>() function described above. It should not be used by new code.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">relookup</b>(<i class="farg">dvp</i>, <i class="farg">vpp</i>, <i class="farg">cnp</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Reacquire a path name component is a directory. This is a quicker way to lookup a pathname component when the parent directory is known. The locked parent directory vnode is specified by <i class="farg">dvp</i> and the pathname component by <i class="farg">cnp</i>. The vnode of the pathname is returned in the address specified by <i class="farg">vpp</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">NDINIT</b>(<i class="farg">ndp</i>, <i class="farg">op</i>, <i class="farg">flags</i>, <i class="farg">pathbuf</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Initialise a nameidata structure pointed to by <i class="farg">ndp</i> for use by the <b class="name">namei</b> interface. The operation and flags are specified by <i class="farg">op</i> and <i class="farg">flags</i> respectively. The pathname is passed as a pathbuf structure, which should be initialized using one of the <a class="link-man" href="../9/pathbuf">pathbuf(9)</a> operations. Destroying the pathbuf is the responsibility of the caller; this must not be done until the caller is finished with all of the <b class="name">namei</b> results and all of the nameidata contents except for the result vnode.<p>
This routine stores the credentials of the calling thread (<b class="var">curlwp</b>) in <i class="farg">ndp</i>. In the rare case that another set of credentials is required for the namei operation, <span class="emph">ndp-&gt;ni_cnd.cn_cred</span> must be set manually.<p>
The following fields of <i class="farg">ndp</i> are set:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">ni_cnd.cn_nameiop</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
is set to <i class="farg">op</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">ni_cnd.cn_flags</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
is set to <i class="farg">flags</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">ni_startdir</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
is set to <span class="define">NULL</span>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">ni_pathbuf</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
is set to <i class="farg">pathbuf</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">ni_cnd.cn_cred</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
is set using <a class="link-man" href="../9/kauth_cred_get">kauth_cred_get(9)</a>.</dd>
</dl>
Other fields of struct nameidata are not (normally) initialized before <b class="name">namei</b> is called. Direct assignment of these or other fields other than by using <b class="fname">NDINIT</b>() or <b class="fname">NDAT</b>(), except as specifically described above, is not supported and may break silently in the future.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">NDAT</b>(<i class="farg">ndp</i>, <i class="farg">dvp</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
This macro is used after <b class="fname">NDINIT</b>() to set the starting directory. This supersedes the current process's current working directory as the initial point of departure for looking up relative paths. This mechanism is used by <a class="link-man" href="../2/openat">openat(2)</a> and related calls.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">namei_simple_kernel</b>(<i class="farg">path</i>, <i class="farg">sflags</i>, <i class="farg">ret</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Look up the path <i class="farg">path</i> and translate it to a vnode, returned in <i class="farg">ret</i>. The <i class="farg">path</i> argument must be a kernel (<span class="define">UIO_SYSSPACE</span>) pointer. The <i class="farg">sflags</i> argument chooses the precise behavior. It may be set to one of the following symbols:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">NSM_NOFOLLOW_NOEMULROOT</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">NSM_NOFOLLOW_TRYEMULROOT</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">NSM_FOLLOW_NOEMULROOT</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">NSM_FOLLOW_TRYEMULROOT</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
</dd>
</dl>
These select (or not) the <span class="define">FOLLOW/NOFOLLOW</span> and <span class="define">TRYEMULROOT</span> flags. Other flags are not available through this interface, which is nonetheless sufficient for more than half the <b class="fname">namei</b>() usage in the kernel. Note that the encoding of <i class="farg">sflags</i> has deliberately been arranged to be type-incompatible with anything else. This prevents various possible accidents while the <b class="fname">namei</b>() interface is being rototilled.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">namei_simple_user</b>(<i class="farg">path</i>, <i class="farg">sflags</i>, <i class="farg">ret</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
This function is the same as <b class="fname">namei_simple_kernel</b>() except that the <i class="farg">path</i> argument shall be a user pointer (<span class="define">UIO_USERSPACE</span>) rather than a kernel pointer.</dd>
</dl>
</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The name lookup subsystem is implemented within the file <i class="file">sys/kern/vfs_lookup.c</i>.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../9/intro">intro(9)</a>, <a class="link-man" href="../9/namecache">namecache(9)</a>, <a class="link-man" href="../9/vfs">vfs(9)</a>, <a class="link-man" href="../9/vnode">vnode(9)</a>, <a class="link-man" href="../9/vnodeops">vnodeops(9)</a></div>
<div class="section">
<h1 id="x42554753">BUGS</h1> It is unfortunate that much of the <b class="name">namei</b> interface makes assumptions on the underlying vnode operations. These assumptions are an artefact of the introduction of the vfs interface to split a file system interface which was historically designed as a tightly coupled module.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
April 21, 2015</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

