<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
RATECHECK(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
RATECHECK(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
RATECHECK(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">ratecheck</b> &#8212; <span class="desc">function to help implement rate-limited actions</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/time.h</a>&gt;</b><p>
<i class="ftype">int</i><br>
<b class="fname">ratecheck</b>(<i class="farg" style="white-space:nowrap;">struct timeval *lasttime</i>, <i class="farg" style="white-space:nowrap;">const struct timeval *mininterval</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="fname">ratecheck</b>() function provides a simple time interval check which can be used when implementing time-based rate-limited actions. If the difference between the current monotonically-increasing system time (<b class="var">mono_time</b>) and <i class="farg">lasttime</i> is less than the value given by the <i class="farg">mininterval</i> argument, zero is returned. Otherwise, <i class="farg">lasttime</i> is set to the current time and a non-zero value is returned.<p>
The motivation for implementing <b class="fname">ratecheck</b>() was to provide a mechanism that could be used to add rate limiting to diagnostic message output. If printed too often, diagnostic messages can keep the system from doing useful work. If the repeated messages can be caused by deliberate user action or network events, they can be exploited to cause denial of system service.<p>
Note that using a very short time interval (less than a second) for <i class="farg">mininterval</i> defeats the purpose of this function. (It doesn't take much to flood a 9600 baud serial console with output, for instance.)</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> Here is a simple example of use of the <b class="fname">ratecheck</b>() function:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
/* 
 * The following variables could be global, in a device softc, etc., 
 * depending on the exact usage. 
 */ 
struct timeval drv_lasterr1time;   /* time of last err1 message */ 
long drv_err1count;                /* # of err1 errs since last msg */ 
struct timeval drv_lasterr2time;   /* time of last err2 message */ 
long drv_err2count;                /* # of err2 errs since last msg */ 
 
/* 
 * The following variable will often be global or shared by all 
 * instances of a driver.  It should be initialized, so it can be 
 * patched.  Allowing it to be set via an option might be nice, 
 * but could lead to an insane proliferation of options. 
 */ 
struct timeval drv_errintvl = { 5, 0 };         /* 5 seconds */ 
 
/* error handling/reporting function */ 
void 
drv_errhandler(int err1, int err2) 
{ 
 
	/* 
	 * Note that you should NOT use the same last-event 
	 * time variable for dissimilar messages! 
	 */ 
	if (err1) { 
		/* handle err1 condition */ 
		... 
 
		drv_err1count++; 
		if (ratecheck(&amp;drv_lasterr1notice, 
		    &amp;drv_errinterval)) { 
			printf("drv: %ld err1 errors occurred", 
			    drv_err1count); 
			drv_err1count = 0; 
		} 
	} 
	if (err2) { 
		/* handle err2 condition */ 
		... 
 
		drv_err2count++; 
		if (ratecheck(&amp;drv_lasterr2notice, 
		    &amp;drv_errinterval)) { 
			printf("drv: %ld err2 errors occurred", 
			    drv_err2count); 
			drv_err2count = 0; 
		} 
	} 
}</pre>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../9/log">log(9)</a>, <a class="link-man" href="../9/ppsratecheck">ppsratecheck(9)</a>, <a class="link-man" href="../9/printf">printf(9)</a>, <a class="link-man" href="../9/time_second">time_second(9)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="fname">ratecheck</b>() function appeared in <span class="unix">NetBSD&#160;1.5</span>.</div>
<div class="section">
<h1 id="x42554753">BUGS</h1> <b class="fname">ratecheck</b>() may not work as expected, if <i class="farg">mininterval</i> is less than the hardware clock interrupt interval (<code class="lit">1/hz</code>).</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
February 2, 2000</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

