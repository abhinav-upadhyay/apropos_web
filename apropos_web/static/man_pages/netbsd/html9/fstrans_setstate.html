<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
FSTRANS(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
FSTRANS(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
FSTRANS(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">fstrans</b>, <b class="name">fstrans_setstate</b>, <b class="name">fstrans_getstate</b>, <b class="name">fstrans_start</b>, <b class="name">fstrans_start_nowait</b>, <b class="name">fstrans_done</b>, <b class="name">fstrans_is_owner</b>, <b class="name">fscow_establish</b>, <b class="name">fscow_disestablish</b>, <b class="name">fscow_run</b> &#8212; <span class="desc">file system suspension helper subsystem</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/mount.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">sys/fstrans.h</a>&gt;</b><p>
<i class="ftype">int</i><br>
<b class="fname">fstrans_mount</b>(<i class="farg" style="white-space:nowrap;">struct mount *mp</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">fstrans_unmount</b>(<i class="farg" style="white-space:nowrap;">struct mount *mp</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">fstrans_start</b>(<i class="farg" style="white-space:nowrap;">struct mount *mp</i>, <i class="farg" style="white-space:nowrap;">enum fstrans_lock_type lock_type</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">fstrans_start_nowait</b>(<i class="farg" style="white-space:nowrap;">struct mount *mp</i>, <i class="farg" style="white-space:nowrap;">enum fstrans_lock_type lock_type</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">fstrans_done</b>(<i class="farg" style="white-space:nowrap;">struct mount *mp</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">fstrans_setstate</b>(<i class="farg" style="white-space:nowrap;">struct mount *mp</i>, <i class="farg" style="white-space:nowrap;">enum fstrans_state new_state</i>);<p>
<i class="ftype">enum fstrans_state</i><br>
<b class="fname">fstrans_getstate</b>(<i class="farg" style="white-space:nowrap;">struct mount *mp</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">fstrans_is_owner</b>(<i class="farg" style="white-space:nowrap;">struct mount *mp</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">fscow_establish</b>(<i class="farg" style="white-space:nowrap;">struct mount *mp</i>, <i class="farg" style="white-space:nowrap;">int (*func)(void *, struct buf *, bool)</i>, <i class="farg" style="white-space:nowrap;">void *cookie</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">fscow_disestablish</b>(<i class="farg" style="white-space:nowrap;">struct mount *mp</i>, <i class="farg" style="white-space:nowrap;">int (*func)(void *, struct buf *, bool)</i>, <i class="farg" style="white-space:nowrap;">void *cookie</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">fscow_run</b>(<i class="farg" style="white-space:nowrap;">struct buf *bp</i>, <i class="farg" style="white-space:nowrap;">bool data_valid</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">fstrans</b> subsystem assists file system suspension and copy-on-write snapshots.<p>
For a file system to use <b class="name">fstrans</b>, its <a class="link-man" href="../9/VFS_MOUNT">VFS_MOUNT(9)</a> method must call <b class="fname">fstrans_mount</b>(), and its <a class="link-man" href="../9/VFS_UNMOUNT">VFS_UNMOUNT(9)</a> method must call <b class="fname">fstrans_unmount</b>().<p>
The file system's normal operations, such as its <a class="link-man" href="../9/vnodeops">vnodeops(9)</a>, must be bracketed by <b class="fname">fstrans_start</b>() and <b class="fname">fstrans_done</b>() in a <span class="emph">shared</span> transaction, which is blocked by suspending the file system and while it is suspended.<p>
Operations needed to sync the file system to its backing store must be bracketed by <b class="fname">fstrans_start</b>() and <b class="fname">fstrans_done</b>() in a <span class="emph">lazy</span> transaction, which is allowed while suspending the file system in order to sync it to its backing store, but blocked while the file system is suspended.<p>
Transactions are per-thread and nestable: if a thread is already in a transaction, it can enter another transaction without blocking. Each <b class="fname">fstrans_start</b>() must be paired with <b class="fname">fstrans_done</b>(). Transactions for multiple distinct mount points may not be nested.<p>
The file system's <a class="link-man" href="../9/VFS_SUSPENDCTL">VFS_SUSPENDCTL(9)</a> method can use <b class="fname">fstrans_setstate</b>() to:<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-dash">
<li class="list-dash" style="margin-top: 1.00em;">
enter the <span class="define">FSTRANS_SUSPENDING</span> to suspend all normal operations but allow syncing,</li>
<li class="list-dash" style="margin-top: 1.00em;">
enter the <span class="define">FSTRANS_SUSPENDED</span> state to suspend all operations once synced, and</li>
<li class="list-dash" style="margin-top: 1.00em;">
restore to the <span class="define">FSTRANS_NORMAL</span> state to resume all operations.</li>
</ul>
<p>
A file system supporting <b class="name">fstrans</b> may establish a copy-on-write callback with <b class="fname">fscow_establish</b>(). The copy-on-write callback will be called every time a buffer is written to a block device with <b class="fname">VOP_STRATEGY</b>() and every time a buffer is read into the <a class="link-man" href="../9/buffercache">buffercache(9)</a> with <span class="define">B_MODIFY</span> set indicating the caller's intent to modify it. Anyone modifying a buffer may additionally use <b class="fname">fscow_run</b>() to explicitly invoke the established callback. The copy-on-write callback must be disestablished with <b class="fname">fscow_disestablish</b>() when the file system is done with it.</div>
<div class="section">
<h1 id="x46554e4354494f4e53">FUNCTIONS</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fstrans_mount</b>(<i class="farg">mp</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Initialize the <b class="name">fstrans</b> subsystem for the file system mounted at <i class="farg">mp</i>. Sets <span class="define">IMNT_HAS_TRANS</span> in <i class="farg">mp</i><code class="lit">-&gt;mnt_iflag</code>. Return zero on success, or error code if <a class="link-man" href="../9/vfs_busy">vfs_busy(9)</a> fails.<p>
May sleep.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fstrans_unmount</b>(<i class="farg">mp</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Finalize the <b class="name">fstrans</b> subsystem. Clears <span class="define">IMNT_HAS_TRANS</span> in <i class="farg">mp</i><code class="lit">-&gt;mnt_iflag</code>. Caller is responsible for ensuring that no transactions are active.<p>
May sleep.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fstrans_start</b>(<i class="farg">mp</i>, <i class="farg">lock_type</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Enter a transaction of type <i class="farg">lock_type</i> on the file system <i class="farg">mp</i> in the current thread. If the file system is in a state that blocks such transactions, wait until it changes state to one that does not.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">FSTRANS_SHARED</span></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
If the file system is suspending or suspended, wait until it is resumed. Intended for normal file system operations.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">FSTRANS_LAZY</span></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
If the file system is suspended, wait until it is resumed. Intended for operations needed to sync the file system to its backing store in order to suspend it.</dd>
</dl>
<p>
However, if the current thread is already in a transaction on <i class="farg">mp</i>, <b class="fname">fstrans_start</b>() will enter a nested transaction and return immediately without waiting.<p>
May sleep.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fstrans_start_nowait</b>(<i class="farg">mp</i>, <i class="farg">lock_type</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Like <b class="fname">fstrans_start</b>(), but return <span class="define">EBUSY</span> immediately if <i class="farg">lock_type</i> transactions are blocked in its current state.<p>
May sleep nevertheless on internal locks.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fstrans_done</b>(<i class="farg">mp</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
End the current transaction on <i class="farg">mp</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fstrans_getstate</b>(<i class="farg">mp</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Return the current state of the file system <i class="farg">mp</i>.<p>
Must be called within a transaction for the answer to be stable.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fstrans_setstate</b>(<i class="farg">mp</i>, <i class="farg">new_state</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Change the state of the file system <i class="farg">mp</i> to <i class="farg">new_state</i>, and wait for all transactions not allowed in <i class="farg">new_state</i> to complete.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">FSTRANS_NORMAL</span></dt>
<dd class="list-tag" style="margin-left: 18.00ex;">
Allow all transactions.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">FSTRANS_SUSPENDING</span></dt>
<dd class="list-tag" style="margin-left: 18.00ex;">
Block <span class="define">FSTRANS_SHARED</span> transactions but allow <span class="define">FSTRANS_LAZY</span> transactions.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">FSTRANS_SUSPENDED</span></dt>
<dd class="list-tag" style="margin-left: 18.00ex;">
Block all transactions.</dd>
</dl>
<p>
A thread that changes a file system to a state other than <span class="define">FSTRANS_NORMAL</span> enters a transaction for the purposes of <b class="fname">fstrans_getstate</b>() until it changes state back to <span class="define">FSTRANS_NORMAL</span>.<p>
Additionally, a thread that changes a file system to a state other than <span class="define">FSTRANS_NORMAL</span> acquires an exclusive lock on the file system state, so that <b class="fname">fstrans_is_owner</b>() will return true in that thread, and no other thread can change the file system's state until the owner restores it to <span class="define">FSTRANS_NORMAL</span>.<p>
May sleep, and may be interrupted by a signal. On success, return zero. On failure, restore the file system to the <span class="define">FSTRANS_NORMAL</span> state and return an error code. <b class="fname">fstrans_setstate</b>() never fails if <i class="farg">new_state</i> is <span class="define">FSTRANS_NORMAL</span>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fstrans_is_owner</b>(<i class="farg">mp</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Return <span class="define">true</span> if the current thread is currently suspending the file system <i class="farg">mp</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fscow_establish</b>(<i class="farg">mp</i>, <i class="farg">func</i>, <i class="farg">cookie</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Establish a copy-on-write callback for the file system <i class="farg">mp</i>. The function <i class="farg">func</i> will be called for every buffer <i class="farg">bp</i> written through this file system as<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit"><i class="farg">func</i><code class="lit">(</code><i class="farg">cookie</i><code class="lit">,</code> <i class="farg">bp</i><code class="lit">,</code> <i class="farg">data_valid</i><code class="lit">)</code></code></div>
</blockquote>
where <i class="farg">data_valid</i> is true if and only if the buffer <i class="farg">bp</i> has not yet been modified.<p>
May sleep.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fscow_disestablish</b>(<i class="farg">mp</i>, <i class="farg">func</i>, <i class="farg">cookie</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Disestablish a copy-on-write callback established with <b class="fname">fscow_establish</b>().<p>
May sleep.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">fscow_run</b>(<i class="farg">bp</i>, <i class="farg">data_valid</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Run all copy-on-write callbacks established for the file system this buffer belongs to, if they have not already been run for this buffer. If <i class="farg">data_valid</i> is <span class="define">true</span> the buffer data has not yet been modified.<p>
May sleep.</dd>
</dl>
</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> The following is an example of a file system suspend operation.<p>
<pre style="margin-left: 0.00ex;" class="lit display">
int 
xxx_suspendctl(struct mount *mp, int cmd) 
{ 
	int error; 
 
	switch (cmd) { 
	case SUSPEND_SUSPEND: 
		error = fstrans_setstate(mp, FSTRANS_SUSPENDING); 
		if (error) 
			return error; 
 
		/* Sync file system state to disk. */ 
 
		return fstrans_setstate(mp, FSTRANS_SUSPENDED); 
 
	case SUSPEND_RESUME: 
		return fstrans_setstate(mp, FSTRANS_NORMAL); 
 
	default: 
		return EINVAL; 
	} 
}</pre>
<p>
This is an example of a file system operation.<p>
<pre style="margin-left: 0.00ex;" class="lit display">
int 
xxx_create(void *v) 
{ 
	struct vop_create_args *ap = v; 
	struct mount *mp = ap-&gt;a_dvp-&gt;v_mount; 
	int error; 
 
	fstrans_start(mp, FSTRANS_SHARED); 
 
	/* Actually create the node. */ 
 
	fstrans_done(mp); 
 
	return 0; 
}</pre>
</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The <b class="name">fstrans</b> subsystem is implemented in the file <i class="file">sys/kern/vfs_trans.c</i>.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../9/vfs_resume">vfs_resume(9)</a>, <a class="link-man" href="../9/vfs_suspend">vfs_suspend(9)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">fstrans</b> subsystem appeared in <span class="unix">NetBSD&#160;5.0</span>.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> The <b class="name">fstrans</b> subsystem was written by <span class="author">J&#252;rgen Hannken-Illjes</span> &#60;hannken@NetBSD.org&#62;.</div>
<div class="section">
<h1 id="x42554753">BUGS</h1> <b class="name">fstrans</b> is useful only for temporary suspension -- it does not help to permanently block file system operations for unmounting, because <b class="fname">fstrans_start</b>() cannot fail.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
March 31, 2015</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

