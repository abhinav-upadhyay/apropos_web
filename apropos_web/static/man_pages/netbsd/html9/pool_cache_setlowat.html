<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
POOL_CACHE(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
POOL_CACHE(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
POOL_CACHE(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">pool_cache</b>, <b class="name">pool_cache_init</b>, <b class="name">pool_cache_destroy</b>, <b class="name">pool_cache_get_paddr</b>, <b class="name">pool_cache_get</b>, <b class="name">pool_cache_put_paddr</b>, <b class="name">pool_cache_put</b>, <b class="name">pool_cache_destruct_object</b>, <b class="name">pool_cache_invalidate</b>, <b class="name">pool_cache_sethiwat</b>, <b class="name">pool_cache_setlowat</b>, <b class="name">pool_cache_sethardlimit</b> &#8212; <span class="desc">resource-pool cache manager</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/pool.h</a>&gt;</b><p>
<i class="ftype">pool_cache_t</i><br>
<b class="fname">pool_cache_init</b>(<i class="farg" style="white-space:nowrap;">size_t size</i>, <i class="farg" style="white-space:nowrap;">u_int align</i>, <i class="farg" style="white-space:nowrap;">u_int align_offset</i>, <i class="farg" style="white-space:nowrap;">int flags</i>, <i class="farg" style="white-space:nowrap;">const char *name</i>, <i class="farg" style="white-space:nowrap;">struct pool_allocator *palloc</i>, <i class="farg" style="white-space:nowrap;">int ipl</i>, <i class="farg" style="white-space:nowrap;">int (*ctor)(void *, void *, int)</i>, <i class="farg" style="white-space:nowrap;">void (*dtor)(void *, void *)</i>, <i class="farg" style="white-space:nowrap;">void *arg</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pool_cache_destroy</b>(<i class="farg" style="white-space:nowrap;">pool_cache_t pc</i>);<p>
<i class="ftype">void *</i><br>
<b class="fname">pool_cache_get_paddr</b>(<i class="farg" style="white-space:nowrap;">pool_cache_t pc</i>, <i class="farg" style="white-space:nowrap;">int flags</i>, <i class="farg" style="white-space:nowrap;">paddr_t *pap</i>);<p>
<i class="ftype">void *</i><br>
<b class="fname">pool_cache_get</b>(<i class="farg" style="white-space:nowrap;">pool_cache_t pc</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pool_cache_put_paddr</b>(<i class="farg" style="white-space:nowrap;">pool_cache_t pc</i>, <i class="farg" style="white-space:nowrap;">void *object</i>, <i class="farg" style="white-space:nowrap;">paddr_t pa</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pool_cache_put</b>(<i class="farg" style="white-space:nowrap;">pool_cache_t pc</i>, <i class="farg" style="white-space:nowrap;">void *object</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pool_cache_destruct_object</b>(<i class="farg" style="white-space:nowrap;">pool_cache_t pc</i>, <i class="farg" style="white-space:nowrap;">void *object</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pool_cache_invalidate</b>(<i class="farg" style="white-space:nowrap;">pool_cache_t pc</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pool_cache_sethiwat</b>(<i class="farg" style="white-space:nowrap;">pool_cache_t pc</i>, <i class="farg" style="white-space:nowrap;">int nitems</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pool_cache_setlowat</b>(<i class="farg" style="white-space:nowrap;">pool_cache_t pc</i>, <i class="farg" style="white-space:nowrap;">int nitems</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">pool_cache_sethardlimit</b>(<i class="farg" style="white-space:nowrap;">pool_cache_t pc</i>, <i class="farg" style="white-space:nowrap;">int nitems</i>, <i class="farg" style="white-space:nowrap;">const char *warnmess</i>, <i class="farg" style="white-space:nowrap;">int ratecap</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> These utility routines provide management of pools of fixed-sized areas of memory. Resource pools set aside an amount of memory for exclusive use by the resource pool owner. This can be used by applications to guarantee the availability of a minimum amount of memory needed to continue operation independent of the memory resources currently available from the system-wide memory allocator.<p>
<b class="name">pool_cache</b> follows the <a class="link-man" href="../9/pool">pool(9)</a> API closely and offers routines that are functionally equivalent to their <a class="link-man" href="../9/pool">pool(9)</a> counterparts. In addition, <b class="name">pool_cache</b> provides object management functions used to manipulate objects allocated from the pool. It also maintains global and per-CPU caches, both levels of cache work together to allow for low overhead allocation and release of objects, and improved L1/L2/L3 hardware cache locality in multiprocessor systems.</div>
<div class="section">
<h1 id="x46554e4354494f4e53">FUNCTIONS</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pool_cache_init</b>(<i class="farg">size</i>, <i class="farg">align</i>, <i class="farg">align_offset</i>, <i class="farg">flags</i>, <i class="farg">name</i>, <i class="farg">palloc</i>, <i class="farg">ipl</i>, <i class="farg">ctor</i>, <i class="farg">dtor</i>, <i class="farg">arg</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
Allocate and initialize a pool cache. The arguments are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">size</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Specifies the size of the memory items managed by the pool.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">align</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Specifies the memory address alignment of the items returned by <b class="fname">pool_cache_get</b>(). This argument must be a power of two. If zero, the alignment defaults to an architecture-specific natural alignment.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">align_offset</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
The offset within an item to which the <i class="farg">align</i> parameter applies.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">flags</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Should be set to zero or <span class="define">PR_NOTOUCH</span>. If <span class="define">PR_NOTOUCH</span> is given, free items are never used to keep internal state so that the pool can be used for non memory backed objects.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">name</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
The name used to identify the object in diagnostic output.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">palloc</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Should be typically be set to NULL, instructing <b class="fname">pool_cache_init</b>() to select an appropriate back-end allocator. Alternate allocators can be used to partition space from arbitrary sources. Use of alternate allocators is not documented here as it is not a stable, endorsed part of the API.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">ipl</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Specifies an interrupt priority level that will block all interrupt handlers that could potentially access the pool. The <b class="name">pool_cache</b> facility provides its own synchronization. The users of any given <b class="name">pool_cache</b> need not provide additional synchronization for access to it.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">ctor</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Specifies a constructor used to initialize newly allocated objects. If no constructor is required, specify <span class="define">NULL</span>. The first argument to <i class="farg">ctor</i> is <i class="farg">arg</i>, the second is the new object, and the third is <i class="farg">flags</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">dtor</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
Specifies a destructor used to destroy cached objects prior to their release to backing store. If no destructor is required, specify <span class="define">NULL</span>. The first argument to <i class="farg">dtor</i> is <i class="farg">arg</i>, and the second is the object.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">arg</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
<p>
This value of this argument will be passed to both the constructor and destructor routines.</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pool_cache_destroy</b>(<i class="farg">pc</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
Destroy a pool cache <i class="farg">pc</i>. All other access to the cache must be stopped before this call can be made.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pool_cache_get_paddr</b>(<i class="farg">pc</i>, <i class="farg">flags</i>, <i class="farg">pap</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
Get an object from a pool cache <i class="farg">pc</i>. If <i class="farg">pap</i> is not <span class="define">NULL</span>, physical address of the object or <span class="define">POOL_PADDR_INVALID</span> will be returned via it. <i class="farg">flags</i> will be passed to <b class="fname">pool_get</b>() function of the backing <a class="link-man" href="../9/pool">pool(9)</a> and the object constructor specified when the pool cache is created by <b class="fname">pool_cache_init</b>().</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pool_cache_get</b>(<i class="farg">pc</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
<b class="fname">pool_cache_get</b>() is the same as <b class="fname">pool_cache_get_paddr</b>() with <span class="define">NULL</span> <i class="farg">pap</i> argument. It's implemented as a macro.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pool_cache_put_paddr</b>(<i class="farg">pc</i>, <i class="farg">object</i>, <i class="farg">pa</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
Put an object <i class="farg">object</i> back to the pool cache <i class="farg">pc</i>. <i class="farg">pa</i> should be physical address of the object <i class="farg">object</i> or <span class="define">POOL_PADDR_INVALID</span>. <i class="farg">pp</i>. If the number of available items in the backing pool exceeds the maximum pool size set by <b class="fname">pool_cache_sethiwat</b>() and there are no outstanding requests for pool items, the excess items will be returned to the system.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pool_cache_put</b>(<i class="farg">pc</i>, <i class="farg">object</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
<b class="fname">pool_cache_put</b>() is the same as <b class="fname">pool_cache_put_paddr</b>() with <span class="define">POOL_PADDR_INVALID</span> <i class="farg">pa</i> argument. It's implemented as a macro.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pool_cache_destruct_object</b>(<i class="farg">pc</i>, <i class="farg">object</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
Force destruction of an object <i class="farg">object</i> and release it back into the pool.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pool_cache_invalidate</b>(<i class="farg">pc</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
Invalidate a pool cache <i class="farg">pc</i>. All objects in the cache will be destructed and freed back to the pool backing the cache. For pool caches that vend constructed objects, consumers of this API must take care to provide proper synchronization between the input to the constructor and cache invalidation.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pool_cache_sethiwat</b>(<i class="farg">pc</i>, <i class="farg">nitems</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
A pool will attempt to increase its resource usage to keep up with the demand for its items. Conversely, it will return unused memory to the system should the number of accumulated unused items in the pool exceed a programmable limit. The limits for the minimum and maximum number of items which a pool should keep at hand are known as the high and low <span class="symb">watermarks</span>.<p>
The function <b class="fname">pool_cache_sethiwat</b>() sets the backing pool's high water mark. As items are returned and the total number of pages in the pool is larger than the maximum set by this function, any completely unused pages are released immediately. If this function is not used to specify a maximum number of items, the pages will remain associated with the pool until the system runs low on memory, at which point the VM system will try to reclaim unused pages.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pool_cache_setlowat</b>(<i class="farg">pc</i>, <i class="farg">nitems</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
Set the minimum number of items to keep in the pool. The number pages in the pool will not decrease below the required value to accommodate the minimum number of items specified by this function.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">pool_cache_sethardlimit</b>(<i class="farg">pc</i>, <i class="farg">nitems</i>, <i class="farg">warnmess</i>, <i class="farg">ratecap</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Set the hard limit for the backing <a class="link-man" href="../9/pool">pool(9)</a> to <i class="farg">nitems</i>. When the hard limit is reached, the warning message <i class="farg">warnmess</i> will be logged. <i class="farg">ratecap</i> represents the minimal interval (in seconds) after which another warning message is issued when the pool hits its hard limit again.</dd>
</dl>
</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The <b class="name">pool_cache</b> subsystem is implemented within the file <i class="file">sys/kern/subr_pool.c</i>.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../9/intro">intro(9)</a>, <a class="link-man" href="../9/kmem">kmem(9)</a>, <a class="link-man" href="../9/memoryallocators">memoryallocators(9)</a>, <a class="link-man" href="../9/percpu">percpu(9)</a>, <a class="link-man" href="../9/pool">pool(9)</a></div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
November 15, 2011</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

