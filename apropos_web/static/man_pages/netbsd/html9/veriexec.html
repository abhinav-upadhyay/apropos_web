<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
VERIEXEC(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
VERIEXEC(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
VERIEXEC(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">veriexec</b> &#8212; <span class="desc">in-kernel file integrity subsystem KPI</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/verified_exec.h</a>&gt;</b><p>
<i class="ftype">void</i><br>
<b class="fname">veriexec_init</b>(<i class="farg" style="white-space:nowrap;">void</i>);<p>
<i class="ftype">bool</i><br>
<b class="fname">veriexec_lookup</b>(<i class="farg" style="white-space:nowrap;">struct vnode *vp</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">veriexec_verify</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>, <i class="farg" style="white-space:nowrap;">struct vnode *vp</i>, <i class="farg" style="white-space:nowrap;">const u_char *name</i>, <i class="farg" style="white-space:nowrap;">int flag</i>, <i class="farg" style="white-space:nowrap;">bool *found</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">veriexec_purge</b>(<i class="farg" style="white-space:nowrap;">struct vnode *vp</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">veriexec_fpops_add</b>(<i class="farg" style="white-space:nowrap;">const char *fp_type</i>, <i class="farg" style="white-space:nowrap;">size_t hash_len</i>, <i class="farg" style="white-space:nowrap;">size_t ctx_size</i>, <i class="farg" style="white-space:nowrap;">veriexec_fpop_init_t init</i>, <i class="farg" style="white-space:nowrap;">veriexec_fpop_update_t update</i>, <i class="farg" style="white-space:nowrap;">veriexec_fpop_final_t final</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">veriexec_file_add</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>, <i class="farg" style="white-space:nowrap;">prop_dictionary_t dict</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">veriexec_file_delete</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>, <i class="farg" style="white-space:nowrap;">struct vnode *vp</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">veriexec_table_delete</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>, <i class="farg" style="white-space:nowrap;">struct mount *mp</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">veriexec_flush</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">veriexec_openchk</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>, <i class="farg" style="white-space:nowrap;">struct vnode *vp</i>, <i class="farg" style="white-space:nowrap;">const char *path</i>, <i class="farg" style="white-space:nowrap;">int fmode</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">veriexec_renamechk</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>, <i class="farg" style="white-space:nowrap;">struct vnode *fromvp</i>, <i class="farg" style="white-space:nowrap;">const char *fromname</i>, <i class="farg" style="white-space:nowrap;">struct vnode *tovp</i>, <i class="farg" style="white-space:nowrap;">const char *toname</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">veriexec_removechk</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>, <i class="farg" style="white-space:nowrap;">struct vnode *vp</i>, <i class="farg" style="white-space:nowrap;">const char *name</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">veriexec_unmountchk</b>(<i class="farg" style="white-space:nowrap;">struct mount *mp</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">veriexec_convert</b>(<i class="farg" style="white-space:nowrap;">struct vnode *vp</i>, <i class="farg" style="white-space:nowrap;">prop_dictionary_t rdict</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">veriexec_dump</b>(<i class="farg" style="white-space:nowrap;">struct lwp *l</i>, <i class="farg" style="white-space:nowrap;">prop_array_t rarray</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> <b class="name">veriexec</b> is the KPI for <span class="emph">Veriexec</span>, the <span class="unix">NetBSD</span> in-kernel file integrity subsystem. It is responsible for managing the supported hashing algorithms, fingerprint calculation and comparison, file monitoring tables, and relevant hooks to enforce the <span class="emph">Veriexec</span> policy.</div>
<div class="section">
<h1 id="x46554e4354494f4e53">FUNCTIONS</h1><div class="subsection">
<h2 id="x436f726520526f7574696e6573">Core Routines</h2><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_init</b>(<i class="farg">void</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Initialize the <span class="emph">Veriexec</span> subsystem. Called only once during system startup.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_lookup</b>(<i class="farg">vp</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Check if <i class="arg">vp</i> is monitored by <span class="emph">Veriexec</span>. Returns <span class="define">true</span> if it is, or <span class="define">false</span> otherwise.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_verify</b>(<i class="farg">l</i>, <i class="farg">vp</i>, <i class="farg">name</i>, <i class="farg">flag</i>, <i class="farg">found</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Verifies the digital fingerprint of <i class="arg">vp</i>. <i class="arg">name</i> is the filename, and <i class="arg">flag</i> is the access flag. The access flag can be one of:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">VERIEXEC_DIRECT</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The file was executed directly via <a class="link-man" href="../2/execve">execve(2)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">VERIEXEC_INDIRECT</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The file was executed indirectly, either as an interpreter for a script or mapped to an executable memory region.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">VERIEXEC_FILE</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The file was opened for reading/writing.</dd>
</dl>
<p>
<i class="arg">l</i> is the LWP for the request context.<p>
An optional argument, <i class="arg">found</i>, is a pointer to a boolean indicating whether an entry for the file was found in the <span class="emph">Veriexec</span> tables.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_purge</b>(<i class="farg">vp</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Purge the file entry for <i class="arg">vp</i>. This invalidates the fingerprint so it will be evaluated next time the file is accessed.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x46696e6765727072696e742052656c6174656420526f7574696e6573">Fingerprint Related Routines</h2><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_fpops_add</b>(<i class="farg">fp_type</i>, <i class="farg">hash_len</i>, <i class="farg">ctx_size</i>, <i class="farg">init</i>, <i class="farg">update</i>, <i class="farg">final</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Add support for fingerprinting algorithm <i class="arg">fp_type</i> with binary hash length <i class="arg">hash_len</i> and calculation context size <i class="arg">ctx_size</i> to <span class="emph">Veriexec</span>. <i class="arg">init</i>, <i class="arg">update</i>, and <i class="arg">final</i> are the routines used to initialize, update, and finalize a calculation context.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x5461626c65204d616e6167656d656e7420526f7574696e6573">Table Management Routines</h2><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_file_add</b>(<i class="farg">l</i>, <i class="farg">dict</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Add a <span class="emph">Veriexec</span> entry for the file described by <i class="arg">dict</i>.<p>
<i class="arg">dict</i> is expected to have the following:<table style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-col">
<col style="width: 10.00ex;">
<col style="width: 6.00ex;">
<col style="min-width: 34.00ex;">
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Name</span></td>
<td class="list-col" style="margin-top: 1.00em;">
Type</td>
<td class="list-col" style="margin-top: 1.00em;">
Purpose</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
file</td>
<td class="list-col" style="margin-top: 1.00em;">
string</td>
<td class="list-col" style="margin-top: 1.00em;">
filename</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
entry-type</td>
<td class="list-col" style="margin-top: 1.00em;">
uint8</td>
<td class="list-col" style="margin-top: 1.00em;">
entry type flags (see <a class="link-man" href="../4/veriexec">veriexec(4)</a>)</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
fp-type</td>
<td class="list-col" style="margin-top: 1.00em;">
string</td>
<td class="list-col" style="margin-top: 1.00em;">
fingerprint hashing algorithm</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
fp</td>
<td class="list-col" style="margin-top: 1.00em;">
data</td>
<td class="list-col" style="margin-top: 1.00em;">
the fingerprint</td>
</tr>
</tbody>
</table>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_file_delete</b>(<i class="farg">l</i>, <i class="farg">vp</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Remove <span class="emph">Veriexec</span> entry for <i class="arg">vp</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_table_delete</b>(<i class="farg">l</i>, <i class="farg">mp</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Remove <span class="emph">Veriexec</span> table for mount-point <i class="arg">mp</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_flush</b>(<i class="farg">l</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Delete all <span class="emph">Veriexec</span> tables.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x486f6f6b2048616e646c657273">Hook Handlers</h2><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_openchk</b>(<i class="farg">l</i>, <i class="farg">vp</i>, <i class="farg">path</i>, <i class="farg">fmode</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Called when a file is opened.<p>
<i class="arg">l</i> is the LWP opening the file, <i class="arg">vp</i> is a vnode for the file being opened as returned from <a class="link-man" href="../9/namei">namei(9)</a>. If <span class="define">NULL</span>, the file is being created. <i class="arg">path</i> is the pathname for the file (not necessarily a full path), and <i class="arg">fmode</i> are the mode bits with which the file was opened.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_renamechk</b>(<i class="farg">l</i>, <i class="farg">fromvp</i>, <i class="farg">fromname</i>, <i class="farg">tovp</i>, <i class="farg">toname</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Called when a file is renamed.<p>
<i class="arg">fromvp</i> and <i class="arg">fromname</i> are the vnode and filename of the file being renamed. <i class="arg">tovp</i> and <i class="arg">toname</i> are the vnode and filename of the target file. <i class="arg">l</i> is the LWP renaming the file.<p>
Depending on the strict level, <b class="name">veriexec</b> will either track changes appropriately or prevent the rename.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_removechk</b>(<i class="farg">l</i>, <i class="farg">vp</i>, <i class="farg">name</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Called when a file is removed.<p>
<i class="arg">vp</i> is the vnode of the file being removed, and <i class="arg">name</i> is the filename. <i class="arg">l</i> is the LWP removing the file,<p>
Depending on the strict level, <b class="name">veriexec</b> will either clean-up after the file or prevent its removal.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_unmountchk</b>(<i class="farg">mp</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Checks if the current strict level allows <i class="arg">mp</i> to be unmounted.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x4d697363656c6c616e656f757320526f7574696e6573">Miscellaneous Routines</h2><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_convert</b>(<i class="farg">vp</i>, <i class="farg">rdict</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Convert <span class="emph">Veriexec</span> entry for <i class="arg">vp</i> to human-readable <a class="link-man" href="../3/proplib">proplib(3)</a> dictionary, <i class="arg">rdict</i>, with the following elements:<table style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-col">
<col style="width: 10.00ex;">
<col style="min-width: 6.00ex;">
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Name</span></td>
<td class="list-col" style="margin-top: 1.00em;">
Type</td>
<td class="list-col" style="margin-top: 1.00em;">
Purpose</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
entry-type</td>
<td class="list-col" style="margin-top: 1.00em;">
uint8</td>
<td class="list-col" style="margin-top: 1.00em;">
entry type flags (see <a class="link-man" href="../4/veriexec">veriexec(4)</a>)</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
status</td>
<td class="list-col" style="margin-top: 1.00em;">
uint8</td>
<td class="list-col" style="margin-top: 1.00em;">
entry status (see below)</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
fp-type</td>
<td class="list-col" style="margin-top: 1.00em;">
string</td>
<td class="list-col" style="margin-top: 1.00em;">
fingerprint hashing algorithm</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
fp</td>
<td class="list-col" style="margin-top: 1.00em;">
data</td>
<td class="list-col" style="margin-top: 1.00em;">
the fingerprint</td>
</tr>
</tbody>
</table>
<p>
The &#8220;status&#8221; can be one of the following:<table style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-col">
<col style="width: 20.00ex;">
<col style="min-width: 6.00ex;">
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Status</span></td>
<td class="list-col" style="margin-top: 1.00em;">
Meaning</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
FINGERPRINT_NOTEVAL</td>
<td class="list-col" style="margin-top: 1.00em;">
not evaluated</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
FINGERPRINT_VALID</td>
<td class="list-col" style="margin-top: 1.00em;">
fingerprint match</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
FINGERPRINT_MISMATCH</td>
<td class="list-col" style="margin-top: 1.00em;">
fingerprint mismatch</td>
</tr>
</tbody>
</table>
<p>
If no entry was found, <span class="errno">ENOENT</span> is returned. Otherwise, zero.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">veriexec_dump</b>(<i class="farg">l</i>, <i class="farg">rarray</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Fill <i class="arg">rarray</i> with entries for all files monitored by <span class="emph">Veriexec</span> that have a filename associated with them.<p>
Each element in <i class="arg">rarray</i> is a dictionary with the same elements as filled by <b class="fname">veriexec_convert</b>(), with an additional field, &#8220;file&#8221;, containing the filename.</dd>
</dl>
</div>
</div>
<div class="section">
<h1 id="x46494c4553">FILES</h1><table style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-col">
<col style="width: 32.00ex;">
<col style="min-width: 3.00ex;">
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Path</span></td>
<td class="list-col" style="margin-top: 1.00em;">
Purpose</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
src/sys/dev/verified_exec.c</td>
<td class="list-col" style="margin-top: 1.00em;">
driver for userland communication</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
src/sys/sys/verified_exec.h</td>
<td class="list-col" style="margin-top: 1.00em;">
shared (userland/kernel) header file</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
src/sys/kern/kern_veriexec.c</td>
<td class="list-col" style="margin-top: 1.00em;">
subsystem code</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
src/sys/kern/vfs_syscalls.c</td>
<td class="list-col" style="margin-top: 1.00em;">
rename, remove, and unmount policies</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
src/sys/kern/vfs_vnops.c</td>
<td class="list-col" style="margin-top: 1.00em;">
regular file access policy</td>
</tr>
</tbody>
</table>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../3/proplib">proplib(3)</a>, <a class="link-man" href="../3/sysctl">sysctl(3)</a>, <a class="link-man" href="../4/veriexec">veriexec(4)</a>, <a class="link-man" href="../7/security">security(7)</a>, <a class="link-man" href="../8/sysctl">sysctl(8)</a>, <a class="link-man" href="../8/veriexecctl">veriexecctl(8)</a>, <a class="link-man" href="../8/veriexecgen">veriexecgen(8)</a>, <a class="link-man" href="../9/fileassoc">fileassoc(9)</a></div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> <span class="author">Brett Lymn</span> &#60;<a class="link-mail" href="mailto:blymn@NetBSD.org">blymn@NetBSD.org</a>&#62; <span class="author">Elad Efrat</span> &#60;<a class="link-mail" href="mailto:elad@NetBSD.org">elad@NetBSD.org</a>&#62;</div>
<div class="section">
<h1 id="x43415645415453">CAVEATS</h1> There are two known issues with <span class="emph">Veriexec</span> that should be considered when using it.<div class="subsection">
<h2 id="x52656d6f74652046696c651e73797374656d73">Remote File-systems</h2> There is an issue providing protection for files residing on mounts from remote hosts. Because access to the file-system does not necessarily go through <b class="name">veriexec</b>, there is no way to track on-disk changes. While it is possible to minimize the effect by evaluating the file's fingerprint on each access without caching the result, a problem arises when a file is overwritten after its fingerprint has been evaluated and it is running on the local host.<p>
An attacker could potentially overwrite the file contents in the remote host at that point, and force a flush on the local host, resulting in paging in of the files from the disk, introducing malicious code into a supposedly safe address space.<p>
There is a fix for this issue, however due to dependencies on other work that is still in progress it has not been committed yet.</div>
<div class="subsection">
<h2 id="x4c6179657265642046696c651e73797374656d73">Layered File-systems</h2> Due to VFS limitations, <b class="name">veriexec</b> cannot track the same on-disk file across multiple layers of overlay file-systems. Therefore, you cannot expect changes to files on overlay mounts will be detected simply because the underlying mount is monitored by <b class="name">veriexec</b>.<p>
A workaround for this issue is listing all files, under all mounts, you want monitored in the signature file.</div>
</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
February 13, 2015</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

