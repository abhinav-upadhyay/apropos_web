<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
CPRNG(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
CPRNG(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
CPRNG(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">cprng</b>, <b class="name">cprng_strong_create</b>, <b class="name">cprng_strong_destroy</b>, <b class="name">cprng_strong</b>, <b class="name">cprng_strong32</b>, <b class="name">cprng_strong64</b>, <b class="name">cprng_fast</b>, <b class="name">cprng_fast32</b>, <b class="name">cprng_fast64</b>, &#8212; <span class="desc">cryptographic pseudorandom number generators</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/cprng.h</a>&gt;</b><p>
<i class="ftype">cprng_strong_t *</i><br>
<b class="fname">cprng_strong_create</b>(<i class="farg" style="white-space:nowrap;">const char *name</i>, <i class="farg" style="white-space:nowrap;">int ipl</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">cprng_strong_destroy</b>(<i class="farg" style="white-space:nowrap;">cprng_strong_t *cprng</i>);<p>
<i class="ftype">size_t</i><br>
<b class="fname">cprng_strong</b>(<i class="farg" style="white-space:nowrap;">cprng_strong_t *cprng</i>, <i class="farg" style="white-space:nowrap;">void *buf</i>, <i class="farg" style="white-space:nowrap;">size_t len</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<p>
<i class="ftype">uint32_t</i><br>
<b class="fname">cprng_strong32</b>(<i class="farg" style="white-space:nowrap;">void</i>);<p>
<i class="ftype">uint64_t</i><br>
<b class="fname">cprng_strong64</b>(<i class="farg" style="white-space:nowrap;">void</i>);<p>
<i class="ftype">size_t</i><br>
<b class="fname">cprng_fast</b>(<i class="farg" style="white-space:nowrap;">void *buf</i>, <i class="farg" style="white-space:nowrap;">size_t len</i>);<p>
<i class="ftype">uint32_t</i><br>
<b class="fname">cprng_fast32</b>(<i class="farg" style="white-space:nowrap;">void</i>);<p>
<i class="ftype">uint32_t</i><br>
<b class="fname">cprng_fast64</b>(<i class="farg" style="white-space:nowrap;">void</i>);<p>
<pre style="margin-left: 0.00ex;" class="lit display">
#define CPRNG_MAX_LEN   524288</pre>
</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">cprng</b> family of functions provide cryptographic pseudorandom number generators automatically seeded from the kernel entropy pool. All applications in the kernel requiring random data or random choices should use the <b class="name">cprng_strong</b> family of functions, unless performance constraints demand otherwise.<p>
The <b class="name">cprng_fast</b> family of functions may be used in applications that can tolerate exposure of past random data, such as initialization vectors or transaction ids that are sent over the internet anyway, if the applications require higher throughput or lower per-request latency than the <b class="name">cprng_strong</b> family of functions provide. If in doubt, choose <b class="name">cprng_strong</b>.<p>
A single instance of the fast generator serves the entire kernel. A well-known instance of the strong generator, <span class="define">kern_cprng</span>, may be used by any in-kernel caller, but separately seeded instances of the strong generator can also be created by calling <b class="fname">cprng_strong_create</b>().<p>
The <b class="name">cprng</b> functions may be used at interrupt priority level <span class="define">IPL_VM</span> or below, except for <b class="fname">cprng_strong_create</b>() and <b class="fname">cprng_strong_destroy</b>() which are allowed only at <span class="define">IPL_NONE</span>; see <a class="link-man" href="../9/spl">spl(9)</a>.<p>
The <b class="name">cprng</b> functions replace the legacy <a class="link-man" href="../9/arc4random">arc4random(9)</a> and <a class="link-man" href="../9/rnd_extract_data">rnd_extract_data(9)</a> functions.</div>
<div class="section">
<h1 id="x46554e4354494f4e53">FUNCTIONS</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cprng_strong_create</b>(<i class="farg">name</i>, <i class="farg">ipl</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Create an instance of the cprng_strong generator. This generator currently implements the NIST SP 800-90A CTR_DRBG with AES-128 as the block transform.<p>
The <i class="farg">name</i> argument is used to &#8220;personalize&#8221; the CTR_DRBG according to the standard, so that its initial state will depend both on seed material from the entropy pool and also on the personalization string (name).<p>
The <i class="farg">ipl</i> argument specifies the interrupt priority level for the mutex which will serialize access to the new instance of the generator (see <a class="link-man" href="../9/spl">spl(9)</a>), and must be no higher than <span class="define">IPL_VM</span>.<p>
The <i class="farg">flags</i> argument controls the behavior of the generator:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CPRNG_INIT_ANY</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Suppress a warning message to the console if, during <b class="fname">cprng_strong_create</b>(), only partial entropy for the generator is available from the entropy pool.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CPRNG_REKEY_ANY</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Suppress a warning message to the console if, during <b class="fname">cprng_strong</b>() after the generator has been exhausted and must be reseeded, only partial entropy for the generator is available from the entropy pool.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CPRNG_USE_CV</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Make <b class="fname">cprng_strong</b>() sleep if the generator has not been seeded with full entropy until full entropy is available. Otherwise, <b class="fname">cprng_strong</b>() will never sleep when passed this generator.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CPRNG_HARD</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Limit the number of bits of output from the generator before reseeding to the number of bits in its seed, so that it approximates the information-theoretic entropy of its seed. Otherwise, the generator may provide many more bits of output than it was seeded with.</dd>
</dl>
<p>
Creation will succeed even if full entropy for the generator is not available. In this case, the first request to read from the generator may cause reseeding.<p>
<b class="fname">cprng_strong_create</b>() may sleep to allocate memory.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cprng_strong_destroy</b>(<i class="farg">cprng</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Destroy <i class="farg">cprng</i>.<p>
<b class="fname">cprng_strong_destroy</b>() may sleep.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cprng_strong</b>(<i class="farg">cprng</i>, <i class="farg">buf</i>, <i class="farg">len</i>, <i class="farg">flags</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Fill memory location <i class="farg">buf</i> with up to <i class="farg">len</i> bytes from the generator <i class="farg">cprng</i>, and return the number of bytes. <i class="farg">len</i> must be at most <span class="define">CPRNG_MAX_LEN</span>.<p>
If <i class="farg">cprng</i> was created with the <span class="define">CPRNG_USE_CV</span> flag and has been exhausted, then <b class="fname">cprng_strong</b>() may sleep until full entropy can be obtained from the entropy pool to reseed it. However, if <i class="farg">flags</i> includes the <span class="define">FNONBLOCK</span> flag, then <b class="fname">cprng_strong</b>() will immediately return zero in this case instead.<p>
If <i class="farg">cprng</i> was created with the <span class="define">CPRNG_HARD</span> flag, then <b class="fname">cprng_strong</b>() will return at most as many bytes as are left from its seed size since the last reseeding.<p>
If <i class="farg">cprng</i> was created with neither the <span class="define">CPRNG_USE_CV</span> flag nor the <span class="define">CPRNG_HARD</span> flag, then <b class="fname">cprng_strong</b>() is guaranteed to return as many bytes as requested, up to <span class="define">CPRNG_MAX_LEN</span>, without sleeping.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cprng_strong32</b>()</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Generate 32 bits using the <span class="define">kern_cprng</span> strong generator.<p>
<b class="fname">cprng_strong32</b>() does not sleep.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cprng_strong64</b>()</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Generate 64 bits using the <span class="define">kern_cprng</span> strong generator.<p>
<b class="fname">cprng_strong64</b>() does not sleep.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cprng_fast</b>(<i class="farg">buf</i>, <i class="farg">len</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Fill memory location <i class="farg">buf</i> with <i class="farg">len</i> bytes from the fast generator.<p>
<b class="fname">cprng_fast</b>() does not sleep.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cprng_fast32</b>()</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Generate 32 bits using the fast generator.<p>
<b class="fname">cprng_fast32</b>() does not sleep.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">cprng_fast64</b>()</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Generate 64 bits using the fast generator.<p>
<b class="fname">cprng_fast64</b>() does not sleep.</dd>
</dl>
</div>
<div class="section">
<h1 id="x5345435552495459204d4f44454c">SECURITY MODEL</h1> The <b class="name">cprng</b> family of functions provide the following security properties:<ul style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 4.00ex;" class="list list-bul">
<li class="list-bul" style="margin-top: 1.00em;">
An attacker who has seen some outputs of any of the <b class="name">cprng</b> functions cannot predict past or future unseen outputs.</li>
<li class="list-bul" style="margin-top: 1.00em;">
An attacker who has compromised kernel memory cannot predict past outputs of the <b class="name">cprng_strong</b> functions. However, such an attacker may be able to predict past outputs of the <b class="name">cprng_fast</b> functions.</li>
</ul>
<p>
The second property is sometimes called &#8220;backtracking resistance&#8221;, &#8220;forward secrecy&#8221;, or &#8220;key erasure&#8221; in the cryptography literature. The <b class="name">cprng_strong</b> functions provide backtracking resistance; the <b class="name">cprng_fast</b> functions do not.</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The <b class="name">cprng_strong</b> functions are implemented in <i class="file">sys/kern/subr_cprng.c</i>, and use the NIST SP 800-90A CTR_DRBG implementation in <i class="file">sys/crypto/nist_ctr_drbg</i>. The <b class="name">cprng_fast</b> functions are implemented in <i class="file">sys/crypto/cprng_fast/cprng_fast.c</i>, and use the ChaCha8 stream cipher.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../9/condvar">condvar(9)</a>, <a class="link-man" href="../9/rnd">rnd(9)</a>, <a class="link-man" href="../9/spl">spl(9)</a><p>
<span class="ref"><span class="ref-auth">Elaine Barker</span> and <span class="ref-auth">John Kelsey</span>, <span class="ref-title">Recommendation for Random Number Generation Using Deterministic Random Bit Generators (Revised)</span>, <i class="ref-issue">National Institute of Standards and Technology</i>, <span class="ref-date">2011</span>, <span class="ref-opt">NIST Special Publication 800-90A, Rev 1</span>.</span><p>
<span class="ref"><span class="ref-auth">Daniel J. Bernstein</span>, <span class="ref-title">ChaCha, a variant of Salsa20</span>, <a class="link-ref" href="http://cr.yp.to/papers#chacha">http://cr.yp.to/papers#chacha</a>, <span class="ref-date">2008-01-28</span>, <span class="ref-opt">Document ID: 4027b5256e17b9796842e6d0f68b0b5e</span>.</span></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The cprng family of functions first appeared in <span class="unix">NetBSD&#160;6.0</span>.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
February 19, 2015</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

