<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
SOCKOPT(9)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
SOCKOPT(9)</td>
<td class="head-vol" align="center">
Kernel Developer's Manual</td>
<td class="head-rtitle" align="right">
SOCKOPT(9)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">sockopt_init</b>, <b class="name">sockopt_destroy</b>, <b class="name">sockopt_get</b>, <b class="name">sockopt_getint</b> <b class="name">sockopt_set</b>, <b class="name">sockopt_setint</b>, &#8212; <span class="desc">socket options handling</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/socketvar.h</a>&gt;</b><p>
<i class="ftype">void</i><br>
<b class="fname">sockopt_init</b>(<i class="farg" style="white-space:nowrap;">struct sockopt *sopt</i>, <i class="farg" style="white-space:nowrap;">int level</i>, <i class="farg" style="white-space:nowrap;">int name</i>, <i class="farg" style="white-space:nowrap;">size_t size</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">sockopt_destroy</b>(<i class="farg" style="white-space:nowrap;">struct sockopt *sopt</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">sockopt_get</b>(<i class="farg" style="white-space:nowrap;">struct sockopt *sopt</i>, <i class="farg" style="white-space:nowrap;">void *value</i>, <i class="farg" style="white-space:nowrap;">size_t size</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">sockopt_getint</b>(<i class="farg" style="white-space:nowrap;">struct sockopt *sopt</i>, <i class="farg" style="white-space:nowrap;">int *value</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">sockopt_set</b>(<i class="farg" style="white-space:nowrap;">struct sockopt *sopt</i>, <i class="farg" style="white-space:nowrap;">const void *value</i>, <i class="farg" style="white-space:nowrap;">size_t size</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">sockopt_setint</b>(<i class="farg" style="white-space:nowrap;">struct sockopt *sopt</i>, <i class="farg" style="white-space:nowrap;">int value</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <i class="ftype">sockopt</i> structure is used to pass a socket option and associated value:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
struct sockopt { 
	int		sopt_level;		/* option level */ 
	int		sopt_name;		/* option name */ 
	size_t		sopt_size;		/* data length */ 
	void *		sopt_data;		/* data pointer */ 
	uint8_t		sopt_buf[sizeof(int)];	/* internal storage */ 
};</pre>
<p>
The internal storage is used for the common case of values up to integer size so that memory allocation is not required and sopt_data will point to this in that case.<p>
Rather than provide accessor functions, the <i class="ftype">sockopt</i> structure is public and the contents are expected to be internally consistent, but the normal practice would be to use the appropriate methods for storage and retrieval of values where a known datatype is expected, as the size will be verified.<p>
Note: a sockopt structure may only be used for a single level/name/size combination. If the structure is to be re-used, it must be destroyed and re-initialized with the new values.</div>
<div class="section">
<h1 id="x4f5054494f4e53">OPTIONS</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="config">options DIAGNOSTIC</b></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Kernels compiled with the <span class="define">DIAGNOSTIC</span> option will perform basic sanity checks on socket options operations.</dd>
</dl>
</div>
<div class="section">
<h1 id="x46554e4354494f4e53">FUNCTIONS</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">sockopt_init</b>(<i class="farg">sopt</i>, <i class="farg">level</i>, <i class="farg">name</i>, <i class="farg">size</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Initialise sockopt storage. If <i class="arg">size</i> is given, <b class="fname">sockopt_init</b>() will arrange for sopt_data to point to a buffer of <i class="arg">size</i> bytes for the sockopt value. Where memory needs to be allocated to satisfy this, <b class="fname">sockopt_init</b>() may sleep.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">sockopt_destroy</b>(<i class="farg">sopt</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Destroy sockopt storage, releasing any allocated memory.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">sockopt_get</b>(<i class="farg">sopt</i>, <i class="farg">value</i>, <i class="farg">size</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Copy out sockopt value. Will return <span class="errno">EINVAL</span> if an incorrect data size is given.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">sockopt_getint</b>(<i class="farg">sopt</i>, <i class="farg">value</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Common case of get sockopt integer value. Will return <span class="errno">EINVAL</span> if sockopt does not contain an integer sized value.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">sockopt_set</b>(<i class="farg">sopt</i>, <i class="farg">value</i>, <i class="farg">size</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Copy in sockopt value. The sockopt structure must contain a data field of <i class="arg">size</i> bytes or be previously unset, in which case a data buffer may be allocated using <a class="link-man" href="../9/kmem_alloc">kmem_alloc(9)</a> with the <span class="define">KM_NOSLEEP</span> flag which may cause <b class="fname">sockopt_set</b>() to return <span class="errno">ENOMEM</span>.<p>
Note: If you need to use <b class="fname">sockopt_set</b>() in a context where memory allocation may be required and you do not wish to contemplate failure, the sockopt structure can be initialised in a more suitable context using <b class="fname">sockopt_init</b>() which will not fail.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">sockopt_setint</b>(<i class="farg">sopt</i>, <i class="farg">value</i>)</dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Common case of set sockopt integer value. The sockpt structure must contain an int sized data field or be previously unset, in which case the data pointer will be set to the internal storage.</dd>
</dl>
</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The function prototypes and sockopt structure are defined in the <i class="file">sys/sys/socketvar.h</i> header file, and the socket options implementation is in <i class="file">sys/kern/uipc_socket.c</i>.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../2/errno">errno(2)</a>, <a class="link-man" href="../9/kmem">kmem(9)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The socket options KPI was inspired by a similar KPI in <span class="unix">FreeBSD</span> and first appeared in <span class="unix">NetBSD&#160;5.0</span>.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
September 4, 2009</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

