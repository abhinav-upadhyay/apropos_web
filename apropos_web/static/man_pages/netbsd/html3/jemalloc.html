<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
JEMALLOC(3)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
JEMALLOC(3)</td>
<td class="head-vol" align="center">
Library Functions Manual</td>
<td class="head-rtitle" align="right">
JEMALLOC(3)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">jemalloc</b> &#8212; <span class="desc">the default system allocator</span></div>
<div class="section">
<h1 id="x4c494252415259">LIBRARY</h1> <span class="lib">Standard C Library (libc, &#45;lc)</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <i class="ftype">const char *</i> <b class="var">_malloc_options</b>;</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">jemalloc</b> is a general-purpose concurrent <a class="link-man" href="../3/malloc">malloc(3)</a> implementation specifically designed to be scalable on modern multi-processor systems. It is the default user space system allocator in <span class="unix">NetBSD</span>.<p>
When the first call is made to one of the memory allocation routines such as <b class="fname">malloc</b>() or <b class="fname">realloc</b>(), various flags that affect the workings of the allocator are set or reset. These are described below.<p>
The &#8220;name&#8221; of the file referenced by the symbolic link named <i class="file">/etc/malloc.conf</i>, the value of the environment variable <span class="env">MALLOC_OPTIONS</span>, and the string pointed to by the global variable <b class="var">_malloc_options</b> will be interpreted, in that order, character by character as flags.<p>
Most flags are single letters. Uppercase letters indicate that the behavior is set, or on, and lowercase letters mean that the behavior is not set, or off. The following options are available.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 3.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="emph">A</span></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
All warnings (except for the warning about unknown flags being set) become fatal. The process will call <a class="link-man" href="../3/abort">abort(3)</a> in these cases.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="emph">H</span></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Use <a class="link-man" href="../2/madvise">madvise(2)</a> when pages within a chunk are no longer in use, but the chunk as a whole cannot yet be deallocated. This is primarily of use when swapping is a real possibility, due to the high overhead of the <b class="fname">madvise</b>() system call.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="emph">J</span></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Each byte of new memory allocated by <b class="fname">malloc</b>(), <b class="fname">realloc</b>() will be initialized to 0xa5. All memory returned by <b class="fname">free</b>(), <b class="fname">realloc</b>() will be initialized to 0x5a. This is intended for debugging and will impact performance negatively.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="emph">K</span></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Increase/decrease the virtual memory chunk size by a factor of two. The default chunk size is 1 MB. This option can be specified multiple times.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="emph">N</span></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Increase/decrease the number of arenas by a factor of two. The default number of arenas is four times the number of CPUs, or one if there is a single CPU. This option can be specified multiple times.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="emph">P</span></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Various statistics are printed at program exit via an <a class="link-man" href="../3/atexit">atexit(3)</a> function. This has the potential to cause deadlock for a multi-threaded process that exits while one or more threads are executing in the memory allocation functions. Therefore, this option should only be used with care; it is primarily intended as a performance tuning aid during application development.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="emph">Q</span></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Increase/decrease the size of the allocation quantum by a factor of two. The default quantum is the minimum allowed by the architecture (typically 8 or 16 bytes). This option can be specified multiple times.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="emph">S</span></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Increase/decrease the size of the maximum size class that is a multiple of the quantum by a factor of two. Above this size, power-of-two spacing is used for size classes. The default value is 512 bytes. This option can be specified multiple times.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="emph">U</span></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Generate &#8220;utrace&#8221; entries for <a class="link-man" href="../1/ktrace">ktrace(1)</a>, for all operations. Consult the source for details on this option.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="emph">V</span></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Attempting to allocate zero bytes will return a <span class="define">NULL</span> pointer instead of a valid pointer. (The default behavior is to make a minimal allocation and return a pointer to it.) This option is provided for System V compatibility. This option is incompatible with the <span class="emph">X</span> option.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="emph">X</span></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Rather than return failure for any allocation function, display a diagnostic message on <span class="define">stderr</span> and cause the program to drop core (using <a class="link-man" href="../3/abort">abort(3)</a>). This option should be set at compile time by including the following in the source code:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
_malloc_options = "X";</pre>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="emph">Z</span></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
Each byte of new memory allocated by <b class="fname">malloc</b>(), <b class="fname">realloc</b>() will be initialized to 0. Note that this initialization only happens once for each byte, so <b class="fname">realloc</b>() does not zero memory that was previously allocated. This is intended for debugging and will impact performance negatively.</dd>
</dl>
<p>
Extra care should be taken when enabling any of the options in production environments. The <span class="emph">A</span>, <span class="emph">J</span>, and <span class="emph">Z</span> options are intended for testing and debugging. An application which changes its behavior when these options are used is flawed.</div>
<div class="section">
<h1 id="x494d504c454d454e544154494f4e204e4f544553">IMPLEMENTATION NOTES</h1> The <b class="name">jemalloc</b> allocator uses multiple arenas in order to reduce lock contention for threaded programs on multi-processor systems. This works well with regard to threading scalability, but incurs some costs. There is a small fixed per-arena overhead, and additionally, arenas manage memory completely independently of each other, which means a small fixed increase in overall memory fragmentation. These overheads are not generally an issue, given the number of arenas normally used. Note that using substantially more arenas than the default is not likely to improve performance, mainly due to reduced cache performance. However, it may make sense to reduce the number of arenas if an application does not make much use of the allocation functions.<p>
Memory is conceptually broken into equal-sized chunks, where the chunk size is a power of two that is greater than the page size. Chunks are always aligned to multiples of the chunk size. This alignment makes it possible to find metadata for user objects very quickly.<p>
User objects are broken into three categories according to size:<ol style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 3.00ex;" class="list list-enum">
<li class="list-enum" style="margin-top: 1.00em;">
Small objects are smaller than one page.</li>
<li class="list-enum" style="margin-top: 1.00em;">
Large objects are smaller than the chunk size.</li>
<li class="list-enum" style="margin-top: 1.00em;">
Huge objects are a multiple of the chunk size.</li>
</ol>
<p>
Small and large objects are managed by arenas; huge objects are managed separately in a single data structure that is shared by all threads. Huge objects are used by applications infrequently enough that this single data structure is not a scalability issue.<p>
Each chunk that is managed by an arena tracks its contents in a page map as runs of contiguous pages (unused, backing a set of small objects, or backing one large object). The combination of chunk alignment and chunk page maps makes it possible to determine all metadata regarding small and large allocations in constant time.<p>
Small objects are managed in groups by page runs. Each run maintains a bitmap that tracks which regions are in use. Allocation requests can be grouped as follows.<ul style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 3.00ex;" class="list list-bul">
<li class="list-bul" style="margin-top: 1.00em;">
Allocation requests that are no more than half the quantum (see the <span class="emph">Q</span> option) are rounded up to the nearest power of two (typically 2, 4, or 8).</li>
<li class="list-bul" style="margin-top: 1.00em;">
Allocation requests that are more than half the quantum, but no more than the maximum quantum-multiple size class (see the <span class="emph">S</span> option) are rounded up to the nearest multiple of the quantum.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Allocation requests that are larger than the maximum quantum-multiple size class, but no larger than one half of a page, are rounded up to the nearest power of two.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Allocation requests that are larger than half of a page, but small enough to fit in an arena-managed chunk (see the <span class="emph">K</span> option), are rounded up to the nearest run size.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Allocation requests that are too large to fit in an arena-managed chunk are rounded up to the nearest multiple of the chunk size.</li>
</ul>
<p>
Allocations are packed tightly together, which can be an issue for multi-threaded applications. If you need to assure that allocations do not suffer from cache line sharing, round your allocation requests up to the nearest multiple of the cache line size.</div>
<div class="section">
<h1 id="x444542554747494e47">DEBUGGING</h1> The first thing to do is to set the <span class="emph">A</span> option. This option forces a coredump (if possible) at the first sign of trouble, rather than the normal policy of trying to continue if at all possible.<p>
It is probably also a good idea to recompile the program with suitable options and symbols for debugger support.<p>
If the program starts to give unusual results, coredump or generally behave differently without emitting any of the messages mentioned in the next section, it is likely because it depends on the storage being filled with zero bytes. Try running it with the <span class="emph">Z</span> option set; if that improves the situation, this diagnosis has been confirmed. If the program still misbehaves, the likely problem is accessing memory outside the allocated area.<p>
Alternatively, if the symptoms are not easy to reproduce, setting the <span class="emph">J</span> option may help provoke the problem. In truly difficult cases, the <span class="emph">U</span> option, if supported by the kernel, can provide a detailed trace of all calls made to these functions.<p>
Unfortunately, <b class="name">jemalloc</b> does not provide much detail about the problems it detects; the performance impact for storing such information would be prohibitive. There are a number of allocator implementations available on the Internet which focus on detecting and pinpointing problems by trading performance for extra sanity checks and detailed diagnostics.</div>
<div class="section">
<h1 id="x454e5649524f4e4d454e54">ENVIRONMENT</h1> The following environment variables affect the execution of the allocation functions:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="env">MALLOC_OPTIONS</span></dt>
<dd class="list-tag" style="margin-left: 18.00ex;">
If the environment variable <span class="env">MALLOC_OPTIONS</span> is set, the characters it contains will be interpreted as flags to the allocation functions.</dd>
</dl>
</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> To dump core whenever a problem occurs:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
ln -s 'A' /etc/malloc.conf</pre>
<p>
To specify in the source that a program does no return value checking on calls to these functions:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
_malloc_options = "X";</pre>
</div>
<div class="section">
<h1 id="x444941474e4f5354494353">DIAGNOSTICS</h1> If any of the memory allocation/deallocation functions detect an error or warning condition, a message will be printed to file descriptor <span class="define">STDERR_FILENO</span>. Errors will result in the process dumping core. If the <span class="emph">A</span> option is set, all warnings are treated as errors.<p>
The <b class="var">_malloc_message</b> variable allows the programmer to override the function which emits the text strings forming the errors and warnings if for some reason the <span class="define">stderr</span> file descriptor is not suitable for this. Please note that doing anything which tries to allocate memory in this function is likely to result in a crash or deadlock.<p>
All messages are prefixed by &#8220;&#60;<i class="arg">progname</i>&#62;<code class="lit">:</code> (malloc)&#8221;.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../3/emalloc">emalloc(3)</a>, <a class="link-man" href="../3/malloc">malloc(3)</a>, <a class="link-man" href="../3/memory">memory(3)</a>, <a class="link-man" href="../9/memoryallocators">memoryallocators(9)</a><p>
<span class="ref"><span class="ref-auth">Jason Evans</span>, <span class="ref-title">A Scalable Concurrent malloc(3) Implementation for FreeBSD</span>, <a class="link-ref" href="http://people.freebsd.org/~jasone/jemalloc/bsdcan2006/jemalloc.pdf">http://people.freebsd.org/~jasone/jemalloc/bsdcan2006/jemalloc.pdf</a>, <span class="ref-date">April 16, 2006</span>, <span class="ref-opt">BSDCan 2006</span>.</span><p>
<span class="ref"><span class="ref-auth">Poul-Henning Kamp</span>, <span class="ref-title">Malloc(3) revisited</span>, <i class="ref-book">Proceedings of the FREENIX Track: 1998 USENIX Annual Technical Conference</i>, <i class="ref-issue">USENIX Association</i>, <a class="link-ref" href="http://www.usenix.org/publications/library/proceedings/usenix98/freenix/kamp.pdf">http://www.usenix.org/publications/library/proceedings/usenix98/freenix/kamp.pdf</a>, <span class="ref-date">June 15-19, 1998</span>.</span><p>
<span class="ref"><span class="ref-auth">Paul R. Wilson</span>, <span class="ref-auth">Mark S. Johnstone</span>, <span class="ref-auth">Michael Neely</span>, and <span class="ref-auth">David Boles</span>, <span class="ref-title">Dynamic Storage Allocation: A Survey and Critical Review</span>, <i class="ref-issue">University of Texas at Austin</i>, <a class="link-ref" href="ftp://ftp.cs.utexas.edu/pub/garbage/allocsrv.ps">ftp://ftp.cs.utexas.edu/pub/garbage/allocsrv.ps</a>, <span class="ref-date">1995</span>.</span></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">jemalloc</b> allocator became the default system allocator first in <span class="unix">FreeBSD&#160;7.0</span> and then in <span class="unix">NetBSD&#160;5.0</span>. In both systems it replaced the older so-called &#8220;phkmalloc&#8221; implementation.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> <span class="author">Jason Evans</span> &#60;<a class="link-mail" href="mailto:jasone@canonware.com">jasone@canonware.com</a>&#62;</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
June 21, 2011</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

