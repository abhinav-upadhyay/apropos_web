<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/../4/strict.dtd">
>
<head>
<meta http-equiv="Content-Type" content="te../; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
PIDLOCK(3)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
PIDLOCK(3)</td>
<td class="head-vol" align="center">
Library Functions Manual</td>
<td class="head-rtitle" align="right">
PIDLOCK(3)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">pidlock</b>, <b class="name">ttylock</b>, <b class="name">ttyunlock</b> &#8212; <span class="desc">locks based on files containing PIDs</span></div>
<div class="section">
<h1 id="x4c494252415259">LIBRARY</h1> <span class="lib">System Utilities Library (libutil, &#45;lutil)</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">util.h</a>&gt;</b><p>
<i class="ftype">int</i><br>
<b class="fname">pidlock</b>(<i class="farg" style="white-space:nowrap;">const char *lockfile</i>, <i class="farg" style="white-space:nowrap;">int flags</i>, <i class="farg" style="white-space:nowrap;">pid_t *locker</i>, <i class="farg" style="white-space:nowrap;">const char *info</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">ttylock</b>(<i class="farg" style="white-space:nowrap;">const char *tty</i>, <i class="farg" style="white-space:nowrap;">int flags</i>, <i class="farg" style="white-space:nowrap;">pid_t *locker</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">ttyunlock</b>(<i class="farg" style="white-space:nowrap;">const char *tty</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="fname">pidlock</b>() <b class="fname">ttylock</b>(), and <b class="fname">ttyunlock</b>() functions attempt to create a lockfile for an arbitrary resource that only one program may hold at a time. (In the case of <b class="fname">ttylock</b>(), this is access to a tty device.) If the function succeeds in creating the lockfile, it will succeed for no other program calling it with the same lockfile until the original calling program has removed the lockfile or exited. The <b class="fname">ttyunlock</b>() function will remove the lockfile created by <b class="fname">ttylock</b>().<p>
These functions use the method of creating a lockfile traditionally used by UUCP software. This is described as follows in the documentation for Taylor UUCP:<p>
<div style="margin-left: 5.00ex;" class="display">
The lock file normally contains the process ID of the locking process. This makes it easy to determine whether a lock is still valid. The algorithm is to create a temporary file and then link it to the name that must be locked. If the link fails because a file with that name already exists, the existing file is read to get the process ID. If the process still exists, the lock attempt fails. Otherwise the lock file is deleted and the locking algorithm is retried.</div>
<p>
The PID is stored in ASCII format, with leading spaces to pad it out to ten characters, and a terminating newline. This implementation has been extended to put the hostname on the second line of the file, terminated with a newline, and optionally an arbitrary comment on the third line of the file, also terminated with a newline. If a comment is given, but <span class="define">PIDLOCK_NONBLOCK</span> is not, a blank line will be written as the second line of the file.<p>
The <b class="fname">pidlock</b>() function will attempt to create the file <i class="farg">lockfile</i> and put the current process's pid in it. The <b class="fname">ttylock</b>() function will do the same, but should be passed only the base name (with no leading directory prefix) of the <i class="farg">tty</i> to be locked; it will test that the tty exists in <i class="file">/dev</i> and is a character device, and then create the file in the <i class="file">/var/spool/lock</i> directory and prefix the filename with <i class="file">LCK..</i>. Use the <b class="fname">ttyunlock</b>() function to remove this lock.<p>
The following flags may be passed in <i class="file">flags</i>:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">PIDLOCK_NONBLOCK</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
The function should return immediately when a lock is held by another active process. Otherwise the function will wait (forever, if necessary) for the lock to be freed.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">PIDLOCK_USEHOSTNAME</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
The hostname should be compared against the hostname in the second line of the file (if present), and if they differ, no attempt at checking for a living process holding the lock will be made, and the lockfile will never be deleted. (The process is assumed to be alive.) This is used for locking on NFS or other remote filesystems. (The function will never create a lock if <span class="define">PIDLOCK_USEHOSTNAME</span> is specified and no hostname is present.)</dd>
</dl>
<p>
If <i class="file">locker</i> is non-null, it will contain the PID of the locking process, if there is one, on return.<p>
If <i class="file">info</i> is non-null and the lock succeeds, the string it points to will be written as the third line of the lock file.</div>
<div class="section">
<h1 id="x52455455524e2056414c554553">RETURN VALUES</h1> Zero is returned if the operation was successful; on an error a -1 is returned and a standard error code is left in the global location <b class="var">errno</b>.</div>
<div class="section">
<h1 id="x4552524f5253">ERRORS</h1> In addition to the errors that are returned from <a class="link-man" href="../2/stat">stat(2)</a>, <a class="link-man" href="../2/open">open(2)</a>, <a class="link-man" href="../2/read">read(2)</a>, <a class="link-man" href="../2/write">write(2)</a>, and <a class="link-man" href="../2/link">link(2)</a>, <b class="fname">pidlock</b>() or <b class="fname">ttylock</b>() can set <b class="var">errno</b> to the following values on failure:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">EWOULDBLOCK</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Another running process has a lock and the <span class="define">PIDLOCK_NONBLOCK</span> flag was specified.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">EFTYPE</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The <i class="farg">tty</i> specified in <b class="fname">ttylock</b>() is not a character special device.</dd>
</dl>
</div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="fname">pidlock</b>() and <b class="fname">ttylock</b>() functions appeared in <span class="unix">NetBSD&#160;1.3</span>.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> <span class="author">Curt Sampson</span> &#60;cjs@NetBSD.org&#62;.</div>
<div class="section">
<h1 id="x42554753">BUGS</h1> The lockfile format breaks if a pid is longer than ten digits when printed in decimal form.<p>
The PID returned will be the pid of the locker on the remote machine if <span class="define">PIDLOCK_USEHOSTNAME</span> is specified, but there is no indication that this is not on the local machine.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
March 19, 2006</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
<>

