<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
ATF-C-API(3)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
ATF-C-API(3)</td>
<td class="head-vol" align="center">
Library Functions Manual</td>
<td class="head-rtitle" align="right">
ATF-C-API(3)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">atf-c-api</b>, <b class="name">ATF_CHECK</b>, <b class="name">ATF_CHECK_MSG</b>, <b class="name">ATF_CHECK_EQ</b>, <b class="name">ATF_CHECK_EQ_MSG</b>, <b class="name">ATF_CHECK_MATCH</b>, <b class="name">ATF_CHECK_MATCH_MSG</b>, <b class="name">ATF_CHECK_STREQ</b>, <b class="name">ATF_CHECK_STREQ_MSG</b>, <b class="name">ATF_CHECK_ERRNO</b>, <b class="name">ATF_REQUIRE</b>, <b class="name">ATF_REQUIRE_MSG</b>, <b class="name">ATF_REQUIRE_EQ</b>, <b class="name">ATF_REQUIRE_EQ_MSG</b>, <b class="name">ATF_REQUIRE_MATCH</b>, <b class="name">ATF_REQUIRE_MATCH_MSG</b>, <b class="name">ATF_REQUIRE_STREQ</b>, <b class="name">ATF_REQUIRE_STREQ_MSG</b>, <b class="name">ATF_REQUIRE_ERRNO</b>, <b class="name">ATF_TC</b>, <b class="name">ATF_TC_BODY</b>, <b class="name">ATF_TC_BODY_NAME</b>, <b class="name">ATF_TC_CLEANUP</b>, <b class="name">ATF_TC_CLEANUP_NAME</b>, <b class="name">ATF_TC_HEAD</b>, <b class="name">ATF_TC_HEAD_NAME</b>, <b class="name">ATF_TC_NAME</b>, <b class="name">ATF_TC_WITH_CLEANUP</b>, <b class="name">ATF_TC_WITHOUT_HEAD</b>, <b class="name">ATF_TP_ADD_TC</b>, <b class="name">ATF_TP_ADD_TCS</b>, <b class="name">atf_tc_get_config_var</b>, <b class="name">atf_tc_get_config_var_wd</b>, <b class="name">atf_tc_get_config_var_as_bool</b>, <b class="name">atf_tc_get_config_var_as_bool_wd</b>, <b class="name">atf_tc_get_config_var_as_long</b>, <b class="name">atf_tc_get_config_var_as_long_wd</b>, <b class="name">atf_no_error</b>, <b class="name">atf_tc_expect_death</b>, <b class="name">atf_tc_expect_exit</b>, <b class="name">atf_tc_expect_fail</b>, <b class="name">atf_tc_expect_pass</b>, <b class="name">atf_tc_expect_signal</b>, <b class="name">atf_tc_expect_timeout</b>, <b class="name">atf_tc_fail</b>, <b class="name">atf_tc_fail_nonfatal</b>, <b class="name">atf_tc_pass</b>, <b class="name">atf_tc_skip</b>, <b class="name">atf_utils_cat_file</b>, <b class="name">atf_utils_compare_file</b>, <b class="name">atf_utils_copy_file</b>, <b class="name">atf_utils_create_file</b>, <b class="name">atf_utils_file_exists</b>, <b class="name">atf_utils_fork</b>, <b class="name">atf_utils_free_charpp</b>, <b class="name">atf_utils_grep_file</b>, <b class="name">atf_utils_grep_string</b>, <b class="name">atf_utils_readline</b>, <b class="name">atf_utils_redirect</b>, <b class="name">atf_utils_wait</b> &#8212; <span class="desc">C API to write ATF-based test programs</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">atf-c.h</a>&gt;</b><p>
<b class="fname">ATF_CHECK</b>(<i class="farg" style="white-space:nowrap;">expression</i>);<p>
<b class="fname">ATF_CHECK_MSG</b>(<i class="farg" style="white-space:nowrap;">expression</i>, <i class="farg" style="white-space:nowrap;">fail_msg_fmt</i>, <i class="farg" style="white-space:nowrap;">...</i>);<p>
<b class="fname">ATF_CHECK_EQ</b>(<i class="farg" style="white-space:nowrap;">expression_1</i>, <i class="farg" style="white-space:nowrap;">expression_2</i>);<p>
<b class="fname">ATF_CHECK_EQ_MSG</b>(<i class="farg" style="white-space:nowrap;">expression_1</i>, <i class="farg" style="white-space:nowrap;">expression_2</i>, <i class="farg" style="white-space:nowrap;">fail_msg_fmt</i>, <i class="farg" style="white-space:nowrap;">...</i>);<p>
<b class="fname">ATF_CHECK_MATCH</b>(<i class="farg" style="white-space:nowrap;">regexp</i>, <i class="farg" style="white-space:nowrap;">string</i>);<p>
<b class="fname">ATF_CHECK_MATCH_MSG</b>(<i class="farg" style="white-space:nowrap;">regexp</i>, <i class="farg" style="white-space:nowrap;">string</i>, <i class="farg" style="white-space:nowrap;">fail_msg_fmt</i>, <i class="farg" style="white-space:nowrap;">...</i>);<p>
<b class="fname">ATF_CHECK_STREQ</b>(<i class="farg" style="white-space:nowrap;">string_1</i>, <i class="farg" style="white-space:nowrap;">string_2</i>);<p>
<b class="fname">ATF_CHECK_STREQ_MSG</b>(<i class="farg" style="white-space:nowrap;">string_1</i>, <i class="farg" style="white-space:nowrap;">string_2</i>, <i class="farg" style="white-space:nowrap;">fail_msg_fmt</i>, <i class="farg" style="white-space:nowrap;">...</i>);<p>
<b class="fname">ATF_CHECK_ERRNO</b>(<i class="farg" style="white-space:nowrap;">exp_errno</i>, <i class="farg" style="white-space:nowrap;">bool_expression</i>);<p>
<b class="fname">ATF_REQUIRE</b>(<i class="farg" style="white-space:nowrap;">expression</i>);<p>
<b class="fname">ATF_REQUIRE_MSG</b>(<i class="farg" style="white-space:nowrap;">expression</i>, <i class="farg" style="white-space:nowrap;">fail_msg_fmt</i>, <i class="farg" style="white-space:nowrap;">...</i>);<p>
<b class="fname">ATF_REQUIRE_EQ</b>(<i class="farg" style="white-space:nowrap;">expression_1</i>, <i class="farg" style="white-space:nowrap;">expression_2</i>);<p>
<b class="fname">ATF_REQUIRE_EQ_MSG</b>(<i class="farg" style="white-space:nowrap;">expression_1</i>, <i class="farg" style="white-space:nowrap;">expression_2</i>, <i class="farg" style="white-space:nowrap;">fail_msg_fmt</i>, <i class="farg" style="white-space:nowrap;">...</i>);<p>
<b class="fname">ATF_REQUIRE_MATCH</b>(<i class="farg" style="white-space:nowrap;">regexp</i>, <i class="farg" style="white-space:nowrap;">string</i>);<p>
<b class="fname">ATF_REQUIRE_MATCH_MSG</b>(<i class="farg" style="white-space:nowrap;">regexp</i>, <i class="farg" style="white-space:nowrap;">string</i>, <i class="farg" style="white-space:nowrap;">fail_msg_fmt</i>, <i class="farg" style="white-space:nowrap;">...</i>);<p>
<b class="fname">ATF_REQUIRE_STREQ</b>(<i class="farg" style="white-space:nowrap;">string_1</i>, <i class="farg" style="white-space:nowrap;">string_2</i>);<p>
<b class="fname">ATF_REQUIRE_STREQ_MSG</b>(<i class="farg" style="white-space:nowrap;">string_1</i>, <i class="farg" style="white-space:nowrap;">string_2</i>, <i class="farg" style="white-space:nowrap;">fail_msg_fmt</i>, <i class="farg" style="white-space:nowrap;">...</i>);<p>
<b class="fname">ATF_REQUIRE_ERRNO</b>(<i class="farg" style="white-space:nowrap;">exp_errno</i>, <i class="farg" style="white-space:nowrap;">bool_expression</i>);<p>
<b class="fname">ATF_TC</b>(<i class="farg" style="white-space:nowrap;">name</i>);<p>
<b class="fname">ATF_TC_BODY</b>(<i class="farg" style="white-space:nowrap;">name</i>, <i class="farg" style="white-space:nowrap;">tc</i>);<p>
<b class="fname">ATF_TC_BODY_NAME</b>(<i class="farg" style="white-space:nowrap;">name</i>);<p>
<b class="fname">ATF_TC_CLEANUP</b>(<i class="farg" style="white-space:nowrap;">name</i>, <i class="farg" style="white-space:nowrap;">tc</i>);<p>
<b class="fname">ATF_TC_CLEANUP_NAME</b>(<i class="farg" style="white-space:nowrap;">name</i>);<p>
<b class="fname">ATF_TC_HEAD</b>(<i class="farg" style="white-space:nowrap;">name</i>, <i class="farg" style="white-space:nowrap;">tc</i>);<p>
<b class="fname">ATF_TC_HEAD_NAME</b>(<i class="farg" style="white-space:nowrap;">name</i>);<p>
<b class="fname">ATF_TC_NAME</b>(<i class="farg" style="white-space:nowrap;">name</i>);<p>
<b class="fname">ATF_TC_WITH_CLEANUP</b>(<i class="farg" style="white-space:nowrap;">name</i>);<p>
<b class="fname">ATF_TC_WITHOUT_HEAD</b>(<i class="farg" style="white-space:nowrap;">name</i>);<p>
<b class="fname">ATF_TP_ADD_TC</b>(<i class="farg" style="white-space:nowrap;">tp_name</i>, <i class="farg" style="white-space:nowrap;">tc_name</i>);<p>
<b class="fname">ATF_TP_ADD_TCS</b>(<i class="farg" style="white-space:nowrap;">tp_name</i>);<p>
<b class="fname">atf_tc_get_config_var</b>(<i class="farg" style="white-space:nowrap;">tc</i>, <i class="farg" style="white-space:nowrap;">varname</i>);<p>
<b class="fname">atf_tc_get_config_var_wd</b>(<i class="farg" style="white-space:nowrap;">tc</i>, <i class="farg" style="white-space:nowrap;">variable_name</i>, <i class="farg" style="white-space:nowrap;">default_value</i>);<p>
<b class="fname">atf_tc_get_config_var_as_bool</b>(<i class="farg" style="white-space:nowrap;">tc</i>, <i class="farg" style="white-space:nowrap;">variable_name</i>);<p>
<b class="fname">atf_tc_get_config_var_as_bool_wd</b>(<i class="farg" style="white-space:nowrap;">tc</i>, <i class="farg" style="white-space:nowrap;">variable_name</i>, <i class="farg" style="white-space:nowrap;">default_value</i>);<p>
<b class="fname">atf_tc_get_config_var_as_long</b>(<i class="farg" style="white-space:nowrap;">tc</i>, <i class="farg" style="white-space:nowrap;">variable_name</i>);<p>
<b class="fname">atf_tc_get_config_var_as_long_wd</b>(<i class="farg" style="white-space:nowrap;">tc</i>, <i class="farg" style="white-space:nowrap;">variable_name</i>, <i class="farg" style="white-space:nowrap;">default_value</i>);<p>
<b class="fname">atf_no_error</b>();<p>
<b class="fname">atf_tc_expect_death</b>(<i class="farg" style="white-space:nowrap;">reason</i>, <i class="farg" style="white-space:nowrap;">...</i>);<p>
<b class="fname">atf_tc_expect_exit</b>(<i class="farg" style="white-space:nowrap;">exitcode</i>, <i class="farg" style="white-space:nowrap;">reason</i>, <i class="farg" style="white-space:nowrap;">...</i>);<p>
<b class="fname">atf_tc_expect_fail</b>(<i class="farg" style="white-space:nowrap;">reason</i>, <i class="farg" style="white-space:nowrap;">...</i>);<p>
<b class="fname">atf_tc_expect_pass</b>();<p>
<b class="fname">atf_tc_expect_signal</b>(<i class="farg" style="white-space:nowrap;">signo</i>, <i class="farg" style="white-space:nowrap;">reason</i>, <i class="farg" style="white-space:nowrap;">...</i>);<p>
<b class="fname">atf_tc_expect_timeout</b>(<i class="farg" style="white-space:nowrap;">reason</i>, <i class="farg" style="white-space:nowrap;">...</i>);<p>
<b class="fname">atf_tc_fail</b>(<i class="farg" style="white-space:nowrap;">reason</i>);<p>
<b class="fname">atf_tc_fail_nonfatal</b>(<i class="farg" style="white-space:nowrap;">reason</i>);<p>
<b class="fname">atf_tc_pass</b>();<p>
<b class="fname">atf_tc_skip</b>(<i class="farg" style="white-space:nowrap;">reason</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">atf_utils_cat_file</b>(<i class="farg">const char *file</i>, <i class="farg">const char *prefix</i>);<p>
<i class="ftype">bool</i><br>
<b class="fname">atf_utils_compare_file</b>(<i class="farg">const char *file</i>, <i class="farg">const char *contents</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">atf_utils_copy_file</b>(<i class="farg">const char *source</i>, <i class="farg">const char *destination</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">atf_utils_create_file</b>(<i class="farg">const char *file</i>, <i class="farg">const char *contents</i>, <i class="farg">...</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">atf_utils_file_exists</b>(<i class="farg">const char *file</i>);<p>
<i class="ftype">pid_t</i><br>
<b class="fname">atf_utils_fork</b>(<i class="farg">void</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">atf_utils_free_charpp</b>(<i class="farg">char **argv</i>);<p>
<i class="ftype">bool</i><br>
<b class="fname">atf_utils_grep_file</b>(<i class="farg">const char *regexp</i>, <i class="farg">const char *file</i>, <i class="farg">...</i>);<p>
<i class="ftype">bool</i><br>
<b class="fname">atf_utils_grep_string</b>(<i class="farg">const char *regexp</i>, <i class="farg">const char *str</i>, <i class="farg">...</i>);<p>
<i class="ftype">char *</i><br>
<b class="fname">atf_utils_readline</b>(<i class="farg">int fd</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">atf_utils_redirect</b>(<i class="farg">const int fd</i>, <i class="farg">const char *file</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">atf_utils_wait</b>(<i class="farg">const pid_t pid</i>, <i class="farg">const int expected_exit_status</i>, <i class="farg">const char *expected_stdout</i>, <i class="farg">const char *expected_stderr</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> ATF provides a C programming interface to implement test programs. C-based test programs follow this template:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
... C-specific includes go here ... 
 
#include &lt;atf-c.h&gt; 
 
ATF_TC(tc1); 
ATF_TC_HEAD(tc1, tc) 
{ 
    ... first test case's header ... 
} 
ATF_TC_BODY(tc1, tc) 
{ 
    ... first test case's body ... 
} 
 
ATF_TC_WITH_CLEANUP(tc2); 
ATF_TC_HEAD(tc2, tc) 
{ 
    ... second test case's header ... 
} 
ATF_TC_BODY(tc2, tc) 
{ 
    ... second test case's body ... 
} 
ATF_TC_CLEANUP(tc2, tc) 
{ 
    ... second test case's cleanup ... 
} 
 
ATF_TC_WITHOUT_HEAD(tc3); 
ATF_TC_BODY(tc3, tc) 
{ 
    ... third test case's body ... 
} 
 
... additional test cases ... 
 
ATF_TP_ADD_TCS(tp) 
{ 
    ATF_TP_ADD_TC(tcs, tc1); 
    ATF_TP_ADD_TC(tcs, tc2); 
    ATF_TP_ADD_TC(tcs, tc3); 
    ... add additional test cases ... 
 
    return atf_no_error(); 
}</pre>
<div class="subsection">
<h2 id="x446566696e6974696f6e206f662074657374206361736573">Definition of test cases</h2> Test cases have an identifier and are composed of three different parts: the header, the body and an optional cleanup routine, all of which are described in <a class="link-man" href="../html4/atf-test-case.html">atf-test-case(4)</a>. To define test cases, one can use the <b class="fname">ATF_TC</b>(), <b class="fname">ATF_TC_WITH_CLEANUP</b>() or the <b class="fname">ATF_TC_WITHOUT_HEAD</b>() macros, which take a single parameter specifiying the test case's name. <b class="fname">ATF_TC</b>(), requires to define a head and a body for the test case, <b class="fname">ATF_TC_WITH_CLEANUP</b>() requires to define a head, a body and a cleanup for the test case and <b class="fname">ATF_TC_WITHOUT_HEAD</b>() requires only a body for the test case. It is important to note that these <span class="emph">do not</span> set the test case up for execution when the program is run. In order to do so, a later registration is needed with the <b class="fname">ATF_TP_ADD_TC</b>() macro detailed in <i class="link-sec"><a class="link-sec" href="#x50726f6772616d20696e697469616c697a6174696f6e">Program initialization</a></i>.<p>
Later on, one must define the three parts of the body by means of three functions. Their headers are given by the <b class="fname">ATF_TC_HEAD</b>(), <b class="fname">ATF_TC_BODY</b>() and <b class="fname">ATF_TC_CLEANUP</b>() macros, all of which take the test case name provided to the <b class="fname">ATF_TC</b>() <b class="fname">ATF_TC_WITH_CLEANUP</b>(), or <b class="fname">ATF_TC_WITHOUT_HEAD</b>() macros and the name of the variable that will hold a pointer to the test case data. Following each of these, a block of code is expected, surrounded by the opening and closing brackets.</div>
<div class="subsection">
<h2 id="x50726f6772616d20696e697469616c697a6174696f6e">Program initialization</h2> The library provides a way to easily define the test program's <b class="fname">main</b>() function. You should never define one on your own, but rely on the library to do it for you. This is done by using the <b class="fname">ATF_TP_ADD_TCS</b>() macro, which is passed the name of the object that will hold the test cases; i.e. the test program instance. This name can be whatever you want as long as it is a valid variable identifier.<p>
After the macro, you are supposed to provide the body of a function, which should only use the <b class="fname">ATF_TP_ADD_TC</b>() macro to register the test cases the test program will execute and return a success error code. The first parameter of this macro matches the name you provided in the former call. The success status can be returned using the <b class="fname">atf_no_error</b>() function.</div>
<div class="subsection">
<h2 id="x48656164657220646566696e6974696f6e73">Header definitions</h2> The test case's header can define the meta-data by using the <b class="fname">atf_tc_set_md_var</b>() method, which takes three parameters: the first one points to the test case data, the second one specifies the meta-data variable to be set and the third one specifies its value. Both of them are strings.</div>
<div class="subsection">
<h2 id="x436f6e66696775726174696f6e207661726961626c6573">Configuration variables</h2> The test case has read-only access to the current configuration variables by means of the <i class="ftype">bool</i> <b class="fname">atf_tc_has_config_var</b>(), <i class="ftype">const char *</i> <b class="fname">atf_tc_get_config_var</b>(), <i class="ftype">const char *</i> <b class="fname">atf_tc_get_config_var_wd</b>(), <i class="ftype">bool</i> <b class="fname">atf_tc_get_config_var_as_bool</b>(), <i class="ftype">bool</i> <b class="fname">atf_tc_get_config_var_as_bool_wd</b>(), <i class="ftype">long</i> <b class="fname">atf_tc_get_config_var_as_long</b>(), and the <i class="ftype">long</i> <b class="fname">atf_tc_get_config_var_as_long_wd</b>() functions, which can be called in any of the three parts of a test case.<p>
The &#8216;_wd&#8217; variants take a default value for the variable which is returned if the variable is not defined. The other functions without the &#8216;_wd&#8217; suffix <span class="emph">require</span> the variable to be defined.</div>
<div class="subsection">
<h2 id="x41636365737320746f2074686520736f75726365206469726563746f7279">Access to the source directory</h2> It is possible to get the path to the test case's source directory from any of its three components by querying the &#8216;srcdir&#8217; configuration variable.</div>
<div class="subsection">
<h2 id="x526571756972696e672070726f6772616d73">Requiring programs</h2> Aside from the <b class="var">require.progs</b> meta-data variable available in the header only, one can also check for additional programs in the test case's body by using the <b class="fname">atf_tc_require_prog</b>() function, which takes the base name or full path of a single binary. Relative paths are forbidden. If it is not found, the test case will be automatically skipped.</div>
<div class="subsection">
<h2 id="x5465737420636173652066696e616c697a6174696f6e">Test case finalization</h2> The test case finalizes either when the body reaches its end, at which point the test is assumed to have <span class="emph">passed</span>, unless any non-fatal errors were raised using <b class="fname">atf_tc_fail_nonfatal</b>(), or at any explicit call to <b class="fname">atf_tc_pass</b>(), <b class="fname">atf_tc_fail</b>() or <b class="fname">atf_tc_skip</b>(). These three functions terminate the execution of the test case immediately. The cleanup routine will be processed afterwards in a completely automated way, regardless of the test case's termination reason.<p>
<b class="fname">atf_tc_pass</b>() does not take any parameters. <b class="fname">atf_tc_fail</b>(), <b class="fname">atf_tc_fail_nonfatal</b>() and <b class="fname">atf_tc_skip</b>() take a format string and a variable list of parameters, which describe, in a user-friendly manner, why the test case failed or was skipped, respectively. It is very important to provide a clear error message in both cases so that the user can quickly know why the test did not pass.</div>
<div class="subsection">
<h2 id="x4578706563746174696f6e73">Expectations</h2> Everything explained in the previous section changes when the test case expectations are redefined by the programmer.<p>
Each test case has an internal state called &#8216;expect&#8217; that describes what the test case expectations are at any point in time. The value of this property can change during execution by any of:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">atf_tc_expect_death</b>(<i class="farg">reason</i>, <i class="farg">...</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Expects the test case to exit prematurely regardless of the nature of the exit.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">atf_tc_expect_exit</b>(<i class="farg">exitcode</i>, <i class="farg">reason</i>, <i class="farg">...</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Expects the test case to exit cleanly. If <b class="var">exitcode</b> is not &#8216;-1&#8217;, <a class="link-man" href="../html1/atf-run.html">atf-run(1)</a> will validate that the exit code of the test case matches the one provided in this call. Otherwise, the exact value will be ignored.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">atf_tc_expect_fail</b>(<i class="farg">reason</i>, <i class="farg">...</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Any failure (be it fatal or non-fatal) raised in this mode is recorded. However, such failures do not report the test case as failed; instead, the test case finalizes cleanly and is reported as &#8216;expected failure&#8217;; this report includes the provided <i class="farg">reason</i> as part of it. If no error is raised while running in this mode, then the test case is reported as &#8216;failed&#8217;.<p>
This mode is useful to reproduce actual known bugs in tests. Whenever the developer fixes the bug later on, the test case will start reporting a failure, signaling the developer that the test case must be adjusted to the new conditions. In this situation, it is useful, for example, to set <i class="farg">reason</i> as the bug number for tracking purposes.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">atf_tc_expect_pass</b>()</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This is the normal mode of execution. In this mode, any failure is reported as such to the user and the test case is marked as &#8216;failed&#8217;.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">atf_tc_expect_signal</b>(<i class="farg">signo</i>, <i class="farg">reason</i>, <i class="farg">...</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Expects the test case to terminate due to the reception of a signal. If <b class="var">signo</b> is not &#8216;-1&#8217;, <a class="link-man" href="../html1/atf-run.html">atf-run(1)</a> will validate that the signal that terminated the test case matches the one provided in this call. Otherwise, the exact value will be ignored.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">atf_tc_expect_timeout</b>(<i class="farg">reason</i>, <i class="farg">...</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Expects the test case to execute for longer than its timeout.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x48656c706572206d6163726f7320666f7220636f6d6d6f6e20636865636b73">Helper macros for common checks</h2> The library provides several macros that are very handy in multiple situations. These basically check some condition after executing a given statement or processing a given expression and, if the condition is not met, they report the test case as failed.<p>
The &#8216;REQUIRE&#8217; variant of the macros immediately abort the test case as soon as an error condition is detected by calling the <b class="fname">atf_tc_fail</b>() function. Use this variant whenever it makes no sense to continue the execution of a test case when the checked condition is not met. The &#8216;CHECK&#8217; variant, on the other hand, reports a failure as soon as it is encountered using the <b class="fname">atf_tc_fail_nonfatal</b>() function, but the execution of the test case continues as if nothing had happened. Use this variant whenever the checked condition is important as a result of the test case, but there are other conditions that can be subsequently checked on the same run without aborting.<p>
Additionally, the &#8216;MSG&#8217; variants take an extra set of parameters to explicitly specify the failure message. This failure message is formatted according to the <a class="link-man" href="../html3/printf.html">printf(3)</a> formatters.<p>
<b class="fname">ATF_CHECK</b>(), <b class="fname">ATF_CHECK_MSG</b>(), <b class="fname">ATF_REQUIRE</b>() and <b class="fname">ATF_REQUIRE_MSG</b>() take an expression and fail if the expression evaluates to false.<p>
<b class="fname">ATF_CHECK_EQ</b>(), <b class="fname">ATF_CHECK_EQ_MSG</b>(), <b class="fname">ATF_REQUIRE_EQ</b>() and <b class="fname">ATF_REQUIRE_EQ_MSG</b>() take two expressions and fail if the two evaluated values are not equal.<p>
<b class="fname">ATF_CHECK_MATCH</b>(), <b class="fname">ATF_CHECK_MATCH_MSG</b>(), <b class="fname">ATF_REQUIRE_MATCH</b>() and <b class="fname">ATF_REQUIRE_MATCH_MSG</b>() take a regular expression and a string and fail if the regular expression does not match the given string. Note that the regular expression is not anchored, so it will match anywhere in the string.<p>
<b class="fname">ATF_CHECK_STREQ</b>(), <b class="fname">ATF_CHECK_STREQ_MSG</b>(), <b class="fname">ATF_REQUIRE_STREQ</b>() and <b class="fname">ATF_REQUIRE_STREQ_MSG</b>() take two strings and fail if the two are not equal character by character.<p>
<b class="fname">ATF_CHECK_ERRNO</b>() and <b class="fname">ATF_REQUIRE_ERRNO</b>() take, first, the error code that the check is expecting to find in the <b class="var">errno</b> variable and, second, a boolean expression that, if evaluates to true, means that a call failed and <b class="var">errno</b> has to be checked against the first value.</div>
<div class="subsection">
<h2 id="x5574696c6974792066756e6374696f6e73">Utility functions</h2> The following functions are provided as part of the <b class="name">atf-c-api</b> API to simplify the creation of a variety of tests. In particular, these are useful to write tests for command-line interfaces.<p>
<i class="ftype">void</i> <b class="fname">atf_utils_cat_file</b>(<i class="farg">const char *file</i>, <i class="farg">const char *prefix</i>);<p>
<div style="margin-left: 5.00ex;" class="display">
Prints the contents of <i class="farg">file</i> to the standard output, prefixing every line with the string in <i class="farg">prefix</i>.</div>
<p>
<i class="ftype">bool</i> <b class="fname">atf_utils_compare_file</b>(<i class="farg">const char *file</i>, <i class="farg">const char *contents</i>);<p>
<div style="margin-left: 5.00ex;" class="display">
Returns true if the given <i class="farg">file</i> matches exactly the expected inlined <i class="farg">contents</i>.</div>
<p>
<i class="ftype">void</i> <b class="fname">atf_utils_copy_file</b>(<i class="farg">const char *source</i>, <i class="farg">const char *destination</i>);<p>
<div style="margin-left: 5.00ex;" class="display">
Copies the file <i class="farg">source</i> to <i class="farg">destination</i>. The permissions of the file are preserved during the code.</div>
<p>
<i class="ftype">void</i> <b class="fname">atf_utils_create_file</b>(<i class="farg">const char *file</i>, <i class="farg">const char *contents</i>, <i class="farg">...</i>);<p>
<div style="margin-left: 5.00ex;" class="display">
Creates <i class="farg">file</i> with the text given in <i class="farg">contents</i>, which is a formatting string that uses the rest of the variable arguments.</div>
<p>
<i class="ftype">void</i> <b class="fname">atf_utils_file_exists</b>(<i class="farg">const char *file</i>);<p>
<div style="margin-left: 5.00ex;" class="display">
Checks if <i class="farg">file</i> exists.</div>
<p>
<i class="ftype">pid_t</i> <b class="fname">atf_utils_fork</b>(<i class="farg">void</i>);<p>
<div style="margin-left: 5.00ex;" class="display">
Forks a process and redirects the standard output and standard error of the child to files for later validation with <b class="fname">atf_utils_wait</b>(). Fails the test case if the fork fails, so this does not return an error.</div>
<p>
<i class="ftype">void</i> <b class="fname">atf_utils_free_charpp</b>(<i class="farg">char **argv</i>);<p>
<div style="margin-left: 5.00ex;" class="display">
Frees a dynamically-allocated array of dynamically-allocated strings.</div>
<p>
<i class="ftype">bool</i> <b class="fname">atf_utils_grep_file</b>(<i class="farg">const char *regexp</i>, <i class="farg">const char *file</i>, <i class="farg">...</i>);<p>
<div style="margin-left: 5.00ex;" class="display">
Searches for the <i class="farg">regexp</i>, which is a formatting string representing the regular expression, in the <i class="farg">file</i>. The variable arguments are used to construct the regular expression.</div>
<p>
<i class="ftype">bool</i> <b class="fname">atf_utils_grep_string</b>(<i class="farg">const char *regexp</i>, <i class="farg">const char *str</i>, <i class="farg">...</i>);<p>
<div style="margin-left: 5.00ex;" class="display">
Searches for the <i class="farg">regexp</i>, which is a formatting string representing the regular expression, in the literal string <i class="farg">str</i>. The variable arguments are used to construct the regular expression.</div>
<p>
<i class="ftype">char *</i> <b class="fname">atf_utils_readline</b>(<i class="farg">int fd</i>);<p>
<div style="margin-left: 5.00ex;" class="display">
Reads a line from the file descriptor <i class="farg">fd</i>. The line, if any, is returned as a dynamically-allocated buffer that must be released with <a class="link-man" href="../html3/free.html">free(3)</a>. If there was nothing to read, returns &#8216;NULL&#8217;.</div>
<p>
<i class="ftype">void</i> <b class="fname">atf_utils_redirect</b>(<i class="farg">const int fd</i>, <i class="farg">const char *file</i>);<p>
<div style="margin-left: 5.00ex;" class="display">
Redirects the given file descriptor <i class="farg">fd</i> to <i class="farg">file</i>. This function exits the process in case of an error and does not properly mark the test case as failed. As a result, it should only be used in subprocesses of the test case; specially those spawned by <b class="fname">atf_utils_fork</b>().</div>
<p>
<i class="ftype">void</i> <b class="fname">atf_utils_wait</b>(<i class="farg">const pid_t pid</i>, <i class="farg">const int expected_exit_status</i>, <i class="farg">const char *expected_stdout</i>, <i class="farg">const char *expected_stderr</i>);<p>
<div style="margin-left: 5.00ex;" class="display">
Waits and validates the result of a subprocess spawned with <b class="fname">atf_utils_wait</b>(). The validation involves checking that the subprocess exited cleanly and returned the code specified in <i class="farg">expected_exit_status</i> and that its standard output and standard error match the strings given in <i class="farg">expected_stdout</i> and <i class="farg">expected_stderr</i>.<p>
If any of the <i class="farg">expected_stdout</i> or <i class="farg">expected_stderr</i> strings are prefixed with &#8216;save:&#8217;, then they specify the name of the file into which to store the stdout or stderr of the subprocess, and no comparison is performed.</div>
</div>
</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> The following shows a complete test program with a single test case that validates the addition operator:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
#include &lt;atf-c.h&gt; 
 
ATF_TC(addition); 
ATF_TC_HEAD(addition, tc) 
{ 
    atf_tc_set_md_var(tc, "descr", 
                      "Sample tests for the addition operator"); 
} 
ATF_TC_BODY(addition, tc) 
{ 
    ATF_CHECK_EQ(0 + 0, 0); 
    ATF_CHECK_EQ(0 + 1, 1); 
    ATF_CHECK_EQ(1 + 0, 1); 
 
    ATF_CHECK_EQ(1 + 1, 2); 
 
    ATF_CHECK_EQ(100 + 200, 300); 
} 
 
ATF_TC(string_formatting); 
ATF_TC_HEAD(string_formatting, tc) 
{ 
    atf_tc_set_md_var(tc, "descr", 
                      "Sample tests for the snprintf"); 
} 
ATF_TC_BODY(string_formatting, tc) 
{ 
    char buf[1024]; 
    snprintf(buf, sizeof(buf), "a %s", "string"); 
    ATF_CHECK_STREQ_MSG("a string", buf, "%s is not working"); 
} 
 
ATF_TC(open_failure); 
ATF_TC_HEAD(open_failure, tc) 
{ 
    atf_tc_set_md_var(tc, "descr", 
                      "Sample tests for the open function"); 
} 
ATF_TC_BODY(open_failure, tc) 
{ 
    ATF_CHECK_ERRNO(ENOENT, open("non-existent", O_RDONLY) == -1); 
} 
 
ATF_TC(known_bug); 
ATF_TC_HEAD(known_bug, tc) 
{ 
    atf_tc_set_md_var(tc, "descr", 
                      "Reproduces a known bug"); 
} 
ATF_TC_BODY(known_bug, tc) 
{ 
    atf_tc_expect_fail("See bug number foo/bar"); 
    ATF_CHECK_EQ(3, 1 + 1); 
    atf_tc_expect_pass(); 
    ATF_CHECK_EQ(3, 1 + 2); 
} 
 
ATF_TP_ADD_TCS(tp) 
{ 
    ATF_TP_ADD_TC(tp, addition); 
    ATF_TP_ADD_TC(tp, string_formatting); 
    ATF_TP_ADD_TC(tp, open_failure); 
    ATF_TP_ADD_TC(tp, known_bug); 
 
    return atf_no_error(); 
}</pre>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html1/atf-test-program.html">atf-test-program(1)</a>, <a class="link-man" href="../html4/atf-test-case.html">atf-test-case(4)</a>, <a class="link-man" href="../html7/atf.html">atf(7)</a></div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
November 15, 2013</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

