<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
DM(3)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
DM(3)</td>
<td class="head-vol" align="center">
Library Functions Manual</td>
<td class="head-rtitle" align="right">
DM(3)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">dm</b> &#8212; <span class="desc">device-mapper access manipulation library</span></div>
<div class="section">
<h1 id="x4c494252415259">LIBRARY</h1> <span class="lib">Device Mapper Library (libdm, &#45;ldm)</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">libdm.h</a>&gt;</b><p>
<i class="ftype">void</i><br>
<b class="fname">libdm_iter_destroy</b>(<i class="farg" style="white-space:nowrap;">libdm_iter_t libdm_iter</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">libdm_task_run</b>(<i class="farg" style="white-space:nowrap;">libdm_task_t *libdm_task</i>);<p>
<i class="ftype">libdm_task_t</i><br>
<b class="fname">libdm_task_create</b>(<i class="farg" style="white-space:nowrap;">const char *command</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">libdm_task_destroy</b>(<i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">libdm_task_set_name</b>(<i class="farg" style="white-space:nowrap;">const char *name</i>, <i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">char *</i><br>
<b class="fname">libdm_task_get_name</b>(<i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">libdm_task_set_uuid</b>(<i class="farg" style="white-space:nowrap;">const char *uuid</i>, <i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">char *</i><br>
<b class="fname">libdm_task_get_uuid</b>(<i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">char *</i><br>
<b class="fname">libdm_task_get_command</b>(<i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">int32_t</i><br>
<b class="fname">libdm_task_get_cmd_version</b>(<i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>, <i class="farg" style="white-space:nowrap;">uint32_t *ver</i>, <i class="farg" style="white-space:nowrap;">size_t size</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">libdm_task_set_minor</b>(<i class="farg" style="white-space:nowrap;">uint32_t minor</i>, <i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">uint32_t</i><br>
<b class="fname">libdm_task_get_minor</b>(<i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">libdm_task_set_flags</b>(<i class="farg" style="white-space:nowrap;">uint32_t flags</i>, <i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">uint32_t</i><br>
<b class="fname">libdm_task_get_flags</b>(<i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">uint32_t</i><br>
<b class="fname">libdm_task_get_target_num</b>(<i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">int32_t</i><br>
<b class="fname">libdm_task_get_open_num</b>(<i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">uint32_t</i><br>
<b class="fname">libdm_task_get_event_num</b>(<i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">libdm_task_set_cmd</b>(<i class="farg" style="white-space:nowrap;">libdm_cmd_t libdm_cmd</i>, <i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">libdm_cmd_t</i><br>
<b class="fname">libdm_task_get_cmd</b>(<i class="farg" style="white-space:nowrap;">libdm_task_t libdm_task</i>);<p>
<i class="ftype">libdm_cmd_t</i><br>
<b class="fname">libdm_cmd_create</b>(<i class="farg" style="white-space:nowrap;">void</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">libdm_cmd_destroy</b>(<i class="farg" style="white-space:nowrap;">libdm_cmd_t libdm_cmd</i>);<p>
<i class="ftype">libdm_iter_t</i><br>
<b class="fname">libdm_cmd_iter_create</b>(<i class="farg" style="white-space:nowrap;">libdm_cmd_t libdm_cmd</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">libdm_cmd_set_table</b>(<i class="farg" style="white-space:nowrap;">libdm_table_t libdm_table</i>, <i class="farg" style="white-space:nowrap;">libdm_cmd_t libdm_cmd</i>);<p>
<i class="ftype">libdm_table_t</i><br>
<b class="fname">libdm_cmd_get_table</b>(<i class="farg" style="white-space:nowrap;">libdm_iter_t iter</i>);<p>
<i class="ftype">libdm_target_t</i><br>
<b class="fname">libdm_cmd_get_target</b>(<i class="farg" style="white-space:nowrap;">libdm_iter_t iter</i>);<p>
<i class="ftype">libdm_dev_t</i><br>
<b class="fname">libdm_cmd_get_dev</b>(<i class="farg" style="white-space:nowrap;">libdm_iter_t iter</i>);<p>
<i class="ftype">uint64_t</i><br>
<b class="fname">libdm_cmd_get_deps</b>(<i class="farg" style="white-space:nowrap;">libdm_iter_t libdm_iter</i>);<p>
<i class="ftype">libdm_table_t</i><br>
<b class="fname">libdm_table_create</b>(<i class="farg" style="white-space:nowrap;">void</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">libdm_table_destroy</b>(<i class="farg" style="white-space:nowrap;">libdm_table_t libdm_table</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">libdm_table_set_start</b>(<i class="farg" style="white-space:nowrap;">uint64_t start</i>, <i class="farg" style="white-space:nowrap;">libdm_table_t libdm_table</i>);<p>
<i class="ftype">uint64_t</i><br>
<b class="fname">libdm_table_get_start</b>(<i class="farg" style="white-space:nowrap;">libdm_table_t libdm_table</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">libdm_table_set_length</b>(<i class="farg" style="white-space:nowrap;">uint64_t length</i>, <i class="farg" style="white-space:nowrap;">libdm_table_t libdm_table</i>);<p>
<i class="ftype">uint64_t</i><br>
<b class="fname">libdm_table_get_length</b>(<i class="farg" style="white-space:nowrap;">libdm_table_t libdm_table</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">libdm_table_set_target</b>(<i class="farg" style="white-space:nowrap;">const char *name</i>, <i class="farg" style="white-space:nowrap;">libdm_table_t libdm_table</i>);<p>
<i class="ftype">char *</i><br>
<b class="fname">libdm_table_get_target</b>(<i class="farg" style="white-space:nowrap;">libdm_table_t libdm_table</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">libdm_table_set_params</b>(<i class="farg" style="white-space:nowrap;">const char *params</i>, <i class="farg" style="white-space:nowrap;">libdm_table_t libdm_table</i>);<p>
<i class="ftype">char *</i><br>
<b class="fname">libdm_table_get_params</b>(<i class="farg" style="white-space:nowrap;">libdm_table_t libdm_table</i>);<p>
<i class="ftype">int32_t</i><br>
<b class="fname">libdm_table_get_status</b>(<i class="farg" style="white-space:nowrap;">libdm_table_t libdm_table</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">libdm_target_destroy</b>(<i class="farg" style="white-space:nowrap;">libdm_target_t libdm_target</i>);<p>
<i class="ftype">char *</i><br>
<b class="fname">libdm_target_get_name</b>(<i class="farg" style="white-space:nowrap;">libdm_target_t libdm_target</i>);<p>
<i class="ftype">int32_t</i><br>
<b class="fname">libdm_target_get_version</b>(<i class="farg" style="white-space:nowrap;">libdm_target_t libdm_target</i>, <i class="farg" style="white-space:nowrap;">uint32_t *ver</i>, <i class="farg" style="white-space:nowrap;">size_t size</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">libdm_dev_destroy</b>(<i class="farg" style="white-space:nowrap;">libdm_dev_t libdm_dev</i>);<p>
<i class="ftype">char *</i><br>
<b class="fname">libdm_dev_get_name</b>(<i class="farg" style="white-space:nowrap;">libdm_dev_t libdm_dev</i>);<p>
<i class="ftype">uint32_t</i><br>
<b class="fname">libdm_dev_get_minor</b>(<i class="farg" style="white-space:nowrap;">libdm_dev_t libdm_dev</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">libdm_dev_set_newname</b>(<i class="farg" style="white-space:nowrap;">const char *newname</i>, <i class="farg" style="white-space:nowrap;">libdm_cmd_t libdm_cmd</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> Every object in libdm has its own create and destroy routine.<ul style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-bul">
<li class="list-bul" style="margin-top: 0.00em;">
libdm_task_t</li>
<li class="list-bul" style="margin-top: 0.00em;">
libdm_cmd_t</li>
<li class="list-bul" style="margin-top: 0.00em;">
libdm_table_t</li>
</ul>
<p>
Except <span class="type">libdm_dev_t</span> which is received from kernel as list of physical devices on which the logical device depends. <span class="type">libdm_target_t</span> which is received from kernel as list of available targets to use. <span class="type">libdm_iter_t</span> which is used as iteration counter for array entries in the task structure.<p>
Every object attribute in libdm can be set and gotten by appropriate routines, therefore there always are set and get routines.<div class="subsection">
<h2 id="x4c4942444d205441534b">LIBDM TASK</h2> The <b class="fname">libdm_task_create</b>() function creates a libdm task dictionary with command string set to <i class="farg">command</i>. If <i class="farg">command</i> is <span class="define">NULL</span>, libdm_task_t is not created and the function returns <span class="define">NULL</span>.<p>
<b class="fname">libdm_task_destroy</b>() free all memory allocated to <i class="farg">libdm_task</i> by <b class="fname">libdm_task_create</b>().<p>
<b class="fname">libdm_task_run</b>() Sends created <i class="farg">libdm_task</i> to kernel and receives new one as reply.<p>
List of attributes avaialable in <span class="type">libdm_task_t</span>:<table style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-col">
<col style="width: 21.00ex;">
<col style="width: 23.00ex;">
<col style="min-width: 3.00ex;">
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Attribute</span></td>
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Description</span></td>
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Mode</span></td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<code class="lit">DM_IOCTL_OPEN</code></td>
<td class="list-col" style="margin-top: 1.00em;">
Device open-count</td>
<td class="list-col" style="margin-top: 1.00em;">
Read-Only</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<code class="lit">DM_IOCTL_MINOR</code></td>
<td class="list-col" style="margin-top: 1.00em;">
Device minor number</td>
<td class="list-col" style="margin-top: 1.00em;">
Read-Write</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<code class="lit">DM_IOCTL_NAME</code></td>
<td class="list-col" style="margin-top: 1.00em;">
Device name</td>
<td class="list-col" style="margin-top: 1.00em;">
Read-Write</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<code class="lit">DM_IOCTL_UUID</code></td>
<td class="list-col" style="margin-top: 1.00em;">
Device uuid</td>
<td class="list-col" style="margin-top: 1.00em;">
Read-Write</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<code class="lit">DM_IOCTL_TARGET_COUNT</code></td>
<td class="list-col" style="margin-top: 1.00em;">
Number of table entries</td>
<td class="list-col" style="margin-top: 1.00em;">
Read-Only</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<code class="lit">DM_IOCTL_FLAGS</code></td>
<td class="list-col" style="margin-top: 1.00em;">
Device status flags</td>
<td class="list-col" style="margin-top: 1.00em;">
Read-Write</td>
</tr>
</tbody>
</table>
<p>
<b class="fname">libdm_task_set_name</b>() and <b class="fname">libdm_task_get_name</b>() Set name of the device for commands which need to have a dm device identifier. The device-mapper later uses the device name to look up the device from the list of all devices. The get routine will fetch the device name from the task dictionary.<p>
<b class="fname">libdm_task_set_uuid</b>() and <b class="fname">libdm_task_get_uuid</b>() Set uuid of device for commands which need to have a dm device identifier. The device-mapper later uses the device uuid to look up the device from the list of all devices. The get routine will fetch the device uuid from the task dictionary.<p>
<b class="fname">libdm_task_set_minor</b>() and <b class="fname">libdm_task_get_minor</b>() Set minor device number of device for commands which need to have a dm device identifier. The device-mapper later uses the device minor number to look up the device from the list of all devices. The get routine will fetch the device minor number from the task dictionary.<p>
<b class="fname">libdm_task_set_flags</b>() and <b class="fname">libdm_task_get_flags</b>() Set/fetch device status flags from the task dictionary.<p>
<b class="fname">libdm_task_get_open_num</b>() Fetch number of opened devices from the kernel and return them as count.<p>
<b class="fname">libdm_task_get_target_num</b>() Fetch number of opened devices from the kernel and return them as count.<p>
<b class="fname">libdm_task_get_cmd_version</b>() Get the version of the dm driver in the kernel as array <i class="farg">uint32_t *ver</i> of size <i class="farg">size</i>. <b class="fname">libdm_task_set_cmd</b>() and <b class="fname">libdm_task_get_cmd</b>() Add and fetch cmd structure from <span class="type">libdm_task_t</span>. <span class="type">libdm_cmd_t</span> is the container used to carry information specific for the particular command. cmd is usually set before libdm_task_run is used and is taken from the task structure after the task run was called.</div>
<div class="subsection">
<h2 id="x4c4942444d205441534b20434d44">LIBDM TASK CMD</h2> The <b class="fname">libdm_cmd_create</b>() function will allocate a cmd structure which can later be put in to the task.<p>
<b class="fname">libdm_cmd_destroy</b>() will deallocate a previously allocated cmd structure.<p>
<b class="fname">libdm_cmd_set_table</b>() Will load and fetch the device mapping table from the dm device. The table is usually loaded to the device during initial device creation or device resizing.<p>
Because libdm_cmd is an array of structures, all _get routines need an iterator to work. For every entry we can have more than one. <b class="fname">libdm_cmd_get_table</b>() When the user creates a task with the "status" command, the kernel sends cmd with a table in it.<p>
<b class="fname">libdm_cmd_get_target</b>() Get mapping target description from cmd. Target contains target_name and target_version.<p>
<b class="fname">libdm_cmd_get_dev</b>() When user creates a task with the "info" command, the kernel sends cmd with information about dm device to user.<p>
<b class="fname">libdm_cmd_get_deps</b>() When user creates a task with the "deps" command, the kernel sends cmd with an array of physical devices attached to the dm device.<p>
Usually the device has more than one table entry in the device command. Therefore cmd iterators are needed for <span class="type">libdm_cmd_t</span>; they can be created by the <b class="fname">libdm_cmd_iter_create</b>() function.</div>
<div class="subsection">
<h2 id="x4c4942444d20434d44205441424c45">LIBDM CMD TABLE</h2> A device table describes the logical mapping between the dm device and physical devices. Every table has the logical block start, the table length (in disk blocks), the target used by table, the physical device, and the offset on it. The physical device and the offset on it are parameters which are target specific and are passed down to the target as param string.<p>
Example device table entry<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit">0 1024 linear /dev/wd1a 384</code></div>
</blockquote>
<table style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-col">
<col style="width: 15.00ex;">
<col style="min-width: 23.00ex;">
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Attribute</span></td>
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Description</span></td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<code class="lit">DM_TABLE_TYPE</code></td>
<td class="list-col" style="margin-top: 1.00em;">
Used device mapper target</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<code class="lit">DM_TABLE_START</code></td>
<td class="list-col" style="margin-top: 1.00em;">
Device Logical start block</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<code class="lit">DM_TABLE_STAT</code></td>
<td class="list-col" style="margin-top: 1.00em;">
Is 1 if this is current active table</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<code class="lit">DM_TABLE_LENGTH</code></td>
<td class="list-col" style="margin-top: 1.00em;">
Logical length described by table</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<code class="lit">DM_TABLE_PARAMS</code></td>
<td class="list-col" style="margin-top: 1.00em;">
Params passed down to target</td>
</tr>
</tbody>
</table>
<p>
<b class="fname">libdm_table_set_start</b>() and <b class="fname">libdm_table_get_start</b>() Set start table from <i class="farg">start</i> value to <i class="farg">libdm_table</i> argument. Get routine will get the table start from kernel as <span class="type">libdm_table</span>.<p>
<b class="fname">libdm_table_set_length</b>() and <b class="fname">libdm_table_get_length</b>() Set table length from <i class="farg">length</i> value to <i class="farg">libdm_table</i> argument. Get routine will get the table length from kernel as <span class="type">libdm_table</span>.<p>
<b class="fname">libdm_table_set_target</b>() and <b class="fname">libdm_table_get_target</b>() Set target name from <i class="farg">target</i> value to <i class="farg">libdm_table</i> argument. The target must be actually present in the kernel, otherwise <b class="fname">libdm_task_run</b>() will fail. Get routine will get the table entry target from kernel as <span class="type">libdm_table</span>.<p>
<b class="fname">libdm_table_set_params</b>() and <b class="fname">libdm_table_get_params</b>() Set table target parameter string from <i class="farg">params</i> argument to <i class="farg">libdm_table</i>. This is later in the kernel passed to the target init routine. Get routine will get the table parameter string from kernel as <span class="type">libdm_table</span>.<p>
<b class="fname">libdm_table_get_status</b>() Get table status which can be Active/Inactive. This tells if this table is actually used or not.</div>
<div class="subsection">
<h2 id="x4c4942444d5f544152474554">LIBDM_TARGET</h2> <b class="fname">libdm_target_destroy</b>() Destroy target received from <span class="type">libdm_cmd</span> with libdm_cmd_iter iterator.<p>
<b class="fname">libdm_target_get_name</b>() returns pointer to a string with available target name.<p>
<b class="fname">lobdm_target_get_version</b>() Sets argument <i class="farg">ver[3]</i> to a in-kernel loaded target version.</div>
<div class="subsection">
<h2 id="x4c4942444d5f444556">LIBDM_DEV</h2> <b class="fname">libdm_dev_destroy</b>() Destroy device received from <span class="type">libdm_cmd</span> with libdm_cmd_iter iterator.<p>
<b class="fname">libdm_dev_get_name</b>() Return pointer to a string with underlying device name from <span class="type">libdm_dev_t</span><p>
<b class="fname">libdm_dev_get_minor</b>() Return underlying device minor number.</div>
<div class="subsection">
<h2 id="x4d495343">MISC</h2> <b class="fname">libdm_dev_set_newname</b>() This routine will set new dm device name attribute to <i class="farg">newname</i>. User must then called libdm_task_run on this task to change the device name.</div>
</div>
<div class="section">
<h1 id="x52455455524e2056414c554553">RETURN VALUES</h1> Upon success, all described functions return zero or non-<span class="define">NULL</span> pointer. Otherwise, an error number will be returned to indicate the error.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html4/dm.html">dm(4)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">dm</b> was written and contributed to <span class="unix">NetBSD</span> by <span class="author">Adam Hamsik</span> and first appeared in <span class="unix">NetBSD&#160;6.0</span>.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
January 22, 2011</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

