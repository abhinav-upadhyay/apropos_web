<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
KAFS(3)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
KAFS(3)</td>
<td class="head-vol" align="center">
Library Functions Manual</td>
<td class="head-rtitle" align="right">
KAFS(3)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">k_hasafs</b>, <b class="name">k_hasafs_recheck</b>, <b class="name">k_pioctl</b>, <b class="name">k_unlog</b>, <b class="name">k_setpag</b>, <b class="name">k_afs_cell_of_file</b>, <b class="name">kafs_set_verbose</b>, <b class="name">kafs_settoken_rxkad</b>, <b class="name">kafs_settoken</b>, <b class="name">krb_afslog</b>, <b class="name">krb_afslog_uid</b>, <b class="name">kafs_settoken5</b>, <b class="name">krb5_afslog</b>, <b class="name">krb5_afslog_uid</b> &#8212; <span class="desc">AFS library</span></div>
<div class="section">
<h1 id="x4c494252415259">LIBRARY</h1> AFS cache manager access library (libkafs, -lkafs)</div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">kafs.h</a>&gt;</b><p>
<i class="ftype">int</i><br>
<b class="fname">k_afs_cell_of_file</b>(<i class="farg" style="white-space:nowrap;">const char *path</i>, <i class="farg" style="white-space:nowrap;">char *cell</i>, <i class="farg" style="white-space:nowrap;">int len</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">k_hasafs</b>(<i class="farg" style="white-space:nowrap;">void</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">k_hasafs_recheck</b>(<i class="farg" style="white-space:nowrap;">void</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">k_pioctl</b>(<i class="farg" style="white-space:nowrap;">char *a_path</i>, <i class="farg" style="white-space:nowrap;">int o_opcode</i>, <i class="farg" style="white-space:nowrap;">struct ViceIoctl *a_paramsP</i>, <i class="farg" style="white-space:nowrap;">int a_followSymlinks</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">k_setpag</b>(<i class="farg" style="white-space:nowrap;">void</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">k_unlog</b>(<i class="farg" style="white-space:nowrap;">void</i>);<p>
<i class="ftype">void</i><br>
<b class="fname">kafs_set_verbose</b>(<i class="farg" style="white-space:nowrap;">void (*func)(void *, const char *, int)</i>, <i class="farg" style="white-space:nowrap;">void *</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">kafs_settoken_rxkad</b>(<i class="farg" style="white-space:nowrap;">const char *cell</i>, <i class="farg" style="white-space:nowrap;">struct ClearToken *token</i>, <i class="farg" style="white-space:nowrap;">void *ticket</i>, <i class="farg" style="white-space:nowrap;">size_t ticket_len</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">kafs_settoken</b>(<i class="farg" style="white-space:nowrap;">const char *cell</i>, <i class="farg" style="white-space:nowrap;">uid_t uid</i>, <i class="farg" style="white-space:nowrap;">CREDENTIALS *c</i>);<p>
<b class="fname">krb_afslog</b>(<i class="farg" style="white-space:nowrap;">char *cell</i>, <i class="farg" style="white-space:nowrap;">char *realm</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">krb_afslog_uid</b>(<i class="farg" style="white-space:nowrap;">char *cell</i>, <i class="farg" style="white-space:nowrap;">char *realm</i>, <i class="farg" style="white-space:nowrap;">uid_t uid</i>);<p>
<i class="ftype">krb5_error_code</i><br>
<b class="fname">krb5_afslog_uid</b>(<i class="farg" style="white-space:nowrap;">krb5_context context</i>, <i class="farg" style="white-space:nowrap;">krb5_ccache id</i>, <i class="farg" style="white-space:nowrap;">const char *cell</i>, <i class="farg" style="white-space:nowrap;">krb5_const_realm realm</i>, <i class="farg" style="white-space:nowrap;">uid_t uid</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">kafs_settoken5</b>(<i class="farg" style="white-space:nowrap;">const char *cell</i>, <i class="farg" style="white-space:nowrap;">uid_t uid</i>, <i class="farg" style="white-space:nowrap;">krb5_creds *c</i>);<p>
<i class="ftype">krb5_error_code</i><br>
<b class="fname">krb5_afslog</b>(<i class="farg" style="white-space:nowrap;">krb5_context context</i>, <i class="farg" style="white-space:nowrap;">krb5_ccache id</i>, <i class="farg" style="white-space:nowrap;">const char *cell</i>, <i class="farg" style="white-space:nowrap;">krb5_const_realm realm</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> <b class="fname">k_hasafs</b>() initializes some library internal structures, and tests for the presence of AFS in the kernel, none of the other functions should be called before <b class="fname">k_hasafs</b>() is called, or if it fails.<p>
<b class="fname">k_hasafs_recheck</b>() forces a recheck if a AFS client has started since last time <b class="fname">k_hasafs</b>() or <b class="fname">k_hasafs_recheck</b>() was called.<p>
<b class="fname">kafs_set_verbose</b>() set a log function that will be called each time the kafs library does something important so that the application using libkafs can output verbose logging. Calling the function <i class="farg">kafs_set_verbose</i> with the function argument set to <span class="define">NULL</span> will stop libkafs from calling the logging function (if set).<p>
<b class="fname">kafs_settoken_rxkad</b>() set <code class="lit">rxkad</code> with the <i class="farg">token</i> and <i class="farg">ticket</i> (that have the length <i class="farg">ticket_len</i>) for a given <i class="farg">cell</i>.<p>
<b class="fname">kafs_settoken</b>() and <b class="fname">kafs_settoken5</b>() work the same way as <b class="fname">kafs_settoken_rxkad</b>() but internally converts the Kerberos 4 or 5 credential to a afs cleartoken and ticket.<p>
<b class="fname">krb_afslog</b>(), and <b class="fname">krb_afslog_uid</b>() obtains new tokens (and possibly tickets) for the specified <i class="farg">cell</i> and <i class="farg">realm</i>. If <i class="farg">cell</i> is <span class="define">NULL</span>, the local cell is used. If <i class="farg">realm</i> is <span class="define">NULL</span>, the function tries to guess what realm to use. Unless you  have some good knowledge of what cell or realm to use, you should pass <span class="define">NULL</span>. <b class="fname">krb_afslog</b>() will use the real user-id for the <span class="define">ViceId</span> field in the token, <b class="fname">krb_afslog_uid</b>() will use <i class="farg">uid</i>.<p>
<b class="fname">krb5_afslog</b>(), and <b class="fname">krb5_afslog_uid</b>() are the Kerberos 5 equivalents of <b class="fname">krb_afslog</b>(), and <b class="fname">krb_afslog_uid</b>().<p>
<b class="fname">krb5_afslog</b>(), <b class="fname">kafs_settoken5</b>() can be configured to behave differently via a <b class="name">krb5_appdefault</b> option <code class="lit">afs-use-524</code> in <i class="file">krb5.conf</i>. Possible values for <code class="lit">afs-use-524</code> are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
yes</dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
use the 524 server in the realm to convert the ticket</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
no</dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
use the Kerberos 5 ticket directly, can be used with if the afs cell support 2b token.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
local, 2b</dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
convert the Kerberos 5 credential to a 2b token locally (the same work as a 2b 524 server should have done).</dd>
</dl>
<p>
Example:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
[appdefaults] 
	SU.SE = { afs-use-524 = local } 
	PDC.KTH.SE = { afs-use-524 = yes } 
	afs-use-524 = yes</pre>
<p>
libkafs will use the <code class="lit">libkafs</code> as application name when running the <b class="name">krb5_appdefault</b> function call.<p>
The (uppercased) cell name is used as the realm to the <b class="name">krb5_appdefault function.</b><p>
<b class="fname">k_afs_cell_of_file</b>() will in <i class="farg">cell</i> return the cell of a specified file, no more than <i class="farg">len</i> characters is put in <i class="farg">cell</i>.<p>
<b class="fname">k_pioctl</b>() does a <b class="fname">pioctl</b>() system call with the specified arguments. This function is equivalent to <b class="fname">lpioctl</b>().<p>
<b class="fname">k_setpag</b>() initializes a new PAG.<p>
<b class="fname">k_unlog</b>() removes destroys all tokens in the current PAG.</div>
<div class="section">
<h1 id="x52455455524e2056414c554553">RETURN VALUES</h1> <b class="fname">k_hasafs</b>() returns 1 if AFS is present in the kernel, 0 otherwise. <b class="fname">krb_afslog</b>() and <b class="fname">krb_afslog_uid</b>() returns 0 on success, or a Kerberos error number on failure. <b class="fname">k_afs_cell_of_file</b>(), <b class="fname">k_pioctl</b>(), <b class="fname">k_setpag</b>(), and <b class="fname">k_unlog</b>() all return the value of the underlaying system call, 0 on success.</div>
<div class="section">
<h1 id="x454e5649524f4e4d454e54">ENVIRONMENT</h1> The following environment variable affect the mode of operation of <b class="name">kafs</b>:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="env">AFS_SYSCALL</span></dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
Normally, <b class="name">kafs</b> will try to figure out the correct system call(s) that are used by AFS by itself.  If it does not manage to do that, or does it incorrectly, you can set this variable to the system call number or list of system call numbers that should be used.</dd>
</dl>
</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> The following code from <b class="name">login</b> will obtain a new PAG and tokens for the local cell and the cell of the users home directory.<p>
<pre style="margin-left: 0.00ex;" class="lit display">
if (k_hasafs()) { 
	char cell[64]; 
	k_setpag(); 
	if(k_afs_cell_of_file(pwd-&gt;pw_dir, cell, sizeof(cell)) == 0) 
		krb_afslog(cell, NULL); 
	krb_afslog(NULL, NULL); 
}</pre>
</div>
<div class="section">
<h1 id="x4552524f5253">ERRORS</h1> If any of these functions (apart from <b class="fname">k_hasafs</b>()) is called without AFS being present in the kernel, the process will usually (depending on the operating system) receive a SIGSYS signal.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../3/krb5_appdefault">krb5_appdefault(3)</a>, <a class="link-man" href="../5/krb5.conf">krb5.conf(5)</a><p>
<span class="ref"><span class="ref-auth">Transarc Corporation</span>, <span class="ref-title">File Server/Cache Manager Interface</span>, <i class="ref-jrnl">AFS-3 Programmer's Reference</i>, <span class="ref-date">1991</span>.</span></div>
<div class="section">
<h1 id="x46494c4553">FILES</h1> libkafs will search for <i class="file">ThisCell and</i> <i class="file">TheseCells</i> in the following locations: <i class="file">/usr/vice/etc</i>, <i class="file">/etc/openafs</i>, <i class="file">/var/db/openafs/etc</i>, <i class="file">/usr/arla/etc</i>, <i class="file">/etc/arla</i>, and <i class="file">/etc/afs</i></div>
<div class="section">
<h1 id="x42554753">BUGS</h1> <span class="env">AFS_SYSCALL</span> has no effect under AIX.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
May 1, 2006</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

