<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
CRYPTO(4)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
CRYPTO(4)</td>
<td class="head-vol" align="center">
Kernel Interfaces Manual</td>
<td class="head-rtitle" align="right">
CRYPTO(4)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">crypto</b>, <b class="name">swcrypto</b> &#8212; <span class="desc">user-mode access to hardware-accelerated cryptography</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="config">hifn*   at pci? dev ? function ?</b><br>
<b class="config">ubsec*  at pci? dev ? function ?</b><p>
<br>
<b class="config">pseudo-device crypto</b><br>
<b class="config">pseudo-device swcrypto</b><p>
<br>
<b class="includes">#include &lt;<a class="link-includes">sys/ioctl.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">sys/time.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">crypto/cryptodev.h</a>&gt;</b></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">crypto</b> driver gives user-mode applications access to hardware-accelerated cryptographic transforms, as implemented by the <a class="link-man" href="../html9/opencrypto.html">opencrypto(9)</a> in-kernel interface.<p>
The <b class="flag">swcrypto</b> driver is a software-only implementation of the <a class="link-man" href="../html9/opencrypto.html">opencrypto(9)</a> interface, and must be included to use the interface without hardware acceleration.<p>
The <i class="file">/dev/crypto</i> special device provides an <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a> based interface. User-mode applications should open the special device, then issue <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a> calls on the descriptor. User-mode access to <i class="file">/dev/crypto</i> is generally controlled by three <a class="link-man" href="../html8/sysctl.html">sysctl(8)</a> variables, <b class="cmd">kern.usercrypto</b>, <b class="cmd">kern.userasymcrypto</b>, and <b class="cmd">kern.cryptodevallowsoft</b>. See <a class="link-man" href="../html7/sysctl.html">sysctl(7)</a> for additional details.<p>
The <b class="name">crypto</b> device provides two distinct modes of operation: one mode for symmetric-keyed cryptographic requests, and a second mode for both asymmetric-key (public-key/private-key) requests, and for modular arithmetic (for Diffie-Hellman key exchange and other cryptographic protocols). The two modes are described separately below.</div>
<div class="section">
<h1 id="x5448454f5259204f46204f5045524154494f4e">THEORY OF OPERATION</h1> Regardless of whether symmetric-key or asymmetric-key operations are to be performed, use of the device requires a basic series of steps:<ol style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-enum">
<li class="list-enum" style="margin-top: 1.00em;">
Open a file descriptor for the device. See <a class="link-man" href="../html2/open.html">open(2)</a>.</li>
<li class="list-enum" style="margin-top: 1.00em;">
If any symmetric operation will be performed, create one session, with <span class="define">CIOCGSESSION</span>, or multiple sessions, with <span class="define">CIOCNGSESSION</span>. Most applications will require at least one symmetric session. Since cipher and MAC keys are tied to sessions, many applications will require more. Asymmetric operations do not use sessions.</li>
<li class="list-enum" style="margin-top: 1.00em;">
Submit requests, synchronously with <span class="define">CIOCCRYPT</span> (symmetric) or <span class="define">CIOCKEY</span> (asymmetric) or asynchronously with <span class="define">CIOCNCRYPTM</span> (symmetric) or <span class="define">CIOCNFKEYM</span> (asymmetric). The asynchronous interface allows multiple requests to be submitted in one call if the user so desires.</li>
<li class="list-enum" style="margin-top: 1.00em;">
If the asynchronous interface is used, wait for results with <a class="link-man" href="../html2/select.html">select(2)</a> or <a class="link-man" href="../html2/poll.html">poll(2)</a>, then collect them with <span class="define">CIOCNCRYPTRET</span> (a particular request) or <span class="define">CIOCNCRYPTRETM</span> (multiple requests).</li>
<li class="list-enum" style="margin-top: 1.00em;">
Destroy one session with <span class="define">CIOCFSESSION</span> or many at once with <span class="define">CIOCNFSESSION</span>.</li>
<li class="list-enum" style="margin-top: 1.00em;">
Close the device with <a class="link-man" href="../html2/close.html">close(2)</a>.</li>
</ol>
</div>
<div class="section">
<h1 id="x53594d4d45545249431e4b4559204f5045524154494f4e">SYMMETRIC-KEY OPERATION</h1> The symmetric-key operation mode provides a context-based API to traditional symmetric-key encryption (or privacy) algorithms, or to keyed and unkeyed one-way hash (HMAC and MAC) algorithms. The symmetric-key mode also permits fused operation, where the hardware performs both a privacy algorithm and an integrity-check algorithm in a single pass over the data: either a fused encrypt/HMAC-generate operation, or a fused HMAC-verify/decrypt operation.<p>
To use symmetric mode, you must first create a session specifying the algorithm(s) and key(s) to use; then issue encrypt or decrypt requests against the session.<div class="subsection">
<h2 id="x53796d6d65747269631e6b6579207072697661637920616c676f726974686d73">Symmetric-key privacy algorithms</h2> Contingent upon device drivers for installed cryptographic hardware registering with <a class="link-man" href="../html9/opencrypto.html">opencrypto(9)</a>, as providers of a given algorithm, some or all of the following symmetric-key privacy algorithms may be available:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_DES_CBC</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_3DES_CBC</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_BLF_CBC</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_CAST_CBC</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_SKIPJACK_CBC</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_AES_CBC</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_ARC4</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x496e746567726974791e636865636b206f7065726174696f6e73">Integrity-check operations</h2> Contingent upon hardware support, some or all of the following keyed one-way hash algorithms may be available:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_RIPEMD160_HMAC</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_MD5_KPDK</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_SHA1_KPDK</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_MD5_HMAC</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_SHA1_HMAC</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_SHA2_256_HMAC</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_SHA2_384_HMAC</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_SHA2_512_HMAC</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_MD5</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
CRYPTO_SHA1</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
</dd>
</dl>
<p>
The <span class="emph">CRYPTO_MD5</span> and <span class="emph">CRYPTO_SHA1</span> algorithms are actually unkeyed, but should be requested as symmetric-key hash algorithms with a zero-length key.</div>
<div class="subsection">
<h2 id="x494f43544c2052657175657374204465736372697074696f6e73">IOCTL Request Descriptions</h2><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CRIOGET</span> <i class="farg">int *fd</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
This operation is deprecated and will be removed after <span class="unix">NetBSD&#160;5.0</span>. It clones the fd argument to <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>, yielding a new file descriptor for the creation of sessions. Because the device now clones on open, this operation is unnecessary.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CIOCGSESSION</span> <i class="farg">struct session_op *sessp</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct session_op { 
    u_int32_t cipher;	/* e.g. CRYPTO_DES_CBC */ 
    u_int32_t mac;	/* e.g. CRYPTO_MD5_HMAC */ 
 
    u_int32_t keylen;	/* cipher key */ 
    void * key; 
    int mackeylen;	/* mac key */ 
    void * mackey; 
 
    u_int32_t ses;	/* returns: ses # */ 
}; 
</pre>
Create a new cryptographic session on a file descriptor for the device; that is, a persistent object specific to the chosen privacy algorithm, integrity algorithm, and keys specified in <i class="farg">sessp</i>. The special value 0 for either privacy or integrity is reserved to indicate that the indicated operation (privacy or integrity) is not desired for this session.<p>
Multiple sessions may be bound to a single file descriptor. The session ID returned in <i class="farg">sessp-&gt;ses</i> is supplied as a required field in the symmetric-operation structure <i class="farg">crypt_op</i> for future encryption or hashing requests.<p>
This implementation will never return a session ID of 0 for a successful creation of a session, which is a <span class="unix">NetBSD</span> extension.<p>
For non-zero symmetric-key privacy algorithms, the privacy algorithm must be specified in <i class="farg">sessp-&gt;cipher</i>, the key length in <i class="farg">sessp-&gt;keylen</i>, and the key value in the octets addressed by <i class="farg">sessp-&gt;key</i>.<p>
For keyed one-way hash algorithms, the one-way hash must be specified in <i class="farg">sessp-&gt;mac</i>, the key length in <i class="farg">sessp-&gt;mackey</i>, and the key value in the octets addressed by <i class="farg">sessp-&gt;mackeylen</i>.<p>
Support for a specific combination of fused privacy  and integrity-check algorithms depends on whether the underlying hardware supports that combination. Not all combinations are supported by all hardware, even if the hardware supports each operation as a stand-alone non-fused operation.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CIOCNGSESSION</span> <i class="farg">struct crypt_sgop *sgop</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct crypt_sgop { 
    size_t	count;			/* how many */ 
    struct session_n_op * sessions; /* where to get them */ 
}; 
 
struct session_n_op { 
    u_int32_t cipher;		/* e.g. CRYPTO_DES_CBC */ 
    u_int32_t mac;		/* e.g. CRYPTO_MD5_HMAC */ 
 
    u_int32_t keylen;		/* cipher key */ 
    void * key; 
    u_int32_t mackeylen;	/* mac key */ 
    void * mackey; 
 
    u_int32_t ses;		/* returns: session # */ 
    int status; 
}; 
</pre>
Create one or more sessions. Takes a counted array of <i class="farg">session_n_op</i> structures in <i class="farg">sgop</i>. For each requested session (array element n), the session number is returned in <i class="farg">sgop-&gt;sessions[n].ses</i> and the status for that session creation in <i class="farg">sgop-&gt;sessions[n].status</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CIOCCRYPT</span> <i class="farg">struct crypt_op *cr_op</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct crypt_op { 
    u_int32_t ses; 
    u_int16_t op;	/* e.g. COP_ENCRYPT */ 
    u_int16_t flags; 
    u_int len; 
    void * src, *dst; 
    void * mac;		/* must be large enough for result */ 
    void * iv; 
}; 
</pre>
Request a symmetric-key (or hash) operation. The file descriptor argument to <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a> must have been bound to a valid session. To encrypt, set <i class="farg">cr_op-&gt;op</i> to <span class="define">COP_ENCRYPT</span>. To decrypt, set <i class="farg">cr_op-&gt;op</i> to <span class="define">COP_DECRYPT</span>. The field <i class="farg">cr_op-&gt;len</i> supplies the length of the input buffer; the fields <i class="farg">cr_op-&gt;src</i>, <i class="farg">cr_op-&gt;dst</i>, <i class="farg">cr_op-&gt;mac</i>, <i class="farg">cr_op-&gt;iv</i> supply the addresses of the input buffer, output buffer, one-way hash, and initialization vector, respectively.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CIOCNCRYPTM</span> <i class="farg">struct crypt_mop *cr_mop</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct crypt_mop { 
    size_t count;		/* how many */ 
    struct crypt_n_op * reqs;	/* where to get them */ 
}; 
 
struct crypt_n_op { 
    u_int32_t ses; 
    u_int16_t op;		/* e.g. COP_ENCRYPT */ 
    u_int16_t flags; 
    u_int len; 
 
    u_int32_t reqid;		/* request id */ 
    int status;			/* accepted or not */ 
 
    void *opaque;		/* opaque pointer ret to user */ 
    u_int32_t keylen;		/* cipher key - optional */ 
    void * key; 
    u_int32_t mackeylen;	/* mac key - optional */ 
    void * mackey; 
 
    void * src, * dst; 
    void * mac; 
    void * iv; 
}; 
</pre>
This is the asynchronous version of CIOCCRYPT, which allows multiple symmetric-key (or hash) operations to be started (see CIOCRYPT above for the details for each operation).<p>
The <i class="farg">cr_mop-&gt;count</i> field specifies the number of operations provided in the cr_mop-&gt;reqs array.<p>
Each operation is assigned a unique request id returned in the <i class="farg">cr_mop-&gt;reqs[n].reqid</i> field.<p>
Each operation can accept an opaque value from the user to be passed back to the user when the operation completes (e.g., to track context for the request). The opaque field is <i class="farg">cr_mop-&gt;reqs[n].opaque</i>.<p>
If a problem occurs with starting any of the operations then that operation's <i class="farg">cr_mop-&gt;reqs[n].status</i> field is filled with the error code. The failure of an operation does not prevent the other operations from being started.<p>
The <a class="link-man" href="../html2/select.html">select(2)</a> or <a class="link-man" href="../html2/poll.html">poll(2)</a> functions must be used on the device file descriptor to detect that some operation has completed; results are then retrieved with <span class="define">CIOCNCRYPTRETM</span>.<p>
The <i class="farg">key</i> and <i class="farg">mackey</i> fields of the operation structure are currently unused. They are intended for use to immediately rekey an existing session before processing a new request.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CIOCFSESSION</span> <i class="farg">u_int32_t *ses_id</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Destroys the /dev/crypto session associated with the file-descriptor argument.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CIOCNFSESSION</span> <i class="farg">struct crypt_sfop *sfop</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct crypt_sfop { 
    size_t count; 
    u_int32_t *sesid; 
}; 
</pre>
Destroys the <i class="farg">sfop-&gt;count</i> sessions specified by the <i class="farg">sfop</i> array of session identifiers.</dd>
</dl>
</div>
</div>
<div class="section">
<h1 id="x4153594d4d45545249431e4b4559204f5045524154494f4e">ASYMMETRIC-KEY OPERATION</h1><div class="subsection">
<h2 id="x4173796d6d65747269631e6b657920616c676f726974686d73">Asymmetric-key algorithms</h2> Contingent upon hardware support, the following asymmetric (public-key/private-key; or key-exchange subroutine) operations may also be available:<p>
<table style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-col">
<col style="width: 18.00ex;">
<col style="width: 15.00ex;">
<col style="min-width: 16.00ex;">
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 0.00em;">
<span class="emph">Algorithm</span></td>
<td class="list-col" style="margin-top: 0.00em;">
Input parameter</td>
<td class="list-col" style="margin-top: 0.00em;">
Output parameter</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 0.00em;">
<span class="emph"> </span></td>
<td class="list-col" style="margin-top: 0.00em;">
Count</td>
<td class="list-col" style="margin-top: 0.00em;">
Count</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 0.00em;">
<span class="define">CRK_MOD_EXP</span></td>
<td class="list-col" style="margin-top: 0.00em;">
3</td>
<td class="list-col" style="margin-top: 0.00em;">
1</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 0.00em;">
<span class="define">CRK_MOD_EXP_CRT</span></td>
<td class="list-col" style="margin-top: 0.00em;">
6</td>
<td class="list-col" style="margin-top: 0.00em;">
1</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 0.00em;">
<span class="define">CRK_MOD_ADD</span></td>
<td class="list-col" style="margin-top: 0.00em;">
3</td>
<td class="list-col" style="margin-top: 0.00em;">
1</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 0.00em;">
<span class="define">CRK_MOD_ADDINV</span></td>
<td class="list-col" style="margin-top: 0.00em;">
2</td>
<td class="list-col" style="margin-top: 0.00em;">
1</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 0.00em;">
<span class="define">CRK_MOD_SUB</span></td>
<td class="list-col" style="margin-top: 0.00em;">
3</td>
<td class="list-col" style="margin-top: 0.00em;">
1</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 0.00em;">
<span class="define">CRK_MOD_MULT</span></td>
<td class="list-col" style="margin-top: 0.00em;">
3</td>
<td class="list-col" style="margin-top: 0.00em;">
1</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 0.00em;">
<span class="define">CRK_MOD_MULTINV</span></td>
<td class="list-col" style="margin-top: 0.00em;">
2</td>
<td class="list-col" style="margin-top: 0.00em;">
1</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 0.00em;">
<span class="define">CRK_MOD</span></td>
<td class="list-col" style="margin-top: 0.00em;">
2</td>
<td class="list-col" style="margin-top: 0.00em;">
1</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 0.00em;">
<span class="define">CRK_DSA_SIGN</span></td>
<td class="list-col" style="margin-top: 0.00em;">
5</td>
<td class="list-col" style="margin-top: 0.00em;">
2</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 0.00em;">
<span class="define">CRK_DSA_VERIFY</span></td>
<td class="list-col" style="margin-top: 0.00em;">
7</td>
<td class="list-col" style="margin-top: 0.00em;">
0</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 0.00em;">
<span class="define">CRK_DH_COMPUTE_KEY</span></td>
<td class="list-col" style="margin-top: 0.00em;">
3</td>
<td class="list-col" style="margin-top: 0.00em;">
1</td>
</tr>
</tbody>
</table>
<p>
See below for discussion of the input and output parameter counts.</div>
<div class="subsection">
<h2 id="x4173796d6d65747269631e6b657920636f6d6d616e6473">Asymmetric-key commands</h2><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CIOCASYMFEAT</span> <i class="farg">int *feature_mask</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Returns a bitmask of supported asymmetric-key operations. Each of the above-listed asymmetric operations is present if and only if the bit position numbered by the code for that operation is set. For example, <span class="define">CRK_MOD_EXP</span> is available if and only if the bit (1 &lt;&lt; <span class="define">CRK_MOD_EXP</span>) is set.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CIOCKEY</span> <i class="farg">struct crypt_kop *kop</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct crypt_kop { 
    u_int crk_op;		/* e.g. CRK_MOD_EXP */ 
    u_int crk_status;		/* return status */ 
    u_short crk_iparams;	/* # of input params */ 
    u_short crk_oparams;	/* # of output params */ 
    u_int crk_pad1; 
    struct crparam crk_param[CRK_MAXPARAM]; 
}; 
 
/* Bignum parameter, in packed bytes. */ 
struct crparam { 
    void * crp_p; 
    u_int crp_nbits; 
}; 
</pre>
Performs an asymmetric-key operation from the list above. The specific operation is supplied in <i class="farg">kop-&gt;crk_op</i>; final status for the operation is returned in <i class="farg">kop-&gt;crk_status</i>. The number of input arguments and the number of output arguments is specified in <i class="farg">kop-&gt;crk_iparams</i> and <i class="farg">kop-&gt;crk_iparams</i>, respectively. The field <i class="farg">crk_param[]</i> must be filled in with exactly <i class="farg">kop-&gt;crk_iparams + kop-&gt;crk_oparams</i> arguments, each encoded as a <i class="farg">struct crparam</i> (address, bitlength) pair.<p>
The semantics of these arguments are currently undocumented.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CIOCNFKEYM</span> <i class="farg">struct crypt_mkop *mkop</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct crypt_mkop { 
    size_t count;		/* how many */ 
    struct crypt_n_op * reqs;	/* where to get them */ 
}; 
 
struct crypt_n_kop { 
    u_int crk_op;		/* e.g. CRK_MOD_EXP */ 
    u_int crk_status;		/* accepted or not */ 
    u_short crk_iparams;	/* # of input params */ 
    u_short crk_oparams;	/* # of output params */ 
    u_int32_t crk_reqid;	/* request id */ 
    struct crparam crk_param[CRK_MAXPARAM]; 
    void *crk_opaque;		/* opaque pointer ret to user */ 
}; 
</pre>
This is the asynchronous version of <span class="define">CIOCKEY</span>, which starts one or more key operations. See <span class="define">CIOCNCRYPTM</span> above and <span class="define">CIOCNCRYPTRETM</span> below for descriptions of the <i class="farg">mkop&gt;count</i>, <i class="farg">mkop&gt;reqs</i>, <i class="farg">mkop&gt;reqs[n].crk_reqid</i>, <i class="farg">mkop&gt;reqs[n].crk_status</i>, and <i class="farg">mkop&gt;reqs[n].crk_opaque</i> fields of the argument structure, and result retrieval.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x4173796e6368726f6e6f75732073746174757320636f6d6d616e6473">Asynchronous status commands</h2> When requests are submitted with the <span class="define">CIOCNCRYPTM</span> or <span class="define">CIOCNFKEYM</span> commands, result retrieval is asynchronous (the submit ioctls return immediately). Use the <a class="link-man" href="../html2/select.html">select(2)</a> or <a class="link-man" href="../html2/poll.html">poll(2)</a> functions to determine when the file descriptor has completed operations ready to be retrieved.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CIOCNCRYPTRET</span> <i class="farg">struct crypt_result *cres</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct crypt_result { 
    u_int32_t reqid;	/* request ID */ 
    u_int32_t status;	/* 0 if successful */ 
    void * opaque;	/* pointer from user */ 
}; 
</pre>
Check for the status of the request specified by <i class="farg">cres-&gt;reqid</i>. This requires a linear search through all completed requests and should be used with extreme care if the number of requests pending on this file descriptor may be large.<p>
The <i class="farg">cres-&gt;status</i> field is set as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
0</dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
The request has completed, and its results have been copied out to the original <i class="farg">crypt_n_op or</i> <i class="farg">crypt_n_kop</i> structure used to start the request. The copyout occurs during this ioctl, so the calling process must be the process that started the request.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
EINPROGRESS</dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
The request has not yet completed.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
EINVAL</dt>
<dd class="list-tag" style="margin-left: 11.00ex;">
The request was not found.</dd>
</dl>
<p>
Other values indicate a problem during the processing of the request.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">CIOCNCRYPTRETM</span> <i class="farg">struct cryptret_t *cret</i></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct cryptret { 
    size_t count;			/* space for how many */ 
    struct crypt_result * results;	/* where to put them */ 
}; 
</pre>
Retrieve a number of completed requests. This ioctl accepts a count and an array (each array element is a <i class="farg">crypt_result_t</i> structure as used by <span class="define">CIOCNCRYPTRET</span> above) and fills the array with up to <i class="farg">cret-&gt;count</i> results of completed requests.<p>
This ioctl fills in the <i class="farg">cret-&gt;results[n].reqid field</i>, so that the request which has completed may be identified by the application. Note that the results may include requests submitted both as symmetric and asymmetric operations.</dd>
</dl>
</div>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html4/hifn.html">hifn(4)</a>, <a class="link-man" href="../html4/ubsec.html">ubsec(4)</a>, <a class="link-man" href="../html9/opencrypto.html">opencrypto(9)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">crypto</b> driver is derived from a version which appeared in <span class="unix">FreeBSD&#160;4.8</span>, which in turn is based on code which appeared in <span class="unix">OpenBSD&#160;3.2</span>.<p>
The "new API" for asynchronous operation with multiple basic operations per system call (the "N" ioctl variants) was contributed by Coyote Point Systems, Inc. and first appeared in <span class="unix">NetBSD&#160;5.0</span>.</div>
<div class="section">
<h1 id="x42554753">BUGS</h1> Error checking and reporting is weak.<p>
The values specified for symmetric-key key sizes to <span class="define">CIOCGSESSION</span> must exactly match the values expected by <a class="link-man" href="../html9/opencrypto.html">opencrypto(9)</a>. The output buffer and MAC buffers supplied to <span class="define">CIOCCRYPT</span> must follow whether privacy or integrity algorithms were specified for session: if you request a non-<span class="define">NULL</span> algorithm, you must supply a suitably-sized buffer.<p>
The scheme for passing arguments for asymmetric requests is baroque.<p>
The naming inconsistency between <span class="define">CRIOGET</span> and the various <span class="define">CIOC</span>* names is an unfortunate historical artifact.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
January 27, 2014</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

