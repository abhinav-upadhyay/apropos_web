<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
CARP(4)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
CARP(4)</td>
<td class="head-vol" align="center">
Kernel Interfaces Manual</td>
<td class="head-rtitle" align="right">
CARP(4)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">carp</b> &#8212; <span class="desc">Common Address Redundancy Protocol</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="config">pseudo-device carp</b></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">carp</b> interface is a pseudo-device which implements and controls the CARP protocol. <b class="name">carp</b> allows multiple hosts on the same local network to share a set of IP addresses. Its primary purpose is to ensure that these addresses are always available, but in some configurations <b class="name">carp</b> can also provide load balancing functionality.<p>
A <b class="name">carp</b> interface can be created at runtime using the <b class="cmd">ifconfig carp</b><i class="arg">N</i> <b class="cmd">create</b> command.<p>
To use <b class="name">carp</b>, the administrator needs to configure at minimum a common virtual host ID and virtual host IP address on each machine which is to take part in the virtual group. Additional parameters can also be set on a per-interface basis: <b class="flag">advbase</b> and <b class="flag">advskew</b>, which are used to control how frequently the host sends advertisements when it is the master for a virtual host, and <b class="flag">pass</b> which is used to authenticate carp advertisements. Finally <b class="flag">carpdev</b> is used to specify which interface the <b class="name">carp</b> device attaches to. If unspecified, the kernel attempts to set carpdev by looking for another interface with the same subnet. These configurations can be done using <a class="link-man" href="../8/ifconfig">ifconfig(8)</a>, or through the <span class="define">SIOCSVH</span> ioctl.<p>
Additionally, there are a number of global parameters which can be set using <a class="link-man" href="../8/sysctl">sysctl(8)</a>:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
net.inet.carp.allow</dt>
<dd class="list-tag" style="margin-left: 26.00ex;">
Accept incoming <b class="name">carp</b> packets. Enabled by default.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
net.inet.carp.preempt</dt>
<dd class="list-tag" style="margin-left: 26.00ex;">
Allow virtual hosts to preempt each other. It is also used to failover <b class="name">carp</b> interfaces as a group. When the option is enabled and one of the <b class="name">carp</b> enabled physical interfaces goes down, advskew is changed to 240 on all <b class="name">carp</b> interfaces. See also the first example. Disabled by default.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
net.inet.carp.log</dt>
<dd class="list-tag" style="margin-left: 26.00ex;">
Log bad <b class="name">carp</b> packets. Disabled by default.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
net.inet.carp.arpbalance</dt>
<dd class="list-tag" style="margin-left: 26.00ex;">
Balance local traffic using ARP. Disabled by default.</dd>
</dl>
</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> For firewalls and routers with multiple interfaces, it is desirable to failover all of the <b class="name">carp</b> interfaces together, when one of the physical interfaces goes down. This is achieved by the preempt option. Enable it on both host A and B:<p>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit"># sysctl -w net.inet.carp.preempt=1</code></div>
</blockquote>
<p>
Assume that host A is the preferred master and 192.168.1.x/24 is configured on one physical interface and 192.168.2.y/24 on another. This is the setup for host A:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
# ifconfig carp0 create 
# ifconfig carp0 vhid 1 pass mekmitasdigoat 192.168.1.1 &#92; 
	netmask 255.255.255.0 
# ifconfig carp1 create 
# ifconfig carp1 vhid 2 pass mekmitasdigoat 192.168.2.1/24 &#92; 
	netmask 255.255.255.0</pre>
<p>
The setup for host B is identical, but it has a higher advskew:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
# ifconfig carp0 create 
# ifconfig carp0 vhid 1 advskew 100 pass mekmitasdigoat &#92; 
	192.168.1.1 netmask 255.255.255.0 
# ifconfig carp1 create 
# ifconfig carp1 vhid 2 advskew 100 pass mekmitasdigoat &#92; 
	192.168.2.1 netmask 255.255.255.0</pre>
<p>
Because of the preempt option, when one of the physical interfaces of host A fails, advskew is adjusted to 240 on all its <b class="name">carp</b> interfaces. This will cause host B to preempt on both interfaces instead of just the failed one.<p>
In order to set up an ARP balanced virtual host, it is necessary to configure one virtual host for each physical host which would respond to ARP requests and thus handle the traffic. In the following example, two virtual hosts are configured on two hosts to provide balancing and failover for the IP address 192.168.1.10.<p>
First the <b class="name">carp</b> interfaces on Host A are configured. The <b class="flag">advskew</b> of 100 on the second virtual host means that its advertisements will be sent out slightly less frequently.<p>
<pre style="margin-left: 5.00ex;" class="lit display">
# ifconfig carp0 create 
# ifconfig carp0 vhid 1 pass mekmitasdigoat 192.168.1.10 &#92; 
	netmask 255.255.255.0 
# ifconfig carp1 create 
# ifconfig carp1 vhid 2 advskew 100 pass mekmitasdigoat &#92; 
	192.168.1.10 netmask 255.255.255.0</pre>
<p>
The configuration for host B is identical, except the skew is on virtual host 1 rather than virtual host 2.<p>
<pre style="margin-left: 5.00ex;" class="lit display">
# ifconfig carp0 create 
# ifconfig carp0 vhid 1 advskew 100 pass mekmitasdigoat &#92; 
	192.168.1.10 netmask 255.255.255.0 
# ifconfig carp1 create 
# ifconfig carp1 vhid 2 pass mekmitasdigoat 192.168.1.10 &#92; 
	netmask 255.255.255.0</pre>
<p>
Finally, the ARP balancing feature must be enabled on both hosts:<p>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit"># sysctl -w net.inet.carp.arpbalance=1</code></div>
</blockquote>
<p>
When the hosts receive an ARP request for 192.168.1.10, the source IP address of the request is used to compute which virtual host should answer the request. The host which is master of the selected virtual host will reply to the request, the other(s) will ignore it.<p>
This way, locally connected systems will receive different ARP replies and subsequent IP traffic will be balanced among the hosts. If one of the hosts fails, the other will take over the virtual MAC address, and begin answering ARP requests on its behalf.<p>
Note: ARP balancing only works on the local network segment. It cannot balance traffic that crosses a router, because the router itself will always be balanced to the same virtual host.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../1/netstat">netstat(1)</a>, <a class="link-man" href="../3/sysctl">sysctl(3)</a>, <a class="link-man" href="../4/arp">arp(4)</a>, <a class="link-man" href="../8/arp">arp(8)</a>, <a class="link-man" href="../8/ifconfig">ifconfig(8)</a>, <a class="link-man" href="../8/sysctl">sysctl(8)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">carp</b> device first appeared in <span class="unix">OpenBSD&#160;3.5</span>.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
November 30, 2013</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

