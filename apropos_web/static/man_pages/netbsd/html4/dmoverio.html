<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/../4/strict.dtd">
>
<head>
<meta http-equiv="Content-Type" content="te../; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
DMOVERIO(4)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
DMOVERIO(4)</td>
<td class="head-vol" align="center">
Kernel Interfaces Manual</td>
<td class="head-rtitle" align="right">
DMOVERIO(4)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">dmoverio</b> &#8212; <span class="desc">hardware-assisted data mover interface</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="config">pseudo-device dmoverio</b><p>
<br>
<b class="includes">#include &lt;<a class="link-includes">dev/dmover/dmover_io.h</a>&gt;</b></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">dmoverio</b> pseudo-device driver provides an interface to hardware-assisted data movers, which the kernel supports using the <a class="link-man" href="../9/dmover">dmover(9)</a> facility.  This can be used to copy data from one location in memory to another, clear a region of memory, fill a region of memory with a pattern, and perform simple operations on multiple regions of memory, such as an XOR, without intervention by the CPU.<p>
A <b class="name">dmoverio</b> function always has one output region.  A function may have zero or more input regions, or may use an immediate value as an input.  For functions which use input regions, the lengths of each input region and the output region must be the same.  All <b class="name">dmoverio</b> functions with the same name will have the same number of and type inputs.<p>
To use <b class="name">dmoverio</b>, the client must first create a session.  This is achieved by performing the following steps:<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-bul">
<li class="list-bul" style="margin-top: 1.00em;">
Create a session handle by opening the <i class="file">/dev/dmoverio</i> device.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Select the <b class="name">dmoverio</b> function using the DMIO_SETFUNC ioctl, which takes the following argument:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
#define DMIO_MAX_FUNCNAME     64 
struct dmio_setfunc { 
        char dsf_name[DMIO_MAX_FUNCNAME]; 
};</pre>
<p>
If the specified function is not available, the DMIO_SETFUNC ioctl will fail with an error code of <span class="errno">ESRCH</span>.</li>
</ul>
<p>
To submit a request for processing the following steps must be performed:<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-bul">
<li class="list-bul" style="margin-top: 1.00em;">
Fill in a request structure:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
typedef struct { 
        struct iovec *dmbuf_iov; 
        u_int dmbuf_iovcnt; 
} dmio_buffer; 
 
struct dmio_usrreq { 
        /* Output buffer. */ 
        dmio_buffer req_outbuf; 
 
        /* Input buffer. */ 
        union { 
                uint8_t _immediate[8]; 
                dmio_buffer *_inbuf; 
        } _req_inbuf_un; 
 
#define req_immediate           _req_inbuf_un._immediate 
#define req_inbuf               _req_inbuf_un._inbuf 
 
        uint32_t req_id;        /* request ID; passed in response */ 
};</pre>
<p>
For functions which use an immediate value as an input, the <span class="emph">req_immediate</span> member is used to specify the value.  Values smaller than 8 bytes should use the least-significant bytes first.  For example, a 32-bit integer would occupy bytes 0, 1, 2, and 3.<p>
For functions which use input regions, <span class="emph">req_inbuf</span> should point to an array of <i class="farg">dmio_buffer</i>'s.<p>
The <span class="emph">req_id</span> should be a unique value for each request submitted by the client.  It will be passed back unchanged in the response when processing of the request has completed.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Write the request structure to the session handle using the <a class="link-man" href="../2/write">write(2)</a> system call.  Multiple requests may be written to the session in a single call.</li>
<li class="list-bul" style="margin-top: 1.00em;">
Read the response structure back from the session handle using the <a class="link-man" href="../2/read">read(2)</a> system call.  The response structure is defined as follows:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
struct dmio_usrresp { 
        uint32_t resp_id; 
        int resp_error; 
};</pre>
<p>
The <span class="emph">resp_id</span> corresponds to the <span class="emph">req_id</span> in the request. <span class="emph">resp_error</span> contains 0 if the request succeeded or an <a class="link-man" href="../2/errno">errno(2)</a> value indicating why the request failed.  Multiple responses may be read back in a single call.  Note that responses may not be received in the same order as requests were written.</li>
</ul>
<p>
When a client is finished using a <b class="name">dmoverio</b> session, the session is destroyed by closing the session handle using <a class="link-man" href="../2/close">close(2)</a>.</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> The following is an example of a client using <b class="name">dmoverio</b> to zero-fill a region of memory.  In this example, the application would be able to perform other work while the hardware-assisted data mover clears the specified block of memory.<p>
<pre style="margin-left: 0.00ex;" class="lit display">
int 
hw_bzero(void *buf, size_t len) 
{ 
	static uint32_t reqid; 
 
	struct dmio_setfunc dsf; 
	struct iovec iov; 
	struct dmio_usrreq req; 
	struct dmio_usrresp resp; 
	int fd; 
 
	fd = open("/dev/dmoverio", O_RDWR, 0666); 
	if (fd == -1) 
		return (-1); 
 
	strcpy(dsf.dsf_name, "zero"); 
 
	if (ioctl(fd, DMIO_SETFUNC, &amp;dsf) == -1) { 
		close(fd); 
		return (-1); 
	} 
 
	iov.iov_base = buf; 
	iov.iov_len = len; 
 
	req.req_outbuf.dmbuf_iov = &amp;iov; 
	req.req_outbuf.dmbuf_iovcnt = 1; 
	req.req_id = reqid++; 
 
	if (write(fd, &amp;req, sizeof(req)) != sizeof(req)) { 
		close(fd); 
		return (-1); 
	} 
 
	/* Application can do other work here. */ 
 
	if (read(fd, &amp;resp, sizeof(resp)) != sizeof(resp)) { 
		close(fd); 
		return (-1); 
	} 
 
	if (resp.resp_id != req.req_id) { 
		close(fd); 
		return (-1); 
	} 
 
	if (resp.resp_error != 0) { 
		close(fd); 
		return (-1); 
	} 
 
	close(fd); 
	return (0); 
}</pre>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../9/dmover">dmover(9)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">dmoverio</b> device first appeared in <span class="unix">NetBSD&#160;2.0</span>.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> The <b class="name">dmoverio</b> device was designed and implemented by <span class="author">Jason R. Thorpe</span> &#60;thorpej@wasabisystems.com&#62; and contributed by Wasabi Systems, Inc.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
August 1, 2002</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
<>

