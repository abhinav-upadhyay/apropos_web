<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
ENVSYS(4)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
ENVSYS(4)</td>
<td class="head-vol" align="center">
Kernel Interfaces Manual</td>
<td class="head-rtitle" align="right">
ENVSYS(4)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">envsys</b> &#8212; <span class="desc">Environmental Systems framework (version 2)</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/envsys.h</a>&gt;</b></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">envsys</b> framework provides support to handle hardware monitor devices. Hardware monitoring chips are able to report values from different types of sensors.<p>
The <b class="name">envsys</b> framework consists of two parts:<p>
<ol style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-enum">
<li class="list-enum" style="margin-top: 0.00em;">
the userland part, to receive the current sensor data and to set some properties on sensors: <a class="link-man" href="../html8/envstat.html">envstat(8)</a>.</li>
<li class="list-enum" style="margin-top: 0.00em;">
The kernel part that is able to talk to the devices providing sensor data: <a class="link-man" href="../html9/sysmon_envsys.html">sysmon_envsys(9)</a>.</li>
</ol>
<p>
The <b class="name">envsys</b> framework uses <a class="link-man" href="../html3/proplib.html">proplib(3)</a> for communication between kernel and user space. The following <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a> types are available:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENVSYS_GETDICTIONARY</span> (prop_dictionary_t)</dt>
<dd class="list-tag" style="margin-left: 2.00ex;">
<p>
This <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a> is used to receive the global dictionary that is being used in the kernel by the <a class="link-man" href="../html9/sysmon_envsys.html">sysmon_envsys(9)</a> framework. It will contain an array of dictionaries per device and one dictionary per sensor plus another special dictionary that contains the properties for a device. Each sensor dictionary will have its own characteristics and values.<p>
The following XML property list represents a virtual device &#8220;device0&#8221; with one entry for sensor &#8220;sensor0&#8221; and all available properties set on it, plus another entry for the &#8220;device-properties&#8221; dictionary (which contains specific properties for a device):<p>
<pre style="margin-left: 0.00ex;" class="lit display">
&lt;key&gt;device0&lt;/key&gt; 
&lt;array&gt; 
	&lt;dict&gt; 
		&lt;key&gt;allow-rfact&lt;/key&gt; 
		&lt;true/&gt; 
		&lt;key&gt;avg-value&lt;/key&gt; 
		&lt;integer&gt;36400&lt;/integer&gt; 
		&lt;key&gt;battery-capacity&lt;/key&gt; 
		&lt;string&gt;NORMAL&lt;/string&gt; 
		&lt;key&gt;critical-capacity&lt;/key&gt; 
		&lt;integer&gt;21417&lt;/integer&gt; 
		&lt;key&gt;critical-max&lt;/key&gt; 
		&lt;integer&gt;343150000&lt;/integer&gt; 
		&lt;key&gt;critical-min&lt;/key&gt; 
		&lt;integer&gt;288150000&lt;/integer&gt; 
		&lt;key&gt;cur-value&lt;/key&gt; 
		&lt;integer&gt;406000&lt;/integer&gt; 
		&lt;key&gt;description&lt;/key&gt; 
		&lt;string&gt;CPU Temp&lt;/string&gt; 
		&lt;key&gt;high-capacity&lt;/key&gt; 
		&lt;integer&gt;21417&lt;/integer&gt; 
		&lt;string&gt;index&lt;/string&gt; 
		&lt;string&gt;sensor0&lt;/string&gt; 
		&lt;key&gt;max-value&lt;/key&gt; 
		&lt;integer&gt;3894000&lt;/integer&gt; 
		&lt;key&gt;maximum-capacity&lt;/key&gt; 
		&lt;integer&gt;21417&lt;/integer&gt; 
		&lt;key&gt;min-value&lt;/key&gt; 
		&lt;integer&gt;2894000&lt;/integer&gt; 
		&lt;key&gt;monitoring-state-critical&lt;/key&gt; 
		&lt;true/&gt; 
		&lt;key&gt;monitoring-state-critover&lt;/key&gt; 
		&lt;true/&gt; 
		&lt;key&gt;monitoring-state-critunder&lt;/key&gt; 
		&lt;true/&gt; 
		&lt;key&gt;monitoring-state-state-changed&lt;/key&gt; 
		&lt;true/&gt; 
		&lt;key&gt;monitoring-state-warnover&lt;/key&gt; 
		&lt;true/&gt; 
		&lt;key&gt;monitoring-state-warnunder&lt;/key&gt; 
		&lt;true/&gt; 
		&lt;key&gt;monitoring-supported&lt;/key&gt; 
		&lt;true/&gt; 
		&lt;key&gt;state&lt;/key&gt; 
		&lt;string&gt;valid&lt;/string&gt; 
		&lt;key&gt;type&lt;/key&gt; 
		&lt;string&gt;Ampere hour&lt;/string&gt; 
		&lt;key&gt;want-percentage&lt;/key&gt; 
		&lt;true/&gt; 
		&lt;key&gt;warning-capacity&lt;/key&gt; 
		&lt;integer&gt;19234&lt;/integer&gt; 
		&lt;key&gt;warning-max&lt;/key&gt; 
		&lt;integer&gt;323150000&lt;/integer&gt; 
		&lt;key&gt;warning-min&lt;/key&gt; 
		&lt;integer&gt;298150000&lt;/integer&gt; 
	&lt;/dict&gt; 
	&lt;dict&gt; 
		&lt;key&gt;device-properties&lt;/key&gt; 
		&lt;dict&gt; 
			&lt;key&gt;refresh-timeout&lt;/key&gt; 
			&lt;integer&gt;0xa&lt;/integer&gt; 
		&lt;/dict&gt; 
	&lt;/dict&gt; 
&lt;/array&gt;</pre>
<p>
Let's explain some more about those objects:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">allow-rfact</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Set to <span class="emph">true</span> means that the sensor is able to change the resistor factor, only used in Voltage sensors.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">avg-value</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Current average value in the sensor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">battery-capacity</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Current capacity state for a battery capacity sensor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">critical-capacity</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Critical capacity set previously by the <span class="define">ENVSYS_SETDICTIONARY</span> <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>. Only available on sensors with the <span class="emph">want-percentage</span> object enabled.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">critical-max</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Critical max limit set previously by the <span class="define">ENVSYS_SETDICTIONARY</span> <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">critical-min</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Critical min limit set previously by the <span class="define">ENVSYS_SETDICTIONARY</span> <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">cur-value</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Current value in the sensor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">description</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Description of the sensor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">high-capacity</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
High capacity set previously by the <span class="define">ENVSYS_SETDICTIONARY</span> <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>. Only available on sensors with the <span class="emph">want-percentage</span> object enabled. Used to monitor possible over-charging of batteries.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">index</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Index position of the sensor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">max-value</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Current max value in the sensor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">maximum-capacity</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Maximum capacity set previously by the <span class="define">ENVSYS_SETDICTIONARY</span> <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>. Only available on sensors with the <span class="emph">want-percentage</span> object enabled. Used to monitor possible over-charging of batteries.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">min-value</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Current min value in the sensor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">monitoring-state-critical</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
If true, the device has enabled the flag to monitor a critical state.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">monitoring-state-hw-range-limits</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
If true, the device has enabled the flag to monitor warning or critical limits.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">monitoring-state-state-changed</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
If true, the device has enabled the flag to monitor for state changes in a drive or Battery state sensor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">monitoring-supported</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
If true, critical/warning capacity/max/min limits may be set by the <span class="define">ENVSYS_SETDICTIONARY</span> <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">state</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Current state in the sensor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">type</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Type of unit in the sensor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">want-percentage</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
If true, <span class="emph">max-value</span> and <span class="emph">cur-value</span> are valid and a percentage may be computed from them.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">warning-capacity</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Warning capacity set previously by the <span class="define">ENVSYS_SETDICTIONARY</span> <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>. Only available on sensors with the <span class="emph">want-percentage</span> object enabled.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">warning-max</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Warning max limit set previously by the <span class="define">ENVSYS_SETDICTIONARY</span> <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">warning-min</i></dt>
<dd class="list-tag" style="margin-left: 32.00ex;">
Warning min limit set previously by the <span class="define">ENVSYS_SETDICTIONARY</span> <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>.</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENVSYS_REMOVEPROPS</span> (prop_dictionary_t)</dt>
<dd class="list-tag" style="margin-left: 2.00ex;">
<p>
This <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a> is used to remove all properties that are currently set via the <span class="define">ENVSYS_SETDICTIONARY</span> ioctl. The values will be set to defaults, the ones that the device uses.<p>
Only one object is allowed on this dictionary:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
&lt;key&gt;envsys-remove-props&lt;/key&gt; 
&lt;true/&gt;</pre>
<p>
It is a boolean object and must be set to <span class="emph">true</span> to be effective.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENVSYS_SETDICTIONARY</span> (prop_dictionary_t)</dt>
<dd class="list-tag" style="margin-left: 2.00ex;">
This <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a> is used to send a dictionary with new properties that should be processed by the <b class="name">envsys</b> framework. Only a set of predefined keywords are recognized by the kernel part. The following is the property list representation of a dictionary with all recognized and required keywords that a sensor understands:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
&lt;dict&gt; 
	&lt;key&gt;description&lt;/key&gt; 
	&lt;string&gt;cpu temp&lt;/string&gt; 
	&lt;key&gt;rfact&lt;/key&gt; 
	&lt;integer&gt;56000&lt;/integer&gt; 
	&lt;key&gt;critical-capacity&lt;/key&gt; 
	&lt;integer&gt;10&lt;/integer&gt; 
	&lt;key&gt;critical-max&lt;/key&gt; 
	&lt;integer&gt;3400&lt;/integer&gt; 
	&lt;key&gt;critical-min&lt;/key&gt; 
	&lt;integer&gt;2800&lt;/integer&gt; 
	&lt;key&gt;high-capacity&lt;/key&gt; 
	&lt;integer&gt;95&lt;/integer&gt; 
	&lt;key&gt;maximum-capacity&lt;/key&gt; 
	&lt;integer&gt;100&lt;/integer&gt; 
	&lt;key&gt;warning-capacity&lt;/key&gt; 
	&lt;integer&gt;15&lt;/integer&gt; 
	&lt;key&gt;warning-max&lt;/key&gt; 
	&lt;integer&gt;3200&lt;/integer&gt; 
	&lt;key&gt;warning-min&lt;/key&gt; 
	&lt;integer&gt;2900&lt;/integer&gt; 
&lt;/dict&gt;</pre>
<p>
Also if some properties in a device need to be changed, the &#8220;device-properties&#8221; dictionary must be used. At this moment only the &#8220;refresh-timeout&#8221; property is understood. This has the following structure:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
&lt;dict&gt; 
	&lt;key&gt;device-properties&lt;/key&gt; 
	&lt;dict&gt; 
		&lt;key&gt;refresh-timeout&lt;/key&gt; 
		&lt;integer&gt;0xa&lt;/integer&gt; 
	&lt;/dict&gt; 
&lt;/dict&gt;</pre>
<p>
A dictionary sent to the kernel with this <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a> should have the following structure:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
&lt;dict&gt; 
	&lt;key&gt;device_name&lt;/key&gt; 
	&lt;array&gt; 
		&lt;dict&gt; 
			&lt;key&gt;index&lt;/key&gt; 
			&lt;string&gt;sensor0&lt;/string&gt; 
			&lt;key&gt;description&lt;/key&gt; 
			&lt;string&gt;cpu temp&lt;/string&gt; 
			... 
			Another property for this sensor 
			... 
		&lt;/dict&gt; 
		... 
		Another dictionary for device-properties or sensor 
		... 
	&lt;/array&gt; 
	... 
	Another device as above 
	... 
&lt;/dict&gt;</pre>
<p>
The named device will be an array and will contain dictionaries, any dictionary needs to have the <span class="emph">index</span> object specifying the sensor that is required for the new properties.<p>
If an unknown object was sent with the dictionary, <span class="errno">EINVAL</span> will be returned, or if the sensor does not support changing rfact (voltage sensors) or critical/warning/capacity limits, <span class="errno">ENOTSUP</span> will be returned.</dd>
</dl>
</div>
<div class="section">
<h1 id="x4e4f544553">NOTES</h1> When setting a critical/warning max or min limit with the <span class="define">ENVSYS_SETDICTIONARY</span> <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>, the user must be aware that <a class="link-man" href="../html9/sysmon_envsys.html">sysmon_envsys(9)</a> expects to have a proper unit, so the value must be converted. Please see <a class="link-man" href="../html9/sysmon_envsys.html">sysmon_envsys(9)</a> for more information.<p>
Also when setting a critical or warning capacity limit, the formula to send a proper value to <a class="link-man" href="../html9/sysmon_envsys.html">sysmon_envsys(9)</a> is the following: <span class="emph">value = (value / 100) * max value</span>. The max value is available in the sensor's dictionary.</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> The following example shows how to change the description of &#8216;<code class="lit">sensor0</code>&#8217; in the &#8216;<code class="lit">aibs0</code>&#8217; device with the <span class="define">ENVSYS_SETDICTIONARY</span> <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
int 
main(void) 
{ 
	prop_dictionary_t global_dict, sensor_dict; 
	prop_array_t array; 
	prop_object_t obj; 
	int fd, error; 
 
	global_dict = prop_dictionary_create(); 
	sensor_dict = prop_dictionary_create(); 
	array = prop_array_create(); 
 
	if (!prop_dictionary_set(global_dict, "aibs0", array)) 
		err(EINVAL, "prop_dictionary_set global"); 
 
	obj = prop_string_create_cstring_nocopy("sensor0"); 
	if (obj == NULL || 
	    !prop_dictionary_set(sensor_dict, "index", obj)) 
		err(EINVAL, "sensor index"); 
 
	prop_object_release(obj); 
 
	/* new description */ 
	obj = prop_string_create_cstring_nocopy("CPU core voltage"); 
	if (obj == NULL || 
	    !prop_dictionary_set(sensor_dict, "description", obj)) 
		err(EINVAL, "new description"); 
 
	prop_object_release(obj); 
 
	if (!prop_array_add(array, sensor_dict)) 
		err(EINVAL, "prop_array_add"); 
 
	if ((fd = open(_DEV_SYSMON, O_RDWR)) == &#45;1) 
		err(EXIT_FAILURE, "open"); 
 
	/* we are done, send the dictionary */ 
	error = prop_dictionary_send_ioctl(global_dict, 
					   fd, 
					   ENVSYS_SETDICTIONARY); 
	prop_object_release(array); 
	prop_object_release(global_dict); 
	(void)close(fd); 
	return error; 
}</pre>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html5/envsys.conf.html">envsys.conf(5)</a>, <a class="link-man" href="../html8/envstat.html">envstat(8)</a>, <a class="link-man" href="../html8/powerd.html">powerd(8)</a>, <a class="link-man" href="../html9/sysmon_envsys.html">sysmon_envsys(9)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The first <span class="emph">envsys</span> framework first appeared in <span class="unix">NetBSD&#160;1.5</span>. The <span class="emph">envsys 2</span> framework first appeared in <span class="unix">NetBSD&#160;5.0</span>.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> The (current) <span class="emph">envsys 2</span> framework was implemented by <span class="author">Juan Romero Pardines</span>. Additional input on the design was provided by many <span class="unix">NetBSD</span> developers around the world.<p>
The first <span class="emph">envsys</span> framework was implemented by Jason R. Thorpe, Tim Rightnour, and Bill Squier.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
January 10, 2013</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

