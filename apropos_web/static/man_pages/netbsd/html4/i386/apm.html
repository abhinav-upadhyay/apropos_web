<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../../style.css" type="text/css" media="all">
<title>
APM(4) (i386)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
APM(4)</td>
<td class="head-vol" align="center">
Kernel Interfaces Manual (i386)</td>
<td class="head-rtitle" align="right">
APM(4)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">apm</b> &#8212; <span class="desc">Advanced Power Management pseudo-device driver</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="config">apm0 at mainbus0</b><br>
<b class="includes">#include &lt;<a class="link-includes">machine/apmvar.h</a>&gt;</b> <i class="file">/dev/apm</i></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">apm</b> driver provides support for the Advanced Power Management features of some i386 system BIOSes. The driver supports the Advanced Power Management (APM) BIOS Interface Specification (revision 1.2), published jointly by the Intel Corporation and the Microsoft Corporation.<p>
The APM driver's behavior may be adjusted by specifying any of the following kernel configuration options:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APM_NO_IDLE</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Do not call the BIOS CPU idle function from the system idle loop. (Some systems will hang on certain device accesses, such as sound cards or floppy diskette drives, without this option)</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APM_V10_ONLY</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Use only the APM revision 1.0 specification calls. (Some systems do not implement APM v1.1 very well, and generate weird events instead of the expected events when the system suspend key is pressed.)</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APM_NO_V12</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Don't attach to the BIOS as APM v1.2 compliant device. (In case there are problems with v1.2 support.)</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APM_NO_STANDBY</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Do not attempt to put the system into standby mode.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APM_NO_POWEROFF</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Do not attempt to turn off power when halting the system.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APM_FORCE_64K_SEGMENTS</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Force the length of the APM BIOS code and data segments to 64KB.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APM_ALLOW_BOGUS_SEGMENTS</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Allow the use of data segments which are in unexpected locations.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APMDEBUG</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Enable kernel printout of events received from the APM BIOS.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APMCALLDEBUG</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Enable kernel printout of every call to the APM BIOS (this is very noisy).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APM_POWER_PRINT</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Print power state on console at <span class="define">APM_POWER_CHANGE</span> events. (Since it increases <a class="link-man" href="../../html8/syslogd.html">syslogd(8)</a>'s activity, it may consume increased battery power. Some systems generate the events too frequently, and printing the status may disturb single-user operations.)</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APM_DISABLE_INTERRUPTS</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Set this to zero if you don't want the kernel to disable interrupts before calling the BIOS. This is required for most IBM ThinkPads, and some other newer laptops. A good indication that you need this is that the machine hangs just after resuming from suspended state. It's unclear if doing this has negative effects on older BIOS, therefore it defaults to one (i.e interrupts are disabled).</dd>
</dl>
<p>
If no processes are holding open file descriptors to the APM device, the driver will process the APM BIOS events itself. If a process has the device open for write, the driver defers all suspend and standby processing to the user process as long as there is sufficient queue space to store the event for the process. If the device is only open for read, the driver will report events but handle them itself.<p>
The APM device may be opened by multiple readers but only one writer. Multiple readers may fetch the status with <a class="link-man" href="../../html2/ioctl.html">ioctl(2)</a> without worrying about interference, but they must cooperate to share events as only a single event queue is provided. The device may only be <a class="link-man" href="../../html2/select.html">select(2)</a>ed or manipulated with <a class="link-man" href="../../html2/ioctl.html">ioctl(2)</a>; <a class="link-man" href="../../html2/read.html">read(2)</a> and <a class="link-man" href="../../html2/write.html">write(2)</a> are not supported. The <a class="link-man" href="../../html2/ioctl.html">ioctl(2)</a> calls supported are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APM_IOC_SUSPEND</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Initiate an APM suspend mode. This is a deep sleep mode which powers down most devices. The device must be open for writing for this command to succeed.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APM_IOC_STANDBY</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Initiate an APM standby mode. This is a light sleep mode from which the system can quickly restore normal operation. The device must be open for writing for this command to succeed.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APM_IOC_GETPOWER</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Fetch the current power status into an <b class="var">apm_power_info</b> structure.<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct apm_power_info { 
	u_char battery_state; 
	u_char ac_state; 
	u_char battery_life; 
	u_char spare1; 
	u_int minutes_left;		/* estimate */ 
	u_int nbattery; 
	u_int batteryid; 
	u_int spare2[4]; 
};</pre>
<p>
The structure should be zeroed (except for <b class="var">batteryid</b>) before being passed.<p>
<b class="var">battery_state</b> is one of <span class="define">APM_BATT_HIGH</span>, <span class="define">APM_BATT_LOW</span>, <span class="define">APM_BATT_CRITICAL</span>, <span class="define">APM_BATT_CHARGING</span>, or <span class="define">APM_BATT_UNKNOWN</span>.<p>
<b class="var">ac_state</b> is one of <span class="define">APM_AC_OFF</span>, <span class="define">APM_AC_ON</span>, <span class="define">APM_AC_BACKUP</span>, or <span class="define">APM_AC_UNKNOWN</span>.<p>
<b class="var">battery_life</b> is the percentage estimated remaining normal battery life (or 0 if the BIOS cannot provide an estimate).<p>
<b class="var">minutes_left</b> is an estimated remaining lifetime (or 0 if the BIOS cannot provide an estimate).<p>
<b class="var">nbattery</b> is the number of batteries in the system. If the system is using APM v1.1 or earlier, nbattery will always return 0.<p>
Batteries are numbered from a base of 1. If the passed value of <b class="var">batteryid</b> is 0, the returned values will reflect the percentage remaining, minutes left, etc. of all of the system's batteries taken together. If the passed value of <b class="var">batteryid</b> is nonzero, the return values will reflect the indicated battery's percentage remaining, minutes left, etc. It is an error to set <b class="var">batteryid</b> to a value greater than that returned by <b class="var">nbattery</b>. If the system is using APM v1.1 or earlier, individual batteries cannot be queried, and <b class="var">nbattery</b> will always return 0. <b class="var">batteryid</b> is always set to the passed value upon return.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">APM_IOC_NEXTEVENT</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Fetch the next event from the APM BIOS into an <b class="var">apm_event_info</b> structure. If no more events are ready, this will return <span class="define">EAGAIN</span>.<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct apm_event_info { 
      u_int type; 
      u_int index; 
      u_int spare[8]; 
};</pre>
<b class="var">type</b> is one of the APM event types (APM_STANDBY_REQ through APM_SYS_STANDBY_RESUME). <b class="var">index</b> is the ordinal event sequence number.</dd>
</dl>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../../html8/apmd.html">apmd(8)</a></div>
<div class="section">
<h1 id="x5245464552454e434553">REFERENCES</h1> Advanced Power Management (APM) BIOS Interface Specification (Revision 1.1), Intel Corporation and Microsoft Corporation. Intel order number 241704-001; Microsoft part number 781-110-X01.</div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">apm</b> pseudo-device driver appeared in <span class="unix">NetBSD&#160;1.3</span>.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
May 18, 1996</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

