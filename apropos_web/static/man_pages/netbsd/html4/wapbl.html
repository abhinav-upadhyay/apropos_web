<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
WAPBL(4)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
WAPBL(4)</td>
<td class="head-vol" align="center">
Kernel Interfaces Manual</td>
<td class="head-rtitle" align="right">
WAPBL(4)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">WAPBL</b> &#8212; <span class="desc">Write Ahead Physical Block Logging file system journaling</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="config">options WAPBL</b><br>
<b class="config">options WAPBL_DEBUG</b></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">WAPBL</b> driver provides meta-data journaling for file systems. In particular, it is used with the fast file system (FFS) to provide rapid file system consistency checking after a system outage. It also provides better general-use performance over regular FFS.<p>
WAPBL currently maintains its journal in one of two locations:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
- After the file system</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The journal is placed in the same partition as the file system, but between the file system and the end of the partition.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
- Within the file system</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The journal is allocated as a special contiguous file within the file system. The journal file is not visible via normal file system access.</dd>
</dl>
<p>
A new journal is created automatically when a file system is mounted via <a class="link-man" href="../html8/mount.html">mount(8)</a> with the <b class="flag">&#45;o</b> <i class="arg">log</i> option. If no journal size has been specified with <a class="link-man" href="../html8/tunefs.html">tunefs(8)</a>, then the size of the journal will be based on 1MB of journal per 1GB of file system, to a maximum journal size of 64MB.<p>
If there is adequate space between the end of the file system and the end of the partition, then unless the journal size has been specified with <a class="link-man" href="../html8/tunefs.html">tunefs(8)</a> then the journal will be created after the file system. To obtain space between the file system and the end of the partition the size of the partition can be adjusted using <a class="link-man" href="../html8/disklabel.html">disklabel(8)</a>. Care must be taken not to damage existing data on existing partitions, but this method will work well if, for example, a swap partition can be shrunk in order to accommodate the journal after the file system on a partition before the swap partition.<p>
For a new file system,<p>
<pre style="margin-left: 5.00ex;" class="lit display">
newfs -s -64m wd0a</pre>
<p>
can be used to leave space for a 64MB journal at the end of <i class="file">/dev/wd0a</i>.<p>
To specify the size of the journal within the file system <a class="link-man" href="../html8/tunefs.html">tunefs(8)</a> can be used as follows:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
tunefs -l 64m wd0a</pre>
<p>
to indicate that a journal of size 64MB on the file system on <i class="file">/dev/wd0a</i> should be created the next time that file system is mounted. This must be done before the file system is mounted with the &#8220;-o log&#8221; option. For existing file systems and general use, however, simply using<p>
<pre style="margin-left: 5.00ex;" class="lit display">
mount -o log /dev/wd0a /mnt</pre>
<p>
will be sufficient to create an appropriate journal within the file system. Running<p>
<pre style="margin-left: 5.00ex;" class="lit display">
tunefs -l 0 wd0a</pre>
<p>
will schedule the log for removal on the next read-write mount, and running<p>
<pre style="margin-left: 5.00ex;" class="lit display">
tunefs -l 0 wd0a</pre>
<p>
followed by<p>
<pre style="margin-left: 5.00ex;" class="lit display">
mount -o log /dev/wd0a /mnt</pre>
<p>
will remove the log and then re-create it with the default size. This method can also be used to grow or shrink the size of the journal by first scheduling the log for removal, then mounting read-write, but with logging disabled (so no new log will be created), then unmounting again, setting the desired log size and finally re-mounting with logging enabled.<p>
With the journal, <a class="link-man" href="../html8/fsck.html">fsck(8)</a> is no longer required at system boot. If the system has been shutdown in an unclean fashion then the journal will be replayed when the file system is mounted. <a class="link-man" href="../html8/fsck.html">fsck(8)</a> can still be used to force a consistency check of the file system should that be desired.<p>
For kernel developers, the compile time option <span class="define">WAPBL_DEBUG</span> turns on debugging.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html1/config.html">config(1)</a>, <a class="link-man" href="../html8/fsck.html">fsck(8)</a>, <a class="link-man" href="../html8/mount.html">mount(8)</a>, <a class="link-man" href="../html8/newfs.html">newfs(8)</a>, <a class="link-man" href="../html8/umount.html">umount(8)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> <span class="author"></span><b class="name">WAPBL</b> was originally written by <span class="author">Darrin B. Jewell</span> while at Wasabi Systems Inc. Wasabi Systems contributed the code to <span class="unix">NetBSD</span>, and it was integrated by <span class="author">Simon Burge</span>, <span class="author">Antti Kantee</span>, <span class="author">Andy Doran</span>, and <span class="author">Greg Oster</span>.<p>
<b class="name">WAPBL</b> first appeared in <span class="unix">NetBSD&#160;5.0</span>.</div>
<div class="section">
<h1 id="x43415645415453">CAVEATS</h1> Older releases of the system, and other systems that support the <span class="define">UFS</span> format should only access <b class="name">WAPBL</b> file systems in read-only mode. Additionally, the <a class="link-man" href="../html8/fsck.html">fsck(8)</a> command from such systems should not be run against <b class="name">WAPBL</b> file systems. Failure to observe these guidelines may damage the file system.<p>
<b class="name">WAPBL</b> requires the super block to be in the UFS2 format. The super block format can be checked using the <b class="flag">&#45;s</b> option with <a class="link-man" href="../html8/dumpfs.html">dumpfs(8)</a>, and older FFSv1 file systems will need to be updated to the newer super block layout with the <b class="flag">&#45;c</b> option to <a class="link-man" href="../html8/fsck_ffs.html">fsck_ffs(8)</a>.<p>
<a class="link-man" href="../html2/fsync.html">fsync(2)</a> causes all outstanding metadata transactions to be committed to disk, introducing additional latency. This can have an impact on database software and other software that calls <a class="link-man" href="../html2/fsync.html">fsync(2)</a> often.<p>
In-file system log allocation should be done on a relatively quiet file system. The error path for log allocation failures could result in a &#8220;dangling inode&#8221; issue, requiring an <a class="link-man" href="../html8/fsck.html">fsck(8)</a> to fix.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
December 3, 2012</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

