<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/../4/strict.dtd">
>
<head>
<meta http-equiv="Content-Type" content="te../; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
IPSEC(4)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
IPSEC(4)</td>
<td class="head-vol" align="center">
Kernel Interfaces Manual</td>
<td class="head-rtitle" align="right">
IPSEC(4)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">ipsec</b> &#8212; <span class="desc">IP security protocol</span></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> <b class="name">ipsec</b> is a security protocol in Internet Protocol (IP) layer. <b class="name">ipsec</b> is defined for both IPv4 and IPv6 (<a class="link-man" href="../4/inet">inet(4)</a> and <a class="link-man" href="../4/inet6">inet6(4)</a>). <b class="name">ipsec</b> consists of two sub-protocols:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-hang">
<dt class="list-hang" style="margin-top: 1.00em;">
<span class="emph">Encapsulated Security Payload</span> (ESP)</dt>
<dd class="list-hang">
protects IP payload from wire-tapping (interception) by encrypting it with secret key cryptography algorithms.</dd>
<dt class="list-hang" style="margin-top: 1.00em;">
<span class="emph">Authentication Header</span> (AH)</dt>
<dd class="list-hang">
guarantees integrity of IP packet and protects it from intermediate alteration or impersonation, by attaching cryptographic checksum computed by one-way hash functions.</dd>
</dl>
<p>
<b class="name">ipsec</b> has two operation modes:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-hang">
<dt class="list-hang" style="margin-top: 1.00em;">
<span class="emph">Transport mode</span></dt>
<dd class="list-hang">
is for protecting peer-to-peer communication between end nodes.</dd>
<dt class="list-hang" style="margin-top: 1.00em;">
<span class="emph">Tunnel mode</span></dt>
<dd class="list-hang">
includes IP-in-IP encapsulation operation and is designed for security gateways, as in Virtual Private Network (VPN) configurations.</dd>
</dl>
<p>
Since version 6, <span class="unix">NetBSD</span> uses the IPSEC implementation formerly known as FAST_IPSEC. Its specifics and kernel options are describes in the <a class="link-man" href="../4/fast_ipsec">fast_ipsec(4)</a> manual page.<div class="subsection">
<h2 id="x4b65726e656c20696e74657266616365">Kernel interface</h2> <b class="name">ipsec</b> is controlled by key management engine and policy engine, in the operating system kernel.<p>
Key management engine can be accessed from the userland by using <span class="define">PF_KEY</span> sockets. The <span class="define">PF_KEY</span> socket API is defined in RFC2367.<p>
Policy engine can be controlled by extended part of <span class="define">PF_KEY</span> API, <a class="link-man" href="../2/setsockopt">setsockopt(2)</a> operations, and <a class="link-man" href="../3/sysctl">sysctl(3)</a> interface. The kernel implements extended version of <span class="define">PF_KEY</span> interface, and allows you to define IPsec policy like per-packet filters. <a class="link-man" href="../2/setsockopt">setsockopt(2)</a> interface is used to define per-socket behavior, and <a class="link-man" href="../3/sysctl">sysctl(3)</a> interface is used to define host-wide default behavior.<p>
The kernel code does not implement dynamic encryption key exchange protocol like IKE (Internet Key Exchange). That should be implemented as userland programs (usually as daemons), by using the above described APIs.</div>
<div class="subsection">
<h2 id="x506f6c696379206d616e6167656d656e74">Policy management</h2> The kernel implements experimental policy management code. You can manage the IPsec policy in two ways. One is to configure per-socket policy using <a class="link-man" href="../2/setsockopt">setsockopt(2)</a>. The other is to configure kernel packet filter-based policy using <span class="define">PF_KEY</span> interface, via <a class="link-man" href="../8/setkey">setkey(8)</a>. In both cases, IPsec policy must be specified with syntax described in <a class="link-man" href="../3/ipsec_set_policy">ipsec_set_policy(3)</a>.<p>
With <a class="link-man" href="../2/setsockopt">setsockopt(2)</a>, you can define IPsec policy in per-socket basis. You can enforce particular IPsec policy onto packets that go through particular socket.<p>
With <a class="link-man" href="../8/setkey">setkey(8)</a> you can define IPsec policy against packets, using sort of packet filtering rule. Refer to <a class="link-man" href="../8/setkey">setkey(8)</a> on how to use it.<p>
In the latter case, &#8220;<code class="lit">default</code>&#8221; policy is allowed for use with <a class="link-man" href="../8/setkey">setkey(8)</a>. By configuring policy to <code class="lit">default</code>, you can refer system-wide <a class="link-man" href="../8/sysctl">sysctl(8)</a> variable for default settings. The following variables are available. <code class="lit">1</code> means &#8220;<code class="lit">use</code>&#8221;, and <code class="lit">2</code> means &#8220;<code class="lit">require</code>&#8221; in the syntax.<table style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-col">
<col style="width: 33.00ex;">
<col style="min-width: 10.00ex;">
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Name</span></td>
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Type</span></td>
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Changeable</span></td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet.ipsec.esp_trans_deflev</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet.ipsec.esp_net_deflev</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet.ipsec.ah_trans_deflev</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet.ipsec.ah_net_deflev</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet6.ipsec6.esp_trans_deflev</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet6.ipsec6.esp_net_deflev</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet6.ipsec6.ah_trans_deflev</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet6.ipsec6.ah_net_deflev</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
</tbody>
</table>
<p>
If kernel finds no matching policy system wide default value is applied. System wide default is specified by the following <a class="link-man" href="../8/sysctl">sysctl(8)</a> variables. <code class="lit">0</code> means &#8220;<code class="lit">discard</code>&#8221; which asks the kernel to drop the packet. <code class="lit">1</code> means &#8220;<code class="lit">none</code>&#8221;.<table style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-col">
<col style="width: 33.00ex;">
<col style="min-width: 10.00ex;">
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Name</span></td>
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Type</span></td>
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Changeable</span></td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet.ipsec.def_policy</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet6.ipsec6.def_policy</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
</tbody>
</table>
</div>
<div class="subsection">
<h2 id="x4d697363656c6c616e656f75732073797363746c207661726961626c6573">Miscellaneous sysctl variables</h2> The following variables are accessible via <a class="link-man" href="../8/sysctl">sysctl(8)</a>, for tweaking kernel IPsec behavior:<table style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-col">
<col style="width: 33.00ex;">
<col style="min-width: 10.00ex;">
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Name</span></td>
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Type</span></td>
<td class="list-col" style="margin-top: 1.00em;">
<span class="symb">Changeable</span></td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet.ipsec.ah_cleartos</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet.ipsec.ah_offsetmask</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet.ipsec.dfbit</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet.ipsec.ecn</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet.ipsec.debug</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet6.ipsec6.ecn</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
net.inet6.ipsec6.debug</td>
<td class="list-col" style="margin-top: 1.00em;">
integer</td>
<td class="list-col" style="margin-top: 1.00em;">
yes</td>
</tr>
</tbody>
</table>
<p>
The variables are interpreted as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">ipsec.ah_cleartos</code></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
If set to non-zero, the kernel clears type-of-service field in the IPv4 header during AH authentication data computation. The variable is for tweaking AH behavior to interoperate with devices that implement RFC1826 AH. It should be set to non-zero (clear the type-of-service field) for RFC2402 conformance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">ipsec.ah_offsetmask</code></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
During AH authentication data computation, the kernel will include 16bit fragment offset field (including flag bits) in IPv4 header, after computing logical AND with the variable. The variable is for tweaking AH behavior to interoperate with devices that implement RFC1826 AH. It should be set to zero (clear the fragment offset field during computation) for RFC2402 conformance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">ipsec.dfbit</code></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The variable configures the kernel behavior on IPv4 IPsec tunnel encapsulation. If set to 0, DF bit on the outer IPv4 header will be cleared. 1 means that the outer DF bit is set regardless from the inner DF bit. 2 means that the DF bit is copied from the inner header to the outer. The variable is supplied to conform to RFC2401 chapter 6.1.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">ipsec.ecn</code></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
If set to non-zero, IPv4 IPsec tunnel encapsulation/decapsulation behavior will be friendly to ECN (explicit congestion notification), as documented in <code class="lit">draft-ietf-ipsec-ecn-02.txt</code>. <a class="link-man" href="../4/gif">gif(4)</a> talks more about the behavior.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">ipsec.debug</code></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
If set to non-zero, debug messages will be generated via <a class="link-man" href="../3/syslog">syslog(3)</a>.</dd>
</dl>
<p>
Variables under <code class="lit">net.inet6.ipsec6</code> tree has similar meaning as the <code class="lit">net.inet.ipsec</code> counterpart.</div>
</div>
<div class="section">
<h1 id="x50524f544f434f4c53">PROTOCOLS</h1> The <b class="name">ipsec</b> protocol works like plug-in to <a class="link-man" href="../4/inet">inet(4)</a> and <a class="link-man" href="../4/inet6">inet6(4)</a> protocols. Therefore, <b class="name">ipsec</b> supports most of the protocols defined upon those IP-layer protocols. Some of the protocols, like <a class="link-man" href="../4/icmp">icmp(4)</a> or <a class="link-man" href="../4/icmp6">icmp6(4)</a>, may behave differently with <b class="name">ipsec</b>. This is because <b class="name">ipsec</b> can prevent <a class="link-man" href="../4/icmp">icmp(4)</a> or <a class="link-man" href="../4/icmp6">icmp6(4)</a> routines from looking into IP payload.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../2/ioctl">ioctl(2)</a>, <a class="link-man" href="../2/socket">socket(2)</a>, <a class="link-man" href="../3/ipsec_set_policy">ipsec_set_policy(3)</a>, <a class="link-man" href="../4/fast_ipsec">fast_ipsec(4)</a>, <a class="link-man" href="../4/icmp6">icmp6(4)</a>, <a class="link-man" href="../4/intro">intro(4)</a>, <a class="link-man" href="../4/ip6">ip6(4)</a>, <a class="link-man" href="../8/racoon">racoon(8)</a>, <a class="link-man" href="../8/setkey">setkey(8)</a>, <a class="link-man" href="../8/sysctl">sysctl(8)</a></div>
<div class="section">
<h1 id="x5354414e4441524453">STANDARDS</h1> <span class="ref"><span class="ref-auth">Daniel L. McDonald</span>, <span class="ref-auth">Craig Metz</span>, and <span class="ref-auth">Bao G. Phan</span>, <span class="ref-title">PF_KEY Key Management API, Version 2</span>, <span class="ref-rep">RFC</span>, <span class="ref-num">2367</span>.</span></div>
<div class="section">
<h1 id="x42554753">BUGS</h1> The IPsec support is subject to change as the IPsec protocols develop.<p>
There is no single standard for policy engine API, so the policy engine API described herein is just for the version introduced by KAME.<p>
AH and tunnel mode encapsulation may not work as you might expect. If you configure inbound &#8220;require&#8221; policy against AH tunnel or any IPsec encapsulating policy with AH (like &#8220;<code class="lit">esp/tunnel/A-B/use ah/transport/A-B/require</code>&#8221;), tunneled packets will be rejected. This is because we enforce policy check on inner packet on reception, and AH authenticates encapsulating (outer) packet, not the encapsulated (inner) packet (so for the receiving kernel there's no sign of authenticity). The issue will be solved when we revamp our policy engine to keep all the packet decapsulation history.<p>
Under certain condition, truncated result may be raised from the kernel against <span class="define">SADB_DUMP</span> and <span class="define">SADB_SPDDUMP</span> operation on <span class="define">PF_KEY</span> socket. This occurs if there are too many database entries in the kernel and socket buffer for the <span class="define">PF_KEY</span> socket is insufficient. If you manipulate many IPsec key/policy database entries, increase the size of socket buffer or use <a class="link-man" href="../8/sysctl">sysctl(8)</a> interface.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
January 16, 2012</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
<>

