<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/../4/strict.dtd">
>
<head>
<meta http-equiv="Content-Type" content="te../; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
IPNAT(4)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
IPNAT(4)</td>
<td class="head-vol" align="center">
Kernel Interfaces Manual</td>
<td class="head-rtitle" align="right">
IPNAT(4)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1>NAME</h1> ipnat &#45; Network Address Translation kernel interface</div>
<div class="section">
<h1>SYNOPSIS</h1> #include &lt;netinet/ip_compat.h&gt;<div style="height: 0.00em;">
&#160;</div>
#include &lt;netinet/ip_fil.h&gt;<div style="height: 0.00em;">
&#160;</div>
#include &lt;netinet/ip_proxy.h&gt;<div style="height: 0.00em;">
&#160;</div>
#include &lt;netinet/ip_nat.h&gt;</div>
<div class="section">
<h1>IOCTLS</h1> To add and delete rules to the NAT list, two 'basic' ioctls are provided for use.  The ioctl's are called as:<p>
<br>
	ioctl(fd, SIOCADNAT, struct ipnat **)<br>
	ioctl(fd, SIOCRMNAT, struct ipnat **)<br>
	ioctl(fd, SIOCGNATS, struct natstat **)<br>
	ioctl(fd, SIOCGNATL, struct natlookup **)<br>
<p>
Unlike <b>ipf(4)</b>, there is only a single list supported by the kernel NAT interface.  An inactive list which can be swapped to is not currently supported.<div style="height: 1.00em;">
&#160;</div>
These ioctl's are implemented as being routing ioctls and thus the same rules for the various routing ioctls and the file descriptor are employed, mainly being that the fd must be that of the device associated with the module (i.e., /dev/ipl).<p>
The structure used with the NAT interface is described below:<p>
<br>
typedef struct  ipnat   {<br>
        struct  ipnat   *in_next;<br>
        void    *in_ifp;<br>
        u_short in_flags;<br>
        u_short in_pnext;<br>
        u_short in_port[2];<br>
        struct  in_addr in_in[2];<br>
        struct  in_addr in_out[2];<br>
        struct  in_addr in_nextip;<br>
        int     in_space;<br>
        int     in_redir; /* 0 if it's a mapping, 1 if it's a hard redir */<br>
        char    in_ifname[IFNAMSIZ];<br>
} ipnat_t;<p>
<br>
#define in_pmin         in_port[0]      /* Also holds static redir port */<br>
#define in_pmax         in_port[1]<br>
#define in_nip          in_nextip.s_addr<br>
#define in_inip         in_in[0].s_addr<br>
#define in_inmsk        in_in[1].s_addr<br>
#define in_outip        in_out[0].s_addr<br>
#define in_outmsk       in_out[1].s_addr<p>
<br>
<p>
Recognised values for in_redir:<p>
<br>
#define NAT_MAP         0<br>
#define NAT_REDIRECT    1<br>
<p>
<b>NAT statistics</b> Statistics on the number of packets mapped, going in and out are kept, the number of times a new entry is added and deleted (through expiration) to the NAT table and the current usage level of the NAT table.<p>
Pointers to the NAT table inside the kernel, as well as to the top of the internal NAT lists constructed with the  <b>SIOCADNAT</b> ioctls.  The table itself is a hash table of size NAT_SIZE (default size is 367).<p>
To retrieve the statistics, the <b>SIOCGNATS</b> ioctl must be used, with the appropriate structure passed by reference, as follows:<br>
	ioctl(fd, SIOCGNATS, struct natstat *)<p>
<br>
typedef struct  natstat {<br>
        u_long  ns_mapped[2];<br>
        u_long  ns_added;<br>
        u_long  ns_expire;<br>
        u_long  ns_inuse;<br>
        nat_t   ***ns_table;<br>
        ipnat_t *ns_list;<br>
} natstat_t;<br>
</div>
<div class="section">
<h1>BUGS</h1> It would be nice if there were more flexibility when adding and deleting filter rules.</div>
<div class="section">
<h1>FILES</h1> /dev/ipnat</div>
<div class="section">
<h1>SEE ALSO</h1> ipf(4), ipnat(5), ipf(8), ipnat(8), ipfstat(8)</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tr>
<td class="foot-date">
</td>
<td class="foot-os" align="right">
</td>
</tr>
</table>
</div>
</body>
<>

