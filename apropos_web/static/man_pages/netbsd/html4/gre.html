<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
GRE(4)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
GRE(4)</td>
<td class="head-vol" align="center">
Kernel Interfaces Manual</td>
<td class="head-rtitle" align="right">
GRE(4)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">gre</b> &#8212; <span class="desc">encapsulating network device</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="config">pseudo-device gre</b></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">gre</b> network interface pseudo device encapsulates datagrams into IP. These encapsulated datagrams are routed to a destination host, where they are decapsulated and further routed to their final destination. The &#8220;tunnel&#8221; appears to the inner datagrams as one hop.<p>
<b class="name">gre</b> interfaces are dynamically created and destroyed with the <a class="link-man" href="../8/ifconfig">ifconfig(8)</a> <b class="flag">create</b> and <b class="flag">destroy</b> subcommands.<p>
This driver currently supports the following modes of operation:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
GRE encapsulation (IP protocol number 47)</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
Encapsulated datagrams are prepended an outer datagram and a GRE header. The GRE header specifies the type of the encapsulated datagram and thus allows for tunneling other protocols than IP like e.g. AppleTalk. GRE mode is also the default tunnel mode on Cisco routers. This is also the default mode of operation of the <span class="symb">gre</span><i class="arg">X</i> interfaces.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
GRE in UDP encapsulation</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
Encapsulated datagrams are prepended a GRE header, and then they are sent over a UDP socket. Userland may create the socket and &#8220;delegate&#8221; it to the kernel using the <span class="define">GRESSOCK</span> <a class="link-man" href="../2/ioctl">ioctl(2)</a>. If userland does not supply a socket, then the kernel will create one using the addresses and ports supplied by <a class="link-man" href="../2/ioctl">ioctl(2)</a>s <span class="define">SIOCSLIFPHYADDR</span>, <span class="define">GRESADDRD</span>, and/or <span class="define">GRESADDRS</span>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
MOBILE encapsulation (IP protocol number 55)</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
Datagrams are encapsulated into IP, but with a shorter encapsulation. The original IP header is modified and the modifications are inserted between the so modified header and the original payload. Like <a class="link-man" href="../4/gif">gif(4)</a>, only for IP in IP encapsulation.</dd>
</dl>
<p>
The <span class="symb">gre</span><i class="arg">X</i> interfaces support a number of <a class="link-man" href="../2/ioctl">ioctl(2)</a>s, such as:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
GRESADDRS:</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
Set the IP address of the local tunnel end. This is the source address set by or displayed by ifconfig for the <span class="symb">gre</span><i class="arg">X</i> interface.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
GRESADDRD:</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
Set the IP address of the remote tunnel end. This is the destination address set by or displayed by ifconfig for the <span class="symb">gre</span><i class="arg">X</i> interface.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
GREGADDRS:</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
Query the IP address that is set for the local tunnel end. This is the address the encapsulation header carries as local address (i.e. the real address of the tunnel start point.)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
GREGADDRD:</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
Query the IP address that is set for the remote tunnel end. This is the address the encapsulated packets are sent to (i.e. the real address of the remote tunnel endpoint.)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
GRESPROTO:</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
Set the operation mode to the specified IP protocol value. The protocol is passed to the interface in (struct ifreq)-&gt;ifr_flags. The operation mode can also be given as<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
link0 link2</dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
IPPROTO_UDP</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
link0 -link2</dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
IPPROTO_GRE</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
-link0 -link2</dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
IPPROTO_MOBILE</dd>
</dl>
<p>
to <a class="link-man" href="../8/ifconfig">ifconfig(8)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
GREGPROTO:</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
Query operation mode.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
GRESSOCK:</dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
Delegate a socket from userland to a tunnel interface in UDP encapsulation mode. The file descriptor for the socket is passed in (struct ifreq)-&gt;ifr_value.</dd>
</dl>
<p>
Note that the IP addresses of the tunnel endpoints may be the same as the ones defined with <a class="link-man" href="../8/ifconfig">ifconfig(8)</a> for the interface (as if IP is encapsulated), but need not be, as e.g. when encapsulating AppleTalk.</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1><div class="subsection">
<h2 id="x4578616d706c6520313a204261736963204752452074756e6e656c696e67">Example 1: Basic GRE tunneling</h2> Configuration example:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
Host X-- Router A  --------------tunnel---------- Router D ----Host E 
          |                                          | 
           \                                        / 
            +----- Router B ----- Router C --------+</pre>
<p>
On Router A (<span class="unix">NetBSD</span>):<p>
<pre style="margin-left: 0.00ex;" class="lit display">
   # route add default B 
   # ifconfig greN create 
   # ifconfig greN A D netmask 0xffffffff linkX up 
   # ifconfig greN tunnel A D 
   # route add E D</pre>
<p>
On Router D (Cisco):<p>
<pre style="margin-left: 0.00ex;" class="lit display">
   Interface TunnelX 
    ip unnumbered D   ! e.g. address from Ethernet interface 
    tunnel source D   ! e.g. address from Ethernet interface 
    tunnel destination A 
   ip route C &lt;some interface and mask&gt; 
   ip route A mask C 
   ip route X mask tunnelX</pre>
<p>
or on Router D (<span class="unix">NetBSD</span>):<p>
<pre style="margin-left: 0.00ex;" class="lit display">
   # route add default C 
   # ifconfig greN create 
   # ifconfig greN D A 
   # ifconfig tunnel greN D A</pre>
<p>
If all goes well, you should see packets flowing ;-)<p>
If you want to reach Router A over the tunnel (from Router D (Cisco)), then you have to have an alias on Router A for e.g. the Ethernet interface like:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
     ifconfig &lt;etherif&gt; alias Y</pre>
<p>
and on the Cisco<p>
<pre style="margin-left: 0.00ex;" class="lit display">
     ip route Y mask tunnelX</pre>
</div>
<div class="subsection">
<h2 id="x4578616d706c6520323a204c696e6b696e672070726976617465207375626e657473">Example 2: Linking private subnets</h2> A similar setup can be used to create a link between two private networks (for example in the 192.168 subnet) over the Internet:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
192.168.1.* --- Router A  -------tunnel-------- Router B --- 192.168.2.* 
                   \                              / 
                    \                            / 
                      +----- the Internet ------+</pre>
<p>
Assuming Router A has the (external) IP address A and the internal address 192.168.1.1, while Router B has external address B and internal address 192.168.2.1, the following commands will configure the tunnel:<p>
On Router A:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
   # ifconfig greN create 
   # ifconfig greN 192.168.1.1 192.168.2.1 
   # ifconfig greN tunnel A B 
   # route add -net 192.168.2 -netmask 255.255.255.0 192.168.2.1</pre>
<p>
On Router B:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
   # ifconfig greN create 
   # ifconfig greN 192.168.2.1 192.168.1.1 
   # ifconfig greN tunnel B A 
   # route add -net 192.168.1 -netmask 255.255.255.0 192.168.1.1</pre>
</div>
<div class="subsection">
<h2 id="x4578616d706c6520333a20456e63617073756c6174696e672047524520696e20554450">Example 3: Encapsulating GRE in UDP</h2> To setup the same tunnel as above, but using GRE in UDP encapsulation instead of GRE encapsulation, set flags <i class="arg">link0</i> and <i class="arg">link2</i>, and specify source and destination UDP ports.<p>
On Router A:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
   # ifconfig greN create 
   # ifconfig greN link0 link2 
   # ifconfig greN 192.168.1.1 192.168.2.1 
   # ifconfig greN tunnel A,port-A B,port-B 
   # route add -net 192.168.2 -netmask 255.255.255.0 192.168.2.1</pre>
<p>
On Router B:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
   # ifconfig greN create 
   # ifconfig greN link0 link2 
   # ifconfig greN 192.168.2.1 192.168.1.1 
   # ifconfig greN tunnel B,port-B A,port-A 
   # route add -net 192.168.1 -netmask 255.255.255.0 192.168.1.1</pre>
</div>
<div class="subsection">
<h2 id="x4578616d706c6520343a205265616c697a696e67204950763620636f6e6e6563746976697479">Example 4: Realizing IPv6 connectivity</h2> Along these lines, you can use GRE tunnels to interconnect two IPv6 networks over an IPv4 infrastructure, or to hook up to the IPv6 internet via an IPv4 tunnel to a Cisco router.<p>
<pre style="margin-left: 0.00ex;" class="lit display">
2001:db8:1::/64 -- NetBSD A  ---- Tunnel ---- Cisco B --- IPv6 Internet 
                   \                              / 
                    \                            / 
                     +------ the Internet ------+</pre>
<p>
The example will use the following addressing:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-hang">
<dt class="list-hang" style="margin-top: 1.00em;">
<span class="unix">NetBSD</span></dt>
<dd class="list-hang">
A has the IPv4 address A and the IPv6 address 2001:db8:1::1 (connects to internal network 2001:db8:1::/64).</dd>
<dt class="list-hang" style="margin-top: 1.00em;">
Cisco B</dt>
<dd class="list-hang">
has external IPv4 address B.</dd>
<dt class="list-hang" style="margin-top: 1.00em;">
All the IPv6 internet world</dt>
<dd class="list-hang">
is behind B, so A wants to route 0::0/0 (the IPv6 default route) into the tunnel.</dd>
<dt class="list-hang" style="margin-top: 1.00em;">
The GRE tunnel</dt>
<dd class="list-hang">
will use a transit network: 2001:db8:ffff::1/64 on the <span class="unix">NetBSD</span> side, and ::2/64 on the Cisco side.</dd>
</dl>
<p>
Then the following commands will configure the tunnel:<p>
On Router A (<span class="unix">NetBSD</span>):<p>
<pre style="margin-left: 0.00ex;" class="lit display">
   # ifconfig greN create 
   # ifconfig greN inet6 2001:db8:ffff::1/64 
   # ifconfig greN tunnel A B 
   # route add -inet6 2001:db8:ffff::/64 2001:db8:ffff::2 -ifp greN 
   # route add -inet6 0::0/0 2001:db8:ffff::2 -ifp greN</pre>
<p>
On Router B (Cisco):<p>
<pre style="margin-left: 0.00ex;" class="lit display">
   Interface TunnelX 
     tunnel mode gre ip 
     ipv6 address 2001:db8:ffff::2/64   ! transfer network 
     tunnel source B                    ! e.g. address from LAN interface 
     tunnel destination A               ! where the tunnel is connected to 
   ipv6 route 2001:db8::/64 TunnelX     ! route this network through tunnel</pre>
</div>
</div>
<div class="section">
<h1 id="x4e4f544553">NOTES</h1> The MTU of <span class="symb">gre</span><i class="arg">X</i> interfaces is set to 1476 by default to match the value used by Cisco routers. This may not be an optimal value, depending on the link between the two tunnel endpoints. It can be adjusted via <a class="link-man" href="../8/ifconfig">ifconfig(8)</a>.<p>
There needs to be a route to the decapsulating host that does not run over the tunnel, as this would be a loop. (This is not relevant for IPv6-over-IPv4 tunnels, of course.)<p>
In order to tell <a class="link-man" href="../8/ifconfig">ifconfig(8)</a> to actually mark the interface as up, the keyword &#8220;up&#8221; must be given last on its command line.<p>
The kernel must be set to forward datagrams by either option <span class="emph">GATEWAY</span> in the kernel config file or by issuing the appropriate option to <a class="link-man" href="../8/sysctl">sysctl(8)</a>.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../4/atalk">atalk(4)</a>, <a class="link-man" href="../4/gif">gif(4)</a>, <a class="link-man" href="../4/inet">inet(4)</a>, <a class="link-man" href="../4/ip">ip(4)</a>, <a class="link-man" href="../4/netintro">netintro(4)</a>, <a class="link-man" href="../4/options">options(4)</a>, <a class="link-man" href="../5/protocols">protocols(5)</a>, <a class="link-man" href="../8/ifconfig">ifconfig(8)</a>, <a class="link-man" href="../8/sysctl">sysctl(8)</a><p>
A description of GRE encapsulation can be found in RFC 1701 and RFC 1702.<p>
A description of MOBILE encapsulation can be found in RFC 2004.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> <span class="author">Heiko W.Rupp</span> &#60;<a class="link-mail" href="mailto:hwr@pilhuhn.de">hwr@pilhuhn.de</a>&#62; <span class="author">David Young</span> &#60;<a class="link-mail" href="mailto:dyoung@NetBSD.org">dyoung@NetBSD.org</a>&#62; (GRE in UDP encapsulation, bug fixes)</div>
<div class="section">
<h1 id="x42554753">BUGS</h1> The GRE RFCs are not yet fully implemented (no GRE options).<p>
The MOBILE encapsulation appears to have been broken since it was first added to <span class="unix">NetBSD</span>, until August 2006. It is known to interoperate with another <b class="name">gre</b> in MOBILE mode, however, it has not been tested for interoperability with any other implementation of RFC 2004.<p>
The <span class="unix">NetBSD</span> base system does not (yet) contain a daemon for automatically establishing a UDP tunnel between a host behind a NAT router and a host on the Internet.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
January 4, 2009</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

