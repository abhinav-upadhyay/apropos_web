<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
NFSSVC(2)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
NFSSVC(2)</td>
<td class="head-vol" align="center">
System Calls Manual</td>
<td class="head-rtitle" align="right">
NFSSVC(2)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">nfssvc</b> &#8212; <span class="desc">NFS services</span></div>
<div class="section">
<h1 id="x4c494252415259">LIBRARY</h1> <span class="lib">Standard C Library (libc, &#45;lc)</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">unistd.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">nfs/nfs.h</a>&gt;</b><p>
<i class="ftype">int</i><br>
<b class="fname">nfssvc</b>(<i class="farg" style="white-space:nowrap;">int flags</i>, <i class="farg" style="white-space:nowrap;">void *argstructp</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="fname">nfssvc</b>() function is used by the NFS daemons to pass information into and out of the kernel and also to enter the kernel as a server daemon. The <i class="farg">flags</i> argument consists of several bits that show what action is to be taken once in the kernel and the <i class="farg">argstructp</i> points to one of three structures depending on which bits are set in flags.<div class="subsection">
<h2>Calls used by <a class="link-man" href="../8/nfsd">nfsd(8)</a></h2> On the server side, <b class="fname">nfssvc</b>() is called with the flag <span class="define">NFSSVC_NFSD</span> and a pointer to a<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct nfsd_srvargs { 
	struct nfsd	*nsd_nfsd;	/* Pointer to in kernel nfsd struct */ 
	uid_t		nsd_uid;	/* Effective uid mapped to cred */ 
	u_long		nsd_haddr;	/* Ip address of client */ 
	struct ucred	nsd_cr;		/* Cred. uid maps to */ 
	int		nsd_authlen;	/* Length of auth string (ret) */ 
	char		*nsd_authstr;	/* Auth string (ret) */ 
};</pre>
<p>
to enter the kernel as an <a class="link-man" href="../8/nfsd">nfsd(8)</a> daemon. Whenever an <a class="link-man" href="../8/nfsd">nfsd(8)</a> daemon receives a Kerberos authentication ticket, it will return from <b class="fname">nfssvc</b>() with errno set to <span class="errno">ENEEDAUTH</span>. The <a class="link-man" href="../8/nfsd">nfsd(8)</a> will attempt to authenticate the ticket and generate a set of credentials on the server for the &#8220;user id&#8221; specified in the field nsd_uid. This is done by first authenticating the Kerberos ticket and then mapping the Kerberos principal to a local name and getting a set of credentials for that user via <a class="link-man" href="../3/getpwnam">getpwnam(3)</a> and <a class="link-man" href="../3/getgrouplist">getgrouplist(3)</a>. If successful, the <a class="link-man" href="../8/nfsd">nfsd(8)</a> will call <b class="fname">nfssvc</b>() with the <span class="define">NFSSVC_NFSD</span> and <span class="define">NFSSVC_AUTHIN</span> flags set to pass the credential mapping in nsd_cr into the kernel to be cached on the server socket for that client. If the authentication failed, <a class="link-man" href="../8/nfsd">nfsd(8)</a> calls <b class="fname">nfssvc</b>() with the flags <span class="define">NFSSVC_NFSD</span> and <span class="define">NFSSVC_AUTHINFAIL</span> to denote an authentication failure.<p>
The master <a class="link-man" href="../8/nfsd">nfsd(8)</a> server daemon calls <b class="fname">nfssvc</b>() with the flag <span class="define">NFSSVC_ADDSOCK</span> and a pointer to a<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct nfsd_args { 
	int	sock;		/* Socket to serve */ 
	caddr_t	name;		/* Client address for connection based sockets */ 
	int	namelen;	/* Length of name */ 
};</pre>
<p>
to pass a server side NFS socket into the kernel for servicing by the <a class="link-man" href="../8/nfsd">nfsd(8)</a> daemons.</div>
<div class="subsection">
<h2>Calls used by <a class="link-man" href="../8/mountd">mountd(8)</a></h2> The <a class="link-man" href="../8/mountd">mountd(8)</a> server daemon calls <b class="fname">nfssvc</b>() with the flag <span class="define">NFSSVC_SETEXPORTSLIST</span> and a pointer to a <i class="ftype">struct mountd_exports_list</i> object to atomically change the exports lists of a specific file system. This structure has the following fields:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="type">const char *mel_path</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Path to the file system that will have its exports list replaced by the one described in the other fields.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="type">size_t mel_nexports</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Number of valid entries in the <span class="type">mel_export</span> field. If zero, the exports list will be cleared for the given file system.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="type">struct export_args mel_export[AF_MAX]</span></dt>
<dd class="list-tag" style="margin-left: 24.00ex;">
Set of exports to be used for the given file system.</dd>
</dl>
</div>
</div>
<div class="section">
<h1 id="x52455455524e2056414c554553">RETURN VALUES</h1> Usually <b class="name">nfssvc</b> does not return unless the server is terminated by a signal when a value of 0 is returned. Otherwise, &#45;1 is returned and the global variable <b class="var">errno</b> is set to specify the error.</div>
<div class="section">
<h1 id="x4552524f5253">ERRORS</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">ENEEDAUTH</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
This special error value is really used for authentication support, particularly Kerberos, as explained above.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">EPERM</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The caller is not the super-user.</dd>
</dl>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../8/mount_nfs">mount_nfs(8)</a>, <a class="link-man" href="../8/nfsd">nfsd(8)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">nfssvc</b> function first appeared in <span class="unix">4.4BSD</span>.</div>
<div class="section">
<h1 id="x42554753">BUGS</h1> The <b class="name">nfssvc</b> system call is designed specifically for the NFS support daemons and as such is specific to their requirements. It should really return values to indicate the need for authentication support, since <span class="errno">ENEEDAUTH</span> is not really an error. Several fields of the argument structures are assumed to be valid and sometimes to be unchanged from a previous call, such that <b class="name">nfssvc</b> must be used with extreme care.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
December 30, 2006</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

