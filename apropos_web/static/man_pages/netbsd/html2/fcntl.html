<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
FCNTL(2)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
FCNTL(2)</td>
<td class="head-vol" align="center">
System Calls Manual</td>
<td class="head-rtitle" align="right">
FCNTL(2)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">fcntl</b> &#8212; <span class="desc">file descriptor control</span></div>
<div class="section">
<h1 id="x4c494252415259">LIBRARY</h1> <span class="lib">Standard C Library (libc, &#45;lc)</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">fcntl.h</a>&gt;</b><p>
<i class="ftype">int</i><br>
<b class="fname">fcntl</b>(<i class="farg" style="white-space:nowrap;">int fd</i>, <i class="farg" style="white-space:nowrap;">int cmd</i>, <i class="farg" style="white-space:nowrap;">...</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> <b class="fname">fcntl</b>() provides for control over descriptors. The argument <i class="farg">fd</i> is a descriptor to be operated on by <i class="farg">cmd</i> as described below. The third parameter is called <i class="farg">arg</i> and is technically a pointer to void, but it is interpreted as an int by some commands and ignored by others.<p>
Commands are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_DUPFD</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Return a new descriptor as follows:<p>
<ul style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 4.00ex;" class="list list-bul">
<li class="list-bul" style="margin-top: 0.00em;">
Lowest numbered available descriptor greater than or equal to <i class="farg">arg</i>, which is interpreted as an int.</li>
<li class="list-bul" style="margin-top: 0.00em;">
Same object references as the original descriptor.</li>
<li class="list-bul" style="margin-top: 0.00em;">
New descriptor shares the same file offset if the object was a file.</li>
<li class="list-bul" style="margin-top: 0.00em;">
Same access mode (read, write or read/write).</li>
<li class="list-bul" style="margin-top: 0.00em;">
Same file status flags (i.e., both file descriptors share the same file status flags).</li>
<li class="list-bul" style="margin-top: 0.00em;">
The close-on-exec flag associated with the new file descriptor is cleared to remain open across <a class="link-man" href="../2/execve">execve(2)</a> system calls.</li>
</ul>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_DUPFD_CLOEXEC</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Same as <span class="define">F_DUPFD</span>, but sets the close-on-exec property on the file descriptor created.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_GETFD</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Get the close-on-exec flag associated with the file descriptor <i class="farg">fd</i> as <span class="define">FD_CLOEXEC</span>. If the returned value ANDed with <span class="define">FD_CLOEXEC</span> is 0, the file will remain open across <b class="fname">exec</b>(), otherwise the file will be closed upon execution of <b class="fname">exec</b>() (<i class="farg">arg</i> is ignored).</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_SETFD</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Set the close-on-exec flag associated with <i class="farg">fd</i> to <i class="farg">arg</i>, where <i class="farg">arg</i> is either 0 or <span class="define">FD_CLOEXEC</span>, as described above.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_GETFL</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Get descriptor status flags, as described below (<i class="farg">arg</i> is ignored).</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_SETFL</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Set descriptor status flags to <i class="farg">arg</i>, which is interpreted as an int.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_GETOWN</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Get the process ID or process group currently receiving <span class="define">SIGIO</span> and <span class="define">SIGURG</span> signals; process groups are returned as negative values (<i class="farg">arg</i> is ignored).</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_SETOWN</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Set the process or process group to receive <span class="define">SIGIO</span> and <span class="define">SIGURG</span> signals; process groups are specified by supplying <i class="farg">arg</i> as negative, otherwise <i class="farg">arg</i> is interpreted as a process ID. The argument <i class="farg">arg</i> is interpreted as an int.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_CLOSEM</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Close all file descriptors greater than or equal to <i class="arg">fd</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_MAXFD</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Return the maximum file descriptor number currently open by the process.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_GETNOSIGPIPE</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Return if the <span class="define">O_NOSIGPIPE</span> flag is set in the file descriptor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_SETNOSIGPIPE</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Set or clear the <span class="define">O_NOSIGPIPE</span> in the file descriptor.</dd>
</dl>
<p>
The set of valid flags for the <span class="define">F_GETFL</span> and <span class="define">F_SETFL</span> flags are as follows: <span class="define">O_APPEND</span>, <span class="define">O_ASYNC</span>, <span class="define">O_SYNC</span>, <span class="define">O_NONBLOCK</span>, <span class="define">O_DSYNC</span>, <span class="define">O_RSYNC</span>, <span class="define">O_ALT_IO</span>, <span class="define">O_DIRECT</span>, <span class="define">O_NOSIGPIPE</span>. These flags are described in <a class="link-man" href="../2/open">open(2)</a>.<p>
Several commands are available for doing advisory file locking; they all operate on the following structure:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct flock { 
	off_t	l_start;	/* starting offset */ 
	off_t	l_len;		/* len = 0 means until end of file */ 
	pid_t	l_pid;		/* lock owner */ 
	short	l_type;		/* lock type: read/write, etc. */ 
	short	l_whence;	/* type of l_start */ 
};</pre>
<p>
The commands available for advisory record locking are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_GETLK</span></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Get the first lock that blocks the lock description pointed to by the third argument, <i class="farg">arg</i>, taken as a pointer to a <i class="farg">struct flock</i> (see above). The information retrieved overwrites the information passed to <b class="name">fcntl</b> in the <i class="farg">flock</i> structure. If no lock is found that would prevent this lock from being created, the structure is left unchanged by this function call except for the lock type <i class="farg">l_type</i>, which is set to <span class="define">F_UNLCK</span>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_SETLK</span></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Set or clear a file segment lock according to the lock description pointed to by the third argument, <i class="farg">arg</i>, taken as a pointer to a <i class="farg">struct flock</i> (see above). As specified by the value of <i class="farg">l_type</i>, <span class="define">F_SETLK</span> is used to establish shared (or read) locks (<span class="define">F_RDLCK</span>) or exclusive (or write) locks, (<span class="define">F_WRLCK</span>), as well as remove either type of lock (<span class="define">F_UNLCK</span>). If a shared or exclusive lock cannot be set, <b class="name">fcntl</b> returns immediately with <span class="errno">EAGAIN</span>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_SETLKW</span></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
This command is the same as <span class="define">F_SETLK</span> except that if a shared or exclusive lock is blocked by other locks, the process waits until the request can be satisfied. If a signal that is to be caught is received while <b class="name">fcntl</b> is waiting for a region, the <b class="name">fcntl</b> will be interrupted if the signal handler has not specified the <span class="define">SA_RESTART</span> (see <a class="link-man" href="../2/sigaction">sigaction(2)</a>).</dd>
</dl>
<p>
When a shared lock has been set on a segment of a file, other processes can set shared locks on that segment or a portion of it. A shared lock prevents any other process from setting an exclusive lock on any portion of the protected area. A request for a shared lock fails if the file descriptor was not opened with read access.<p>
An exclusive lock prevents any other process from setting a shared lock or an exclusive lock on any portion of the protected area. A request for an exclusive lock fails if the file was not opened with write access.<p>
The value of <i class="farg">l_whence</i> is <span class="define">SEEK_SET</span>, <span class="define">SEEK_CUR</span>, or <span class="define">SEEK_END</span> to indicate that the relative offset, <i class="farg">l_start</i> bytes, will be measured from the start of the file, current position, or end of the file, respectively. The value of <i class="farg">l_len</i> is the number of consecutive bytes to be locked. If <i class="farg">l_len</i> is negative, the result is undefined. The <i class="farg">l_pid</i> field is only used with <span class="define">F_GETLK</span> to return the process ID of the process holding a blocking lock. After a successful <span class="define">F_GETLK</span> request, the value of <i class="farg">l_whence</i> is <span class="define">SEEK_SET</span>.<p>
Locks may start and extend beyond the current end of a file, but may not start or extend before the beginning of the file. A lock is set to extend to the largest possible value of the file offset for that file if <i class="farg">l_len</i> is set to zero. If <i class="farg">l_whence</i> and <i class="farg">l_start</i> point to the beginning of the file, and <i class="farg">l_len</i> is zero, the entire file is locked. If an application wishes only to do entire file locking, the <a class="link-man" href="../2/flock">flock(2)</a> system call is much more efficient.<p>
There is at most one type of lock set for each byte in the file. Before a successful return from an <span class="define">F_SETLK</span> or an <span class="define">F_SETLKW</span> request when the calling process has previously existing locks on bytes in the region specified by the request, the previous lock type for each byte in the specified region is replaced by the new lock type. As specified above under the descriptions of shared locks and exclusive locks, an <span class="define">F_SETLK</span> or an <span class="define">F_SETLKW</span> request fails or blocks respectively when another process has existing locks on bytes in the specified region and the type of any of those locks conflicts with the type specified in the request.</div>
<div class="section">
<h1 id="x52455455524e2056414c554553">RETURN VALUES</h1> Upon successful completion, the value returned depends on <i class="farg">cmd</i> as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_DUPFD</span></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
A new file descriptor.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_GETFD</span></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Value of flag (only the low-order bit is defined).</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_GETFL</span></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Value of flags.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_GETOWN</span></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Value of file descriptor owner.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">F_MAXFD</span></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Value of the highest file descriptor open by the process.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
other</dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Value other than &#45;1.</dd>
</dl>
<p>
Otherwise, a value of &#45;1 is returned and <b class="var">errno</b> is set to indicate the error.</div>
<div class="section">
<h1 id="x434f4d5041544942494c495459">COMPATIBILITY</h1> This interface follows the completely stupid semantics of AT&amp;T System&#160;V UNIX and IEEE Std 1003.1-1988 (&#8220;POSIX.1&#8221;) that require that all locks associated with a file for a given process are removed when  <i>any</i> file descriptor for that file is closed by that process. This semantic means that applications must be aware of any files that a subroutine library may access. For example if an application for updating the password file locks the password file database while making the update, and then calls <a class="link-man" href="../3/getpwnam">getpwnam(3)</a> to retrieve a record, the lock will be lost because <a class="link-man" href="../3/getpwnam">getpwnam(3)</a> opens, reads, and closes the password database. The database close will release all locks that the process has associated with the database, even if the library routine never requested a lock on the database.<p>
Another minor semantic problem with this interface is that locks are not inherited by a child process created using the <a class="link-man" href="../2/fork">fork(2)</a> function. The <a class="link-man" href="../2/flock">flock(2)</a> interface has much more rational last close semantics and allows locks to be inherited by child processes. Calling <a class="link-man" href="../2/flock">flock(2)</a> is recommended for applications that want to ensure the integrity of their locks when using library routines or wish to pass locks to their children. Note that <a class="link-man" href="../2/flock">flock(2)</a> and <b class="name">fcntl</b> locks may be safely used concurrently.<p>
All locks associated with a file for a given process are removed when the process terminates.<p>
A potential for deadlock occurs if a process controlling a locked region is put to sleep by attempting to lock the locked region of another process. This implementation detects that sleeping until a locked region is unlocked would cause a deadlock and fails with an <span class="errno">EDEADLK</span> error.</div>
<div class="section">
<h1 id="x4552524f5253">ERRORS</h1> <b class="fname">fcntl</b>() will fail if:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">EAGAIN</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The argument <i class="farg">arg</i> is <span class="define">F_SETLK</span>, the type of lock (<i class="farg">l_type</i>) is a shared lock (<span class="define">F_RDLCK</span>) or exclusive lock (<span class="define">F_WRLCK</span>), and the segment of a file to be locked is already exclusive-locked by another process; or the type is an exclusive lock and some portion of the segment of a file to be locked is already shared-locked or exclusive-locked by another process.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">EBADF</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
<i class="farg">fildes</i> is not a valid open file descriptor.<p>
The argument <i class="farg">cmd</i> is <span class="define">F_SETLK</span> or <span class="define">F_SETLKW</span>, the type of lock (<i class="farg">l_type</i>) is a shared lock (<span class="define">F_RDLCK</span>), and <i class="farg">fildes</i> is not a valid file descriptor open for reading.<p>
The argument <i class="farg">cmd</i> is <span class="define">F_SETLK</span> or <span class="define">F_SETLKW</span>, the type of lock (<i class="farg">l_type</i>) is an exclusive lock (<span class="define">F_WRLCK</span>), and <i class="farg">fildes</i> is not a valid file descriptor open for writing.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">EDEADLK</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The argument <i class="farg">cmd</i> is <span class="define">F_SETLKW</span>, and a deadlock condition was detected.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">EINTR</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The argument <i class="farg">cmd</i> is <span class="define">F_SETLKW</span>, and the function was interrupted by a signal.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">EINVAL</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The argument <i class="farg">cmd</i> is invalid.<p>
The argument <i class="farg">cmd</i> is <span class="define">F_DUPFD</span> and <i class="farg">arg</i> is negative or greater than the maximum allowable number (see <a class="link-man" href="../3/getdtablesize">getdtablesize(3)</a>).<p>
The argument <i class="farg">cmd</i> is <span class="define">F_GETLK</span>, <span class="define">F_SETLK</span>, or <span class="define">F_SETLKW</span> and the data to which <i class="farg">arg</i> points is not valid, or <i class="farg">fildes</i> refers to a file that does not support locking.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">EMFILE</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The argument <i class="farg">cmd</i> is <span class="define">F_DUPFD</span> and the maximum number of file descriptors permitted for the process are already in use, or no file descriptors greater than or equal to <i class="farg">arg</i> are available.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">ENFILE</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
<i class="farg">cmd</i> is <span class="define">F_DUPFD</span> and system-wide the maximum allowed number of file descriptors are currently open.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">ENOLCK</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The argument <i class="farg">cmd</i> is <span class="define">F_SETLK</span> or <span class="define">F_SETLKW</span>, and satisfying the lock or unlock request would result in the number of locked regions in the system exceeding a system-imposed limit.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">ESRCH</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
<i class="farg">cmd</i> is <span class="define">F_SETOWN</span> and the process ID given as argument is not in use.</dd>
</dl>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../2/close">close(2)</a>, <a class="link-man" href="../2/execve">execve(2)</a>, <a class="link-man" href="../2/flock">flock(2)</a>, <a class="link-man" href="../2/open">open(2)</a>, <a class="link-man" href="../2/sigaction">sigaction(2)</a>, <a class="link-man" href="../3/getdtablesize">getdtablesize(3)</a></div>
<div class="section">
<h1 id="x5354414e4441524453">STANDARDS</h1> The <b class="fname">fcntl</b>() function conforms to IEEE Std 1003.1-1990 (&#8220;POSIX.1&#8221;).</div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="fname">fcntl</b>() function call appeared in <span class="unix">4.2BSD</span>.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
January 23, 2012</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

