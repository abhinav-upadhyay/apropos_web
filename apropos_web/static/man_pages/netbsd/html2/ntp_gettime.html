<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
NTP_ADJTIME(2)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
NTP_ADJTIME(2)</td>
<td class="head-vol" align="center">
System Calls Manual</td>
<td class="head-rtitle" align="right">
NTP_ADJTIME(2)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">ntp_adjtime</b>, <b class="name">ntp_gettime</b> &#8212; <span class="desc">Network Time Protocol (NTP) daemon interface system calls</span></div>
<div class="section">
<h1 id="x4c494252415259">LIBRARY</h1> <span class="lib">Standard C Library (libc, &#45;lc)</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/time.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">sys/timex.h</a>&gt;</b><p>
<i class="ftype">int</i><br>
<b class="fname">ntp_adjtime</b>(<i class="farg" style="white-space:nowrap;">struct timex *</i>);<p>
<i class="ftype">int</i><br>
<b class="fname">ntp_gettime</b>(<i class="farg" style="white-space:nowrap;">struct ntptimeval *</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The two system calls <b class="fname">ntp_adjtime</b>() and <b class="fname">ntp_gettime</b>() are the kernel interface to the Network Time Protocol (NTP) daemon <a class="link-man" href="../8/ntpd">ntpd(8)</a>.<p>
The <b class="fname">ntp_adjtime</b>() function is used by the NTP daemon to adjust the system clock to an externally derived time. The time offset and related variables which are set by <b class="fname">ntp_adjtime</b>() are used by <a class="link-man" href="../9/hardclock">hardclock(9)</a> to adjust the phase and frequency of the phase- or frequency-lock loop (PLL resp. FLL) which controls the system clock.<p>
The <b class="fname">ntp_gettime</b>() function provides the time, maximum error (sync distance) and estimated error (dispersion) to client user application programs.<p>
In the following, all variables that refer PPS are only relevant if the <span class="emph">PPS_SYNC</span> option (see <a class="link-man" href="../4/options">options(4)</a>) is enabled in the kernel.<p>
<b class="fname">ntp_adjtime</b>() has as argument a <b class="var">struct timex *</b> of the following form:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct timex { 
	unsigned int modes;	/* clock mode bits (wo) */ 
	long offset;		/* time offset (us) (rw) */ 
	long freq;		/* frequency offset (scaled ppm) (rw) */ 
	long maxerror;		/* maximum error (us) (rw) */ 
	long esterror;		/* estimated error (us) (rw) */ 
	int status;		/* clock status bits (rw) */ 
	long constant;		/* pll time constant (rw) */ 
	long precision;		/* clock precision (us) (ro) */ 
	long tolerance;		/* clock frequency tolerance (scaled 
				 * ppm) (ro) */ 
	/* 
	 * The following read-only structure members are implemented 
	 * only if the PPS signal discipline is configured in the 
	 * kernel. 
	 */ 
	long ppsfreq;		/* pps frequency (scaled ppm) (ro) */ 
	long jitter;		/* pps jitter (us) (ro) */ 
	int shift;		/* interval duration (s) (shift) (ro) */ 
	long stabil;		/* pps stability (scaled ppm) (ro) */ 
	long jitcnt;		/* jitter limit exceeded (ro) */ 
	long calcnt;		/* calibration intervals (ro) */ 
	long errcnt;		/* calibration errors (ro) */ 
	long stbcnt;		/* stability limit exceeded (ro) */ 
};</pre>
<p>
The members of this struct have the following meanings when used as argument for <b class="fname">ntp_adjtime</b>():<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">modes</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Defines what settings should be changed with the current <b class="fname">ntp_adjtime</b>() call (write-only). Bitwise OR of the following:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
MOD_OFFSET</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
set time offset</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
MOD_FREQUENCY</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
set frequency offset</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
MOD_MAXERROR</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
set maximum time error</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
MOD_ESTERROR</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
set estimated time error</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
MOD_STATUS</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
set clock status bits</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
MOD_TIMECONST</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
set PLL time constant</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
MOD_CLKA</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
set clock A</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
MOD_CLKB</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
set clock B</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">offset</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Time offset (in microseconds), used by the PLL/FLL to adjust the system time in small increments (read-write).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">freq</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Frequency offset (scaled ppm) (read-write).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">maxerror</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Maximum error (in microseconds). Initialized by an <b class="fname">ntp_adjtime</b>() call, and increased by the kernel once each second to reflect the maximum error bound growth (read-write).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">esterror</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Estimated error (in microseconds). Set and read by <b class="fname">ntp_adjtime</b>(), but unused by the kernel (read-write).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">status</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
System clock status bits (read-write). Bitwise OR of the following:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
STA_PLL</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Enable PLL updates (read-write).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
STA_PPSFREQ</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Enable PPS freq discipline (read-write).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
STA_PPSTIME</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Enable PPS time discipline (read-write).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
STA_FLL</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Select frequency-lock mode (read-write).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
STA_INS</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Insert leap (read-write).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
STA_DEL</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Delete leap (read-write).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
STA_UNSYNC</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Clock unsynchronized (read-write).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
STA_FREQHOLD</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Hold frequency (read-write).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
STA_PPSSIGNAL</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
PPS signal present (read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
STA_PPSJITTER</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
PPS signal jitter exceeded (read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
STA_PPSWANDER</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
PPS signal wander exceeded (read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
STA_PPSERROR</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
PPS signal calibration error (read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
STA_CLOCKERR</dt>
<dd class="list-tag" style="margin-left: 13.00ex;">
Clock hardware fault (read-only).</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">constant</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
PLL time constant, determines the bandwidth, or &#8220;stiffness&#8221;, of the PLL (read-write).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">precision</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Clock precision (in microseconds). In most cases the same as the kernel tick variable (see <a class="link-man" href="../9/hz">hz(9)</a>). If a precision clock counter or external time-keeping signal is available, it could be much lower (and depend on the state of the signal) (read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">tolerance</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Maximum frequency error, or tolerance of the CPU clock oscillator (scaled ppm). Ordinarily a property of the architecture, but could change under the influence of external time-keeping signals (read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">ppsfreq</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
PPS frequency offset produced by the frequency median filter (scaled ppm) (read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">jitter</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
PPS jitter measured by the time median filter in microseconds (read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">shift</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Logarithm to base 2 of the interval duration in seconds (PPS, read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">stabil</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
PPS stability (scaled ppm); dispersion (wander) measured by the frequency median filter (read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">jitcnt</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Number of seconds that have been discarded because the jitter measured by the time median filter exceeded the limit <span class="emph">MAXTIME</span> (PPS, read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">calcnt</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Count of calibration intervals (PPS, read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">errcnt</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Number of calibration intervals that have been discarded because the wander exceeded the limit <span class="emph">MAXFREQ</span> or where the calibration interval jitter exceeded two ticks (PPS, read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">stbcnt</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Number of calibration intervals that have been discarded because the frequency wander exceeded the limit <span class="emph">MAXFREQ</span>/4 (PPS, read-only).</dd>
</dl>
After the <b class="fname">ntp_adjtime</b>() call, the <b class="var">struct timex *</b> structure contains the current values of the corresponding variables.<p>
<b class="fname">ntp_gettime</b>() has as argument a <b class="var">struct ntptimeval *</b> with the following members:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
struct ntptimeval { 
	struct timespec time;	/* current time (ro) */ 
	long maxerror;		/* maximum error (us) (ro) */ 
	long esterror;		/* estimated error (us) (ro) */ 
	/* the following are placeholders for now */ 
	long tai;		/* TAI offset */ 
	int time_state;		/* time status */ 
};</pre>
<p>
These have the following meaning:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">time</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Current time (read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">maxerror</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Maximum error in microseconds (read-only).</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">esterror</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Estimated error in microseconds (read-only).</dd>
</dl>
</div>
<div class="section">
<h1 id="x52455455524e2056414c554553">RETURN VALUES</h1> <b class="fname">ntp_adjtime</b>() and <b class="fname">ntp_gettime</b>() return the current state of the clock on success, or any of the errors of <a class="link-man" href="../9/copyin">copyin(9)</a> and <a class="link-man" href="../9/copyout">copyout(9)</a>. <b class="fname">ntp_adjtime</b>() may additionally return <span class="errno">EPERM</span> if the user calling <b class="fname">ntp_adjtime</b>() does not have sufficient permissions.<p>
Possible states of the clock are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 5.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
TIME_OK</dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Everything okay, no leap second warning.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
TIME_INS</dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
&#8220;insert leap second&#8221; warning.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
TIME_DEL</dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
&#8220;delete leap second&#8221; warning.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
TIME_OOP</dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Leap second in progress.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
TIME_WAIT</dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Leap second has occurred.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
TIME_ERROR</dt>
<dd class="list-tag" style="margin-left: 10.00ex;">
Clock not synchronized.</dd>
</dl>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../4/options">options(4)</a>, <a class="link-man" href="../8/ntpd">ntpd(8)</a>, <a class="link-man" href="../9/hardclock">hardclock(9)</a>, <a class="link-man" href="../9/hz">hz(9)</a><p>
<span class="ref"><span class="ref-auth">J. Mogul</span>, <span class="ref-auth">D. Mills</span>, <span class="ref-auth">J. Brittenson</span>, <span class="ref-auth">J. Stone</span>, and <span class="ref-auth">U. Windl</span>, <span class="ref-title">Pulse-Per-Second API for UNIX-like Operating Systems</span>, <span class="ref-rep">RFC 2783</span>, <span class="ref-date">March 2000</span>.</span></div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
October 22, 2007</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

