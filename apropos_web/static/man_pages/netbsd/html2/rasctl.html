<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
RASCTL(2)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
RASCTL(2)</td>
<td class="head-vol" align="center">
System Calls Manual</td>
<td class="head-rtitle" align="right">
RASCTL(2)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">rasctl</b> &#8212; <span class="desc">restartable atomic sequences</span></div>
<div class="section">
<h1 id="x4c494252415259">LIBRARY</h1> <span class="lib">Standard C Library (libc, &#45;lc)</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/types.h</a>&gt;</b><br>
<b class="includes">#include &lt;<a class="link-includes">sys/ras.h</a>&gt;</b><p>
<i class="ftype">int</i><br>
<b class="fname">rasctl</b>(<i class="farg" style="white-space:nowrap;">void *addr</i>, <i class="farg" style="white-space:nowrap;">size_t len</i>, <i class="farg" style="white-space:nowrap;">int op</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> Restartable atomic sequences are code sequences which are guaranteed to execute without preemption. This property is assured by the kernel by re-executing a preempted sequence from the start. This functionality enables applications to build atomic sequences which, when executed to completion, will have executed atomically. Restartable atomic sequences are intended to be used on systems that do not have hardware support for low-overhead atomic primitives.<p>
The <b class="name">rasctl</b> function manipulates a process's set of restartable atomic sequences. If a restartable atomic sequence is registered and the process is preempted within the range <i class="farg">addr</i> and <i class="farg">addr</i>+<i class="farg">len</i>, then the process is resumed at <i class="farg">addr</i>.<p>
As the process execution can be rolled-back, the code in the sequence should have no side effects other than a final store at <i class="farg">addr</i>+<i class="farg">len</i>&#45;1. The kernel does not guarantee that the sequences are successfully restartable. It assumes that the application knows what it is doing. Restartable atomic sequences should adhere to the following guidelines:<p>
<ul style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-bul">
<li class="list-bul" style="margin-top: 0.00em;">
have a single entry point and a single exit point;</li>
<li class="list-bul" style="margin-top: 0.00em;">
not execute emulated instructions; and</li>
<li class="list-bul" style="margin-top: 0.00em;">
not invoke any functions or system calls.</li>
</ul>
<p>
Restartable atomic sequences are inherited from the parent by the child during the <a class="link-man" href="../2/fork">fork(2)</a> operation. Restartable atomic sequences for a process are removed during <a class="link-man" href="../3/exec">exec(3)</a>.<p>
The operations that can be applied to a restartable atomic sequence are specified by the <i class="farg">op</i> argument. Possible operations are:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">RAS_INSTALL</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
Install this sequence.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">RAS_PURGE</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
Remove the specified registered sequence for this process.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">RAS_PURGE_ALL</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
Remove all registered sequences for this process.</dd>
</dl>
<p>
The <span class="define">RAS_PURGE</span> and <span class="define">RAS_PURGE_ALL</span> operations should be considered to have undefined behaviour if there are any other runnable threads in the address space which might be executing within the restartable atomic sequence(s) at the time of the purge. The caller must be responsible for ensuring that there is some form of coordination with other threads to prevent unexpected behaviour.<p>
To preserve the atomicity of sequences, the kernel attempts to protect the sequences from alteration by the <a class="link-man" href="../2/ptrace">ptrace(2)</a> facility.</div>
<div class="section">
<h1 id="x52455455524e2056414c554553">RETURN VALUES</h1> Upon successful completion, <b class="fname">rasctl</b>() returns zero. Otherwise, &#45;1 is returned and <b class="var">errno</b> is set to indicate the error.</div>
<div class="section">
<h1 id="x4552524f5253">ERRORS</h1> The <b class="name">rasctl</b> function will fail if:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">EINVAL</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Invalid input was supplied, such as an invalid operation, an invalid address, or an invalid length. A process may have a finite number of atomic sequences that is defined at compile time.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">EOPNOTSUPP</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Restartable atomic sequences are not supported by the kernel.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
&#91;<span class="errno">ESRCH</span>&#93;</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Restartable atomic sequence not registered.</dd>
</dl>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../2/ptrace">ptrace(2)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">rasctl</b> functionality first appeared in <span class="unix">NetBSD&#160;2.0</span> based on a similar interface that appeared in Mach 2.5.</div>
<div class="section">
<h1 id="x43415645415453">CAVEATS</h1> Modern compilers reorder instruction sequences to optimize speed. The start address and size of a <b class="name">RAS</b> need to be protected against this. One level of protection is created by compiler dependent instructions, abstracted from user level code via the following macros:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">RAS_DECL(name)</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Declares the start and end labels used internally by the other macros to mark a <b class="name">RAS</b>. The name uniquely identifies the <b class="name">RAS</b>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">RAS_START(name)</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Marks the start of the code. Each restart returns to the instruction following this macro.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">RAS_END(name)</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Marks the end of the restartable code.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">RAS_ADDR(name)</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Returns the start address of a <b class="name">RAS</b> and is used to create the first argument to <b class="name">rasctl</b>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">RAS_SIZE(name)</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Returns the size of a <b class="name">RAS</b> and is used as second argument to <b class="name">rasctl</b>.</dd>
</dl>
Recent versions of <a class="link-man" href="../1/gcc">gcc(1)</a> require the <b class="flag">&#45;fno-reorder-blocks</b> flag to prevent blocks of code wrapped with <span class="define">RAS_START</span>/<span class="define">RAS_END</span> being moved outside these labels. However, be aware that this may not always be sufficient to prevent <a class="link-man" href="../1/gcc">gcc(1)</a> from generating non-restartable code within the <b class="name">RAS</b> due to register clobbers. It is, therefore, strongly recommended that restartable atomic sequences are coded in assembly. <b class="name">RAS</b> blocks within assembly code can be specified by using the following macros:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">RAS_START_ASM(name)</span></dt>
<dd class="list-tag" style="margin-left: 26.00ex;">
Similar to <b class="name">RAS_START</b> but for use in assembly source code.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">RAS_END_ASM(name)</span></dt>
<dd class="list-tag" style="margin-left: 26.00ex;">
Similar to <b class="name">RAS_END</b> but for use in assembly source code.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">RAS_START_ASM_HIDDEN(name)</span></dt>
<dd class="list-tag" style="margin-left: 26.00ex;">
Similar to <b class="name">RAS_START_ASM</b> except that the symbol will not be placed in the dynamic symbol table.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">RAS_END_ASM_HIDDEN(name)</span></dt>
<dd class="list-tag" style="margin-left: 26.00ex;">
Similar to <b class="name">RAS_END_ASM</b> except that the symbol will not be placed in the dynamic symbol table.</dd>
</dl>
</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
April 29, 2008</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

