<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
IPMON(5)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
IPMON(5)</td>
<td class="head-vol" align="center">
File Formats Manual</td>
<td class="head-rtitle" align="right">
IPMON(5)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1>NAME</h1> ipmon, ipmon.conf &#45; ipmon configuration file format</div>
<div class="section">
<h1>DESCRIPTION</h1> The <b>ipmon.conf</b> file is optionally loaded by <b>ipmon</b> when it starts.  Its primary purpose is to direct <b>ipmon</b> to do extra actions when it sees a specific log entry from the kernel.<p>
A line in the <b>ipmon.conf</b> file is either a comment or a <b>match</b> line.  Each line must have a matching segment and an action segment. These are to the left and right of the word "do", respectively. A comment line is any line that starts with a #.<p>
<b>NOTE:</b> This file differs from all other IPFilter configuration files because it attempts to match every line with every log record received.  It does <b>not</b> stop at the <b>first</b> match or only use the <b>last</b> match.<p>
For the action segment, a <b>match</b> line can delivery output to one of three destinations:  <b>file</b>, <b>email</b> or <b>command</b>.  For example:<p>
<br>
match { type = ipf; } do { save("file:///var/log/ipf-log"); };<br>
match { type = nat; } do { syslog; };<br>
match { type = state; } do { execute("/bin/mail root"); };<br>
<p>
and is roughly described like this:<p>
match { <i>match-it ,match-it, ...</i> } do { <i>action, action, ...</i>};<p>
where there can be a list of matching expressions and a list of actions to perform if all of the matching expressions are matched up with by the current log entry.<p>
The lines above would save all ipf log entries to /var/log/ipf-log, send all of the entries for NAT (ipnat related) to syslog and generate an email to root for each log entry from the state tables.</div>
<div class="section">
<h1>SYNTAX - MATCHING</h1> In the above example, the matching segment was confined to matching on the type of log entry generated.  The full list of fields that can be used here is:<dl>
<dt>
direction &lt;in|out&gt;</dt>
<dd>
This option is used to match on log records generated for packets going in or out.</dd>
</dl>
<dl>
<dt>
dstip &lt;address/mask&gt;</dt>
<dd>
This option is used to match against the destination address associated with the packet being logged.  A "/mask" must be given and given in CIDR notation (/0-/32) so to specify host 192.2.2.1, 192.2.2.1/32 must be given.</dd>
</dl>
<dl>
<dt>
dstport &lt;portnumber&gt;</dt>
<dd>
This option is used to match against the destination port in log entries. A number must be given, symbolic names (such as those from /etc/services) are not recognised by the parser.</dd>
</dl>
<dl>
<dt>
every &lt;second|# seconds|packet|# packets&gt;</dt>
<dd>
This option is used to regulate how often an <b>ipmon.conf</b> entry is actioned in response to an otherwise matching log record from the kernel.</dd>
</dl>
<dl>
<dt>
group &lt;name|number&gt;</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
interface &lt;interface-name&gt;</dt>
<dd>
This option is used to match against the network interface name associated with the action causing the logging to happen.  In general this will be the network interface where the packet is seen by IPFilter.</dd>
</dl>
<dl>
<dt>
logtag &lt;number&gt;</dt>
<dd>
This option is used to match against tags set by ipf rules in <b>ipf.conf</b>. These tags are set with "set-tag(log=100)" appended to filter rules.</dd>
</dl>
<dl>
<dt>
nattag &lt;string&gt;</dt>
<dd>
This option is used to match against tags set by NAT rules in <b>ipnat.conf</b>.</dd>
</dl>
<dl>
<dt>
protocol &lt;name|number&gt;</dt>
<dd>
This option is used to match against the IP protocol field in the packet being logged.</dd>
</dl>
<dl>
<dt>
result &lt;pass|block|nomatch|log&gt;</dt>
<dd>
This option is used to match against the result of packet matching in the kernel.  If a packet is logged, using a  <b>log</b> rule in <b>ipf.conf</b> then it will match "log" here.  The "nomatch" option is for use with matching log records generated for all packets as the default.</dd>
</dl>
<dl>
<dt>
rule &lt;number&gt;</dt>
<dd>
This option is used to match against the <i>number</i> of the rule causing the record to be generated.  The  <i>number</i> of a rule can be observed using "ipfstat -ion".</dd>
</dl>
<dl>
<dt>
srcip &lt;address/mask&gt;</dt>
<dd>
This option is used to match against the source address associated with the packet being logged.  A "/mask" must be given and given in CIDR notation (/0-/32) so to specify host 192.2.2.1, 192.2.2.1/32 must be given.</dd>
</dl>
<dl>
<dt>
srcport &lt;portnumber&gt;</dt>
<dd>
This option is used to match against the source port in log entries. A number must be given, symbolic names (such as those from /etc/services) are not recognised by the parser.</dd>
</dl>
<dl>
<dt>
type &lt;ipf|nat|state&gt;</dt>
<dd>
The format for files accepted by ipmon is described by the following grammar: <b>NOTE:</b> At present, only IPv4 matching is available for source/destination address matching.</dd>
</dl>
</div>
<div class="section">
<h1>SYNTAX - ACTIONS</h1> The list of actions supported is as follows:<dl>
<dt>
save("file://&lt;filename&gt;")</dt>
<dd>
save("raw://&lt;filename&gt;") Write out the log record to the filename given.  This file will be closed and reopened on receipt of a SIGHUP.  If the  <i>raw</i> target is used, binary log data, as read from the kernel, is written out rather than a text log record. The filename should be an absolute target, including the root directory. Thus, saving to /var/log/ipmon.log would be, as an example, save("file:///var/log/ipmon.log").</dd>
</dl>
<dl>
<dt>
syslog("&lt;facility&gt;.&lt;priority&gt;")</dt>
<dd>
syslog("&lt;facility&gt;.") syslog(".&lt;priority&gt;") To log a text record via syslog, the  <b>syslog</b> action word is used. The facility used by default is determined at first by the default compiled into  <b>ipmon</b> (usually LOG_LOCAL0), which can be changed via the command line (-L &lt;facility&gt;) or in an  <b>ipf.conf</b> rule using the  <i>level</i> option with logging.  If the facility is specified here, it takes precedence over all other settings. The same applies to the syslog priority. By default, ipmon will determine a priority for the packet, depending on whether or not it has been blocked, passed, etc. It is possible to force the complete facility/priority value for each log entry or to choose to replace only one of them.</dd>
</dl>
<dl>
<dt>
execute("&lt;command string&gt;")</dt>
<dd>
The <b>execute</b> action runs the specified command each time the log entry matches and feeds the log entry, as text, to the command being executed. The command string given is executed using /bin/sh.</dd>
</dl>
<dl>
<dt>
nothing</dt>
<dd>
Literally, do nothing.  Use this if you want to be verbose in your config file about doing nothing for a particular log record.</dd>
</dl>
</div>
<div class="section">
<h1>PLUGIN ACTIONS</h1> It is possible to configure <b>ipmon</b> to use externally supplied modules to save log entries with. These are added to <b>ipmon</b> using the <i>load_action</i> configuration line. The syntax of this line is:<p>
<br>
load_action &lt;name&gt; &lt;path&gt;;<br>
<dl>
<dt>
name</dt>
<dd>
is a short name for the action. It does not need to correspond to the name of the library file, but inside the library file, the functions <b>&lt;name&gt;destroy</b> , <b>&lt;name&gt;parse</b> and <b>&lt;name&gt;store</b> must be present.</dd>
</dl>
<dl>
<dt>
path</dt>
<dd>
specifies the path in the filesystem to the shared object that contains the implementation of the new action. After the new action has been declared using <i>load_action</i> it can then be used in any <i>do</i> statement.</dd>
</dl>
</div>
<div class="section">
<h1>EXAMPLES</h1> Some further examples are:<p>
<br>
#<br>
# log everything to syslog local4, regardless<br>
#<br>
match { ; } do { syslog("local4."); };<br>
#<br>
# keep a local copy of things packets to/from port 80<br>
#<br>
match { srcport = 80; } do { save("file:///var/log/web"); };<br>
match { dstport = 80; } do { save("file:///var/log/web"); };<br>
#<br>
load_action local "/usr/lib/libmyaction.so";<br>
match { dstip 127.0.0.1; } do { local("local options"); };<br>
#<br>
</div>
<div class="section">
<h1>MATCHING</h1> All entries of the rules present in the file are compared for matches - there is no first or last rule match.</div>
<div class="section">
<h1>FILES</h1> /dev/ipl<div style="height: 0.00em;">
&#160;</div>
/dev/ipf<div style="height: 0.00em;">
&#160;</div>
/dev/ipnat<div style="height: 0.00em;">
&#160;</div>
/dev/ipstate<div style="height: 0.00em;">
&#160;</div>
/etc/ipmon.conf</div>
<div class="section">
<h1>SEE ALSO</h1> ipmon(8), ipl(4)</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tr>
<td class="foot-date">
</td>
<td class="foot-os" align="right">
</td>
</tr>
</table>
</div>
</body>
</html>

