<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
POSTFIX-WRAPPER(5)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
POSTFIX-WRAPPER(5)</td>
<td class="head-vol" align="center">
File Formats Manual</td>
<td class="head-rtitle" align="right">
POSTFIX-WRAPPER(5)</td>
</tr>
</tbody>
</table>
<br>
<div class="section">
<h1>NAME</h1> postfix-wrapper &#45; Postfix multi-instance API</div>
<div class="section">
<h1>DESCRIPTION</h1><br>
Support for managing multiple Postfix instances is available as of version 2.6. Instances share executable files and documentation, but have their own directories for configuration, queue and data files.<div style="height: 1.00em;">
&#160;</div>
This document describes how the familiar "postfix start" etc. user interface can be used to manage one or multiple Postfix instances, and gives details of an API to coordinate activities between the postfix(1) command and a multi-instance manager program.<div style="height: 1.00em;">
&#160;</div>
With multi-instance support, the default Postfix instance is always required. This instance is identified by the config_directory parameter's default value.</div>
<div class="section">
<h1>GENERAL OPERATION</h1><br>
Multi-instance support is backwards compatible: when you run only one Postfix instance, commands such as "postfix start" will not change behavior at all.<div style="height: 1.00em;">
&#160;</div>
Even with multiple Postfix instances, you can keep using the same postfix commands in boot scripts, upgrade procedures, and other places. The commands do more work, but humans are not forced to learn new tricks.<div style="height: 1.00em;">
&#160;</div>
For example, to start all Postfix instances, use:<dl>
<dt>
</dt>
<dd>
# postfix start</dd>
</dl>
<p>
Other postfix(1) commands also work as expected. For example, to find out what Postfix instances exist in a multi-instance configuration, use:<dl>
<dt>
</dt>
<dd>
# postfix status</dd>
</dl>
<p>
This enumerates the status of all Postfix instances within a multi-instance configuration.</div>
<div class="section">
<h1>MANAGING AN INDIVIDUAL POSTFIX INSTANCE</h1><br>
To manage a specific Postfix instance, specify its configuration directory on the postfix(1) command line:<dl>
<dt>
</dt>
<dd>
# postfix -c <i>/path/to/config_directory command</i></dd>
</dl>
<p>
Alternatively, the postfix(1) command accepts the instance's configuration directory via the MAIL_CONFIG environment variable (the -c command-line option has higher precedence).<div style="height: 1.00em;">
&#160;</div>
Otherwise, the postfix(1) command will operate on all Postfix instances.</div>
<div class="section">
<h1>ENABLING POSTFIX(1) MULTI-INSTANCE MODE</h1><br>
By default, the postfix(1) command operates in single-instance mode. In this mode the command invokes the postfix-script file directly (currently installed in the daemon directory). This file contains the commands that start or stop one Postfix instance, that upgrade the configuration of one Postfix instance, and so on.<div style="height: 1.00em;">
&#160;</div>
When the postfix(1) command operates in multi-instance mode as discussed below, the command needs to execute start, stop, etc.  commands for each Postfix instance.  This multiplication of commands is handled by a multi-instance manager program.<div style="height: 1.00em;">
&#160;</div>
Turning on postfix(1) multi-instance mode goes as follows: in the default Postfix instance's main.cf file, 1) specify the pathname of a multi-instance manager program with the multi_instance_wrapper parameter; 2) populate the multi_instance_directories parameter with the configuration directory pathnames of additional Postfix instances.  For example:<dl>
<dt>
</dt>
<dd>
<br>
/etc/postfix/main.cf:<br>
    multi_instance_wrapper = $daemon_directory/postfix-wrapper<br>
    multi_instance_directories = /etc/postfix-test<br>
</dd>
</dl>
<p>
The $daemon_directory/postfix-wrapper file implements a simple manager and contains instructions for creating Postfix instances by hand.  The postmulti(1) command provides a more extensive implementation including support for life-cycle management.<div style="height: 1.00em;">
&#160;</div>
The multi_instance_directories and other main.cf parameters are listed below in the CONFIGURATION PARAMETERS section.<div style="height: 1.00em;">
&#160;</div>
In multi-instance mode, the postfix(1) command invokes the $multi_instance_wrapper command instead of the postfix-script file. This multi-instance manager in turn executes the postfix(1) command in single-instance mode for each Postfix instance.<div style="height: 1.00em;">
&#160;</div>
To illustrate the main ideas behind multi-instance operation, below is an example of a simple but useful multi-instance manager implementation:<dl>
<dt>
</dt>
<dd>
<br>
#!/bin/sh<p>
<br>
: ${command_directory?"do not invoke this command directly"}<p>
<br>
POSTCONF=$command_directory/postconf<br>
POSTFIX=$command_directory/postfix<br>
instance_dirs=&#768;$POSTCONF -h multi_instance_directories |<br>
                sed 's/,/ /'&#768; || exit 1<p>
<br>
err=0<br>
for dir in $config_directory $instance_dirs<br>
do<br>
    case "$1" in<br>
    stop|abort|flush|reload|drain)<br>
        test "&#768;$POSTCONF -c $dir -h multi_instance_enable&#768;" &#92;<br>
            = yes || continue;;<br>
    start)<br>
        test "&#768;$POSTCONF -c $dir -h multi_instance_enable&#768;" &#92;<br>
            = yes || {<br>
            $POSTFIX -c $dir check || err=$?<br>
            continue<br>
        };;<br>
    esac<br>
    $POSTFIX -c $dir "$@" || err=$?<br>
done<p>
<br>
exit $err<br>
</dd>
</dl>
</div>
<div class="section">
<h1>PER-INSTANCE MULTI-INSTANCE MANAGER CONTROLS</h1><br>
Each Postfix instance has its own main.cf file with parameters that control how the multi-instance manager operates on that instance.  This section discusses the most important settings.<div style="height: 1.00em;">
&#160;</div>
The setting "multi_instance_enable = yes" allows the multi-instance manager to start (stop, etc.) the corresponding Postfix instance. For safety reasons, this setting is not the default.<div style="height: 1.00em;">
&#160;</div>
The default setting "multi_instance_enable = no" is useful for manual testing with "postfix -c  <i>/path/name</i> start" etc.  The multi-instance manager will not start such an instance, and it will skip commands such as "stop" or "flush" that require a running Postfix instance.  The multi-instance manager will execute commands such as "check", "set-permissions" or "upgrade-configuration", and it will replace "start" by "check" so that problems will be reported even when the instance is disabled.</div>
<div class="section">
<h1>MAINTAINING SHARED AND NON-SHARED FILES</h1><br>
Some files are shared between Postfix instances, such as executables and manpages, and some files are per-instance, such as configuration files, mail queue files, and data files.  See the NON-SHARED FILES section below for a list of per-instance files.<div style="height: 1.00em;">
&#160;</div>
Before Postfix multi-instance support was implemented, the executables, manpages, etc., have always been maintained as part of the default Postfix instance.<div style="height: 1.00em;">
&#160;</div>
With multi-instance support, we simply continue to do this. Specifically, a Postfix instance will not check or update shared files when that instance's config_directory value is listed with the default main.cf file's multi_instance_directories parameter.<div style="height: 1.00em;">
&#160;</div>
The consequence of this approach is that the default Postfix instance should be checked and updated before any other instances.</div>
<div class="section">
<h1>MULTI-INSTANCE API SUMMARY</h1><br>
Only the multi-instance manager implements support for the multi_instance_enable configuration parameter. The multi-instance manager will start only Postfix instances whose main.cf file has "multi_instance_enable = yes". A setting of "no" allows a Postfix instance to be tested by hand.<div style="height: 1.00em;">
&#160;</div>
The postfix(1) command operates on only one Postfix instance when the -c option is specified, or when MAIL_CONFIG is present in the process environment. This is necessary to terminate recursion.<div style="height: 1.00em;">
&#160;</div>
Otherwise, when the multi_instance_directories parameter value is non-empty, the postfix(1) command executes the command specified with the multi_instance_wrapper parameter, instead of executing the commands in postfix-script.<div style="height: 1.00em;">
&#160;</div>
The multi-instance manager skips commands such as "stop" or "reload" that require a running Postfix instance, when an instance does not have "multi_instance_enable = yes". This avoids false error messages.<div style="height: 1.00em;">
&#160;</div>
The multi-instance manager replaces a "start" command by "check" when a Postfix instance's main.cf file does not have "multi_instance_enable = yes". This substitution ensures that problems will be reported even when the instance is disabled.<div style="height: 1.00em;">
&#160;</div>
No Postfix command or script will update or check shared files when its config_directory value is listed in the default main.cf's multi_instance_directories parameter value.  Therefore, the default instance should be checked and updated before any Postfix instances that depend on it.<div style="height: 1.00em;">
&#160;</div>
Set-gid commands such as postdrop(1) and postqueue(1) effectively append the multi_instance_directories parameter value to the legacy alternate_config_directories parameter value. The commands use this information to determine whether a -c option or MAIL_CONFIG environment setting specifies a legitimate value.<div style="height: 1.00em;">
&#160;</div>
The legacy alternate_config_directories parameter remains necessary for non-default Postfix instances that are running different versions of Postfix, or that are not managed together with the default Postfix instance.</div>
<div class="section">
<h1>ENVIRONMENT VARIABLES</h1><br>
<dl>
<dt>
MAIL_CONFIG</dt>
<dd>
When present, this forces the postfix(1) command to operate only on the specified Postfix instance. This environment variable is exported by the postfix(1) -c option, so that postfix(1) commands in descendant processes will work correctly.</dd>
</dl>
</div>
<div class="section">
<h1>CONFIGURATION PARAMETERS</h1><br>
The text below provides only a parameter summary. See postconf(5) for more details.<dl>
<dt>
<b>multi_instance_directories (empty)</b></dt>
<dd>
An optional list of non-default Postfix configuration directories; these directories belong to additional Postfix instances that share the Postfix executable files and documentation with the default Postfix instance, and that are started, stopped, etc., together with the default Postfix instance.</dd>
</dl>
<dl>
<dt>
<b>multi_instance_wrapper (empty)</b></dt>
<dd>
The pathname of a multi-instance manager command that the  <b>postfix</b>(1) command invokes when the multi_instance_directories parameter value is non-empty.</dd>
</dl>
<dl>
<dt>
<b>multi_instance_name (empty)</b></dt>
<dd>
The optional instance name of this Postfix instance.</dd>
</dl>
<dl>
<dt>
<b>multi_instance_group (empty)</b></dt>
<dd>
The optional instance group name of this Postfix instance.</dd>
</dl>
<dl>
<dt>
<b>multi_instance_enable (no)</b></dt>
<dd>
Allow this Postfix instance to be started, stopped, etc., by a multi-instance manager.</dd>
</dl>
</div>
<div class="section">
<h1>NON-SHARED FILES</h1><br>
<dl>
<dt>
<b>config_directory (see 'postconf -d' output)</b></dt>
<dd>
The default location of the Postfix main.cf and master.cf configuration files.</dd>
</dl>
<dl>
<dt>
<b>data_directory (see 'postconf -d' output)</b></dt>
<dd>
The directory with Postfix-writable data files (for example: caches, pseudo-random numbers).</dd>
</dl>
<dl>
<dt>
<b>queue_directory (see 'postconf -d' output)</b></dt>
<dd>
The location of the Postfix top-level queue directory.</dd>
</dl>
</div>
<div class="section">
<h1>SEE ALSO</h1><br>
postfix(1) Postfix control program<br>
postmulti(1) full-blown multi-instance manager<br>
$daemon_directory/postfix-wrapper simple multi-instance manager</div>
<div class="section">
<h1>LICENSE</h1><br>
The Secure Mailer license must be distributed with this software.</div>
<div class="section">
<h1>AUTHOR(S)</h1><br>
Wietse Venema<br>
IBM T.J. Watson Research<br>
P.O. Box 704<br>
Yorktown Heights, NY 10598, USA</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tr>
<td class="foot-date">
</td>
<td class="foot-os" align="right">
</td>
</tr>
</table>
</div>
</body>
</html>

