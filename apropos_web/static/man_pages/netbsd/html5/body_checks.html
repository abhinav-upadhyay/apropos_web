<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
HEADER_CHECKS(5)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
HEADER_CHECKS(5)</td>
<td class="head-vol" align="center">
File Formats Manual</td>
<td class="head-rtitle" align="right">
HEADER_CHECKS(5)</td>
</tr>
</tbody>
</table>
<br>
<div class="section">
<h1>NAME</h1> header_checks &#45; Postfix built-in content inspection</div>
<div class="section">
<h1>SYNOPSIS</h1><br>
<b>header_checks = pcre:/etc/postfix/header_checks</b><br>
<b>mime_header_checks = pcre:/etc/postfix/mime_header_checks</b><br>
<b>nested_header_checks = pcre:/etc/postfix/nested_header_checks</b><br>
<b>body_checks = pcre:/etc/postfix/body_checks</b><div style="height: 1.00em;">
&#160;</div>
<br>
<b>milter_header_checks = pcre:/etc/postfix/milter_header_checks</b><div style="height: 1.00em;">
&#160;</div>
<br>
<b>smtp_header_checks = pcre:/etc/postfix/smtp_header_checks</b><br>
<b>smtp_mime_header_checks = pcre:/etc/postfix/smtp_mime_header_checks</b><br>
<b>smtp_nested_header_checks = pcre:/etc/postfix/smtp_nested_header_checks</b><br>
<b>smtp_body_checks = pcre:/etc/postfix/smtp_body_checks</b><div style="height: 1.00em;">
&#160;</div>
<br>
<b>postmap -q "</b><i>string</i><b>" pcre:/etc/postfix/</b><i>filename</i><br>
<b>postmap -q - pcre:/etc/postfix/</b><i>filename</i> &lt;<i>inputfile</i><br>
</div>
<div class="section">
<h1>DESCRIPTION</h1><br>
This document describes access control on the content of message headers and message body lines; it is implemented by the Postfix  <b>cleanup</b>(8) server before mail is queued. See  <b>access</b>(5) for access control on remote SMTP client information.<div style="height: 1.00em;">
&#160;</div>
Each message header or message body line is compared against a list of patterns. When a match is found the corresponding action is executed, and the matching process is repeated for the next message header or message body line.<div style="height: 1.00em;">
&#160;</div>
Note: message headers are examined one logical header at a time, even when a message header spans multiple lines. Body lines are always examined one line at a time.<div style="height: 1.00em;">
&#160;</div>
For examples, see the EXAMPLES section at the end of this manual page.<div style="height: 1.00em;">
&#160;</div>
Postfix header or body_checks are designed to stop a flood of mail from worms or viruses; they do not decode attachments, and they do not unzip archives. See the documents referenced below in the README FILES section if you need more sophisticated content analysis.</div>
<div class="section">
<h1>FILTERS WHILE RECEIVING MAIL</h1><br>
Postfix implements the following four built-in content inspection classes while receiving mail:<dl>
<dt>
<b>header_checks</b> (default: empty)</dt>
<dd>
These are applied to initial message headers (except for the headers that are processed with  <b>mime_header_checks</b>).</dd>
</dl>
<dl>
<dt>
<b>mime_header_checks</b> (default: <b>$header_checks</b>)</dt>
<dd>
These are applied to MIME related message headers only.<div style="height: 1.00em;">
&#160;</div>
This feature is available in Postfix 2.0 and later.</dd>
</dl>
<dl>
<dt>
<b>nested_header_checks</b> (default: <b>$header_checks</b>)</dt>
<dd>
These are applied to message headers of attached email messages (except for the headers that are processed with  <b>mime_header_checks</b>).<div style="height: 1.00em;">
&#160;</div>
This feature is available in Postfix 2.0 and later.</dd>
</dl>
<dl>
<dt>
<b>body_checks</b></dt>
<dd>
These are applied to all other content, including multi-part message boundaries.<div style="height: 1.00em;">
&#160;</div>
With Postfix versions before 2.0, all content after the initial message headers is treated as body content.</dd>
</dl>
</div>
<div class="section">
<h1>FILTERS AFTER RECEIVING MAIL</h1><br>
Postfix supports a subset of the built-in content inspection classes after the message is received:<dl>
<dt>
<b>milter_header_checks</b> (default: empty)</dt>
<dd>
These are applied to headers that are added with Milter applications.<div style="height: 1.00em;">
&#160;</div>
This feature is available in Postfix 2.7 and later.</dd>
</dl>
</div>
<div class="section">
<h1>FILTERS WHILE DELIVERING MAIL</h1><br>
Postfix supports all four content inspection classes while delivering mail via SMTP.<dl>
<dt>
<b>smtp_header_checks</b> (default: empty)</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>smtp_mime_header_checks</b> (default: empty)</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>smtp_nested_header_checks</b> (default: empty)</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>smtp_body_checks</b> (default: empty)</dt>
<dd>
These features are available in Postfix 2.5 and later.</dd>
</dl>
</div>
<div class="section">
<h1>COMPATIBILITY</h1><br>
With Postfix version 2.2 and earlier specify "<b>postmap</b>  <b>-fq</b>" to query a table that contains case sensitive patterns. By default, regexp: and pcre: patterns are case insensitive.</div>
<div class="section">
<h1>TABLE FORMAT</h1><br>
This document assumes that header and body_checks rules are specified in the form of Postfix regular expression lookup tables. Usually the best performance is obtained with  <b>pcre</b> (Perl Compatible Regular Expression) tables. The  <b>regexp</b> (POSIX regular expressions) tables are usually slower, but more widely available. Use the command " <b>postconf -m</b>" to find out what lookup table types your Postfix system supports.<div style="height: 1.00em;">
&#160;</div>
The general format of Postfix regular expression tables is given below. For a discussion of specific pattern or flags syntax, see  <b>pcre_table</b>(5) or <b>regexp_table</b>(5), respectively.<dl>
<dt>
<b>/</b><i>pattern</i><b>/</b><i>flags action</i></dt>
<dd>
When /<i>pattern</i>/ matches the input string, execute the corresponding  <i>action</i>. See below for a list of possible actions.</dd>
</dl>
<dl>
<dt>
<b>!/</b><i>pattern</i><b>/</b><i>flags action</i></dt>
<dd>
When /<i>pattern</i>/ does <b>not</b> match the input string, execute the corresponding  <i>action</i>.</dd>
</dl>
<dl>
<dt>
<b>if /</b><i>pattern</i><b>/</b><i>flags</i></dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>endif</b></dt>
<dd>
Match the input string against the patterns between <b>if</b> and  <b>endif</b>, if and only if the same input string also matches / <i>pattern</i>/. The <b>if</b>..<b>endif</b> can nest.<div style="height: 1.00em;">
&#160;</div>
Note: do not prepend whitespace to patterns inside  <b>if</b>..<b>endif</b>.</dd>
</dl>
<dl>
<dt>
<b>if !/</b><i>pattern</i><b>/</b><i>flags</i></dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>endif</b></dt>
<dd>
Match the input string against the patterns between <b>if</b> and  <b>endif</b>, if and only if the same input string does  <b>not</b> match /<i>pattern</i>/. The <b>if</b>..<b>endif</b> can nest.</dd>
</dl>
<dl>
<dt>
blank lines and comments</dt>
<dd>
Empty lines and whitespace-only lines are ignored, as are lines whose first non-whitespace character is a `#'.</dd>
</dl>
<dl>
<dt>
multi-line text</dt>
<dd>
A pattern/action line starts with non-whitespace text. A line that starts with whitespace continues a logical line.</dd>
</dl>
</div>
<div class="section">
<h1>TABLE SEARCH ORDER</h1><br>
For each line of message input, the patterns are applied in the order as specified in the table. When a pattern is found that matches the input line, the corresponding action is executed and then the next input line is inspected.</div>
<div class="section">
<h1>TEXT SUBSTITUTION</h1><br>
Substitution of substrings from the matched expression into the  <i>action</i> string is possible using the conventional Perl syntax ( <b>$1</b>, <b>$2</b>, etc.). The macros in the result string may need to be written as  <b>${n}</b> or  <b>$(n)</b> if they aren't followed by whitespace.<div style="height: 1.00em;">
&#160;</div>
Note: since negated patterns (those preceded by <b>!</b>) return a result when the expression does not match, substitutions are not available for negated patterns.</div>
<div class="section">
<h1>ACTIONS</h1><br>
Action names are case insensitive. They are shown in upper case for consistency with other Postfix documentation.<dl>
<dt>
<b>DISCARD </b><i>optional text...</i></dt>
<dd>
Claim successful delivery and silently discard the message. Log the optional text if specified, otherwise log a generic message.<div style="height: 1.00em;">
&#160;</div>
Note: this action disables further header or body_checks inspection of the current message and affects all recipients. To discard only one recipient without discarding the entire message, use the transport(5) table to direct mail to the discard(8) service.<div style="height: 1.00em;">
&#160;</div>
This feature is available in Postfix 2.0 and later.<div style="height: 1.00em;">
&#160;</div>
This feature is not supported with smtp header/body checks.</dd>
</dl>
<dl>
<dt>
<b>DUNNO</b></dt>
<dd>
Pretend that the input line did not match any pattern, and inspect the next input line. This action can be used to shorten the table search.<div style="height: 1.00em;">
&#160;</div>
For backwards compatibility reasons, Postfix also accepts  <b>OK</b> but it is (and always has been) treated as <b>DUNNO</b>.<div style="height: 1.00em;">
&#160;</div>
This feature is available in Postfix 2.1 and later.</dd>
</dl>
<dl>
<dt>
<b>FILTER </b><i>transport:destination</i></dt>
<dd>
After the message is queued, send the entire message through the specified external content filter. The  <i>transport</i> name specifies the first field of a mail delivery agent definition in master.cf; the syntax of the next-hop  <i>destination</i> is described in the manual page of the corresponding delivery agent.  More information about external content filters is in the Postfix FILTER_README file.<div style="height: 1.00em;">
&#160;</div>
Note 1: do not use $<i>number</i> regular expression substitutions for  <i>transport</i> or <i>destination</i> unless you know that the information has a trusted origin.<div style="height: 1.00em;">
&#160;</div>
Note 2: this action overrides the main.cf <b>content_filter</b> setting, and affects all recipients of the message. In the case that multiple  <b>FILTER</b> actions fire, only the last one is executed.<div style="height: 1.00em;">
&#160;</div>
Note 3: the purpose of the FILTER command is to override message routing.  To override the recipient's  <i>transport</i> but not the next-hop  <i>destination</i>, specify an empty filter  <i>destination</i> (Postfix 2.7 and later), or specify a  <i>transport:destination</i> that delivers through a different Postfix instance (Postfix 2.6 and earlier). Other options are using the recipient-dependent  <b>transport_maps</b> or the sender-dependent  <b>sender_dependent_default_transport_maps</b> features.<div style="height: 1.00em;">
&#160;</div>
This feature is available in Postfix 2.0 and later.<div style="height: 1.00em;">
&#160;</div>
This feature is not supported with smtp header/body checks.</dd>
</dl>
<dl>
<dt>
<b>HOLD </b><i>optional text...</i></dt>
<dd>
Arrange for the message to be placed on the <b>hold</b> queue, and inspect the next input line.  The message remains on  <b>hold</b> until someone either deletes it or releases it for delivery. Log the optional text if specified, otherwise log a generic message.<div style="height: 1.00em;">
&#160;</div>
Mail that is placed on hold can be examined with the  <b>postcat</b>(1) command, and can be destroyed or released with the  <b>postsuper</b>(1) command.<div style="height: 1.00em;">
&#160;</div>
Note: use "<b>postsuper -r</b>" to release mail that was kept on hold for a significant fraction of  <b>$maximal_queue_lifetime</b> or  <b>$bounce_queue_lifetime</b>, or longer. Use "<b>postsuper -H</b>" only for mail that will not expire within a few delivery attempts.<div style="height: 1.00em;">
&#160;</div>
Note: this action affects all recipients of the message.<div style="height: 1.00em;">
&#160;</div>
This feature is available in Postfix 2.0 and later.<div style="height: 1.00em;">
&#160;</div>
This feature is not supported with smtp header/body checks.</dd>
</dl>
<dl>
<dt>
<b>IGNORE</b></dt>
<dd>
Delete the current line from the input, and inspect the next input line.</dd>
</dl>
<dl>
<dt>
<b>INFO </b><i>optional text...</i></dt>
<dd>
Log an "info:" record with the <i>optional text...</i> (or log a generic text), and inspect the next input line. This action is useful for routine logging or for debugging.<div style="height: 1.00em;">
&#160;</div>
This feature is available in Postfix 2.8 and later.</dd>
</dl>
<dl>
<dt>
<b>PREPEND </b><i>text...</i></dt>
<dd>
Prepend one line with the specified text, and inspect the next input line.<div style="height: 1.00em;">
&#160;</div>
Notes:</dd>
</dl>
<div style="margin-left: 5.00ex;">
<dl>
<dt>
&#8226;</dt>
<dd>
The prepended text is output on a separate line, immediately before the input that triggered the  <b>PREPEND</b> action.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
The prepended text is not considered part of the input stream: it is not subject to header/body checks or address rewriting, and it does not affect the way that Postfix adds missing message headers.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
When prepending text before a message header line, the prepended text must begin with a valid message header label.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
This action cannot be used to prepend multi-line text.</dd>
</dl>
</div>
<dl>
<dt>
</dt>
<dd>
This feature is available in Postfix 2.1 and later.<div style="height: 1.00em;">
&#160;</div>
This feature is not supported with milter_header_checks.</dd>
</dl>
<dl>
<dt>
<b>REDIRECT </b><i>user@domain</i></dt>
<dd>
Write a message redirection request to the queue file, and inspect the next input line. After the message is queued, it will be sent to the specified address instead of the intended recipient(s).<div style="height: 1.00em;">
&#160;</div>
Note: this action overrides the <b>FILTER</b> action, and affects all recipients of the message. If multiple  <b>REDIRECT</b> actions fire, only the last one is executed.<div style="height: 1.00em;">
&#160;</div>
This feature is available in Postfix 2.1 and later.<div style="height: 1.00em;">
&#160;</div>
This feature is not supported with smtp header/body checks.</dd>
</dl>
<dl>
<dt>
<b>REPLACE </b><i>text...</i></dt>
<dd>
Replace the current line with the specified text, and inspect the next input line.<div style="height: 1.00em;">
&#160;</div>
This feature is available in Postfix 2.2 and later. The description below applies to Postfix 2.2.2 and later.<div style="height: 1.00em;">
&#160;</div>
Notes:</dd>
</dl>
<div style="margin-left: 5.00ex;">
<dl>
<dt>
&#8226;</dt>
<dd>
When replacing a message header line, the replacement text must begin with a valid header label.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
The replaced text remains part of the input stream. Unlike the result from the  <b>PREPEND</b> action, a replaced message header may be subject to address rewriting and may affect the way that Postfix adds missing message headers.</dd>
</dl>
</div>
<dl>
<dt>
<b>REJECT </b><i>optional text...</i></dt>
<dd>
Reject the entire message. Reply with <i>optional text...</i> when the optional text is specified, otherwise reply with a generic error message.<div style="height: 1.00em;">
&#160;</div>
Note: this action disables further header or body_checks inspection of the current message and affects all recipients.<div style="height: 1.00em;">
&#160;</div>
Postfix version 2.3 and later support enhanced status codes. When no code is specified at the beginning of  <i>optional</i>  <i>text...</i>, Postfix inserts a default enhanced status code of "5.7.1".<div style="height: 1.00em;">
&#160;</div>
This feature is not supported with smtp header/body checks.</dd>
</dl>
<dl>
<dt>
<b>WARN </b><i>optional text...</i></dt>
<dd>
Log a "warning:" record with the <i>optional text...</i> (or log a generic text), and inspect the next input line. This action is useful for debugging and for testing a pattern before applying more drastic actions.</dd>
</dl>
</div>
<div class="section">
<h1>BUGS</h1><br>
Empty lines never match, because some map types mis-behave when given a zero-length search string.  This limitation may be removed for regular expression tables in a future release.<div style="height: 1.00em;">
&#160;</div>
Many people overlook the main limitations of header and body_checks rules.<dl>
<dt>
&#8226;</dt>
<dd>
These rules operate on one logical message header or one body line at a time. A decision made for one line is not carried over to the next line.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
If text in the message body is encoded (RFC 2045) then the rules need to be specified for the encoded form.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
Likewise, when message headers are encoded (RFC 2047) then the rules need to be specified for the encoded form.</dd>
</dl>
<p>
Message headers added by the <b>cleanup</b>(8) daemon itself are excluded from inspection. Examples of such message headers are  <b>From:</b>, <b>To:</b>, <b>Message-ID:</b>, <b>Date:</b>.<div style="height: 1.00em;">
&#160;</div>
Message headers deleted by the <b>cleanup</b>(8) daemon will be examined before they are deleted. Examples are:  <b>Bcc:</b>,  <b>Content-Length:</b>, <b>Return-Path:</b>.</div>
<div class="section">
<h1>CONFIGURATION PARAMETERS</h1><br>
<dl>
<dt>
<b>body_checks</b></dt>
<dd>
Lookup tables with content filter rules for message body lines. These filters see one physical line at a time, in chunks of at most  <b>$line_length_limit</b> bytes.</dd>
</dl>
<dl>
<dt>
<b>body_checks_size_limit</b></dt>
<dd>
The amount of content per message body segment (attachment) that is subjected to  <b>$body_checks</b> filtering.</dd>
</dl>
<dl>
<dt>
<b>header_checks</b></dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>mime_header_checks</b> (default: <b>$header_checks</b>)</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>nested_header_checks</b> (default: <b>$header_checks</b>)</dt>
<dd>
Lookup tables with content filter rules for message header lines: respectively, these are applied to the initial message headers (not including MIME headers), to the MIME headers anywhere in the message, and to the initial headers of attached messages.<div style="height: 1.00em;">
&#160;</div>
Note: these filters see one logical message header at a time, even when a message header spans multiple lines. Message headers that are longer than  <b>$header_size_limit</b> characters are truncated.</dd>
</dl>
<dl>
<dt>
<b>disable_mime_input_processing</b></dt>
<dd>
While receiving mail, give no special treatment to MIME related message headers; all text after the initial message headers is considered to be part of the message body. This means that  <b>header_checks</b> is applied to all the initial message headers, and that  <b>body_checks</b> is applied to the remainder of the message.<div style="height: 1.00em;">
&#160;</div>
Note: when used in this manner, <b>body_checks</b> will process a multi-line message header one line at a time.</dd>
</dl>
</div>
<div class="section">
<h1>EXAMPLES</h1><br>
Header pattern to block attachments with bad file name extensions.  For convenience, the PCRE /x flag is specified, so that there is no need to collapse the pattern into a single line of text.  The purpose of the [[:xdigit:]] sub-expressions is to recognize Windows CLSID strings.<div style="height: 1.00em;">
&#160;</div>
<br>
/etc/postfix/main.cf:<br>
    header_checks = pcre:/etc/postfix/header_checks.pcre<p>
<br>
/etc/postfix/header_checks.pcre:<br>
    /^Content-(Disposition|Type).*name&#92;s*=&#92;s*"?(.*(&#92;.|=2E)(<br>
      ade|adp|asp|bas|bat|chm|cmd|com|cpl|crt|dll|exe|<br>
      hlp|ht[at]|<br>
      inf|ins|isp|jse?|lnk|md[betw]|ms[cipt]|nws|<br>
      &#92;{[[:xdigit:]]{8}(?:-[[:xdigit:]]{4}){3}-[[:xdigit:]]{12}&#92;}|<br>
      ops|pcd|pif|prf|reg|sc[frt]|sh[bsm]|swf|<br>
      vb[esx]?|vxd|ws[cfh]))(&#92;?=)?"?&#92;s*(;|$)/x<br>
        REJECT Attachment name "$2" may not end with ".$4"<br>
<div style="height: 1.00em;">
&#160;</div>
Body pattern to stop a specific HTML browser vulnerability exploit.<div style="height: 1.00em;">
&#160;</div>
<br>
/etc/postfix/main.cf:<br>
    body_checks = regexp:/etc/postfix/body_checks<p>
<br>
/etc/postfix/body_checks:<br>
    /^&lt;iframe src=(3D)?cid:.* height=(3D)?0 width=(3D)?0&gt;$/<br>
        REJECT IFRAME vulnerability exploit</div>
<div class="section">
<h1>SEE ALSO</h1><br>
cleanup(8), canonicalize and enqueue Postfix message<br>
pcre_table(5), format of PCRE lookup tables<br>
regexp_table(5), format of POSIX regular expression tables<br>
postconf(1), Postfix configuration utility<br>
postmap(1), Postfix lookup table management<br>
postsuper(1), Postfix janitor<br>
postcat(1), show Postfix queue file contents<br>
RFC 2045, base64 and quoted-printable encoding rules<br>
RFC 2047, message header encoding for non-ASCII text</div>
<div class="section">
<h1>README FILES</h1><br>
Use "<b>postconf readme_directory</b>" or " <b>postconf html_directory</b>" to locate this information.<br>
DATABASE_README, Postfix lookup table overview<br>
CONTENT_INSPECTION_README, Postfix content inspection overview<br>
BUILTIN_FILTER_README, Postfix built-in content inspection<br>
BACKSCATTER_README, blocking returned forged mail</div>
<div class="section">
<h1>LICENSE</h1><br>
The Secure Mailer license must be distributed with this software.</div>
<div class="section">
<h1>AUTHOR(S)</h1><br>
Wietse Venema<br>
IBM T.J. Watson Research<br>
P.O. Box 704<br>
Yorktown Heights, NY 10598, USA</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tr>
<td class="foot-date">
</td>
<td class="foot-os" align="right">
</td>
</tr>
</table>
</div>
</body>
</html>

