<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="/static/man_pages/netbsd/style.css" type="text/css" media="all">
<title>
NPF.CONF(5)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
NPF.CONF(5)</td>
<td class="head-vol" align="center">
File Formats Manual</td>
<td class="head-rtitle" align="right">
NPF.CONF(5)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">npf.conf</b> &#8212; <span class="desc">NPF packet filter configuration file</span></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> <b class="name">npf.conf</b> is the default configuration file for the NPF packet filter.<p>
This manual page serves as a reference for editing <b class="name">npf.conf</b>. Please refer to the official NPF documentation for comprehensive and in-depth information.<p>
There are multiple structural elements <b class="name">npf.conf</b> may contain: <b class="config">variable</b> and <b class="config">table</b> definitions (with or without content), abstraction <b class="config">groups</b>, packet filtering <b class="config">rules</b>, <b class="config">map</b> rules for address translation and <b class="config">procedure</b> definitions to call on filtered packets. The minimal <b class="name">npf.conf</b> must contain a mandatory <b class="config">default group</b>.</div>
<div class="section">
<h1 id="x53594e544158">SYNTAX</h1><div class="subsection">
<h2 id="x5661726961626c6573">Variables</h2> Variables are specified using the dollar ($) sign, which is used both in definitions and uses of a variable. Variables are defined by assigning a value to them as follows:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
$var1 = 10.0.0.1</pre>
<p>
A variable may also be defined as a set:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
$var2 = { 10.0.0.1, 10.0.0.2 }</pre>
<p>
Common variable definitions are for IP addresses, networks, ports, and interfaces.</div>
<div class="subsection">
<h2 id="x5461626c6573">Tables</h2> Tables are specified using a name between angle brackets &lt; and &gt;. The following is an example of table definition:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
table &lt;black&gt; type hash dynamic 
<p>
</pre>
Currently, tables support three storage types: "hash", "tree", or "cdb". They can also be "dynamic" or static i.e. loaded from the specified file.<p>
The file should contain a list of IP addresses and/or networks in the form of:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
10.0.0.0/24 
10.1.1.1</pre>
<p>
Tables of type "hash" and "cdb" can only contain IP addresses. Also, the latter can only be static.</div>
<div class="subsection">
<h2 id="x496e7465726661636573">Interfaces</h2> Interfaces can be specified as the values of the variables:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
$pub_if_list = { inet4(wm0), inet4(wm1) }</pre>
<p>
In the context of filtering, an interface provides a list of its all IP addresses, including IPv4 and IPv6. Specific interface addresses can be selected by the family, e.g.:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
$pub_if4 = inet4(wm0) 
$pub_if46 = { inet4(wm0), inet6(wm0) }</pre>
</div>
<div class="subsection">
<h2 id="x47726f757073">Groups</h2> Groups may have the following options: name, interface, and direction. They are defined in the following form:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
group "my-name" in on wm0 { 
	# List of rules 
}</pre>
</div>
<div class="subsection">
<h2 id="x52756c6573">Rules</h2> With a rule statement NPF is instructed to <b class="config">pass</b> or <b class="config">block</b> a packet depending on packet header information, transit direction and interface it arrives on, either immediately upon match (keyword <b class="config">final</b>) or using the last match. The rule can also instruct NPF to create an entry in the state table when passing the packet, to notify the sender when blocking it, and to apply a procedure to the packet (e.g. "log") in either case.<p>
A "fully-featured" rule would for example be:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
pass stateful in final family inet4 proto tcp flags S/SA \ 
	from $source port $sport to $dest port $dport apply "someproc"</pre>
<p>
Any protocol in <i class="file">/etc/protocols</i> can be specified. Further packet specification at present is limited to protocol TCP understanding flags, TCP and UDP understanding source and destination ports, and ICMP and IPv6-ICMP understanding icmp-type.<p>
Alternatively, NPF supports <a class="link-man" href="../7/pcap-filter">pcap-filter(7)</a> syntax, for example:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
block out final pcap-filter "tcp and dst 10.1.1.252"</pre>
<p>
Fragments are not selectable since NPF always reassembles packets before further processing.</div>
<div class="subsection">
<h2 id="x537461746566756c">Stateful</h2> Stateful packet inspection is enabled using <b class="config">stateful</b> or <b class="config">stateful-ends</b> keywords. The former creates a state which is uniquely identified by a 5-tuple (source and destination IP addresses, port numbers and an interface identifier). The latter excludes the interface identifier and must be used with precaution. In both cases, a full TCP state tracking is performed for TCP connections and a limited tracking for message-based protocols (UDP and ICMP).<p>
By default, a stateful rule implies SYN-only flag check ("flags S/SAFR") for the TCP packets. It is not advisable to change this behavior; however, it can be overridden with the <b class="config">flags</b> keyword.</div>
<div class="subsection">
<h2 id="x4d6170">Map</h2> Network Address Translation (NAT) is expressed in a form of segment mapping. The translation may be dynamic (stateful) or static (stateless). The following mapping types are available:<p>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="file">-&gt;</i></dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
outbound NAT (translation of the source)</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="file">&lt;-</i></dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
inbound NAT (translation of the destination)</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="file">&lt;-&gt;</i></dt>
<dd class="list-tag" style="margin-left: 3.00ex;">
bi-directional NAT (combination of inbound and outbound NAT)</dd>
</dl>
<p>
The following would translate the source to the IP address specified by the $pub_ip for the packets on the interface $ext_if.<p>
<pre style="margin-left: 0.00ex;" class="lit display">
map $ext_if dynamic 10.1.1.0/24 -&gt; $pub_ip</pre>
<p>
Translations are implicitly filtered by limiting the operation to the network segments specified, that is, translation would be performed only on packets originating from 10.1.1.0/24 network. Explicit filter criteria can be specified using "pass &lt;criteria&gt;" as an additional option of the mapping.</div>
<div class="subsection">
<h2 id="x50726f63656475726573">Procedures</h2> A rule procedure is defined as a collection of extension calls (it may have none). Every extension call has a name and a list of options in the form of key-value pairs. Depending on the call, the key might represent the argument and the value might be optional. For example:<p>
<pre style="margin-left: 0.00ex;" class="lit display">
procedure "someproc" { 
	log: npflog0 
	normalize: "random-id", "min-ttl" 64 
}</pre>
<p>
In this case, the procedure calls the logging and normalisation modules.</div>
<div class="subsection">
<h2 id="x4d697363">Misc</h2> Text after a hash (&#8216;#&#8217;) character is considered a comment. The backslash (&#8216;&#92;&#8217;) character at the end of a line marks a continuation line, i.e., the next line is considered an extension of the present line.</div>
</div>
<div class="section">
<h1 id="x4752414d4d4152">GRAMMAR</h1> The following is a non-formal BNF-like definition of the grammar. The definition is simplified and is intended to be human readable, therefore it does not strictly represent the full syntax, which is more flexible.<p>
<pre style="margin-left: 0.00ex;" class="lit display">
; Syntax of a single line.  Lines can be separated by LF (\n) or 
; a semicolon.  Comments start with a hash (#) character. 
 
syntax		= var-def | set-param | alg | table-def | 
		  map | group | rproc | comment 
 
; Variable definition.  Names can be alpha-numeric, including "_" character. 
 
var-name	= "$" . string 
interface	= interface-name | var-name 
var-def		= var "=" ( var-value | "{" value *[ "," value ] "}" ) 
 
; Parameter setting. 
set-param	= "set" param-value 
 
; Application level gateway.  The name should be in the double quotes. 
 
alg		= "alg" alg-name 
 
; Table definition.  Table ID shall be numeric.  Path is in the double quotes. 
 
table-id	= &lt;table-name&gt; 
table-def	= "table" table-id "type" ( "hash" | "tree" | "cdb" ) 
		  ( "dynamic" | "file" path ) 
 
; Mapping for address translation. 
 
map		= "map" interface 
		  ( "static" [ "algo" algorithm ] | "dynamic" ) 
		  net-seg ( "-&gt;" | "&lt;-" | "&lt;-&gt;" ) net-seg 
		  [ "pass" filt-opts ] 
 
; Rule procedure definition.  The name should be in the double quotes. 
; 
; Each call can have its own options in a form of key-value pairs. 
; Both key and values may be strings (either in double quotes or not) 
; and numbers, depending on the extension. 
 
proc		= "procedure" proc-name "{" *( proc-call [ new-line ] ) "}" 
proc-opts	= key " " val [ "," proc-opts ] 
proc-call	= call-name ":" proc-opts new-line 
 
; Group definition and the rule list. 
 
group		= "group" ( "default" | group-opts ) "{" rule-list "}" 
group-opts	= name-string [ "in" | "out" ] [ "on" interface ] 
rule-list	= [ rule new-line ] rule-list 
 
npf-filter	= [ "family" family-opt ] [ "proto" protocol [ proto-opts ] ] 
		  ( "all" | filt-opts ) 
static-rule	= ( "block" [ block-opts ] | "pass" ) 
		  [ "stateful" | "stateful-ends" ] 
		  [ "in" | out" ] [ "final" ] [ "on" interface ] 
		  ( npf-filter | "pcap-filter" pcap-filter-expr ) 
		  [ "apply" proc-name ] 
 
dynamic-ruleset	= "ruleset" group-opts 
rule		= static-rule | dynamic-ruleset 
 
block-opts	= "return-rst" | "return-icmp" | "return" 
family-opt	= "inet4" | "inet6" 
proto-opts	= "flags" tcp-flags [ "/" tcp-flag-mask ] | 
		  "icmp-type" type [ "code" icmp-code ] 
 
addr-mask	= addr [ "/" mask ] 
filt-opts	= "from" filt-addr [ port-opts ] "to" filt-addr [ port-opts ] 
filt-addr	= [ interface | var-name | addr-mask | table-id | "any" ] 
filt-port	= "port" ( port-num | port-from "-" port-to | var-name )</pre>
</div>
<div class="section">
<h1 id="x46494c4553">FILES</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="file">/dev/npf</i></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
control device</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="file">/etc/npf.conf</i></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
default configuration file</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="file">/usr/share/examples/npf</i></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
directory containing further examples</dd>
</dl>
</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1><pre style="margin-left: 0.00ex;" class="lit display">
$ext_if = { inet4(wm0) } 
$int_if = { inet4(wm1) } 
 
table &lt;blacklist&gt; type hash file "/etc/npf_blacklist" 
table &lt;limited&gt; type tree dynamic 
 
$services_tcp = { http, https, smtp, domain, 6000, 9022 } 
$services_udp = { domain, ntp, 6000 } 
$localnet = { 10.1.1.0/24 } 
 
alg "icmp" 
 
# Note: if $ext_if has multiple IP address (e.g. IPv6 as well), 
# then the translation address has to be specified explicitly. 
map $ext_if dynamic 10.1.1.0/24 -&gt; $ext_if 
map $ext_if dynamic 10.1.1.2 port 22 &lt;- $ext_if port 9022 
 
procedure "log" { 
	# Note: npf_ext_log kernel module should be loaded, if not built-in. 
	# Also, the interface created, e.g.: ifconfig npflog0 create 
	log: npflog0 
} 
 
group "external" on $ext_if { 
	pass stateful out final all 
 
	block in final from &lt;blacklist&gt; 
	pass stateful in final family inet4 proto tcp to $ext_if port ssh apply "log" 
	pass stateful in final proto tcp to $ext_if port $services_tcp 
	pass stateful in final proto udp to $ext_if port $services_udp 
	pass stateful in final proto tcp to $ext_if port 49151-65535	# Passive FTP 
	pass stateful in final proto udp to $ext_if port 33434-33600	# Traceroute 
} 
 
group "internal" on $int_if { 
	block in all 
	block in final from &lt;limited&gt; 
 
	# Ingress filtering as per BCP 38 / RFC 2827. 
	pass in final from $localnet 
	pass out final all 
} 
 
group default { 
	pass final on lo0 all 
	block all 
}</pre>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../4/bpf">bpf(4)</a>, <a class="link-man" href="../7/npf">npf(7)</a>, <a class="link-man" href="../7/pcap-filter">pcap-filter(7)</a>, <a class="link-man" href="../8/npfctl">npfctl(8)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> NPF first appeared in <span class="unix">NetBSD&#160;6.0</span>.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> NPF was designed and implemented by <span class="author">Mindaugas Rasiukevicius</span>.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
February 1, 2015</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

