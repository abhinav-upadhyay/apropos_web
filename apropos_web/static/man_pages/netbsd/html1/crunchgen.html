<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
CRUNCHGEN(1)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
CRUNCHGEN(1)</td>
<td class="head-vol" align="center">
General Commands Manual</td>
<td class="head-rtitle" align="right">
CRUNCHGEN(1)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">crunchgen</b> &#8212; <span class="desc">generates build environment for a crunched binary</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1><table class="synopsis">
<col style="width: 9.00ex;">
<col>
<tbody>
<tr>
<td>
crunchgen</td>
<td>
&#91;<span class="opt"><b class="flag">&#45;fOoq</b></span>&#93; &#91;<span class="opt"><b class="flag">&#45;c</b> <i class="arg">c-file-name</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;D</b> <i class="arg">src-root</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;d</b> <i class="arg">build-options</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;e</b> <i class="arg">exec-file-name</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;L</b> <i class="arg">lib-dir</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;m</b> <i class="arg">makefile-name</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;v</b> <i class="arg">var-spec</i></span>&#93; <i class="arg">conf-file</i></td>
</tr>
</tbody>
</table>
</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> A crunched binary is a program made up of many other programs linked together into a single executable. The crunched binary <b class="fname">main</b>() function determines which component program to run by the contents of argv[0]. The main reason to crunch programs together is for fitting as many programs as possible onto an installation or system recovery floppy.<p>
<b class="name">crunchgen</b> reads in the specifications in <i class="arg">conf-file</i> for a crunched binary, and generates a Makefile and accompanying top-level C source file that when built create the crunched executable file from the component programs. For each component program, <b class="name">crunchgen</b> can optionally attempt to determine the object (.o) files that make up the program from its source directory Makefile. This information is cached between runs. <b class="name">crunchgen</b> uses the companion program <span class="emph">crunchide</span> to eliminate link-time conflicts between the component programs by hiding all unnecessary symbols.<p>
After <b class="name">crunchgen</b> is run, the crunched binary can be built by running &#8220;make -f &#60;conf-name&#62;.mk&#8221;. The component programs' object files must already be built. An &#8220;objs&#8221; target, included in the output makefile, will run make in each component program's source dir to build the object files for the user. This is not done automatically since in release engineering circumstances it is generally not desirable to be modifying objects in other directories.<p>
The options are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;c</b> <i class="arg">c-file-name</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Set output C file name to <i class="arg">c-file-name</i>. The default name is &#8220;&#60;confname&#62;.c&#8221;.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;D</b> <i class="arg">src-root</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Assume that relative source directory specifications begin with <i class="arg">src-root</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;d</b> <i class="arg">build-options</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Set the DBG variable in the generated makefile to <i class="arg">build-options</i>. The default flags are -Os.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;e</b> <i class="arg">exec-file-name</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Set crunched binary executable file name to <i class="arg">exec-file-name</i>. The default name is &#8220;&#60;<a class="link-mail" href="mailto:conf-name">conf-name</a>&#62;&#8221;.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;f</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Flush cache. Forces the recalculation of cached parameters.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;L</b> <i class="arg">lib-dir</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Try to obtain libraries from <i class="arg">lib-dir</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;m</b> <i class="arg">makefile-name</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Set output Makefile name to <i class="arg">makefile-name</i>. The default name is &#8220;&#60;conf-name&#62;.mk&#8221;.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;O</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Force <b class="name">crunchgen</b> to parse the program's Makefile in determine the list of .o files. Without this option <b class="name">crunchgen</b> expects the program's Makefile to have a program.ro target that links all the program objects into a single relocatable.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;o</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Use existing object files. Rather than rebuilding object files via reach-over makefiles, instead search for and use existing object files.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;q</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Quiet operation. Status messages are suppressed.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;v</b> <i class="arg">varspec</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Append a variable specification to the on-the fly generated Makefile.</dd>
</dl>
</div>
<div class="section">
<h1 id="x4352554e434847454e20434f4e46494755524154494f4e2046494c4520434f4d4d414e4453">CRUNCHGEN CONFIGURATION FILE COMMANDS</h1> <b class="name">crunchgen</b> reads specifications from the <i class="arg">conf-file</i> that describe the components of the crunched binary. In its simplest use, the component program names are merely listed along with the top-level source directories in which their sources can be found. <b class="name">crunchgen</b> then calculates (via the source makefiles) and caches the list of object files and their locations. For more specialized situations, the user can specify by hand all the parameters that <b class="name">crunchgen</b> needs.<p>
The <i class="arg">conf-file</i> commands are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="name">srcdirs</b> <i class="arg">dirname ...</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
A list of source trees in which the source directories of the component programs can be found. These dirs are searched using the <span class="unix">BSD</span> &#8220;&#60;source-dir&#62;/&#60;progname&#62;/&#8221; convention. Multiple <span class="emph">srcdirs</span> lines can be specified. The directories are searched in the order they are given.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="name">progs</b> <i class="arg">progname ...</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
A list of programs that make up the crunched binary. Multiple <span class="emph">progs</span> lines can be specified.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="name">libs</b> <i class="arg">libspec ...</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
A list of library specifications to be included in the crunched binary link. Multiple <span class="emph">libs</span> lines can be specified.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="name">ln</b> <i class="arg">progname linkname</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Causes the crunched binary to invoke <i class="arg">progname</i> whenever <i class="arg">linkname</i> appears in argv[0]. This allows programs that change their behavior when run under different names to operate correctly.</dd>
</dl>
<p>
To handle specialized situations, such as when the source is not available or not built via a conventional Makefile, the following <span class="emph">special</span> commands can be used to set <b class="name">crunchgen</b> parameters for a component program.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="name">special</b> <i class="arg">progname</i> <b class="name">keepsymbols</b> <i class="arg">symbols ...</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Don't hide the specified symbols for <i class="arg">progname</i>. Normally all externally visible symbols for a program is hidden to avoid interference. Multiple <span class="emph">keepsymbols</span> lines can be specified for given <i class="arg">progname</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="name">special</b> <i class="arg">progname</i> <b class="name">srcdir</b> <i class="arg">pathname</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Set the source directory for <i class="arg">progname</i>. This is normally calculated by searching the specified <span class="emph">srcdirs</span> for a directory named <i class="arg">progname</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="name">special</b> <i class="arg">progname</i> <b class="name">objdir</b> <i class="arg">pathname</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Set the obj directory for <i class="arg">progname</i>. This is normally calculated by looking for a directory named &#8220;<i class="file">obj</i>&#8221; under the <i class="arg">srcdir</i>, and if that is not found, the <i class="arg">srcdir</i> itself becomes the <i class="arg">objdir</i>.<p>
<b class="name">Note</b>: This option only takes effect if the -o option to use existing object files is also specified.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="name">special</b> <i class="arg">progname</i> <b class="name">objs</b> <i class="arg">object-file-name ...</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Set the list of object files for program <i class="arg">progname</i>. This is normally calculated by constructing a temporary makefile that includes &#8220;<b class="name">srcdir /</b> <i class="file">Makefile</i>&#8221; and outputs the value of $(OBJS). Multiple <span class="emph">objs</span> lines can be specified for given <i class="arg">progname</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="name">special</b> <i class="arg">progname</i> <b class="name">objpaths</b> <i class="arg">full-pathname-to-object-file ...</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Sets the pathnames of the object files for program <i class="arg">progname</i>. This is normally calculated by prepending the <span class="emph">objdir</span> pathname to each file in the <b class="name">objs</b> list. Multiple <span class="emph">objpaths</span> lines can be specified for given <i class="arg">progname</i>.</dd>
</dl>
<p>
Only the <span class="emph">objpaths</span> parameter is actually needed by <b class="name">crunchgen</b> but it is calculated from <span class="emph">objdir</span> and <span class="emph">objs</span>, which are in turn calculated from <span class="emph">srcdir</span>, so is sometimes convenient to specify the earlier parameters and let <b class="name">crunchgen</b> calculate forward from there if it can.<p>
The makefile produced by <b class="name">crunchgen</b> contains an optional <i class="arg">objs</i> target that will build the object files for each component program by running make inside that program's source directory. For this to work the <span class="emph">srcdir</span> and <span class="emph">objs</span> parameters must also be valid. If they are not valid for a particular program, that program is skipped in the <i class="arg">objs</i> target.<p>
The makefile produced by <b class="name">crunchgen</b> strips certain sections from the final binary to reduce its size. This includes:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">.eh_frame</code></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Unwinding tables for exceptions and backtraces.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">.eh_frame_hdr</code></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Index of the <code class="lit">.eh_frame</code> section.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">.note</code></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Optional data for the kernel and/or runtime linker.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">.comment</code></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Comments in the binary.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">.ident</code></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Embedded source revisions used by <a class="link-man" href="../html1/ident.html">ident(1)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">.copyright</code></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Embedded copyright notes.</dd>
</dl>
</div>
<div class="section">
<h1 id="x454e5649524f4e4d454e54">ENVIRONMENT</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="env">MAKEOBJDIRPREFIX</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
If the environment variable <span class="env">MAKEOBJDIRPREFIX</span> is set, the object directory will be prefixed with the path contained in this environment variable.<p>
<b class="name">Note</b>: This variable is only used if the -o option to use existing object files is also specified.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="env">MACHINE</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
If the environment variable <span class="env">MACHINE</span> is set, it is used as the name of the machine type, when accessing object directories of the form obj.MACHINE. If it is not set, it defaults to the machine type returned by <a class="link-man" href="../html3/uname.html">uname(3)</a>.<p>
<b class="name">Note</b>: This option is only used if the -o option to use existing object files is also specified.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="env">MAKE</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
If the environment variable <span class="env">MAKE</span> is set, it is used as the name of the <a class="link-man" href="../html1/make.html">make(1)</a> executable to be called. If this environment variable is not set, <b class="name">crunchgen</b> defaults to &#8220;make&#8221;.</dd>
</dl>
</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> Here is an example <span class="emph">crunchgen</span> input conf file, named &#8220;<i class="file">kcopy.conf</i>&#8221;:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
srcdirs /usr/src/bin /usr/src/sbin 
 
progs test cp echo sh fsck halt init mount umount myinstall 
ln test [       # test can be invoked via [ 
ln sh -sh       # init invokes the shell with "-sh" in argv[0] 
 
special myprog objpaths /homes/leroy/src/myinstall.o # no sources 
 
libs -lutil -lcrypt</pre>
<p>
This conf file specifies a small crunched binary consisting of some basic system utilities plus a home-grown install program &#8220;myinstall&#8221;, for which no source directory is specified, but its object file is specified directly with the <span class="emph">special</span> line.<p>
The crunched binary &#8220;kcopy&#8221; can be built as follows:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
% crunchgen -m Makefile kcopy.conf    # gen Makefile and kcopy.c 
% make objs             # build the component programs' .o files 
% make                  # build the crunched binary kcopy 
% kcopy sh              # test that this invokes a sh shell 
$			# it works!</pre>
<p>
At this point the binary &#8220;kcopy&#8221; can be copied onto an install floppy and hard-linked to the names of the component programs.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html1/crunchide.html">crunchide(1)</a>, <a class="link-man" href="../html1/make.html">make(1)</a></div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> <b class="name">crunchgen</b> was written by <span class="author">James da Silva</span> &#60;<a class="link-mail" href="mailto:jds@cs.umd.edu">jds@cs.umd.edu</a>&#62;.<p>
Copyright (c) 1994 University of Maryland.  All Rights Reserved.</div>
<div class="section">
<h1 id="x42554753">BUGS</h1> While <b class="name">crunchgen</b> takes care to eliminate link conflicts between the component programs of a crunched binary, conflicts are still possible between the libraries that are linked in. Some shuffling in the order of libraries may be required, and in some rare cases two libraries may have an unresolvable conflict and thus cannot be crunched together.<p>
Some versions of the <span class="unix">BSD</span> build environment do not by default build the intermediate object file for single-source file programs. The &#8220;make objs&#8221; target must then be used to get those object files built, or some other arrangements made.<p>
If a program directory being searched for is found, but contains no objects, other directories are not searched. This causes the following directive to fail:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
srcdirs /usr/src/usr.bin /usr/src/usr.bin/less 
progs less gzip</pre>
<p>
as the <i class="file">/usr/src/usr.bin/less</i> directory will be found with the <i class="file">/usr/src/usr.bin</i> <span class="emph">srcdirs</span> entry, and as it does not contain the require objects, <b class="name">crunchgen</b> fails to find objects for the <span class="emph">less</span> program. To avoid this problem, list specific srcdirs first, and the more general ones later, for e.g.:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
srcdirs /usr/src/usr.bin/less /usr/src/usr.bin 
progs less gzip</pre>
<p>
will not have the above problem.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
June 10, 2013</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

