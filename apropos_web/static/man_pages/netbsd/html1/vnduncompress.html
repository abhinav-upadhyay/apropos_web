<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="resource-type" content="document">
<link rel="stylesheet" href="../style.css" type="text/css" media="all">
<title>
VNDCOMPRESS(1)</title>
</head>
<body>
<div class="mandoc">
<table summary="Document Header" class="head" width="100%">
<col width="30%">
<col width="30%">
<col width="30%">
<tbody>
<tr>
<td class="head-ltitle">
VNDCOMPRESS(1)</td>
<td class="head-vol" align="center">
General Commands Manual</td>
<td class="head-rtitle" align="right">
VNDCOMPRESS(1)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">vndcompress</b>, <b class="name">vnduncompress</b> &#8212; <span class="desc">compress and uncompress disk images in cloop2 format</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1><table class="synopsis">
<col style="width: 11.00ex;">
<col>
<tbody>
<tr>
<td>
vndcompress</td>
<td>
&#91;<span class="opt"><b class="flag">&#45;c</b></span>&#93; &#91;<span class="opt"><b class="flag">&#45;rR</b></span>&#93; &#91;<span class="opt"><b class="flag">&#45;b</b> <i class="arg">blocksize</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;k</b> <i class="arg">checkpoint-blocks</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;l</b> <i class="arg">length</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;p</b> <i class="arg">partial-offset</i></span>&#93; &#91;<span class="opt"><b class="flag">&#45;w</b> <i class="arg">winsize</i></span>&#93; <i class="arg">image</i> <i class="arg">compressed-image</i> &#91;<span class="opt"><i class="arg">blocksize</i></span>&#93;</td>
</tr>
</tbody>
</table>
<br>
<table class="synopsis">
<col style="width: 11.00ex;">
<col>
<tbody>
<tr>
<td>
vnduncompress</td>
<td>
&#91;<span class="opt"><b class="flag">&#45;d</b></span>&#93; &#91;<span class="opt"><b class="flag">&#45;w</b> <i class="arg">winsize</i></span>&#93; <i class="arg">compressed-image</i> <i class="arg">image</i></td>
</tr>
</tbody>
</table>
</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">vndcompress</b> utility compresses disk images in cloop2 format, which the kernel's <a class="link-man" href="../4/vnd">vnd(4)</a> device can interpret as read-only disk devices using the <b class="flag">&#45;z</b> option to <a class="link-man" href="../8/vnconfig">vnconfig(8)</a>.<p>
By default, <b class="name">vndcompress</b> compresses an image, and <b class="name">vnduncompress</b> uncompresses an image, but the <b class="flag">&#45;c</b> and <b class="flag">&#45;d</b> options can control whether either utility compresses or decompresses.<p>
The following options are available for the compression operation:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;b</b> <i class="arg">blocksize</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Set the compression block size to <i class="arg">blocksize</i>, which must be a multiple of 512 and must be no more than 4294966784, or 0xfffffe00. (On 32-bit systems, the limit may be smaller, limited by the available virtual address space.)<p>
For compatibility with the old version of <b class="name">vndcompress</b>, the compression block size may instead be specified at the end of the command line.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;k</b> <i class="arg">checkpoint-blocks</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Write a checkpoint after every <i class="arg">checkpoint-blocks</i> blocks of output. If interrupted, <b class="name">vndcompress</b> can restart at the last checkpoint with the <b class="flag">&#45;r</b> option. You can also request a checkpoint at any time by sending <span class="define">SIGUSR2</span> to the <b class="name">vndcompress</b> process.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;l</b> <i class="arg">length</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify the length of the input, so that the input may be a pipe, socket, or FIFO. Otherwise, the input must know its size, i.e. must have its size reported in <i class="farg">st_size</i> by <a class="link-man" href="../2/fstat">fstat(2)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;p</b> <i class="arg">partial-blocks</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Stop after writing <i class="arg">partial-blocks</i> blocks of output. This option is mainly useful for automatic testing of restarts.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;R</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
With the <b class="flag">&#45;r</b> option, if restarting fails, then abort right now and don't touch the output file.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;r</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Try to restart a partial compression from the last checkpoint. If restarting fails, and the <b class="flag">&#45;R</b> option is not specified, then truncate the output file and start compression afresh. Restarting may fail for various reasons: if there have been no checkpoints, or if the output file has been corrupted in some easily recognizable ways, or if the input file's size has changed, or if the block size does not match, and so on.</dd>
</dl>
<p>
The following option is available for both compression and decompression:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">&#45;w</b> <i class="arg">winsize</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Use an in-memory window of <i class="arg">winsize</i> entries into the table of compressed block offsets. If <i class="arg">winsize</i> is zero, <b class="name">vndcompress</b> will use memory proportional to the number of blocks in the uncompressed image, namely 64 bits or 8 bytes per block. If <i class="arg">winsize</i> is nonzero, <b class="name">vndcompress</b> will use memory proportional to <i class="arg">winsize</i>, and independent of the size of the uncompressed image.<p>
A nonzero <i class="arg">winsize</i> requires the compressed image to be a seekable file, which compression requires anyway, in order to record the offsets of compressed blocks once they are compressed and written, but which is a limitation for decompression. Thus, decompressing from a pipe is incompatible with a nonzero <i class="arg">winsize</i>.<p>
By default, <b class="name">vndcompress</b> uses a fixed window size, unless decompressing with nonseekable input.</dd>
</dl>
</div>
<div class="section">
<h1 id="x4558495420535441545553">EXIT STATUS</h1> The <b class="utility">vndcompress</b> utility exits 0 on success, and &gt;0 if an error occurs.</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> Compress an ISO 9660 CD-ROM image:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
# vndcompress cdrom.iso cdrom.izo</pre>
<p>
Send a 59 GB disk partition over a local network with netcat (don't do this over the internet!):<p>
<pre style="margin-left: 5.00ex;" class="lit display">
# nc 10.0.1.2 12345 &lt; /dev/rcgd1h</pre>
<p>
Receive it and save it compressed on another host, showing a progress bar interactively, restarting if possible, and taking a checkpoint every 16 MB (i.e., every 256 compression blocks, which are 64 KB by default):<p>
<pre style="margin-left: 5.00ex;" class="lit display">
# nc -l 12345 | progress -l 59g &#92; 
    vndcompress -l 59g -k 256 -r /dev/stdin disk.cloop2</pre>
<p>
If the process is interrupted and you rewire your network and disks so that the receiving host now has the disk you want to image, you can start up where you left off, using the <b class="flag">&#45;R</b> option to keep <b class="name">vndcompress</b> from clobbering the partial transfer if anything goes wrong:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
# vndcompress -l 59g -k 256 -rR /dev/rcgd1h disk.cloop2</pre>
<p>
Mount the disk with <a class="link-man" href="../4/vnd">vnd(4)</a>, assuming your kernel was built with the <span class="define">VND_COMPRESSION</span> option enabled:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
# vnconfig -z vnd0 disk.cloop2 
# mount /dev/vnd0d /mnt</pre>
</div>
<div class="section">
<h1 id="x5349474e414c53">SIGNALS</h1> <b class="name">vndcompress</b> responds to the following signals:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">SIGINFO</span>, <span class="define">SIGUSR1</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Report progress to standard error.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">SIGUSR2</span></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Write a checkpoint to disk now.</dd>
</dl>
</div>
<div class="section">
<h1 id="x464f524d4154">FORMAT</h1> The cloop2 format consists of a header, an offset table, and a sequence of compressed blocks. The header is described by the following packed structure:<p>
<pre style="margin-left: 5.00ex;" class="lit display">
struct cloop2_header { 
	char		cl2h_magic[128]; 
	uint32_t	cl2h_blocksize; 
	uint32_t	cl2h_n_blocks; 
} __packed;</pre>
<p>
The <i class="farg">cl2h_magic</i> field is an arbitrary sequence of 128 bits, the <i class="farg">cl2h_blocksize</i> field is a big-endian integer number of bytes per compression block, and the <i class="farg">cl2h_n_blocks</i> field is a big-endian integer number of the compression blocks in the image.<p>
The offset table is a sequence of one more than <i class="farg">cl2h_n_blocks</i> big-endian 64-bit integers specifying the offset of each compression block relative to the start of the file. The extra offset specifies the end of the last compression block, which may be truncated if the uncompressed image's size is not a multiple of the compression block size.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../4/vnd">vnd(4)</a>, <a class="link-man" href="../8/vnconfig">vnconfig(8)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">vndcompress</b> command first appeared in <span class="unix">NetBSD&#160;3.0</span>. It was rewritten to be more robust, to support restarting partial transfers, and to support bounded memory usage in <span class="unix">NetBSD&#160;7.0</span>.</div>
<table summary="Document Footer" class="foot" width="100%">
<col width="50%">
<col width="50%">
<tbody>
<tr>
<td class="foot-date">
January 21, 2014</td>
<td class="foot-os" align="right">
NetBSD 7.99</td>
</tr>
</tbody>
</table>
</div>
</body>
</html>

