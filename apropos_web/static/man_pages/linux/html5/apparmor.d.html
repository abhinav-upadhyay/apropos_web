<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/linux/style.css" type="text/css" media="all"/>
<title>
APPARMOR.D(5)</title>
</head>
<body>
<div class="mandoc">
<table class="head">
<tbody>
<tr>
<td class="head-ltitle">
APPARMOR.D(5)</td>
<td class="head-vol">
AppArmor</td>
<td class="head-rtitle">
APPARMOR.D(5)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1>NAME</h1> apparmor.d - syntax of security profiles for AppArmor.</div>
<div class="section">
<h1>DESCRIPTION</h1> AppArmor profiles describe mandatory access rights granted to given programs and are fed to the AppArmor policy enforcement module using  <i>apparmor_parser</i>(8). This man page describes the format of the AppArmor configuration files; see  <i>apparmor</i>(7) for an overview of AppArmor.</div>
<div class="section">
<h1>FORMAT</h1> The following is a BNF-style description of AppArmor policy configuration files; see below for an example AppArmor policy file. AppArmor configuration files are line-oriented;  <b>#</b> introduces a comment, similar to shell scripting languages. The exception to this rule is that  <b>#include</b> will <i>include</i> the contents of a file inline to the policy; this behaviour is modelled after  <i>cpp</i>(1).<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
<b>INCLUDE</b> = '#include' ( <i>ABS PATH</i> | <i>MAGIC PATH</i> )<div style="height: 1.00em;">
&#160;</div>
<b>ABS PATH</b> = '&quot;' path '&quot;' (the path is passed to <i>open</i>(2))<div style="height: 1.00em;">
&#160;</div>
<b>MAGIC PATH</b> = '&lt;' relative path '&gt;' (the path is relative to <i>/etc/apparmor.d/</i>)<div style="height: 1.00em;">
&#160;</div>
<b>COMMENT</b> = '#' <i>TEXT</i><div style="height: 1.00em;">
&#160;</div>
<b>TEXT</b> = any characters<div style="height: 1.00em;">
&#160;</div>
<b>PROFILE</b> = [ <i>COMMENT</i> ... ] [ <i>VARIABLE ASSIGNMENT</i> ... ] ( '&quot;' <i>PROGRAM</i> '&quot;' | <i>PROGRAM</i> ) [ 'flags=(complain)' ]'{' [ ( <i>RESOURCE RULE</i> | <i>COMMENT</i> | <i>INCLUDE</i> | <i>SUBPROFILE</i> | 'capability ' <i>CAPABILITY</i> | <i>NETWORK RULE</i> | <i>MOUNT RULE</i> | <i>FILE RULE</i> | 'change_profile -&gt; ' <i>PROGRAMCHILD</i> ) ... ] '}'<div style="height: 1.00em;">
&#160;</div>
<b>SUBPROFILE</b> = [ <i>COMMENT</i> ... ] ( <i>PROGRAMHAT</i> | 'profile ' <i>PROGRAMCHILD</i> ) '{' [ ( <i>FILE RULE</i> | <i>COMMENT</i> | <i>INCLUDE</i> ) ... ] '}'<div style="height: 1.00em;">
&#160;</div>
<b>CAPABILITY</b> = (lowercase capability name without 'CAP_' prefix; see  <i>capabilities</i>(7))<div style="height: 1.00em;">
&#160;</div>
<b>NETWORK RULE</b> = 'network' [ [ <i>DOMAIN</i> ] [ <i>TYPE</i> ] [ I &lt;PROTOCOL&gt; ] ] ','<div style="height: 1.00em;">
&#160;</div>
<b>DOMAIN</b> = ( 'inet' | 'ax25' | 'ipx' | 'appletalk' | 'netrom' | 'bridge' | 'atmpvc' | 'x25' | 'inet6' | 'rose' | 'netbeui' | 'security' | 'key' | 'packet' | 'ash' | 'econet' | 'atmsvc' | 'sna' | 'irda' | 'pppox' | 'wanpipe' | 'bluetooth' ) ','<div style="height: 1.00em;">
&#160;</div>
<b>TYPE</b> = ( 'stream' | 'dgram' | 'seqpacket' |  'rdm' | 'raw' | 'packet' )<div style="height: 1.00em;">
&#160;</div>
<b>PROTOCOL</b> = ( 'tcp' | 'udp' | 'icmp' )<div style="height: 1.00em;">
&#160;</div>
<b>PROGRAM</b> = (non-whitespace characters except for '^', must start with '/'. Embedded spaces or tabs must be quoted.)<div style="height: 1.00em;">
&#160;</div>
<b>PROGRAMHAT</b> = '^'  (non-whitespace characters; see <i>aa_change_hat</i>(2) for a description of how this &quot;hat&quot; is used.)<div style="height: 1.00em;">
&#160;</div>
<b>PROGRAMCHILD</b> = <i>SUBPROFILE</i> name<div style="height: 1.00em;">
&#160;</div>
<b>MOUNT RULE</b> = ( <i>MOUNT</i> | <i>REMOUNT</i> | <i>UMOUNT</i> | <i>PIVOT ROOT</i> )<div style="height: 1.00em;">
&#160;</div>
<b>MOUNT</b> = [ 'audit' ] [ 'deny' ] 'mount' [ <i>MOUNT CONDITIONS</i> ] [ <i>SOURCE FILEGLOB</i> ] [ -&gt; [ <i>MOUNTPOINT FILEGLOB</i> ]<div style="height: 1.00em;">
&#160;</div>
<b>REMOUNT</b> = [ 'audit' ] [ 'deny' ] 'remount' [ <i>MOUNT CONDITIONS</i> ] <i>MOUNTPOINT FILEGLOB</i><div style="height: 1.00em;">
&#160;</div>
<b>UMOUNT</b> = [ 'audit' ] [ 'deny' ] 'umount' [ <i>MOUNT CONDITIONS</i> ] <i>MOUNTPOINT FILEGLOB</i><div style="height: 1.00em;">
&#160;</div>
<b>PIVOT ROOT</b> = [ 'audit' ] [ 'deny' ] pivot_root [ <i>OLD ABS PATH</i> ] [ <i>MOUNTPOINT ABS PATH</i> ] [ -&gt; <i>PROGRAMCHILD</i> ]<div style="height: 1.00em;">
&#160;</div>
<b>MOUNT CONDITIONS</b> = [ ( 'fstype' | 'vfstype' ) ( '=' | 'in' ) <i>MOUNT FSTYPE EXPRESSION</i> ] [ 'options' ( '=' | 'in' ) <i>MOUNT FLAGS EXPRESSION</i> ]<div style="height: 1.00em;">
&#160;</div>
<b>MOUNT FSTYPE EXPRESSION</b> = ( <i>MOUNT FSTYPE LIST</i> | <i>MOUNT EXPRESSION</i> )<div style="height: 1.00em;">
&#160;</div>
<b>MOUNT FSTYPE LIST</b> = Comma separated list of valid filesystem and virtual filesystem types (eg ext4, debugfs, devfs, etc)<div style="height: 1.00em;">
&#160;</div>
<b>MOUNT FLAGS EXPRESSION</b> = ( <i>MOUNT FLAGS LIST</i> | <i>MOUNT EXPRESSION</i> )<div style="height: 1.00em;">
&#160;</div>
<b>MOUNT FLAGS LIST</b> = Comma separated list of <i>MOUNT FLAGS</i>.<div style="height: 1.00em;">
&#160;</div>
<b>MOUNT FLAGS</b> = ( 'ro' | 'rw' | 'nosuid' | 'suid' | 'nodev' | 'dev' | 'noexec' | 'exec' | 'sync' | 'async' | 'remount' | 'mand' | 'nomand' | 'dirsync' | 'nodirsync' | 'noatime' | 'atime' | 'nodiratime' | 'diratime' | 'bind' | 'move' | 'rec' | 'verbose' | 'silent' | 'load' | 'acl' | 'noacl' | 'unbindable' | 'private' | 'slave' | 'shared' | 'relative' | 'norelative' | 'iversion' | 'noiversion' | 'strictatime' | 'nouser' | 'user' )<div style="height: 1.00em;">
&#160;</div>
<b>MOUNT EXPRESSION</b> = ( <i>ALPHANUMERIC</i> | <i>AARE</i> ) ...<div style="height: 1.00em;">
&#160;</div>
<b>AARE</b> = <b>?*[]{}^</b> (see below for meanings)<div style="height: 1.00em;">
&#160;</div>
<b>FILE RULE</b> = <i>RULE QUALIFIER</i> ( '&quot;' <i>FILEGLOB</i> '&quot;' | <i>FILEGLOB</i> ) <i>ACCESS</i> ','<div style="height: 1.00em;">
&#160;</div>
<b>RULE QUALIFIER</b> = [ 'audit' ] [ 'deny' ] [ 'owner' ]<div style="height: 1.00em;">
&#160;</div>
<b>FILEGLOB</b> = (must start with '/' (after variable expansion), <b>AARE</b> have special meanings; see below. May include <i>VARIABLE</i>. Rules with embedded spaces or tabs must be quoted. Rules must end with '/' to apply to directories.)<div style="height: 1.00em;">
&#160;</div>
<b>ACCESS</b> = ( 'r' | 'w' | 'l' | 'ix' | 'ux' | 'Ux' | 'px' | 'Px' | 'cx -&gt; ' <i>PROGRAMCHILD</i> | 'Cx -&gt; ' <i>PROGRAMCHILD</i> | 'm' ) [ <i>ACCESS</i> ... ]  (not all combinations are allowed; see below.)<div style="height: 1.00em;">
&#160;</div>
<b>VARIABLE</b> = '@{' <i>ALPHA</i> [ ( <i>ALPHANUMERIC</i> | '_' ) ... ] '}'<div style="height: 1.00em;">
&#160;</div>
<b>VARIABLE ASSIGNMENT</b> = <i>VARIABLE</i> ('=' | '+=') (space separated values)<div style="height: 1.00em;">
&#160;</div>
<b>ALIAS RULE</b> = <i>ABS PATH</i> '-&gt;' <i>REWRITTEN ABS PATH</i> ','<div style="height: 1.00em;">
&#160;</div>
<b>ALPHA</b> = ('a', 'b', 'c', ... 'z', 'A', 'B', ... 'Z')<div style="height: 1.00em;">
&#160;</div>
<b>ALPHANUMERIC</b> = ('0', '1', '2', ... '9', 'a', 'b', 'c', ... 'z', 'A', 'B', ... 'Z')</div>
<div class="spacer">
</div>
All resources and programs need a full path. There may be any number of subprofiles (aka child profiles) in a profile, limited only by kernel memory. Subprofile names are limited to 974 characters.  Child profiles can be used to confine an application in a special way, or when you want the child to be unconfined on the system, but confined when called from the parent.  Hats are a special child profile that can be used with the  <i>aa_change_hat</i>(2) API call.  Applications written or modified to use  <i>aa_change_hat</i>(2) can take advantage of subprofiles to run under different confinements, dependent on program logic. Several  <i>aa_change_hat</i>(2)-aware applications exist, including an Apache module,  <i>mod_apparmor</i>(5); a PAM module, pam_apparmor; and a Tomcat valve, tomcat_apparmor. Applications written or modified to use  <i>change_profile</i>(2) transition permanently to the specified profile. libvirt is one such application.<div class="subsection">
<h2>Access Modes</h2> File permission access modes consists of combinations of the following modes:<dl>
<dt>
<b>r</b> 	- read</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>w</b> 	- write -- conflicts with append</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>a</b>	- append -- conflicts with write</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>ux</b> 	- unconfined execute</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>Ux</b> 	- unconfined execute -- scrub the environment</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>px</b> 	- discrete profile execute</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>Px</b> 	- discrete profile execute -- scrub the environment</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>cx</b> 	- transition to subprofile on execute</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>Cx</b> 	- transition to subprofile on execute -- scrub the environment</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>ix</b>	- inherit execute</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>m</b>	- allow PROT_EXEC with <i>mmap</i>(2) calls</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>l</b> 	- link</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<b>k</b>	- lock</dt>
<dd>
</dd>
</dl>
</div>
<div class="subsection">
<h2>Access Modes Details</h2><dl>
<dt>
<b>r - Read mode</b></dt>
<dd>
Allows the program to have read access to the file or directory listing. Read access is required for shell scripts and other interpreted content.</dd>
</dl>
<dl>
<dt>
<b>w - Write mode</b></dt>
<dd>
Allows the program to have write access to the file. Files and directories must have this permission if they are to be unlinked (removed.)  Write mode is not required on a directory to rename or create files within the directory.<div style="height: 1.00em;">
&#160;</div>
This mode conflicts with append mode.</dd>
</dl>
<dl>
<dt>
<b>a - Append mode</b></dt>
<dd>
Allows the program to have a limited appending only write access to the file. Append mode will prevent an application from opening the file for write unless it passes the O_APPEND parameter flag on open.<div style="height: 1.00em;">
&#160;</div>
The mode conflicts with Write mode.</dd>
</dl>
<dl>
<dt>
<b>ux - Unconfined execute mode</b></dt>
<dd>
Allows the program to execute the program without any AppArmor profile being applied to the program.<div style="height: 1.00em;">
&#160;</div>
This mode is useful when a confined program needs to be able to perform a privileged operation, such as rebooting the machine. By placing the privileged section in another executable and granting unconfined execution rights, it is possible to bypass the mandatory constraints imposed on all confined processes. For more information on what is constrained, see the  <i>apparmor</i>(7) man page.<div style="height: 1.00em;">
&#160;</div>
<b>WARNING</b> 'ux' should only be used in very special cases. It enables the designated child processes to be run without any AppArmor protection. 'ux' does not scrub the environment of variables such as LD_PRELOAD; as a result, the calling domain may have an undue amount of influence over the callee.  Use this mode only if the child absolutely must be run unconfined and LD_PRELOAD must be used. Any profile using this mode provides negligible security. Use at your own risk.<div style="height: 1.00em;">
&#160;</div>
Incompatible with 'Ux', 'px', 'Px', 'cx', 'Cx', 'ix'.</dd>
</dl>
<dl>
<dt>
<b>Ux - unconfined execute -- scrub the environment</b></dt>
<dd>
'Ux' allows the named program to run in 'ux' mode, but AppArmor will invoke the Linux Kernel's  <b>unsafe_exec</b> routines to scrub the environment, similar to setuid programs. (See  <i>ld.so</i>(8) for some information on setuid/setgid environment scrubbing.)<div style="height: 1.00em;">
&#160;</div>
<b>WARNING</b> 'Ux' should only be used in very special cases. It enables the designated child processes to be run without any AppArmor protection. Use this mode only if the child absolutely must be run unconfined. Use at your own risk.<div style="height: 1.00em;">
&#160;</div>
Incompatible with 'ux', 'px', 'Px', 'cx', 'Cx', 'ix'.</dd>
</dl>
<dl>
<dt>
<b>px - Discrete Profile execute mode</b></dt>
<dd>
This mode requires that a discrete security profile is defined for a program executed and forces an AppArmor domain transition. If there is no profile defined then the access will be denied.<div style="height: 1.00em;">
&#160;</div>
<b>WARNING</b> 'px' does not scrub the environment of variables such as LD_PRELOAD; as a result, the calling domain may have an undue amount of influence over the callee.<div style="height: 1.00em;">
&#160;</div>
Incompatible with 'Ux', 'ux', 'Px', 'cx', 'Cx', 'ix'.</dd>
</dl>
<dl>
<dt>
<b>Px - Discrete Profile execute mode -- scrub the environment</b></dt>
<dd>
'Px' allows the named program to run in 'px' mode, but AppArmor will invoke the Linux Kernel's  <b>unsafe_exec</b> routines to scrub the environment, similar to setuid programs. (See  <i>ld.so</i>(8) for some information on setuid/setgid environment scrubbing.)<div style="height: 1.00em;">
&#160;</div>
Incompatible with 'Ux', 'ux', 'px', 'cx', 'Cx', 'ix'.</dd>
</dl>
<dl>
<dt>
<b>cx - Transition to Subprofile execute mode</b></dt>
<dd>
This mode requires that a local security profile is defined and forces an AppArmor domain transition to the named profile. If there is no profile defined then the access will be denied.<div style="height: 1.00em;">
&#160;</div>
<b>WARNING</b> 'cx' does not scrub the environment of variables such as LD_PRELOAD; as a result, the calling domain may have an undue amount of influence over the callee.<div style="height: 1.00em;">
&#160;</div>
Incompatible with 'Ux', 'ux', 'px', 'Px', 'Cx', 'ix'.</dd>
</dl>
<dl>
<dt>
<b>Cx - Transition to Subprofile execute mode -- scrub the environment</b></dt>
<dd>
'Cx' allows the named program to run in 'cx' mode, but AppArmor will invoke the Linux Kernel's  <b>unsafe_exec</b> routines to scrub the environment, similar to setuid programs. (See  <i>ld.so</i>(8) for some information on setuid/setgid environment scrubbing.)<div style="height: 1.00em;">
&#160;</div>
Incompatible with 'Ux', 'ux', 'px', 'Px', 'cx', 'ix'.</dd>
</dl>
<dl>
<dt>
<b>ix - Inherit execute mode</b></dt>
<dd>
Prevent the normal AppArmor domain transition on <i>execve</i>(2) when the profiled program executes the named program. Instead, the executed resource will inherit the current profile.<div style="height: 1.00em;">
&#160;</div>
This mode is useful when a confined program needs to call another confined program without gaining the permissions of the target's profile, or losing the permissions of the current profile. There is no version to scrub the environment because 'ix' executions don't change privileges.<div style="height: 1.00em;">
&#160;</div>
Incompatible with 'Ux', 'ux', 'Px', 'px', 'cx', 'Cx'. Implies 'm'.</dd>
</dl>
<dl>
<dt>
<b>m - Allow executable mapping</b></dt>
<dd>
This mode allows a file to be mapped into memory using <i>mmap</i>(2)'s PROT_EXEC flag. This flag marks the pages executable; it is used on some architectures to provide non-executable data pages, which can complicate exploit attempts. AppArmor uses this mode to limit which files a well-behaved program (or all programs on architectures that enforce non-executable memory access controls) may use as libraries, to limit the effect of invalid  <b>-L</b> flags given to <i>ld</i>(1) and <b>LD_PRELOAD</b>,  <b>LD_LIBRARY_PATH</b>, given to <i>ld.so</i>(8).</dd>
</dl>
<dl>
<dt>
<b>l - Link mode</b></dt>
<dd>
Allows the program to be able to create a link with this name.  When a link is created, the new link  <b>MUST</b> have a subset of permissions as the original file (with the exception that the destination does not have to have link access.) If there is an 'x' rule on the new link, it must match the original file exactly.</dd>
</dl>
<dl>
<dt>
<b>k - lock mode</b></dt>
<dd>
Allows the program to be able lock a file with this name.  This permission covers both advisory and mandatory locking.</dd>
</dl>
</div>
<div class="subsection">
<h2>Comments</h2> Comments start with # and may begin at any place within a line. The comment ends when the line ends. This is the same comment style as shell scripts.</div>
<div class="subsection">
<h2>Capabilities</h2> The only capabilities a confined process may use may be enumerated; for the complete list, please refer to  <i>capabilities</i>(7). Note that granting some capabilities renders AppArmor confinement for that domain advisory; while  <i>open</i>(2), <i>read</i>(2), <i>write</i>(2), etc., will still return error when access is not granted, some capabilities allow loading kernel modules, arbitrary access to IPC, ability to bypass discretionary access controls, and other operations that are typically reserved for the root user.</div>
<div class="subsection">
<h2>Network Rules</h2> AppArmor supports simple coarse grained network mediation.  The network rule restrict all  <i>socket</i>(2) based operations.  The mediation done is a course grained check on whether a socket of a given type and family can be created, read, or written.  There is no mediation based of port number or protocol beyond tcp, udp, and raw.<div class="spacer">
</div>
AppArmor network rules are accumulated so that the granted network permissions are the union of all the listed network rule permissions.<div class="spacer">
</div>
AppArmor network rules are broad and general and become more restrictive as further information is specified.<div class="spacer">
</div>
eg.<div class="spacer">
</div>
<br/>
 network,               #allow access to all networking<br/>
 network tcp,           #allow access to tcp<br/>
 network inet tcp,      #allow access to tcp only for inet4 addresses<br/>
 network inet6 tcp,     #allow access to tcp only for inet6 addresses<br/>
</div>
<div class="subsection">
<h2>Mount Rules</h2> AppArmor supports mount mediation and allows specifying filesystem types and mount flags. The syntax of mount rules in AppArmor is based on the  <i>mount</i>(8) command syntax. Mount rules must contain one of the mount, remount, umount or pivot_root keywords, but all mount conditions are optional. Unspecified optional conditionals are assumed to match all entries (eg, not specifying fstype means all fstypes are matched). Due to the complexity of the mount command and how options may be specified, AppArmor allows specifying conditionals three different ways:<dl>
<dt>
1.</dt>
<dd>
If a conditional is specified using '=', then the rule only grants permission for mounts matching the exactly specified options. For example, an AppArmor policy with the following rule:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
mount options=ro /dev/foo -&gt; /mnt/,</div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
Would match:<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount -o ro /dev/foo /mnt</div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
but not either of these:<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount -o ro,atime /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o rw /dev/foo /mnt</div>
</div>
<div style="margin-left: 4.00ex;">
</div>
<dl>
<dt>
2.</dt>
<dd>
If a conditional is specified using 'in', then the rule grants permission for mounts matching any combination of the specified options. For example, if an AppArmor policy has the following rule:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
mount options in (ro,atime) /dev/foo -&gt; /mnt/,</div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
all of these mount commands will match:<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount -o ro /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o ro,atime /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o atime /dev/foo /mnt</div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
but none of these will:<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount -o ro,sync /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o ro,atime,sync /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o rw /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o rw,noatime /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount /dev/foo /mnt</div>
</div>
<div style="margin-left: 4.00ex;">
</div>
<dl>
<dt>
3.</dt>
<dd>
If multiple conditionals are specified in a single mount rule, then the rule grants permission for each set of options. This provides a shorthand when writing mount rules which might help to logically break up a conditional. For example, if an AppArmor policy has the following rule:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
mount options=ro options=atime</div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
both of these mount commands will match:<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount -o ro /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o atime /dev/foo /mnt</div>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
but this one will not:<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount -o ro,atime /dev/foo /mnt</div>
</div>
<div style="margin-left: 4.00ex;">
</div>
<div class="spacer">
</div>
Note that separate mount rules are distinct and the options do not accumulate. For example, these AppArmor mount rules:<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
mount options=ro, mount options=atime,</div>
<div class="spacer">
</div>
are not equivalent to either of these mount rules:<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
mount options=(ro,atime),<div style="height: 1.00em;">
&#160;</div>
mount options in (ro,atime),</div>
<div class="spacer">
</div>
To help clarify the flexibility and complexity of mount rules, here are some example rules with accompanying matching commands:<dl>
<dt>
<b>mount,</b></dt>
<dd>
the 'mount' rule without any conditionals is the most generic and allows any mount. Equivalent to 'mount fstype=** options=** ** -&gt; /**'.</dd>
</dl>
<dl>
<dt>
<b>mount /dev/foo,</b></dt>
<dd>
allow mounting of /dev/foo anywhere with any options. Some matching mount commands:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -t ext3 /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -t vfat /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o ro,atime,noexec,nodiratime /dev/foo /srv/some/mountpoint</div>
</div>
<div style="margin-left: 4.00ex;">
</div>
<dl>
<dt>
<b>mount options=ro /dev/foo,</b></dt>
<dd>
allow mounting of /dev/foo anywhere, as read only. Some matching mount commands:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount -o ro /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o ro /dev/foo /some/where/else</div>
</div>
<div style="margin-left: 4.00ex;">
</div>
<dl>
<dt>
<b>mount options=(ro,atime) /dev/foo,</b></dt>
<dd>
allow mount of /dev/foo anywhere, as read only and using inode access times. Some matching mount commands:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount -o ro,atime /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o ro,atime /dev/foo /some/where/else</div>
</div>
<div style="margin-left: 4.00ex;">
</div>
<dl>
<dt>
<b>mount options in (ro,atime) /dev/foo,</b></dt>
<dd>
allow mount of /dev/foo anywhere using some combination of 'ro' and 'atime' (see above). Some matching mount commands:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount -o ro /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o atime /dev/foo /some/where/else<div style="height: 1.00em;">
&#160;</div>
$ mount -o ro,atime /dev/foo /some/other/place</div>
</div>
<div style="margin-left: 4.00ex;">
</div>
<dl>
<dt>
<b>mount options=ro /dev/foo, mount options=atime /dev/foo,</b></dt>
<dd>
allow mount of /dev/foo anywhere as read only, and allow mount of /dev/foo anywhere using inode access times. Note this is expressed as two different rules. Matches:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount -o ro /dev/foo /mnt/1<div style="height: 1.00em;">
&#160;</div>
$ mount -o atime /dev/foo /mnt/2</div>
</div>
<div style="margin-left: 4.00ex;">
</div>
<dl>
<dt>
<b>mount -&gt; /mnt/**,</b></dt>
<dd>
allow mounting anything under a directory in /mnt/**. Some matching mount commands:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount /dev/foo1 /mnt/1<div style="height: 1.00em;">
&#160;</div>
$ mount -o ro,atime,noexec,nodiratime /dev/foo2 /mnt/deep/path/foo2</div>
</div>
<div style="margin-left: 4.00ex;">
</div>
<dl>
<dt>
<b>mount options=ro -&gt; /mnt/**,</b></dt>
<dd>
allow mounting anything under /mnt/**, as read only. Some matching mount commands:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount -o ro /dev/foo1 /mnt/1<div style="height: 1.00em;">
&#160;</div>
$ mount -o ro /dev/foo2 /mnt/deep/path/foo2</div>
</div>
<div style="margin-left: 4.00ex;">
</div>
<dl>
<dt>
<b>mount fstype=ext3 options=(rw,atime) /dev/sdb1 -&gt; /mnt/stick/,</b></dt>
<dd>
allow mounting an ext3 filesystem in /dev/sdb1 on /mnt/stick as read/write and using inode access times. Matches only:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount -o rw,atime /dev/sdb1 /mnt/stick</div>
</div>
<div style="margin-left: 4.00ex;">
</div>
<dl>
<dt>
<b>mount options=(ro, atime) options in (nodev, user) /dev/foo -&gt; /mnt/,</b></dt>
<dd>
allow mounting /dev/foo on /mmt/ read only and using inode access times or allow mounting /dev/foo on /mnt/ with some combination of 'nodev' and 'user'. Matches only:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
<div style="margin-left: 4.00ex;">
$ mount -o ro,atime /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o nodev /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o user /dev/foo /mnt<div style="height: 1.00em;">
&#160;</div>
$ mount -o nodev,user /dev/foo /mnt</div>
</div>
<div style="margin-left: 4.00ex;">
</div>
</div>
<div class="subsection">
<h2>Variables</h2> AppArmor's policy language allows embedding variables into file rules to enable easier configuration for some common (and pervasive) setups. Variables may have multiple values assigned, but any variable assignments must be made before the start of the profile.<div class="spacer">
</div>
The parser will automatically expand variables to include all values that they have been assigned; it is an error to reference a variable without setting at least one value.<div class="spacer">
</div>
At the time of this writing, only <b>@{HOME}</b> and <b>@{HOMEDIRS}</b> are defined in the AppArmor policy provided, in the  <i>/etc/apparmor.d/tunables/home</i> file; these variables are used in many of the abstractions described later. You may also add files in  <i>/etc/apparmor.d/tunables/home.d</i> for site-specific customization of  <b>@{HOMEDIRS}</b>.</div>
<div class="subsection">
<h2>Alias rules</h2> AppArmor also provides alias rules for remapping paths for site-specific layouts. They are an alternative form of path rewriting to using variables, and are done after variable resolution. Alias rules must occur within the preamble of the profile. System-wide aliases are found in  <i>/etc/apparmor.d/tunables/alias</i>, which is included by  <i>/etc/apparmor.d/tunables/global</i>. <i>/etc/apparmor.d/tunables/global</i> is typically included at the beginning of an AppArmor profile.</div>
<div class="subsection">
<h2>Globbing</h2> File resources may be specified with a globbing syntax similar to that used by popular shells, such as  <i>csh</i>(1), <i>bash</i>(1), <i>zsh</i>(1).<dl>
<dt>
<b>*</b></dt>
<dd>
can substitute for any number of characters, excepting '/'</dd>
</dl>
<dl>
<dt>
<b>**</b></dt>
<dd>
can substitute for any number of characters, including '/'</dd>
</dl>
<dl>
<dt>
<b>?</b></dt>
<dd>
can substitute for any single character excepting '/'</dd>
</dl>
<dl>
<dt>
<b>[abc]</b></dt>
<dd>
will substitute for the single character a, b, or c</dd>
</dl>
<dl>
<dt>
<b>[a-c]</b></dt>
<dd>
will substitute for the single character a, b, or c</dd>
</dl>
<dl>
<dt>
<b>[^a-c]</b></dt>
<dd>
will substitute for any single character not matching a, b or c</dd>
</dl>
<dl>
<dt>
<b>{ab,cd}</b></dt>
<dd>
will expand to one rule to match ab, one rule to match cd</dd>
</dl>
<div class="spacer">
</div>
When AppArmor looks up a directory the pathname being looked up will end with a slash (e.g.,  <i>/var/tmp/</i>); otherwise it will not end with a slash. Only rules that match a trailing slash will match directories. Some examples, none matching the  <i>/tmp/</i> directory itself, are:<dl>
<dt>
<b>/tmp/*</b></dt>
<dd>
Files directly in <i>/tmp</i>.</dd>
</dl>
<dl>
<dt>
<b>/tmp/*/</b></dt>
<dd>
Directories directly in <i>/tmp</i>.</dd>
</dl>
<dl>
<dt>
<b>/tmp/**</b></dt>
<dd>
Files and directories anywhere underneath <i>/tmp</i>.</dd>
</dl>
<dl>
<dt>
<b>/tmp/**/</b></dt>
<dd>
Directories anywhere underneath <i>/tmp</i>.</dd>
</dl>
</div>
<div class="subsection">
<h2>Rule Qualifiers</h2> There are several rule qualifiers that can be applied to permission rules. Rule qualifiers can modify the rule and/or permissions within the rule.<dl>
<dt>
<b>audit</b></dt>
<dd>
Specifies that permissions requests that match the rule should be recorded to the audit log.</dd>
</dl>
<dl>
<dt>
<b>deny</b></dt>
<dd>
Specifies that permissions requests that match the rule should be denied without logging. Can be combined with 'audit' to enable logging.</dd>
</dl>
<dl>
<dt>
<b>owner</b></dt>
<dd>
Specifies that the task must have the same euid/fsuid as the object being referenced by the permission check.</dd>
</dl>
</div>
<div class="subsection">
<h2>#include mechanism</h2> AppArmor provides an easy abstraction mechanism to group common file access requirements; this abstraction is an extremely flexible way to grant site-specific rights and makes writing new AppArmor profiles very simple by assembling the needed building blocks for any given program.<div class="spacer">
</div>
The use of '#include' is modelled directly after <i>cpp</i>(1); its use will replace the '#include' statement with the specified file's contents.  <b>#include &quot;/absolute/path&quot;</b> specifies that <i>/absolute/path</i> should be used.   <b>#include &quot;relative/path&quot;</b> specifies that <i>relative/path</i> should be used, where the path is relative to the current working directory.  <b>#include &lt;magic/path&gt;</b> is the most common usage; it will load  <i>magic/path</i> relative to a directory specified to <i>apparmor_parser</i>(8).  <i>/etc/apparmor.d/</i> is the AppArmor default.<div class="spacer">
</div>
The supplied AppArmor profiles follow several conventions; the abstractions stored in  <i>/etc/apparmor.d/abstractions/</i> are some large clusters that are used in most profiles. What follows are short descriptions of how some of the abstractions are used.<dl>
<dt>
<i>abstractions/audio</i></dt>
<dd>
Includes accesses to device files used for audio applications.</dd>
</dl>
<dl>
<dt>
<i>abstractions/authentication</i></dt>
<dd>
Includes access to files and services typically necessary for services that perform user authentication.</dd>
</dl>
<dl>
<dt>
<i>abstractions/base</i></dt>
<dd>
Includes files that should be readable and writable in all profiles.</dd>
</dl>
<dl>
<dt>
<i>abstractions/bash</i></dt>
<dd>
Includes many files used by bash; useful for interactive shells and programs that call  <i>system</i>(3).</dd>
</dl>
<dl>
<dt>
<i>abstractions/consoles</i></dt>
<dd>
Includes read and write access to the device files controlling the virtual console,  <i>sshd</i>(8), <i>xterm</i>(1), etc. This abstraction is needed for many programs that interact with users.</dd>
</dl>
<dl>
<dt>
<i>abstractions/fonts</i></dt>
<dd>
Includes access to fonts and the font libraries.</dd>
</dl>
<dl>
<dt>
<i>abstractions/gnome</i></dt>
<dd>
Includes read and write access to GNOME configuration files, as well as read access to GNOME libraries.</dd>
</dl>
<dl>
<dt>
<i>abstractions/kde</i></dt>
<dd>
Includes read and write access to KDE configuration files, as well as read access to KDE libraries.</dd>
</dl>
<dl>
<dt>
<i>abstractions/kerberosclient</i></dt>
<dd>
Includes file access rules needed for common kerberos clients.</dd>
</dl>
<dl>
<dt>
<i>abstractions/nameservice</i></dt>
<dd>
Includes file rules to allow DNS, LDAP, NIS, SMB, user and group password databases, services, and protocols lookups.</dd>
</dl>
<dl>
<dt>
<i>abstractions/perl</i></dt>
<dd>
Includes read access to perl modules.</dd>
</dl>
<dl>
<dt>
<i>abstractions/user-download</i></dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<i>abstractions/user-mail</i></dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<i>abstractions/user-manpages</i></dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<i>abstractions/user-tmp</i></dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<i>abstractions/user-write</i></dt>
<dd>
Some profiles for typical &quot;user&quot; programs will use these include files to describe rights that users have in the system.</dd>
</dl>
<dl>
<dt>
<i>abstractions/wutmp</i></dt>
<dd>
Includes write access to files used to maintain <i>wtmp</i>(5) and <i>utmp</i>(5) databases, used with the w(1) and associated commands.</dd>
</dl>
<dl>
<dt>
<i>abstractions/X</i></dt>
<dd>
Includes read access to libraries, configuration files, X authentication files, and the X socket.</dd>
</dl>
<div class="spacer">
</div>
The abstractions stored in <i>/etc/apparmor.d/program-chunks/</i> are intended for use by specific program suites, and are not generally useful.<div class="spacer">
</div>
Some of the abstractions rely on variables that are set in files in the  <i>/etc/apparmor.d/tunables/</i> directory. These variables are currently  <b>@{HOME}</b> and <b>@{HOMEDIRS}</b>. Variables cannot be set in profile scope; they can only be set before the profile. Therefore, any profiles that use abstractions should either  <b>#include &lt;tunables/global&gt;</b> or otherwise ensure that  <b>@{HOME}</b> and <b>@{HOMEDIRS}</b> are set before starting the profile definition. The  <i>aa-autodep</i>(8) and <i>aa-genprof</i>(8) utilities will automatically emit  <b>#include &lt;tunables/global&gt;</b> in generated profiles.</div>
</div>
<div class="section">
<h1>EXAMPLE</h1> An example AppArmor profile:<div class="spacer">
</div>
<br/>
        # a variable definition in the preamble<br/>
        @{HOME} = /home/*/ /root/<br/>
<br/>
        # a comment about foo.<br/>
        /usr/bin/foo {<br/>
          /bin/mount          ux,<br/>
          /dev/{,u}random     r,<br/>
          /etc/ld.so.cache    r,<br/>
          /etc/foo.conf       r,<br/>
          /etc/foo/*          r,<br/>
          /lib/ld-*.so*       rmix,<br/>
          /lib/lib*.so*       r,<br/>
          /proc/[0-9]**       r,<br/>
          /usr/lib/**         r,<br/>
          /tmp/foo.pid        wr,<br/>
          /tmp/foo.*          lrw,<br/>
          /@{HOME}/.foo_file  rw,<br/>
          /usr/bin/baz        Cx -&gt; baz,<br/>
<br/>
          # a comment about foo's hat (subprofile), bar.<br/>
          ^bar {<br/>
            /lib/ld-*.so*       rmix,<br/>
            /usr/bin/bar        rmix,<br/>
            /var/spool/*        rwl,<br/>
          }<br/>
<br/>
          # a comment about foo's subprofile, baz.<br/>
          profile baz {<br/>
            #include &lt;abstractions/bash&gt;<br/>
            owner /proc/[0-9]*/stat r,<br/>
            /bin/bash ixr,<br/>
            /var/lib/baz/ r,<br/>
            owner /var/lib/baz/* rw,<br/>
          }<br/>
        }<br/>
</div>
<div class="section">
<h1>FILES</h1><dl>
<dt>
<i>/etc/init.d/boot.apparmor</i></dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<i>/etc/apparmor.d/</i></dt>
<dd>
</dd>
</dl>
</div>
<div class="section">
<h1>KNOWN BUGS</h1><div style="margin-left: 4.00ex;">
Mount options support the use of pattern matching but mount flags are not correctly intersected against specified patterns. Eg, 'mount options=**,' should be equivalent to 'mount,', but it is not. (LP: #965690)<div style="height: 1.00em;">
&#160;</div>
The fstype may not be matched against when certain mount command flags are used. Specifically fstype matching currently only works when creating a new mount and not remount, bind, etc.<div style="height: 1.00em;">
&#160;</div>
Mount rules with multiple 'options' conditionals are not applied as documented but instead merged such that 'options in (ro,nodev) options in (atime)' is equivalent to 'options in (ro,nodev,atime)'.<div style="height: 1.00em;">
&#160;</div>
When specifying mount options with the 'in' conditional, both the positive and negative values match when specifying one or the other. Eg, 'rw' matches when 'ro' is specified and 'dev' matches when 'nodev' is specified such that 'options in (ro,nodev)' is equivalent to 'options in (rw,dev)'.</div>
</div>
<div class="section">
<h1>SEE ALSO</h1>  <i>apparmor</i>(7), <i>apparmor_parser</i>(8), <i>aa-complain</i>(1),  <i>aa-enforce</i>(1), <i>aa_change_hat</i>(2), <i>mod_apparmor</i>(5), and &lt;http://wiki.apparmor.net&gt;.</div>
<table class="foot">
<tr>
<td class="foot-date">
2014-08-11</td>
<td class="foot-os">
AppArmor 2.7.102</td>
</tr>
</table>
</div>
</body>
</html>

