<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/linux/style.css" type="text/css" media="all"/>
<title>
Filter::Util::Call(3perl)</title>
</head>
<body>
<div class="mandoc">
<table class="head">
<tbody>
<tr>
<td class="head-ltitle">
Filter::Util::Call(3perl)</td>
<td class="head-vol">
Perl Programmers Reference Guide</td>
<td class="head-rtitle">
Filter::Util::Call(3perl)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1>NAME</h1> Filter::Util::Call - Perl Source Filter Utility Module</div>
<div class="section">
<h1>SYNOPSIS</h1><br/>
    use Filter::Util::Call ;<br/>
</div>
<div class="section">
<h1>DESCRIPTION</h1> This module provides you with the framework to write  <i>Source Filters</i> in Perl.<div class="spacer">
</div>
An alternate interface to Filter::Util::Call is now available. See Filter::Simple for more details.<div class="spacer">
</div>
A <i>Perl Source Filter</i> is implemented as a Perl module. The structure of the module can take one of two broadly similar formats. To distinguish between them, the first will be referred to as  <i>method</i>  <i>filter</i> and the second as <i>closure filter</i>.<div class="spacer">
</div>
Here is a skeleton for the <i>method filter</i>:<div class="spacer">
</div>
<br/>
    package MyFilter ;<br/>
<br/>
    use Filter::Util::Call ;<br/>
<br/>
    sub import<br/>
    {<br/>
        my($type, @arguments) = @_ ;<br/>
        filter_add([]) ;<br/>
    }<br/>
<br/>
    sub filter<br/>
    {<br/>
        my($self) = @_ ;<br/>
        my($status) ;<br/>
<br/>
        $status = filter_read() ;<br/>
        $status ;<br/>
    }<br/>
<br/>
    1 ;<br/>
<div class="spacer">
</div>
and this is the equivalent skeleton for the <i>closure filter</i>:<div class="spacer">
</div>
<br/>
    package MyFilter ;<br/>
<br/>
    use Filter::Util::Call ;<br/>
<br/>
    sub import<br/>
    {<br/>
        my($type, @arguments) = @_ ;<br/>
<br/>
        filter_add(<br/>
            sub <br/>
            {<br/>
                my($status) ;<br/>
                $status = filter_read() ;<br/>
                $status ;<br/>
            } )<br/>
    }<br/>
<br/>
    1 ;<br/>
<div class="spacer">
</div>
To make use of either of the two filter modules above, place the line below in a Perl source file.<div class="spacer">
</div>
<br/>
    use MyFilter;<br/>
<div class="spacer">
</div>
In fact, the skeleton modules shown above are fully functional <i>Source</i>  <i>Filters</i>, albeit fairly useless ones. All they does is filter the source stream without modifying it at all.<div class="spacer">
</div>
As you can see both modules have a broadly similar structure. They both make use of the &quot;Filter::Util::Call&quot; module and both have an &quot;import&quot; method. The difference between them is that the  <i>method filter</i> requires a  <i>filter</i> method, whereas the <i>closure filter</i> gets the equivalent of a  <i>filter</i> method with the anonymous sub passed to  <i>filter_add</i>.<div class="spacer">
</div>
To make proper use of the <i>closure filter</i> shown above you need to have a good understanding of the concept of a  <i>closure</i>. See perlref for more details on the mechanics of  <i>closures</i>.<div class="subsection">
<h2><b>use Filter::Util::Call</b></h2> The following functions are exported by &quot;Filter::Util::Call&quot;:<div class="spacer">
</div>
<br/>
    filter_add()<br/>
    filter_read()<br/>
    filter_read_exact()<br/>
    filter_del()<br/>
</div>
<div class="subsection">
<h2><b></b><b><i>import()</i></b><b></b></h2> The &quot;import&quot; method is used to create an instance of the filter. It is called indirectly by Perl when it encounters the &quot;use MyFilter&quot; line in a source file (See &quot;import&quot; in perlfunc for more details on &quot;import&quot;).<div class="spacer">
</div>
It will always have at least one parameter automatically passed by Perl - this corresponds to the name of the package. In the example above it will be &quot;MyFilter&quot;.<div class="spacer">
</div>
Apart from the first parameter, import can accept an optional list of parameters. These can be used to pass parameters to the filter. For example:<div class="spacer">
</div>
<br/>
    use MyFilter qw(a b c) ;<br/>
<div class="spacer">
</div>
will result in the @_ array having the following values:<div class="spacer">
</div>
<br/>
    @_ [0] =&gt; &quot;MyFilter&quot;<br/>
    @_ [1] =&gt; &quot;a&quot;<br/>
    @_ [2] =&gt; &quot;b&quot;<br/>
    @_ [3] =&gt; &quot;c&quot;<br/>
<div class="spacer">
</div>
Before terminating, the &quot;import&quot; function must explicitly install the filter by calling &quot;filter_add&quot;.<div class="spacer">
</div>
<b></b><b><i>filter_add()</i></b><b></b><div class="spacer">
</div>
The function, &quot;filter_add&quot;, actually installs the filter. It takes one parameter which should be a reference. The kind of reference used will dictate which of the two filter types will be used.<div class="spacer">
</div>
If a CODE reference is used then a <i>closure filter</i> will be assumed.<div class="spacer">
</div>
If a CODE reference is not used, a <i>method filter</i> will be assumed. In a  <i>method filter</i>, the reference can be used to store context information. The reference will be  <i>blessed</i> into the package by &quot;filter_add&quot;.<div class="spacer">
</div>
See the filters at the end of this documents for examples of using context information using both  <i>method filters</i> and <i>closure</i>  <i>filters</i>.</div>
<div class="subsection">
<h2><b></b><b><i>filter()</i></b><b> and anonymous sub</b></h2> Both the &quot;filter&quot; method used with a  <i>method filter</i> and the anonymous sub used with a  <i>closure filter</i> is where the main processing for the filter is done.<div class="spacer">
</div>
The big difference between the two types of filter is that the <i>method</i>  <i>filter</i> uses the object passed to the method to store any context data, whereas the  <i>closure filter</i> uses the lexical variables that are maintained by the closure.<div class="spacer">
</div>
Note that the single parameter passed to the <i>method filter</i>, $self, is the same reference that was passed to &quot;filter_add&quot; blessed into the filter's package. See the example filters later on for details of using $self.<div class="spacer">
</div>
Here is a list of the common features of the anonymous sub and the &quot;filter()&quot; method.<dl>
<dt>
<b></b><b>$_</b><b></b></dt>
<dd>
Although $_ doesn't actually appear explicitly in the sample filters above, it is implicitly used in a number of places.<div style="height: 1.00em;">
&#160;</div>
Firstly, when either &quot;filter&quot; or the anonymous sub are called, a local copy of $_ will automatically be created. It will always contain the empty string at this point.<div style="height: 1.00em;">
&#160;</div>
Next, both &quot;filter_read&quot; and &quot;filter_read_exact&quot; will append any source data that is read to the end of $_.<div style="height: 1.00em;">
&#160;</div>
Finally, when &quot;filter&quot; or the anonymous sub are finished processing, they are expected to return the filtered source using $_.<div style="height: 1.00em;">
&#160;</div>
This implicit use of $_ greatly simplifies the filter.</dd>
</dl>
<dl>
<dt>
<b></b><b>$status</b><b></b></dt>
<dd>
The status value that is returned by the user's &quot;filter&quot; method or anonymous sub and the &quot;filter_read&quot; and &quot;read_exact&quot; functions take the same set of values, namely:<div style="height: 1.00em;">
&#160;</div>
<br/>
    &lt; 0  Error<br/>
    = 0  EOF<br/>
    &gt; 0  OK<br/>
</dd>
</dl>
<dl>
<dt>
<b>filter_read</b> and <b>filter_read_exact</b></dt>
<dd>
These functions are used by the filter to obtain either a line or block from the next filter in the chain or the actual source file if there aren't any other filters.<div style="height: 1.00em;">
&#160;</div>
The function &quot;filter_read&quot; takes two forms:<div style="height: 1.00em;">
&#160;</div>
<br/>
    $status = filter_read() ;<br/>
    $status = filter_read($size) ;<br/>
<div style="height: 1.00em;">
&#160;</div>
The first form is used to request a <i>line</i>, the second requests a  <i>block</i>.<div style="height: 1.00em;">
&#160;</div>
In line mode, &quot;filter_read&quot; will append the next source line to the end of the $_ scalar.<div style="height: 1.00em;">
&#160;</div>
In block mode, &quot;filter_read&quot; will append a block of data which is &lt;= $size to the end of the $_ scalar. It is important to emphasise the that &quot;filter_read&quot; will not necessarily read a block which is  <i>precisely</i> $size bytes.<div style="height: 1.00em;">
&#160;</div>
If you need to be able to read a block which has an exact size, you can use the function &quot;filter_read_exact&quot;. It works identically to &quot;filter_read&quot; in block mode, except it will try to read a block which is exactly $size bytes in length. The only circumstances when it will not return a block which is $size bytes long is on EOF or error.<div style="height: 1.00em;">
&#160;</div>
It is <i>very</i> important to check the value of $status after <i>every</i> call to &quot;filter_read&quot; or &quot;filter_read_exact&quot;.</dd>
</dl>
<dl>
<dt>
<b>filter_del</b></dt>
<dd>
The function, &quot;filter_del&quot;, is used to disable the current filter. It does not affect the running of the filter. All it does is tell Perl not to call filter any more.<div style="height: 1.00em;">
&#160;</div>
See &quot;Example 4: Using filter_del&quot; for details.</dd>
</dl>
</div>
</div>
<div class="section">
<h1>EXAMPLES</h1> Here are a few examples which illustrate the key concepts - as such most of them are of little practical use.<div class="spacer">
</div>
The &quot;examples&quot; sub-directory has copies of all these filters implemented both as  <i>method filters</i> and as <i>closure filters</i>.<div class="subsection">
<h2>Example 1: A simple filter.</h2> Below is a  <i>method filter</i> which is hard-wired to replace all occurrences of the string &quot;Joe&quot; to &quot;Jim&quot;. Not particularly Useful, but it is the first example and I wanted to keep it simple.<div class="spacer">
</div>
<br/>
    package Joe2Jim ;<br/>
<br/>
    use Filter::Util::Call ;<br/>
<br/>
    sub import<br/>
    {<br/>
        my($type) = @_ ;<br/>
<br/>
        filter_add(bless []) ;<br/>
    }<br/>
<br/>
    sub filter<br/>
    {<br/>
        my($self) = @_ ;<br/>
        my($status) ;<br/>
<br/>
        s/Joe/Jim/g<br/>
            if ($status = filter_read()) &gt; 0 ;<br/>
        $status ;<br/>
    }<br/>
<br/>
    1 ;<br/>
<div class="spacer">
</div>
Here is an example of using the filter:<div class="spacer">
</div>
<br/>
    use Joe2Jim ;<br/>
    print &quot;Where is Joe?\n&quot; ;<br/>
<div class="spacer">
</div>
And this is what the script above will print:<div class="spacer">
</div>
<br/>
    Where is Jim?<br/>
</div>
<div class="subsection">
<h2>Example 2: Using the context</h2> The previous example was not particularly useful. To make it more general purpose we will make use of the context data and allow any arbitrary  <i>from</i> and <i>to</i> strings to be used. This time we will use a  <i>closure filter</i>. To reflect its enhanced role, the filter is called &quot;Subst&quot;.<div class="spacer">
</div>
<br/>
    package Subst ;<br/>
<br/>
    use Filter::Util::Call ;<br/>
    use Carp ;<br/>
<br/>
    sub import<br/>
    {<br/>
        croak(&quot;usage: use Subst qw(from to)&quot;)<br/>
            unless @_ == 3 ;<br/>
        my ($self, $from, $to) = @_ ;<br/>
        filter_add(<br/>
            sub <br/>
            {<br/>
                my ($status) ;<br/>
                s/$from/$to/<br/>
                    if ($status = filter_read()) &gt; 0 ;<br/>
                $status ;<br/>
            })<br/>
    }<br/>
    1 ;<br/>
<div class="spacer">
</div>
and is used like this:<div class="spacer">
</div>
<br/>
    use Subst qw(Joe Jim) ;<br/>
    print &quot;Where is Joe?\n&quot; ;<br/>
</div>
<div class="subsection">
<h2>Example 3: Using the context within the filter</h2> Here is a filter which a variation of the &quot;Joe2Jim&quot; filter. As well as substituting all occurrences of &quot;Joe&quot; to &quot;Jim&quot; it keeps a count of the number of substitutions made in the context object.<div class="spacer">
</div>
Once EOF is detected ($status is zero) the filter will insert an extra line into the source stream. When this extra line is executed it will print a count of the number of substitutions actually made. Note that $status is set to 1 in this case.<div class="spacer">
</div>
<br/>
    package Count ;<br/>
<br/>
    use Filter::Util::Call ;<br/>
<br/>
    sub filter<br/>
    {<br/>
        my ($self) = @_ ;<br/>
        my ($status) ;<br/>
<br/>
        if (($status = filter_read()) &gt; 0 ) {<br/>
            s/Joe/Jim/g ;<br/>
            ++ $$self ;<br/>
        }<br/>
        elsif ($$self &gt;= 0) { # EOF<br/>
            $_ = &quot;print q[Made ${$self} substitutions\n]&quot; ;<br/>
            $status = 1 ;<br/>
            $$self = -1 ;<br/>
        }<br/>
<br/>
        $status ;<br/>
    }<br/>
<br/>
    sub import<br/>
    {<br/>
        my ($self) = @_ ;<br/>
        my ($count) = 0 ;<br/>
        filter_add(\$count) ;<br/>
    }<br/>
<br/>
    1 ;<br/>
<div class="spacer">
</div>
Here is a script which uses it:<div class="spacer">
</div>
<br/>
    use Count ;<br/>
    print &quot;Hello Joe\n&quot; ;<br/>
    print &quot;Where is Joe\n&quot; ;<br/>
<div class="spacer">
</div>
Outputs:<div class="spacer">
</div>
<br/>
    Hello Jim<br/>
    Where is Jim<br/>
    Made 2 substitutions<br/>
</div>
<div class="subsection">
<h2>Example 4: Using filter_del</h2> Another variation on a theme. This time we will modify the &quot;Subst&quot; filter to allow a starting and stopping pattern to be specified as well as the  <i>from</i> and <i>to</i> patterns. If you know the <i>vi</i> editor, it is the equivalent of this command:<div class="spacer">
</div>
<br/>
    :/start/,/stop/s/from/to/<br/>
<div class="spacer">
</div>
When used as a filter we want to invoke it like this:<div class="spacer">
</div>
<br/>
    use NewSubst qw(start stop from to) ;<br/>
<div class="spacer">
</div>
Here is the module.<div class="spacer">
</div>
<br/>
    package NewSubst ;<br/>
<br/>
    use Filter::Util::Call ;<br/>
    use Carp ;<br/>
<br/>
    sub import<br/>
    {<br/>
        my ($self, $start, $stop, $from, $to) = @_ ;<br/>
        my ($found) = 0 ;<br/>
        croak(&quot;usage: use Subst qw(start stop from to)&quot;)<br/>
            unless @_ == 5 ;<br/>
<br/>
        filter_add( <br/>
            sub <br/>
            {<br/>
                my ($status) ;<br/>
<br/>
                if (($status = filter_read()) &gt; 0) {<br/>
<br/>
                    $found = 1<br/>
                        if $found == 0 and /$start/ ;<br/>
<br/>
                    if ($found) {<br/>
                        s/$from/$to/ ;<br/>
                        filter_del() if /$stop/ ;<br/>
                    }<br/>
<br/>
                }<br/>
                $status ;<br/>
            } )<br/>
<br/>
    }<br/>
<br/>
    1 ;<br/>
</div>
</div>
<div class="section">
<h1>Filter::Simple</h1> If you intend using the Filter::Call functionality, I would strongly recommend that you check out Damian Conway's excellent Filter::Simple module. Damian's module provides a much cleaner interface than Filter::Util::Call. Although it doesn't allow the fine control that Filter::Util::Call does, it should be adequate for the majority of applications. It's available at<div class="spacer">
</div>
<br/>
   http://www.cpan.org/modules/by-author/Damian_Conway/Filter-Simple.tar.gz<br/>
   http://www.csse.monash.edu.au/~damian/CPAN/Filter-Simple.tar.gz<br/>
</div>
<div class="section">
<h1>AUTHOR</h1> Paul Marquess</div>
<div class="section">
<h1>DATE</h1> 26th January 1996</div>
<table class="foot">
<tr>
<td class="foot-date">
2011-09-26</td>
<td class="foot-os">
perl v5.14.2</td>
</tr>
</table>
</div>
</body>
</html>

