<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/linux/style.css" type="text/css" media="all"/>
<title>
PIDFILE(3)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">pidfile_open</b>, <b class="name">pidfile_write</b>, <b class="name">pidfile_close</b>, <b class="name">pidfile_remove</b> &#8212; <span class="desc">library for PID files handling</span></div>
<div class="section">
<h1 id="x4c494252415259">LIBRARY</h1> <span class="lib">library &#8220;libbsd&#8221;</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">bsd/libutil.h</a>&gt;</b><div class="spacer">
</div>
<i class="ftype">struct pidfh *</i><br/>
<b class="fname">pidfile_open</b>(<i class="farg" style="white-space:nowrap;">const char *path</i>, <i class="farg" style="white-space:nowrap;">mode_t mode</i>, <i class="farg" style="white-space:nowrap;">pid_t *pidptr</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">pidfile_write</b>(<i class="farg" style="white-space:nowrap;">struct pidfh *pfh</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">pidfile_close</b>(<i class="farg" style="white-space:nowrap;">struct pidfh *pfh</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">pidfile_remove</b>(<i class="farg" style="white-space:nowrap;">struct pidfh *pfh</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">pidfile</b> family of functions allows daemons to handle PID files. It uses <a class="link-man" href="/man/linux/3/flopen">flopen(3)</a> to lock a pidfile and detect already running daemons.<div class="spacer">
</div>
The <b class="fname">pidfile_open</b>() function opens (or creates) a file specified by the <i class="farg">path</i> argument and locks it. If a file can not be locked, a PID of an already running daemon is returned in the <i class="farg">pidptr</i> argument (if it is not <span class="define">NULL</span>). The function does not write process' PID into the file here, so it can be used before <b class="fname">fork</b>()ing and exit with a proper error message when needed. If the <i class="farg">path</i> argument is <span class="define">NULL</span>, <i class="file">/var/run/</i>&#10216;<b class="var">progname</b>&#10217;<i class="file">.pid</i> file will be used.<div class="spacer">
</div>
The <b class="fname">pidfile_write</b>() function writes process' PID into a previously opened file.<div class="spacer">
</div>
The <b class="fname">pidfile_close</b>() function closes a pidfile. It should be used after daemon <b class="fname">fork</b>()s to start a child process.<div class="spacer">
</div>
The <b class="fname">pidfile_remove</b>() function closes and removes a pidfile.</div>
<div class="section">
<h1 id="x52455455524e2056414c554553">RETURN VALUES</h1> The <b class="fname">pidfile_open</b>() function returns a valid pointer to a <span class="type">pidfh</span> structure on success, or <span class="define">NULL</span> if an error occurs. If an error occurs, <b class="var">errno</b> will be set.<div class="spacer">
</div>
<br/>
The <b class="fname">pidfile_write</b>(), <b class="fname">pidfile_close</b>(), and <b class="fname">pidfile_remove</b>() functions return the value&#160;0 if successful; otherwise the value&#160;-1 is returned and the global variable <b class="var">errno</b> is set to indicate the error.</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> The following example shows in which order these functions should be used. Note that it is safe to pass <span class="define">NULL</span> to <b class="fname">pidfile_write</b>(), <b class="fname">pidfile_remove</b>() and <b class="fname">pidfile_close</b>() functions.<div class="spacer">
</div>
<pre style="margin-left: 0.00ex;" class="lit display">
struct pidfh *pfh; 
pid_t otherpid, childpid; 
 
pfh = pidfile_open(&quot;/var/run/daemon.pid&quot;, 0600, &amp;otherpid); 
if (pfh == NULL) { 
	if (errno == EEXIST) { 
		errx(EXIT_FAILURE, &quot;Daemon already running, pid: %jd.&quot;, 
		    (intmax_t)otherpid); 
	} 
	/* If we cannot create pidfile from other reasons, only warn. */ 
	warn(&quot;Cannot open or create pidfile&quot;); 
} 
 
if (daemon(0, 0) == -1) { 
	warn(&quot;Cannot daemonize&quot;); 
	pidfile_remove(pfh); 
	exit(EXIT_FAILURE); 
} 
 
pidfile_write(pfh); 
 
for (;;) { 
	/* Do work. */ 
	childpid = fork(); 
	switch (childpid) { 
	case -1: 
		syslog(LOG_ERR, &quot;Cannot fork(): %s.&quot;, strerror(errno)); 
		break; 
	case 0: 
		pidfile_close(pfh); 
		/* Do child work. */ 
		break; 
	default: 
		syslog(LOG_INFO, &quot;Child %jd started.&quot;, (intmax_t)childpid); 
		break; 
	} 
} 
 
pidfile_remove(pfh); 
exit(EXIT_SUCCESS);</pre>
</div>
<div class="section">
<h1 id="x4552524f5253">ERRORS</h1> The <b class="fname">pidfile_open</b>() function will fail if:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">EEXIST</span>]</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Some process already holds the lock on the given pidfile, meaning that a daemon is already running.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">ENAMETOOLONG</span>]</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Specified pidfile's name is too long.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">EINVAL</span>]</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Some process already holds the lock on the given pidfile, but PID read from there is invalid.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">EAGAIN</span>]</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Some process already holds the lock on the given pidfile, but the file is truncated. Most likely, the existing daemon is writing new PID into the file.</dd>
</dl>
<div class="spacer">
</div>
The <b class="fname">pidfile_open</b>() function may also fail and set <b class="var">errno</b> for any errors specified for the <a class="link-man" href="/man/linux/2/fstat">fstat(2)</a>, <a class="link-man" href="/man/linux/2/open">open(2)</a>, and <a class="link-man" href="/man/linux/2/read">read(2)</a> calls.<div class="spacer">
</div>
The <b class="fname">pidfile_write</b>() function will fail if:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">EINVAL</span>]</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Improper function use. Probably called before <b class="fname">pidfile_open</b>().</dd>
</dl>
<div class="spacer">
</div>
The <b class="fname">pidfile_write</b>() function may also fail and set <b class="var">errno</b> for any errors specified for the <a class="link-man" href="/man/linux/2/fstat">fstat(2)</a>, <a class="link-man" href="/man/linux/2/ftruncate">ftruncate(2)</a>, and <a class="link-man" href="/man/linux/2/write">write(2)</a> calls.<div class="spacer">
</div>
The <b class="fname">pidfile_close</b>() function may fail and set <b class="var">errno</b> for any errors specified for the <a class="link-man" href="/man/linux/2/close">close(2)</a> and <a class="link-man" href="/man/linux/2/fstat">fstat(2)</a> calls.<div class="spacer">
</div>
The <b class="fname">pidfile_remove</b>() function will fail if:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">EINVAL</span>]</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Improper function use. Probably called not from the process which made <b class="fname">pidfile_write</b>().</dd>
</dl>
<div class="spacer">
</div>
The <b class="fname">pidfile_remove</b>() function may also fail and set <b class="var">errno</b> for any errors specified for the <a class="link-man" href="/man/linux/2/close">close(2)</a>, <a class="link-man" href="/man/linux/2/fstat">fstat(2)</a>, <a class="link-man" href="/man/linux/2/write">write(2)</a>, and <a class="link-man" href="/man/linux/2/unlink">unlink(2)</a> system calls and the <a class="link-man" href="/man/linux/3/flopen">flopen(3)</a> library function.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="/man/linux/2/open">open(2)</a>, <a class="link-man" href="/man/linux/3/daemon">daemon(3)</a>, <a class="link-man" href="/man/linux/3/flopen">flopen(3)</a></div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> The <b class="name">pidfile</b> functionality is based on ideas from <span class="author">John-Mark Gurney</span> &#10216;jmg@FreeBSD.org&#10217;.<div class="spacer">
</div>
The code and manual page was written by <span class="author">Pawel Jakub Dawidek</span> &#10216;pjd@FreeBSD.org&#10217;.</div>
</div>
</body>
</html>

