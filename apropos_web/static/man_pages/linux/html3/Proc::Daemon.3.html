<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/linux/style.css" type="text/css" media="all"/>
<title>
Proc::Daemon(3pm)</title>
</head>
<body>
<div class="mandoc">
<table class="head">
<tbody>
<tr>
<td class="head-ltitle">
Proc::Daemon(3pm)</td>
<td class="head-vol">
User Contributed Perl Documentation</td>
<td class="head-rtitle">
Proc::Daemon(3pm)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1>NAME</h1> Proc::Daemon - Run Perl program(s) as a daemon process.</div>
<div class="section">
<h1>SYNOPSIS</h1><br/>
    use Proc::Daemon;<br/>
<br/>
    $daemon = Proc::Daemon-&gt;new(<br/>
        work_dir =&gt; '/my/daemon/directory',<br/>
        .....<br/>
    );<br/>
<br/>
    $Kid_1_PID = $daemon-&gt;Init;<br/>
<br/>
    unless ( $Kid_1_PID ) {<br/>
        # code executed only by the child ...<br/>
    }<br/>
<br/>
    $Kid_2_PID = $daemon-&gt;Init( { <br/>
                    work_dir     =&gt; '/other/daemon/directory',<br/>
                    exec_command =&gt; 'perl /home/my_script.pl',<br/>
                 } );<br/>
<br/>
    $pid = $daemon-&gt;Status( ... );<br/>
<br/>
    $stopped = $daemon-&gt;Kill_Daemon( ... );<br/>
</div>
<div class="section">
<h1>DESCRIPTION</h1> This module can be used by a Perl program to initialize itself as a daemon or to execute (&quot;exec&quot;) a system command as daemon. You can also check the status of the daemon (alive or dead) and you can kill the daemon.<div class="spacer">
</div>
A daemon is a process that runs in the background with no controlling terminal. Generally servers (like FTP, HTTP and SIP servers) run as daemon processes. Do not make the mistake to think that a daemon is a server. ;-)<div class="spacer">
</div>
Proc::Daemon does the following:<dl>
<dt>
1.</dt>
<dd>
The script forks a child.</dd>
</dl>
<dl>
<dt>
2.</dt>
<dd>
The child changes the current working directory to the value of 'work_dir'.</dd>
</dl>
<dl>
<dt>
3.</dt>
<dd>
The child clears the file creation mask.</dd>
</dl>
<dl>
<dt>
4.</dt>
<dd>
The child becomes a session leader, which detaches the program from the controlling terminal.</dd>
</dl>
<dl>
<dt>
5.</dt>
<dd>
The child forks another child (the final daemon process). This prevents the potential of acquiring a controlling terminal at all and detaches the daemon completely from the first parent.</dd>
</dl>
<dl>
<dt>
6.</dt>
<dd>
The second child closes all open file descriptors (unless you define &quot;dont_close_fh&quot; and/or &quot;dont_close_fd&quot;).</dd>
</dl>
<dl>
<dt>
7.</dt>
<dd>
The second child opens STDIN, STDOUT and STDERR to the location defined in the constructor (&quot;new&quot;).</dd>
</dl>
<dl>
<dt>
8.</dt>
<dd>
The second child returns to the calling script, or the program defined in 'exec_command' is executed and the second child never returns.</dd>
</dl>
<dl>
<dt>
9.</dt>
<dd>
The first child transfers the PID of the second child (daemon) to the parent. Additionally the PID of the daemon process can be written into a file if 'pid_file' is defined. Then the first child exits.</dd>
</dl>
<dl>
<dt>
10.</dt>
<dd>
If the parent script is looking for a return value, then the PID(s) of the child/ren will be returned. Otherwise the parent will exit.</dd>
</dl>
<div class="spacer">
</div>
NOTE: Because of the second fork the daemon will not be a session-leader and therefore Signals will not be send to other members of his process group. If you need the functionality of a session-leader you may want to call  <i>POSIX::setsid()</i> manually at your daemon.<div class="spacer">
</div>
INFO: Since &quot;fork&quot; is not performed the same way on Windows systems as on Linux, this module does not work with Windows. Patches appreciated!</div>
<div class="section">
<h1>CONSTRUCTOR</h1><dl>
<dt>
new ( %ARGS )</dt>
<dd>
The constructor creates a new Proc::Daemon object based on the hash %ARGS. The following keys from %ARGS are used:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<dl>
<dt>
work_dir</dt>
<dd>
Defines the path to the working directory of your daemon. Defaults to &quot;/&quot;.</dd>
</dl>
<dl>
<dt>
setuid</dt>
<dd>
Sets the real user identifier ($&lt;) and the effective user identifier ($&gt;) for the daemon process using &quot;POSIX::setuid( ... )&quot;, in case you want to run your daemon under a different user from the parent. Obviously the first user must have the rights to switch to the new user otherwise it will stay the same. It is helpful to define the argument &quot;setuid&quot; if you start your script at boot time by init with the superuser, but wants the daemon to run under a normal user account.</dd>
</dl>
<dl>
<dt>
child_STDIN</dt>
<dd>
Defines the path to STDIN for your daemon. Defaults to &quot;/dev/null&quot;. Default Mode is '&lt;' (read). You can define other Mode the same way as you do using Perls &quot;open&quot; in a two-argument form.</dd>
</dl>
<dl>
<dt>
child_STDOUT</dt>
<dd>
Defines the path where the output of your daemon will go. Defaults to &quot;/dev/null&quot;. Default Mode is '+&gt;' (write/read). You can define other Mode the same way as you do using Perls &quot;open&quot; in a two-argument form.</dd>
</dl>
<dl>
<dt>
child_STDERR</dt>
<dd>
Defines the path where the error output of your daemon will go. Defaults to &quot;/dev/null&quot;. Default Mode is '+&gt;' (write/read). You can define other Mode the same way as you do using Perls &quot;open&quot; in a two-argument form, see example below.</dd>
</dl>
<dl>
<dt>
dont_close_fh</dt>
<dd>
If you define it, it must be an arrayref with file handles you want to preserve from the parent into the child (daemon). This may be the case if you have code below a &quot;__DATA__&quot; token in your script or module called by &quot;use&quot; or &quot;require&quot;.<div style="height: 1.00em;">
&#160;</div>
<br/>
    dont_close_fh =&gt; [ 'main::DATA', 'PackageName::DATA', $my_filehandle, ... ],<br/>
<div style="height: 1.00em;">
&#160;</div>
You can add any kind of file handle to the array (expression in single quotes or a scalar variable), including 'STDIN', 'STDOUT' and 'STDERR'. Logically the path settings from above (&quot;child_STDIN&quot;, ...) will be ignored in this case.<div style="height: 1.00em;">
&#160;</div>
DISCLAIMER: Using this argument may not detach your daemon fully from the parent! Use it at your own risk.</dd>
</dl>
<dl>
<dt>
dont_close_fd</dt>
<dd>
Same function and disclaimer as &quot;dont_close_fh&quot;, but instead of file handles you write the numeric file descriptors inside the arrayref.</dd>
</dl>
<dl>
<dt>
pid_file</dt>
<dd>
Defines the path to a file (owned by the parent user) where the PID of the daemon process will be stored. Defaults to &quot;undef&quot; (= write no file).</dd>
</dl>
<dl>
<dt>
exec_command</dt>
<dd>
Scalar or arrayref with system command(s) that will be executed by the daemon via Perls &quot;exec PROGRAM_LIST&quot;. In this case the child will never return to the parents process!</dd>
</dl>
</div>
<div style="margin-left: 4.00ex;">
<div style="height: 1.00em;">
&#160;</div>
Example:<div style="height: 1.00em;">
&#160;</div>
<br/>
    my $daemon = Proc::Daemon-&gt;new(<br/>
        work_dir     =&gt; '/working/daemon/directory',<br/>
        child_STDOUT =&gt; '/path/to/daemon/output.file',<br/>
        child_STDERR =&gt; '+&gt;&gt;debug.txt',<br/>
        pid_file     =&gt; 'pid.txt',<br/>
        exec_command =&gt; 'perl /home/my_script.pl',<br/>
      # or:<br/>
      # exec_command =&gt; [ 'perl /home/my_script.pl', 'perl /home/my_other_script.pl' ],<br/>
    );<br/>
<div style="height: 1.00em;">
&#160;</div>
In this example:<dl>
<dt>
&#8226;</dt>
<dd>
the PID of the daemon will be returned to $daemon in the parent process and a pid-file will be created at &quot;/working/daemon/directory/pid.txt&quot;.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
STDOUT will be open with Mode '+&gt;' (write/read) to &quot;/path/to/daemon/output.file&quot; and STDERR will be open to &quot;/working/daemon/directory/debug.txt&quot; with Mode '+&gt;&gt;' (write/read opened for appending).</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
the script &quot;/home/my_script.pl&quot; will be executed by &quot;perl&quot; and run as daemon. Therefore the child process will never return to this parent script.</dd>
</dl>
</div>
<div style="margin-left: 4.00ex;">
</div>
</div>
<div class="section">
<h1>METHODS</h1><dl>
<dt>
Init( [ { %ARGS } ] )</dt>
<dd>
Become a daemon.<div style="height: 1.00em;">
&#160;</div>
If used for the first time after &quot;new&quot;, you call &quot;Init&quot; with the object reference to start the daemon.<div style="height: 1.00em;">
&#160;</div>
<br/>
    $pid = $daemon-&gt;Init();<br/>
<div style="height: 1.00em;">
&#160;</div>
If you want to use the object reference created by &quot;new&quot; for other daemons, you write &quot;Init( { %ARGS } )&quot;. %ARGS are the same as described in &quot;new&quot;. Notice that you shouldn't call &quot;Init()&quot; without argument in this case, or the next daemon will execute and/or write in the same files as the first daemon. To prevent this use at least an empty anonymous hash here.<div style="height: 1.00em;">
&#160;</div>
<br/>
    $pid = $daemon-&gt;Init( {} );<br/>
    @pid = $daemon-&gt;Init( {<br/>
        work_dir     =&gt; '/other/daemon/directory',<br/>
        exec_command =&gt; [ 'perl /home/my_second_script.pl', 'perl /home/my_third_script.pl' ],<br/>
    } );<br/>
<div style="height: 1.00em;">
&#160;</div>
If you don't need the Proc::Daemon object reference in your script, you can also use the method without object reference:<div style="height: 1.00em;">
&#160;</div>
<br/>
    $pid = Proc::Daemon::Init();<br/>
    # or<br/>
    $pid = Proc::Daemon::Init( { %ARGS } );<br/>
<div style="height: 1.00em;">
&#160;</div>
&quot;Init&quot; returns the PID (scalar) of the daemon to the parent, or the PIDs (array) of the daemons created if &quot;exec_command&quot; has more then one program to execute. See examples above.<div style="height: 1.00em;">
&#160;</div>
&quot;Init&quot; returns 0 to the child (daemon).<div style="height: 1.00em;">
&#160;</div>
If you call the &quot;Init&quot; method in the context without looking for a return value (void context) the parent process will &quot;exit&quot; here like in earlier versions:<div style="height: 1.00em;">
&#160;</div>
<br/>
    Proc::Daemon::Init();<br/>
</dd>
</dl>
<dl>
<dt>
Status( [ $ARG ] )</dt>
<dd>
This function checks the status of the process (daemon). Returns the PID number (alive) or 0 (dead).<div style="height: 1.00em;">
&#160;</div>
$ARG can be a string with:</dd>
</dl>
<div style="margin-left: 4.00ex;">
<dl>
<dt>
&#8226;</dt>
<dd>
&quot;undef&quot;, in this case it tries to get the PID to check out of the object reference settings.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
a PID number to check.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
the path to a file containing the PID to check.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
the command line entry of the running program to check. This requires Proc::ProcessTable to be installed.</dd>
</dl>
</div>
<div style="margin-left: 4.00ex;">
</div>
<dl>
<dt>
Kill_Daemon( [ $ARG [, SIGNAL] ] )</dt>
<dd>
This function kills the Daemon process. Returns the number of processes successfully killed (which mostly is not the same as the PID number), or 0 if the process wasn't found.<div style="height: 1.00em;">
&#160;</div>
$ARG is the same as of &quot;Status()&quot;. SIGNAL is an optional signal name or number as required by Perls &quot;kill&quot; function and listed out by &quot;kill -l&quot; on your system. Default value is 9 ('KILL' = non-catchable, non-ignorable kill).</dd>
</dl>
<dl>
<dt>
Fork</dt>
<dd>
Is like the Perl built-in &quot;fork&quot;, but it retries to fork over 30 seconds if necessary and if possible to fork at all. It returns the child PID to the parent process and 0 to the child process. If the fork is unsuccessful it &quot;warn&quot;s and returns &quot;undef&quot;.</dd>
</dl>
</div>
<div class="section">
<h1>OTHER METHODS</h1> Proc::Daemon also defines some other functions. See source code for more details:<dl>
<dt>
OpenMax( [ $NUMBER ] )</dt>
<dd>
Returns the maximum file descriptor number. If undetermined $NUMBER will be returned.</dd>
</dl>
<dl>
<dt>
adjust_settings</dt>
<dd>
Does some fixes/adjustments on the &quot;new&quot; settings together with &quot;fix_filename&quot;.</dd>
</dl>
<dl>
<dt>
fix_filename( $KEYNAME )</dt>
<dd>
Prevents double use of same filename in different processes.</dd>
</dl>
<dl>
<dt>
get_pid( [ $STRING ] )</dt>
<dd>
Returns the wanted PID if it can be found.</dd>
</dl>
<dl>
<dt>
get_pid_by_proc_table_attr( $ATTR, $MATCH )</dt>
<dd>
Returns the wanted PID by looking into the process table, or &quot;undef&quot;. Requires the &quot;Proc::ProcessTable&quot; module to be installed.</dd>
</dl>
</div>
<div class="section">
<h1>NOTES</h1> &quot;Proc::Daemon::init&quot; is still available for backwards capability.</div>
<div class="section">
<h1>AUTHORS</h1> Primary-maintainer and code writer until version 0.03:<dl>
<dt>
&#8226;</dt>
<dd>
Earl Hood, earl@earlhood.com, http://www.earlhood.com/</dd>
</dl>
<div class="spacer">
</div>
Co-maintainer and code writer since version 0.04:<dl>
<dt>
&#8226;</dt>
<dd>
Detlef Pilzecker, http://search.cpan.org/~deti/, http://www.secure-sip-server.net/</dd>
</dl>
</div>
<div class="section">
<h1>CREDITS</h1> Initial implementation of &quot;Proc::Daemon&quot; derived from the following sources:<dl>
<dt>
&#8226;</dt>
<dd>
&quot;Advanced Programming in the UNIX Environment&quot; by W. Richard Stevens. Addison-Wesley, Copyright 1992.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
&quot;UNIX Network Programming&quot;, Vol 1, by W. Richard Stevens. Prentice-Hall PTR, Copyright 1998.</dd>
</dl>
</div>
<div class="section">
<h1>PREREQUISITES</h1> This module requires the &quot;POSIX&quot; module to be installed.<div class="spacer">
</div>
The &quot;Proc::ProcessTable&quot; module is not essentially required but it can be useful if it is installed (see above).</div>
<div class="section">
<h1>SEE ALSO</h1>  <i>perl</i>(1), POSIX, Proc::ProcessTable</div>
<div class="section">
<h1>COPYRIGHT</h1> This module is Copyright (C) 1997-2011 by Earl Hood and Detlef Pilzecker.<div class="spacer">
</div>
All Rights Reserved.<div class="spacer">
</div>
This module is free software. It may be used, redistributed and/or modified under the same terms as Perl itself.</div>
<table class="foot">
<tr>
<td class="foot-date">
2011-06-06</td>
<td class="foot-os">
perl v5.12.3</td>
</tr>
</table>
</div>
</body>
</html>

