<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/linux/style.css" type="text/css" media="all"/>
<title>
Moose::Cookbook::Basics::Recipe9(3pm)</title>
</head>
<body>
<div class="mandoc">
<table class="head">
<tbody>
<tr>
<td class="head-ltitle">
Moose::Cookbook::Basics::Recipe9(3pm)</td>
<td class="head-vol">
User Contributed Perl Documentation</td>
<td class="head-rtitle">
Moose::Cookbook::Basics::Recipe9(3pm)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1>NAME</h1> Moose::Cookbook::Basics::Recipe9 - Operator overloading, subtypes, and coercion</div>
<div class="section">
<h1>VERSION</h1> version 2.0401</div>
<div class="section">
<h1>SYNOPSIS</h1><br/>
  package Human;<br/>
<br/>
  use Moose;<br/>
  use Moose::Util::TypeConstraints;<br/>
<br/>
  subtype 'Sex'<br/>
      =&gt; as 'Str'<br/>
      =&gt; where { $_ =~ m{^[mf]$}s };<br/>
<br/>
  has 'sex'    =&gt; ( is =&gt; 'ro', isa =&gt; 'Sex', required =&gt; 1 );<br/>
<br/>
  has 'mother' =&gt; ( is =&gt; 'ro', isa =&gt; 'Human' );<br/>
  has 'father' =&gt; ( is =&gt; 'ro', isa =&gt; 'Human' );<br/>
<br/>
  use overload '+' =&gt; \&amp;_overload_add, fallback =&gt; 1;<br/>
<br/>
  sub _overload_add {<br/>
      my ( $one, $two ) = @_;<br/>
<br/>
      die('Only male and female humans may create children')<br/>
          if ( $one-&gt;sex() eq $two-&gt;sex() );<br/>
<br/>
      my ( $mother, $father )<br/>
          = ( $one-&gt;sex eq 'f' ? ( $one, $two ) : ( $two, $one ) );<br/>
<br/>
      my $sex = 'f';<br/>
      $sex = 'm' if ( rand() &gt;= 0.5 );<br/>
<br/>
      return Human-&gt;new(<br/>
          sex    =&gt; $sex,<br/>
          mother =&gt; $mother,<br/>
          father =&gt; $father,<br/>
      );<br/>
  }<br/>
</div>
<div class="section">
<h1>DESCRIPTION</h1> This Moose cookbook recipe shows how operator overloading, coercion, and subtypes can be used to mimic the human reproductive system (well, the selection of genes at least).</div>
<div class="section">
<h1>INTRODUCTION</h1> Our &quot;Human&quot; class uses operator overloading to allow us to &quot;add&quot; two humans together and produce a child. Our implementation does require that the two objects be of opposite sex. Remember, we're talking about biological reproduction, not marriage.<div class="spacer">
</div>
While this example works as-is, we can take it a lot further by adding genes into the mix. We'll add the two genes that control eye color, and use overloading to combine the genes from the parent to model the biology.<div class="subsection">
<h2>What is Operator Overloading?</h2> Overloading is  <i>not</i> a Moose-specific feature. It's a general OO concept that is implemented in Perl with the &quot;overload&quot; pragma. Overloading lets objects do something sane when used with Perl's built in operators, like addition (&quot;+&quot;) or when used as a string.<div class="spacer">
</div>
In this example we overload addition so we can write code like &quot;$child = $mother + $father&quot;.</div>
</div>
<div class="section">
<h1>GENES</h1> There are many genes which affect eye color, but there are two which are most important,  <i>gey</i> and <i>bey2</i>. We will start by making a class for each gene.<div class="subsection">
<h2>Human::Gene::bey2</h2><br/>
  package Human::Gene::bey2;<br/>
<br/>
  use Moose;<br/>
  use Moose::Util::TypeConstraints;<br/>
<br/>
  type 'bey2_color' =&gt; where { $_ =~ m{^(?:brown|blue)$} };<br/>
<br/>
  has 'color' =&gt; ( is =&gt; 'ro', isa =&gt; 'bey2_color' );<br/>
<div class="spacer">
</div>
This class is trivial. We have a type constraint for the allowed colors, and a &quot;color&quot; attribute.</div>
<div class="subsection">
<h2>Human::Gene::gey</h2><br/>
  package Human::Gene::gey;<br/>
<br/>
  use Moose;<br/>
  use Moose::Util::TypeConstraints;<br/>
<br/>
  type 'gey_color' =&gt; where { $_ =~ m{^(?:green|blue)$} };<br/>
<br/>
  has 'color' =&gt; ( is =&gt; 'ro', isa =&gt; 'gey_color' );<br/>
<div class="spacer">
</div>
This is nearly identical to the &quot;Humane::Gene::bey2&quot; class, except that the  <i>gey</i> gene allows for different colors.</div>
</div>
<div class="section">
<h1>EYE COLOR</h1> We could just give four attributes (two of each gene) to the &quot;Human&quot; class, but this is a bit messy. Instead, we'll abstract the genes into a container class, &quot;Human::EyeColor&quot;. Then a &quot;Human&quot; can have a single &quot;eye_color&quot; attribute.<div class="spacer">
</div>
<br/>
  package Human::EyeColor;<br/>
<br/>
  use Moose;<br/>
  use Moose::Util::TypeConstraints;<br/>
<br/>
  coerce 'Human::Gene::bey2'<br/>
      =&gt; from 'Str'<br/>
          =&gt; via { Human::Gene::bey2-&gt;new( color =&gt; $_ ) };<br/>
<br/>
  coerce 'Human::Gene::gey'<br/>
      =&gt; from 'Str'<br/>
          =&gt; via { Human::Gene::gey-&gt;new( color =&gt; $_ ) };<br/>
<br/>
  has [qw( bey2_1 bey2_2 )] =&gt;<br/>
      ( is =&gt; 'ro', isa =&gt; 'Human::Gene::bey2', coerce =&gt; 1 );<br/>
<br/>
  has [qw( gey_1 gey_2 )] =&gt;<br/>
      ( is =&gt; 'ro', isa =&gt; 'Human::Gene::gey', coerce =&gt; 1 );<br/>
<div class="spacer">
</div>
The eye color class has two of each type of gene. We've also created a coercion for each class that coerces a string into a new object. Note that a coercion will fail if it attempts to coerce a string like &quot;indigo&quot;, because that is not a valid color for either type of gene.<div class="spacer">
</div>
As an aside, you can see that we can define several identical attributes at once by supplying an array reference of names as the first argument to &quot;has&quot;.<div class="spacer">
</div>
We also need a method to calculate the actual eye color that results from a set of genes. The  <i>bey2</i> brown gene is dominant over both blue and green. The  <i>gey</i> green gene is dominant over blue.<div class="spacer">
</div>
<br/>
  sub color {<br/>
      my ($self) = @_;<br/>
<br/>
      return 'brown'<br/>
          if ( $self-&gt;bey2_1-&gt;color() eq 'brown'<br/>
          or $self-&gt;bey2_2-&gt;color() eq 'brown' );<br/>
<br/>
      return 'green'<br/>
          if ( $self-&gt;gey_1-&gt;color() eq 'green'<br/>
          or $self-&gt;gey_2-&gt;color() eq 'green' );<br/>
<br/>
      return 'blue';<br/>
  }<br/>
<div class="spacer">
</div>
We'd like to be able to treat a &quot;Human::EyeColor&quot; object as a string, so we define a string overloading for the class:<div class="spacer">
</div>
<br/>
  use overload '&quot;&quot;' =&gt; \&amp;color, fallback =&gt; 1;<br/>
<div class="spacer">
</div>
Finally, we need to define overloading for addition. That way we can add together two &quot;Human::EyeColor&quot; objects and get a new one with a new (genetically correct) eye color.<div class="spacer">
</div>
<br/>
  use overload '+' =&gt; \&amp;_overload_add, fallback =&gt; 1;<br/>
<br/>
  sub _overload_add {<br/>
      my ( $one, $two ) = @_;<br/>
<br/>
      my $one_bey2 = 'bey2_' . _rand2();<br/>
      my $two_bey2 = 'bey2_' . _rand2();<br/>
<br/>
      my $one_gey = 'gey_' . _rand2();<br/>
      my $two_gey = 'gey_' . _rand2();<br/>
<br/>
      return Human::EyeColor-&gt;new(<br/>
          bey2_1 =&gt; $one-&gt;$one_bey2-&gt;color(),<br/>
          bey2_2 =&gt; $two-&gt;$two_bey2-&gt;color(),<br/>
          gey_1  =&gt; $one-&gt;$one_gey-&gt;color(),<br/>
          gey_2  =&gt; $two-&gt;$two_gey-&gt;color(),<br/>
      );<br/>
  }<br/>
<br/>
  sub _rand2 {<br/>
      return 1 + int( rand(2) );<br/>
  }<br/>
<div class="spacer">
</div>
When two eye color objects are added together, the &quot;_overload_add()&quot; method will be passed two &quot;Human::EyeColor&quot; objects. These are the left and right side operands for the &quot;+&quot; operator. This method returns a new &quot;Human::EyeColor&quot; object.</div>
<div class="section">
<h1>ADDING EYE COLOR TO &quot;Human&quot;s</h1> Our original &quot;Human&quot; class requires just a few changes to incorporate our new &quot;Human::EyeColor&quot; class.<div class="spacer">
</div>
<br/>
  use List::MoreUtils qw( zip );<br/>
<br/>
  coerce 'Human::EyeColor'<br/>
      =&gt; from 'ArrayRef'<br/>
      =&gt; via { my @genes = qw( bey2_1 bey2_2 gey_1 gey_2 );<br/>
               return Human::EyeColor-&gt;new( zip( @genes, @{$_} ) ); };<br/>
<br/>
  has 'eye_color' =&gt; (<br/>
      is       =&gt; 'ro',<br/>
      isa      =&gt; 'Human::EyeColor',<br/>
      coerce   =&gt; 1,<br/>
      required =&gt; 1,<br/>
  );<br/>
<div class="spacer">
</div>
We also need to modify &quot;_overload_add()&quot; in the &quot;Human&quot; class to account for eye color:<div class="spacer">
</div>
<br/>
  return Human-&gt;new(<br/>
      sex       =&gt; $sex,<br/>
      eye_color =&gt; ( $one-&gt;eye_color() + $two-&gt;eye_color() ),<br/>
      mother    =&gt; $mother,<br/>
      father    =&gt; $father,<br/>
  );<br/>
</div>
<div class="section">
<h1>CONCLUSION</h1> The three techniques we used, overloading, subtypes, and coercion, combine to provide a powerful interface.<div class="spacer">
</div>
If you'd like to learn more about overloading, please read the documentation for the overload pragma.<div class="spacer">
</div>
To see all the code we created together, take a look at  <i>t/recipes/basics_recipe9.t</i>.</div>
<div class="section">
<h1>NEXT STEPS</h1> Had this been a real project we'd probably want:<dl>
<dt>
Better Randomization with Crypt::Random</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
Characteristic Base Class</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
Mutating Genes</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
More Characteristics</dt>
<dd>
</dd>
</dl>
<dl>
<dt>
Artificial Life</dt>
<dd>
</dd>
</dl>
</div>
<div class="section">
<h1>LICENSE</h1> This work is licensed under a Creative Commons Attribution 3.0 Unported License.<div class="spacer">
</div>
License details are at: &lt;http://creativecommons.org/licenses/by/3.0/&gt;</div>
<div class="section">
<h1>AUTHOR</h1> Moose is maintained by the Moose Cabal, along with the help of many contributors. See &quot;CABAL&quot; in Moose and &quot;CONTRIBUTORS&quot; in Moose for details.</div>
<div class="section">
<h1>COPYRIGHT AND LICENSE</h1> This software is copyright (c) 2011 by Infinity Interactive, Inc..<div class="spacer">
</div>
This is free software; you can redistribute it and/or modify it under the same terms as the Perl 5 programming language system itself.</div>
<table class="foot">
<tr>
<td class="foot-date">
2011-11-17</td>
<td class="foot-os">
perl v5.14.2</td>
</tr>
</table>
</div>
</body>
</html>

