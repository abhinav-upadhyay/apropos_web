<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/linux/style.css" type="text/css" media="all"/>
<title>
Moose::Cookbook::Meta::Recipe7(3pm)</title>
</head>
<body>
<div class="mandoc">
<table class="head">
<tbody>
<tr>
<td class="head-ltitle">
Moose::Cookbook::Meta::Recipe7(3pm)</td>
<td class="head-vol">
User Contributed Perl Documentation</td>
<td class="head-rtitle">
Moose::Cookbook::Meta::Recipe7(3pm)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1>NAME</h1> Moose::Cookbook::Meta::Recipe7 - Creating a glob reference meta-instance class</div>
<div class="section">
<h1>VERSION</h1> version 2.0401</div>
<div class="section">
<h1>SYNOPSIS</h1><br/>
  package My::Meta::Instance;<br/>
<br/>
  use Scalar::Util qw( weaken );<br/>
  use Symbol qw( gensym );<br/>
<br/>
  use Moose;<br/>
  extends 'Moose::Meta::Instance';<br/>
<br/>
  sub create_instance {<br/>
      my $self = shift;<br/>
      my $sym = gensym();<br/>
      bless $sym, $self-&gt;_class_name;<br/>
  }<br/>
<br/>
  sub clone_instance {<br/>
      my ( $self, $instance ) = @_;<br/>
<br/>
      my $new_sym = gensym();<br/>
      %{*$new_sym} = %{*$instance};<br/>
<br/>
      bless $new_sym, $self-&gt;_class_name;<br/>
  }<br/>
<br/>
  sub get_slot_value {<br/>
      my ( $self, $instance, $slot_name ) = @_;<br/>
      return *$instance-&gt;{$slot_name};<br/>
  }<br/>
<br/>
  sub set_slot_value {<br/>
      my ( $self, $instance, $slot_name, $value ) = @_;<br/>
      *$instance-&gt;{$slot_name} = $value;<br/>
  }<br/>
<br/>
  sub deinitialize_slot {<br/>
      my ( $self, $instance, $slot_name ) = @_;<br/>
      delete *$instance-&gt;{$slot_name};<br/>
  }<br/>
<br/>
  sub is_slot_initialized {<br/>
      my ( $self, $instance, $slot_name ) = @_;<br/>
      exists *$instance-&gt;{$slot_name};<br/>
  }<br/>
<br/>
  sub weaken_slot_value {<br/>
      my ( $self, $instance, $slot_name ) = @_;<br/>
      weaken *$instance-&gt;{$slot_name};<br/>
  }<br/>
<br/>
  sub inline_create_instance {<br/>
      my ( $self, $class_variable ) = @_;<br/>
      return 'do { my $sym = Symbol::gensym(); bless $sym, ' . $class_variable . ' }';<br/>
  }<br/>
<br/>
  sub inline_slot_access {<br/>
      my ( $self, $instance, $slot_name ) = @_;<br/>
      return '*{' . $instance . '}-&gt;{' . $slot_name . '}';<br/>
  }<br/>
<br/>
  package MyApp::User;<br/>
<br/>
  use metaclass 'Moose::Meta::Class' =&gt;<br/>
      ( instance_metaclass =&gt; 'My::Meta::Instance' );<br/>
<br/>
  use Moose;<br/>
<br/>
  has 'name' =&gt; (<br/>
      is  =&gt; 'rw',<br/>
      isa =&gt; 'Str',<br/>
  );<br/>
<br/>
  has 'email' =&gt; (<br/>
      is  =&gt; 'rw',<br/>
      isa =&gt; 'Str',<br/>
  );<br/>
</div>
<div class="section">
<h1>DESCRIPTION</h1> This recipe shows how to build your own meta-instance. The meta instance is the metaclass that creates object instances and helps manages access to attribute slots.<div class="spacer">
</div>
In this example, we're creating a meta-instance that is based on a glob reference rather than a hash reference. This example is largely based on the Piotr Roszatycki's MooseX::GlobRef module.<div class="spacer">
</div>
Our class is a subclass of Moose::Meta::Instance, which creates hash reference based objects. We need to override all the methods which make assumptions about the object's data structure.<div class="spacer">
</div>
The first method we override is &quot;create_instance&quot;:<div class="spacer">
</div>
<br/>
  sub create_instance {<br/>
      my $self = shift;<br/>
      my $sym = gensym();<br/>
      bless $sym, $self-&gt;_class_name;<br/>
  }<br/>
<div class="spacer">
</div>
This returns an glob reference which has been blessed into our meta-instance's associated class.<div class="spacer">
</div>
We also override &quot;clone_instance&quot; to create a new array reference:<div class="spacer">
</div>
<br/>
  sub clone_instance {<br/>
      my ( $self, $instance ) = @_;<br/>
<br/>
      my $new_sym = gensym();<br/>
      %{*$new_sym} = %{*$instance};<br/>
<br/>
      bless $new_sym, $self-&gt;_class_name;<br/>
  }<br/>
<div class="spacer">
</div>
After that, we have a series of methods which mediate access to the object's slots (attributes are stored in &quot;slots&quot;). In the default instance class, these expect the object to be a hash reference, but we need to change this to expect a glob reference instead.<div class="spacer">
</div>
<br/>
  sub get_slot_value {<br/>
      my ( $self, $instance, $slot_name ) = @_;<br/>
      *$instance-&gt;{$slot_name};<br/>
  }<br/>
<div class="spacer">
</div>
This level of indirection probably makes our instance class <i>slower</i> than the default. However, when attribute access is inlined, this lookup will be cached:<div class="spacer">
</div>
<br/>
  sub inline_slot_access {<br/>
      my ( $self, $instance, $slot_name ) = @_;<br/>
      return '*{' . $instance . '}-&gt;{' . $slot_name . '}';<br/>
  }<br/>
<div class="spacer">
</div>
The code snippet that the &quot;inline_slot_access&quot; method returns will get &quot;eval&quot;'d once per attribute.<div class="spacer">
</div>
Finally, we use this meta-instance in our &quot;MyApp::User&quot; class:<div class="spacer">
</div>
<br/>
  use metaclass 'Moose::Meta::Class' =&gt;<br/>
      ( instance_metaclass =&gt; 'My::Meta::Instance' );<br/>
<div class="spacer">
</div>
We actually don't recommend the use of metaclass in most cases. However, the other ways of using alternate metaclasses are more complex, and would complicate our example code unnecessarily.</div>
<div class="section">
<h1>CONCLUSION</h1> This recipe shows how to create your own meta-instance class. It's unlikely that you'll need to do this yourself, but it's interesting to take a peek at how Moose works under the hood.</div>
<div class="section">
<h1>SEE ALSO</h1> There are a few meta-instance class extensions on CPAN:<dl>
<dt>
&#8226;</dt>
<dd>
MooseX::Singleton<div style="height: 1.00em;">
&#160;</div>
This module extends the instance class in order to ensure that the object is a singleton. The instance it uses is still a blessed hash reference.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
MooseX::GlobRef<div style="height: 1.00em;">
&#160;</div>
This module makes the instance a blessed glob reference. This lets you use a handle as an object instance.</dd>
</dl>
</div>
<div class="section">
<h1>AUTHOR</h1> Moose is maintained by the Moose Cabal, along with the help of many contributors. See &quot;CABAL&quot; in Moose and &quot;CONTRIBUTORS&quot; in Moose for details.</div>
<div class="section">
<h1>COPYRIGHT AND LICENSE</h1> This software is copyright (c) 2011 by Infinity Interactive, Inc..<div class="spacer">
</div>
This is free software; you can redistribute it and/or modify it under the same terms as the Perl 5 programming language system itself.</div>
<table class="foot">
<tr>
<td class="foot-date">
2011-11-17</td>
<td class="foot-os">
perl v5.14.2</td>
</tr>
</table>
</div>
</body>
</html>

