<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/linux/style.css" type="text/css" media="all"/>
<title>
APPARMOR(7)</title>
</head>
<body>
<div class="mandoc">
<table class="head">
<tbody>
<tr>
<td class="head-ltitle">
APPARMOR(7)</td>
<td class="head-vol">
AppArmor</td>
<td class="head-rtitle">
APPARMOR(7)</td>
</tr>
</tbody>
</table>
<div class="section">
<h1>NAME</h1> AppArmor - kernel enhancement to confine programs to a limited set of resources.</div>
<div class="section">
<h1>DESCRIPTION</h1> AppArmor is a kernel enhancement to confine programs to a limited set of resources. AppArmor's unique security model is to bind access control attributes to programs rather than to users.<div class="spacer">
</div>
AppArmor confinement is provided via <i>profiles</i> loaded into the kernel via  <i>apparmor_parser</i>(8), typically through the <i>/etc/init.d/apparmor</i> SysV initscript (on Ubuntu, also see UBUNTU POLICY LOAD, below), which is used like this:<div class="spacer">
</div>
<br/>
        # /etc/init.d/apparmor start<br/>
        # /etc/init.d/apparmor stop<br/>
        # /etc/init.d/apparmor restart<br/>
<div class="spacer">
</div>
AppArmor can operate in two modes: <i>enforcement</i>, and <i>complain or learning</i>:<dl>
<dt>
&#8226;</dt>
<dd>
<i>enforcement</i> -  Profiles loaded in enforcement mode will result in enforcement of the policy defined in the profile as well as reporting policy violation attempts to syslogd.</dd>
</dl>
<dl>
<dt>
&#8226;</dt>
<dd>
<i>complain</i> - Profiles loaded in  &quot;complain&quot; mode will not enforce policy. Instead, it will report policy violation attempts. This mode is convenient for developing profiles. To manage complain mode for individual profiles the utilities  <i>aa-complain</i>(8) and <i>aa-enforce</i>(8) can be used. These utilities take a program name as an argument.</dd>
</dl>
<div class="spacer">
</div>
Profiles are traditionally stored in files in <i>/etc/apparmor.d/</i> under filenames with the convention of replacing the  <b>/</b> in pathnames with  <b>.</b> (except for the root <b>/</b>) so profiles are easier to manage (e.g. the  <i>/usr/sbin/nscd</i> profile would be named <i>usr.sbin.nscd</i>).<div class="spacer">
</div>
Profiles are applied to a process at <i>exec</i>(3) time (as seen through the  <i>execve</i>(2) system call); an already running process cannot be confined. However, once a profile is loaded for a program, that program will be confined on the next  <i>exec</i>(3).<div class="spacer">
</div>
AppArmor supports the Linux kernel's securityfs filesystem, and makes available the list of the profiles currently loaded; to mount the filesystem:<div class="spacer">
</div>
<br/>
        # mount -tsecurityfs securityfs /sys/kernel/security<br/>
        $ cat /sys/kernel/security/apparmor/profiles<br/>
        /usr/bin/mutt<br/>
        /usr/bin/gpg<br/>
           ...<br/>
<div class="spacer">
</div>
Normally, the initscript will mount securityfs if it has not already been done.<div class="spacer">
</div>
AppArmor also restricts what privileged operations a confined process may execute, even if the process is running as root. A confined process cannot call the following system calls:<div class="spacer">
</div>
<br/>
        create_module(2) delete_module(2) init_module(2) ioperm(2)<br/>
        iopl(2) mount(2) umount(2) ptrace(2) reboot(2) setdomainname(2)<br/>
        sethostname(2) swapoff(2) swapon(2) sysctl(2)<br/>
<div class="spacer">
</div>
A confined process can not call <i>mknod</i>(2) to create character or block devices.</div>
<div class="section">
<h1>UBUNTU POLICY LOAD</h1> Ubuntu systems use Upstart instead of a traditional SysV init system. Because Upstart is an event-driven init system and understanding that policy must be loaded before execution, Ubuntu loads policy in two stages: first via upstart jobs for binaries that are started in early boot, and then via a SysV initscript that starts in S37 for all remaining policy. When developing policy it is important to know how your application is started and if policy load should be handled specially.<div class="spacer">
</div>
In general, nothing extra has to be done for applications without an initscript or with an initscript that starts after AppArmor's second stage initscript.<div class="spacer">
</div>
If the confined application has an Upstart job, adjust the job to call  <i>/lib/init/apparmor-profile-load</i> with the filename of the policy file (relative to  <i>/etc/apparmor.d/</i>). For example:<div class="spacer">
</div>
<br/>
        pre-start script<br/>
                /lib/init/apparmor-profile-load usr.bin.foo<br/>
        end script<br/>
<div class="spacer">
</div>
If the confined application does not have an Upstart job but it starts before AppArmor's second stage initscript, then add a symlink from the policy file in  <i>/etc/apparmor.d</i> to <i>/etc/apparmor/init/network-interface-security/</i>. For example:<div class="spacer">
</div>
<br/>
        # cd /etc/apparmor/init/network-interface-security/<br/>
        # ln -s /etc/apparmor.d/usr.bin.foo .<br/>
<div class="spacer">
</div>
The network-interface-security Upstart job will load all the symlinked policy files in  <i>/etc/apparmor/init/network-interface-security/</i> before any network interfaces come up. Because network interfaces come up very early in the boot process, this will help ensure that AppArmor policy is loaded before the confined application starts.</div>
<div class="section">
<h1>ERRORS</h1> When a confined process tries to access a file it does not have permission to access, the kernel will report a message through audit, similar to:<div class="spacer">
</div>
<br/>
        audit(1148420912.879:96): REJECTING x access to /bin/uname<br/>
          (sh(6646) profile /tmp/sh active /tmp/sh)<br/>
<br/>
        audit(1148420912.879:97): REJECTING r access to /bin/uname<br/>
          (sh(6646) profile /tmp/sh active /tmp/sh)<br/>
<br/>
        audit(1148420944.837:98): REJECTING access to capability<br/>
          'dac_override' (sh(6641) profile /tmp/sh active /tmp/sh)<br/>
<div class="spacer">
</div>
The permissions requested by the process are immediately after REJECTING. The &quot;name&quot; and process id of the running program are reported, as well as the profile name and any &quot;hat&quot; that may be active. (&quot;Name&quot; is in quotes, because the process name is limited to 15 bytes; it is the same as reported through the Berkeley process accounting.) If no hat is active (see  <i>aa_change_hat</i>(2)) then the profile name is printed for &quot;active&quot;.<div class="spacer">
</div>
For confined processes running under a profile that has been loaded in complain mode, enforcement will not take place and the log messages reported to audit will be of the form:<div class="spacer">
</div>
<br/>
        audit(1146868287.904:237): PERMITTING r access to<br/>
          /etc/apparmor.d/tunables (du(3811) profile /usr/bin/du active<br/>
          /usr/bin/du)<br/>
<br/>
        audit(1146868287.904:238): PERMITTING r access to /etc/apparmor.d<br/>
          (du(3811) profile /usr/bin/du active /usr/bin/du)<br/>
<div class="spacer">
</div>
If the userland auditd is not running, the kernel will send audit events to klogd; klogd will send the messages to syslog, which will log the messages with the KERN facility. Thus, REJECTING and PERMITTING messages may go to either  <i>/var/log/audit/audit.log</i> or <i>/var/log/messages</i>, depending upon local configuration.</div>
<div class="section">
<h1>FILES</h1><dl>
<dt>
<i>/etc/init.d/apparmor</i></dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<i>/etc/apparmor/init/network-interface-security/</i></dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<i>/etc/apparmor.d/</i></dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<i>/var/lib/apparmor/</i></dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<i>/var/log/audit/audit.log</i></dt>
<dd>
</dd>
</dl>
<dl>
<dt>
<i>/var/log/messages</i></dt>
<dd>
</dd>
</dl>
</div>
<div class="section">
<h1>SEE ALSO</h1>  <i>apparmor_parser</i>(8), <i>aa_change_hat</i>(2), <i>apparmor.d</i>(5),  <i>subdomain.conf</i>(5), <i>aa-autodep</i>(1), <i>clean</i>(1),  <i>auditd</i>(8),  <i>aa-unconfined</i>(8), <i>aa-enforce</i>(1), <i>aa-complain</i>(1), and &lt;http://wiki.apparmor.net&gt;.</div>
<table class="foot">
<tr>
<td class="foot-date">
2014-08-11</td>
<td class="foot-os">
AppArmor 2.7.102</td>
</tr>
</table>
</div>
</body>
</html>

