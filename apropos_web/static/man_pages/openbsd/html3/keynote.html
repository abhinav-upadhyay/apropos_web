<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
KN_INIT(3)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">kn_init</b>, <b class="name">kn_add_assertion</b>, <b class="name">kn_remove_assertion</b>, <b class="name">kn_add_action</b>, <b class="name">kn_remove_action</b>, <b class="name">kn_add_authorizer</b>, <b class="name">kn_remove_authorizer</b>, <b class="name">kn_do_query</b>, <b class="name">kn_get_failed</b>, <b class="name">kn_cleanup_action_environment</b>, <b class="name">kn_close</b>, <b class="name">kn_query</b>, <b class="name">kn_read_asserts</b>, <b class="name">kn_keycompare</b>, <b class="name">kn_get_authorizer</b>, <b class="name">kn_get_licensees</b>, <b class="name">kn_encode_base64</b>, <b class="name">kn_decode_base64</b>, <b class="name">kn_encode_hex</b>, <b class="name">kn_decode_hex</b>, <b class="name">kn_encode_key</b>, <b class="name">kn_decode_key</b>, <b class="name">kn_sign_assertion</b>, <b class="name">kn_verify_assertion</b>, <b class="name">kn_free_key</b>, <b class="name">kn_get_string</b> &#8212; <span class="desc">a trust-management system library</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/types.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">regex.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">keynote.h</a>&gt;</b><div class="spacer">
</div>
<pre style="margin-left: 0.00ex;" class="lit display">
struct environment { 
	char               *env_name; 
	char               *env_value; 
	int                 env_flags; 
	regex_t             env_regex; 
	struct environment *env_next; 
}; 
 
struct keynote_deckey { 
	int   dec_algorithm; 
	void *dec_key; 
}; 
 
struct keynote_binary { 
	int   bn_len; 
	char *bn_key; 
}; 
 
struct keynote_keylist { 
	int                     key_alg; 
	void                   *key_key; 
	char                   *key_stringkey; 
	struct keynote_keylist *key_next; 
};</pre>
<br/>
<span class="type">extern int keynote_errno;</span><div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_init</b>(<i class="farg" style="white-space:nowrap;">void</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_add_assertion</b>(<i class="farg" style="white-space:nowrap;">int sessid</i>, <i class="farg" style="white-space:nowrap;">char *assertion</i>, <i class="farg" style="white-space:nowrap;">int len</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_remove_assertion</b>(<i class="farg" style="white-space:nowrap;">int sessid</i>, <i class="farg" style="white-space:nowrap;">int assertid</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_add_action</b>(<i class="farg" style="white-space:nowrap;">int sessid</i>, <i class="farg" style="white-space:nowrap;">char *name</i>, <i class="farg" style="white-space:nowrap;">char *value</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_remove_action</b>(<i class="farg" style="white-space:nowrap;">int sessid</i>, <i class="farg" style="white-space:nowrap;">char *name</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_add_authorizer</b>(<i class="farg" style="white-space:nowrap;">int sessid</i>, <i class="farg" style="white-space:nowrap;">char *principal</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_remove_authorizer</b>(<i class="farg" style="white-space:nowrap;">int sessid</i>, <i class="farg" style="white-space:nowrap;">char *principal</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_do_query</b>(<i class="farg" style="white-space:nowrap;">int sessid</i>, <i class="farg" style="white-space:nowrap;">char **returnvalues</i>, <i class="farg" style="white-space:nowrap;">int numvalues</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_get_failed</b>(<i class="farg" style="white-space:nowrap;">int sessid</i>, <i class="farg" style="white-space:nowrap;">int type</i>, <i class="farg" style="white-space:nowrap;">int seq</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_cleanup_action_environment</b>(<i class="farg" style="white-space:nowrap;">int sessid</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_close</b>(<i class="farg" style="white-space:nowrap;">int sessid</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_query</b>(<i class="farg">struct environment *env</i>, <i class="farg">char **returnvalues</i>, <i class="farg">int numvalues</i>, <i class="farg">char **trusted</i>, <i class="farg">int *trustedlen</i>, <i class="farg">int numtrusted</i>, <i class="farg">char **untrusted</i>, <i class="farg">int *untrustedlen</i>, <i class="farg">int numuntrusted</i>, <i class="farg">char **authorizers</i>, <i class="farg">int numauthorizers</i>);<div class="spacer">
</div>
<i class="ftype">char **</i><br/>
<b class="fname">kn_read_asserts</b>(<i class="farg" style="white-space:nowrap;">char *array</i>, <i class="farg" style="white-space:nowrap;">int arraylen</i>, <i class="farg" style="white-space:nowrap;">int *numassertions</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_keycompare</b>(<i class="farg" style="white-space:nowrap;">void *key1</i>, <i class="farg" style="white-space:nowrap;">void *key2</i>, <i class="farg" style="white-space:nowrap;">int algorithm</i>);<div class="spacer">
</div>
<i class="ftype">void *</i><br/>
<b class="fname">kn_get_authorizer</b>(<i class="farg" style="white-space:nowrap;">int sessid</i>, <i class="farg" style="white-space:nowrap;">int assertid</i>, <i class="farg" style="white-space:nowrap;">int *algorithm</i>);<div class="spacer">
</div>
<i class="ftype">struct keynote_keylist *</i><br/>
<b class="fname">kn_get_licensees</b>(<i class="farg" style="white-space:nowrap;">int sessid</i>, <i class="farg" style="white-space:nowrap;">int assertid</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_encode_base64</b>(<i class="farg" style="white-space:nowrap;">unsigned char const *src</i>, <i class="farg" style="white-space:nowrap;">unsigned int srclen</i>, <i class="farg" style="white-space:nowrap;">char *dst</i>, <i class="farg" style="white-space:nowrap;">unsigned int dstlen</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_decode_base64</b>(<i class="farg" style="white-space:nowrap;">char const *src</i>, <i class="farg" style="white-space:nowrap;">unsigned char *dst</i>, <i class="farg" style="white-space:nowrap;">unsigned int dstlen</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_encode_hex</b>(<i class="farg" style="white-space:nowrap;">unsigned char *src</i>, <i class="farg" style="white-space:nowrap;">char **dst</i>, <i class="farg" style="white-space:nowrap;">int srclen</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_decode_hex</b>(<i class="farg" style="white-space:nowrap;">char *src</i>, <i class="farg" style="white-space:nowrap;">char **dst</i>);<div class="spacer">
</div>
<i class="ftype">char *</i><br/>
<b class="fname">kn_encode_key</b>(<i class="farg" style="white-space:nowrap;">struct keynote_deckey *dc</i>, <i class="farg" style="white-space:nowrap;">int iencoding</i>, <i class="farg" style="white-space:nowrap;">int encoding</i>, <i class="farg" style="white-space:nowrap;">int keytype</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_decode_key</b>(<i class="farg" style="white-space:nowrap;">struct keynote_deckey *dc</i>, <i class="farg" style="white-space:nowrap;">char *key</i>, <i class="farg" style="white-space:nowrap;">int keytype</i>);<div class="spacer">
</div>
<i class="ftype">char *</i><br/>
<b class="fname">kn_sign_assertion</b>(<i class="farg" style="white-space:nowrap;">char *assertion</i>, <i class="farg" style="white-space:nowrap;">int len</i>, <i class="farg" style="white-space:nowrap;">char *key</i>, <i class="farg" style="white-space:nowrap;">char *algorithm</i>, <i class="farg" style="white-space:nowrap;">int vflag</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">kn_verify_assertion</b>(<i class="farg" style="white-space:nowrap;">char *assertion</i>, <i class="farg" style="white-space:nowrap;">int len</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">kn_free_key</b>(<i class="farg" style="white-space:nowrap;">struct keynote_deckey *</i>);<div class="spacer">
</div>
<i class="ftype">char *</i><br/>
<b class="fname">kn_get_string</b>(<i class="farg" style="white-space:nowrap;">char *</i>);<div class="spacer">
</div>
<b class="macro">Link options: -lkeynote -lm -lcrypto</b></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> For more details on <b class="name">keynote</b>, see RFC 2704.<div class="spacer">
</div>
<b class="var">keynote_errno</b> contains an error code if some library call failed. Failed calls return -1 (if their return value is integer), or <span class="define">NULL</span> (if their return value is a pointer) and set <b class="var">keynote_errno</b>. The defined error codes are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">ERROR_MEMORY</code></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
Some memory allocation or usage error was encountered.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">ERROR_SYNTAX</code></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
Some syntactic or logical error was encountered.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<code class="lit">ERROR_NOTFOUND</code></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
One of the arguments referred to a nonexistent structure or entry.</dd>
</dl>
<div class="spacer">
</div>
If no errors were encountered, <b class="var">keynote_errno</b> will be set to 0. This variable should be reset to 0 if an error was encountered, prior to calling other library routines.<div class="spacer">
</div>
The main interface to <b class="name">kn_init</b> is centered around the concept of a session. A session describes a collection of policies, assertions, action authorizers, return values, and action attributes that the <b class="name">kn_init</b> system uses to evaluate a query. Information is not shared between sessions. Policies, credentials, action authorizers, and action attributes can be added or deleted at any point during the lifetime of a session. Furthermore, an application can discover which assertions failed to be evaluated, and in what way, during a query.<div class="spacer">
</div>
For those applications that only need to do a simple query, there exists a single call that takes as arguments all the necessary information and performs all the necessary steps. This is essentially a wrapper that calls the session API functions as necessary.<div class="spacer">
</div>
Finally, there exist functions for doing ASCII to hexadecimal and Base64 encoding (and vice versa), for encoding/decoding keys between ASCII and binary formats, and for signing and verifying assertions.<div class="spacer">
</div>
The description of all <b class="name">kn_init</b> library functions follows.<div class="spacer">
</div>
<b class="fname">kn_init</b>() creates a new <b class="name">kn_init</b> session, and performs any necessary initializations. On success, this function returns the new session ID, which is used by all subsequent calls with a <i class="farg">sessid</i> argument. On failure, it returns -1 and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_MEMORY</span>.<div class="spacer">
</div>
<b class="fname">kn_add_assertion</b>() adds the assertion pointed to by the array <i class="farg">assertion</i>, of length <i class="farg">len</i> in the session identified by <i class="farg">sessid</i>. The first argument can be discarded after the call to this function. The following flags are defined:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
ASSERT_FLAG_LOCAL</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Mark this assertion as ultimately trusted. Trusted assertions need not be signed, and the <i class="farg">Authorizer</i> and <i class="farg">Licensees</i> fields can have non-key entries.</dd>
</dl>
<div class="spacer">
</div>
At least one (trusted) assertion should have <span class="define">POLICY</span> as the <i class="farg">Authorizer</i>. On success, this function will return an assertion ID which can be used to remove the assertion from the session, by using <a class="link-man" href="../html3/kn_remove_assertion.html">kn_remove_assertion(3)</a>. On failure, -1 is returned, and <b class="var">keynote_errno</b> is set to <span class="errno">ERROR_NOTFOUND</span> if the session was not found, <span class="errno">ERROR_SYNTAX</span> if the assertion was syntactically incorrect, or <span class="errno">ERROR_MEMORY</span> if necessary memory could not be allocated.<div class="spacer">
</div>
<b class="fname">kn_remove_assertion</b>() removes the assertion identified by <i class="farg">assertid</i> from the session identified by <i class="farg">sessid</i>. On success, this function returns 0. On failure, it returns -1 and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_NOTFOUND</span>.<div class="spacer">
</div>
<b class="fname">kn_add_action</b>() inserts the variable <i class="farg">name</i> in the action environment of session <i class="farg">sessid</i>, with the value <i class="farg">value</i>. The same attribute may be added more than once, but only the last instance will be used (memory resources are consumed however).<div class="spacer">
</div>
The <i class="farg">flags</i> specified are formed by or'ing the following values:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
ENVIRONMENT_FLAG_FUNC</dt>
<dd class="list-tag" style="margin-left: 22.00ex;">
In this case, <i class="farg">value</i> is a pointer to a function that takes as argument a string and returns a string. This is used to implement callbacks for getting action attribute values. The argument passed to such a callback function is a string identifying the action attribute whose value is requested, and should return a pointer to string containing that value (this pointer will not be freed by the library), the empty string if the value was not found, or a <span class="define">NULL</span> to indicate an error (and may set <b class="var">keynote_errno</b> appropriately). Prior to first use (currently, at the time the attribute is added to the session environment), such functions are called with <span class="define">KEYNOTE_CALLBACK_INITIALIZE</span> as the argument (defined in keynote.h) so that they can perform any special initializations. Furthermore, when the session is deleted, all such functions will be called with <span class="define">KEYNOTE_CALLBACK_CLEANUP</span> to perform any special cleanup (such as free any allocated memory). A function may be called with either of these arguments more than once, if it has been defined as the callback function for more than one attribute.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
ENVIRONMENT_FLAG_REGEX</dt>
<dd class="list-tag" style="margin-left: 22.00ex;">
In this case, <i class="farg">name</i> is a regular expression that may match more than one attribute. In case of conflict between a regular expression and a &#8220;simple&#8221; attribute, the latter will be given priority. In case of conflict between two regular expression attributes, the one added later will be given priority. A callback function should never change the current <b class="name">kn_init</b> session, start/invoke/operate on another session, or call one of the session-API functions.</dd>
</dl>
<div class="spacer">
</div>
The combination of the two flags may be used to specify callback functions that handle large sets of attributes (even to the extent of having one callback function handling all attribute references). This is particularly useful when the action attribute set is particularly large.<div class="spacer">
</div>
On success, <a class="link-man" href="../html3/kn_add_action.html">kn_add_action(3)</a> returns 0. On failure, it returns -1 and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_NOTFOUND</span> if the session was not found, <span class="errno">ERROR_SYNTAX</span> if the <i class="farg">name</i> was invalid (e.g., started with an underscore character) or was <span class="define">NULL</span>, or <span class="errno">ERROR_MEMORY</span> if necessary memory could not be allocated.<div class="spacer">
</div>
<b class="fname">kn_remove_action</b>() removes action attribute <i class="farg">name</i> from the environment of session <i class="farg">sessid</i>. Notice that if more than one instances of <i class="farg">name</i> exist, only the one added last will be deleted. On success, this function returns 0. On failure, it returns -1 and <b class="var">keynote_errno</b> is set to <span class="errno">ERROR_NOTFOUND</span> if the session or the attribute were not found, or <span class="errno">ERROR_SYNTAX</span> if the name was invalid. If the attribute value was a callback, that function will be called with the define <span class="define">KEYNOTE_CALLBACK_CLEANUP</span> as the argument.<div class="spacer">
</div>
<b class="fname">kn_add_authorizer</b>() adds the principal pointed to by <i class="farg">principal</i> to the action authorizers list of session <i class="farg">sessid</i>. The principal is typically an ASCII-encoded key. On success, this function will return 0. On failure, it returns -1 and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_NOTFOUND</span> if the session was not found, <span class="errno">ERROR_SYNTAX</span> if the encoding was invalid, or <span class="errno">ERROR_MEMORY</span> if necessary memory could not be allocated.<div class="spacer">
</div>
<b class="fname">kn_remove_authorizer</b>() removes <i class="farg">principal</i> from the action authorizer list of session <i class="farg">sessid</i>. On success, this function returns 0. On failure, it returns -1 and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_NOTFOUND</span> if the session was not found.<div class="spacer">
</div>
<b class="fname">kn_do_query</b>() evaluates the request based on the assertions, action attributes, and action authorizers added to session <i class="farg">sessid</i>. <i class="farg">returnvalues</i> is an ordered array of strings that contain the return values. The lowest-ordered return value is contained in <i class="farg">returnvalues[0]</i>, and the highest-ordered value is <i class="farg">returnvalues[numvalues - 1]</i>. If <i class="farg">returnvalues</i> is <span class="define">NULL</span>, the <i class="farg">returnvalues</i> from the previous call to <a class="link-man" href="../html3/kn_do_query.html">kn_do_query(3)</a> will be used. The programmer SHOULD NOT free <i class="farg">returnvalues</i> after the call to <a class="link-man" href="../html3/kn_do_query.html">kn_do_query(3)</a> if this feature is used, as the array is not replicated internally. On success, this function returns an index into the <i class="farg">returnvalues</i> array. On failure, it returns -1 and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_NOTFOUND</span> if the session was not found or the authorizers list was empty, <span class="errno">ERROR_SYNTAX</span> if no <i class="farg">returnvalues</i> have been specified, or <span class="errno">ERROR_MEMORY</span> if necessary memory could not be allocated.<div class="spacer">
</div>
<b class="fname">kn_get_failed</b>() returns the assertion ID of the <i class="farg">num'th</i> assertion (starting from zero) in session <i class="farg">sessid</i> that was somehow invalid during evaluation. This function is typically called after <a class="link-man" href="../html3/kn_do_query.html">kn_do_query(3)</a> is used to evaluate a request. <i class="farg">type</i> specifies the type of failure the application is interested in. It can be set to:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
KEYNOTE_ERROR_ANY</dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
to indicate interest in any error.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
KEYNOTE_ERROR_SYNTAX</dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
for syntactic or semantic errors.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
KEYNOTE_ERROR_MEMORY</dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
for memory-related problems.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
KEYNOTE_ERROR_SIGNATURE</dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
if the assertion could not be cryptographically verified.</dd>
</dl>
<div class="spacer">
</div>
These values are defined in keynote.h. An application can then delete the offending assertion using <a class="link-man" href="../html3/kn_remove_assertion.html">kn_remove_assertion(3)</a>. For example, to remove all assertion whose signature failed, an application could do something like:<div class="spacer">
</div>
<pre style="margin-left: 0.00ex;" class="lit display">
  while ((assertid = kn_get_failed(sessid, KEYNOTE_ERROR_SIGNATURE, 0) 
         != -1) 
    kn_remove_assertion(sessid, assertid);</pre>
<div class="spacer">
</div>
On success, <a class="link-man" href="../html3/kn_get_failed.html">kn_get_failed(3)</a> returns an assertion ID. On failure, or when no assertion matching the given criteria is found, it returns -1 and set <b class="var">keynote_errno</b> to <span class="errno">ERROR_NOTFOUND</span>.<div class="spacer">
</div>
<b class="fname">kn_cleanup_action_environment</b>() removes all action attributes from the action environment of session <i class="farg">sessid</i>. It returns 0 on success.<div class="spacer">
</div>
<b class="fname">kn_close</b>() closes session <i class="farg">sessid</i> and frees all related resources, deleting action attributes, action authorizers, and assertions. On success, this function returns 0. On failure, it returns -1 and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_NOTFOUND</span> if the session was not found.<div class="spacer">
</div>
<b class="fname">kn_read_asserts</b>() parses the string <i class="farg">array</i> of length <i class="farg">arraylen</i> and returns an array of pointers to strings containing copies of the assertions found in <i class="farg">array</i>. Both the array of pointers and the strings are allocated by <b class="fname">kn_read_asserts</b>() dynamically, and thus should be freed by the programmer when they are no longer needed. <i class="farg">numassertions</i> contains the number of assertions (and thus strings in the returned array) found in <i class="farg">array</i>. On failure, this function returns <span class="define">NULL</span> and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_MEMORY</span> if necessary memory could not be allocated, or <span class="errno">ERROR_SYNTAX</span> if <i class="farg">array</i> was <span class="define">NULL</span>. Note that if there were no assertions found in <i class="farg">array</i>, a valid pointer will be returned, but <i class="farg">numassertions</i> will contain the value zero on return. The returned pointer should be freed by the programmer.<div class="spacer">
</div>
<b class="fname">kn_keycompare</b>() compares <i class="farg">key1</i> and <i class="farg">key2</i> (which must be of the same <i class="farg">algorithm</i>) and returns 1 if equal and 0 otherwise.<div class="spacer">
</div>
<b class="fname">kn_get_authorizer</b>() returns the authorizer key (in binary format) for assertion <i class="farg">assertid</i> in session <i class="farg">sessid</i>. It also sets the <i class="farg">algorithm</i> argument to the algorithm of the authorizer key. On failure, <b class="fname">kn_get_authorizer</b>() returns <span class="define">NULL</span>, and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_NOTFOUND</span>.<div class="spacer">
</div>
<b class="fname">kn_get_licensees</b>() returns the licensee key(s) for assertion <i class="farg">assertid</i> in session <i class="farg">sessid</i>. The keys are returned in a linked list of <i class="farg">struct keynote_keylist</i> structures. On failure, <b class="fname">kn_get_licensees</b>() returns <span class="define">NULL</span>. and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_NOTFOUND</span>.<div class="spacer">
</div>
<b class="fname">kn_query</b>() takes as arguments a list of action attributes in <i class="farg">env</i>, a list of return values in <i class="farg">returnvalues</i> (the number of returnvalues is indicated by <i class="farg">numvalues</i>), a number (<i class="farg">numtrusted</i>) of locally-trusted assertions in <i class="farg">trusted</i> (the length of each assertion is given by the respective element of <i class="farg">trustedlen</i>), a number (<i class="farg">numuntrusted</i>) of assertions that need to be cryptographically verified in <i class="farg">untrusted</i> (the length of each assertion is given by the respective element of <i class="farg">untrustedlen</i>), and a number (<i class="farg">numauthorizers</i>) of action authorizers in <i class="farg">authorizers</i>. <i class="farg">env</i> is a linked list of <i class="farg">struct environment</i> structures. The <i class="farg">env_name</i>, <i class="farg">env_value</i>, and <i class="farg">env_flags</i> fields correspond to the <i class="farg">name</i>, <i class="farg">value</i>, and <i class="farg">flags</i> arguments to <a class="link-man" href="../html3/kn_add_assertion.html">kn_add_assertion(3)</a> respectively. <i class="farg">env_regex</i> is not used. On success, this function returns an index in <i class="farg">returnvalues</i> indicating the returned value to the query. On failure, it returns -1 and sets <b class="var">keynote_errno</b> to the same values as <a class="link-man" href="../html3/kn_do_query.html">kn_do_query(3)</a>, or to <span class="errno">ERROR_MEMORY</span> if a trusted or untrusted assertion could not be added to the session due to lack of memory resources. Syntax errors in assertions will not be reported by <b class="fname">kn_query</b>().<div class="spacer">
</div>
<b class="fname">kn_encode_base64</b>() converts the data of length <i class="farg">srclen</i> contained in <i class="farg">src</i> in Base64 encoding and stores them in <i class="farg">dst</i> which is of length <i class="farg">dstlen</i>. The actual length of the encoding stored in <i class="farg">dst</i> is returned. <i class="farg">dst</i> should be long enough to also contain the trailing string terminator. If <i class="farg">dst</i> is not long enough to contain the encoded data, this function returns -1 and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_SYNTAX</span>.<div class="spacer">
</div>
<b class="fname">kn_decode_base64</b>() decodes the Base64-encoded data stored in <i class="farg">src</i> and stores the result in <i class="farg">dst</i>, which is of length <i class="farg">dstlen</i>. The actual length of the decoded data is returned on success. On failure, this function returns -1 and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_SYNTAX</span>, denoting either an invalid Base64 encoding or insufficient space in <i class="farg">dst</i>.<div class="spacer">
</div>
<b class="fname">kn_encode_hex</b>() encodes in ASCII-hexadecimal format the data of length <i class="farg">srclen</i> contained in <i class="farg">src</i>. This function allocates a chunk of memory to store the result, which is returned in <i class="farg">dst</i>. Thus, this function should be used as follows:<div class="spacer">
</div>
<pre style="margin-left: 0.00ex;" class="lit display">
  char *dst; 
 
  kn_encode_hex(src, &amp;dst, srclen);</pre>
<div class="spacer">
</div>
The length of the allocated buffer will be (2 * srclen + 1). On success, this function returns 0. On failure, it returns -1 and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_MEMORY</span> if it failed to allocate enough memory, <span class="errno">ERROR_SYNTAX</span> if <i class="farg">dst</i> was <span class="define">NULL</span>.<div class="spacer">
</div>
<b class="fname">kn_decode_hex</b>() decodes the ASCII hex-encoded string in <i class="farg">src</i> and stores the result in a memory chunk allocated by the function. A pointer to that memory is stored in <i class="farg">dst</i>. The length of the allocated memory will be (strlen(src) / 2). On success, this function returns 0. On failure, it returns -1 and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_MEMORY</span> if it could not allocate enough memory, or <span class="errno">ERROR_SYNTAX</span> if <i class="farg">dst</i> was <span class="define">NULL</span>, or the length of <i class="farg">src</i> is not even.<div class="spacer">
</div>
<b class="fname">kn_encode_key</b>() ASCII-encodes a cryptographic key. The binary representation of the key is contained in <i class="farg">dc</i>. The field <i class="farg">dec_key</i> in that structure is a pointer to some cryptographic algorithm dependent information describing the key. In this implementation, this pointer should be a <i class="farg">DSA *</i> or <i class="farg">RSA *</i> for DSA or RSA keys respectively, as used in the SSL library, or a <i class="farg">keynote_binary *</i> for cryptographic keys whose algorithm <b class="name">kn_init</b> does not know about but the application wishes to include in the action authorizers (and thus need to be canonicalized). The field <i class="farg">dec_algorithm</i> describes the cryptographic algorithm, and may be one of <span class="define">KEYNOTE_ALGORITHM_DSA</span>, <span class="define">KEYNOTE_ALGORITHM_RSA</span>, or <span class="define">KEYNOTE_ALGORITHM_BINARY</span> in this implementation.<div class="spacer">
</div>
<i class="farg">iencoding</i> describes how the key should be binary-encoded. This implementation supports <span class="define">INTERNAL_ENC_PKCS1</span> for RSA keys, <span class="define">INTERNAL_ENC_ASN1</span> for DSA keys, and <span class="define">INTERNAL_ENC_NONE</span> for BINARY keys. <i class="farg">encoding</i> describes what ASCII encoding should be applied to the key. Valid values are <span class="define">ENCODING_HEX</span> and <span class="define">ENCODING_BASE64</span>, for hexadecimal and Base64 encoding respectively. <i class="farg">keytype</i> is one of <span class="define">KEYNOTE_PUBLIC_KEY</span> or <span class="define">KEYNOTE_PRIVATE_KEY</span> to indicate whether the key is public or private. Private keys have the string <span class="define">KEYNOTE_PRIVATE_KEY_PREFIX</span> (defined in keynote.h) prefixed to the algorithm name. On success, this function returns a string containing the encoded key. On failure, it returns <span class="define">NULL</span> and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_NOTFOUND</span> if the <i class="farg">dc</i> argument was invalid, <span class="errno">ERROR_MEMORY</span> if it failed to allocate the necessary memory, or <span class="errno">ERROR_SYNTAX</span> if the key to be converted was invalid.<div class="spacer">
</div>
<b class="fname">kn_decode_key</b>() decodes the ASCII-encoded string contained in <i class="farg">key</i>. The result is placed in <i class="farg">dc</i>, with <i class="farg">dec_algorithm</i> describing the algorithm (see <a class="link-man" href="../html3/kn_encode_key.html">kn_encode_key(3)</a>), and <i class="farg">dec_key</i> pointing to an algorithm-dependent structure. In this implementation, this is an SSLeay/OpenSSL-defined <i class="farg">DSA *</i> for DSA keys, <i class="farg">RSA *</i> for RSA and X.509-based keys, and a <i class="farg">keynote_binary *</i> for BINARY keys. <i class="farg">keytype</i> takes the values <span class="define">KEYNOTE_PUBLIC_KEY</span> or <span class="define">KEYNOTE_PRIVATE_KEY</span> to specify a public or private key, where applicable. On success, this function returns 0. On failure, it returns -1 and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_MEMORY</span> if necessary memory could not be allocated, or <span class="errno">ERROR_SYNTAX</span> if the key or the ASCII encoding was malformed.<div class="spacer">
</div>
<b class="fname">kn_sign_assertion</b>() produces the cryptographic signature for the assertion of length <i class="farg">len</i> stored in <i class="farg">assertion</i>, using the ASCII-encoded cryptographic key contained in <i class="farg">key</i>. The type of signature to be produced is described by the string <i class="farg">algorithm</i>. Possible values for this string are <span class="define">SIG_RSA_SHA1_PKCS1_HEX</span>, <span class="define">SIG_RSA_SHA1_PKCS1_BASE64</span>, <span class="define">SIG_RSA_MD5_HEX</span> and <span class="define">SIG_RSA_MD5_HEX</span> for RSA keys, <span class="define">SIG_DSA_SHA1_HEX</span> and <span class="define">SIG_DSA_SHA1_BASE64</span> for DSA keys, <span class="define">SIG_X509_SHA1_HEX</span> and <span class="define">SIG_X509_SHA1_BASE64</span> for X.509-based keys. No other cryptographic signatures are currently supported by this implementation. If <i class="farg">vflag</i> is set to 1, then the generated signature will also be verified. On success, this function returns a string containing the ASCII-encoded signature, without modifying the <i class="farg">assertion</i>. On failure, it returns <span class="define">NULL</span> and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_NOTFOUND</span> if one of the arguments was <span class="define">NULL</span>, <span class="errno">ERROR_MEMORY</span> if necessary memory could not be allocated, or <span class="errno">ERROR_SYNTAX</span> if the <i class="farg">algorithm</i>, the <i class="farg">key</i>, or the <i class="farg">assertion</i> (if signature verification was requested) was invalid.<div class="spacer">
</div>
<b class="fname">kn_verify_assertion</b>() verifies the cryptographic signature on the assertion of length <i class="farg">len</i> contained in string <i class="farg">assertion</i>. On success, this function returns <span class="define">SIGRESULT_TRUE</span> if the signature could be verified, or <span class="define">SIGRESULT_FALSE</span> otherwise. On failure, this function returns -1 and sets <b class="var">keynote_errno</b> to <span class="errno">ERROR_MEMORY</span> if necessary memory could not be allocated, or <span class="errno">ERROR_SYNTAX</span> if the assertion contained a syntactic error, or the cryptographic algorithm was not supported.<div class="spacer">
</div>
<b class="fname">kn_free_key</b>() frees a cryptographic key.<div class="spacer">
</div>
<b class="fname">kn_get_string</b>() parses the argument, treating it as a <a class="link-man" href="../html4/keynote.html">keynote(4)</a> (quoted) string. This is useful for parsing key files. On success, this function returns a pointer to the parsing result. The result is dynamically allocated and should be freed after use. On failure, <span class="define">NULL</span> is returned.</div>
<div class="section">
<h1 id="x46494c4553">FILES</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="file">keynote.h</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="file">libkeynote.a</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
</dd>
</dl>
</div>
<div class="section">
<h1 id="x444941474e4f5354494353">DIAGNOSTICS</h1> The return values of all the functions have been given along with the function description above.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html1/keynote.html">keynote(1)</a>, <a class="link-man" href="../html4/keynote.html">keynote(4)</a>, <a class="link-man" href="../html5/keynote.html">keynote(5)</a><div class="spacer">
</div>
<span class="ref"><span class="ref-auth">M. Blaze</span>, <span class="ref-auth">J. Feigenbaum</span>, and <span class="ref-auth">J. Lacy</span>, <span class="ref-title">Decentralized Trust Management</span>, <i class="ref-jrnl">IEEE Symposium on Security and Privacy</i>, <span class="ref-date">1996</span>.</span><div class="spacer">
</div>
<span class="ref"><span class="ref-auth">M. Blaze</span>, <span class="ref-auth">J. Feigenbaum</span>, and <span class="ref-auth">M. Strauss</span>, <span class="ref-title">Compliance-Checking in the PolicyMaker Trust Management System</span>, <i class="ref-jrnl">Financial Crypto Conference</i>, <span class="ref-date">1998</span>.</span></div>
<div class="section">
<h1 id="x5354414e4441524453">STANDARDS</h1> <span class="ref"><span class="ref-auth">M. Blaze</span>, <span class="ref-auth">J. Feigenbaum</span>, <span class="ref-auth">J. Ioannidis</span>, and <span class="ref-auth">A. Keromytis</span>, <span class="ref-title">The KeyNote Trust-Management System Version 2</span>, <span class="ref-rep">RFC 2704</span>, <span class="ref-date">September 1999</span>.</span></div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> <span class="author">Angelos D. Keromytis</span> &lt;<a class="link-mail" href="mailto:angelos@cs.columbia.edu">angelos@cs.columbia.edu</a>&gt;</div>
<div class="section">
<h1 id="x5745422050414745">WEB PAGE</h1> <a class="link-ext" href="http://www1.cs.columbia.edu/~angelos/keynote.html">http://www1.cs.columbia.edu/~angelos/keynote.html</a></div>
</div>
</body>
</html>

