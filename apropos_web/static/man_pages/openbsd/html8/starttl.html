<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
STARTTLS(8)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">starttls</b> &#8212; <span class="desc">ESMTP over TLS/SSL</span></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> STARTTLS is an ESMTP option, defined in RFC 3207, which is used to conduct ESMTP transactions over TLS circuits. This is used to increase the security of mail server transactions.<div class="spacer">
</div>
STARTTLS allows for the combination of several security solutions for MTA (mail transport agent) level services through the TLS suite. These security features include:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
Confidentiality</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Encryption is used to protect data from passive monitoring. An attacker would have to recover the encryption key used to decode the transmitted data.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
Integrity</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Hash algorithms are used to ensure the integrity of the transmitted data, and alternatively the timestamp, protecting against a replay attack. This protects data from modification in transit.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
Authentication</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The use of public key encryption allows for the strong authentication of either, or both, communicating parties. This can be used to allow for select features, such as relaying, to be controlled more securely.</dd>
</dl>
<div class="spacer">
</div>
A new ESMTP option, STARTTLS, has been added. This is presented by the server when an ESMTP session is initiated. The client then begins the TLS portion of the ESMTP session by issuing the command &#8220;STARTTLS&#8221;. The remaining portion of the ESMTP session occurs over a TLS channel.<div class="subsection">
<h2 id="x4372656174696e6720612070726976617465206b657920616e6420636572746966696361746520666f7220616e204d5441">Creating a private key and certificate for an MTA</h2> This example assumes you are creating your own self-signed certificates for use with <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> and STARTTLS. If you have an existing private key and you simply wish to generate a new certificate (for example, if your old certificate has expired), see the section entitled <i class="link-sec"><a class="link-sec" href="#x4372656174696e672061206365727469666963617465207769746820616e206578697374696e672070726976617465206b6579">Creating a certificate with an existing private key</a></i>.<div class="spacer">
</div>
For the purposes of this example the certificates will be stored in <i class="file">/etc/ssl</i>, though it is possible to use a different directory if needed.<div class="spacer">
</div>
Next, you must generate an <i class="arg">RSA</i> private key:<div class="spacer">
</div>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit"># openssl genrsa -out /etc/ssl/private/mail.example.com.key 4096</code></div>
</blockquote>
<div class="spacer">
</div>
This would generate a 4096-bit <i class="arg">RSA</i> key stored in the file <i class="file">mail.example.com.key</i>.<div class="spacer">
</div>
Once you have generated the <i class="arg">RSA</i> key, you can generate a certificate from it using the command:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
# openssl req -x509 -new -key /etc/ssl/private/mail.example.com.key \ 
  -out /etc/ssl/mail.example.com.crt -days 365</pre>
<div class="spacer">
</div>
You may adjust the lifetime of the certificate via the <b class="flag">-days</b> parameter (one year in this example).<div class="spacer">
</div>
You can verify that the newly-generated certificate has correct information with the following command:<div class="spacer">
</div>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit"># openssl x509 -in /etc/ssl/mail.example.com.crt -text</code></div>
</blockquote>
<div class="spacer">
</div>
If you don't intend to use TLS for authentication (and if you are using self-signed certificates you probably don't) you can simply link your new certificate to <i class="file">CAcert.pem</i>.<div class="spacer">
</div>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit"># ln -s /etc/ssl/mail.example.com.crt /etc/ssl/CAcert.pem</code></div>
</blockquote>
<div class="spacer">
</div>
If, on the other hand, you intend to use TLS for authentication you should install your certificate authority bundle as <i class="file">/etc/ssl/CAcert.pem</i>.<div class="spacer">
</div>
Because the private key files are unencrypted, MTAs can be picky about using tight permissions on those files. The certificate directory and the files therein should be readable and writable only by the owner (root). A simple way to ensure this is to run the following:<div class="spacer">
</div>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit"># chmod -R go-rwx /etc/ssl/private</code></div>
</blockquote>
</div>
<div class="subsection">
<h2 id="x4372656174696e672061206365727469666963617465207769746820616e206578697374696e672070726976617465206b6579">Creating a certificate with an existing private key</h2> This example assumes you already have an existing private key, <i class="file">/etc/ssl/private/mail.example.com.key</i>. You can generate a new certificate based on this key using the command:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
# openssl req -x509 -new -key /etc/ssl/private/mail.example.com.key \ 
  -out /etc/ssl/mail.example.com.crt -days 365 
# chmod 600 /etc/ssl/mycert.pem</pre>
<div class="spacer">
</div>
You may adjust the lifetime of the certificate via the <b class="flag">-days</b> parameter (one year in this example).<div class="spacer">
</div>
After having installed the certificates the mail server needs to be configured to accept TLS sessions and use the key and certificate. For <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a>, it's as simple as adding pki configuration to <a class="link-man" href="../html5/smtpd.conf.html">smtpd.conf(5)</a>:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
pki mail.example.com certificate &quot;/etc/ssl/mail.example.com.crt&quot; 
pki mail.example.com key &quot;/etc/ssl/private/mail.example.com.key&quot; 
 
listen on [...] tls pki mail.example.com auth</pre>
<div class="spacer">
</div>
After restarting the mail server, a new option should be presented for ESMTP transactions, STARTTLS. You can test this by connecting to the local host and issuing the &#8220;EHLO&#8221; command.<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
# telnet localhost 25 
Trying 127.0.0.1... 
Connected to localhost. 
Escape character is '^]'. 
220 localhost ESMTP OpenSMTPD 
EHLO localhost</pre>
<div class="spacer">
</div>
After typing <span class="emph">EHLO localhost</span> you should receive something like the following back.<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
250-localhost Hello localhost [127.0.0.1], pleased to meet you 
250-8BITMIME 
250-ENHANCEDSTATUSCODES 
250-SIZE 36700160 
250-DSN 
250-STARTTLS 
250 HELP</pre>
<div class="spacer">
</div>
You should see &#8220;STARTTLS&#8221; listed along with the other options. If so, congratulations, the MTA will now use TLS to encrypt your mail traffic when the remote server supports it. If not, check <i class="file">/var/log/maillog</i> to see whether the MTA has reported any security problems or other errors.</div>
<div class="subsection">
<h2 id="x5573657320666f7220544c53206571756970706564204d544173">Uses for TLS equipped MTAs</h2> The most obvious use of a cryptographically enabled MTA is for confidentiality of the electronic mail transaction and the integrity checking provided by the cipher suite. All traffic between the two mail servers is encrypted, including the sender and recipient addresses. TLS also allows for authentication of either or both systems in the transaction.<div class="spacer">
</div>
One use of public key cryptography is for strong authentication. We can use this authentication to selectively relay clients, including other mail servers and mobile clients like laptops. However, there have been some problems getting some mail clients to work using certificate-based authentication. Note that your clients will have to generate certificates and have them signed (for trust validation) by a CA (certificate authority) you also trust, if you configure your server to do client certificate checking. Two new entries are available for TLS options:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
VERIFY</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
contains the status of the level of verification (held in the macro {verify})</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
ENCR</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
the strength of the encryption (in the macro {cipher_bits})</dd>
</dl>
<div class="spacer">
</div>
VERIFY can also accept the argument for {cipher_bits}. Here are a few example entries that illustrate these features, and the role based granularity as well:<div class="spacer">
</div>
Require strong (256-bit) encryption for communication with this server:<div class="spacer">
</div>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit">TLS_Srv:server1.example.net	ENCR:256</code></div>
</blockquote>
<div class="spacer">
</div>
For a TLS client, require verification and a minimum of 128-bit encryption:<div class="spacer">
</div>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit">TLS_Clt:desktop.example.net VERIFY:128</code></div>
</blockquote>
<div class="spacer">
</div>
Much more complicated access maps are possible, and error conditions (such as permanent or temporary, PERM+ or TEMP+) can be set on the basis of various criteria. This allows you fine-grained control over the types of connections you can allow.<div class="spacer">
</div>
Note that it is unwise to force all SMTP clients to use TLS, as it is not yet widespread. The RFC document notes that publicly referenced SMTP servers, such as the MX servers for a domain, must not refuse non-TLS connections. However, restricted access SMTP servers, such as those for a corporate intranet, can use TLS as an access control mechanism.</div>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html1/mail.html">mail(1)</a>, <a class="link-man" href="../html1/openssl.html">openssl(1)</a>, <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a>, <a class="link-man" href="../html8/ssl.html">ssl(8)</a></div>
<div class="section">
<h1 id="x5354414e4441524453">STANDARDS</h1> <span class="ref"><span class="ref-auth">P. Hoffman</span>, <span class="ref-title">SMTP Service Extension for Secure SMTP over Transport Layer Security</span>, <span class="ref-rep">RFC 3207</span>, <span class="ref-date">February 2002</span>.</span></div>
<div class="section">
<h1 id="x43415645415453">CAVEATS</h1> One often forgotten limitation of using TLS on a mail server is the payload of the mail message and the resulting security there. Many virus and worm files are now distributed via electronic mail. While the mail may be encrypted and the servers authenticated, the payload can still be malicious. The use of a good content protection program on the desktop is therefore still of value even with TLS at the MTA level.<div class="spacer">
</div>
Because TLS can only authenticate at the server level, true end-to-end authentication of the mail message cannot be performed with only the use of STARTLS on the server. The use of S/MIME or PGP email and trustworthy key hierarchies can guarantee full confidentiality and integrity of the entire message path.<div class="spacer">
</div>
Furthermore, if a mail message traverses more than just the starting and ending servers, there is no way to control interactions between the intervening mail servers, which may use non-secure connections. This introduces a point of vulnerability in the chain.<div class="spacer">
</div>
Additionally, SMTP over TLS is not yet widely implemented. The standard, in fact, doesn't require it, leaving it only as an option, though specific sites can configure their servers to force it for specific clients. As such, it is difficult to foresee the widespread use of SMTP using TLS, despite the fact that the standard is, at the date of this writing, over two years old.<div class="spacer">
</div>
Lastly, interoperability problems can appear between different implementations.</div>
</div>
</body>
</html>

