<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
FTP-PROXY(8)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">ftp-proxy</b> &#8212; <span class="desc">Internet File Transfer Protocol proxy daemon</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1><table class="synopsis">
<col style="width: 9.00ex;"/>
<col/>
<tbody>
<tr>
<td>
ftp-proxy</td>
<td>
[<span class="opt"><b class="flag">-6Adrv</b></span>] [<span class="opt"><b class="flag">-a</b>&#160;<i class="arg">address</i></span>] [<span class="opt"><b class="flag">-b</b>&#160;<i class="arg">address</i></span>] [<span class="opt"><b class="flag">-D</b>&#160;<i class="arg">level</i></span>] [<span class="opt"><b class="flag">-m</b>&#160;<i class="arg">maxsessions</i></span>] [<span class="opt"><b class="flag">-P</b>&#160;<i class="arg">port</i></span>] [<span class="opt"><b class="flag">-p</b>&#160;<i class="arg">port</i></span>] [<span class="opt"><b class="flag">-q</b>&#160;<i class="arg">queue</i></span>] [<span class="opt"><b class="flag">-R</b>&#160;<i class="arg">address</i></span>] [<span class="opt"><b class="flag">-T</b>&#160;<i class="arg">tag</i></span>] [<span class="opt"><b class="flag">-t</b>&#160;<i class="arg">timeout</i></span>]</td>
</tr>
</tbody>
</table>
</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> <b class="name">ftp-proxy</b> is a proxy for the Internet File Transfer Protocol. FTP control connections should be redirected into the proxy using the <a class="link-man" href="../html4/pf.html">pf(4)</a> <i class="arg">divert-to</i> command, after which the proxy connects to the server on behalf of the client.<div class="spacer">
</div>
The proxy allows data connections to pass, rewriting and redirecting them so that the right addresses are used. All connections from the client to the server have their source address rewritten so they appear to come from the proxy. Consequently, all connections from the server to the proxy have their destination address rewritten, so they are redirected to the client. The proxy uses the <a class="link-man" href="../html4/pf.html">pf(4)</a> <i class="arg">anchor</i> facility for this.<div class="spacer">
</div>
Assuming the FTP control connection is from $client to $server, the proxy connected to the server using the $proxy source address, and $port is negotiated, then <b class="name">ftp-proxy</b> adds the following rules to the anchor. $server and $orig_server are the same unless <b class="flag">-R</b> is used to force a different $server address for all connections. (These example rules use inet, but the proxy also supports inet6.)<div class="spacer">
</div>
In case of active mode (PORT or EPRT):<div class="spacer">
</div>
<pre style="margin-left: 2.00ex;" class="lit display">
pass in from $server to $proxy port $proxy_port \ 
    rdr-to $client port $port 
pass out from $server to $client port $port \ 
    nat-to $orig_server port $natport</pre>
<div class="spacer">
</div>
In case of passive mode (PASV or EPSV):<div class="spacer">
</div>
<pre style="margin-left: 2.00ex;" class="lit display">
pass in from $client to $orig_server port $proxy_port \ 
    rdr-to $server port $port 
pass out from $client to $server port $port nat-to $proxy</pre>
<div class="spacer">
</div>
<b class="name">ftp-proxy</b> chroots to &quot;/var/empty&quot; and changes to user &quot;_ftp-proxy&quot; to drop privileges.<div class="spacer">
</div>
The options are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-6</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
IPv6 mode. The proxy will expect and use IPv6 addresses for all communication. Only the extended FTP modes EPSV and EPRT are allowed with IPv6. The proxy is in IPv4 mode by default.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-A</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Only permit anonymous FTP connections. Either user &quot;ftp&quot; or user &quot;anonymous&quot; is allowed.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-a</b> <i class="arg">address</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The proxy will use this as the source address for the control connection to a server.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-b</b> <i class="arg">address</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Address where the proxy will listen for redirected control connections. The default is 127.0.0.1, or ::1 in IPv6 mode.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-D</b> <i class="arg">level</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Debug level, ranging from 0 to 7. Higher is more verbose. The default is 5. (These levels correspond to the <a class="link-man" href="../html3/syslog.html">syslog(3)</a> levels.)</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-d</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Do not daemonize. The process will stay in the foreground, logging to standard error.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-m</b> <i class="arg">maxsessions</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Maximum number of concurrent FTP sessions. When the proxy reaches this limit, new connections are denied. The default is 100 sessions. The limit can be lowered to a minimum of 1, or raised to a maximum of 500.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-P</b> <i class="arg">port</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Fixed server port. Only used in combination with <b class="flag">-R</b>. The default is port 21.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-p</b> <i class="arg">port</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Port where the proxy will listen for redirected connections. The default is port 8021.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-q</b> <i class="arg">queue</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Create rules with queue <i class="arg">queue</i> appended, so that data connections can be queued.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-R</b> <i class="arg">address</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Fixed server address, also known as reverse mode. The proxy will always connect to the same server, regardless of where the client wanted to connect to (before it was redirected). Use this option to proxy for a server behind NAT, or to forward all connections to another proxy.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-r</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Rewrite sourceport to 20 in active mode to suit ancient clients that insist on this RFC property.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-T</b> <i class="arg">tag</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The filter rules will add tag <i class="arg">tag</i> to data connections, and will use match rules instead of pass ones. This way alternative rules that use the <i class="arg">tagged</i> keyword can be implemented following the <b class="name">ftp-proxy</b> anchor. These rules can use special <a class="link-man" href="../html4/pf.html">pf(4)</a> features like route-to, reply-to, label, rtable, overload, etc. that <b class="name">ftp-proxy</b> does not implement itself. There must be a matching pass rule after the <b class="name">ftp-proxy</b> anchor or the data connections will be blocked.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-t</b> <i class="arg">timeout</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Number of seconds that the control connection can be idle, before the proxy will disconnect. The maximum is 86400 seconds, which is also the default. Do not set this too low, because the control connection is usually idle when large data transfers are taking place.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="flag">-v</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Set the 'log' flag on pf rules committed by <b class="name">ftp-proxy</b>. Use twice to set the 'log all' flag. The pf rules do not log by default.</dd>
</dl>
</div>
<div class="section">
<h1 id="x434f4e46494755524154494f4e">CONFIGURATION</h1> To make use of the proxy, <a class="link-man" href="../html5/pf.conf.html">pf.conf(5)</a> needs the following rules. Adjust the rules as needed; depending on the rest of the ruleset, the last rule explicitly allowing FTP sessions from the proxy may not be necessary.<div class="spacer">
</div>
<pre style="margin-left: 2.00ex;" class="lit display">
anchor &quot;ftp-proxy/*&quot; 
pass in quick proto tcp to port ftp divert-to 127.0.0.1 port 8021 
pass out inet proto tcp from (self) to any port ftp</pre>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html1/ftp.html">ftp(1)</a>, <a class="link-man" href="../html4/pf.html">pf(4)</a>, <a class="link-man" href="../html5/pf.conf.html">pf.conf(5)</a></div>
<div class="section">
<h1 id="x43415645415453">CAVEATS</h1> <a class="link-man" href="../html4/pf.html">pf(4)</a> does not allow the ruleset to be modified if the system is running at a <a class="link-man" href="../html7/securelevel.html">securelevel(7)</a> higher than 1. At that level <b class="name">ftp-proxy</b> cannot add rules to the anchors and FTP data connections may get blocked.<div class="spacer">
</div>
Negotiated data connection ports below 1024 are not allowed.<div class="spacer">
</div>
The negotiated IP address for active modes is ignored for security reasons. This makes third party file transfers impossible.<div class="spacer">
</div>
Since <b class="name">ftp-proxy</b> acts as a man-in-the-middle it breaks explicit FTP TLS connections (RFC 4217).</div>
</div>
</body>
</html>

