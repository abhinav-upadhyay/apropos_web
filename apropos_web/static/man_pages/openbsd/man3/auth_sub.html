<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
AUTH_OPEN(3)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">auth_open</b>, <b class="name">auth_call</b>, <b class="name">auth_challenge</b>, <b class="name">auth_check_change</b>, <b class="name">auth_check_expire</b>, <b class="name">auth_clean</b>, <b class="name">auth_close</b>, <b class="name">auth_clrenv</b>, <b class="name">auth_clroption</b>, <b class="name">auth_clroptions</b>, <b class="name">auth_getitem</b>, <b class="name">auth_getpwd</b>, <b class="name">auth_getstate</b>, <b class="name">auth_getvalue</b>, <b class="name">auth_set_va_list</b>, <b class="name">auth_setdata</b>, <b class="name">auth_setenv</b>, <b class="name">auth_setitem</b>, <b class="name">auth_setoption</b>, <b class="name">auth_setpwd</b>, <b class="name">auth_setstate</b> &#8212; <span class="desc">interface to the BSD Authentication system</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/types.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">login_cap.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">bsd_auth.h</a>&gt;</b><div class="spacer">
</div>
<i class="ftype">auth_session_t *</i><br/>
<b class="fname">auth_open</b>(<i class="farg" style="white-space:nowrap;">void</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">auth_close</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">auth_call</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>, <i class="farg" style="white-space:nowrap;">char *path</i>, <i class="farg" style="white-space:nowrap;">...</i>);<div class="spacer">
</div>
<i class="ftype">char *</i><br/>
<b class="fname">auth_challenge</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>);<div class="spacer">
</div>
<i class="ftype">quad_t</i><br/>
<b class="fname">auth_check_change</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>);<div class="spacer">
</div>
<i class="ftype">quad_t</i><br/>
<b class="fname">auth_check_expire</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">auth_clean</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">auth_clrenv</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">auth_clroption</b>(<i class="farg" style="white-space:nowrap;">auth_session_t * as</i>, <i class="farg" style="white-space:nowrap;">char *name</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">auth_clroptions</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>);<div class="spacer">
</div>
<i class="ftype">char *</i><br/>
<b class="fname">auth_getitem</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>, <i class="farg" style="white-space:nowrap;">auth_item_t item</i>);<div class="spacer">
</div>
<i class="ftype">struct passwd *</i><br/>
<b class="fname">auth_getpwd</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">auth_getstate</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>);<div class="spacer">
</div>
<i class="ftype">char *</i><br/>
<b class="fname">auth_getvalue</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>, <i class="farg" style="white-space:nowrap;">char *what</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">auth_set_va_list</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>, <i class="farg" style="white-space:nowrap;">va_list ap</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">auth_setdata</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>, <i class="farg" style="white-space:nowrap;">void *ptr</i>, <i class="farg" style="white-space:nowrap;">size_t len</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">auth_setenv</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">auth_setitem</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>, <i class="farg" style="white-space:nowrap;">auth_item_t item</i>, <i class="farg" style="white-space:nowrap;">char *value</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">auth_setoption</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>, <i class="farg" style="white-space:nowrap;">char *name</i>, <i class="farg" style="white-space:nowrap;">char *value</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">auth_setpwd</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>, <i class="farg" style="white-space:nowrap;">struct passwd *pwd</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">auth_setstate</b>(<i class="farg" style="white-space:nowrap;">auth_session_t *as</i>, <i class="farg" style="white-space:nowrap;">int state</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> These functions provide the lower level interface to the <span class="unix">BSD</span> Authentication system. They all operate on a <span class="unix">BSD</span> Authentication session pointer, <i class="farg">as</i>, which is returned by <b class="fname">auth_open</b>(). The session pointer must be passed to all other <span class="unix">BSD</span> Authentication functions called. The <b class="fname">auth_open</b>() function returns <span class="define">NULL</span> if it was unable to allocate memory for the session. The session is terminated by the <b class="fname">auth_close</b>() function, which also sets any environment variables requested by the login script (assuming the user was not rejected) or removes files created by the login script if the authentication was not successful. It returns the final state of the authentication request. A return value of 0 implies the user was not authenticated. A non-zero return value is made up of 1 or more of the following values ORed together:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">AUTH_OKAY</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
The user was authenticated.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">AUTH_ROOTOKAY</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
The user was authenticated with a root instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">AUTH_SECURE</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
The user was authenticated via a mechanism which is not subject to eavesdropping attacks (such as provided by token cards).</dd>
</dl>
<div class="spacer">
</div>
The full state of the session is returned by the <b class="fname">auth_getstate</b>() function. In addition to the values above, it also may contain the bits:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">AUTH_SILENT</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
Do not report an error, the user was not authenticated for access and was not expected to be. This is returned by login scripts that allow changing of the user's password, for instance. This value is stripped off for normal returns.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">AUTH_CHALLENGE</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
The user was not authenticated for access and a challenge was issued. The challenge should be displayed to the user, a response retrieved, and the result verified. This value is stripped off for normal returns.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">AUTH_EXPIRED</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
The user's account has expired.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">AUTH_PWEXPIRED</span></dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
The user's password has expired and needs to be changed.</dd>
</dl>
<div class="spacer">
</div>
A session may be cleaned by calling <b class="fname">auth_clean</b>(). This function removes any files created by a login script in this session and clears all state associated with this session, with the exception of the option settings. It is not necessary to call <b class="fname">auth_clean</b>() if <b class="fname">auth_close</b>() is called.<div class="spacer">
</div>
The remaining functions are described in alphabetical order.<div class="spacer">
</div>
The fundamental function for doing <span class="unix">BSD</span> Authentication is <b class="fname">auth_call</b>(). In addition to the pointer to the <span class="unix">BSD</span> Authentication session, it takes the following parameters:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="arg">path</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The full path name of the login script to run. The call will fail if <i class="arg">path</i> does not pass the requirements of the <a class="link-man" href="../html3/secure_path.html">secure_path(3)</a> function.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="arg">...</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The remaining arguments, which should be of type <span class="type">char *</span> and terminated with a <span class="define">NULL</span>, are passed to the login script at the end of the command line.</dd>
</dl>
<div class="spacer">
</div>
The <b class="fname">auth_call</b>() function, after verifying the <i class="arg">path</i>, creates a bi-directional pipe (socketpair) which is located on file descriptor 3 for the child (the login script). This is known as the &#8220;back channel&#8221;. The actual command line passed to the child is made up of 3 parts. The parameters passed to <b class="fname">auth_call</b>() following <i class="arg">path</i> have appended to them any arguments specified by the <b class="fname">auth_set_va_list</b>() function. These are typically the variable arguments passed to the function that calls <b class="fname">auth_call</b>(). Any option values set by the <b class="fname">auth_setoption</b>() function are inserted between the first argument (the command name) and the second argument with a preceding <b class="flag">-v</b> flag. The name and value are separated by an &#8216;=&#8217;:<div class="spacer">
</div>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<b class="flag">-v</b> <i class="arg">name=value</i></div>
</blockquote>
<div class="spacer">
</div>
Once the login script has been spawned, any data specified by the <b class="fname">auth_setdata</b>() is written to the back channel. Multiple blocks of data may have been specified and they will be sent in the same order they were specified. As the data is sent, the storage for the data is zeroed out and then freed (the data is zeroed out since it may contain sensitive information, such as a password). Once any data is written out, <b class="fname">auth_call</b>() reads up to 8192 bytes of data from the back channel. The state of the session is determined from this data (see <a class="link-man" href="../html5/login.conf.html">login.conf(5)</a> for details). If the login script exits with a 0 and does not specify any return state on the back channel, the state prior to the call to <b class="fname">auth_call</b>() is retained.<div class="spacer">
</div>
Note that while <b class="fname">auth_call</b>() will zero out the copies it makes of sensitive information, such as plain text passwords, after it is sent, it is the responsibility of the caller to zero out the original copies of this sensitive information. Due to the mechanics of the <b class="fname">auth_call</b>() function, this data must be zeroed <span class="emph">before</span> <b class="fname">auth_call</b>() is called. The safest place to zero out sensitive information is immediately after it has been passed to <b class="fname">auth_setdata</b>().<div class="spacer">
</div>
The back channel data may also contain a file descriptor passed back from the login script. If this is the case, the login script will first send back the string &#8220;fd&#8221; to indicate that a file descriptor will be the next data item. The file descriptor will be passed back to the next invocation of the login script with a number specified by the <b class="flag">-v</b> <i class="arg">fd</i> option. This is used to implement stateful challenge/response schemes that require a persistent connection during the challenge and response. The copy of the descriptor in the parent process is closed when the child is running to prevent deadlock when file locking is used. The descriptor is also closed by a call to <b class="fname">auth_close</b>() or <b class="fname">auth_clean</b>().<div class="spacer">
</div>
The data read from the back channel is also used by the <b class="fname">auth_getvalue</b>() and <b class="fname">auth_close</b>() functions. Subsequent calls to <b class="fname">auth_call</b>() will cause this data to be lost and overwritten with the new data read from the new call.<div class="spacer">
</div>
The environment passed to the login script by <b class="fname">auth_call</b>() only contains two values: <span class="env">PATH</span> and <span class="env">SHELL</span>. The <span class="env">PATH</span> is set to the default path (<i class="file">/bin</i> and <i class="file">/usr/bin</i>) while the <span class="env">SHELL</span> is set to the default system shell (<i class="file">/bin/sh</i>).<div class="spacer">
</div>
The <b class="fname">auth_challenge</b>() function queries the login script defined by the current <i class="arg">style</i> for a challenge for the user specified by <i class="arg">name</i>. (See below for the setting of the <i class="arg">style</i> and <i class="arg">name</i>). It internally uses the <b class="fname">auth_call</b>() function. The generated challenge is returned. <span class="define">NULL</span> is returned on error or if no challenge was generated. The challenge can also be extracted by the <b class="fname">auth_getchallenge</b>() function, which simply returns the last challenge generated for this session.<div class="spacer">
</div>
The <b class="fname">auth_check_change</b>() and <b class="fname">auth_check_expire</b>() functions check the password expiration (change) and account expiration times. They return 0 if no change or expiration time is set for the account. They return a negative value of how many seconds have passed since the password or account expired. In this case the state of the session is marked with either <code class="lit">AUTH_PWEXPIRED</code> or <code class="lit">AUTH_EXPIRED</code> as well as clearing any bits which would indicate the authentication was successful. If the password or account has not expired, they return the number of seconds left until the account does expire. The return value of -1 can either indicate the password or account just expired or that no password entry was set for the current session.<div class="spacer">
</div>
The <b class="fname">auth_clrenv</b>() function clears any requests set by a login script for environment variables to be set.<div class="spacer">
</div>
The <b class="fname">auth_clroption</b>() function clears the previously set option <i class="farg">name</i>.<div class="spacer">
</div>
The <b class="fname">auth_clroptions</b>() function clears all previously set options.<div class="spacer">
</div>
The <b class="fname">auth_getitem</b>() function returns the value of <i class="farg">item</i>. The <i class="farg">item</i> may be one of:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">AUTH_CHALLENGE</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
The latest challenge, if any, set for the session.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">AUTH_CLASS</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
The class of the user, as defined by the <i class="file">/etc/login.conf</i> file. This value is not directly used by <span class="unix">BSD</span> Authentication, rather, it is passed to the login scripts for their possible use.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">AUTH_INTERACTIVE</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
If set to any value, then the session is tagged as interactive. If not set, the session is not interactive. When the value is requested it is always either <span class="define">NULL</span> or &#8220;True&#8221;. The auth subroutines may choose to provide additional information to standard output or standard error when the session is interactive. There is no functional change in the operation of the subroutines.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">AUTH_NAME</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
The name of the user being authenticated. The name should include the instance, if any, that is being requested.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">AUTH_SERVICE</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
The service requesting the authentication. Initially it is set to the default service which provides the traditional interactive service.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">AUTH_STYLE</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
The style of authentication being performed, as defined by the <i class="file">/etc/login.conf</i> file. The style determines which login script should actually be used.</dd>
</dl>
<div class="spacer">
</div>
The value returned points to private memory and should not be freed by the caller.<div class="spacer">
</div>
The <b class="fname">auth_getvalue</b>() function returns the value, if any, associated with the specified internal variable <i class="arg">what</i>. These variables are set by login scripts. When a new login script is run (by the <b class="fname">auth_call</b>() function) the values from the previous login script are lost. (See <a class="link-man" href="../html5/login.conf.html">login.conf(5)</a> for details on internal variables.)<div class="spacer">
</div>
The <b class="fname">auth_set_va_list</b>() function establishes a variable argument list to be used by the <b class="fname">auth_call</b>() function. It is intended to be used by functions which need to call <b class="fname">auth_call</b>() but take a variable number of arguments themselves. Since the arguments are not copied, the call to <b class="fname">auth_call</b>() must be placed within the scope of <i class="farg">ap</i>. The <b class="fname">auth_call</b>() function will call <a class="link-man" href="../html3/va_end.html">va_end(3)</a> on <i class="farg">ap</i>.<div class="spacer">
</div>
The <b class="fname">auth_setdata</b>() function makes a copy of <i class="farg">len</i> bytes of data pointed to by <i class="farg">ptr</i> for use by <b class="fname">auth_call</b>(). The data will be passed on the back channel to the next login script called.<div class="spacer">
</div>
The <b class="fname">auth_setenv</b>() function adds/deletes any environment variables requested by the login script to the current environment.<div class="spacer">
</div>
The <b class="fname">auth_setitem</b>() function assigns <i class="farg">value</i> to the specified <i class="farg">item</i>. The items are described above with the <b class="fname">auth_getitem</b>() function. In addition, if <i class="farg">value</i> is <span class="define">NULL</span>, the <i class="farg">item</i> is cleared. If <i class="farg">value</i> is <span class="define">NULL</span> and <i class="farg">item</i> is <code class="lit">AUTH_ALL</code> then all items are cleared.<div class="spacer">
</div>
The <b class="fname">auth_setoption</b>() function requests that the option <i class="farg">name</i> be set with the value of <i class="farg">value</i> when a script is executed by <b class="fname">auth_call</b>(). The actual arguments to the script will be placed at the beginning of the argument vector. For each option two arguments will be issued: <code class="lit">-v name=value</code>.<div class="spacer">
</div>
The function <b class="fname">auth_setpwd</b>() establishes the password file entry for the authentication session. If the name has already been set by <b class="fname">auth_setitem</b>() then the <i class="farg">pwd</i> argument may be <span class="define">NULL</span>, else it must be the password entry to use.<div class="spacer">
</div>
The function <b class="fname">auth_getpwd</b>() retrieves the saved password file entry for the authentication session. If no entry has been saved (either explicitly via <b class="fname">auth_setpwd</b>() or implicitly via <b class="fname">auth_check_expire</b>() or <b class="fname">auth_check_change</b>()) it returns <span class="define">NULL</span>. Note that the memory containing the password file entry is freed by a call to <b class="fname">auth_close</b>() or <b class="fname">auth_clean</b>().<div class="spacer">
</div>
The function <b class="fname">auth_setstate</b>() sets the sessions state to <i class="farg">state</i>. Typically this is either <code class="lit">AUTH_OKAY</code> or 0.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html3/authenticate.html">authenticate(3)</a>, <a class="link-man" href="../html3/login_cap.html">login_cap(3)</a>, <a class="link-man" href="../html3/pw_dup.html">pw_dup(3)</a>, <a class="link-man" href="../html5/login.conf.html">login.conf(5)</a></div>
</div>
</body>
</html>

