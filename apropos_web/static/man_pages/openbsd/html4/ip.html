<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
IP(4)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">ip</b> &#8212; <span class="desc">Internet Protocol</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/types.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">sys/socket.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">netinet/in.h</a>&gt;</b><div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">socket</b>(<i class="farg" style="white-space:nowrap;">AF_INET</i>, <i class="farg" style="white-space:nowrap;">SOCK_RAW</i>, <i class="farg" style="white-space:nowrap;">proto</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> IP is the network layer protocol used by the Internet protocol family. Options may be set at the IP level when using higher-level protocols that are based on IP (such as TCP and UDP). It may also be accessed through a &#8220;raw socket&#8221; when developing new protocols, or special-purpose applications.<div class="spacer">
</div>
There are several IP-level <a class="link-man" href="../html2/setsockopt.html">setsockopt(2)</a>/<a class="link-man" href="../html2/getsockopt.html">getsockopt(2)</a> options. <span class="define">IP_OPTIONS</span> may be used to provide IP options to be transmitted in the IP header of each outgoing packet or to examine the header options on incoming packets. IP options may be used with any socket type in the Internet family. The format of IP options to be sent is that specified by the IP protocol specification (RFC 791), with one exception: the list of addresses for Source Route options must include the first-hop gateway at the beginning of the list of gateways. The first-hop gateway address will be extracted from the option list and the size adjusted accordingly before use. To disable previously specified options, use a zero-length buffer:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
setsockopt(s, IPPROTO_IP, IP_OPTIONS, NULL, 0);</pre>
<div class="spacer">
</div>
<span class="define">IP_TOS</span> and <span class="define">IP_TTL</span> may be used to set the type-of-service and time-to-live fields in the IP header for <span class="define">SOCK_STREAM</span>, <span class="define">SOCK_DGRAM</span> and <span class="define">SOCK_RAW</span> sockets. For example,<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
int tos = IPTOS_LOWDELAY;       /* see &lt;netinet/ip.h&gt; */ 
setsockopt(s, IPPROTO_IP, IP_TOS, &amp;tos, sizeof(tos)); 
 
int ttl = 60;                   /* max = 255 */ 
setsockopt(s, IPPROTO_IP, IP_TTL, &amp;ttl, sizeof(ttl));</pre>
<div class="spacer">
</div>
<span class="define">IP_IPDEFTTL</span> can be used to retrieve the system wide default TTL.<div class="spacer">
</div>
If the <span class="define">IP_RECVDSTADDR</span> option is enabled on a <span class="define">SOCK_DGRAM</span> socket, the <a class="link-man" href="../html2/recvmsg.html">recvmsg(2)</a> call will return the destination IP address for a UDP datagram. The <b class="var">msg_control</b> field in the <span class="type">msghdr</span> structure points to a buffer that contains a <span class="type">cmsghdr</span> structure followed by the IP address. The <span class="type">cmsghdr</span> fields have the following values:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
cmsg_len = CMSG_LEN(sizeof(struct in_addr)) 
cmsg_level = IPPROTO_IP 
cmsg_type = IP_RECVDSTADDR</pre>
<div class="spacer">
</div>
If the <span class="define">IP_RECVDSTPORT</span> option is enabled on a <span class="define">SOCK_DGRAM</span> socket, the <a class="link-man" href="../html2/recvmsg.html">recvmsg(2)</a> call will return the destination port for a UDP datagram. The <b class="var">msg_control</b> field in the <span class="type">msghdr</span> structure points to a buffer that contains a <span class="type">cmsghdr</span> structure followed by the port in 16-bit network byte order. The <span class="type">cmsghdr</span> fields have the following values:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
cmsg_len = CMSG_LEN(sizeof(u_int16_t)) 
cmsg_level = IPPROTO_IP 
cmsg_type = IP_RECVDSTPORT</pre>
<div class="spacer">
</div>
If the <span class="define">IP_RECVTTL</span> option is enabled on a <span class="define">SOCK_DGRAM</span> or <span class="define">SOCK_RAW</span> socket, the <a class="link-man" href="../html2/recvmsg.html">recvmsg(2)</a> call will return the TTL of the received datagram. The <b class="var">msg_control</b> field in the <span class="type">msghdr</span> structure points to a buffer that contains a <span class="type">cmsghdr</span> structure followed by the TTL value. The <span class="type">cmsghdr</span> fields have the following values:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
cmsg_len = CMSG_LEN(sizeof(u_int8_t)) 
cmsg_level = IPPROTO_IP 
cmsg_type = IP_RECVTTL</pre>
<div class="spacer">
</div>
The <span class="define">IP_MINTTL</span> option may be used on <span class="define">SOCK_STREAM</span> sockets to discard packets with a TTL lower than the option value. This can be used to implement the <span class="emph">Generalized TTL Security Mechanism (GTSM)</span> according to RFC 5082. To discard all packets with a TTL lower than 255:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
int minttl = 255; 
setsockopt(s, IPPROTO_IP, IP_MINTTL, &amp;minttl, sizeof(minttl));</pre>
<div class="spacer">
</div>
If the <span class="define">IP_IPSECFLOWINFO</span> option is enabled on a <span class="define">SOCK_DGRAM</span> socket, the <a class="link-man" href="../html2/recvmsg.html">recvmsg(2)</a> call will return information identifying the incoming IPsec SA for a UDP datagram. The <b class="var">msg_control</b> field in the <span class="type">msghdr</span> structure points to a buffer that contains a <span class="type">cmsghdr</span> structure followed by flow information in 32-bit network byte order. When this information is passed to a <a class="link-man" href="../html2/sendmsg.html">sendmsg(2)</a> call the ID of the incoming SA will be used for looking up the outgoing SA for the UDP datagram. The <span class="type">cmsghdr</span> fields for <a class="link-man" href="../html2/recvmsg.html">recvmsg(2)</a> and <a class="link-man" href="../html2/sendmsg.html">sendmsg(2)</a> have the following values:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
cmsg_len = CMSG_LEN(sizeof(u_int32_t)) 
cmsg_level = IPPROTO_IP 
cmsg_type = IP_IPSECFLOWINFO</pre>
<div class="spacer">
</div>
The <span class="define">IP_PORTRANGE</span> option causes the default allocation policy for when the kernel is asked to choose a free port number. Three choices are available:<div class="spacer">
</div>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">IP_PORTRANGE_DEFAULT</span></dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
The regular range of non-reserved ports.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">IP_PORTRANGE_HIGH</span></dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
A high range, for fun.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">IP_PORTRANGE_LOW</span></dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
Reserved ports; between 600 and 1023.</dd>
</dl>
<div class="spacer">
</div>
If the <span class="define">IP_RECVRTABLE</span> option is enabled on a <span class="define">SOCK_DGRAM</span> socket, the <a class="link-man" href="../html2/recvmsg.html">recvmsg(2)</a> call will return the source routing domain for a UDP datagram. The <b class="var">msg_control</b> field in the <span class="type">msghdr</span> structure points to a buffer that contains a <span class="type">cmsghdr</span> structure followed by the routing table ID. The <span class="type">cmsghdr</span> fields have the following values:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
cmsg_len = CMSG_LEN(sizeof(u_int)) 
cmsg_level = IPPROTO_IP 
cmsg_type = IP_RECVRTABLE</pre>
<div class="subsection">
<h2 id="x4d756c746963617374204f7074696f6e73">Multicast Options</h2> IP multicasting is supported only on <span class="define">AF_INET</span> sockets of type <span class="define">SOCK_DGRAM</span> and <span class="define">SOCK_RAW</span>, and only on networks where the interface driver supports multicasting.<div class="spacer">
</div>
The <span class="define">IP_MULTICAST_TTL</span> option changes the time-to-live (TTL) for outgoing multicast datagrams in order to control the scope of the multicasts:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
u_char ttl;	/* range: 0 to 255, default = 1 */ 
setsockopt(s, IPPROTO_IP, IP_MULTICAST_TTL, &amp;ttl, sizeof(ttl));</pre>
<div class="spacer">
</div>
Datagrams with a TTL of 1 are not forwarded beyond the local network. Multicast datagrams with a TTL of 0 will not be transmitted on any network, but may be delivered locally if the sending host belongs to the destination group and if multicast loopback has not been disabled on the sending socket (see below). Multicast datagrams with TTL greater than 1 may be forwarded to other networks if a multicast router is attached to the local network.<div class="spacer">
</div>
For hosts with multiple interfaces, each multicast transmission is sent from the primary network interface. The <span class="define">IP_MULTICAST_IF</span> option overrides the default for subsequent transmissions from a given socket:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
struct in_addr addr; 
setsockopt(s, IPPROTO_IP, IP_MULTICAST_IF, &amp;addr, sizeof(addr));</pre>
<div class="spacer">
</div>
where <b class="var">addr</b> is the local IP address of the desired interface or <span class="define">INADDR_ANY</span> to specify the default interface. An interface's local IP address and multicast capability can be obtained via the <span class="define">SIOCGIFCONF</span> and <span class="define">SIOCGIFFLAGS</span> <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>'s. Normal applications should not need to use this option.<div class="spacer">
</div>
If a multicast datagram is sent to a group to which the sending host itself belongs (on the outgoing interface), a copy of the datagram is, by default, looped back by the IP layer for local delivery. The <span class="define">IP_MULTICAST_LOOP</span> option gives the sender explicit control over whether or not subsequent datagrams are looped back:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
u_char loop;	/* 0 = disable, 1 = enable (default) */ 
setsockopt(s, IPPROTO_IP, IP_MULTICAST_LOOP, &amp;loop, sizeof(loop));</pre>
<div class="spacer">
</div>
This option improves performance for applications that may have no more than one instance on a single host (such as a router daemon), by eliminating the overhead of receiving their own transmissions. It should generally not be used by applications for which there may be more than one instance on a single host (such as a conferencing program) or for which the sender does not belong to the destination group (such as a time querying program).<div class="spacer">
</div>
A multicast datagram sent with an initial TTL greater than 1 may be delivered to the sending host on a different interface from that on which it was sent, if the host belongs to the destination group on that other interface. The loopback control option has no effect on such delivery.<div class="spacer">
</div>
A host must become a member of a multicast group before it can receive datagrams sent to the group. To join a multicast group, use the <span class="define">IP_ADD_MEMBERSHIP</span> option:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
struct ip_mreq mreq; 
setsockopt(s, IPPROTO_IP, IP_ADD_MEMBERSHIP, &amp;mreq, sizeof(mreq));</pre>
<div class="spacer">
</div>
where <i class="farg">mreq</i> is the following structure:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
struct ip_mreq { 
    struct in_addr imr_multiaddr; /* multicast group to join */ 
    struct in_addr imr_interface; /* interface to join on */ 
}</pre>
<div class="spacer">
</div>
<b class="var">imr_interface</b> should be <span class="define">INADDR_ANY</span> to choose the default multicast interface, or the IP address of a particular multicast-capable interface if the host is multihomed. Membership is associated with a single interface; programs running on multihomed hosts may need to join the same group on more than one interface. Up to <span class="define">IP_MAX_MEMBERSHIPS</span> (currently 4095) memberships may be added on a single socket.<div class="spacer">
</div>
To drop a membership, use:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
struct ip_mreq mreq; 
setsockopt(s, IPPROTO_IP, IP_DROP_MEMBERSHIP, &amp;mreq, sizeof(mreq));</pre>
<div class="spacer">
</div>
where <i class="farg">mreq</i> contains the same values as used to add the membership. Memberships are dropped when the socket is closed or the process exits.</div>
<div class="subsection">
<h2 id="x52617720495020536f636b657473">Raw IP Sockets</h2> Raw IP sockets are connectionless, and are normally used with the <a class="link-man" href="../html2/sendto.html">sendto(2)</a> and <a class="link-man" href="../html2/recvfrom.html">recvfrom(2)</a> calls, though the <a class="link-man" href="../html2/connect.html">connect(2)</a> call may also be used to fix the destination for future packets (in which case the <a class="link-man" href="../html2/read.html">read(2)</a> or <a class="link-man" href="../html2/recv.html">recv(2)</a> and <a class="link-man" href="../html2/write.html">write(2)</a> or <a class="link-man" href="../html2/send.html">send(2)</a> system calls may be used).<div class="spacer">
</div>
If <i class="farg">proto</i> is 0, the default protocol <span class="define">IPPROTO_RAW</span> is used for outgoing packets, and only incoming packets destined for that protocol are received. If <i class="farg">proto</i> is non-zero, that protocol number will be used on outgoing packets and to filter incoming packets.<div class="spacer">
</div>
Outgoing packets automatically have an IP header prepended to them (based on the destination address and the protocol number the socket is created with), unless the <span class="define">IP_HDRINCL</span> option has been set. Incoming packets are received with IP header and options intact.<div class="spacer">
</div>
<span class="define">IP_HDRINCL</span> indicates the complete IP header is included with the data and may be used only with the <span class="define">SOCK_RAW</span> type.<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
#include &lt;netinet/ip.h&gt; 
 
int hincl = 1;                  /* 1 = on, 0 = off */ 
setsockopt(s, IPPROTO_IP, IP_HDRINCL, &amp;hincl, sizeof(hincl));</pre>
<div class="spacer">
</div>
Unlike previous <span class="unix">BSD</span> releases, the program must set all the fields of the IP header, including the following:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
ip-&gt;ip_v = IPVERSION; 
ip-&gt;ip_hl = hlen &gt;&gt; 2; 
ip-&gt;ip_id = 0;  /* 0 means kernel set appropriate value */ 
ip-&gt;ip_off = htons(offset); 
ip-&gt;ip_len = htons(len);</pre>
<div class="spacer">
</div>
Additionally note that starting with <span class="unix">OpenBSD&#160;2.1</span>, the <b class="var">ip_off</b> and <b class="var">ip_len</b> fields are in network byte order. If the header source address is set to <span class="define">INADDR_ANY</span>, the kernel will choose an appropriate address.</div>
</div>
<div class="section">
<h1 id="x444941474e4f5354494353">DIAGNOSTICS</h1> A socket operation may fail with one of the following errors returned:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">EISCONN</span>]</dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
when trying to establish a connection on a socket which already has one, or when trying to send a datagram with the destination address specified and the socket is already connected;</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">ENOTCONN</span>]</dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
when trying to send a datagram, but no destination address is specified, and the socket hasn't been connected;</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">ENOBUFS</span>]</dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
when the system runs out of memory for an internal data structure;</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">EADDRNOTAVAIL</span>]</dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
when an attempt is made to create a socket with a network address for which no network interface exists.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">EACCES</span>]</dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
when an attempt is made to create a raw IP socket by a non-privileged process.</dd>
</dl>
<div class="spacer">
</div>
The following errors specific to IP may occur when setting or getting IP options:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">EINVAL</span>]</dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
An unknown socket option name was given.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">EINVAL</span>]</dt>
<dd class="list-tag" style="margin-left: 15.00ex;">
The IP option field was improperly formed; an option field was shorter than the minimum value or longer than the option buffer provided.</dd>
</dl>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html2/getsockopt.html">getsockopt(2)</a>, <a class="link-man" href="../html2/ioctl.html">ioctl(2)</a>, <a class="link-man" href="../html2/recv.html">recv(2)</a>, <a class="link-man" href="../html2/send.html">send(2)</a>, <a class="link-man" href="../html4/icmp.html">icmp(4)</a>, <a class="link-man" href="../html4/inet.html">inet(4)</a>, <a class="link-man" href="../html4/netintro.html">netintro(4)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">ip</b> protocol appeared in <span class="unix">4.2BSD</span>.</div>
</div>
</body>
</html>

