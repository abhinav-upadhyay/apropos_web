<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
IPSEC(4)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">ipsec</b> &#8212; <span class="desc">IP Security Protocol</span></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> IPsec is a pair of protocols, Encapsulating Security Payload (ESP) and Authentication Header (AH), which provide security services for IP datagrams.<div class="spacer">
</div>
Both protocols may be enabled or disabled using the following <a class="link-man" href="../html3/sysctl.html">sysctl(3)</a> variables in <i class="file">/etc/sysctl.conf</i>. By default, both protocols are enabled:<div class="spacer">
</div>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
net.inet.esp.enable</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Enable the ESP IPsec protocol</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
net.inet.ah.enable</dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Enable the AH IPsec protocol</dd>
</dl>
<div class="spacer">
</div>
There are four main security properties provided by IPsec:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-inset">
<dt class="list-inset" style="margin-top: 1.00em;">
Confidentiality</dt>
<dd class="list-inset">
- Ensure it is hard for anyone but the receiver to understand what data has been communicated. For example, ensuring the secrecy of passwords when logging into a remote machine over the Internet.</dd>
<dt class="list-inset" style="margin-top: 1.00em;">
Integrity</dt>
<dd class="list-inset">
- Guarantee that the data does not get changed in transit. If you are on a line carrying invoicing data you probably want to know that the amounts and account numbers are correct and have not been modified by a third party.</dd>
<dt class="list-inset" style="margin-top: 1.00em;">
Authenticity</dt>
<dd class="list-inset">
- Sign your data so that others can see that it is really you that sent it. It is clearly nice to know that documents are not forged.</dd>
<dt class="list-inset" style="margin-top: 1.00em;">
Replay protection</dt>
<dd class="list-inset">
- We need ways to ensure a datagram is processed only once, regardless of how many times it is received. That is, it should not be possible for an attacker to record a transaction (such as a bank account withdrawal), and then by replaying it verbatim cause the peer to think a new message (withdrawal request) had been received. WARNING: as per the standard's specification, replay protection is not performed when using manual-keyed IPsec (e.g. when using <a class="link-man" href="../html8/ipsecctl.html">ipsecctl(8)</a>).</dd>
</dl>
<div class="subsection">
<h2 id="x49507365632050726f746f636f6c73">IPsec Protocols</h2> IPsec provides these services using two new protocols: Authentication Header (AH), and Encapsulating Security Payload (ESP).<div class="spacer">
</div>
ESP can provide the properties authentication, integrity, replay protection, and confidentiality of the data (it secures everything in the packet that follows the IP header). Replay protection requires authentication and integrity (these two always go together). Confidentiality (encryption) can be used with or without authentication/integrity. Similarly, one could use authentication/integrity with or without confidentiality.<div class="spacer">
</div>
AH provides authentication, integrity, and replay protection (but not confidentiality). The main difference between the authentication features of AH and ESP is that AH also authenticates portions of the IP header of the packet (such as the source/destination addresses). ESP authenticates only the packet payload.</div>
<div class="subsection">
<h2 id="x41757468656e7469636174696f6e204865616465722028414829">Authentication Header (AH)</h2> AH works by computing a value that depends on all of the payload data, some of the IP header data, and a certain secret value (the authentication key). This value is then sent with the rest of each packet. The receiver performs the same computation, and if the value matches, he knows no one tampered with the data (integrity), the address information (authenticity) or a sequence number (replay protection). He knows this because the secret authentication key makes sure no active attacker (man-in-the-middle) can recompute the correct value after altering the packet. The algorithms used to compute these values are called hash algorithms and are parameters in the SA, just like the authentication key.</div>
<div class="subsection">
<h2 id="x456e63617073756c6174696e67205365637572697479205061796c6f6164202845535029">Encapsulating Security Payload (ESP)</h2> ESP optionally does almost everything that AH does except that it does not protect the outer IP header but furthermore it encrypts the payload data with an encryption algorithm using a secret encryption key. Only the ones knowing this key can decrypt the data, thus providing confidentiality. Both the algorithm and the encryption key are parameters of the SA.</div>
<div class="subsection">
<h2 id="x5365637572697479204173736f63696174696f6e73202853417329">Security Associations (SAs)</h2> These protocols require certain parameters for each connection, describing exactly how the desired protection will be achieved. These parameters are collected in an entity called a security association, or SA for short. Typical SA parameters include encryption algorithm, hash algorithm, encryption key, and authentication key, to name a few. When two peers have established matching SAs (one at each end), packets protected with one end's SA may be verified and/or decrypted using the information in the other end's SA. The only issue remaining is to ensure that both ends have matching SAs. This may be done manually, or automatically using a key management daemon.<div class="spacer">
</div>
Further information on manual SA establishment is described in <a class="link-man" href="../html5/ipsec.conf.html">ipsec.conf(5)</a>. Information on automated key management for IKEv1 can be found in <a class="link-man" href="../html8/isakmpd.html">isakmpd(8)</a> and for IKEv2 in <a class="link-man" href="../html5/iked.conf.html">iked.conf(5)</a>.</div>
<div class="subsection">
<h2 id="x536563757269747920506172616d6574657220496e646578657320285350497329">Security Parameter Indexes (SPIs)</h2> In order to identify an SA we need to have a unique name for it. This name is a triplet, consisting of the destination address, security parameter index (aka SPI) and the security protocol (ESP or AH). Since the destination address is part of the name, an SA is necessarily a unidirectional construct. For a bidirectional communication channel, two SAs are required, one outgoing and one incoming, where the destination address is our local IP address. The SPI is just a number that helps us make the name unique; it can be arbitrarily chosen in the range 0x100 - 0xffffffff. The security protocol number should be 50 for ESP and 51 for AH, as these are the protocol numbers assigned by IANA.</div>
<div class="subsection">
<h2 id="x4d6f646573206f66204f7065726174696f6e">Modes of Operation</h2> IPsec can operate in two modes, either tunnel or transport mode. In transport mode the ordinary IP header is used to deliver the packets to their endpoint; in tunnel mode the ordinary IP header just tells us the address of a security gateway which knows how to verify/decrypt the payload and forward the packet to a destination given by another IP header contained in the protected payload. Tunnel mode can be used for establishing virtual private networks (VPNs), where parts of the networks can be spread out over an unsafe public network, but security gateways at each subnet are responsible for encrypting and decrypting the data passing over the public net. An SA will contain information specifying whether it is a tunnel or transport mode SA, and for tunnels it will contain values to fill in into the outer IP header.</div>
<div class="subsection">
<h2 id="x4c69666574696d6573">Lifetimes</h2> The SA also holds a couple of other parameters, especially useful for automatic keying, called lifetimes, which puts a limit on how much we can use an SA for protecting our data. These limits can be in wall-clock time or in volume of our data.</div>
<div class="subsection">
<h2 id="x4950736563204578616d706c6573">IPsec Examples</h2> To better illustrate how IPsec works, consider a typical TCP packet:<div class="spacer">
</div>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit">[IP header] [TCP header] [data...]</code></div>
</blockquote>
<div class="spacer">
</div>
If we apply ESP in transport mode to the above packet, we will get:<div class="spacer">
</div>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit">[IP header] [ESP header] [TCP header] [data...]</code></div>
</blockquote>
<div class="spacer">
</div>
Everything after the ESP header is protected by whatever services of ESP we are using (authentication/integrity, replay protection, confidentiality). This means the IP header itself is not protected.<div class="spacer">
</div>
If we apply ESP in tunnel mode to the original packet, we would get:<div class="spacer">
</div>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit">[IP header] [ESP header] [IP header] [TCP header] [data...]</code></div>
</blockquote>
<div class="spacer">
</div>
Again, everything after the ESP header is cryptographically protected. Notice the insertion of an IP header between the ESP and TCP header. This mode of operation allows us to hide who the true source and destination addresses of a packet are (since the protected and the unprotected IP headers don't have to be exactly the same). A typical application of this is in Virtual Private Networks (or VPNs), where two firewalls use IPsec to secure the traffic of all the hosts behind them. For example:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
Net A &lt;----&gt; Firewall 1 &lt;--- Internet ---&gt; Firewall 2 &lt;----&gt; Net B</pre>
<div class="spacer">
</div>
Firewall 1 and Firewall 2 can protect all communications between Net A and Net B by using IPsec in tunnel mode, as illustrated above.<div class="spacer">
</div>
This implementation makes use of a virtual interface, <b class="name">enc0</b>, which can be used in packet filters to specify those packets that have been or will be processed by IPsec.<div class="spacer">
</div>
NAT can also be applied to <b class="name">enc#</b> interfaces, but special care should be taken because of the interactions between NAT and the IPsec flow matching, especially on the packet output path. Inside the TCP/IP stack, packets go through the following stages:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
UL/R -&gt; [X] -&gt; PF/NAT(enc0) -&gt; IPsec -&gt; PF/NAT(IF) -&gt; IF 
UL/R &lt;-------- PF/NAT(enc0) &lt;- IPsec &lt;- PF/NAT(IF) &lt;- IF</pre>
<div class="spacer">
</div>
With IF being the real interface and UL/R the Upper Layer or Routing code. The [X] stage on the output path represents the point where the packet is matched against the IPsec flow database (SPD) to determine if and how the packet has to be IPsec-processed. If, at this point, it is determined that the packet should be IPsec-processed, it is processed by the PF/NAT code. Unless PF drops the packet, it will then be IPsec-processed, even if the packet has been modified by NAT.<div class="spacer">
</div>
Security Associations can be set up manually with <a class="link-man" href="../html8/ipsecctl.html">ipsecctl(8)</a> or automatically with the <a class="link-man" href="../html8/isakmpd.html">isakmpd(8)</a> or <a class="link-man" href="../html8/iked.html">iked(8)</a> key management daemons.</div>
<div class="subsection">
<h2 id="x4164646974696f6e616c205661726961626c6573">Additional Variables</h2> A number of <a class="link-man" href="../html8/sysctl.html">sysctl(8)</a> variables are relevant to <b class="name">ipsec</b>. These are generally <b class="var">net.inet.ah.*</b>, <b class="var">net.inet.esp.*</b>, <b class="var">net.inet.ip.forwarding</b>, <b class="var">net.inet6.ip6.forwarding</b>, and <b class="var">net.inet.ip.ipsec-*</b>. Full explanations can be found in <a class="link-man" href="../html3/sysctl.html">sysctl(3)</a>, and variables can be set using the <a class="link-man" href="../html8/sysctl.html">sysctl(8)</a> interface.<div class="spacer">
</div>
A number of kernel options are also relevant to <b class="name">ipsec</b>. See <a class="link-man" href="../html4/options.html">options(4)</a> for further information.</div>
<div class="subsection">
<h2 id="x4150492044657461696c73">API Details</h2> The following IP-level <a class="link-man" href="../html2/setsockopt.html">setsockopt(2)</a> and <a class="link-man" href="../html2/getsockopt.html">getsockopt(2)</a> options are specific to <b class="name">ipsec</b>. A socket can specify security levels for three different categories:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 2.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
IP_AUTH_LEVEL</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
Specifies the use of authentication for packets sent or received by the socket.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
IP_ESP_TRANS_LEVEL</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
Specifies the use of encryption in transport mode for packets sent or received by the socket.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
IP_ESP_NETWORK_LEVEL</dt>
<dd class="list-tag" style="margin-left: 20.00ex;">
Specifies the use of encryption in tunnel mode.</dd>
</dl>
<div class="spacer">
</div>
For each of the categories there are five possible levels which specify the security policy to use in that category:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 2.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
IPSEC_LEVEL_BYPASS</dt>
<dd class="list-tag" style="margin-left: 19.00ex;">
Bypass the default system security policy. This option can only be used by privileged processes. This level is necessary for the key management daemon, <a class="link-man" href="../html8/isakmpd.html">isakmpd(8)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
IPSEC_LEVEL_AVAIL</dt>
<dd class="list-tag" style="margin-left: 19.00ex;">
If a Security Association is available it will be used for sending packets by that socket.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
IPSEC_LEVEL_USE</dt>
<dd class="list-tag" style="margin-left: 19.00ex;">
Use IP Security for sending packets but still accept packets which are not secured.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
IPSEC_LEVEL_REQUIRE</dt>
<dd class="list-tag" style="margin-left: 19.00ex;">
Use IP Security for sending packets and also require IP Security for received data.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
IPSEC_LEVEL_UNIQUE</dt>
<dd class="list-tag" style="margin-left: 19.00ex;">
The outbound Security Association will only be used by this socket.</dd>
</dl>
<div class="spacer">
</div>
When a new socket is created, it is assigned the default system security level in each category. These levels can be queried with <a class="link-man" href="../html2/getsockopt.html">getsockopt(2)</a>. Only a privileged process can lower the security level with a <a class="link-man" href="../html2/setsockopt.html">setsockopt(2)</a> call.<div class="spacer">
</div>
For example, a server process might want to accept only authenticated connections to prevent session hijacking. It would issue the following <a class="link-man" href="../html2/setsockopt.html">setsockopt(2)</a> call:<div class="spacer">
</div>
<pre style="margin-left: 4.00ex;" class="lit display">
int level = IPSEC_LEVEL_REQUIRE; 
error = setsockopt(s, IPPROTO_IP, IP_AUTH_LEVEL, &amp;level, sizeof(int));</pre>
<div class="spacer">
</div>
The system does guarantee that it will succeed at establishing the required security associations. In any case a properly configured key management daemon is required which listens to messages from the kernel.<div class="spacer">
</div>
A list of all security associations in the kernel tables can be obtained using the <a class="link-man" href="../html8/ipsecctl.html">ipsecctl(8)</a> command.</div>
</div>
<div class="section">
<h1 id="x444941474e4f5354494353">DIAGNOSTICS</h1> A socket operation may fail with one of the following errors returned:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">EACCES</span>]</dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
An attempt was made to lower the security level below the system default by a non-privileged process.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">EINVAL</span>]</dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
The length of option field did not match or an unknown security level was given.</dd>
</dl>
<div class="spacer">
</div>
<a class="link-man" href="../html1/netstat.html">netstat(1)</a> can be used to obtain some statistics about AH and ESP usage, using the <b class="flag">-p</b> flag. Using the <b class="flag">-r</b> flag, <a class="link-man" href="../html1/netstat.html">netstat(1)</a> displays information about IPsec flows.<div class="spacer">
</div>
<a class="link-man" href="../html8/vmstat.html">vmstat(8)</a> displays information about memory use by IPsec with the <b class="flag">-m</b> flag (look for &#8220;tdb&#8221; and &#8220;xform&#8221; allocations).</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html4/enc.html">enc(4)</a>, <a class="link-man" href="../html4/options.html">options(4)</a>, <a class="link-man" href="../html5/ipsec.conf.html">ipsec.conf(5)</a>, <a class="link-man" href="../html8/iked.html">iked(8)</a>, <a class="link-man" href="../html8/ipsecctl.html">ipsecctl(8)</a>, <a class="link-man" href="../html8/isakmpd.html">isakmpd(8)</a>, <a class="link-man" href="../html8/sysctl.html">sysctl(8)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> IPsec was originally designed to provide security services for Internet Protocol IPv6. It has since been engineered to provide those services for the original Internet Protocol, IPv4.<div class="spacer">
</div>
The IPsec protocol design process was started in 1992 by John Ioannidis, Phil Karn, and William Allen Simpson. In 1995, the former wrote an implementation for <span class="unix">BSD/OS</span>. Angelos D. Keromytis ported it to <span class="unix">OpenBSD</span> and <span class="unix">NetBSD</span>. The latest transforms and new features were implemented by Angelos D. Keromytis and Niels Provos.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> The authors of the IPsec code proper are <span class="author">John Ioannidis</span>, <span class="author">Angelos D. Keromytis</span>, and <span class="author">Niels Provos</span>.<div class="spacer">
</div>
<span class="author">Niklas Hallqvist</span> and <span class="author">Niels Provos</span> are the authors of <a class="link-man" href="../html8/isakmpd.html">isakmpd(8)</a>.<div class="spacer">
</div>
<span class="author">Eric Young</span>'s libdeslite was used in this implementation for the DES algorithm.<div class="spacer">
</div>
<span class="author">Steve Reid</span>'s SHA-1 code was also used.<div class="spacer">
</div>
The <a class="link-man" href="../html2/setsockopt.html">setsockopt(2)</a>/<a class="link-man" href="../html2/getsockopt.html">getsockopt(2)</a> interface follows somewhat loosely the draft-mcdonald-simple-ipsec-api (since expired, but still available from <a class="link-ext" href="ftp://ftp.kame.net/pub/internet-drafts/">ftp://ftp.kame.net/pub/internet-drafts/</a>).</div>
<div class="section">
<h1 id="x42554753">BUGS</h1> There's a lot more to be said on this subject. This is just a beginning. At the moment the socket options are not fully implemented.</div>
</div>
</body>
</html>

