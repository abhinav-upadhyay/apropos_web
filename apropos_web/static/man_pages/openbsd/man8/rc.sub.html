<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
RC.SUBR(8)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">rc.subr</b> &#8212; <span class="desc">daemon control scripts routines</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1><table class="synopsis">
<col style="width: 7.00ex;"/>
<col/>
<tbody>
<tr>
<td>
daemon=<i class="arg">path_to_executable</i></td>
<td>
</td>
</tr>
</tbody>
</table>
<br/>
<table class="synopsis">
<col style="width: 7.00ex;"/>
<col/>
<tbody>
<tr>
<td>
.</td>
<td>
<i class="file">/etc/rc.d/rc.subr</i></td>
</tr>
</tbody>
</table>
<br/>
<table class="synopsis">
<col style="width: 7.00ex;"/>
<col/>
<tbody>
<tr>
<td>
rc_cmd</td>
<td>
<i class="arg">action</i></td>
</tr>
</tbody>
</table>
</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> Apart from a few notable exceptions, rc scripts must follow this naming policy:<div class="spacer">
</div>
<ol style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-enum">
<li class="list-enum" style="margin-top: 0.00em;">
Use the same name as the <b class="name">daemon</b> it is referring to.</li>
<li class="list-enum" style="margin-top: 0.00em;">
Dashes (&#8216;-&#8217;) have to be converted to underscores (&#8216;_&#8217;).</li>
</ol>
<div class="spacer">
</div>
Every script under <i class="file">/etc/rc.d</i> follows this pattern:<div class="spacer">
</div>
<ol style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-enum">
<li class="list-enum" style="margin-top: 0.00em;">
Define the <b class="var">daemon</b> variable.</li>
<li class="list-enum" style="margin-top: 0.00em;">
Define service-specific defaults for one or more <b class="var">daemon_*</b> variables (optional).</li>
<li class="list-enum" style="margin-top: 0.00em;">
Source <b class="name">rc.subr</b>, which defines default shell functions and variable values.</li>
<li class="list-enum" style="margin-top: 0.00em;">
Override the <b class="var">pexp</b> variable or any of the <b class="cmd">rc_*</b> functions and set the <b class="var">rc_bg</b> or <b class="var">rc_reload</b> variables, if needed.</li>
<li class="list-enum" style="margin-top: 0.00em;">
Define an <b class="cmd">rc_pre</b> and/or <b class="cmd">rc_post</b> function, if needed.</li>
<li class="list-enum" style="margin-top: 0.00em;">
Call the <b class="cmd">rc_cmd</b> function as &#8220;rc_cmd $1&#8221;.</li>
</ol>
<div class="spacer">
</div>
The following shell functions are defined by <b class="name">rc.subr</b>:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">rc_cmd</b> <i class="arg">action</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Run the <i class="arg">action</i> for the current <b class="name">rc.d</b> script, based on the settings of various shell variables. <b class="cmd">rc_cmd</b> is extremely flexible, and allows fully functional <b class="name">rc.d</b> scripts to be implemented in a small amount of shell code. For a given <i class="arg">action</i>, if the <b class="cmd">rc_${action}</b> function is not defined, then a default function is provided by <b class="name">rc.subr</b>. In addition actions can be disabled by setting the <b class="var">rc_${action}</b> variable to &#8220;NO&#8221;. For example, if &#8220;rc_reload=NO&#8221; is set in the <b class="name">rc.d</b> script, and <b class="cmd">rc_cmd</b> is called for the reload action, an error will be raised. Similarly, the special variable <b class="var">rc_usercheck</b> must be set to &#8220;NO&#8221; if the <b class="flag">check</b> <i class="arg">action</i> requires root privileges.<div class="spacer">
</div>
The <i class="arg">action</i> argument can be <b class="flag">start</b>, <b class="flag">stop</b>, <b class="flag">reload</b>, <b class="flag">restart</b>, or <b class="flag">check</b>:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">check</b></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Call <b class="cmd">rc_check</b>. Return 0 if the daemon is running or 1 if it is not.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">start</b></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Check that the service is running by calling <b class="cmd">rc_check</b>. If it's not running, call <b class="cmd">rc_pre</b> if it exists, then <b class="cmd">rc_start</b>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">stop</b></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Check that the service is running by calling <b class="cmd">rc_check</b>. If it is running, call <b class="cmd">rc_stop</b> and wait up to 30 seconds for the daemon to properly shutdown. If successful, run <b class="cmd">rc_post</b> if it exists.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">restart</b></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Run the <i class="arg">action</i> argument <b class="flag">stop</b>, then if successful run <b class="flag">start</b>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">reload</b></dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Check that the service is running by calling <b class="cmd">rc_check</b>. If it is running, call <b class="cmd">rc_reload</b>.</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">rc_check</b></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Search for processes of the service with <a class="link-man" href="../html1/pgrep.html">pgrep(1)</a> using the regular expression given in the <b class="var">pexp</b> variable.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">rc_start</b></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Start the daemon. Defaults to:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
${rcexec} &quot;${daemon} ${daemon_flags} ${_bg}&quot;</pre>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">rc_stop</b></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Stop the daemon. Send a <span class="define">SIGTERM</span> signal using <a class="link-man" href="../html1/pkill.html">pkill(1)</a> on the regular expression given in the <b class="var">pexp</b> variable.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">rc_reload</b></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Send a <span class="define">SIGHUP</span> signal using <a class="link-man" href="../html1/pkill.html">pkill(1)</a> on the regular expression given in the <b class="var">pexp</b> variable. One has to make sure that sending <span class="define">SIGHUP</span> to a daemon will have the desired effect, i.e. that it will reload its configuration.</dd>
</dl>
</div>
<div class="section">
<h1 id="x454e5649524f4e4d454e54">ENVIRONMENT</h1> <b class="cmd">rc_cmd</b> uses the following shell variables to control its behaviour.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="var">daemon</b></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
The path to the daemon, optionally followed by one or more whitespace separated arguments. Arguments included here are always used, even if <b class="var">daemon_flags</b> is empty. This variable is required. It is an error to source <b class="name">rc.subr</b> without defining <b class="var">daemon</b> first.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="var">daemon_class</b></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
Login class to run the daemon with, using <a class="link-man" href="../html1/su.html">su(1)</a>. This is a read only variable that gets set by <b class="name">rc.subr</b> itself. It searches <a class="link-man" href="../html5/login.conf.html">login.conf(5)</a> for a login class that has the same name as the <b class="name">rc.d</b> script itself and uses that. If no such login class exists then &#8220;daemon&#8221; will be used.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="var">daemon_flags</b></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
Arguments to call the daemon with.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="var">daemon_rtable</b></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
Routing table to run the daemon under, using <a class="link-man" href="../html8/route.html">route(8)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="var">daemon_timeout</b></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
Maximum time in seconds to wait for the <b class="flag">start</b> (only if <b class="var">rc_bg</b> is set), <b class="flag">stop</b> and <b class="flag">reload</b> actions to return. This is only guaranteed with the default <b class="cmd">rc_start</b>, <b class="cmd">rc_stop</b> and <b class="cmd">rc_reload</b> functions.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="var">daemon_user</b></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
User to run the daemon as, using <a class="link-man" href="../html1/su.html">su(1)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="var">pexp</b></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
A regular expression to be passed to <a class="link-man" href="../html1/pgrep.html">pgrep(1)</a> in order to find the desired process or to be passed to <a class="link-man" href="../html1/pkill.html">pkill(1)</a> to stop it. By default this variable contains the <b class="var">daemon</b> and <b class="var">daemon_flags</b> variables. To override the default value, an <b class="name">rc.d</b> script has to redefine this variable <span class="emph">after</span> sourcing <b class="name">rc.subr</b>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="var">rc_bg</b></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
Can be set to <b class="flag">YES</b> in an <b class="name">rc.d</b> script to force starting the daemon in background when using the default <b class="cmd">rc_start</b>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="var">rc_reload</b></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
Can be set to &#8220;NO&#8221; in an <b class="name">rc.d</b> script to disable the reload action if the respective daemon does not support reloading its configuration. The same is possible, but almost never useful, for other actions.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="var">rc_usercheck</b></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
Can be set to &#8220;NO&#8221; in an <b class="name">rc.d</b> script, if the <b class="flag">check</b> action needs root privileges.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="var">rcexec</b></dt>
<dd class="list-tag" style="margin-left: 14.00ex;">
Holds the full <a class="link-man" href="../html1/su.html">su(1)</a> command used to run the daemon. Defaults to:<div class="spacer">
</div>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit">su -l -c ${daemon_class} -s /bin/sh ${daemon_user} -c</code></div>
</blockquote>
</dd>
</dl>
If <b class="var">daemon_rtable</b> is set, the following <a class="link-man" href="../html8/route.html">route(8)</a> command is prepended to <b class="var">rcexec</b>:<div class="spacer">
</div>
<blockquote style="margin-top: 0.00em;margin-bottom: 0.00em;">
<div class="display">
<code class="lit">route -T ${daemon_rtable}</code></div>
</blockquote>
<div class="spacer">
</div>
All <b class="var">daemon_*</b> variables are set in the following ways:<ol style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-enum">
<li class="list-enum" style="margin-top: 1.00em;">
Global defaults are provided by <b class="name">rc.subr</b>:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
daemon_class=daemon 
daemon_flags= 
daemon_rtable=0 
daemon_timeout=30 
daemon_user=root</pre>
</li>
<li class="list-enum" style="margin-top: 1.00em;">
Service-specific defaults may be provided in the respective <b class="name">rc.d</b> script <span class="emph">before</span> sourcing <b class="name">rc.subr</b>, thus overriding the global defaults.</li>
<li class="list-enum" style="margin-top: 1.00em;">
As noted in <a class="link-man" href="../html8/rc.d.html">rc.d(8)</a>, site-specific values provided in <a class="link-man" href="../html8/rc.conf.local.html">rc.conf.local(8)</a> for <b class="var">daemon_flags</b>, <b class="var">daemon_rtable</b>, <b class="var">daemon_timeout</b>, and <b class="var">daemon_user</b> will override those defaults.</li>
</ol>
</div>
<div class="section">
<h1 id="x46494c4553">FILES</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="file">/etc/rc.d/</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Directory containing daemon control scripts.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="file">/etc/rc.d/rc.subr</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Functions and variables used by <b class="name">rc.d</b> scripts.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="file">/usr/ports/infrastructure/templates/rc.template</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
A sample <b class="name">rc.d</b> script.</dd>
</dl>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html8/rc.html">rc(8)</a>, <a class="link-man" href="../html8/rc.conf.html">rc.conf(8)</a>, <a class="link-man" href="../html8/rc.d.html">rc.d(8)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">rc.subr</b> framework first appeared in <span class="unix">OpenBSD&#160;4.9</span>.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> The <b class="name">rc.subr</b> framework was written by <span class="author">Robert Nagy</span> &lt;<a class="link-mail" href="mailto:robert@openbsd.org">robert@openbsd.org</a>&gt;, <span class="author">Antoine Jacoutot</span> &lt;<a class="link-mail" href="mailto:ajacoutot@openbsd.org">ajacoutot@openbsd.org</a>&gt;, and <span class="author">Ingo Schwarze</span> &lt;<a class="link-mail" href="mailto:schwarze@openbsd.org">schwarze@openbsd.org</a>&gt;.</div>
</div>
</body>
</html>

