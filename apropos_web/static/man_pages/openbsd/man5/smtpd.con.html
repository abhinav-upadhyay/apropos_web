<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
SMTPD.CONF(5)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">smtpd.conf</b> &#8212; <span class="desc">Simple Mail Transfer Protocol daemon configuration file</span></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> <b class="name">smtpd.conf</b> is the configuration file for the mail daemon <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a>.<div class="spacer">
</div>
The current line can be extended over multiple lines using a backslash (&#8216;\&#8217;). Comments can be put anywhere in the file using a hash mark (&#8216;#&#8217;), and extend to the end of the current line. Care should be taken when commenting out multi-line text: the comment is effective until the end of the entire block.<div class="spacer">
</div>
Argument names not beginning with a letter, digit, or underscore must be quoted. Arguments containing whitespace should be surrounded by double quotes (&quot;).<div class="spacer">
</div>
Macros can be defined that will later be expanded in context. Macro names must start with a letter, digit, or underscore, and may contain any of those characters. Macro names may not be reserved words (for example <i class="arg">listen</i>, <i class="arg">accept</i>, <i class="arg">port</i>). Macros are not expanded inside quotes.<div class="spacer">
</div>
For example:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
lan_addr = &quot;192.168.0.1&quot; 
listen on $lan_addr 
listen on $lan_addr tls auth</pre>
<div class="spacer">
</div>
Additional configuration files can be included with the <b class="cmd">include</b> keyword, for example:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
include &quot;/etc/mail/smtpd.conf.local&quot;</pre>
<div class="spacer">
</div>
The syntax of <b class="name">smtpd.conf</b> is described below.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">accept</b> | <b class="cmd">reject</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
<a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> accepts and rejects messages based on information gathered during the SMTP session.<div class="spacer">
</div>
For each message processed by the daemon, the rules are evaluated in sequential order, from first to last. The first matching rule decides what action is taken. If no rule matches the message, the default action is to reject the message. An exclamation mark may be specified to perform a reverse match.<div class="spacer">
</div>
Following the accept/reject decision comes the optional tag matching:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">tagged</b> [<span class="opt"><b class="cmd">!</b></span>] <i class="arg">tag</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
If specified, the rule will only be matched if the client session was tagged with <i class="arg">tag</i>.</dd>
</dl>
<div class="spacer">
</div>
After that the client's IP address rule is specified:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">from any</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Make the rule match regardless of the IP of connecting client.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">from</b> [<span class="opt"><b class="cmd">!</b></span>] <b class="cmd">local</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The rule matches only locally originating connections. This is the default, and may be omitted.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">from</b> [<span class="opt"><b class="cmd">!</b></span>] <b class="cmd">source</b> &lt;<i class="arg">table</i>&gt;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The rule matches if the connection is made from a client whose address is declared in the table <i class="arg">table</i>.</dd>
</dl>
<div class="spacer">
</div>
In addition, finer access control may be achieved on the sender if desired:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">sender</b> [<span class="opt"><b class="cmd">!</b></span>] &lt;<i class="arg">senders</i>&gt;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
If specified, the rule will only be matched if the sender email address is found in the table <i class="arg">senders</i>. The table may contain complete email addresses or apply to an entire domain if prefixed with &#8216;@&#8217;.</dd>
</dl>
<div class="spacer">
</div>
Next comes the selection based on the domain the message is sent to:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for any</b> [<span class="opt"><b class="cmd">alias</b> <code class="none">&lt;</code><i class="arg">aliases</i>&gt;</span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Make the rule match regardless of the domain it is sent to. If specified, the table <i class="arg">aliases</i> is used for looking up alternative destinations for all addresses.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for any virtual</b> <code class="none">&lt;</code><i class="arg">vmap</i>&gt;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Make the rule match regardless of the domain it is sent to. The <i class="arg">vmap</i> table will be used as the virtual domain mapping.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for</b> [<span class="opt"><b class="cmd">!</b></span>] <b class="cmd">domain</b> <i class="arg">domain</i> [<span class="opt"><b class="cmd">alias</b> <code class="none">&lt;</code><i class="arg">aliases</i>&gt;</span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This rule applies to mail destined for the specified <i class="arg">domain</i>. This parameter supports the &#8216;*&#8217; wildcard, so that a single rule for all sub-domains can be used, for example:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
accept for domain &quot;*.example.com&quot; deliver to mbox</pre>
<div class="spacer">
</div>
If specified, the table <i class="arg">aliases</i> is used for looking up alternative destinations for addresses in this <i class="arg">domain</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for</b> [<span class="opt"><b class="cmd">!</b></span>] <b class="cmd">domain</b> &lt;<i class="arg">domains</i>&gt; [<span class="opt"><b class="cmd">alias</b> <code class="none">&lt;</code><i class="arg">aliases</i>&gt;</span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This rule applies to mail destined to domains which are part of the table <i class="arg">domains</i>.<div class="spacer">
</div>
If specified, the table <i class="arg">aliases</i> is used for looking up alternative destinations for addresses in these <i class="arg">domains</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for</b> [<span class="opt"><b class="cmd">!</b></span>] <b class="cmd">domain</b> <i class="arg">domain</i> <b class="cmd">virtual</b> <code class="none">&lt;</code><i class="arg">users</i>&gt;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This rule applies to mail destined for the specified virtual <i class="arg">domain</i>. This parameter supports the &#8216;*&#8217; wildcard, so that a single rule for all sub-domains can be used, for example:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
accept for domain &quot;*.example.com&quot; \ 
       virtual &lt;users&gt; deliver to mbox</pre>
<div class="spacer">
</div>
The table <i class="arg">users</i> holds a key-value mapping of virtual to system users. For an example of how to configure the <i class="arg">users</i> table, see <a class="link-man" href="../html5/table.html">table(5)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for</b> [<span class="opt"><b class="cmd">!</b></span>] <b class="cmd">domain</b> &lt;<i class="arg">domains</i>&gt; <b class="cmd">virtual</b> <code class="none">&lt;</code><i class="arg">users</i>&gt;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This rule applies to mail destined for the virtual domains specified in the table <i class="arg">domains</i>.<div class="spacer">
</div>
The table <i class="arg">users</i> holds a key-value mapping of virtual to system users. For an example of how to configure the <i class="arg">users</i> table, see <a class="link-man" href="../html5/table.html">table(5)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for</b> [<span class="opt"><b class="cmd">!</b></span>] <b class="cmd">local</b> [<span class="opt"><b class="cmd">alias</b> <code class="none">&lt;</code><i class="arg">aliases</i>&gt;</span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This rule applies to mail destined to &#8220;localhost&#8221; and to the default server name. See the <i class="link-sec"><a class="link-sec" href="#x46494c4553">FILES</a></i> entry for <i class="file">/etc/mail/mailname</i> below for details of how the server name is determined.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">for</b> [<span class="opt"><b class="cmd">!</b></span>] <b class="cmd">local</b> <b class="cmd">virtual</b> <code class="none">&lt;</code><i class="arg">vmap</i>&gt;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
This rule applies to mail destined to &#8220;localhost&#8221; and to the default server name. The <i class="arg">vmap</i> table will be used as the virtual domain mapping.</dd>
</dl>
<div class="spacer">
</div>
Further access control may be achieved on specific recipients if desired:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">recipient</b> [<span class="opt"><b class="cmd">!</b></span>] &lt;<i class="arg">recipients</i>&gt;</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
If specified, the rule will only be matched if the recipient email address is found in the table <i class="arg">recipients</i>. The table may contain complete email addresses or apply to an entire domain if prefixed with &#8216;@&#8217;.</dd>
</dl>
<div class="spacer">
</div>
If the method of delivery is local, a user database may be specified to override the system database:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="opt"><b class="cmd">userbase</b> <code class="none">&lt;</code><i class="arg">table</i>&gt;</span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Look up users in the table <i class="arg">table</i> instead of performing system lookups using the <a class="link-man" href="../html3/getpwnam.html">getpwnam(3)</a> function.</dd>
</dl>
<div class="spacer">
</div>
You can also accept mail just to have it forwarded elsewhere:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">forward-only</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Mail is accepted for local recipients ONLY if it is redirected to an external address via an alias or a ~/.forward file.<div class="spacer">
</div>
Example:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
accept for domain opensmtpd.org forward-only</pre>
</dd>
</dl>
<div class="spacer">
</div>
Finally, the method of delivery is specified:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">deliver to lmtp</b> [<span class="opt"><i class="arg">host</i>:<i class="arg">port</i> | <i class="arg">socket</i></span>] [<span class="opt"><b class="cmd">rcpt-to</b></span>] [<span class="opt"><b class="cmd">as</b> <i class="arg">user</i></span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Mail is delivered to <i class="arg">host</i>:<i class="arg">port</i>, or to the <span class="unix">UNIX</span> <i class="arg">socket</i> over LMTP with the privileges of the specified <i class="arg">user</i>.<div class="spacer">
</div>
Optionally, <b class="cmd">rcpt-to</b> might be specified to use the recipient email address (after expansion) instead of the local user in the LMTP session as RCPT TO.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">deliver to maildir</b> [<span class="opt"><i class="arg">path</i></span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Mail is added to a maildir. Its location, <i class="arg">path</i>, may contain format specifiers that are expanded before use (see <i class="link-sec"><a class="link-sec" href="#x464f524d41542053504543494649455253">FORMAT SPECIFIERS</a></i>). If <i class="arg">path</i> is not provided, then <i class="file">~/Maildir</i> is assumed.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">deliver to mbox</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Mail is delivered to the local user's system mailbox in <i class="file">/var/mail</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">deliver to mda</b> <i class="arg">program</i> [<span class="opt"><b class="cmd">as</b> <i class="arg">user</i></span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Mail is piped to the specified <i class="arg">program</i>, which is run with the privileges of the specified <i class="arg">user</i> or the user the message is destined to. This parameter may use conversion specifiers that are expanded before use (see <i class="link-sec"><a class="link-sec" href="#x464f524d41542053504543494649455253">FORMAT SPECIFIERS</a></i>).</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">relay</b> [<span class="opt"><b class="cmd">backup</b>&#160;[<span class="opt"><i class="arg">mx</i></span>]</span>] [<span class="opt"><b class="cmd">as</b>&#160;<i class="arg">address</i></span>] [<span class="opt"><b class="cmd">source</b>&#160;<code class="none">&lt;</code><i class="arg">source</i>&gt;</span>] [<span class="opt"><b class="cmd">hostname</b>&#160;<i class="arg">name</i></span>] [<span class="opt"><b class="cmd">hostnames</b>&#160;<code class="none">&lt;</code><i class="arg">names</i>&gt;</span>] [<span class="opt"><b class="cmd">pki</b>&#160;<i class="arg">pkiname</i></span>] [<span class="opt"><b class="cmd">tls</b>&#160;[<span class="opt"><b class="cmd">verify</b></span>]</span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
<div class="spacer">
</div>
Mail is relayed. The routing decision is based on the DNS system.<div class="spacer">
</div>
If the <b class="cmd">backup</b> parameter is specified, the current server will act as a backup server for the target domain. Accepted mails are only relayed through servers with a lower preference value in the MX record for the domain than the one specified in <i class="arg">mx</i>. If <i class="arg">mx</i> is not specified, the default server name will be assumed.<div class="spacer">
</div>
If the <b class="cmd">as</b> parameter is specified, <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> will rewrite the sender advertised in the SMTP session. <i class="arg">address</i> may be a user, a domain prefixed with &#8216;@&#8217;, or an email address, causing <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> to rewrite the user-part, the domain-part, or the entire address, respectively.<div class="spacer">
</div>
If the <b class="cmd">source</b> parameter is specified, <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> will explicitly bind to an address found in the table referenced by <i class="arg">source</i> when connecting to the relay. If the table contains more than one address, they are picked in turn each time a new connection is opened.<div class="spacer">
</div>
By default, when connecting to a remote server, <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> advertises its default server name. A <b class="cmd">hostname</b> parameter may be specified to advertise the alternate hostname <i class="arg">name</i>. If the <b class="cmd">source</b> parameter is used, the <b class="cmd">hostnames</b> parameter may be specified to advertise a hostname based on the source address. Table <i class="arg">names</i> contains a mapping of IP addresses to hostnames and <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> will automatically select the name that matches its source address when connected to the remote server. The <b class="cmd">hostname</b> and <b class="cmd">hostnames</b> parameters are mutually exclusive.<div class="spacer">
</div>
When relaying, STARTTLS is always attempted if available on remote host and <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> will try to present a certificate matching the outgoing hostname if one is registered in the pki. If <b class="cmd">pki</b> is specified, the certificate registered for <i class="arg">pkiname</i> is used instead.<div class="spacer">
</div>
If <b class="cmd">tls</b> is specified, <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> will refuse to relay unless the remote host provides STARTTLS. If <b class="cmd">tls verify</b> is specified, <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> will refuse to relay unless the remote host provides STARTTLS and the certificate it presented has been verified.<div class="spacer">
</div>
Note that the <b class="cmd">tls</b> and <b class="cmd">tls verify</b> options should only be used in private networks as they will prevent proper relaying on the Internet.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">relay via</b> <i class="arg">host</i> [<span class="opt"><b class="cmd">auth</b> <code class="none">&lt;</code><i class="arg">auth</i>&gt;</span>] [<span class="opt"><b class="cmd">as</b> <i class="arg">address</i></span>] [<span class="opt"><b class="cmd">source</b> <code class="none">&lt;</code><i class="arg">source</i>&gt;</span>] [<span class="opt"><b class="cmd">hostname</b> <i class="arg">name</i></span>] [<span class="opt"><b class="cmd">hostnames</b> <code class="none">&lt;</code><i class="arg">names</i>&gt;</span>] [<span class="opt"><b class="cmd">pki</b> <i class="arg">pkiname</i></span>] [<span class="opt"><b class="cmd">verify</b></span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
<div class="spacer">
</div>
Mail is relayed through the specified <i class="arg">host</i> expressed as a URL. For example:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
smtp://mx1.example.org		# use SMTP 
smtp://mx1.example.org:4321	# use SMTP \ 
				# with port 4321 
lmtp://localhost:2026		# use LMTP \ 
				# with port 2026</pre>
<div class="spacer">
</div>
The communication channel may be secured using one of the secure schemas. For example:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
tls://mx1.example.org		# use TLS 
smtps://mx1.example.org		# use SMTPS 
secure://mx1.example.org	# try SMTPS and \ 
				# fallback to TLS</pre>
<div class="spacer">
</div>
In addition, credentials for authenticated relaying may be provided when using a secure schema. For example:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
tls+auth://label@mx.example.org	    # over TLS 
smtps+auth://label@mx.example.org   # over SMTPS 
secure+auth://label@mx.example.org  # over either \ 
				    # SMTPS or TLS</pre>
<div class="spacer">
</div>
If a pki entry exists for the outgoing hostname, or one is provided with <i class="arg">pkiname</i>, the associated certificate will be sent to the remote server.<div class="spacer">
</div>
If an SMTPAUTH session with <i class="arg">host</i> is desired, the <b class="cmd">auth</b> parameter is used to specify the <i class="arg">auth</i> table that holds the credentials. Credentials will be looked up using the label provided in the URL.<div class="spacer">
</div>
If the <b class="cmd">as</b> parameter is specified, <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> will rewrite the sender advertised in the SMTP session. <i class="arg">address</i> may be a user, a domain prefixed with &#8216;@&#8217;, or an email address, causing <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> to rewrite the user-part, the domain-part, or the entire address, respectively.<div class="spacer">
</div>
If the <b class="cmd">source</b> parameter is specified, <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> will explicitly bind to an address found in the table referenced by &lt;<i class="arg">source</i>&gt; when connecting to the relay. If the table contains more than one address, they are picked in turn each time a new connection is opened.<div class="spacer">
</div>
By default, when connecting to a remote server, <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> advertises its default server name. A <b class="cmd">hostname</b> parameter may be specified to advertise the alternate hostname <i class="arg">name</i>. If the <b class="cmd">source</b> parameter is used, the <b class="cmd">hostnames</b> parameter may be specified to advertise a hostname based on the source address. Table <i class="arg">names</i> contains a mapping of IP addresses to hostnames and <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> will automatically select the name that matches its source address when connected to the remote server. The <b class="cmd">hostname</b> and <b class="cmd">hostnames</b> parameters are mutually exclusive.<div class="spacer">
</div>
If <b class="cmd">verify</b> is specified, <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> will refuse to relay unless the remote host provides STARTTLS and the certificate it presented has been verified. The relay URL must specify TLS for this option to be valid.</dd>
</dl>
<div class="spacer">
</div>
Additional per-rule adjustments are available:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">expire</b> <i class="arg">n</i>{<b class="flag">s</b>|<b class="flag">m</b>|<b class="flag">h</b>|<b class="flag">d</b>}</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify how long a message that matched this rule can stay in the queue.</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">bounce-warn</b> <i class="arg">n</i>{<b class="flag">s</b>|<b class="flag">m</b>|<b class="flag">h</b>|<b class="flag">d</b>}[<span class="opt">, <i class="arg">...</i></span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify the delays for which temporary failure reports must be generated when messages are stuck in the queue. For example:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
bounce-warn	1h, 6h, 2d</pre>
<div class="spacer">
</div>
will generate a failure report when an envelope is in the queue for more than one hour, six hours and two days. The default is 4h.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">ca</b> <i class="arg">hostname</i> <b class="cmd">certificate</b> <i class="arg">cafile</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Associate a custom CA certificate located in <i class="arg">cafile</i> with <i class="arg">hostname</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">ciphers</b> <i class="arg">cipher-list</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify an alternate list of ciphers to use when establishing TLS sessions. It is highly recommended to avoid making use of this option unless there is a good understanding of the implications.<div class="spacer">
</div>
When not specified, only ciphers considered safe are chosen.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">expire</b> <i class="arg">n</i>{<b class="flag">s</b>|<b class="flag">m</b>|<b class="flag">h</b>|<b class="flag">d</b>}</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify how long a message can stay in the queue. The default value is 4d. For example:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
expire 4d	# expire after 4 days 
expire 10h	# expire after 10 hours</pre>
</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">filter</b> <i class="arg">name filter</i> [<span class="opt"><i class="arg">arguments</i></span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify a filter with the given <i class="arg">name</i> and the program <i class="arg">filter</i> using the given filter <i class="arg">arguments</i>. Filters are used to hook into the SMTP dialog and provide additional filtering options for <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">filter</b> <i class="arg">name</i> <b class="cmd">chain</b> <i class="arg">filter</i> <i class="arg">...</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify a filter chain with the given <i class="arg">name</i> and filters.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">limit session</b> {<b class="flag">max-rcpt</b> | <b class="flag">max-mails</b>} <i class="arg">num</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Instruct <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> to accept a maximum number of recipients or emails at once in the receiving queue. Defaults are 100 for <b class="cmd">max-mails</b> and 1000 for <b class="cmd">max-rcpt</b>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">limit mta</b> [<span class="opt"><b class="cmd">for</b> <b class="cmd">domain</b> <i class="arg">domain</i></span>] <i class="arg">family</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Instruct <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> to only use the specified address <i class="arg">family</i> for outgoing connections. Accepted values are <b class="cmd">inet4</b> and <b class="cmd">inet6</b>. If a <i class="arg">domain</i> is specified, the restriction only applies when connecting to MXs for this domain.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">limit scheduler max-inflight</b> <i class="arg">num</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Suspend the scheduling of envelopes for deliver/relay until the number of inflight envelopes falls below <i class="arg">num</i>. Changing the default value might degrade performance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">listen on socket</b> [<span class="opt"><b class="cmd">filter</b> <i class="arg">name</i></span>] [<span class="opt"><b class="cmd">mask-source</b></span>]<div style="height: 0.00em;">
&#160;</div>
<b class="cmd">listen on</b>&#160;<i class="arg">interface</i> [<span class="opt"><i class="arg">family</i></span>] [<span class="opt"><b class="cmd">port</b>&#160;<i class="arg">port</i></span>] [<span class="opt"><b class="cmd">filter</b>&#160;<i class="arg">name</i></span>] [<span class="opt"><b class="cmd">tls</b>&#160;|&#160;<b class="cmd">tls-require</b>&#160;|&#160;<b class="cmd">tls-require&#160;verify</b>&#160;|&#160;<b class="cmd">smtps</b>&#160;|&#160;<b class="cmd">secure</b></span>] [<span class="opt"><b class="cmd">pki</b>&#160;<i class="arg">pkiname</i></span>] [<span class="opt"><b class="cmd">ca</b>&#160;<i class="arg">caname</i></span>] [<span class="opt"><b class="cmd">auth</b>&#160;|&#160;<b class="cmd">auth-optional</b>&#160;[<span class="opt">&lt;<i class="arg">authtable</i>&gt;</span>]</span>] [<span class="opt"><b class="cmd">tag</b>&#160;<i class="arg">tag</i></span>] [<span class="opt"><b class="cmd">hostname</b>&#160;<i class="arg">hostname</i></span>] [<span class="opt"><b class="cmd">hostnames</b>&#160;<code class="none">&lt;</code><i class="arg">names</i>&gt;</span>] [<span class="opt"><b class="cmd">senders</b>&#160;<code class="none">&lt;</code><i class="arg">users</i>&gt;&#160;[<span class="opt">masquerade</span>]</span>] [<span class="opt"><b class="cmd">mask-source</b></span>] [<span class="opt"><b class="cmd">received-auth</b></span>] [<span class="opt"><b class="cmd">no-dsn</b></span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
<div class="spacer">
</div>
Specify a <b class="cmd">socket</b> or an <i class="arg">interface</i> to listen on for incoming connections. The <b class="cmd">listen on socket</b> directive is used to modify the behavior of the listener handling messages submitted through the local enqueuer, for example via the <a class="link-man" href="../html1/mail.html">mail(1)</a> utility. This is an optional directive: if unspecified then <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> will simply listen for connections on the <b class="cmd">socket</b> as if it was configured with no option. Clients connecting through the <b class="cmd">socket</b> will always be tagged with the 'local' <b class="cmd">tag</b>.<div class="spacer">
</div>
To listen on a specific network interface, specify an <i class="arg">interface</i> and an optional <i class="arg">port</i>. An interface group, an IP address or a domain name may be used in place of <i class="arg">interface</i>. The <i class="arg">family</i> parameter can be used to listen only on specific address family. Accepted values are <b class="cmd">inet4</b> and <b class="cmd">inet6</b>.<div class="spacer">
</div>
A <b class="cmd">filter</b> may be specified to use a filter or filter chain with the given <i class="arg">name</i> on SMTP transactions.<div class="spacer">
</div>
Secured connections are provided either using STARTTLS (<b class="cmd">tls</b>), by default on port 25, or SMTPS (<b class="cmd">smtps</b>), by default on port 465. <b class="cmd">tls-require</b> may be used to force clients to establish a secure connection before being allowed to start an SMTP transaction.<div class="spacer">
</div>
If <b class="cmd">tls-require verify</b> is specified, the client must provide a valid certificate to be able to establish an SMTP session.<div class="spacer">
</div>
<b class="cmd">secure</b> may be specified to provide both STARTTLS and SMTPS services. Host certificates may be used for these connections, and must be previously declared using the pki directive. If <b class="cmd">pki</b> is specified, a certificate matching <b class="cmd">name</b> is searched for. Moreover, a previously declared <b class="cmd">ca</b> directive may be specified to use a custom CA certificate.<div class="spacer">
</div>
If the <b class="cmd">auth</b> parameter is used, then a client may only start an SMTP transaction after a successful authentication. Any remote sender that passed SMTPAUTH is treated as if it was the server's local user that was sending the mail. This means that filter rules using <b class="cmd">from local</b> will be matched. If <b class="cmd">auth-optional</b> is specified, then SMTPAUTH is not required to establish an SMTP transaction. This is only useful to let a listener accept incoming mail from untrusted senders and outgoing mail from authenticated users in situations where it is not possible to listen on the submission port.<div class="spacer">
</div>
Both <b class="cmd">auth</b> and <b class="cmd">auth-optional</b> accept an optional table as a parameter. When provided, credentials are looked up in this table. The credentials format is described in <a class="link-man" href="../html5/table.html">table(5)</a>.<div class="spacer">
</div>
If the <b class="cmd">tag</b> parameter is used, then clients connecting to the listener will be tagged <i class="arg">tag</i>.<div class="spacer">
</div>
If the <b class="cmd">hostname</b> parameter is used, then it will be used in the greeting banner instead of the default server name.<div class="spacer">
</div>
The <b class="cmd">hostnames</b> parameter overrides the server name for specific addresses. Table <i class="arg">names</i> contains a mapping of IP addresses to hostnames and <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> will use the hostname that matches the address on which the connection arrives if it is found in the mapping.<div class="spacer">
</div>
If the <b class="cmd">senders</b> parameter is used, then <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> will look up a mapping of username to email addresses to see whether the authenticated user is allowed to submit mail as the sender that was provided in the SMTP session. In addition, if the masquerade option is provided, the From header will be rewritten to match the sender provided in the SMTP session.<div class="spacer">
</div>
If the <b class="cmd">mask-source</b> parameter is used, then the listener will skip the <b class="cmd">from</b> part when prepending the &#8220;Received&#8221; header.<div class="spacer">
</div>
If the <b class="cmd">received-auth</b> parameter is used, the &#8220;Received&#8221; header will display if the session was authenticated and by which local user.<div class="spacer">
</div>
If the <b class="cmd">no-dsn</b> parameter is used, DSN (Delivery Status Notification) extension will not be enabled.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">max-message-size</b> <i class="arg">n</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify a maximum message size of <i class="arg">n</i> bytes. The argument may contain a multiplier, as documented in <a class="link-man" href="../html3/scan_scaled.html">scan_scaled(3)</a>. The default maximum message size is 35MB if none is specified.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">pki</b> <i class="arg">hostname</i> <b class="cmd">certificate</b> <i class="arg">certfile</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Associate the certificate located in <i class="arg">certfile</i> with <i class="arg">hostname</i>.<div class="spacer">
</div>
If a fallback certificate or SNI is wanted, the &#8216;*&#8217; wildcard may be used as <i class="arg">hostname</i>.<div class="spacer">
</div>
A certificate chain may be created by appending one or many certificates, including a Certificate Authority certificate, to <i class="arg">certfile</i>.<div class="spacer">
</div>
Creation of certificates is documented in <a class="link-man" href="../html8/starttls.html">starttls(8)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">pki</b> <i class="arg">hostname</i> <b class="cmd">key</b> <i class="arg">keyfile</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Associate the key located in <i class="arg">keyfile</i> with <i class="arg">hostname</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">pki</b> <i class="arg">hostname</i> <b class="cmd">dhe</b> <i class="arg">params</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Specify the DHE parameters to use for DHE cipher suites with <i class="arg">hostname</i>. Valid parameter values are none, legacy and auto. For legacy a fixed key length of 1024 bits is used, whereas for auto the key length is determined automatically. The default is none, which disables DHE cipher suites.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">queue compression</b></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Enable transparent compression of envelopes and messages. The only supported algorithm at the moment is gzip. Envelopes and messages may be inspected using the <a class="link-man" href="../html8/smtpctl.html">smtpctl(8)</a> or <a class="link-man" href="../html1/gzcat.html">gzcat(1)</a> utilities.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">queue encryption</b> [<span class="opt">key <i class="arg">key</i></span>]</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Enable transparent encryption of envelopes and messages. <i class="arg">key</i> must be a 16-byte random key in hexadecimal representation. It can be obtained using the <a class="link-man" href="../html1/openssl.html">openssl(1)</a> utility as follow:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
$ openssl rand -hex 16</pre>
<div class="spacer">
</div>
If the <i class="arg">key</i> parameter is not specified, it is read with <a class="link-man" href="../html3/getpass.html">getpass(3)</a> at startup. If <i class="arg">key</i> is <b class="cmd">stdin</b>, then it is read from the standard input at startup.<div class="spacer">
</div>
The only supported algorithm is AES-256 in GCM mode. Envelopes and messages may be inspected using the <a class="link-man" href="../html8/smtpctl.html">smtpctl(8)</a> utility.<div class="spacer">
</div>
Queue encryption can be used with queue compression and will always perform compression before encryption.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">table</b> <i class="arg">name</i> [<span class="opt"><i class="arg">type</i>:</span>]<i class="arg">config</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Tables are used to provide additional configuration information for <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> in the form of lists or key-value mappings. The format of the entries depends on what the table is used for. Refer to <a class="link-man" href="../html5/table.html">table(5)</a> for the exhaustive documentation.<div class="spacer">
</div>
The table is identified using table name <i class="arg">name</i>; the name itself is arbitrarily chosen.<div class="spacer">
</div>
<i class="arg">type</i> specifies the table backend, and should be one of the following:<div class="spacer">
</div>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
db</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Information is stored in a file created using <a class="link-man" href="../html8/makemap.html">makemap(8)</a>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
file</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Information is stored in a plain text file using the same format as used to generate <a class="link-man" href="../html8/makemap.html">makemap(8)</a> mappings. This is the default.</dd>
</dl>
<div class="spacer">
</div>
<i class="arg">config</i> specifies a configuration file for the table data. It must be an absolute path to a file for the &#8220;file&#8221; and &#8220;db&#8221; table types.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">table</b> <i class="arg">name</i> {<i class="arg">value</i> [<span class="opt">, <i class="arg">...</i></span>]}</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Tables containing list of static values may be declared using an inlined notation.<div class="spacer">
</div>
The table is identified using table name <i class="arg">name</i>; the name itself is arbitrarily chosen.<div class="spacer">
</div>
The table must contain at least one value and may declare many values as a list of comma-separated strings.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="cmd">table</b> <i class="arg">name</i> {<i class="arg">key</i>=<i class="arg">value</i> [<span class="opt">, <i class="arg">...</i></span>]}</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Tables containing static key-value mappings may be declared using an inlined notation.<div class="spacer">
</div>
The table is identified using table name <i class="arg">name</i>; the name itself is arbitrarily chosen.<div class="spacer">
</div>
The table must contain at least one key-value mapping and may declare many mappings as a list of comma-separated <i class="arg">key</i>=<i class="arg">value</i> descriptions.</dd>
</dl>
<div class="subsection">
<h2 id="x464f524d41542053504543494649455253">FORMAT SPECIFIERS</h2> Some configuration directives support expansion of their parameters at runtime. Such directives (for example <b class="cmd">deliver to maildir</b>, <b class="cmd">deliver to mda</b>) may use format specifiers which will be expanded before delivery or relaying. The following formats are currently supported:<table style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-col">
<col style="min-width: 17.00ex;"/>
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{sender}</td>
<td class="list-col" style="margin-top: 1.00em;">
sender email address</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{sender.user}</td>
<td class="list-col" style="margin-top: 1.00em;">
user part of the sender email address</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{sender.domain}</td>
<td class="list-col" style="margin-top: 1.00em;">
domain part of the sender email address</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt}</td>
<td class="list-col" style="margin-top: 1.00em;">
recipient email address</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt.user}</td>
<td class="list-col" style="margin-top: 1.00em;">
user part of the recipient email address</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt.domain}</td>
<td class="list-col" style="margin-top: 1.00em;">
domain part of the recipient email address</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{dest}</td>
<td class="list-col" style="margin-top: 1.00em;">
recipient email address after expansion</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{dest.user}</td>
<td class="list-col" style="margin-top: 1.00em;">
user part after expansion</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{dest.domain}</td>
<td class="list-col" style="margin-top: 1.00em;">
domain part after expansion</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{user.username}</td>
<td class="list-col" style="margin-top: 1.00em;">
local user</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{user.directory}</td>
<td class="list-col" style="margin-top: 1.00em;">
home directory of the local user</td>
</tr>
</tbody>
</table>
<div class="spacer">
</div>
Expansion formats also support partial expansion using the optional bracket notations with substring offset. For example, with recipient domain &#8220;example.org&#8221;:<table style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-col">
<col style="min-width: 20.00ex;"/>
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt.domain[0]}</td>
<td class="list-col" style="margin-top: 1.00em;">
expands to &#8220;e&#8221;</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt.domain[1]}</td>
<td class="list-col" style="margin-top: 1.00em;">
expands to &#8220;x&#8221;</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt.domain[8:]}</td>
<td class="list-col" style="margin-top: 1.00em;">
expands to &#8220;org&#8221;</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt.domain[-3:]}</td>
<td class="list-col" style="margin-top: 1.00em;">
expands to &#8220;org&#8221;</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt.domain[0:6]}</td>
<td class="list-col" style="margin-top: 1.00em;">
expands to &#8220;example&#8221;</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt.domain[0:-4]}</td>
<td class="list-col" style="margin-top: 1.00em;">
expands to &#8220;example&#8221;</td>
</tr>
</tbody>
</table>
<div class="spacer">
</div>
In addition, modifiers may be applied to the token. For example, with recipient &#8220;User+Tag@Example.org&#8221;:<table style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-col">
<col style="min-width: 23.00ex;"/>
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt:lowercase}</td>
<td class="list-col" style="margin-top: 1.00em;">
expands to &#8220;user+tag@example.org&#8221;</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt:uppercase}</td>
<td class="list-col" style="margin-top: 1.00em;">
expands to &#8220;USER+TAG@EXAMPLE.ORG&#8221;</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt:strip}</td>
<td class="list-col" style="margin-top: 1.00em;">
expands to &#8220;User@Example.org&#8221;</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt:lowercase|strip}</td>
<td class="list-col" style="margin-top: 1.00em;">
expands to &#8220;user@example.org&#8221;</td>
</tr>
</tbody>
</table>
<div class="spacer">
</div>
For security concerns, expanded values are sanitized and potentially dangerous characters are replaced with &#8216;:&#8217;. In situations where they are desirable, the &#8220;raw&#8221; modifier may be applied. For example, with recipient &#8220;user+t?g@example.org&#8221;:<table style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-col">
<col style="min-width: 11.00ex;"/>
<tbody>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt}</td>
<td class="list-col" style="margin-top: 1.00em;">
expands to &#8220;user+t:g@example.org&#8221;</td>
</tr>
<tr class="list-col">
<td class="list-col" style="margin-top: 1.00em;">
%{rcpt:raw}</td>
<td class="list-col" style="margin-top: 1.00em;">
expands to &#8220;user+t?g@example.org&#8221;</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section">
<h1 id="x46494c4553">FILES</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="file">/etc/mail/smtpd.conf</i></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
Default <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> configuration file.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="file">/etc/mail/mailname</i></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
If this file exists, the first line is used as the server name. Otherwise, the server name is derived from the local hostname returned by <a class="link-man" href="../html3/gethostname.html">gethostname(3)</a>, either directly if it is a fully qualified domain name, or by retrieving the associated canonical name through <a class="link-man" href="../html3/getaddrinfo.html">getaddrinfo(3)</a>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="file">/var/spool/smtpd/</i></dt>
<dd class="list-tag" style="margin-left: 23.00ex;">
Spool directories for mail during processing.</dd>
</dl>
</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> The default <b class="name">smtpd.conf</b> file which ships with <span class="unix">OpenBSD</span> listens on the loopback network interface (lo0), and allows for mail from users and daemons on the local machine, as well as permitting email to remote servers. Some more complex configurations are given below.<div class="spacer">
</div>
This first example is the same as the default configuration, but all outgoing mail is forwarded to a remote SMTP server. A secrets file is needed to specify a username and password:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
# touch /etc/mail/secrets 
# chmod 640 /etc/mail/secrets 
# chown root:_smtpd /etc/mail/secrets 
# echo &quot;label username:password&quot; &gt; /etc/mail/secrets</pre>
<div class="spacer">
</div>
<b class="name">smtpd.conf</b> would look like this:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
table aliases file:/etc/mail/aliases 
table secrets file:/etc/mail/secrets 
 
listen on lo0 
 
accept for local alias &lt;aliases&gt; deliver to mbox 
accept for any relay via tls+auth://label@smtp.example.com \ 
	auth &lt;secrets&gt;</pre>
<div class="spacer">
</div>
In this second example, the aim is to permit mail relaying for any user that can authenticate using their normal login credentials. An RSA certificate must be provided to prove the server's identity. The mail server listens on all interfaces the default route(s) point to. Mail with a local destination should be sent to an external mda. First, the RSA certificate is created:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
# openssl genrsa -out /etc/ssl/private/mail.example.com.key 4096 
# openssl req -new -x509 -key /etc/ssl/private/mail.example.com.key \ 
	-out /etc/ssl/mail.example.com.crt -days 365 
# chmod 600 /etc/ssl/mail.example.com.crt 
# chmod 600 /etc/ssl/private/mail.example.com.key</pre>
<div class="spacer">
</div>
In the example above, a certificate valid for one year was created. The configuration file would look like this:<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
pki mail.example.com certificate &quot;/etc/ssl/mail.example.com.crt&quot; 
pki mail.example.com key &quot;/etc/ssl/private/mail.example.com.key&quot; 
 
table aliases file:/etc/mail/aliases 
 
listen on lo0 
listen on egress tls pki mail.example.com auth 
 
accept for local alias &lt;aliases&gt; deliver to mda &quot;/path/to/mda -f -&quot; 
accept from any for domain example.com \ 
	deliver to mda &quot;/path/to/mda -f -&quot; 
accept for any relay</pre>
<div class="spacer">
</div>
For sites that wish to sign messages using DKIM, the <span class="emph">dkimproxy</span> package may be used as a filter. The following example is the same as the default configuration, but all outgoing mail is passed to dkimproxy_out on port 10027 for signing. The signed messages are received on port 10028 and tagged for relaying.<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
table aliases file:/etc/mail/aliases 
 
listen on lo0 
listen on lo0 port 10028 tag DKIM 
 
accept for local alias &lt;aliases&gt; deliver to mbox 
accept tagged DKIM for any relay 
accept from local for any relay via smtp://127.0.0.1:10027</pre>
<div class="spacer">
</div>
Sites that accept non-local messages may be able to cut down on the volume of spam received by rejecting forged messages that claim to be from the local domain. The table <span class="emph">other-relays</span> can be used to specify the IP addresses of relays that may legitimately originate mail with your domain as the sender.<div class="spacer">
</div>
<pre style="margin-left: 5.00ex;" class="lit display">
table aliases file:/etc/mail/aliases 
table other-relays file:/etc/mail/other-relays 
 
listen on lo0 
listen on egress 
 
accept for local alias &lt;aliases&gt; deliver to mbox 
accept from local for any relay 
reject from ! source &lt;other-relays&gt; sender &quot;@example.com&quot; for any 
accept from any for domain example.com \ 
	alias &lt;aliases&gt; deliver to mbox</pre>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html5/mailer.conf.html">mailer.conf(5)</a>, <a class="link-man" href="../html5/table.html">table(5)</a>, <a class="link-man" href="../html8/makemap.html">makemap(8)</a>, <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> <a class="link-man" href="../html8/smtpd.html">smtpd(8)</a> first appeared in <span class="unix">OpenBSD&#160;4.6</span>.</div>
</div>
</body>
</html>

