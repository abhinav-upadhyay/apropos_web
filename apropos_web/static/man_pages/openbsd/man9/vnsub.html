<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
VNSUBR(9)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">vnsubr</b>, <b class="name">vn_close</b>, <b class="name">vn_default_error</b>, <b class="name">vn_isunder</b>, <b class="name">vn_lock</b>, <b class="name">vn_marktext</b>, <b class="name">vn_rdwr</b>, <b class="name">vn_open</b>, <b class="name">vn_stat</b>, <b class="name">vn_writechk</b> &#8212; <span class="desc">high-level convenience functions for vnode operations</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/param.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">sys/lock.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">sys/vnode.h</a>&gt;</b><div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">vn_close</b>(<i class="farg" style="white-space:nowrap;">struct vnode *vp</i>, <i class="farg" style="white-space:nowrap;">int flags</i>, <i class="farg" style="white-space:nowrap;">struct ucred *cred</i>, <i class="farg" style="white-space:nowrap;">struct proc *p</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">vn_default_error</b>(<i class="farg" style="white-space:nowrap;">void *v</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">vn_isunder</b>(<i class="farg" style="white-space:nowrap;">struct vnode *dvp</i>, <i class="farg" style="white-space:nowrap;">struct vnode *rvp</i>, <i class="farg" style="white-space:nowrap;">struct proc *p</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">vn_lock</b>(<i class="farg" style="white-space:nowrap;">struct vnode *vp</i>, <i class="farg" style="white-space:nowrap;">int flags</i>, <i class="farg" style="white-space:nowrap;">struct proc *p</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">vn_marktext</b>(<i class="farg" style="white-space:nowrap;">struct vnode *vp</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">vn_open</b>(<i class="farg" style="white-space:nowrap;">struct nameidata *ndp</i>, <i class="farg" style="white-space:nowrap;">int fmode</i>, <i class="farg" style="white-space:nowrap;">int cmode</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">vn_rdwr</b>(<i class="farg">enum uio_rw rw</i>, <i class="farg">struct vnode *vp</i>, <i class="farg">caddr_t base</i>, <i class="farg">int len</i>, <i class="farg">off_t offset</i>, <i class="farg">enum uio_seg segflg</i>, <i class="farg">int ioflg</i>, <i class="farg">struct ucred *cred</i>, <i class="farg">size_t *aresid</i>, <i class="farg">struct proc *p</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">vn_stat</b>(<i class="farg" style="white-space:nowrap;">struct vnode *vp</i>, <i class="farg" style="white-space:nowrap;">struct stat *sb</i>, <i class="farg" style="white-space:nowrap;">struct proc *p</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">vn_writechk</b>(<i class="farg" style="white-space:nowrap;">struct vnode *vp</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The high-level functions described in this page are convenience functions for simplified access to the vnode operations described in <a class="link-man" href="../html9/VOP_LOOKUP.html">VOP_LOOKUP(9)</a>.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">vn_close</b>(<i class="farg">vp</i>, <i class="farg">flags</i>, <i class="farg">cred</i>, <i class="farg">p</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Common code for a vnode close. The argument <i class="farg">vp</i> is the unlocked vnode of the vnode to close. <b class="fname">vn_close</b>() simply locks the vnode, invokes the vnode operation <b class="fname">VOP_CLOSE</b>() and calls <a class="link-man" href="../html9/vput.html">vput(9)</a> to return the vnode to the freelist or holdlist. Note that <b class="fname">vn_close</b>() expects an unlocked, referenced vnode and will dereference the vnode prior to returning. If the operation is successful, zero is returned; otherwise an appropriate error is returned.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">vn_default_error</b>(<i class="farg">v</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
A generic &quot;default&quot; routine that just returns error. It is used by a file system to specify unsupported operations in the vnode operations vector.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">vn_isunder</b>(<i class="farg">dvp</i>, <i class="farg">rvp</i>, <i class="farg">p</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Common code to check if one directory specified by the vnode <i class="farg">rvp</i> can be found inside the directory specified by the vnode <i class="farg">dvp</i>. The argument <i class="farg">p</i> is the calling process. <b class="fname">vn_isunder</b>() is intended to be used in <a class="link-man" href="../html2/chroot.html">chroot(2)</a>, <a class="link-man" href="../html2/chdir.html">chdir(2)</a>, <a class="link-man" href="../html2/fchdir.html">fchdir(2)</a>, etc., to ensure that <a class="link-man" href="../html2/chroot.html">chroot(2)</a> actually means something. If the operation is successful, zero is returned; otherwise 1 is returned.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">vn_lock</b>(<i class="farg">vp</i>, <i class="farg">flags</i>, <i class="farg">p</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Acquire the vnode lock. Certain file system operations require that the vnode lock be held when they are called.<div class="spacer">
</div>
The <b class="fname">vn_lock</b>() function must not be called when the vnode's reference count is zero. Instead, the <a class="link-man" href="../html9/vget.html">vget(9)</a> function should be used.<div class="spacer">
</div>
The <i class="farg">flags</i> argument may contain the following flags:<div class="spacer">
</div>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">LK_RETRY</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Return the vnode even if it has been reclaimed.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">LK_NOWAIT</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Don't wait if the vnode lock is held by someone else (may still wait on reclamation lock). Must not be used with <span class="define">LK_RETRY</span>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">LK_EXCLUSIVE</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Acquire an exclusive lock.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">LK_SHARED</span></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Acquire a shared lock.</dd>
</dl>
<div class="spacer">
</div>
The <b class="fname">vn_lock</b>() function can sleep.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">vn_marktext</b>(<i class="farg">vp</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Common code to mark the vnode <i class="farg">vp</i> as being the text of a running process.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">vn_open</b>(<i class="farg">ndp</i>, <i class="farg">fmode</i>, <i class="farg">cmode</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Common code for vnode open operations. The pathname is described in the <span class="type">nameidata</span> pointer (see <a class="link-man" href="../html9/namei.html">namei(9)</a>). The arguments <i class="farg">fmode</i> and <i class="farg">cmode</i> specify the <a class="link-man" href="../html2/open.html">open(2)</a> file mode and the access permissions for creation. <b class="fname">vn_open</b>() checks permissions and invokes the <a class="link-man" href="../html9/VOP_OPEN.html">VOP_OPEN(9)</a> or <a class="link-man" href="../html9/VOP_CREATE.html">VOP_CREATE(9)</a> vnode operations. If the operation is successful, zero is returned; otherwise an appropriate error code is returned.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">vn_rdwr</b>(<i class="farg">rw</i>, <i class="farg">vp</i>, <i class="farg">base</i>, <i class="farg">len</i>, <i class="farg">offset</i>, <i class="farg">segflg</i>, <i class="farg">ioflg</i>, <i class="farg">cred</i>, <i class="farg">aresid</i>, <i class="farg">p</i>);</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Common code to package up an I/O request on a vnode into a <span class="type">uio</span> and then perform the I/O. The argument <i class="farg">rw</i> specifies whether the I/O is a read (<span class="define">UIO_READ</span>) or write (<span class="define">UIO_WRITE</span>) operation. The unlocked vnode is specified by <i class="farg">vp</i>. The arguments <i class="farg">p</i> and <i class="farg">cred</i> are the calling process and its credentials. The remaining arguments specify the <span class="type">uio</span> parameters. For further information on these parameters, see <a class="link-man" href="../html9/uiomove.html">uiomove(9)</a>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">vn_stat</b>(<i class="farg">vp</i>, <i class="farg">sb</i>, <i class="farg">p</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Common code for a vnode stat operation. The vnode is specified by the argument <i class="farg">vp</i>, and <i class="farg">sb</i> is the buffer in which to store the stat information. The argument <i class="farg">p</i> is the calling process. <b class="fname">vn_stat</b>() basically calls the vnode operation <a class="link-man" href="../html9/VOP_GETATTR.html">VOP_GETATTR(9)</a> and transfers the contents of a <span class="type">vattr</span> structure into a <span class="type">struct stat</span>. If the operation is successful, zero is returned; otherwise an appropriate error code is returned.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">vn_writechk</b>(<i class="farg">vp</i>)</dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Common code to check for write permission on the vnode <i class="farg">vp</i>. A vnode is read-only if it is in use as a process's text image. If the vnode is read-only, <span class="errno">ETXTBSY</span> is returned; otherwise zero is returned to indicate that the vnode can be written to.</dd>
</dl>
</div>
<div class="section">
<h1 id="x4552524f5253">ERRORS</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">ETXTBSY</span>]</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Cannot write to a vnode since it is a process's text image.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">ENOENT</span>]</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The vnode has been reclaimed and is dead. This error is only returned if the <span class="define">LK_RETRY</span> flag is not passed to <b class="fname">vn_lock</b>().</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
[<span class="errno">EBUSY</span>]</dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The <span class="define">LK_NOWAIT</span> flag was set and <b class="fname">vn_lock</b>() would have slept.</dd>
</dl>
</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> This section describes places within the <span class="unix">OpenBSD</span> source tree where actual code implementing or using the vnode framework can be found. All pathnames are relative to <i class="file">/usr/src</i>.<div class="spacer">
</div>
The high-level convenience functions are implemented within the files <i class="file">sys/kern/vfs_vnops.c</i> and <i class="file">sys/sys/vnode.h</i>.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html9/file.html">file(9)</a>, <a class="link-man" href="../html9/lock.html">lock(9)</a>, <a class="link-man" href="../html9/namei.html">namei(9)</a>, <a class="link-man" href="../html9/vfs.html">vfs(9)</a>, <a class="link-man" href="../html9/vnode.html">vnode(9)</a>, <a class="link-man" href="../html9/VOP_LOOKUP.html">VOP_LOOKUP(9)</a></div>
<div class="section">
<h1 id="x42554753">BUGS</h1> The locking discipline is bizarre. Many vnode operations are passed locked vnodes on entry but release the lock before they exit. Discussions with Kirk McKusick indicate that locking discipline evolved out of the pre-VFS way of doing inode locking. In addition, the current locking discipline may actually save lines of code, especially if the number of file systems is fewer than the number of call sites. However, the VFS interface would require less wizardry if the locking discipline were simpler.<div class="spacer">
</div>
The locking discipline is used in some places to attempt to make a series of operations atomic (e.g., permissions check + operation). This does not work for non-local file systems that do not support locking (e.g., NFS).<div class="spacer">
</div>
Are vnode locks even necessary? The security checks can be moved into the individual file systems. Each file system can have the responsibility of ensuring that vnode operations are suitably atomic.<div class="spacer">
</div>
The <span class="define">LK_NOWAIT</span> flag does prevent the caller from sleeping.<div class="spacer">
</div>
The locking discipline as it relates to shared locks has yet to be defined.</div>
</div>
</body>
</html>

