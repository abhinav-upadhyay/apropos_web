<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
NAMEI(9)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">namei</b>, <b class="name">vfs_lookup</b>, <b class="name">vfs_relookup</b>, <b class="name">NDINIT</b>, <b class="name">NDINITAT</b> &#8212; <span class="desc">pathname lookup</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/param.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">sys/namei.h</a>&gt;</b><div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">namei</b>(<i class="farg" style="white-space:nowrap;">struct nameidata *ndp</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">vfs_lookup</b>(<i class="farg" style="white-space:nowrap;">struct nameidata *ndp</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">vfs_relookup</b>(<i class="farg" style="white-space:nowrap;">struct vnode *dvp</i>, <i class="farg" style="white-space:nowrap;">struct vnode **vpp</i>, <i class="farg" style="white-space:nowrap;">struct componentname *cnp</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">NDINIT</b>(<i class="farg" style="white-space:nowrap;">struct nameidata *ndp</i>, <i class="farg" style="white-space:nowrap;">u_long op</i>, <i class="farg" style="white-space:nowrap;">u_long flags</i>, <i class="farg" style="white-space:nowrap;">enum uio_seg segflg</i>, <i class="farg" style="white-space:nowrap;">const char *namep</i>, <i class="farg" style="white-space:nowrap;">struct proc *p</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">NDINITAT</b>(<i class="farg" style="white-space:nowrap;">struct nameidata *ndp</i>, <i class="farg" style="white-space:nowrap;">u_long op</i>, <i class="farg" style="white-space:nowrap;">u_long flags</i>, <i class="farg" style="white-space:nowrap;">enum uio_seg segflg</i>, <i class="farg" style="white-space:nowrap;">int dirfd</i>, <i class="farg" style="white-space:nowrap;">const char *namep</i>, <i class="farg" style="white-space:nowrap;">struct proc *p</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="fname">namei</b>() function is used to convert pathnames to file system vnodes. The name of the function is actually a contraction of the words <span class="emph">name</span> and <span class="emph">inode</span> for name-to-inode conversion, in the days before the <a class="link-man" href="../html9/vfs.html">vfs(9)</a> interface was implemented.<div class="spacer">
</div>
The arguments passed to the functions are encapsulated in the <span class="emph">nameidata</span> structure. It has the following structure:<div class="spacer">
</div>
<pre style="margin-left: 0.00ex;" class="lit display">
struct nameidata { 
        /* 
         * Arguments to namei/lookup. 
         */ 
        const char *ni_dirp;            /* pathname pointer */ 
        int     ni_dirfd;               /* AT_FDCWD or fd of base of */ 
					/* relative paths */ 
        enum    uio_seg ni_segflg;      /* location of pathname */ 
        /* 
         * Arguments to lookup. 
         */ 
        struct  vnode *ni_startdir;     /* starting directory */ 
        struct  vnode *ni_rootdir;      /* logical root directory */ 
        /* 
         * Results: returned from/manipulated by lookup 
         */ 
        struct  vnode *ni_vp;           /* vnode of result */ 
        struct  vnode *ni_dvp;          /* vnode of intermediate dir */ 
        /* 
         * Shared between namei and lookup/commit routines. 
         */ 
        size_t  ni_pathlen;             /* remaining chars in path */ 
        const char *ni_next;            /* next location in pathname */ 
        u_long  ni_loopcnt;             /* count of symlinks encountered */ 
        /* 
         * Lookup parameters 
         */ 
        struct componentname ni_cnd; 
};</pre>
<div class="spacer">
</div>
The <b class="fname">namei</b>() function accesses vnode operations by passing arguments in the partially initialised <span class="emph">componentname</span> structure <span class="emph">ni_cnd</span>. This structure describes the subset of information from the nameidata structure that is passed through to the vnode operations. See <a class="link-man" href="../html9/VOP_LOOKUP.html">VOP_LOOKUP(9)</a> for more information. The details of the componentname structure are not absolutely necessary since the members are initialised by the helper macros <b class="fname">NDINIT</b>() and <b class="fname">NDINITAT</b>(). It is useful to know the operations and flags as specified in <a class="link-man" href="../html9/VOP_LOOKUP.html">VOP_LOOKUP(9)</a>.<div class="spacer">
</div>
The <b class="fname">namei</b>() function overloads <span class="emph">ni_cnd.cn_flags</span> with some additional flags. These flags should be specific to <b class="fname">namei</b>() and ignored by vnode operations. However, due to the historic close relationship between <b class="fname">namei</b>() and the vnode operations, these flags are sometimes used (and set) by vnode operations, particularly <b class="fname">VOP_LOOKUP</b>(). The additional flags are:<div class="spacer">
</div>
<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
NOCROSSMOUNT</dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
do not cross mount points</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
RDONLY</dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
lookup with read-only semantics</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
HASBUF</dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
caller has allocated pathname buffer <span class="emph">ni_cnd.cn_pnbuf</span></dd>
<dt class="list-tag" style="margin-top: 0.00em;">
SAVENAME</dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
save pathname buffer</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
SAVESTART</dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
save starting directory</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
ISDOTDOT</dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
current pathname component is ..</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
MAKEENTRY</dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
add entry to the name cache</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
ISLASTCN</dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
this is last component of pathname</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
ISSYMLINK</dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
symlink needs interpretation</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
REQUIREDIR</dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
must be a directory</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
STRIPSLASHES</dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
strip trailing slashes from the pathname</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
PDIRUNLOCK</dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
<b class="fname">VOP_LOOKUP</b>() unlocked parent dir</dd>
</dl>
<div class="spacer">
</div>
If the caller of <b class="fname">namei</b>() sets the SAVENAME flag, then it must free the buffer. If <b class="fname">VOP_LOOKUP</b>() sets the flag, then the buffer must be freed by either the commit routine or the <b class="fname">VOP_ABORT</b>() routine. The SAVESTART flag is set only by the callers of <b class="fname">namei</b>(). It implies SAVENAME plus the addition of saving the parent directory that contains the name in <span class="emph">ni_startdir</span>. It allows repeated calls to <b class="fname">vfs_lookup</b>() for the name being sought. The caller is responsible for releasing the buffer and for invoking <b class="fname">vrele</b>() on <span class="emph">ni_startdir</span>.<div class="spacer">
</div>
All access to <b class="fname">namei</b>(), <b class="fname">vfs_lookup</b>(), and <b class="fname">vfs_relookup</b>() must be in process context. Pathname lookups cannot be done in interrupt context.</div>
<div class="section">
<h1 id="x46554e4354494f4e53">FUNCTIONS</h1><dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">namei</b>(<i class="farg">ndp</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Convert a pathname into a pointer to a vnode. The pathname is specified by <span class="emph">ndp-&gt;ni_dirp</span> and is of length <span class="emph">ndp-&gt;ni_pathlen</span>. The <span class="emph">ndp-&gt;segflg</span> flags defines whether the name in <span class="emph">ndp-&gt;ni_dirp</span> is an address in kernel space (UIO_SYSSPACE) or an address in user space (UIO_USERSPACE). The vnode for the pathname is referenced and returned in <span class="emph">ndp-&gt;ni_vp</span>.<div class="spacer">
</div>
If <span class="emph">ndp-&gt;ni_cnd.cn_flags</span> has the FOLLOW flag set then symbolic links are followed when they occur at the end of the name translation process. Symbolic links are always followed for all other pathname components other than the last.<div class="spacer">
</div>
If the LOCKLEAF flag is set, a locked vnode is returned.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">vfs_lookup</b>(<i class="farg">ndp</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Search for a pathname. This is a very central and rather complicated routine.<div class="spacer">
</div>
The pathname is specified by <span class="emph">ndp-&gt;ni_dirp</span> and is of length <span class="emph">ndp-&gt;ni_pathlen</span>. The starting directory is taken from <span class="emph">ndp-&gt;ni_startdir</span>. The pathname is descended until done, or a symbolic link is encountered.<div class="spacer">
</div>
The semantics of <b class="fname">vfs_lookup</b>() are altered by the operation specified by <span class="emph">ndp-&gt;ni_cnd.cn_nameiop</span>. When CREATE, RENAME, or DELETE is specified, information usable in creating, renaming, or deleting a directory entry may be calculated.<div class="spacer">
</div>
If <span class="emph">ndp-&gt;ci_cnd.cn_flags</span> has LOCKPARENT set, the parent directory is returned locked in <span class="emph">ndp-&gt;ni_dvp</span>. If WANTPARENT is set, the parent directory is returned unlocked. Otherwise the parent directory is not returned. If the target of the pathname exists and LOCKLEAF is set, the target is returned locked in <span class="emph">ndp-&gt;ni_vp</span>, otherwise it is returned unlocked.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">vfs_relookup</b>(<i class="farg">dvp</i>, <i class="farg">vpp</i>, <i class="farg">cnp</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Reacquire a path name component in a directory. This is a quicker way to lookup a pathname component when the parent directory is known. The unlocked parent directory vnode is specified by <i class="farg">dvp</i> and the pathname component by <i class="farg">cnp</i>. The vnode of the pathname is returned in the address specified by <i class="farg">vpp</i>.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">NDINITAT</b>(<i class="farg">ndp</i>, <i class="farg">op</i>, <i class="farg">flags</i>, <i class="farg">segflg</i>, <i class="farg">dirfd</i>, <i class="farg">namep</i>, <i class="farg">p</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Initialise a nameidata structure pointed to by <i class="farg">ndp</i> for use by the <b class="name">namei</b> interfaces. It saves having to deal with the componentname structure inside <i class="farg">ndp</i>. The operation and flags are specified by <i class="farg">op</i> and <i class="farg">flags</i> respectively. These are the values to which <span class="emph">ndp-&gt;ni_cnd.cn_nameiop</span> and <span class="emph">ndp-&gt;ni_cnd.cn_flags</span> are respectively set. The segment flags which defines whether the pathname is in kernel address space or user address space is specified by <i class="farg">segflg</i>. The directory from which relative pathnames will be looked up is specified by <i class="farg">dirfd</i>, with <span class="define">AT_FDCWD</span> specifying use of the current working directory of process <i class="farg">p</i>. The argument <i class="farg">namep</i> is a pointer to the pathname that <span class="emph">ndp-&gt;ni_dirp</span> is set to and <i class="farg">p</i> is the calling process.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<b class="fname">NDINIT</b>(<i class="farg">ndp</i>, <i class="farg">op</i>, <i class="farg">flags</i>, <i class="farg">segflg</i>, <i class="farg">namep</i>, <i class="farg">p</i>)</dt>
<dd class="list-tag" style="margin-left: 7.00ex;">
Same as <b class="fname">NDINITAT</b>(<i class="farg">ndp</i>, <i class="farg">op</i>, <i class="farg">flags</i>, <i class="farg">segflg</i>, <i class="farg">AT_FDCWD</i>, <i class="farg">namep</i>, <i class="farg">p</i>).</dd>
</dl>
</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The name lookup subsystem is implemented within the file <i class="file">sys/kern/vfs_lookup.c</i>.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html9/intro.html">intro(9)</a>, <a class="link-man" href="../html9/vfs.html">vfs(9)</a>, <a class="link-man" href="../html9/vnode.html">vnode(9)</a>, <a class="link-man" href="../html9/VOP_LOOKUP.html">VOP_LOOKUP(9)</a></div>
<div class="section">
<h1 id="x42554753">BUGS</h1> It is unfortunate that much of the <b class="name">namei</b> interface makes assumptions on the underlying vnode operations. These assumptions are an artefact of the introduction of the vfs interface to split a file system interface which was historically designed as a tightly coupled module.</div>
</div>
</body>
</html>

