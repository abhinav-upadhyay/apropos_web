<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
FALLOC(9)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">falloc</b>, <b class="name">fdrelease</b>, <b class="name">FREF</b>, <b class="name">FRELE</b>, <b class="name">fd_getfile</b>, <b class="name">getsock</b>, <b class="name">getvnode</b> &#8212; <span class="desc">an overview of file descriptor handling</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/file.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">sys/filedesc.h</a>&gt;</b><div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">falloc</b>(<i class="farg" style="white-space:nowrap;">struct proc *p</i>, <i class="farg" style="white-space:nowrap;">struct file **resultfp</i>, <i class="farg" style="white-space:nowrap;">int *resultfd</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">fdrelease</b>(<i class="farg" style="white-space:nowrap;">struct proc *p</i>, <i class="farg" style="white-space:nowrap;">int fd</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">FREF</b>(<i class="farg" style="white-space:nowrap;">struct file *fp</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">FRELE</b>(<i class="farg" style="white-space:nowrap;">struct file *fp</i>, <i class="farg" style="white-space:nowrap;">struct proc *p</i>);<div class="spacer">
</div>
<i class="ftype">struct file *</i><br/>
<b class="fname">fd_getfile</b>(<i class="farg" style="white-space:nowrap;">struct filedesc *fdp</i>, <i class="farg" style="white-space:nowrap;">int fd</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">getsock</b>(<i class="farg" style="white-space:nowrap;">struct proc *p</i>, <i class="farg" style="white-space:nowrap;">int fd</i>, <i class="farg" style="white-space:nowrap;">struct file **fpp</i>);<div class="spacer">
</div>
<b class="includes">#include &lt;<a class="link-includes">sys/file.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">sys/filedesc.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">sys/vnode.h</a>&gt;</b><div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">getvnode</b>(<i class="farg" style="white-space:nowrap;">struct proc *p</i>, <i class="farg" style="white-space:nowrap;">int fd</i>, <i class="farg" style="white-space:nowrap;">struct file **fpp</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> These functions provide the interface for the UNIX file descriptors. File descriptors can be used to access vnodes (see <a class="link-man" href="../html9/vnode.html">vnode(9)</a>), sockets (see <a class="link-man" href="../html2/socket.html">socket(2)</a>), pipes (see <a class="link-man" href="../html2/pipe.html">pipe(2)</a>), kqueues (see <a class="link-man" href="../html2/kqueue.html">kqueue(2)</a>), and various special purpose communication endpoints.<div class="spacer">
</div>
A new file descriptor is allocated with the function <b class="fname">falloc</b>() and freed with <b class="fname">fdrelease</b>(). <b class="fname">falloc</b>() and <b class="fname">fdrelease</b>() deal with allocating and freeing slots in the file descriptor table, expanding the table when necessary and initializing the descriptor. It's possible to do those things in smaller steps, but it's not recommended to make complicated kernel APIs that require it.<div class="spacer">
</div>
The files are extracted from the file descriptor table using the functions <b class="fname">fd_getfile</b>() <b class="fname">fd_getfile</b>() performs all necessary checks to see if the file descriptor number is within the range of file descriptor table, and if the descriptor is valid.<div class="spacer">
</div>
The files are extracted from the process context using the function <b class="fname">getsock</b>() and <b class="fname">getvnode</b>(). These functions are special cases that besides doing <b class="fname">fd_getfile</b>() also check if the descriptor is a socket or a vnode respectively, return the proper errno on error and increase the use count with <b class="fname">FREF</b>().</div>
<div class="section">
<h1 id="x434f4e43555252454e5420414343455353">CONCURRENT ACCESS</h1> Since multiple processes can share the same file descriptor table, it's important that the file is not freed in one process while some other process is still accessing it. To solve that problem a special use count is kept with the functions <b class="fname">FREF</b>() and <b class="fname">FRELE</b>(). In most cases <b class="fname">FREF</b>() should be used on a file after it has been extracted from the file descriptor table and <b class="fname">FRELE</b>() should be called when the file won't be used anymore. There are cases when this isn't necessary, but since <b class="fname">FREF</b>() and <b class="fname">FRELE</b>() are cheap to use, there is no reason to risk introducing bugs by not using them.</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The majority of those functions are implemented in <i class="file">sys/kern/kern_descrip.c</i>. The function prototypes and the macros are located in <i class="file">sys/sys/file.h</i> and <i class="file">sys/sys/filedesc.h</i>.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html9/vnode.html">vnode(9)</a></div>
</div>
</body>
</html>

