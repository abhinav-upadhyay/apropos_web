<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
EXTENT(9)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">extent_create</b>, <b class="name">extent_destroy</b>, <b class="name">extent_alloc</b>, <b class="name">extent_alloc_with_descr</b>, <b class="name">extent_alloc_subregion</b>, <b class="name">extent_alloc_subregion_with_descr</b>, <b class="name">extent_alloc_region</b>, <b class="name">extent_free</b>, <b class="name">extent_print</b> &#8212; <span class="desc">general purpose extent manager</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/malloc.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">sys/extent.h</a>&gt;</b><div class="spacer">
</div>
<i class="ftype">struct extent *</i><br/>
<b class="fname">extent_create</b>(<i class="farg" style="white-space:nowrap;">char *name</i>, <i class="farg" style="white-space:nowrap;">u_long start</i>, <i class="farg" style="white-space:nowrap;">u_long end</i>, <i class="farg" style="white-space:nowrap;">int mtype</i>, <i class="farg" style="white-space:nowrap;">caddr_t storage</i>, <i class="farg" style="white-space:nowrap;">size_t storagesize</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">extent_destroy</b>(<i class="farg" style="white-space:nowrap;">struct extent *ex</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">extent_alloc</b>(<i class="farg" style="white-space:nowrap;">struct extent *ex</i>, <i class="farg" style="white-space:nowrap;">u_long size</i>, <i class="farg" style="white-space:nowrap;">u_long alignment</i>, <i class="farg" style="white-space:nowrap;">u_long skew</i>, <i class="farg" style="white-space:nowrap;">u_long boundary</i>, <i class="farg" style="white-space:nowrap;">int flags</i>, <i class="farg" style="white-space:nowrap;">u_long *result</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">extent_alloc_with_descr</b>(<i class="farg" style="white-space:nowrap;">struct extent *ex</i>, <i class="farg" style="white-space:nowrap;">u_long size</i>, <i class="farg" style="white-space:nowrap;">u_long alignment</i>, <i class="farg" style="white-space:nowrap;">u_long skew</i>, <i class="farg" style="white-space:nowrap;">u_long boundary</i>, <i class="farg" style="white-space:nowrap;">int flags</i>, <i class="farg" style="white-space:nowrap;">struct extent_region *rp</i>, <i class="farg" style="white-space:nowrap;">u_long *result</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">extent_alloc_subregion</b>(<i class="farg">struct extent *ex</i>, <i class="farg">u_long substart</i>, <i class="farg">u_long subend</i>, <i class="farg">u_long size</i>, <i class="farg">u_long alignment</i>, <i class="farg">u_long skew</i>, <i class="farg">u_long boundary</i>, <i class="farg">int flags</i>, <i class="farg">u_long *result</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">extent_alloc_subregion_with_descr</b>(<i class="farg">struct extent *ex</i>, <i class="farg">u_long substart</i>, <i class="farg">u_long subend</i>, <i class="farg">u_long size</i>, <i class="farg">u_long alignment</i>, <i class="farg">u_long skew</i>, <i class="farg">u_long boundary</i>, <i class="farg">int flags</i>, <i class="farg">struct extent_region *rp</i>, <i class="farg">u_long *result</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">extent_alloc_region</b>(<i class="farg" style="white-space:nowrap;">struct extent *ex</i>, <i class="farg" style="white-space:nowrap;">u_long start</i>, <i class="farg" style="white-space:nowrap;">u_long size</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">extent_free</b>(<i class="farg" style="white-space:nowrap;">struct extent *ex</i>, <i class="farg" style="white-space:nowrap;">u_long start</i>, <i class="farg" style="white-space:nowrap;">u_long size</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">extent_print</b>(<i class="farg" style="white-space:nowrap;">struct extent *ex</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The extent manager provides management of areas of memory or other enumerable spaces (such as I/O ports). An opaque structure called an <b class="name">extent map</b> keeps track of allocated regions within the enumerable space.<div class="spacer">
</div>
<b class="fname">extent_create</b>() creates an extent map managing the space from <i class="farg">start</i> to <i class="farg">end</i> inclusive. All memory allocation will use the memory type <i class="farg">mtype</i> (see <a class="link-man" href="../html9/malloc.html">malloc(9)</a>). The extent map will have the name <i class="farg">name</i>, used for identification in case of errors or in <a class="link-man" href="../html4/ddb.html">ddb(4)</a> <b class="cmd">show extents</b>. If the flag <span class="define">EX_NOCOALESCE</span> is set, internal coalescing of regions is disabled, and only entire regions may be freed within the extent map, so that <b class="fname">extent_free</b>() will never have to allocate a region descriptor. If the flag <span class="define">EX_FILLED</span> is set, the entire space managed by the extent map will be allocated upon creation of the extent map, such that selected regions may be made available through calls to <b class="fname">extent_free</b>().<div class="spacer">
</div>
Some applications may want to use an extent map but can't use <b class="fname">malloc</b>() and <b class="fname">free</b>(). These applications may provide pre-allocated storage for all descriptor overhead with the arguments <i class="farg">storage</i> and <i class="farg">storagesize</i>. An extent of this type is called a <b class="name">fixed extent</b>. If the application can safely use <b class="fname">malloc</b>() and <b class="fname">free</b>(), <i class="farg">storage</i> should be <span class="define">NULL</span>. A fixed extent has a fixed number of region descriptors, so care should be taken to provide enough storage for them; alternatively, the flag <span class="define">EX_MALLOCOK</span> may be passed to extent requests to indicate that a fixed extent map may be extended using a call to <b class="fname">malloc</b>(). Note that passing the flag <span class="define">EX_FILLED</span> to <b class="fname">extent_create</b>() will consume a region descriptor upon creation of the extent map.<div class="spacer">
</div>
The caller should pass the flag <span class="define">EX_WAITOK</span> or <span class="define">EX_NOWAIT</span> to extent functions that have a memory overhead, to specify whether it is okay to wait. These functions are <b class="fname">extent_create</b>() (non fixed extents), <b class="fname">extent_free</b>() (unless <span class="define">EX_NOCOALESCE</span> is set), <b class="fname">extent_alloc</b>(), <b class="fname">extent_alloc_subregion</b>() and <b class="fname">extent_alloc_region</b>().<div class="spacer">
</div>
<b class="fname">extent_destroy</b>() destroys the extent map <i class="farg">ex</i>, freeing all allocated regions. If the extent is not a fixed extent, the region and internal extent descriptors themselves are freed. This function always succeeds.<div class="spacer">
</div>
<b class="fname">extent_alloc</b>() allocates a region in the extent map <i class="farg">ex</i> of size <i class="farg">size</i> that fits the provided parameters. There are two distinct allocation policies, which are selected by the <i class="farg">flags</i> argument:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">EX_FAST</span></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Allocate the first region that fits the provided parameters, regardless of resulting extent fragmentation.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
default</dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Allocate the smallest region that is capable of holding the request, thus minimizing fragmentation of the extent.</dd>
</dl>
<div class="spacer">
</div>
The caller may specify that it is okay to wait for space to become free in the extent by setting the flag <span class="define">EX_WAITSPACE</span>. If <span class="define">EX_WAITSPACE</span> is not set, the allocation will fail if the request cannot be satisfied without sleeping.<div class="spacer">
</div>
The request will be aligned to a multiple of <i class="farg">alignment</i>. That value must be a power of 2. If no alignment is necessary, the value <span class="define">EX_NOALIGN</span> should be specified. If <i class="farg">skew</i> is non-zero, it modifies the requested alignment result in the following way: the value (<i class="farg">result</i> <code class="none">-</code> <i class="farg">skew</i>) is aligned to <i class="farg">alignment</i> boundaries. <i class="farg">skew</i> must be a smaller number than <i class="farg">alignment</i>. If <i class="farg">boundary</i> is not <span class="define">EX_NOBOUNDARY</span>, the allocated region will not cross any boundary lines, spaced <i class="farg">boundary</i> apart. If the caller specifies the <span class="define">EX_BOUNDZERO</span> flag, boundary lines begin at zero. Otherwise, boundary lines begin at the beginning of the extent. The allocated region may begin on a boundary line, but the end of the region will not touch nor cross a boundary line. A <i class="farg">boundary</i> argument smaller than the sum of the requested skew and the size of the request is invalid. Upon successful completion, <i class="farg">*result</i> will contain the start of the allocated region.<div class="spacer">
</div>
<b class="fname">extent_alloc_with_descr</b>() is similar to <b class="fname">extent_alloc</b>() but allows the caller to provide a pre-allocated region descriptor instead of having the function allocate one. This function can only be used with extents that have the <span class="define">EX_NOCOALESCE</span> property.<div class="spacer">
</div>
<b class="fname">extent_alloc_subregion</b>() and <b class="fname">extent_alloc_subregion_with_descr</b>() are generalized versions of <b class="fname">extent_alloc</b>() and <b class="fname">extent_alloc_with_descr</b>() that allow the caller to specify that the allocated region must fall within the subregion from <i class="farg">substart</i> to <i class="farg">subend</i> inclusive.<div class="spacer">
</div>
<b class="fname">extent_alloc_region</b>() allocates the specific region in the extent map <i class="farg">ex</i> beginning at <i class="farg">start</i> with the size <i class="farg">size</i>. If the caller specifies the <span class="define">EX_CONFLICTOK</span> flag, the allocation will succeed even if part of the requested region has already been allocated. The caller may specify that it is okay to wait for the indicated region to be free by setting the flag <span class="define">EX_WAITSPACE</span>. If neither <span class="define">EX_WAITSPACE</span> nor <span class="define">EX_CONFLICTOK</span> is set, the allocation will fail if the request cannot be satisfied without sleeping.<div class="spacer">
</div>
<b class="fname">extent_free</b>() frees a region of <i class="farg">size</i> bytes starting at <i class="farg">start</i> in the extent map <i class="farg">ex</i>. If the extent has the <span class="define">EX_NOCOALESCE</span> property, only entire regions may be freed. If the extent has the <span class="define">EX_NOCOALESCE</span> property and the caller attempts to free a partial region, behavior is undefined. If called on an extent without the <span class="define">EX_NOCOALESCE</span> property, this function can fail with error codes listed below, otherwise this function will always succeed.<div class="spacer">
</div>
<b class="fname">extent_print</b>() Prints out information about extent <i class="farg">ex</i>. This function always succeeds.</div>
<div class="section">
<h1 id="x52455455524e2056414c554553">RETURN VALUES</h1> The behavior of all extent manager functions is undefined if given invalid arguments. <b class="fname">extent_create</b>() returns the extent map on success, or <span class="define">NULL</span> if it fails to allocate storage for the extent map. It always succeeds when creating a fixed extent or when given the flag <span class="define">EX_WAITOK</span>. <b class="fname">extent_alloc</b>(), <b class="fname">extent_alloc_region</b>(), <b class="fname">extent_alloc_subregion</b>(), and <b class="fname">extent_free</b>() return one of the following values:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">0</span></dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
Operation was successful.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">ENOMEM</span></dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
If <span class="define">EX_NOWAIT</span> is specified, the extent manager was not able to allocate a region descriptor for the new region or to split a region when freeing a partial region.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">EAGAIN</span></dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
Requested region is not available and <span class="define">EX_WAITSPACE</span> was not specified.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<span class="define">EINTR</span></dt>
<dd class="list-tag" style="margin-left: 8.00ex;">
Process received a signal while waiting for the requested region to become available in the extent.</dd>
</dl>
</div>
<div class="section">
<h1 id="x4558414d504c4553">EXAMPLES</h1> Here is an example of a (useless) function that uses several of the extent manager routines.<div class="spacer">
</div>
<pre style="margin-left: 0.00ex;" class="lit display">
void 
func() 
{ 
	struct extent *foo_ex; 
	u_long region_start; 
	int error; 
 
	/* 
	 * Extent &quot;foo&quot; manages a 256k region starting at 0x0 and 
	 * only allows complete regions to be freed so that 
	 * extent_free() never needs to allocate memory. 
	 */ 
	foo_ex = extent_create(&quot;foo&quot;, 0x0, 0x3ffff, M_DEVBUF, 
	    NULL, 0, EX_WAITOK | EX_NOCOALESCE); 
 
	/* 
	 * Allocate an 8k region, aligned to a 4k boundary, which 
	 * does not cross any of the 3 64k boundaries (at 64k, 
	 * 128k, and 192k) within the extent. 
	 */ 
	error = extent_alloc(foo_ex, 0x2000, 0x1000, 0x10000, 
	    EX_NOWAIT, &amp;region_start); 
	if (error) 
		panic(&quot;you lose&quot;); 
 
	/* 
	 * Give up the extent. 
	 */ 
	extent_destroy(foo_ex); 
}</pre>
</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The extent manager itself is implemented within the file <i class="file">sys/kern/subr_extent.c</i>.<div class="spacer">
</div>
The i386 bus management code uses the extent manager for managing I/O ports and I/O memory. See <i class="file">sys/arch/i386/i386/machdep.c</i>.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html4/ddb.html">ddb(4)</a>, <a class="link-man" href="../html9/malloc.html">malloc(9)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The extent manager appeared in <span class="unix">NetBSD&#160;1.3</span>.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> The extent manager was designed and implemented by <span class="author">Jason R. Thorpe</span> &lt;<a class="link-mail" href="mailto:thorpej@NetBSD.ORG">thorpej@NetBSD.ORG</a>&gt;. <span class="author">Matthias Drochner</span> &lt;<a class="link-mail" href="mailto:drochner@zelux6.zel.kfa-juelich.de">drochner@zelux6.zel.kfa-juelich.de</a>&gt; contributed to the initial testing and optimization of the implementation. <span class="author">Chris Demetriou</span> &lt;<a class="link-mail" href="mailto:cgd@NetBSD.ORG">cgd@NetBSD.ORG</a>&gt; contributed many architectural suggestions.</div>
</div>
</body>
</html>

