<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
POOL_INIT(9)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">pool_init</b>, <b class="name">pool_destroy</b>, <b class="name">pool_get</b>, <b class="name">pool_put</b>, <b class="name">pool_prime</b>, <b class="name">pool_setipl</b>, <b class="name">pool_sethiwat</b>, <b class="name">pool_setlowat</b>, <b class="name">pool_sethardlimit</b> &#8212; <span class="desc">resource-pool manager</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">sys/types.h</a>&gt;</b><br/>
<b class="includes">#include &lt;<a class="link-includes">sys/pool.h</a>&gt;</b><div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">pool_init</b>(<i class="farg">struct pool *pool</i>, <i class="farg">size_t size</i>, <i class="farg">u_int align</i>, <i class="farg">u_int align_offset</i>, <i class="farg">int flags</i>, <i class="farg">const char *wmesg</i>, <i class="farg">struct pool_allocator *palloc</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">pool_destroy</b>(<i class="farg">struct pool *pp</i>);<div class="spacer">
</div>
<i class="ftype">void *</i><br/>
<b class="fname">pool_get</b>(<i class="farg" style="white-space:nowrap;">struct pool *pp</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">pool_put</b>(<i class="farg" style="white-space:nowrap;">struct pool *pp</i>, <i class="farg" style="white-space:nowrap;">void *item</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">pool_prime</b>(<i class="farg" style="white-space:nowrap;">struct pool *pp</i>, <i class="farg" style="white-space:nowrap;">int nitems</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">pool_setipl</b>(<i class="farg" style="white-space:nowrap;">struct pool *pp</i>, <i class="farg" style="white-space:nowrap;">int ipl</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">pool_sethiwat</b>(<i class="farg" style="white-space:nowrap;">struct pool *pp</i>, <i class="farg" style="white-space:nowrap;">int n</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">pool_setlowat</b>(<i class="farg" style="white-space:nowrap;">struct pool *pp</i>, <i class="farg" style="white-space:nowrap;">int n</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">pool_sethardlimit</b>(<i class="farg">struct pool *pp</i>, <i class="farg">unsigned n</i>, <i class="farg">const char *warnmess</i>, <i class="farg">int ratecap</i>);</div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> These utility routines provide management of pools of fixed-sized areas of memory. Resource pools set aside an amount of memory for exclusive use by the resource pool owner. This can be used by applications to guarantee the availability of a minimum amount of memory needed to continue operation independent of the memory resources currently available from the system-wide memory allocator (<a class="link-man" href="../html9/malloc.html">malloc(9)</a>). The pool manager obtains memory by using the special-purpose memory allocator <i class="farg">palloc</i> passed to <b class="fname">pool_init</b>(), for extra pool items in case the number of allocations exceeds the nominal number of pool items managed by a pool resource. This temporary memory will be automatically returned to the system at a later time.<div class="subsection">
<h2 id="x4352454154494e47204120504f4f4c">CREATING A POOL</h2> The function <b class="fname">pool_init</b>() initializes a resource pool. The arguments are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pool</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Specifies the pool storage to be initialized.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">size</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Specifies the size of the memory items managed by the pool.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">align</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Specifies the memory address alignment of the items returned by <b class="fname">pool_get</b>(). This argument must be a power of two. If zero, the alignment defaults to an architecture-specific natural alignment.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">align_offset</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
The offset within an item to which the <i class="farg">align</i> parameter applies.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">flags</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
Specifies various flags set on the pool at creation time.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">wmesg</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
The message passed on to <a class="link-man" href="../html9/tsleep.html">tsleep(9)</a> if <b class="fname">pool_get</b>() must wait for items to be returned to the pool.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">palloc</i></dt>
<dd class="list-tag" style="margin-left: 12.00ex;">
The back-end allocator used to manage the memory for the pool. <i class="farg">palloc</i> may be <span class="define">NULL</span>, in which case the pool manager chooses an appropriate back-end allocator. If the <span class="define">PR_WAITOK</span> flag has been specified, this allocator may not be interrupt safe. It is recommended to specify this flag if the pool will never be accessed in interrupt context.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x44455354524f59494e47204120504f4f4c">DESTROYING A POOL</h2> The <b class="fname">pool_destroy</b>() function destroys a resource pool. It takes a single argument <i class="farg">pp</i> identifying the pool resource instance.</div>
<div class="subsection">
<h2 id="x414c4c4f434154494e47204954454d532046524f4d204120504f4f4c">ALLOCATING ITEMS FROM A POOL</h2> <b class="fname">pool_get</b>() allocates an item from the pool and returns a pointer to it.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pp</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The handle identifying the pool resource instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">flags</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
One or more flags. Either <span class="define">PR_WAITOK</span> or <span class="define">PR_NOWAIT</span> must be specified to define behaviour in case the pooled resources are depleted. If no resources are available and <span class="define">PR_NOWAIT</span> was specified, this function returns <span class="define">NULL</span>. If <span class="define">PR_WAITOK</span> was specified but <span class="define">PR_LIMITFAIL</span> was not, <b class="fname">pool_get</b>() will wait until items are returned to the pool. If both <span class="define">PR_WAITOK</span> and <span class="define">PR_LIMITFAIL</span> were specified, and the pool has reached its hard limit, <b class="fname">pool_get</b>() will return <span class="define">NULL</span> without waiting, allowing the caller to do its own garbage collection; however, it will still wait if the pool is not yet at its hard limit. If <span class="define">PR_ZERO</span> was specified and an item has been successfully allocated, it is zeroed before being returned to the caller.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x52455455524e494e47204954454d5320544f204120504f4f4c">RETURNING ITEMS TO A POOL</h2> <b class="fname">pool_put</b>() returns the pool item pointed at by <i class="farg">item</i> to the resource pool identified by the pool handle <i class="farg">pp</i>. If the number of available items in the pool exceeds the maximum pool size set by <b class="fname">pool_sethiwat</b>() and there are no outstanding requests for pool items, the excess items will be returned to the system if possible.<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pp</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
The handle identifying the pool resource instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">item</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
A pointer to a pool item previously obtained by <b class="fname">pool_get</b>().</dd>
</dl>
<div class="spacer">
</div>
If a non-interrupt safe allocator has been selected by passing the <span class="define">PR_WAITOK</span> flag to <b class="fname">pmap_init</b>(), <b class="fname">pool_put</b>() may sleep when completely unused pages are released.</div>
<div class="subsection">
<h2 id="x5052494d494e47204120504f4f4c">PRIMING A POOL</h2> <b class="fname">pool_prime</b>() adds items to the pool. Storage space for the items is allocated by using the page allocation routine specified to <b class="fname">pool_init</b>().<div class="spacer">
</div>
<b class="fname">pool_prime</b>()<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pp</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The handle identifying the pool resource instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">nitems</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The number of items to add to the pool.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x53455454494e4720504f4f4c205245534f555243452057415445524d41524b53">SETTING POOL RESOURCE WATERMARKS</h2> A pool will attempt to increase its resource usage to keep up with the demand for its items. Conversely, it will return unused memory to the system should the number of accumulated unused items in the pool exceed a programmable limit. The limits for the minimum and maximum number of items which a pool should keep at hand are known as the high and low <span class="symb">watermarks</span>. The functions <b class="fname">pool_sethiwat</b>() and <b class="fname">pool_setlowat</b>() set a pool's high and low watermarks, respectively.<div class="spacer">
</div>
<b class="fname">pool_sethiwat</b>()<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pp</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The handle identifying the pool resource instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">n</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The maximum number of items to keep in the pool. As items are returned and the total number of pages in the pool is larger than the maximum set by this function, any completely unused pages are released immediately. If this function is not used to specify a maximum number of items, the pages will remain associated with the pool until the system runs low on memory, at which point the VM system will try to reclaim unused pages.</dd>
</dl>
<div class="spacer">
</div>
<b class="fname">pool_setlowat</b>()<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pp</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The handle identifying the pool resource instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">n</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The minimum number of items to keep in the pool. The number of pages in the pool will not decrease below the required value to accommodate the minimum number of items specified by this function. Unlike <b class="fname">pool_prime</b>(), this function does not allocate the necessary memory up-front.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x53455454494e47205448452050524f54454354494f4e204c4556454c">SETTING THE PROTECTION LEVEL</h2> The <b class="fname">pool_setipl</b>() function is used to specify the interrupt protection level at which the pool can be safely used.<div class="spacer">
</div>
<b class="fname">pool_setipl</b>()<dl style="margin-top: 0.00em;margin-bottom: 0.00em;margin-left: 6.00ex;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">pp</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The handle identifying the pool resource instance.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">ipl</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The interrupt protection level used to protect the pool's internals. See <a class="link-man" href="../html9/spl.html">spl(9)</a> for a list of the IPLs.</dd>
</dl>
</div>
<div class="subsection">
<h2 id="x53455454494e472048415244204c494d495453">SETTING HARD LIMITS</h2> The function <b class="fname">pool_sethardlimit</b>() sets a hard limit on the pool to <i class="farg">n</i> items. If the hard limit is reached <i class="farg">warnmess</i> will be printed to the console, but no more than every <i class="farg">ratecap</i> seconds. Upon successful completion, a value of 0 is returned. The value EINVAL is returned when the current size of the pool already exceeds the requested hard limit.</div>
<div class="subsection">
<h2 id="x504f54454e5449414c2050495446414c4c53">POTENTIAL PITFALLS</h2> Note that undefined behaviour results when mixing the storage providing methods supported by the pool resource routines.<div class="spacer">
</div>
The pool resource code uses a per-pool lock to protect its internal state. If any pool functions are called in an interrupt context, the caller must block all interrupts that might cause the code to be reentered.</div>
</div>
<div class="section">
<h1 id="x434f4e54455854">CONTEXT</h1> <b class="fname">pool_init</b>(), <b class="fname">pool_destroy</b>(), <b class="fname">pool_prime</b>(), <b class="fname">pool_setipl</b>(), <b class="fname">pool_sethiwat</b>(), <b class="fname">pool_setlowat</b>(), and <b class="fname">pool_sethardlimit</b>() can be called during autoconf or from process context.<div class="spacer">
</div>
<b class="fname">pool_get</b>() and <b class="fname">pool_put</b>() can be called during autoconf or from process context. If the pool has been initialised with an interrupt safe pool allocator they can also be called from interrupt context at or below the interrupt level specified by a call to <b class="fname">pool_setipl</b>().</div>
<div class="section">
<h1 id="x52455455524e2056414c554553">RETURN VALUES</h1> <b class="fname">pool_get</b>() will return a pointer to an item allocated from the pool. If <span class="define">PR_NOWAIT</span> or <span class="define">PR_LIMITFAIL</span> were passed as flags to the pool it may return <span class="define">NULL</span> if there are no resources available or if the pool hard limit has been reached, respectively.<div class="spacer">
</div>
<b class="fname">pool_prime</b>() will return <span class="define">ENOMEM</span> if the requested number of items could not be allocated. Otherwise, the return value is 0.<div class="spacer">
</div>
<b class="fname">pool_sethardlimit</b>() will return <span class="define">EINVAL</span> if the current size of the pool exceeds the requested hard limit. Otherwise, the return value is 0.</div>
<div class="section">
<h1 id="x434f4445205245464552454e434553">CODE REFERENCES</h1> The pool manager is implemented in the file <i class="file">sys/kern/subr_pool.c</i>.</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html9/free.html">free(9)</a>, <a class="link-man" href="../html9/malloc.html">malloc(9)</a>, <a class="link-man" href="../html9/spl.html">spl(9)</a>, <a class="link-man" href="../html9/uvm.html">uvm(9)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The pool manager first appeared in <span class="unix">NetBSD&#160;1.4</span> and was ported to <span class="unix">OpenBSD</span> by <span class="author">Artur Grabowski</span> &lt;<a class="link-mail" href="mailto:art@openbsd.org">art@openbsd.org</a>&gt;.</div>
</div>
</body>
</html>

