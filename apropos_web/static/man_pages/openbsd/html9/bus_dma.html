<head>
<meta charset="utf-8"/>
<style>
table.head, table.foot { width: 100%; }
td.head-rtitle, td.foot-os { text-align: right; }
td.head-vol { text-align: center; }
table.foot td { width: 50%; }
table.head td { width: 33%; }
div.spacer { margin: 1em 0; }
</style>
<link rel="stylesheet" href="/static/man_pages/posix/style.css" type="text/css" media="all"/>
<title>
BUS_DMAMAP_CREATE(9)</title>
</head>
<body>
<div class="mandoc">
<div class="section">
<h1 id="x4e414d45">NAME</h1> <b class="name">bus_dmamap_create</b>, <b class="name">bus_dmamap_destroy</b>, <b class="name">bus_dmamap_load</b>, <b class="name">bus_dmamap_load_mbuf</b>, <b class="name">bus_dmamap_load_uio</b>, <b class="name">bus_dmamap_load_raw</b>, <b class="name">bus_dmamap_unload</b>, <b class="name">bus_dmamap_sync</b>, <b class="name">bus_dmamem_alloc</b>, <b class="name">bus_dmamem_alloc_range</b>, <b class="name">bus_dmamem_free</b>, <b class="name">bus_dmamem_map</b>, <b class="name">bus_dmamem_unmap</b>, <b class="name">bus_dmamem_mmap</b> &#8212; <span class="desc">bus and machine independent DMA mapping interface</span></div>
<div class="section">
<h1 id="x53594e4f50534953">SYNOPSIS</h1> <b class="includes">#include &lt;<a class="link-includes">machine/bus.h</a>&gt;</b></div>
<div class="section">
<h1 id="x4445534352495054494f4e">DESCRIPTION</h1> The <b class="name">bus_dmamap_create</b> interface provides a bus and machine independent mechanism for managing DMA data transfers to and from devices.<div class="spacer">
</div>
The basic abstraction is <i class="farg">bus_dmamap_t</i>, a pointer to a structure describing an individual DMA mapping. The structure contains an array of segments (<i class="farg">dm_segs</i>), and a count of segments (<i class="farg">dm_nsegs</i>).<div class="spacer">
</div>
Each segment in <i class="farg">dm_segs</i> describes a single physical area of memory suitable for DMA, with a starting address (<i class="farg">ds_addr</i>) and a length (<i class="farg">ds_len</i>). These are the values that must be communicated to the DMA device. Taken together the segments exactly and completely describe the buffer being used to transfer data.<div class="spacer">
</div>
<i class="farg">bus_dma_tag_t</i> is an opaque type. <i class="farg">bus_dma_tag_t</i> values are received from higher software layers and are never created, changed, deleted or even examined in this interface.<div class="spacer">
</div>
The basic cycle to transfer data to/from a DMA device is:<div class="spacer">
</div>
<pre style="margin-left: 0.00ex;" class="lit display">
bus_dmamap_create();         /* get a dmamap to load/unload          */ 
 
for each DMA xfer { 
        bus_dmamem_alloc();  /* allocate some DMA'able memory        */ 
        bus_dmamem_map();    /* map it into the kernel address space */ 
 
        /* 
         * Fill the allocated DMA'able memory with whatever data 
         * is to be sent out, using the pointer obtained with 
         * bus_dmamem_map(). 
         */ 
 
        bus_dmamap_load();   /* initialize the segments of dmamap    */ 
        bus_dmamap_sync();   /* synchronize/flush any DMA cache      */ 
 
        for (i = 0; i &lt; dm_nsegs; i++) { 
                /* 
                 * Tell the DMA device the physical address 
                 * (dmamap-&gt;dm_segs[i].ds_addr) and the length 
                 * (dmamap-&gt;dm_segs[i].ds_len) of the memory to xfer. 
                 * 
                 * Start the DMA, wait until it's done 
                 */ 
        } 
 
        bus_dmamap_sync();   /* synchronize/flush any DMA cache      */ 
        bus_dmamap_unload(); /* prepare dmamap for reuse             */ 
 
        /* 
         * Copy any data desired from the DMA'able memory using the 
         * pointer created by bus_dmamem_map(). 
         */ 
 
        bus_dmamem_unmap();  /* free kernel virtual address space    */ 
        bus_dmamem_free();   /* free DMA'able memory                 */ 
} 
 
bus_dmamap_destroy();        /* release any resources used by dmamap */</pre>
</div>
<div class="section">
<h1 id="x44415441205459504553">DATA TYPES</h1> Individual implementations may name these structures whatever they wish, providing that the external representations are:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">bus_addr_t</i></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
A device bus address to be used for CPU access or DMA.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">bus_size_t</i></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The size of a bus address range.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">bus_dma_tag_t</i></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
A machine-dependent opaque type describing the implementation of DMA for a given host/bus. Machine-dependent code is responsible for passing these structures to a bus's autoconfiguration machinery, which in turn passes it down to the device drivers.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">bus_dma_segment_t</i></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
A structure describing an individual DMA segment. The structure may have machine-dependent members and arbitrary layout, but has at least the following members:<div class="spacer">
</div>
<pre style="margin-left: 0.00ex;" class="lit display">
	bus_addr_t	ds_addr; 
	bus_size_t	ds_len;</pre>
<div class="spacer">
</div>
The values in <i class="farg">ds_addr</i> and <i class="farg">ds_len</i> are suitable for programming into a DMA controller's address and length registers.</dd>
<dt class="list-tag" style="margin-top: 1.00em;">
<i class="farg">bus_dmamap_t</i></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
A pointer to a structure describing an individual DMA mapping. The structure may have machine-dependent members and arbitrary layout, but has at least the following members:<div class="spacer">
</div>
<pre style="margin-left: 0.00ex;" class="lit display">
	int		   dm_nsegs; 
	bus_dma_segment_t *dm_segs;</pre>
<div class="spacer">
</div>
The <i class="farg">dm_segs</i> member may be an array of segments or a pointer to an array of segments. The <i class="farg">dm_nsegs</i> member indicates the number of segments in <i class="farg">dm_segs</i>.</dd>
</dl>
</div>
<div class="section">
<h1 id="x444d41204d415053">DMA MAPS</h1> <i class="ftype">int</i><br/>
<b class="fname">bus_dmamap_create</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">bus_size_t size</i>, <i class="farg" style="white-space:nowrap;">int nsegments</i>, <i class="farg" style="white-space:nowrap;">bus_size_t maxsegsz</i>, <i class="farg" style="white-space:nowrap;">bus_size_t boundary</i>, <i class="farg" style="white-space:nowrap;">int flags</i>, <i class="farg" style="white-space:nowrap;">bus_dmamap_t *dmamp</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">bus_dmamap_destroy</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">bus_dmamap_t dmam</i>);<div class="spacer">
</div>
The <b class="fname">bus_dmamap_create</b>() function allocates a DMA handle and initializes it according to the parameters provided. This function returns 0 on success, an error code otherwise.<div class="spacer">
</div>
The <b class="fname">bus_dmamap_create</b>() arguments are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">tag</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
The <i class="farg">bus_dma_tag_t</i> passed down from the parent driver via <i class="farg">&lt;bus&gt;_attach_args</i>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">size</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
The maximum DMA transfer that can be mapped by the handle.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">nsegments</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Number of segments the device can support in a single DMA transaction. This may be the number of scatter-gather descriptors supported by the device.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">maxsegsz</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
The maximum number of bytes that may be transferred by any given DMA segment.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">boundary</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Some DMA controllers are not able to transfer data that crosses a particular boundary. This argument allows this boundary to be specified. The boundary lines begin at 0, and occur every <i class="farg">boundary</i> bytes. Mappings may begin on a boundary line but may not end on or cross a boundary line. If no boundary condition needs to be observed, a <i class="farg">boundary</i> argument of 0 should be used.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">flags</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Flags are defined as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_WAITOK</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
It is safe to wait (sleep) for resources during this call.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_NOWAIT</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
It is not safe to wait (sleep) for resources during this call.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_ALLOCNOW</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
Perform any resource allocation this handle may need now. If this is not specified, the allocation may be deferred to <b class="fname">bus_dmamap_load</b>(). If this flag is specified, <b class="fname">bus_dmamap_load</b>() will not block on resource allocation.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_BUS[1-4]</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
These flags are placeholders, and may be used by buses to provide bus-dependent functionality.</dd>
</dl>
</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">dmamp</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
A <i class="farg">bus_dmamap_t</i> pointer. A DMA map will be allocated and pointed to by <i class="farg">dmamp</i> upon successful completion of this routine.</dd>
</dl>
<div class="spacer">
</div>
The <b class="fname">bus_dmamap_destroy</b>() function frees all resources associated with a given DMA handle. This function always succeeds if given valid arguments.<div class="spacer">
</div>
The <b class="fname">bus_dmamap_destroy</b>() arguments are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">tag</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
The <i class="farg">bus_dma_tag_t</i> passed down from the parent driver via <i class="farg">&lt;bus&gt;_attach_args</i>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">dmam</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
The DMA handle to destroy.</dd>
</dl>
<div class="spacer">
</div>
In the event that the DMA handle contains a valid mapping, the mapping will be unloaded via the same mechanism used by <b class="fname">bus_dmamap_unload</b>().</div>
<div class="section">
<h1 id="x444d41204d4150205345474d454e5453">DMA MAP SEGMENTS</h1> <i class="ftype">int</i><br/>
<b class="fname">bus_dmamap_load</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">bus_dmamap_t dmam</i>, <i class="farg" style="white-space:nowrap;">void *buf</i>, <i class="farg" style="white-space:nowrap;">bus_size_t buflen</i>, <i class="farg" style="white-space:nowrap;">struct proc *p</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">bus_dmamap_load_mbuf</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">bus_dmamap_t dmam</i>, <i class="farg" style="white-space:nowrap;">struct mbuf *chain</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">bus_dmamap_load_uio</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">bus_dmamap_t dmam</i>, <i class="farg" style="white-space:nowrap;">struct uio *uio</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">bus_dmamap_load_raw</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">bus_dmamap_t dmam</i>, <i class="farg" style="white-space:nowrap;">bus_dma_segment_t *segs</i>, <i class="farg" style="white-space:nowrap;">int nsegs</i>, <i class="farg" style="white-space:nowrap;">bus_size_t size</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">bus_dmamap_unload</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">bus_dmamap_t dmam</i>);<div class="spacer">
</div>
The <b class="fname">bus_dmamap_load</b>() function loads a DMA handle with mappings for a DMA transfer. It assumes that all pages involved in a DMA transfer are wired. This function returns 0 on success, an error code otherwise.<div class="spacer">
</div>
The <b class="fname">bus_dmamap_load</b>() arguments are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">tag</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The <i class="farg">bus_dma_tag_t</i> passed down from the parent driver via <i class="farg">&lt;bus&gt;_attach_args</i>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">dmam</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The DMA handle with which to map the transfer.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">buf</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The buffer to be used for the DMA transfer.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">buflen</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The size of the buffer.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">p</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Used to indicate the address space in which the buffer is located. If <span class="define">NULL</span>, the buffer is assumed to be in kernel space. Otherwise, the buffer is assumed to be in process <i class="farg">p</i>'s address space.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">flags</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Flags are defined as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_WAITOK</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
It is safe to wait (sleep) for resources during this call.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_NOWAIT</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
It is not safe to wait (sleep) for resources during this call.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_BUS[1-4]</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
These flags are placeholders, and may be used by buses to provide bus-dependent functionality.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_STREAMING</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
By default, the <b class="name">bus_dmamap_create</b> API assumes that there is coherency between memory and the device performing the DMA transaction. Some platforms, however, have special hardware, such as an &#8220;I/O cache&#8221;, which may improve performance of some types of DMA transactions, but which break the assumption that there is coherency between memory and the device performing the DMA transaction. This flag allows the use of this special hardware, provided that the device is doing sequential, unidirectional transfers which conform to certain alignment and size constraints defined by the platform. If the platform does not support the feature, or if the buffer being loaded into the DMA map does not conform to the constraints required for use of the feature, then this flag will be silently ignored. Also refer to the use of this flag with the <b class="fname">bus_dmamem_alloc</b>() function.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_READ</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
This is a hint to the machine-dependent back-end that indicates the mapping will be used only for a <span class="emph">device -&gt; memory</span> transaction. The back-end may perform optimizations based on this information.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_WRITE</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
This is a hint to the machine-dependent back-end that indicates the mapping will be used only for a <span class="emph">memory -&gt; device</span> transaction. The back-end may perform optimizations based on this information.</dd>
</dl>
</dd>
</dl>
<div class="spacer">
</div>
As noted above, if a DMA handle is created with <span class="define">BUS_DMA_ALLOCNOW</span>, <b class="fname">bus_dmamap_load</b>() will never block.<div class="spacer">
</div>
If a call to <b class="fname">bus_dmamap_load</b>() fails, the mapping in the DMA handle will be invalid. It is the responsibility of the caller to clean up any inconsistent device state resulting from incomplete iteration through the uio.<div class="spacer">
</div>
The <b class="fname">bus_dmamap_load_mbuf</b>() function is a variation of <b class="fname">bus_dmamap_load</b>() which maps mbuf chains for DMA transfers. Mbuf chains are assumed to be in kernel virtual address space.<div class="spacer">
</div>
The <b class="fname">bus_dmamap_load_uio</b>() function is a variation of <b class="fname">bus_dmamap_load</b>() which maps buffers pointed to by <i class="farg">uio</i> for DMA transfers. The value of <i class="farg">uio-&gt;uio_segflg</i> will determine if the buffers are in user or kernel virtual address space. If the buffers are in user address space, the buffers are assumed to be in <i class="farg">uio-&gt;uio_procp</i>'s address space.<div class="spacer">
</div>
The <b class="fname">bus_dmamap_load_raw</b>() function is a variation of <b class="fname">bus_dmamap_load</b>() which maps buffers allocated by <b class="fname">bus_dmamem_alloc</b>() (see below). The <i class="farg">segs</i> argument is a <i class="farg">bus_dma_segment_t</i> array filled in by <b class="fname">bus_dmamem_alloc</b>(). The <i class="farg">nsegs</i> argument is the number of segments in the array. The <i class="farg">size</i> argument is the size of the DMA transfer.<div class="spacer">
</div>
The <b class="fname">bus_dmamap_unload</b>() function deletes the mappings for a given DMA handle. This function always succeeds if given valid arguments. Attempting to unload a map that is already unloaded is not valid.<div class="spacer">
</div>
The <b class="fname">bus_dmamap_unload</b>() arguments are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">tag</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
The <i class="farg">bus_dma_tag_t</i> passed down from the parent driver via <i class="farg">&lt;bus&gt;_attach_args</i>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">dmam</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
The DMA handle containing the mappings which are to be deleted.</dd>
</dl>
<div class="spacer">
</div>
If the DMA handle was created with <span class="define">BUS_DMA_ALLOCNOW</span>, <b class="fname">bus_dmamap_unload</b>() will not free the corresponding resources which were allocated by <b class="fname">bus_dmamap_create</b>(). This is to ensure that <b class="fname">bus_dmamap_load</b>() will never block on resources if the handle was created with <span class="define">BUS_DMA_ALLOCNOW</span>.</div>
<div class="section">
<h1 id="x53594e4348524f4e495a4154494f4e">SYNCHRONIZATION</h1> <i class="ftype">void</i><br/>
<b class="fname">bus_dmamap_sync</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">bus_dmamap_t dmam</i>, <i class="farg" style="white-space:nowrap;">bus_addr_t offset</i>, <i class="farg" style="white-space:nowrap;">bus_size_t size</i>, <i class="farg" style="white-space:nowrap;">int ops</i>);<div class="spacer">
</div>
The <b class="fname">bus_dmamap_sync</b>() function performs pre- and post-DMA operation cache and/or buffer synchronization. This function always succeeds if given valid arguments.<div class="spacer">
</div>
The <b class="fname">bus_dmamap_sync</b>() arguments are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">tag</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The <i class="farg">bus_dma_tag_t</i> passed down from the parent driver via <i class="farg">&lt;bus&gt;_attach_args</i>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">dmam</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The DMA mapping to be synchronized.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">offset</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
Offset in the DMA mapping to be synchronized.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">size</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
The size of the region to be synchronized.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">ops</i></dt>
<dd class="list-tag" style="margin-left: 6.00ex;">
One or more synchronization operations to perform. The following DMA synchronization operations are defined:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMASYNC_PREREAD</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Perform any pre-read DMA cache and/or bounce operations.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMASYNC_POSTREAD</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Perform any post-read DMA cache and/or bounce operations.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMASYNC_PREWRITE</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Perform any pre-write DMA cache and/or bounce operations.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMASYNC_POSTWRITE</span></dt>
<dd class="list-tag" style="margin-left: 21.00ex;">
Perform any post-write DMA cache and/or bounce operations.</dd>
</dl>
<div class="spacer">
</div>
More than one operation may be performed in a given synchronization call. Mixing of <span class="emph">PRE</span> and <span class="emph">POST</span> operations is not allowed, and behavior is undefined if this is attempted.</dd>
</dl>
<div class="spacer">
</div>
Synchronization operations are expressed from the perspective of the host RAM, e.g., a <span class="emph">device -&gt; memory</span> operation is a <span class="emph">READ</span> and a <span class="emph">memory -&gt; device</span> operation is a <span class="emph">WRITE</span>.<div class="spacer">
</div>
<b class="fname">bus_dmamap_sync</b>() may consult state kept within the DMA map to determine if the memory is mapped in a DMA coherent fashion. If so, <b class="fname">bus_dmamap_sync</b>() may elect to skip certain expensive operations, such as flushing of the data cache. See <b class="fname">bus_dmamem_map</b>() for more information on this subject.<div class="spacer">
</div>
On platforms which implement reordered stores, <b class="fname">bus_dmamap_sync</b>() will always cause the store buffer to be flushed.<div class="spacer">
</div>
This function exists so that multiple read and write transfers can be performed with the same buffer, and so that drivers can explicitly inform the <b class="name">bus_dmamap_create</b> code when their data is &#8220;ready&#8221; in its DMA buffer.<div class="spacer">
</div>
An example of multiple read-write use of a single mapping might look like:<div class="spacer">
</div>
<pre style="margin-left: 0.00ex;" class="lit display">
bus_dmamap_load(...); 
 
while (not done) { 
	/* invalidate soon-to-be-stale cache blocks */ 
	bus_dmamap_sync(..., BUS_DMASYNC_PREREAD); 
 
	[ do read DMA ] 
 
	/* copy from bounce */ 
	bus_dmamap_sync(..., BUS_DMASYNC_POSTREAD); 
 
	/* read data now in driver-provided buffer */ 
 
	[ computation ] 
 
	/* data to be written now in driver-provided buffer */ 
 
	/* flush write buffers and writeback, copy to bounce */ 
	bus_dmamap_sync(..., BUS_DMASYNC_PREWRITE); 
 
	[ do write DMA ] 
 
	/* probably a no-op, but provided for consistency */ 
	bus_dmamap_sync(..., BUS_DMASYNC_POSTWRITE); 
} 
 
bus_dmamap_unload(...);</pre>
<div class="spacer">
</div>
If DMA read and write operations are not preceded and followed by the appropriate synchronization operations, behavior is undefined.</div>
<div class="section">
<h1 id="x444d411e53414645204d454d4f5259">DMA-SAFE MEMORY</h1> <i class="ftype">int</i><br/>
<b class="fname">bus_dmamem_alloc</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">bus_size_t size</i>, <i class="farg" style="white-space:nowrap;">bus_size_t alignment</i>, <i class="farg" style="white-space:nowrap;">bus_size_t boundary</i>, <i class="farg" style="white-space:nowrap;">bus_dma_segment_t *segs</i>, <i class="farg" style="white-space:nowrap;">int nsegs</i>, <i class="farg" style="white-space:nowrap;">int *rsegs</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<div class="spacer">
</div>
<i class="ftype">int</i><br/>
<b class="fname">bus_dmamem_alloc_range</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">bus_size_t size</i>, <i class="farg" style="white-space:nowrap;">bus_size_t alignment</i>, <i class="farg" style="white-space:nowrap;">bus_size_t boundary</i>, <i class="farg" style="white-space:nowrap;">bus_dma_segment_t *segs</i>, <i class="farg" style="white-space:nowrap;">int nsegs</i>, <i class="farg" style="white-space:nowrap;">int *rsegs</i>, <i class="farg" style="white-space:nowrap;">int flags</i>, <i class="farg" style="white-space:nowrap;">bus_addr_t low</i>, <i class="farg" style="white-space:nowrap;">bus_addr_t high</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">bus_dmamem_free</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">bus_dma_segment_t *segs</i>, <i class="farg" style="white-space:nowrap;">int nsegs</i>);<div class="spacer">
</div>
The <b class="fname">bus_dmamem_alloc</b>() function allocates memory that is &quot;DMA safe&quot; for the bus corresponding to the given tag. This function returns 0 on success, or an error code indicating mode of failure.<div class="spacer">
</div>
The mapping of this memory is machine-dependent (or &quot;opaque&quot;); machine-independent code should not assume that the addresses returned are valid in kernel virtual address space, or that the addresses returned are system physical addresses. The address value returned as part of <i class="farg">segs</i> can thus not be used to program DMA controller address registers. Only the values in the <i class="farg">dm_segs</i> array of a successfully loaded DMA map (using <b class="fname">bus_dmamap_load</b>()) can be used for this purpose.<div class="spacer">
</div>
Allocations will always be rounded to the hardware page size. Callers may wish to take advantage of this, and cluster allocation of small data structures.<div class="spacer">
</div>
The <b class="fname">bus_dmamem_alloc</b>() arguments are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">tag</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
The <i class="farg">bus_dma_tag_t</i> passed down from the parent driver via <i class="farg">&lt;bus&gt;_attach_args</i>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">size</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
The amount of memory to allocate.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">alignment</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Each segment in the allocated memory will be aligned to this value. If the alignment is less than a hardware page size, it will be rounded up to the hardware page size. This value must be a power of two.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">boundary</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Each segment in the allocated memory must not cross this boundary (relative to zero). This value must be a power of two. A boundary value less than the size of the allocation is invalid.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">segs</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
The <i class="farg">bus_dma_segment_t</i> array, filled in as memory is allocated, representing the opaque addresses of the memory chunks.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">nsegs</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
The number of segments available in <i class="farg">segs</i>. Used to specify the maximum number of segments that the allocated memory may be divided into.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">rsegs</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
The number of segments used in <i class="farg">segs</i>. Used to return the actual number of segments the memory was divided into.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">flags</i></dt>
<dd class="list-tag" style="margin-left: 9.00ex;">
Flags are defined as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_WAITOK</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
It is safe to wait (sleep) for resources during this call.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_NOWAIT</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
It is not safe to wait (sleep) for resources during this call.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_ZERO</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
The memory allocated should be zeroed.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_STREAMING</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
Adjusts, if necessary, the size, alignment, and boundary constraints to conform to the platform-dependent requirements for the use of the <span class="define">BUS_DMA_STREAMING</span> flag with the <b class="fname">bus_dmamap_load</b>() function. If the platform does not support the <span class="define">BUS_DMA_STREAMING</span> feature, or if the size, alignment, and boundary constraints would already satisfy the platform's requirements, this flag is silently ignored. The <span class="define">BUS_DMA_STREAMING</span> flag will never relax the constraints specified in the call.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_BUS[1-4]</span></dt>
<dd class="list-tag" style="margin-left: 17.00ex;">
These flags are placeholders, and may be used by buses to provide bus-dependent functionality.</dd>
</dl>
</dd>
</dl>
<div class="spacer">
</div>
The <b class="fname">bus_dmamem_alloc_range</b>() function is a variation of <b class="fname">bus_dmamem_alloc</b>() that allows specification of the &quot;DMA safe&quot; bus address range supported by the device. The additional <i class="farg">low</i> and <i class="farg">high</i> arguments specify the lowest and highest bus address that the device can use for DMA transfers. This function should only be used if that address range differs from the default address range for the bus.<div class="spacer">
</div>
All pages allocated by <b class="fname">bus_dmamem_alloc</b>() and <b class="fname">bus_dmameme_alloc_range</b>() will be wired down until they are freed by <b class="fname">bus_dmamem_free</b>().<div class="spacer">
</div>
The <b class="fname">bus_dmamem_free</b>() function frees memory previously allocated by <b class="fname">bus_dmamem_alloc</b>() or <b class="fname">bus_dmamem_alloc_range</b>(), invalidating any mapping. This function always succeeds if given valid arguments.<div class="spacer">
</div>
The <b class="fname">bus_dmamem_free</b>() arguments are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">tag</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The <i class="farg">bus_dma_tag_t</i> passed down from the parent driver via <i class="farg">&lt;bus&gt;_attach_args</i>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">segs</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The <i class="farg">bus_dma_segment_t</i> array filled in by <b class="fname">bus_dmamem_alloc</b>().</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">nsegs</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The number of segments in <i class="farg">segs</i>.</dd>
</dl>
</div>
<div class="section">
<h1 id="x4d415050494e4720444d411e53414645204d454d4f5259">MAPPING DMA-SAFE MEMORY</h1> <i class="ftype">int</i><br/>
<b class="fname">bus_dmamem_map</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">bus_dma_segment_t *segs</i>, <i class="farg" style="white-space:nowrap;">int nsegs</i>, <i class="farg" style="white-space:nowrap;">size_t size</i>, <i class="farg" style="white-space:nowrap;">caddr_t *kvap</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<div class="spacer">
</div>
<i class="ftype">void</i><br/>
<b class="fname">bus_dmamem_unmap</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">caddr_t kva</i>, <i class="farg" style="white-space:nowrap;">size_t size</i>);<div class="spacer">
</div>
<i class="ftype">paddr_t</i><br/>
<b class="fname">bus_dmamem_mmap</b>(<i class="farg" style="white-space:nowrap;">bus_dma_tag_t tag</i>, <i class="farg" style="white-space:nowrap;">bus_dma_segment_t *segs</i>, <i class="farg" style="white-space:nowrap;">int nsegs</i>, <i class="farg" style="white-space:nowrap;">off_t off</i>, <i class="farg" style="white-space:nowrap;">int prot</i>, <i class="farg" style="white-space:nowrap;">int flags</i>);<div class="spacer">
</div>
The <b class="fname">bus_dmamem_map</b>() function maps memory allocated with <b class="fname">bus_dmamem_alloc</b>() or <b class="fname">bus_dmamem_alloc_range</b>() into kernel virtual address space. This function returns 0 on success, an error code otherwise, and must not be called from an interrupt context.<div class="spacer">
</div>
The <b class="fname">bus_dmamem_map</b>() arguments are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">tag</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The <i class="farg">bus_dma_tag_t</i> passed down from the parent driver via <i class="farg">&lt;bus&gt;_attach_args</i>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">segs</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The <i class="farg">bus_dma_segment_t</i> array filled in by <b class="fname">bus_dmamem_alloc</b>(), representing the memory regions to map.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">nsegs</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The number of segments in <i class="farg">segs</i>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">size</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The size of the mapping.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">kvap</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
Filled in to specify the kernel virtual address where the memory is mapped.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">flags</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
Flags are defined as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_WAITOK</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
It is safe to wait (sleep) for resources during this call.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_NOWAIT</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
It is not safe to wait (sleep) for resources during this call.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_BUS[1-4]</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
These flags are placeholders, and may be used by buses to provide bus-dependent functionality.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_COHERENT</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
This flag is a <span class="emph">hint</span> to machine-dependent code. If possible, map the memory in such a way as it will be DMA coherent. This may include mapping the pages into uncached address space or setting the cache-inhibit bits in page table entries. If implementation of DMA coherent mappings is impossible, this is ignored.<div class="spacer">
</div>
Later, when this memory is loaded into a DMA map, machine-dependent code will take whatever steps are necessary to determine if the memory was mapped in a DMA coherent fashion. This may include checking if the kernel virtual address lies within uncached address space or if the cache-inhibit bits are set in page table entries. If it is determined that the mapping is DMA coherent, state may be placed into the DMA map for use by later calls to <b class="fname">bus_dmamap_sync</b>().</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_NOCACHE</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
This flag is a <span class="emph">hint</span> to machine-dependent code. If possible, map the memory uncached.</dd>
</dl>
</dd>
</dl>
<div class="spacer">
</div>
The <b class="fname">bus_dmamem_unmap</b>() function unmaps memory previously mapped with <b class="fname">bus_dmamem_map</b>(), freeing the kernel virtual address space used by the mapping. This function always succeeds if given valid arguments, but must not be called from an interrupt context.<div class="spacer">
</div>
<b class="fname">bus_dmamem_unmap</b>() arguments are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">tag</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
The <i class="farg">bus_dma_tag_t</i> passed down from the parent driver via <i class="farg">&lt;bus&gt;_attach_args</i>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">kva</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
The kernel virtual address of the mapped memory.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">size</i></dt>
<dd class="list-tag" style="margin-left: 4.00ex;">
The size of the mapping.</dd>
</dl>
<div class="spacer">
</div>
The <b class="fname">bus_dmamem_mmap</b>() function provides support for user <a class="link-man" href="../html2/mmap.html">mmap(2)</a>'ing of DMA-safe memory. <b class="fname">bus_dmamem_mmap</b>() is to be called by a device driver's <b class="fname">(*d_mmap)</b>() entry point, which is called by the device pager for each page to be mapped. This function returns a physical address to be passed to <b class="fname">pmap_enter</b>() by the device pager, or -1 on failure. <b class="fname">bus_dmamem_mmap</b>() arguments are as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">tag</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The <i class="farg">bus_dma_tag_t</i> passed down from the parent driver via <i class="farg">&lt;bus&gt;_attach_args</i>.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">segs</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The <i class="farg">bus_dma_segment_t</i> array filled in by <b class="fname">bus_dmamem_alloc</b>(), representing the memory to be <a class="link-man" href="../html2/mmap.html">mmap(2)</a>'ed.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">nsegs</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The number of elements in the <i class="farg">segs</i> array.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">off</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The offset of the page in DMA memory which is to be mapped.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">prot</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
The protection codes for the mapping.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<i class="farg">flags</i></dt>
<dd class="list-tag" style="margin-left: 5.00ex;">
Flags are defined as follows:<dl style="margin-top: 0.00em;margin-bottom: 0.00em;" class="list list-tag">
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_WAITOK</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
It is safe to wait (sleep) for resources during this call.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_NOWAIT</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
It is not safe to wait (sleep) for resources during this call.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_BUS[1-4]</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
These flags are placeholders, and may be used by buses to provide bus-dependent functionality.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_COHERENT</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
See <b class="fname">bus_dmamem_map</b>() above for a description of this flag.</dd>
<dt class="list-tag" style="margin-top: 0.00em;">
<span class="define">BUS_DMA_NOCACHE</span></dt>
<dd class="list-tag" style="margin-left: 16.00ex;">
See <b class="fname">bus_dmamem_map</b>() above for a description of this flag.</dd>
</dl>
</dd>
</dl>
</div>
<div class="section">
<h1 id="x53454520414c534f">SEE ALSO</h1> <a class="link-man" href="../html9/bus_space.html">bus_space(9)</a></div>
<div class="section">
<h1 id="x484953544f5259">HISTORY</h1> The <b class="name">bus_dmamap_create</b> interface appeared in <span class="unix">NetBSD&#160;1.3</span>.</div>
<div class="section">
<h1 id="x415554484f5253">AUTHORS</h1> The <b class="name">bus_dmamap_create</b> interface was designed and implemented by <span class="author">Jason R. Thorpe</span> of the Numerical Aerospace Simulation Facility, NASA Ames Research Center. Additional input on the <b class="name">bus_dmamap_create</b> design was provided by Chris Demetriou, Charles Hannum, Ross Harvey, Matthew Jacob, Jonathan Stone, and Matt Thomas.</div>
</div>
</body>
</html>

